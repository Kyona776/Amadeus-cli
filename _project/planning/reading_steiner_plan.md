# Reading Steiner メタコマンド＆並行世界線ツール 実装計画（ドラフト v0.1）

作成日: 2025-11-10  
作成者: GPT-5 Codex（Cursor エージェント）

---

## 1. 背景・目的
- 現行 Kimi CLI では D-Mail による単一時間線への巻き戻りのみが可能で、分岐した世界線同士の並行協調や過程の再利用が困難。  
- ユーザー要望: 「オカリンのリーディング・シュタイナー」を想起させるメタコマンドを導入し、Mind Evolution の進化的探索と PageIndex 型の記憶索引を組み合わせた“並列世界線”選択と知識活用を実現する。  
- 目標: 並行世界線の生成・再評価・収束を司る新メタコマンドとツール群を `soul / toolset / UI / meta commands` に統合し、シンプルかつ美しい設計で物語的な分岐管理を提供する。

## 2. 現状整理（2025-11-10 時点）
- `Context` は直線的履歴(チェックポイント)を JSONL に保存。分岐や並列世界線の概念は未実装。  
- `DenwaRenji` + `SendDMail` で未来からの単発メッセージを扱うが、複数世界線の相互干渉や自走型サブエージェントとの協調支援は限定的。  
- `toolset.CustomToolset` は単位ツール呼び出しの状態保持のみ。並列ワールドを跨ぐスコープ共有は想定していない。  
- `ui.shell.visualize` は1本のステップ進行をライブ表示する作りで、世界線図の描画コンポーネントは未整備。  
- DeepWiki & ドキュメント参照先: 4.1/4.2/5.x/6.x/7.2 などに既存の時間遡行・サブエージェント・メタコマンド仕様が記載されている（別途確認予定）。

## 3. 要求仕様（ヒアリング整理）
- `/reading-steiner`（仮）メタコマンドを追加し、世界線生成・監視・収束を一括制御。  
- 並列世界線で得た **結果だけでなく過程・知識・経験** を記憶として蓄積し、Agent が必要に応じ PageIndex で索引 → 再参照可能にする。  
- Context に直接過程全文を載せず、チェックポイント単位で世界線の合流を行い、トレースは別ストアから必要時に参照。  
- 未来側チェックポイントが存在する場合は新世界線を分岐させ、バタフライ効果を考慮した「再評価システム」を実装。  
- 複数 Sub Agent が自走し、自身の世界線で検討した結果をオーケストレータへ反映。  
- TUI: 世界線分岐図/チェックポイント一覧をキーボードで切り替え可能にし、簡潔な要約を表示。  
- Mind Evolution (MIT ライセンス) を参考にしつつ、世界線全体の探索・評価ロジックを発展。  
- PageIndex (MIT) を取り込み、記憶索引＋ページングで参照候補を決定する。  
- 実装後は spec/ストーリー過不足が無いか、テスト観点で保証。

## 4. 想定スコープ
- **対象**: `soul`（新世界線管理レイヤー）、`toolset`（新ツールハンドラ）、`ui.shell`（メタコマンド・TUI拡張）、`tools`（世界線操作ツールセット）、`session/context` 継続性の調整。  
- **非対象（現時点）**: WebUI・API 版の拡張、ファイルシステムの自動分岐管理（必要なら別フェーズへ切り出し）。

## 5. アーキテクチャ提案

### 5.1 世界線管理レイヤー（Worldline Orchestrator）
- 新モジュール候補: `soul/worldline/manager.py`, `soul/worldline/graph.py`, `soul/worldline/checkpoint.py` など。  
- 職責: 
  1. 世界線グラフ（有向非巡回: root → 派生）の構築・更新。  
  2. Mind Evolution エンジンに世界線候補を渡し、評価指標 (Temporal Consistency, Timeline Entropy など) で scoring。  
  3. チェックポイント境界で Context とファイルバックエンドを切り替える仕組み（イベントソーシング型 rotating history + diff 差分管理を検討）。  
  4. バタフライ効果再評価: 未来の成果が既にコミット済みの場合、分岐時に再シミュレート → 影響度メトリクス更新。

### 5.2 記憶・知識ストア + PageIndex 連携
- `memory/`（仮）ディレクトリに「世界線メモリバンク」を新設。  
- 各世界線のプロセスログ・知識抽出・経験タグを PageIndex 向け「ページ」単位に格納。  
- PageIndex Adapter: PageIndex の `PageIndex` クラスをラップして、世界線ID + チェックポイントID をキーに索引化。  
- Agent からの参照フロー:  
  1. Reading Steiner が探索フェーズでメモリバンクを更新。  
  2. Agent 実行中に必要となった情報は Tool 経由で Query → PageIndex で最適候補を取得 → 摂動の少ない形で context へ注入。  
- 過程メモリは context に直接注入せず、サマリのみ（チェックポイント「概要」）を挿入する設計にする。

### 5.3 Mind Evolution 拡張
- 既存 `mind_evolution.py`（MIT）を調査し、世界線探索アルゴリズムを抽象化。  
- 差分: Mind Evolution は候補ソリューションの進化的選択にフォーカス → 本件では**世界線**（状態 + 記憶）を個体として扱う。  
- 拡張点:  
  - 状態表現に世界線履歴(グラフ)・記憶参照状態を含める。  
  - 染色体 → 「ツール呼び出しシーケンス」+「チェックポイント遷移」。  
  - Fitness 関数に Temporal Consistency / Relevance / Divergence など複数スコアを組み合わせる。  
  - 探索結果は必ず Worldline Manager を経由して登録し、バタフライ効果検証を挟む。  
  - Mind Evolution の各 LLM 呼び出しは Kimi CLI 標準の `kosong` フレームワーク（`kimi_cli.llm`）を通じて実行し、既存の思考モード・ツール呼び出しとの整合を取る。

### 5.4 チェックポイント・バタフライ効果評価
- `Temporal Evaluator`（仮）モジュールを新設し、未来側に既存チェックポイントがある場合、差分シミュレーションを実行：  
  - 世界線グラフにおける対象ノードから未来子孫ノードを探索。  
  - 副作用（例: ファイル変更, メモリ更新）が上書きされる場合は新枝を生成し、影響度スコアを更新。  
  - 再評価結果に基づき、ユーザ承認（approval 連携）や自動合流ポリシーを適用。

### 5.5 CLI / TUI 拡張
- `/reading-steiner` 実行後:  
  - 進行状況をライブ表示しつつ、`visualize` に新しい「世界線ビュータブ」を追加。  
  - 例: `KeyEvent.TAB` で“従来ログビュー ↔ 世界線図ビュー”を切替。  
  - 世界線図ビューは Rich の Tree / Table を活用し、各ノードに「1行あらすじ（summary）」＋「ハイライト（主要コンテキスト抜粋）」を表示。  
  - チェックポイント選択後、`ENTER` で詳細パネル（要約、記憶索引結果）を表示。  
- `console` メッセージ: 世界線合流や分岐結果をコンパクトに説明する。

### 5.6 Toolset 拡張案
- 新ツール群（仮称）  
  - `WorldlineFork` : 任意チェックポイントから分岐世界線を生成。  
  - `WorldlineMerge` : 選択世界線の結果をメイン世界線へ反映。  
  - `WorldlineQueryMemory` : PageIndex を通して記憶検索。  
  - `WorldlineTrace` : 特定世界線の過程サマリを取得（Context には概要のみ挿入）。  
  - `WorldlineReevaluate` : 未来枝の再評価を要求（バタフライ効果検知）。  
- 既存ツールとの整合  
  - `Task` ツール: サブエージェント起動時に世界線IDを付与し、結果を Worldline Manager に送信。  
  - `SendDMail` : 従来の巻き戻し機構を Worldline Manager の API から呼び出す形にリファクタリングし、世界線間メッセージングの一部とする。

### 5.7 Review Agent ワークフロー
- バタフライ効果再評価や世界線マージ前に、Review Agent が判断材料を集約。  
- エージェントは対象世界線の要約・差分・影響度メトリクスを収集し、「レビュー依頼」メッセージとしてユーザーへ提示。  
- デフォルトでユーザー承認（Approval API）を待つ。承認時のみマージ／更新を実行。  
- Review Agent の結果は PageIndex ストアにも記録し、後続世界線から参照可能にする。
## 6. メタコマンド仕様（案）
```
/reading-steiner [mode] [options...]
  mode:
    explore      # 並列世界線を生成・評価（デフォルト）
    recall       # 過去世界線のチェックポイントを一覧・選択
    merge        # 指定世界線をメイン世界線へマージ
    timeline     # TUI 世界線ビューを起動

  options (例):
    --seed <id>                  # 分岐開始チェックポイント
    --agents <list>              # 自走させるサブエージェント名
    --limit-worldlines <int>     # 探索世界線数の上限
    --score-threshold <float>    # Temporal Consistency 閾値
```
- 初回実行で必要な初期化: 世界線グラフとメモリストアのルート生成。  
- コマンド終了時: 選択された世界線サマリを context に1-2文挿入、詳細は記憶ストアに保持。

## 7. データ構造・フローダイアグラム（概念）
```
┌─────────────┐        ┌────────────────┐
│ /reading-steiner │──┐    │ MindEvolutionEngine │
└─────────────┘  │    └────────────────┘
                   ▼
           ┌────────────────┐
           │ WorldlineManager│
           └────────────────┘
                   │
        ┌──────────┴───────────┐
        ▼                      ▼
┌───────────────┐     ┌─────────────────────┐
│ Context Router │     │ Worldline Memory Bank│
└───────────────┘     └─────────────────────┘
        │                      │
        ▼                      ▼
┌───────────────┐     ┌─────────────────────┐
│ Checkpoint FS │     │ PageIndex Adapter    │
└───────────────┘     └─────────────────────┘
        │                      │
        ▼                      ▼
┌───────────────┐     ┌─────────────────────┐
│ KimiSoul Loop │     │ Agent / SubAgent     │
└───────────────┘     └─────────────────────┘
```
- 世界線グラフモデル（例）:  
  - ノード: `{worldline_id, parent_id, checkpoint_id, summary, metrics}`  
  - エッジ: `{from_worldline_id → to_worldline_id, divergence_reason, timestamp}`  
  - メモリ: `{worldline_id, artifact_type, pointer(PageIndex page_id), tags}`  
- Temporal 再評価: グラフ探索 + 差分サマリ（Δファイル, Δメモリ, Δツール出力）。

## 8. 開発フェーズ提案
1. **調査フェーズ（Phase 0）**  
   - DeepWiki 該当章、Mind Evolution / PageIndex リポジトリ読み込み。  
   - 現行テスト・挙動の逆解析（Time travel, Task, Compact など）。  
   - 調査結果を `/_project` に反映。
2. **設計フェーズ（Phase 1）**  
   - 世界線データモデル仕様書（JSON Schema / UML）作成。  
   - API インタフェース（Worldline Manager ↔ Soul/TUI/Tools）定義。  
   - メタコマンド CLI フローの詳細化。
3. **基盤実装（Phase 2）**  
   - 世界線グラフ + 記憶ストア基盤（読み書き, PageIndex 接続）。  
   - Mind Evolution/Baseline 探索を最小構成で組み込み。  
   - ツール群のスケルトン実装 + 単体テスト。
4. **UI/メタコマンド統合（Phase 3）**  
   - `/reading-steiner` メタコマンド統合, 既存 CLI との連携。  
   - TUI 世界線ビュー、キーボード操作対応。  
   - サブエージェントとの連動テスト。
5. **評価・整備（Phase 4）**  
   - シナリオテスト（世界線分岐→合流、バタフライ効果、メモリ参照）。  
   - ドキュメント更新（AGENTS.md / docs/ etc）。  
   - コードクリーンアップ、型チェック、CI テスト拡張。

## 9. テスト戦略（初期案）
- **Unit**:  
  - 世界線グラフ操作（追加・分岐・マージ）。  
  - バタフライ効果評価ロジック（再評価シナリオ）。  
  - PageIndex Adapter（索引作成・検索結果）。  
- **Integration**:  
  - `/reading-steiner explore` → 世界線生成 → `merge` までの一連操作。  
  - サブエージェントが並列世界線で実行し、結果がメモリバンクへ登録される。  
  - コンテキスト compaction / D-Mail との相互作用。  
- **Scenario**:  
  - 未来チェックポイントが存在する状態で新規分岐 → 再評価 → 新世界線が生成される。  
  - TUI でチェックポイントを選択し、過去世界線の要約を閲覧→マージ。  
- **回帰**: 既存 test_* を流し、破壊的変更がないか確認。

## 10. リスク・課題・未確定事項
1. ~~**記憶永続化の範囲**~~ → **確定**: 世界線メモリは永続化（例: `.kimi/worldlines/`）を前提に設計。  
2. ~~**チェックポイント粒度**~~ → **確定方針**: メタコマンド／ツール呼び出し／ユーザーステップを基本単位とし、必要に応じチャット履歴要約から補完チェックポイントを生成するマルチ粒度モデルを設計。  
3. ~~**PageIndex 適用範囲**~~ → **確定方針**: 世界線ごとに独立/共有を切替可能な構成とし、参照時に必要範囲を選択できる UI/API を設計。  
4. **Review フローの複雑化**: バタフライ効果評価結果のユーザー承認フロー（レビュー専用エージェント導入）設計が複雑化する恐れ。  
5. **パフォーマンス**: Mind Evolution + PageIndex の組込みで処理時間が増大するリスク。  
6. **UI 複雑化**: 世界線表示が煩雑になり UX が悪化する可能性。  
7. **tree コマンド未導入**: ワークスペース調査時に `tree` 不在を確認。必要なら環境へ導入検討。  
8. **外部ライセンス**: MIT だがライセンス告知や attribution の反映方法を決定する必要あり。

## 11. 外部調査 TODO
- [ ] DeepWiki: 4.1/4.2/5.1/5.2/5.3/6.4/6.5/7.2 を読み込み、既存仕様と整合性を確認。  
- [ ] Mind Evolution リポジトリ: アルゴリズム構造を把握（個体表現、進化ループ、適応度関数）。  
- [ ] PageIndex リポジトリ & ドキュメント: API・データモデル・PageIndexMD フロー確認。  
- [ ] Temporal/バタフライ効果評価に適した既存手法（例: Event Sourcing, Causal Consistency）を追加調査。

## 12. 今後の確認事項（ユーザーへの問い）
1. ~~世界線メモリは永続化（例: `.kimi/worldlines/`）が必要か、セッションごとに破棄するか。~~  
2. ~~チェックポイント粒度の希望（メタコマンド単位 vs ツール単位）。~~  
3. ~~PageIndex を世界線共通で共有するか、世界線毎に分離するか。~~  
4. ~~バタフライ効果再評価の結果は自動マージ or ユーザー承認が必要か。~~ → デフォルトでユーザー承認を挟み、Review Agent が判断材料を整理してレビュー依頼を発行する半自動フローを設計する。  
5. ~~TUI 世界線ビューの要約表示フォーマット（例: 1行要約 + 指標スコア？）。~~ → 1行あらすじ(summary) + ハイライト（主要文脈抜粋）を基本表示とする。  
6. ~~Mind Evolution / PageIndex 取り込み時のライセンス表記ポリシー（README 追記など）の希望。~~ → 特段の追加要望なし。

---

**次アクション**:  
ユーザーによる計画内容と未確定事項の確認・補足を待ち、承認後に Phase 0 調査へ進行します。
