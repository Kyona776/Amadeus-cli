<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/4cf2300e9c8272f7-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/93f479601ee12b01-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/de70bee13400563f.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/21563f70193c14e1.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-acbbbb548492d4a6.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w"/><script src="/_next/static/chunks/4bd1b696-cebf68b71ed1e85d.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/1684-c4cfd1915085f766.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/main-app-8ab5af3d6b81086e.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/4420-863691215dce8f1b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/6417-34cc3208366c5e5f.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/4348-824485747071bae4.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/3224-7e9887ea92eab174.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/6967-c4b815e71e97ed18.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/app/layout-37a15e31a18fac3d.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/7bf36345-06f80506190927ed.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/c16f53c3-1a60b9b77b3e1d4b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/2249-342d7235b3a68051.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/9970-31fea4ade6367f07.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/1769-6bbc7ae2dcadfa9c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/655-b5574efc1f81bad2.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/4154-f7634cd651686b21.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/3639-900f572b0aed0454.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/8613-da4dddfdd374b6ba.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/4870-8871061efa4307d3.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/app/%5Borg%5D/%5Brepo%5D/%5B%5B...wikiRoutes%5D%5D/page-78fac26cbb8eb9a1.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/3449-aaf01d1b29913c28.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/7553-2bb9c132a5788553.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/1127-b475c4cc62d0a830.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/736-90a1c8956f4d3102.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script src="/_next/static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-99964eedd99460bc.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><meta name="next-size-adjust" content=""/><title>Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki</title><meta name="description" content="This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name"/><meta property="og:title" content="Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki"/><meta property="og:description" content="This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name"/><meta property="og:url" content="https://deepwiki.com/MoonshotAI/kimi-cli/5.1-agent-specification-format"/><meta property="og:site_name" content="DeepWiki"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki"/><meta name="twitter:description" content="This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="48x48"/><link rel="icon" href="/icon.png?66aaf51e0e68c818" type="image/png" sizes="16x16"/><link rel="apple-touch-icon" href="/apple-icon.png?a4f658907db0ab87" type="image/png" sizes="180x180"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" noModule=""></script></head><body class="__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased"><section aria-label="Notifications alt+T" tabindex="-1" aria-live="polite" aria-relevant="additions text" aria-atomic="false"></section><script>((e,t,r,n,o,a,i,s)=>{let l=document.documentElement,u=["light","dark"];function c(t){var r;(Array.isArray(e)?e:[e]).forEach(e=>{let r="class"===e,n=r&&a?o.map(e=>a[e]||e):o;r?(l.classList.remove(...n),l.classList.add(a&&a[t]?a[t]:t)):l.setAttribute(e,t)}),r=t,s&&u.includes(r)&&(l.style.colorScheme=r)}if(n)c(n);else try{let e=localStorage.getItem(t)||r,n=i&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;c(n)}catch(e){}})("class","theme","light",null,["light","dark"],null,true,true)</script><!--$--><div class="flex min-h-screen w-full flex-col text-white" id="codebase-wiki-repo-page"><div class="bg-background border-b-border sticky top-0 z-30 border-b border-dashed"><div class="font-geist-mono relative flex h-8 items-center justify-center text-xs font-medium sm:hidden"><div class="powered-by-devin-gradient absolute inset-0 z-[-1] h-8 w-full"></div><a class="flex items-center gap-2" href="/private-repo"><svg class="size-3 [&amp;_path]:stroke-0 [&amp;_path]:animate-[custom-pulse_1.8s_infinite_var(--delay,0s)]" xmlns="http://www.w3.org/2000/svg" viewBox="110 110 460 500"><path style="fill:#21c19a" class="[--delay:0.6s]" d="M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z"></path><path style="fill:#3969ca" d="M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z"></path><path style="fill:#0294de" class="[--delay:1.2s]" d="M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z"></path></svg>Index your code with Devin</a></div><div class="container-wrapper"><div class="container mx-auto flex w-full flex-row items-center gap-2 py-4 md:py-6"><a class="flex items-center gap-3" href="/"><span class="text-base font-medium leading-none md:text-lg hidden sm:block">DeepWiki</span></a><div class="flex-1"><div class="flex flex-row items-center gap-2"><a class="block text-xs font-medium leading-none text-white sm:hidden md:text-lg" href="/">DeepWiki</a><p class="text-sm font-normal leading-none md:text-lg"><a href="https://github.com/MoonshotAI/kimi-cli" target="_blank" rel="noopener noreferrer" title="Open repository" class="text-muted-foreground hover:text-muted-foreground/80 group inline-flex items-center gap-1 transition-colors">MoonshotAI/kimi-cli<!-- --> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="opacity-0 transition-opacity group-hover:opacity-100"><path d="M224,104a8,8,0,0,1-16,0V59.32l-66.33,66.34a8,8,0,0,1-11.32-11.32L196.68,48H152a8,8,0,0,1,0-16h64a8,8,0,0,1,8,8Zm-40,24a8,8,0,0,0-8,8v72H48V80h72a8,8,0,0,0,0-16H48A16,16,0,0,0,32,80V208a16,16,0,0,0,16,16H176a16,16,0,0,0,16-16V136A8,8,0,0,0,184,128Z"></path></svg></a></p></div></div><div class="flex items-center gap-4"><a class="group hidden items-center gap-1.5 md:flex" href="/private-repo"><div class="relative"><span class="text-foreground/70 group-hover:text-foreground text-xs font-light transition-colors">Index your code with</span><div class="bg-foreground/30 absolute bottom-0 left-0 h-[1px] w-0 transition-all duration-300 group-hover:w-full"></div></div><div class="flex items-center gap-1 transition-transform duration-300 group-hover:translate-x-0.5"><svg class="size-4 transform transition-transform duration-700 group-hover:rotate-180 [&amp;_path]:stroke-0" xmlns="http://www.w3.org/2000/svg" viewBox="110 110 460 500"><path style="fill:#21c19a" class="" d="M418.73,332.37c9.84-5.68,22.07-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.58,1.06.19.06.37.11.55.16.87.21,1.76.34,2.65.35.04,0,.08.02.13.02.1,0,.19-.03.29-.04.83-.02,1.64-.13,2.45-.32.14-.03.28-.05.42-.09.87-.24,1.7-.59,2.5-1.03.08-.04.17-.06.25-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.06,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.57-1.06-.19-.06-.37-.11-.56-.16-.88-.21-1.76-.34-2.65-.34-.13,0-.26.02-.4.02-.84.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.24.1.8.44,1.64.79,2.5,1.03.14.04.28.06.42.09.81.19,1.62.3,2.45.32.1,0,.19.04.29.04.04,0,.08-.02.13-.02.89,0,1.77-.13,2.65-.35.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.58-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-.08-.04-.16-.06-.24-.1-.8-.44-1.64-.8-2.51-1.04-.13-.04-.26-.05-.39-.09-.82-.2-1.65-.31-2.49-.33-.13,0-.25-.02-.38-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.75.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.07,5.68-31.9,0-9.84-5.68-15.95-16.27-15.95-27.63s6.11-21.95,15.95-27.63Z"></path><path style="fill:#3969ca" d="M141.09,317.65l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c.08-.04.13-.11.2-.16.78-.48,1.51-1.02,2.15-1.66.1-.1.18-.21.28-.31.57-.6,1.08-1.26,1.51-1.97.07-.12.15-.22.22-.34.44-.77.77-1.6,1.03-2.47.05-.19.1-.37.14-.56.22-.89.37-1.81.37-2.76v-29.43c0-11.36,6.11-21.95,15.96-27.63s22.06-5.68,31.91,0l25.49,14.71c.82.48,1.69.8,2.57,1.06.19.06.37.11.56.16.87.21,1.76.34,2.64.35.04,0,.09.02.13.02.1,0,.19-.04.29-.04.83-.02,1.65-.13,2.45-.32.14-.03.28-.05.41-.09.87-.24,1.71-.6,2.51-1.04.08-.04.16-.06.24-.1l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-.08.04-.13.11-.2.16-.78.48-1.51,1.02-2.15,1.66-.1.1-.18.21-.28.31-.57.6-1.08,1.26-1.51,1.97-.07.12-.15.22-.22.34-.44.77-.77,1.6-1.03,2.47-.05.19-.1.37-.14.56-.22.89-.37,1.81-.37,2.76v29.43c0,11.36-6.11,21.95-15.95,27.63-9.84,5.68-22.07,5.68-31.91,0l-25.49-14.71c-.82-.48-1.69-.8-2.58-1.06-.19-.06-.37-.11-.55-.16-.88-.21-1.76-.34-2.65-.35-.13,0-.26.02-.4.02-.83.02-1.66.13-2.47.32-.13.03-.27.05-.4.09-.87.24-1.71.6-2.51,1.04-.08.04-.16.06-.24.1l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22Z"></path><path style="fill:#0294de" class="" d="M396.88,484.35l-50.97-29.43c-.08-.04-.17-.06-.24-.1-.8-.44-1.64-.79-2.51-1.03-.14-.04-.27-.06-.41-.09-.81-.19-1.64-.3-2.47-.32-.13,0-.26-.02-.39-.02-.89,0-1.78.13-2.66.35-.18.04-.36.1-.54.15-.88.26-1.76.59-2.58,1.07l-25.49,14.72c-9.84,5.68-22.06,5.68-31.9,0-9.84-5.68-15.96-16.27-15.96-27.63v-29.43c0-.95-.15-1.87-.37-2.76-.05-.19-.09-.37-.14-.56-.25-.86-.59-1.69-1.03-2.47-.07-.12-.15-.22-.22-.34-.43-.71-.94-1.37-1.51-1.97-.1-.1-.18-.21-.28-.31-.65-.63-1.37-1.18-2.15-1.66-.07-.04-.13-.11-.2-.16l-50.97-29.43c-3.65-2.11-8.15-2.11-11.81,0l-50.97,29.43c-3.65,2.11-5.9,6.01-5.9,10.22v58.86c0,4.22,2.25,8.11,5.9,10.22l50.97,29.43c.08.04.17.06.25.1.8.44,1.63.79,2.5,1.03.14.04.29.06.43.09.8.19,1.61.3,2.43.32.1,0,.2.04.3.04.04,0,.09-.02.13-.02.88,0,1.77-.13,2.64-.34.19-.04.37-.1.56-.16.88-.26,1.75-.59,2.57-1.06l25.49-14.71c9.84-5.68,22.06-5.68,31.91,0,9.84,5.68,15.95,16.27,15.95,27.63v29.43c0,.95.15,1.87.37,2.76.05.19.09.37.14.56.25.86.59,1.69,1.03,2.47.07.12.15.22.22.34.43.71.94,1.37,1.51,1.97.1.1.18.21.28.31.65.63,1.37,1.18,2.15,1.66.07.04.13.11.2.16l50.97,29.43c1.83,1.05,3.86,1.58,5.9,1.58s4.08-.53,5.9-1.58l50.97-29.43c3.65-2.11,5.9-6.01,5.9-10.22v-58.86c0-4.22-2.25-8.11-5.9-10.22Z"></path></svg><span class="text-sm font-medium">Devin</span></div></a><button aria-label="Edit Wiki" class="flex items-center rounded-md cursor-pointer transition-all border border-border bg-surface hover:border-border-hover hover:bg-component disabled:cursor-default disabled:opacity-50 disabled:hover:border-border disabled:hover:bg-surface gap-2 px-3 py-1.5 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H216a8,8,0,0,0,0-16H115.32l112-112A16,16,0,0,0,227.32,73.37ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z"></path></svg>Edit Wiki</button><button class="flex items-center rounded-md !text-white cursor-pointer transition-all border bg-blue-500 hover:bg-blue-600 border-blue-500 hover:border-blue-600 dark:bg-blue-900 dark:hover:bg-blue-800 dark:border-blue-900 dark:hover:border-blue-800 disabled:cursor-default disabled:opacity-50 disabled:hover:bg-blue-500 disabled:hover:border-blue-500 dark:disabled:hover:bg-blue-900 dark:disabled:hover:border-blue-900 gap-1.5 px-3 py-1.5 text-sm" aria-label="Share" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg><span>Share</span></button><div class="h-8 w-8"></div></div></div></div></div><!--$--><div class="w-full flex-1"><div class="container-wrapper relative mx-auto h-full px-0"><div class="container relative mx-auto flex h-full w-full flex-col gap-0 max-md:!px-0 md:flex-row md:gap-6 lg:gap-10"><div class="border-r-border hidden max-h-screen border-r border-dashed py-6 pr-4 transition-[border-radius] md:sticky md:left-0 md:top-20 md:block md:h-[calc(100vh-82px)] md:w-64 md:flex-shrink-0 md:overflow-y-auto lg:py-9 xl:w-72"><div class="flex h-full w-full max-w-full flex-shrink-0 flex-col overflow-hidden" style="scrollbar-color:var(--color-border) transparent"><div class="flex-shrink-0 px-2"><div class="text-secondary pb-1 text-xs">Last indexed: <!-- -->6 November 2025<!-- --> (<a href="https://github.com/MoonshotAI/kimi-cli/commits/e613cdd1" target="_blank" rel="noopener noreferrer">e613cd</a>)</div></div><ul class="flex-1 flex-shrink-0 space-y-1 overflow-y-auto py-1" style="scrollbar-width:none"><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/1-overview">Overview</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/2-getting-started">Getting Started</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/2.1-installation-and-configuration">Installation and Configuration</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/2.2-basic-usage">Basic Usage</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/3-architecture-overview">Architecture Overview</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/3.1-cli-entry-point-and-initialization">CLI Entry Point and Initialization</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/3.2-agent-system">Agent System</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/3.3-llm-integration">LLM Integration</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/3.4-communication-layer">Communication Layer</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/4-user-interfaces">User Interfaces</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/4.1-interactive-shell-mode">Interactive Shell Mode</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/4.2-meta-commands">Meta Commands</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/4.3-live-view-and-visualization">Live View and Visualization</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/4.4-print-and-acp-modes">Print and ACP Modes</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/5-agent-configuration">Agent Configuration</a></li><li style="padding-left:12px"><a data-selected="true" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/5.1-agent-specification-format">Agent Specification Format</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/5.2-agent-loading-and-initialization">Agent Loading and Initialization</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/5.3-subagents-and-task-delegation">Subagents and Task Delegation</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6-tool-system">Tool System</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6.1-file-system-tools">File System Tools</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6.2-web-tools">Web Tools</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6.3-system-execution-tools">System Execution Tools</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6.4-task-management-tools">Task Management Tools</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/6.5-time-travel-and-context-tools">Time Travel and Context Tools</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7-advanced-features">Advanced Features</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7.1-context-and-session-management">Context and Session Management</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7.2-approval-system">Approval System</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7.3-d-mail-and-time-travel">D-Mail and Time Travel</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7.4-context-compaction">Context Compaction</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/7.5-auto-update-system">Auto-Update System</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/8-configuration-reference">Configuration Reference</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/8.1-llm-provider-configuration">LLM Provider Configuration</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/8.2-loop-control-and-limits">Loop Control and Limits</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/8.3-external-services">External Services</a></li><li style="padding-left:0"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/9-development-guide">Development Guide</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/9.1-build-system">Build System</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/9.2-testing">Testing</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/9.3-creating-custom-tools">Creating Custom Tools</a></li><li style="padding-left:12px"><a data-selected="false" class="hover:bg-hover block w-full rounded px-2 py-1.5 text-left text-sm transition-none text-secondary data-[selected=true]:bg-hover data-[selected=true]:text-primary font-normal data-[selected=true]:font-normal" href="/MoonshotAI/kimi-cli/9.4-cicd-and-release-process">CI/CD and Release Process</a></li></ul></div></div><div class="flex h-full flex-1 flex-col overflow-hidden"><div class="bg-background border-b-border sticky top-0 z-10 border-b border-dashed md:hidden"><div class="flex cursor-pointer items-center gap-2 p-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="transition-transform"><path d="M184.49,136.49l-80,80a12,12,0,0,1-17-17L159,128,87.51,56.49a12,12,0,1,1,17-17l80,80A12,12,0,0,1,184.49,136.49Z"></path></svg><span class="truncate text-base font-normal">Menu</span></div></div><div class="relative flex-1 overflow-y-auto px-3 pt-3 md:rounded-md md:px-0 md:pt-0 [&amp;_::selection]:bg-purple-500/40" style="scrollbar-color:var(--color-night) transparent"><div class="pb-30 mx-auto max-w-2xl md:pb-40 md:pt-6 lg:pt-8"><div class="prose prose-invert dark:prose-invert prose-headings:text-inherit prose-p:text-inherit max-w-none"><div><div class="prose-custom prose-custom-md prose-custom-gray !max-w-none text-neutral-300 [overflow-wrap:anywhere]"><h1 id="agent-specification-format" class="group" data-header="true">Agent Specification Format<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h1>
<details>
<summary>Relevant source files</summary>
<ul>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span></a></li>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span></a></li>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/tools/web/__init__.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/tools/web/__init__.py</span></a></li>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/tools/web/fetch.md" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/tools/web/fetch.md</span></a></li>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span></a></li>
<li><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span></a></li>
</ul>
</details>
<h2 id="purpose-and-scope" class="group" data-header="true">Purpose and Scope<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name, system prompt, available tools, and subagent configurations.</p>
<p>For information about how agents are loaded and initialized at runtime, see <a href="/MoonshotAI/kimi-cli/5.2-agent-loading-and-initialization" class="text-neutral-300 hover:text-neutral-200 hover:underline">Agent Loading and Initialization</a>. For details on configuring and using subagents for task delegation, see <a href="/MoonshotAI/kimi-cli/5.3-subagents-and-task-delegation" class="text-neutral-300 hover:text-neutral-200 hover:underline">Subagents and Task Delegation</a>.</p>
<hr/>
<h2 id="overview" class="group" data-header="true">Overview<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<p>Agents in kimi-cli are defined using YAML configuration files that specify all aspects of agent behavior. The system supports agent extension (inheritance), allowing agents to build upon existing configurations. Each agent specification references a system prompt markdown file and declares which tools the agent can use.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L1-L25" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-25</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L1-L12" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-12</span></a></p>
<hr/>
<h2 id="yaml-file-structure" class="group" data-header="true">YAML File Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="basic-schema" class="group" data-header="true">Basic Schema<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>All agent specifications follow a consistent top-level structure:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">version</code> field must be set to <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">1</code> (currently the only supported version). The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">agent</code> section contains all agent configuration fields.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L213-L222" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">213-222</span></a></p>
<h3 id="minimum-required-fields" class="group" data-header="true">Minimum Required Fields<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>A valid agent specification requires three mandatory fields:</p>





























<table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Required</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">name</code></td><td>string</td><td>Human-readable agent name</td><td>Yes</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_path</code></td><td>path</td><td>Relative path to system prompt markdown file</td><td>Yes</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">tools</code></td><td>list[string]</td><td>List of tool module paths</td><td>Yes</td></tr></tbody></table>
<p><strong>Example minimal agent</strong>:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L236-L256" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">236-256</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L38-L53" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">38-53</span></a></p>
<hr/>
<h2 id="core-configuration-fields" class="group" data-header="true">Core Configuration Fields<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="agent-name" class="group" data-header="true">Agent Name<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">name</code> field identifies the agent. It can be an empty string for unnamed agents but the field must be present.</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>Empty names are used for subagents that inherit their context from parent agents:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L3-L3" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">3</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L38-L41" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">38-41</span></a></p>
<h3 id="system-prompt-path" class="group" data-header="true">System Prompt Path<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_path</code> specifies a relative path to a markdown file containing the agent&#x27;s system prompt. The path is resolved relative to the agent YAML file location.</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>System prompts support template variable substitution (see Template Variables section below).</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L4-L4" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">4</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L44-L47" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">44-47</span></a></p>
<h3 id="tools-list" class="group" data-header="true">Tools List<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">tools</code> field declares which tools the agent can use. Each tool is specified using the format <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">module.path:ClassName</code>.</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Standard tool modules</strong>:</p>





































<table><thead><tr><th>Module Path</th><th>Available Tools</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.task</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Task</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.think</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Think</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.todo</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">SetTodoList</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.bash</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Bash</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.file</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">ReadFile</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">WriteFile</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">StrReplaceFile</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">PatchFile</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Glob</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Grep</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.web</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">SearchWeb</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">FetchURL</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">kimi_cli.tools.dmail</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">SendDMail</code></td></tr></tbody></table>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L7-L20" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">7-20</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py#L23-L35" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">23-35</span></a></p>
<hr/>
<h2 id="system-prompt-arguments" class="group" data-header="true">System Prompt Arguments<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="template-variable-substitution" class="group" data-header="true">Template Variable Substitution<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>System prompts support template variable substitution using <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">${VARIABLE_NAME}</code> syntax. Variables are provided via the <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_args</code> field:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>If <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system.md</code> contains:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>The resolved prompt becomes:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L5-L6" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">5-6</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L122-L129" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">122-129</span></a></p>
<h3 id="builtin-template-variables" class="group" data-header="true">Builtin Template Variables<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The system automatically provides builtin variables that are always available:</p>






























<table><thead><tr><th>Variable</th><th>Description</th><th>Example Value</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">KIMI_NOW</code></td><td>Current timestamp</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">2024-01-15T10:30:00+00:00</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">KIMI_WORK_DIR</code></td><td>Current working directory path</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">/home/user/project</code></td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">KIMI_WORK_DIR_LS</code></td><td>Directory listing of work dir</td><td>File listing output</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">KIMI_AGENTS_MD</code></td><td>Contents of AGENTS.md if present</td><td>Project agent documentation</td></tr></tbody></table>
<p>These variables are automatically injected and do not need to be declared in <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_args</code>.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py#L65-L72" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">65-72</span></a></p>
<h3 id="multi-line-arguments" class="group" data-header="true">Multi-line Arguments<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>For longer text values, use YAML multi-line string syntax:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L4-L6" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">4-6</span></a></p>
<hr/>
<h2 id="tool-configuration" class="group" data-header="true">Tool Configuration<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="excluding-tools" class="group" data-header="true">Excluding Tools<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">exclude_tools</code> field removes specific tools from the agent&#x27;s toolset. This is useful when extending an agent but wanting to restrict certain capabilities:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>The exclusion is processed after tool loading, so an agent can inherit all parent tools and selectively remove some.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L7-L10" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">7-10</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L56-L62" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">56-62</span></a></p>
<h3 id="tool-loading-process" class="group" data-header="true">Tool Loading Process<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></pre>
<p><strong>Tool instantiation with dependency injection</strong>: Tools are instantiated with required dependencies automatically injected based on their constructor parameters. Available dependency types include <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">AgentGlobals</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Config</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">BuiltinSystemPromptArgs</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Session</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">DenwaRenji</code>, and <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Approval</code>.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L132-L172" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">132-172</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py#L98-L114" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">98-114</span></a></p>
<hr/>
<h2 id="agent-extension" class="group" data-header="true">Agent Extension<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="extending-existing-agents" class="group" data-header="true">Extending Existing Agents<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>Agents can extend other agents using the <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">extend</code> field, creating an inheritance-like relationship. The extending agent inherits all configuration from the base agent and can override specific fields:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<h3 id="extension-resolution" class="group" data-header="true">Extension Resolution<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></pre>
<p><strong>Merge behavior</strong>:</p>
<ul>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">name</code>: Override if specified, otherwise inherit</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_path</code>: Override if specified, otherwise inherit</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_args</code>: Merge dictionaries, child values override parent</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">tools</code>: Override if specified, otherwise inherit</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">exclude_tools</code>: Override if specified, otherwise inherit</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">subagents</code>: Override if specified, otherwise inherit</li>
</ul>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L65-L73" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">65-73</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L75-L120" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">75-120</span></a></p>
<h3 id="default-extension" class="group" data-header="true">Default Extension<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The special value <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">&quot;default&quot;</code> for <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">extend</code> references the built-in default agent configuration:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p>This loads the default agent from <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">DEFAULT_AGENT_FILE</code> and applies overrides.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L75-L120" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">75-120</span></a></p>
<hr/>
<h2 id="subagent-definitions" class="group" data-header="true">Subagent Definitions<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="subagent-configuration" class="group" data-header="true">Subagent Configuration<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>Agents can define subagents for task delegation using the <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">subagents</code> field. Each subagent has a name (used for delegation) and configuration:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<h3 id="subagent-specification-structure" class="group" data-header="true">Subagent Specification Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></pre>
<p><strong>Subagent field structure</strong>:</p>




















<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">path</code></td><td>string</td><td>Relative path to subagent YAML file</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">description</code></td><td>string</td><td>Human-readable description for the main agent</td></tr></tbody></table>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">description</code> is used by the Task tool to help the main agent choose appropriate subagents.</p>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L21-L24" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">21-24</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L1-L12" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-12</span></a></p>
<h3 id="typical-subagent-pattern" class="group" data-header="true">Typical Subagent Pattern<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>Subagents typically:</p>
<ol>
<li><strong>Extend the main agent</strong>: Inherit most configuration</li>
<li><strong>Modify ROLE_ADDITIONAL</strong>: Add context about being a subagent</li>
<li><strong>Exclude high-level tools</strong>: Remove Task, SendDMail, SetTodoList to prevent recursion</li>
<li><strong>Clear subagents field</strong>: Prevent further nesting</li>
</ol>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L1-L12" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-12</span></a></p>
<hr/>
<h2 id="complete-agent-specification-example" class="group" data-header="true">Complete Agent Specification Example<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="main-agent-configuration" class="group" data-header="true">Main Agent Configuration<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>Here is a complete example showing all commonly-used fields:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/agent.yaml#L1-L25" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/agent.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-25</span></a></p>
<hr/>
<h2 id="agent-specification-loading-flow" class="group" data-header="true">Agent Specification Loading Flow<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="from-yaml-to-runtime-agent" class="group" data-header="true">From YAML to Runtime Agent<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></pre>
<p><strong>Key functions involved</strong>:</p>






























<table><thead><tr><th>Function</th><th>Location</th><th>Purpose</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">_load_agent_spec()</code></td><td><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agent.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agent.py</span></a></td><td>Parses YAML and resolves extension</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">_load_system_prompt()</code></td><td><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agent.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agent.py</span></a></td><td>Loads markdown and substitutes variables</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">_load_tools()</code></td><td><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agent.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agent.py</span></a></td><td>Instantiates tool classes with dependencies</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">load_agent()</code></td><td><a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agent.py" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4] rounded-r"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agent.py</span></a></td><td>Orchestrates complete agent loading</td></tr></tbody></table>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L29-L36" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">29-36</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py#L11-L20" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">11-20</span></a></p>
<hr/>
<h2 id="validation-rules" class="group" data-header="true">Validation Rules<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="specification-validation" class="group" data-header="true">Specification Validation<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The agent loading system enforces these validation rules:</p>








































<table><thead><tr><th>Rule</th><th>Error Message</th><th>Validation Point</th></tr></thead><tbody><tr><td>Version must be 1</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Unsupported agent spec version: X</code></td><td>YAML parsing</td></tr><tr><td>File must exist</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">expect agent file to exist</code></td><td>File loading</td></tr><tr><td>Name must be present</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Agent name is required</code></td><td>Field validation</td></tr><tr><td>system_prompt_path required</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">System prompt path is required</code></td><td>Field validation</td></tr><tr><td>tools list required</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Tools are required</code></td><td>Field validation</td></tr><tr><td>Tool modules must be valid</td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Invalid tools: [...]</code></td><td>Tool loading</td></tr></tbody></table>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L207-L230" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">207-230</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L38-L53" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">38-53</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L201-L204" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">201-204</span></a></p>
<h3 id="tool-validation" class="group" data-header="true">Tool Validation<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>During tool loading, the system:</p>
<ol>
<li>Attempts to import each tool module</li>
<li>Attempts to instantiate each tool class with available dependencies</li>
<li>Collects any invalid tool paths</li>
<li>Raises <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">ValueError</code> with list of invalid tools if any fail</li>
</ol>
<p>Invalid tool specifications are reported clearly:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">ValueError: Invalid tools: [&#x27;kimi_cli.tools.nonexistent:Tool&#x27;]
</code></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L153-L172" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">153-172</span></a></p>
<hr/>
<h2 id="agentspec-dataclass-structure" class="group" data-header="true">AgentSpec Dataclass Structure<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="runtime-representation" class="group" data-header="true">Runtime Representation<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p>The <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">AgentSpec</code> dataclass represents the parsed agent configuration:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<h3 id="field-types" class="group" data-header="true">Field Types<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>





















































<table><thead><tr><th>Field</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">name</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">str</code></td><td>Required</td><td>Agent display name</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_path</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Path</code></td><td>Required</td><td>Absolute path to prompt file</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">system_prompt_args</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">dict[str, str]</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">{}</code></td><td>Template variables</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">tools</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">list[str]</code></td><td>Required</td><td>Tool module paths</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">exclude_tools</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">list[str]</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">[]</code></td><td>Tools to exclude</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">subagents</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">dict[str, SubagentSpec]</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">{}</code></td><td>Subagent definitions</td></tr><tr><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">extend</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Path | None</code></td><td><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">None</code></td><td>Resolved during loading</td></tr></tbody></table>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/conftest.py#L11-L20" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/conftest.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">11-20</span></a></p>
<hr/>
<h2 id="best-practices" class="group" data-header="true">Best Practices<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h2>
<h3 id="agent-organization" class="group" data-header="true">Agent Organization<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p><strong>Recommended directory structure</strong>:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">agents/
 my_agent/
    agent.yaml       # Main agent configuration
    system.md        # System prompt
    sub.yaml         # Subagent configuration
    sub_system.md    # Subagent prompt (if different)
</code></pre>
<h3 id="tool-selection-guidelines" class="group" data-header="true">Tool Selection Guidelines<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p><strong>Always include</strong>:</p>
<ul>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Think</code> - For reasoning before actions</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">ReadFile</code> - Nearly always needed for code/file inspection</li>
</ul>
<p><strong>Include for general agents</strong>:</p>
<ul>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">WriteFile</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">StrReplaceFile</code> - File modification</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Glob</code>, <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Grep</code> - File discovery and search</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Bash</code> - System operations</li>
<li><code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Task</code> - If agent needs to delegate work</li>
</ul>
<p><strong>Restrict for subagents</strong>:</p>
<ul>
<li>Remove <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">Task</code> - Prevents recursive delegation</li>
<li>Remove <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">SendDMail</code> - Time travel should be main agent only</li>
<li>Remove <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">SetTodoList</code> - Task tracking at main agent level</li>
</ul>
<h3 id="system-prompt-template-design" class="group" data-header="true">System Prompt Template Design<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p><strong>Use template variables for</strong>:</p>
<ul>
<li>Role modifications (<code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">ROLE_ADDITIONAL</code>)</li>
<li>Project-specific context</li>
<li>Environment information</li>
</ul>
<p><strong>Don&#x27;t hardcode</strong>:</p>
<ul>
<li>Timestamps - use <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">${KIMI_NOW}</code></li>
<li>Directory paths - use <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">${KIMI_WORK_DIR}</code></li>
<li>File listings - use <code class="rounded-sm bg-[#e5e5e5] px-[0.25rem] py-[0.20rem] text-xs font-normal leading-[15px] before:hidden after:hidden dark:bg-[#484848]/30">${KIMI_WORK_DIR_LS}</code></li>
</ul>
<h3 id="extension-patterns" class="group" data-header="true">Extension Patterns<button class="relative ml-2 cursor-pointer align-baseline text-gray-400 opacity-0 transition-opacity hover:text-blue-400 focus:opacity-100 group-hover:opacity-100" aria-label="Copy link to header"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M117.18,188.74a12,12,0,0,1,0,17l-5.12,5.12A58.26,58.26,0,0,1,70.6,228h0A58.62,58.62,0,0,1,29.14,127.92L63.89,93.17a58.64,58.64,0,0,1,98.56,28.11,12,12,0,1,1-23.37,5.44,34.65,34.65,0,0,0-58.22-16.58L46.11,144.89A34.62,34.62,0,0,0,70.57,204h0a34.41,34.41,0,0,0,24.49-10.14l5.11-5.12A12,12,0,0,1,117.18,188.74ZM226.83,45.17a58.65,58.65,0,0,0-82.93,0l-5.11,5.11a12,12,0,0,0,17,17l5.12-5.12a34.63,34.63,0,1,1,49,49L175.1,145.86A34.39,34.39,0,0,1,150.61,156h0a34.63,34.63,0,0,1-33.69-26.72,12,12,0,0,0-23.38,5.44A58.64,58.64,0,0,0,150.56,180h.05a58.28,58.28,0,0,0,41.47-17.17l34.75-34.75a58.62,58.62,0,0,0,0-82.91Z"></path></svg></button></h3>
<p><strong>Prefer extension over duplication</strong>:</p>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&amp;_code]:block [&amp;_code]:border-none [&amp;_code]:bg-transparent [&amp;_code]:p-0"><div class="rounded-sm border border-[#8F8F8F]/30 p-2 text-xs font-normal leading-[15px]" style="background-color:transparent;min-height:2em"></div></pre>
<p><strong>Sources</strong>: <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/tests/test_load_agent.py#L75-L120" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>tests/test_load_agent.py</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">75-120</span></a> <a href="https://github.com/MoonshotAI/kimi-cli/blob/e613cdd1/src/kimi_cli/agents/koder/sub.yaml#L1-L12" target="_blank" rel="noopener noreferrer" class="mb-1 mr-1 inline-flex items-stretch font-mono text-xs !no-underline transition-opacity hover:opacity-75"><span class="flex items-center break-all rounded-l px-2 py-1.5 bg-[#e5e5e5] text-[#333333] dark:bg-[#252525] dark:text-[#e4e4e4]"><svg class="mr-1.5 hidden h-3.5 w-3.5 flex-shrink-0 opacity-40 md:block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>src/kimi_cli/agents/koder/sub.yaml</span><span class="flex flex-shrink-0 items-center rounded-r border-l px-2 py-1.5 border-[#dddddd] bg-[#d8d8d8] text-[#666666] dark:border-[#333333] dark:bg-[#2a2a2a] dark:text-[#888888]">1-12</span></a></p></div></div></div></div></div></div><div class="hidden overflow-hidden transition-[border-radius] xl:sticky xl:right-0 xl:top-20 xl:block xl:h-[calc(100vh-82px)] xl:w-64 xl:flex-shrink-0 2xl:w-72" style="scrollbar-width:none"><div class="flex max-h-full w-full flex-shrink-0 flex-col py-6 pt-0 text-sm lg:pb-4 lg:pt-8 xl:w-64 2xl:w-72" style="scrollbar-color:var(--color-night) transparent"><div><div class="relative mx-4 my-4 rounded-md border border-neutral-200 bg-neutral-100 p-3 text-sm text-neutral-600 dark:border-neutral-800 dark:bg-neutral-900 dark:text-neutral-400"><button class="absolute right-2 top-2 rounded-sm p-1 opacity-70 transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-neutral-400 focus:ring-offset-2"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256" class="h-4 w-4"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg><span class="sr-only">Dismiss</span></button><p class="text-sm font-medium">Refresh this wiki</p><p class="mt-2 text-sm font-light text-neutral-500 dark:text-neutral-400">This wiki was recently refreshed. Please wait<!-- --> <!-- -->4<!-- --> day<!-- -->s<!-- --> to refresh again.</p></div></div><h3 class="px-4 pb-5 text-lg font-medium leading-none">On this page</h3><ul style="scrollbar-width:none" class="min-h-0 flex-1 space-y-3 overflow-y-auto p-4 pt-0"><li class=""><a href="#agent-specification-format" class="hover:text-primary pr-1 transition-all text-primary font-medium">Agent Specification Format</a></li><li class="ml-3"><a href="#purpose-and-scope" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Purpose and Scope</a></li><li class="ml-3"><a href="#overview" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Overview</a></li><li class="ml-3"><a href="#yaml-file-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">YAML File Structure</a></li><li class="ml-6"><a href="#basic-schema" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Basic Schema</a></li><li class="ml-6"><a href="#minimum-required-fields" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Minimum Required Fields</a></li><li class="ml-3"><a href="#core-configuration-fields" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Core Configuration Fields</a></li><li class="ml-6"><a href="#agent-name" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Agent Name</a></li><li class="ml-6"><a href="#system-prompt-path" class="hover:text-primary pr-1 font-normal transition-all text-secondary">System Prompt Path</a></li><li class="ml-6"><a href="#tools-list" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Tools List</a></li><li class="ml-3"><a href="#system-prompt-arguments" class="hover:text-primary pr-1 font-normal transition-all text-secondary">System Prompt Arguments</a></li><li class="ml-6"><a href="#template-variable-substitution" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Template Variable Substitution</a></li><li class="ml-6"><a href="#builtin-template-variables" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Builtin Template Variables</a></li><li class="ml-6"><a href="#multi-line-arguments" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Multi-line Arguments</a></li><li class="ml-3"><a href="#tool-configuration" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Tool Configuration</a></li><li class="ml-6"><a href="#excluding-tools" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Excluding Tools</a></li><li class="ml-6"><a href="#tool-loading-process" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Tool Loading Process</a></li><li class="ml-3"><a href="#agent-extension" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Agent Extension</a></li><li class="ml-6"><a href="#extending-existing-agents" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Extending Existing Agents</a></li><li class="ml-6"><a href="#extension-resolution" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Extension Resolution</a></li><li class="ml-6"><a href="#default-extension" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Default Extension</a></li><li class="ml-3"><a href="#subagent-definitions" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Subagent Definitions</a></li><li class="ml-6"><a href="#subagent-configuration" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Subagent Configuration</a></li><li class="ml-6"><a href="#subagent-specification-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Subagent Specification Structure</a></li><li class="ml-6"><a href="#typical-subagent-pattern" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Typical Subagent Pattern</a></li><li class="ml-3"><a href="#complete-agent-specification-example" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Complete Agent Specification Example</a></li><li class="ml-6"><a href="#main-agent-configuration" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Main Agent Configuration</a></li><li class="ml-3"><a href="#agent-specification-loading-flow" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Agent Specification Loading Flow</a></li><li class="ml-6"><a href="#from-yaml-to-runtime-agent" class="hover:text-primary pr-1 font-normal transition-all text-secondary">From YAML to Runtime Agent</a></li><li class="ml-3"><a href="#validation-rules" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Validation Rules</a></li><li class="ml-6"><a href="#specification-validation" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Specification Validation</a></li><li class="ml-6"><a href="#tool-validation" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Tool Validation</a></li><li class="ml-3"><a href="#agentspec-dataclass-structure" class="hover:text-primary pr-1 font-normal transition-all text-secondary">AgentSpec Dataclass Structure</a></li><li class="ml-6"><a href="#runtime-representation" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Runtime Representation</a></li><li class="ml-6"><a href="#field-types" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Field Types</a></li><li class="ml-3"><a href="#best-practices" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Best Practices</a></li><li class="ml-6"><a href="#agent-organization" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Agent Organization</a></li><li class="ml-6"><a href="#tool-selection-guidelines" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Tool Selection Guidelines</a></li><li class="ml-6"><a href="#system-prompt-template-design" class="hover:text-primary pr-1 font-normal transition-all text-secondary">System Prompt Template Design</a></li><li class="ml-6"><a href="#extension-patterns" class="hover:text-primary pr-1 font-normal transition-all text-secondary">Extension Patterns</a></li></ul></div></div><div class="pointer-events-none fixed bottom-2 left-2 right-2 mt-2 md:bottom-4 md:left-0 md:right-0"><div class="z-10 mx-auto max-w-3xl"><!--$!--><template data-dgst="BAILOUT_TO_CLIENT_SIDE_RENDERING"></template><!--/$--></div></div></div></div></div><!--/$--></div><!--/$--><script src="/_next/static/chunks/webpack-acbbbb548492d4a6.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[51709,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4420\",\"static/chunks/4420-863691215dce8f1b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6417\",\"static/chunks/6417-34cc3208366c5e5f.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4348\",\"static/chunks/4348-824485747071bae4.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"3224\",\"static/chunks/3224-7e9887ea92eab174.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6967\",\"static/chunks/6967-c4b815e71e97ed18.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"7177\",\"static/chunks/app/layout-37a15e31a18fac3d.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\"],\"RootProvider\"]\n3:I[87555,[],\"\"]\n4:I[31295,[],\"\"]\n6:I[90894,[],\"ClientPageRoot\"]\n7:I[87667,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4129\",\"static/chunks/7bf36345-06f80506190927ed.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2545\",\"static/chunks/c16f53c3-1a60b9b77b3e1d4b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4420\",\"static/chunks/4420-863691215dce8f1b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6417\",\"static/chunks/6417-34cc3208366c5e5f.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4348\",\"static/chunks/4348-824485747071bae4.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"3224\",\"static/chunks/3224-7e9887ea92eab174.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2249\",\"static/chunks/2249-342d7235b3a68051.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"9970\",\"static/chunks/9970-31fea4ade6367f07.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6967\",\"static/chunks/6967-c4b815e71e97ed18.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1769\",\"static/chunks/1769-6bbc7ae2dcadfa9c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"655\",\"static/c"])</script><script>self.__next_f.push([1,"hunks/655-b5574efc1f81bad2.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4154\",\"static/chunks/4154-f7634cd651686b21.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"3639\",\"static/chunks/3639-900f572b0aed0454.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"8613\",\"static/chunks/8613-da4dddfdd374b6ba.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4870\",\"static/chunks/4870-8871061efa4307d3.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"3285\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/%5B%5B...wikiRoutes%5D%5D/page-78fac26cbb8eb9a1.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\"],\"default\"]\na:I[59665,[],\"OutletBoundary\"]\nd:I[59665,[],\"ViewportBoundary\"]\nf:I[59665,[],\"MetadataBoundary\"]\n11:I[26614,[],\"\"]\n:HL[\"/_next/static/media/4cf2300e9c8272f7-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/93f479601ee12b01-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/de70bee13400563f.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"style\"]\n:HL[\"/_next/static/css/21563f70193c14e1.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"PQmYJS_Aliaw07eQsj4km\",\"p\":\"\",\"c\":[\"\",\"MoonshotAI\",\"kimi-cli\",\"5.1-agent-specification-format\"],\"i\":false,\"f\":[[[\"\",{\"children\":[[\"org\",\"MoonshotAI\",\"d\"],{\"children\":[[\"repo\",\"kimi-cli\",\"d\"],{\"children\":[[\"wikiRoutes\",\"5.1-agent-specification-format\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/de70bee13400563f.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/21563f70193c14e1.css?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[[\"$\",\"head\",null,{}],[\"$\",\"body\",null,{\"className\":\"__variable_188709 font-geist-sans relative min-h-screen __variable_9a8899 bg-background antialiased\",\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}]]}],{\"children\":[[\"org\",\"MoonshotAI\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"repo\",\"kimi-cli\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,\"$L5\"]}],{\"children\":[[\"wikiRoutes\",\"5.1-agent-specification-format\",\"oc\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[\"$\",\"$L6\",null,{\"Component\":\"$7\",\"searchParams\":{},\"params\":{\"org\":\"MoonshotAI\",\"repo\":\"kimi-cli\",\"wikiRoutes\":[\"5.1-agent-specification-format\"]},\"promises\":[\"$@8\",\"$@9\"]}],\"$undefined\",null,[\"$\",\"$La\",null,{\"children\":[\"$Lb\",\"$Lc\",null]}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"7l0_xrfdDJSsO54odJJ0I\",{\"children\":[[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Lf\",null,{\"children\":\"$L10\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$11\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"8:{}\n9:{\"org\":\"MoonshotAI\",\"repo\":\"kimi-cli\",\"wikiRoutes\":\"$0:f:0:1:2:children:2:children:2:children:2:children:1:props:children:0:props:params:wikiRoutes\"}\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\nb:null\n"])</script><script>self.__next_f.push([1,"12:I[87437,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4420\",\"static/chunks/4420-863691215dce8f1b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6417\",\"static/chunks/6417-34cc3208366c5e5f.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4348\",\"static/chunks/4348-824485747071bae4.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2249\",\"static/chunks/2249-342d7235b3a68051.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"9970\",\"static/chunks/9970-31fea4ade6367f07.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"655\",\"static/chunks/655-b5574efc1f81bad2.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"3449\",\"static/chunks/3449-aaf01d1b29913c28.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"7553\",\"static/chunks/7553-2bb9c132a5788553.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1127\",\"static/chunks/1127-b475c4cc62d0a830.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"736\",\"static/chunks/736-90a1c8956f4d3102.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2933\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-99964eedd99460bc.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\"],\"HeaderWrapperWithSuspense\"]\n13:I[93403,[\"9453\",\"static/chunks/b1298b8d-549c141f97a3b262.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"8970\",\"static/chunks/378e5a93-3b0f971d3611a8a5.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1585\",\"static/chunks/f7f68e2d-40290491c524df5c.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4420\",\"static/chunks/4420-863691215dce8f1b.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"6417\",\"static/chunks/6417-34cc3208366c5e5f.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"4348\",\"static/chunks/4348-824485747071bae4.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2249\",\"static/chunks/2249-342d7235b3a68051.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"9970\",\"static/chunks/9970-31fea4ade6367f07.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"655\",\"static/chunks/655-b5574efc1f81bad2.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze"])</script><script>self.__next_f.push([1,"6m1w\",\"3449\",\"static/chunks/3449-aaf01d1b29913c28.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"7553\",\"static/chunks/7553-2bb9c132a5788553.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"1127\",\"static/chunks/1127-b475c4cc62d0a830.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"736\",\"static/chunks/736-90a1c8956f4d3102.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\",\"2933\",\"static/chunks/app/%5Borg%5D/%5Brepo%5D/layout-99964eedd99460bc.js?dpl=dpl_HPUtPsuSBJ3XoKhCjPxGnhze6m1w\"],\"WikiContextProvider\"]\n14:T3d6e,"])</script><script>self.__next_f.push([1,"# Overview\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document provides a high-level introduction to kimi-cli, an AI-powered command-line agent system. It describes the project's purpose, core capabilities, architectural layers, and key components. For installation instructions, see [Installation and Configuration](#2.1). For detailed architecture information, see [Architecture Overview](#3). For information about specific tools and features, consult sections [Tool System](#6) and [Advanced Features](#7).\n\n**Sources:** [pyproject.toml:1-5](), [CHANGELOG.md:1-336]()\n\n## What is Kimi CLI\n\nKimi CLI is an AI-powered command-line agent system that enables Large Language Models (LLMs) to interact with your local development environment through a structured set of tools. The agent can read and modify files, execute shell commands, search the web, and manage complex tasks through subagent delegation.\n\nThe system is distributed both as a Python package (`kimi-cli` on PyPI) and as standalone binaries for Linux and macOS platforms. It supports multiple LLM providers including Kimi, OpenAI, and custom OpenAI-compatible endpoints.\n\n**Sources:** [pyproject.toml:1-47](), [src/kimi_cli/__init__.py:1-43]()\n\n## Core Capabilities\n\n| Capability | Description | Key Components |\n|------------|-------------|----------------|\n| **File Operations** | Read, write, patch, search, and glob files | `ReadFile`, `WriteFile`, `StrReplaceFile`, `PatchFile`, `Glob`, `Grep` |\n| **Shell Execution** | Run bash commands with timeout and approval | `Bash` tool |\n| **Web Integration** | Search web and fetch URLs | `SearchWeb`, `FetchURL` tools |\n| **Task Delegation** | Spawn isolated subagents for parallel execution | `Task` tool, `AgentSpec` |\n| **Time Travel** | Checkpoint and revert conversation context | `SendDMail` tool, `DenwaRenji` system |\n| **Progress Tracking** | Maintain todo lists and reasoning logs | `SetTodoList`, `Think` tools |\n| **Interactive UI** | Rich terminal interface with auto-completion | `ShellApp`, `CustomPromptSession` |\n| **Non-Interactive Mode** | Pipeline-friendly text and JSON I/O | `PrintApp`, stream-json format |\n| **Agent Protocol** | Server mode for programmatic access | `ACPServer`, Agent Client Protocol |\n\n**Sources:** [CHANGELOG.md:14-336](), [src/kimi_cli/__init__.py:46-47]()\n\n## System Architecture\n\n### Entry Point and Main Components\n\n```mermaid\ngraph TB\n    subgraph \"Entry Point\"\n        main[\"main()\u003cbr/\u003ekimi_cli/__init__.py\"]\n        kimi_cmd[\"kimi() CLI command\u003cbr/\u003e@click.command\"]\n        kimi_run[\"kimi_run() async\u003cbr/\u003eCore orchestration\"]\n    end\n    \n    subgraph \"Configuration Layer\"\n        Config[\"Config\u003cbr/\u003econfig.py:Config\"]\n        load_config[\"load_config()\u003cbr/\u003eReads config.json\"]\n        LLMModel[\"LLMModel\u003cbr/\u003emodel + max_context_size\"]\n        LLMProvider[\"LLMProvider\u003cbr/\u003etype + base_url + api_key\"]\n    end\n    \n    subgraph \"Agent Layer\"\n        AgentSpec[\"AgentSpec\u003cbr/\u003eagent.py:AgentSpec\"]\n        load_agent[\"load_agent()\u003cbr/\u003eLoads YAML definition\"]\n        Agent[\"Agent\u003cbr/\u003ename + system_prompt + toolset\"]\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003eContainer for dependencies\"]\n    end\n    \n    subgraph \"Core Execution\"\n        KimiSoul[\"KimiSoul\u003cbr/\u003esoul/kimisoul.py\"]\n        Context[\"Context\u003cbr/\u003esoul/context.py\"]\n        DenwaRenji[\"DenwaRenji\u003cbr/\u003esoul/denwarenji.py\"]\n        Approval[\"Approval\u003cbr/\u003esoul/approval.py\"]\n    end\n    \n    subgraph \"Tools\"\n        CustomToolset[\"CustomToolset\u003cbr/\u003esoul/toolset.py\"]\n        FileTools[\"File tools\u003cbr/\u003etools/file/*\"]\n        BashTool[\"Bash tool\u003cbr/\u003etools/bash\"]\n        WebTools[\"Web tools\u003cbr/\u003etools/web/*\"]\n        TaskTool[\"Task tool\u003cbr/\u003etools/task\"]\n    end\n    \n    subgraph \"UI Layer\"\n        ShellApp[\"ShellApp\u003cbr/\u003eui/shell/__init__.py\"]\n        PrintApp[\"PrintApp\u003cbr/\u003eui/print.py\"]\n        ACPServer[\"ACPServer\u003cbr/\u003eui/acp.py\"]\n    end\n    \n    main --\u003e kimi_cmd\n    kimi_cmd --\u003e kimi_run\n    \n    kimi_run --\u003e load_config\n    load_config --\u003e Config\n    Config --\u003e LLMModel\n    Config --\u003e LLMProvider\n    \n    kimi_run --\u003e load_agent\n    load_agent --\u003e AgentSpec\n    AgentSpec --\u003e Agent\n    kimi_run --\u003e AgentGlobals\n    \n    AgentGlobals --\u003e Config\n    AgentGlobals --\u003e DenwaRenji\n    AgentGlobals --\u003e Approval\n    \n    Agent --\u003e CustomToolset\n    CustomToolset --\u003e FileTools\n    CustomToolset --\u003e BashTool\n    CustomToolset --\u003e WebTools\n    CustomToolset --\u003e TaskTool\n    \n    kimi_run --\u003e Context\n    kimi_run --\u003e KimiSoul\n    \n    Agent --\u003e KimiSoul\n    AgentGlobals --\u003e KimiSoul\n    Context --\u003e KimiSoul\n    \n    kimi_run --\u003e ShellApp\n    kimi_run --\u003e PrintApp\n    kimi_run --\u003e ACPServer\n    \n    ShellApp --\u003e KimiSoul\n    PrintApp --\u003e KimiSoul\n    ACPServer --\u003e KimiSoul\n```\n\n**Architecture Overview:** The system follows a layered architecture starting from the `main()` entry point. The CLI command parser (`kimi()`) delegates to `kimi_run()`, which orchestrates configuration loading, agent initialization, and UI mode selection. Configuration flows from `config.json` into `Config`, `LLMModel`, and `LLMProvider` objects. Agents are loaded from YAML files into `AgentSpec` structures, which combine with `AgentGlobals` (a dependency injection container) to produce executable `Agent` instances. The core execution engine `KimiSoul` orchestrates LLM interactions, tool execution, and context management. Three UI modes (`ShellApp`, `PrintApp`, `ACPServer`) provide different interaction paradigms while sharing the same underlying execution engine.\n\n**Sources:** [src/kimi_cli/__init__.py:49-388](), [src/kimi_cli/agent.py:23-143]()\n\n### Agent Execution Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant ShellApp as \"ShellApp\u003cbr/\u003eui/shell\"\n    participant KimiSoul as \"KimiSoul\u003cbr/\u003esoul/kimisoul\"\n    participant Context as \"Context\u003cbr/\u003esoul/context\"\n    participant LLM as \"LLM\u003cbr/\u003ellm.py\"\n    participant Tools as \"CustomToolset\u003cbr/\u003esoul/toolset\"\n    participant Approval as \"Approval\u003cbr/\u003esoul/approval\"\n    participant Wire as \"Wire\u003cbr/\u003ekosong.Wire\"\n    \n    User-\u003e\u003eShellApp: \"Input command\"\n    ShellApp-\u003e\u003eKimiSoul: \"run(user_input, wire)\"\n    \n    KimiSoul-\u003e\u003eContext: \"checkpoint()\"\n    Note over Context: \"Create checkpoint_id\"\n    \n    KimiSoul-\u003e\u003eContext: \"append_message(user_msg)\"\n    \n    loop \"Agent loop (max 100 steps)\"\n        KimiSoul-\u003e\u003eWire: \"send(StepBegin)\"\n        \n        alt \"Context \u003e max_context_size\"\n            KimiSoul-\u003e\u003eContext: \"compact_context()\"\n            KimiSoul-\u003e\u003eWire: \"send(CompactionBegin/End)\"\n        end\n        \n        KimiSoul-\u003e\u003eLLM: \"step(messages, tools)\"\n        LLM--\u003e\u003eKimiSoul: \"StepResult(text, tool_calls)\"\n        \n        KimiSoul-\u003e\u003eWire: \"send(text_parts)\"\n        \n        loop \"For each tool_call\"\n            KimiSoul-\u003e\u003eTools: \"call_tool(tool_call)\"\n            \n            opt \"Tool requires approval\"\n                Tools-\u003e\u003eApproval: \"request_approval()\"\n                Approval-\u003e\u003eWire: \"send(ApprovalRequest)\"\n                Wire--\u003e\u003eShellApp: \"Display approval menu\"\n                ShellApp--\u003e\u003eApproval: \"User decision\"\n            end\n            \n            Tools--\u003e\u003eKimiSoul: \"ToolResult\"\n            KimiSoul-\u003e\u003eWire: \"send(ToolResult)\"\n        end\n        \n        KimiSoul-\u003e\u003eContext: \"append_message(assistant_msg)\"\n        \n        alt \"D-Mail received\"\n            KimiSoul-\u003e\u003eContext: \"revert_to(checkpoint_id)\"\n            KimiSoul-\u003e\u003eContext: \"append_message(dmail)\"\n            Note over KimiSoul: \"Continue loop\"\n        else \"No tool calls\"\n            Note over KimiSoul: \"Exit loop\"\n        end\n    end\n    \n    KimiSoul--\u003e\u003eShellApp: \"Completed\"\n    ShellApp--\u003e\u003eUser: \"Display results\"\n```\n\n**Execution Flow:** User input flows from the UI layer (`ShellApp`) to the `KimiSoul` execution engine via the `run()` method. `KimiSoul` creates a checkpoint in `Context`, then enters an agent loop (max 100 steps). Each iteration sends a `StepBegin` event via `Wire`, checks if context compaction is needed, queries the `LLM` with current messages and available tools, receives a `StepResult` containing text and tool calls, and executes each tool through the `CustomToolset`. Tools requiring approval send `ApprovalRequest` events through `Wire` to the UI, blocking execution until the user responds. Tool results are appended to context, and the loop continues until no tool calls remain or a D-Mail triggers time-travel via checkpoint reversion.\n\n**Sources:** [src/kimi_cli/__init__.py:256-380]()\n\n## Key Components and Responsibilities\n\n### Agent Definition System\n\n| Component | Location | Responsibility |\n|-----------|----------|----------------|\n| `AgentSpec` | [agent.py:23-37]() | YAML schema for agent definitions with inheritance |\n| `Agent` | [agent.py:70-76]() | Runtime agent instance (name, system_prompt, toolset) |\n| `load_agent()` | [agent.py:97-143]() | Loads and validates agent from YAML, resolves inheritance |\n| `DEFAULT_AGENT_FILE` | [agent.py:82]() | Points to builtin Kimi Koder agent definition |\n| `AgentGlobals` | [agent.py:59-68]() | Dependency injection container for tools |\n| `BuiltinSystemPromptArgs` | [agent.py:46-57]() | Environment variables like `KIMI_WORK_DIR`, `KIMI_NOW` |\n\n**Sources:** [src/kimi_cli/agent.py:23-143]()\n\n### Execution Engine\n\n| Component | Location | Responsibility |\n|-----------|----------|----------------|\n| `KimiSoul` | [soul/kimisoul.py]() | Core agent execution loop, LLM interaction orchestration |\n| `Context` | [soul/context.py]() | Message history management, persistence, checkpointing |\n| `DenwaRenji` | [soul/denwarenji.py]() | Time-travel mechanism for D-Mail (checkpoint-based reversion) |\n| `Approval` | [soul/approval.py]() | User approval gating for dangerous tools (Bash, file writes) |\n| `Session` | [metadata.py]() | Session metadata, history file path management |\n\n**Sources:** [src/kimi_cli/__init__.py:31-36]()\n\n### UI Modes\n\n| Mode | Class | Location | Use Case |\n|------|-------|----------|----------|\n| Interactive Shell | `ShellApp` | [ui/shell/__init__.py]() | Rich terminal with prompt_toolkit, auto-completion, history |\n| Non-Interactive | `PrintApp` | [ui/print.py]() | Pipeline-friendly text or stream-json I/O |\n| Agent Protocol | `ACPServer` | [ui/acp.py]() | Server implementing Agent Client Protocol for programmatic access |\n\n**Sources:** [src/kimi_cli/__init__.py:37-39]()\n\n### Tool Categories\n\n```mermaid\ngraph LR\n    subgraph \"File System Tools\"\n        ReadFile[\"ReadFile\u003cbr/\u003etools/file/read.py\"]\n        WriteFile[\"WriteFile\u003cbr/\u003etools/file/write.py\"]\n        StrReplaceFile[\"StrReplaceFile\u003cbr/\u003etools/file/str_replace.py\"]\n        PatchFile[\"PatchFile\u003cbr/\u003etools/file/patch.py\"]\n        Glob[\"Glob\u003cbr/\u003etools/file/glob.py\"]\n        Grep[\"Grep\u003cbr/\u003etools/file/grep.py\"]\n    end\n    \n    subgraph \"Web Tools\"\n        SearchWeb[\"SearchWeb\u003cbr/\u003etools/web/search.py\"]\n        FetchURL[\"FetchURL\u003cbr/\u003etools/web/fetch.py\"]\n    end\n    \n    subgraph \"System Tools\"\n        Bash[\"Bash\u003cbr/\u003etools/bash/__init__.py\"]\n    end\n    \n    subgraph \"Context Tools\"\n        Task[\"Task\u003cbr/\u003etools/task/__init__.py\"]\n        Think[\"Think\u003cbr/\u003etools/think.py\"]\n        SetTodoList[\"SetTodoList\u003cbr/\u003etools/todo.py\"]\n        SendDMail[\"SendDMail\u003cbr/\u003etools/dmail.py\"]\n    end\n    \n    subgraph \"Dependencies\"\n        Approval_dep[\"Approval\"]\n        BuiltinArgs[\"BuiltinSystemPromptArgs\"]\n        Config_dep[\"Config\"]\n        DenwaRenji_dep[\"DenwaRenji\"]\n    end\n    \n    Bash --\u003e Approval_dep\n    WriteFile --\u003e Approval_dep\n    StrReplaceFile --\u003e Approval_dep\n    PatchFile --\u003e Approval_dep\n    \n    ReadFile --\u003e BuiltinArgs\n    WriteFile --\u003e BuiltinArgs\n    Glob --\u003e BuiltinArgs\n    \n    SearchWeb --\u003e Config_dep\n    \n    SendDMail --\u003e DenwaRenji_dep\n```\n\n**Tool Organization:** Tools are organized by functional category. File system tools handle file operations with most write operations requiring approval. Web tools integrate external services (Moonshot Search API, trafilatura). System tools provide shell execution. Context tools enable advanced agent behaviors: `Task` spawns subagents, `SendDMail` implements time-travel, while `Think` and `SetTodoList` support reasoning and progress tracking. Dependencies are injected via the `AgentGlobals` container pattern.\n\n**Sources:** [src/kimi_cli/agent.py:120-136]()\n\n## Configuration and Extension\n\nThe system supports multiple layers of configuration:\n\n| Layer | File/Location | Purpose |\n|-------|---------------|---------|\n| **System Config** | `~/.config/kimi/config.json` | LLM providers, models, loop control, services |\n| **Default Agent** | `kimi_cli/agents/koder/agent.yaml` | Builtin Kimi Koder agent definition |\n| **Project Agent** | `./AGENTS.md` or `./agents.md` | Project-specific agent instructions |\n| **Custom Agent** | `--agent-file path/to/agent.yaml` | User-specified agent definition with inheritance |\n| **MCP Config** | `--mcp-config-file` or `--mcp-config` | External tool server configurations |\n| **Environment Variables** | `MOONSHOT_*`, `OPENAI_*`, etc. | Override provider settings at runtime |\n\nAgent definitions support inheritance via the `extend` field, allowing customization while maintaining compatibility with the base agent. For example, a custom agent can `extend: default` to inherit Kimi Koder's configuration while overriding specific tools or system prompt arguments.\n\n**Sources:** [src/kimi_cli/__init__.py:64-154](), [src/kimi_cli/agent.py:145-179]()\n\n## Command-Line Interface\n\nThe primary entry point is the `kimi` command defined in [src/kimi_cli/__init__.py:49-179](). Key options include:\n\n- `--agent-file`: Specify custom agent definition (default: builtin Kimi Koder)\n- `--model`, `-m`: Select LLM model from config\n- `--work-dir`, `-w`: Set working directory (default: current directory)\n- `--continue`, `-C`: Resume previous session for the working directory\n- `--command`, `-c`: Execute single command (non-interactive)\n- `--ui`: Select UI mode (shell, print, acp)\n- `--yolo`, `-y`: Auto-approve all tool executions\n- `--mcp-config-file`, `--mcp-config`: Load MCP tool servers\n\nThe session system automatically persists conversation history to `~/.local/share/kimi/sessions/\u003csession_id\u003e/history.jsonl`, enabling session continuation across runs.\n\n**Sources:** [src/kimi_cli/__init__.py:49-179](), [pyproject.toml:45-46]()\n\n## Distribution and Dependencies\n\nKimi CLI is distributed through two channels:\n\n1. **PyPI Package**: `pip install kimi-cli` installs the Python package with all dependencies\n2. **Standalone Binaries**: Platform-specific executables (Linux x86_64, macOS Intel/ARM) bundled with dependencies including the `ripgrep` binary\n\nCore dependencies include:\n- `kosong`: Agent framework and tooling abstraction\n- `prompt-toolkit`: Rich interactive terminal UI\n- `rich`: Terminal formatting and markdown rendering\n- `trafilatura`: Web content extraction\n- `ripgrepy`: Fast file search (wraps ripgrep)\n- `fastmcp`: Model Context Protocol client\n- `agent-client-protocol`: ACP server implementation\n\n**Sources:** [pyproject.toml:7-25](), [pyproject.toml:45-46]()\n\n## Development and Release\n\nThe project uses:\n- `uv` for Python dependency management\n- `ruff` for linting and formatting\n- `pyright` for type checking\n- `pytest` for testing\n- `PyInstaller` for binary packaging\n\nCI/CD workflows automate testing on every PR and produce multi-platform releases on tag pushes. See [Development Guide](#9) for detailed information.\n\n**Sources:** [pyproject.toml:27-60](), [CHANGELOG.md:1-11]()"])</script><script>self.__next_f.push([1,"15:T3c7d,"])</script><script>self.__next_f.push([1,"# Getting Started\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis document guides you through the initial setup and first interactions with kimi-cli. It provides an overview of installation methods, basic configuration requirements, and a walkthrough of your first agent session. For detailed installation procedures and configuration options, see [Installation and Configuration](#2.1). For comprehensive usage patterns and command-line options, see [Basic Usage](#2.2).\n\n## Purpose and Scope\n\nThis page covers:\n- Prerequisites for running kimi-cli\n- Overview of installation methods (PyPI and binary releases)\n- Initial configuration of LLM providers\n- First-time execution workflow\n- Simple usage examples to verify setup\n\nFor architecture details about how the system works internally, see [Architecture Overview](#3).\n\n---\n\n## Prerequisites\n\nBefore installing kimi-cli, ensure you have:\n\n- **Python 3.13 or higher** (if installing via PyPI)\n- **API access to an LLM provider**:\n  - Moonshot Kimi API (recommended)\n  - OpenAI-compatible API\n  - Other compatible providers\n- **Operating system**: Linux (x86_64), macOS (Intel or ARM)\n- **Terminal with UTF-8 support** for rich text rendering\n\n**Sources**: [pyproject.toml:6-7]()\n\n---\n\n## Installation Methods Overview\n\nkimi-cli can be installed through two primary methods:\n\n| Method | Use Case | Distribution |\n|--------|----------|--------------|\n| **PyPI Package** | Python developers, pip/uv users | `pip install kimi-cli` |\n| **Binary Release** | Standalone execution, CI/CD | GitHub releases (tar.gz) |\n\nThe PyPI package name is `kimi-cli` and the command-line entry point is `kimi`. The binary distribution includes bundled dependencies like `ripgrep` for enhanced file search capabilities.\n\n```bash\n# PyPI installation\npip install kimi-cli\n\n# Verify installation\nkimi --version\n```\n\nFor detailed installation instructions including binary setup, environment configuration, and troubleshooting, see [Installation and Configuration](#2.1).\n\n**Sources**: [pyproject.toml:1-6](), [pyproject.toml:45-46]()\n\n---\n\n## First Run Workflow\n\nThe following diagram illustrates the complete initialization sequence from first invocation to agent execution:\n\n**Diagram: kimi CLI First Run Initialization Flow**\n\n```mermaid\ngraph TB\n    UserCmd[\"User executes\u003cbr/\u003e'kimi' command\"]\n    ClickCmd[\"click.command decorator\u003cbr/\u003ekimi()\"]\n    LoadConfig[\"load_config()\u003cbr/\u003e~/.config/kimi-cli/config.json\"]\n    \n    ConfigCheck{Config exists?}\n    UseConfig[\"Use configured\u003cbr/\u003eLLM provider/model\"]\n    EnvVars[\"Check environment vars:\u003cbr/\u003eKIMI_BASE_URL\u003cbr/\u003eKIMI_API_KEY\u003cbr/\u003eKIMI_MODEL\"]\n    \n    EnvCheck{Env vars set?}\n    \n    SetupPrompt[\"Prompt user with\u003cbr/\u003e/setup meta command\"]\n    \n    SessionCreate[\"new_session(work_dir)\u003cbr/\u003eor continue_session()\"]\n    \n    LoadAgent[\"load_agent()\u003cbr/\u003eDEFAULT_AGENT_FILE or\u003cbr/\u003e--agent-file\"]\n    \n    AgentSpec[\"_load_agent_spec()\u003cbr/\u003eParse YAML\"]\n    SystemPrompt[\"_load_system_prompt()\u003cbr/\u003eSubstitute KIMI_* args\"]\n    LoadTools[\"_load_tools()\u003cbr/\u003eDependency injection\"]\n    \n    ContextInit[\"Context(session.history_file)\u003cbr/\u003eRestore if exists\"]\n    \n    SoulInit[\"KimiSoul(agent, globals, context)\"]\n    \n    UISelect{UI Mode?}\n    ShellApp[\"ShellApp(soul)\u003cbr/\u003eInteractive prompt\"]\n    PrintApp[\"PrintApp(soul)\u003cbr/\u003eNon-interactive\"]\n    ACPServer[\"ACPServer(soul)\u003cbr/\u003eAgent protocol\"]\n    \n    Ready[\"Agent ready\u003cbr/\u003efor user input\"]\n    \n    UserCmd --\u003e ClickCmd\n    ClickCmd --\u003e LoadConfig\n    LoadConfig --\u003e ConfigCheck\n    \n    ConfigCheck --\u003e|Yes| UseConfig\n    ConfigCheck --\u003e|No| EnvVars\n    \n    EnvVars --\u003e EnvCheck\n    EnvCheck --\u003e|Yes| UseConfig\n    EnvCheck --\u003e|No| SetupPrompt\n    \n    UseConfig --\u003e SessionCreate\n    SetupPrompt --\u003e SessionCreate\n    \n    SessionCreate --\u003e LoadAgent\n    LoadAgent --\u003e AgentSpec\n    AgentSpec --\u003e SystemPrompt\n    AgentSpec --\u003e LoadTools\n    \n    SystemPrompt --\u003e ContextInit\n    LoadTools --\u003e ContextInit\n    \n    ContextInit --\u003e SoulInit\n    \n    SoulInit --\u003e UISelect\n    UISelect --\u003e|\"--ui shell\"| ShellApp\n    UISelect --\u003e|\"--ui print\"| PrintApp\n    UISelect --\u003e|\"--ui acp\"| ACPServer\n    \n    ShellApp --\u003e Ready\n    PrintApp --\u003e Ready\n    ACPServer --\u003e Ready\n```\n\n**Key initialization functions:**\n\n1. **`kimi()`** ([src/kimi_cli/__init__.py:165-254]()) - Main CLI entry point decorated with `@click.command`\n2. **`load_config()`** ([src/kimi_cli/config.py]()) - Loads `~/.config/kimi-cli/config.json` or environment variables\n3. **`new_session()` / `continue_session()`** ([src/kimi_cli/metadata.py]()) - Creates or restores session state\n4. **`load_agent()`** ([src/kimi_cli/agent.py:97-142]()) - Loads agent specification from YAML\n5. **`Context()`** ([src/kimi_cli/soul/context.py]()) - Manages conversation history\n6. **`KimiSoul()`** ([src/kimi_cli/soul/kimisoul.py]()) - Core agent execution engine\n\n**Sources**: [src/kimi_cli/__init__.py:165-254](), [src/kimi_cli/__init__.py:256-379](), [src/kimi_cli/agent.py:97-142]()\n\n---\n\n## Configuration Quick Start\n\nkimi-cli requires LLM provider configuration before first use. Configuration can be provided through three methods:\n\n**Diagram: Configuration Discovery and Precedence**\n\n```mermaid\ngraph LR\n    subgraph \"Configuration Sources\"\n        EnvVars[\"Environment Variables\u003cbr/\u003eKIMI_BASE_URL\u003cbr/\u003eKIMI_API_KEY\u003cbr/\u003eKIMI_MODEL\"]\n        ConfigFile[\"config.json\u003cbr/\u003e~/.config/kimi-cli/\"]\n        Defaults[\"Fallback Defaults\u003cbr/\u003eEmpty provider\"]\n    end\n    \n    subgraph \"Loading Process\"\n        LoaderFunc[\"load_config()\"]\n        Augment[\"augment_provider_with_env_vars()\"]\n        ValidCheck{Valid config?}\n    end\n    \n    subgraph \"Result\"\n        Provider[\"LLMProvider instance\"]\n        Model[\"LLMModel instance\"]\n        LLMCreate[\"create_llm()\"]\n    end\n    \n    ConfigFile --\u003e LoaderFunc\n    LoaderFunc --\u003e Augment\n    EnvVars --\u003e Augment\n    Augment --\u003e ValidCheck\n    ValidCheck --\u003e|Yes| Provider\n    ValidCheck --\u003e|No| Defaults\n    Defaults --\u003e Provider\n    \n    Provider --\u003e LLMCreate\n    Model --\u003e LLMCreate\n```\n\n### Interactive Setup\n\nOn first run without configuration, use the `/setup` meta command:\n\n```bash\n$ kimi\nWelcome to Kimi CLI!\nNo LLM configuration found.\n\n\u003e /setup\n```\n\nThe interactive setup wizard will guide you through:\n1. Selecting an LLM provider (Kimi, OpenAI, etc.)\n2. Entering your API key\n3. Choosing a model\n4. Saving configuration to `~/.config/kimi-cli/config.json`\n\n### Environment Variable Setup\n\nAlternatively, set environment variables:\n\n```bash\nexport KIMI_BASE_URL=\"https://api.moonshot.cn/v1\"\nexport KIMI_API_KEY=\"your-api-key\"\nexport KIMI_MODEL=\"moonshot-v1-8k\"\n\nkimi\n```\n\n### Configuration File Example\n\nCreate `~/.config/kimi-cli/config.json`:\n\n```json\n{\n  \"providers\": {\n    \"kimi\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"your-api-key\"\n    }\n  },\n  \"models\": {\n    \"kimi-8k\": {\n      \"provider\": \"kimi\",\n      \"model\": \"moonshot-v1-8k\",\n      \"max_context_size\": 8000\n    }\n  },\n  \"default_model\": \"kimi-8k\"\n}\n```\n\nFor complete configuration reference including loop control, external services, and MCP servers, see [Configuration Reference](#8).\n\n**Sources**: [src/kimi_cli/__init__.py:228-231](), [src/kimi_cli/__init__.py:277-294](), [src/kimi_cli/config.py]()\n\n---\n\n## Your First Agent Session\n\nOnce configured, start an interactive session:\n\n**Diagram: Interactive Session Flow**\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant kimi_main[\"kimi() main\"]\n    participant ShellApp\n    participant CustomPromptSession\n    participant KimiSoul\n    participant LLM\n    \n    User-\u003e\u003ekimi_main: kimi\n    kimi_main-\u003e\u003ekimi_main: load_config()\n    kimi_main-\u003e\u003ekimi_main: new_session(work_dir)\n    kimi_main-\u003e\u003ekimi_main: load_agent(DEFAULT_AGENT_FILE)\n    kimi_main-\u003e\u003eShellApp: ShellApp(soul, welcome_info)\n    \n    ShellApp-\u003e\u003eCustomPromptSession: Initialize prompt_toolkit\n    ShellApp-\u003e\u003eUser: Display welcome banner\n    \n    User-\u003e\u003eCustomPromptSession: Enter query\n    alt Meta Command\n        CustomPromptSession-\u003e\u003eShellApp: /help, /setup, etc.\n        ShellApp-\u003e\u003eUser: Execute meta command\n    else Regular Query\n        CustomPromptSession-\u003e\u003eShellApp: User input\n        ShellApp-\u003e\u003eKimiSoul: run(user_input, wire)\n        \n        loop Agent Loop\n            KimiSoul-\u003e\u003eLLM: step(messages, tools)\n            LLM--\u003e\u003eKimiSoul: Response + tool_calls\n            KimiSoul-\u003e\u003eKimiSoul: Execute tools\n            KimiSoul-\u003e\u003eShellApp: Wire events\n        end\n        \n        ShellApp-\u003e\u003eUser: Display results\n    end\n    \n    User-\u003e\u003eCustomPromptSession: Ctrl-D or 'exit'\n    CustomPromptSession-\u003e\u003eShellApp: Shutdown\n```\n\n### Example Session\n\n```bash\n$ kimi\n Created new session: 20250124_143022\n Loaded agent: Kimi Koder\n Working directory: /home/user/my-project\n\n\u003e List all Python files in this directory\n\n[Agent analyzes request and uses Glob tool]\nTool: Glob\nPattern: **/*.py\nResults: \n  - main.py\n  - tests/test_core.py\n  - utils/helpers.py\n\n\u003e Read the main.py file and explain its purpose\n\n[Agent uses ReadFile tool and provides analysis]\n...\n```\n\n### Session Continuity\n\nSessions are automatically saved to `~/.local/share/kimi-cli/sessions/{work_dir_hash}/{session_id}/history.json`. Continue a previous session:\n\n```bash\n$ cd /home/user/my-project\n$ kimi --continue\n Continuing previous session: 20250124_143022\n Restored history with 12 messages\n\n\u003e Continue from where we left off\n```\n\n**Sources**: [src/kimi_cli/__init__.py:352-367](), [src/kimi_cli/ui/shell/__init__.py](), [src/kimi_cli/metadata.py]()\n\n---\n\n## Command-Line Options Overview\n\nThe `kimi` command accepts various options to control behavior:\n\n| Option | Short | Description | Default |\n|--------|-------|-------------|---------|\n| `--version` | | Display version | |\n| `--agent-file PATH` | | Custom agent file | Builtin Kimi Koder |\n| `--model NAME` | `-m` | LLM model to use | From config |\n| `--work-dir PATH` | `-w` | Working directory | Current directory |\n| `--continue` | `-C` | Continue previous session | New session |\n| `--command TEXT` | `-c`, `-q` | One-shot query | Interactive mode |\n| `--ui MODE` | | UI mode (shell/print/acp) | shell |\n| `--yolo` | `-y` | Auto-approve all actions | Prompt for approval |\n| `--debug` | | Enable debug logging | Info level |\n\n### One-Shot Command Execution\n\nExecute a single query and exit:\n\n```bash\n$ kimi -c \"Create a README.md file for this project\"\n[Agent executes and exits]\n\n$ kimi -q \"What files were modified today?\" --work-dir /path/to/project\n[Agent analyzes and responds]\n```\n\n### Non-Interactive Print Mode\n\nFor scripting and pipelines:\n\n```bash\n$ echo \"Analyze this codebase\" | kimi --print\n[Plain text output]\n\n$ echo '{\"query\": \"List Python files\"}' | kimi --print --input-format stream-json --output-format stream-json\n{\"type\": \"step_begin\", ...}\n{\"type\": \"text\", \"content\": \"...\"}\n...\n```\n\nFor comprehensive CLI options and usage patterns, see [Basic Usage](#2.2).\n\n**Sources**: [src/kimi_cli/__init__.py:49-164](), [CHANGELOG.md:176-179]()\n\n---\n\n## Agent and Tool Ecosystem\n\nkimi-cli comes with a default agent called **Kimi Koder** that provides file system operations, web search, task management, and bash execution:\n\n**Default Toolset:**\n- **File Operations**: `ReadFile`, `WriteFile`, `StrReplaceFile`, `Glob`, `Grep`\n- **Web Tools**: `SearchWeb`, `FetchURL`\n- **Task Management**: `Task` (subagent spawning), `Think`, `SetTodoList`\n- **System**: `Bash`\n\nThe agent definition is loaded from `DEFAULT_AGENT_FILE` which points to [src/kimi_cli/agents/koder/agent.yaml](). Custom agents can be specified with `--agent-file`, and project-level agents can be defined in `AGENTS.md`.\n\nFor details on agent configuration and customization, see [Agent Configuration](#5). For tool documentation, see [Tool System](#6).\n\n**Sources**: [src/kimi_cli/agent.py:82](), [src/kimi_cli/agents/koder/agent.yaml](), [CHANGELOG.md:304-311]()\n\n---\n\n## Meta Commands\n\nInteractive sessions support meta commands for system control:\n\n| Command | Description |\n|---------|-------------|\n| `/help` | Display help information |\n| `/setup` | Configure LLM provider |\n| `/version` | Show version information |\n| `/reload` | Reload configuration |\n| `/clear`, `/reset` | Clear conversation history |\n| `/compact` | Manually compact context |\n| `/init` | Generate AGENTS.md for project |\n| `/release-notes` | View recent release notes |\n| `/feedback` | Provide feedback |\n| `/debug` | Debug context state |\n| `/update` | Check for updates |\n\nMeta commands are handled by the `ShellApp` before being passed to the agent. See [Meta Commands](#4.2) for complete documentation.\n\n**Sources**: [CHANGELOG.md:32-60](), [src/kimi_cli/ui/shell/metacmd.py]()\n\n---\n\n## Approval System\n\nBy default, kimi-cli requires user approval for potentially destructive operations:\n- File writes (`WriteFile`, `StrReplaceFile`)\n- Bash command execution\n- File patching (`PatchFile`)\n\nWhen a tool requires approval, you'll see an interactive menu:\n\n```\nTool: Bash\nCommand: rm -rf temp/\nApprove this action?\n  [y] Yes (this time)\n  [a] Yes (for this session)\n  [n] No\n  [e] Edit command\n\u003e\n```\n\nTo automatically approve all actions (useful for CI/CD):\n\n```bash\n$ kimi --yolo -c \"Run all tests\"\n```\n\nFor details on approval mechanisms and session-based auto-approval, see [Approval System](#7.2).\n\n**Sources**: [CHANGELOG.md:32-37](), [src/kimi_cli/soul/approval.py](), [src/kimi_cli/__init__.py:156-163]()\n\n---\n\n## Troubleshooting First Run\n\n### No Configuration Found\n\n**Symptom**: Error message about missing LLM configuration\n\n**Solution**: Run `/setup` in interactive mode or set environment variables\n\n```bash\nexport KIMI_BASE_URL=\"https://api.moonshot.cn/v1\"\nexport KIMI_API_KEY=\"your-key\"\nkimi\n```\n\n### ripgrep Not Found\n\n**Symptom**: Warning about missing `ripgrep` binary\n\n**Solution**: kimi-cli automatically downloads `ripgrep` on first use, or install manually:\n\n```bash\n# Ubuntu/Debian\nsudo apt install ripgrep\n\n# macOS\nbrew install ripgrep\n```\n\n### Session History Errors\n\n**Symptom**: Cannot restore previous session\n\n**Solution**: Clear session cache and start fresh:\n\n```bash\nrm -rf ~/.local/share/kimi-cli/sessions/\nkimi  # Start new session\n```\n\n### Python Version Mismatch\n\n**Symptom**: Installation fails or import errors\n\n**Solution**: Ensure Python 3.13+ is installed:\n\n```bash\npython --version  # Should be 3.13 or higher\n```\n\n**Sources**: [pyproject.toml:6](), [CHANGELOG.md:47-49]()\n\n---\n\n## Next Steps\n\nNow that you have kimi-cli installed and configured:\n\n1. **Learn detailed usage patterns** - See [Basic Usage](#2.2) for command-line options, UI modes, and interaction patterns\n2. **Explore agent customization** - See [Agent Configuration](#5) to create custom agents\n3. **Understand the architecture** - See [Architecture Overview](#3) to learn how components interact\n4. **Master the tool system** - See [Tool System](#6) for comprehensive tool documentation\n5. **Try advanced features** - See [Advanced Features](#7) for context management, time travel, and auto-updates\n\nFor installation details, configuration file structure, and environment setup, continue to [Installation and Configuration](#2.1).\n\n**Sources**: [README.md](), [CHANGELOG.md:1-336]()"])</script><script>self.__next_f.push([1,"16:T3cbc,"])</script><script>self.__next_f.push([1,"# Installation and Configuration\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.github/workflows/ci.yml](.github/workflows/ci.yml)\n- [.github/workflows/release.yml](.github/workflows/release.yml)\n- [CHANGELOG.md](CHANGELOG.md)\n- [Makefile](Makefile)\n- [pyproject.toml](pyproject.toml)\n- [pyrightconfig.json](pyrightconfig.json)\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/deps/Makefile](src/kimi_cli/deps/Makefile)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis page provides detailed instructions for installing kimi-cli and configuring its components, including LLM providers, external services, and system behavior. For information about basic CLI usage after installation, see [Basic Usage](#2.2). For comprehensive configuration reference details, see [Configuration Reference](#8).\n\n## System Requirements\n\nkimi-cli requires **Python 3.13 or higher**. This minimum version requirement is strictly enforced by the package metadata.\n\nThe following core dependencies are automatically installed:\n\n| Category | Dependencies |\n|----------|-------------|\n| **LLM Integration** | `kosong\u003e=0.15.0` (LLM abstraction layer), `agent-client-protocol\u003e=0.4.9` |\n| **CLI \u0026 UI** | `click\u003e=8.3.0`, `prompt-toolkit\u003e=3.0.52`, `rich\u003e=14.2.0` |\n| **File Operations** | `aiofiles\u003e=25.1.0`, `patch-ng\u003e=1.19.0`, `ripgrepy\u003e=2.2.0` |\n| **Web \u0026 Network** | `aiohttp\u003e=3.13.1`, `trafilatura\u003e=2.0.0` |\n| **Data Handling** | `pyyaml\u003e=6.0.3`, `pydantic\u003e=2.12.3`, `streamingjson\u003e=0.0.5` |\n| **Utilities** | `loguru\u003e=0.7.3`, `tenacity\u003e=9.1.2`, `fastmcp\u003e=2.12.5` |\n\nSources: [pyproject.toml:1-24]()\n\n## Installation\n\n### Using pip\n\n```bash\npip install kimi-cli\n```\n\n### Using uv (Recommended for Development)\n\n```bash\nuv pip install kimi-cli\n```\n\n### Verifying Installation\n\nAfter installation, verify that the `kimi` command is available:\n\n```bash\nkimi --version\n```\n\nThe package registers the `kimi` command as the main entry point via the `[project.scripts]` configuration.\n\nSources: [pyproject.toml:44-45]()\n\n## Configuration File Structure\n\n### Configuration File Location\n\n```mermaid\ngraph LR\n    ShareDir[\"Share Directory\u003cbr/\u003e(platform-specific)\"]\n    ConfigFile[\"config.json\"]\n    LoadFunc[\"load_config()\"]\n    GetFunc[\"get_config_file()\"]\n    \n    GetFunc --\u003e ShareDir\n    ShareDir --\u003e ConfigFile\n    LoadFunc --\u003e GetFunc\n    \n    style ConfigFile fill:#f9f9f9\n    style LoadFunc fill:#f0f0f0\n```\n\n**Configuration File Hierarchy**\n\nThe configuration file is located at `\u003cshare_dir\u003e/config.json`, where the share directory is platform-specific and retrieved via `get_share_dir()`. The `load_config()` function automatically creates a default configuration file if none exists.\n\nSources: [src/kimi_cli/config.py:87-89](), [src/kimi_cli/config.py:102-124]()\n\n### Configuration Schema\n\n```mermaid\ngraph TB\n    Config[\"Config\u003cbr/\u003e(Root)\"]\n    DefaultModel[\"default_model: str\"]\n    Models[\"models: dict[str, LLMModel]\"]\n    Providers[\"providers: dict[str, LLMProvider]\"]\n    LoopControl[\"loop_control: LoopControl\"]\n    Services[\"services: Services\"]\n    \n    LLMModel[\"LLMModel\"]\n    ModelProvider[\"provider: str\"]\n    ModelName[\"model: str\"]\n    MaxContext[\"max_context_size: int\"]\n    \n    LLMProvider[\"LLMProvider\"]\n    ProviderType[\"type: Literal\"]\n    BaseURL[\"base_url: str\"]\n    APIKey[\"api_key: SecretStr\"]\n    \n    LoopControlClass[\"LoopControl\"]\n    MaxSteps[\"max_steps_per_run: int = 100\"]\n    MaxRetries[\"max_retries_per_step: int = 3\"]\n    \n    ServicesClass[\"Services\"]\n    MoonshotSearch[\"moonshot_search: MoonshotSearchConfig | None\"]\n    \n    Config --\u003e DefaultModel\n    Config --\u003e Models\n    Config --\u003e Providers\n    Config --\u003e LoopControl\n    Config --\u003e Services\n    \n    Models --\u003e LLMModel\n    LLMModel --\u003e ModelProvider\n    LLMModel --\u003e ModelName\n    LLMModel --\u003e MaxContext\n    \n    Providers --\u003e LLMProvider\n    LLMProvider --\u003e ProviderType\n    LLMProvider --\u003e BaseURL\n    LLMProvider --\u003e APIKey\n    \n    LoopControl --\u003e LoopControlClass\n    LoopControlClass --\u003e MaxSteps\n    LoopControlClass --\u003e MaxRetries\n    \n    Services --\u003e ServicesClass\n    ServicesClass --\u003e MoonshotSearch\n    \n    style Config fill:#f9f9f9\n    style LLMModel fill:#f0f0f0\n    style LLMProvider fill:#f0f0f0\n    style LoopControlClass fill:#f0f0f0\n    style ServicesClass fill:#f0f0f0\n```\n\n**Configuration Object Structure**\n\nThe configuration system uses Pydantic models for validation and type safety. The root `Config` class contains all configuration sections.\n\nSources: [src/kimi_cli/config.py:11-76]()\n\n### Default Configuration\n\nWhen no configuration file exists, `load_config()` creates a minimal default configuration:\n\n```json\n{\n  \"default_model\": \"\",\n  \"models\": {},\n  \"providers\": {},\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  },\n  \"services\": {}\n}\n```\n\nSources: [src/kimi_cli/config.py:92-99](), [tests/test_config.py:22-37]()\n\n## LLM Provider Configuration\n\n### Supported Provider Types\n\nkimi-cli supports the following LLM provider types via the `type` field in `LLMProvider`:\n\n| Provider Type | Description | Implementation |\n|--------------|-------------|----------------|\n| `kimi` | Moonshot AI's Kimi API | `kosong.chat_provider.Kimi` |\n| `openai_legacy` | OpenAI-compatible API | `kosong.chat_provider.OpenAILegacy` |\n| `_chaos` | Testing provider with random failures | `kosong.chat_provider.ChaosChatProvider` |\n\nSources: [src/kimi_cli/config.py:14](), [src/kimi_cli/utils/provider.py:32-72]()\n\n### Provider Configuration Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant LoadConfig[\"load_config()\"]\n    participant AugmentProvider[\"augment_provider_with_env_vars()\"]\n    participant CreateLLM[\"create_llm()\"]\n    participant ChatProvider[\"ChatProvider\u003cbr/\u003e(Kimi/OpenAI)\"]\n    participant LLM[\"LLM\"]\n    \n    User-\u003e\u003eLoadConfig: \"Load configuration\"\n    LoadConfig--\u003e\u003eUser: \"Config object\"\n    User-\u003e\u003eAugmentProvider: \"Config, LLMProvider, LLMModel\"\n    \n    Note over AugmentProvider: \"Check env vars:\u003cbr/\u003eKIMI_BASE_URL\u003cbr/\u003eKIMI_API_KEY\u003cbr/\u003eKIMI_MODEL_NAME\u003cbr/\u003eOPENAI_BASE_URL\u003cbr/\u003eOPENAI_API_KEY\"\n    \n    AugmentProvider--\u003e\u003eUser: \"Updated provider/model\"\n    User-\u003e\u003eCreateLLM: \"provider, model, options\"\n    \n    alt provider.type == \"kimi\"\n        CreateLLM-\u003e\u003eChatProvider: \"Kimi(model, base_url, api_key)\"\n    else provider.type == \"openai_legacy\"\n        CreateLLM-\u003e\u003eChatProvider: \"OpenAILegacy(model, base_url, api_key)\"\n    end\n    \n    CreateLLM-\u003e\u003eLLM: \"LLM(chat_provider, max_context_size)\"\n    LLM--\u003e\u003eUser: \"LLM instance\"\n```\n\n**Provider Configuration and Environment Variable Override Flow**\n\nThe system first loads configuration from `config.json`, then applies environment variable overrides via `augment_provider_with_env_vars()`, and finally creates the LLM instance with the merged configuration.\n\nSources: [src/kimi_cli/utils/provider.py:12-30](), [src/kimi_cli/utils/provider.py:32-72]()\n\n### Configuring Kimi Provider\n\n**Basic Configuration:**\n\n```json\n{\n  \"default_model\": \"kimi-default\",\n  \"models\": {\n    \"kimi-default\": {\n      \"provider\": \"kimi-provider\",\n      \"model\": \"moonshot-v1-8k\",\n      \"max_context_size\": 8192\n    }\n  },\n  \"providers\": {\n    \"kimi-provider\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"your-kimi-api-key-here\"\n    }\n  }\n}\n```\n\n**Environment Variable Overrides:**\n\nThe following environment variables override Kimi configuration:\n\n| Environment Variable | Overrides | Example |\n|---------------------|-----------|---------|\n| `KIMI_BASE_URL` | `provider.base_url` | `https://api.moonshot.cn/v1` |\n| `KIMI_API_KEY` | `provider.api_key` | `sk-...` |\n| `KIMI_MODEL_NAME` | `model.model` | `moonshot-v1-32k` |\n| `KIMI_MODEL_MAX_CONTEXT_SIZE` | `model.max_context_size` | `32768` |\n\n**Special Features:**\n\nWhen using the Kimi provider, if a `session_id` is provided, the provider is configured with `prompt_cache_key` to enable prompt caching across sessions:\n\n```python\nchat_provider.with_generation_kwargs(prompt_cache_key=session_id)\n```\n\nSources: [src/kimi_cli/utils/provider.py:12-30](), [src/kimi_cli/utils/provider.py:39-51]()\n\n### Configuring OpenAI-Compatible Provider\n\n**Basic Configuration:**\n\n```json\n{\n  \"default_model\": \"openai-gpt4\",\n  \"models\": {\n    \"openai-gpt4\": {\n      \"provider\": \"openai-provider\",\n      \"model\": \"gpt-4\",\n      \"max_context_size\": 8192\n    }\n  },\n  \"providers\": {\n    \"openai-provider\": {\n      \"type\": \"openai_legacy\",\n      \"base_url\": \"https://api.openai.com/v1\",\n      \"api_key\": \"your-openai-api-key-here\"\n    }\n  }\n}\n```\n\n**Environment Variable Overrides:**\n\n| Environment Variable | Overrides | Example |\n|---------------------|-----------|---------|\n| `OPENAI_BASE_URL` | `provider.base_url` | `https://api.openai.com/v1` |\n| `OPENAI_API_KEY` | `provider.api_key` | `sk-...` |\n\nSources: [src/kimi_cli/utils/provider.py:23-27](), [src/kimi_cli/utils/provider.py:52-58]()\n\n### Model Configuration Parameters\n\nThe `LLMModel` class defines model-specific settings:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `str` | Name of the provider in the `providers` dictionary |\n| `model` | `str` | Model identifier as recognized by the provider API |\n| `max_context_size` | `int` | Maximum context size in tokens for the model |\n\nThe `max_context_size` field was introduced to support context management and automatic compaction when approaching token limits.\n\nSources: [src/kimi_cli/config.py:26-35](), [CHANGELOG.md:213]()\n\n## Services Configuration\n\n### Moonshot Search Service\n\nThe Moonshot Search service is used by the `SearchWeb` tool to perform web searches. Configuration is optional; if not configured, the `SearchWeb` tool will return an error message suggesting alternative methods.\n\n**Configuration Structure:**\n\n```json\n{\n  \"services\": {\n    \"moonshot_search\": {\n      \"base_url\": \"https://search.moonshot.cn/api/v1/search\",\n      \"api_key\": \"your-search-api-key-here\"\n    }\n  }\n}\n```\n\n**Configuration Schema:**\n\n```mermaid\ngraph LR\n    Services[\"Services\"]\n    MoonshotSearch[\"moonshot_search:\u003cbr/\u003eMoonshotSearchConfig | None\"]\n    BaseURL[\"base_url: str\"]\n    APIKey[\"api_key: SecretStr\"]\n    \n    Services --\u003e MoonshotSearch\n    MoonshotSearch --\u003e BaseURL\n    MoonshotSearch --\u003e APIKey\n    \n    SearchWeb[\"SearchWeb Tool\"]\n    CheckConfig{\"Config\u003cbr/\u003epresent?\"}\n    \n    SearchWeb --\u003e CheckConfig\n    CheckConfig --\u003e|\"Yes\"| UseAPI[\"Use API\"]\n    CheckConfig --\u003e|\"No\"| ReturnError[\"Return error:\u003cbr/\u003e'Search service not configured'\"]\n    \n    style MoonshotSearch fill:#f0f0f0\n    style SearchWeb fill:#f9f9f9\n```\n\n**Service Configuration and Usage Flow**\n\nThe `SearchWeb` tool checks for Moonshot Search configuration during initialization. If the service is not configured, search requests fail gracefully with an error message.\n\nSources: [src/kimi_cli/config.py:46-64](), [src/kimi_cli/tools/web/search.py:42-59]()\n\n## Loop Control Configuration\n\nThe `LoopControl` section controls agent execution behavior, specifically limiting the number of iterations and retry attempts:\n\n### Configuration Fields\n\n| Field | Type | Default | Description |\n|-------|------|---------|-------------|\n| `max_steps_per_run` | `int` | `100` | Maximum number of agent loop iterations in one run |\n| `max_retries_per_step` | `int` | `3` | Maximum number of retry attempts per step when LLM API calls fail |\n\n### Configuration Example\n\n```json\n{\n  \"loop_control\": {\n    \"max_steps_per_run\": 50,\n    \"max_retries_per_step\": 5\n  }\n}\n```\n\n### Historical Context\n\n- **v0.11.0**: Loop control configuration was introduced with `max_retry_per_step` (typo)\n- **v0.11.1**: Field renamed to `max_retries_per_step` (correct spelling)\n- **v0.17**: Default `max_steps_per_run` increased from 50 to 100\n\nSources: [src/kimi_cli/config.py:37-44](), [CHANGELOG.md:230](), [CHANGELOG.md:282-291]()\n\n## Configuration Validation\n\n### Validation Rules\n\nThe `Config` class uses Pydantic's `model_validator` to enforce consistency:\n\n1. **Default Model Validation**: If `default_model` is specified, it must exist in the `models` dictionary\n2. **Provider Reference Validation**: Each model's `provider` field must reference a key in the `providers` dictionary\n\n### Validation Example\n\n```mermaid\ngraph TD\n    ConfigInput[\"Config Input\"]\n    Validate[\"model_validator(mode='after')\"]\n    CheckDefaultModel{\"default_model\u003cbr/\u003ein models?\"}\n    CheckProviders{\"All model.provider\u003cbr/\u003ein providers?\"}\n    Success[\"Valid Config\"]\n    Error1[\"ValueError:\u003cbr/\u003e'Default model not found'\"]\n    Error2[\"ValueError:\u003cbr/\u003e'Provider not found'\"]\n    \n    ConfigInput --\u003e Validate\n    Validate --\u003e CheckDefaultModel\n    CheckDefaultModel --\u003e|\"No (if set)\"| Error1\n    CheckDefaultModel --\u003e|\"Yes\"| CheckProviders\n    CheckProviders --\u003e|\"No\"| Error2\n    CheckProviders --\u003e|\"Yes\"| Success\n    \n    style Success fill:#f0f0f0\n    style Error1 fill:#ffe0e0\n    style Error2 fill:#ffe0e0\n```\n\n**Configuration Validation Flow**\n\nValidation occurs after Pydantic parses the JSON structure, ensuring referential integrity between models and providers.\n\nSources: [src/kimi_cli/config.py:77-84]()\n\n## Configuration Management\n\n### Loading Configuration\n\nThe `load_config()` function follows this process:\n\n1. Determine configuration file path via `get_config_file()`\n2. Check if file exists\n3. If missing, create default configuration and save to file\n4. If present, load and validate JSON\n5. Return `Config` object or raise `ConfigError` on validation failure\n\n### Saving Configuration\n\nThe `save_config(config: Config)` function serializes the configuration to JSON with:\n- 2-space indentation for readability\n- Exclusion of `None` values via `exclude_none=True`\n- Automatic secret serialization (API keys are written as plain text)\n\n### Error Handling\n\nConfiguration errors are wrapped in the `ConfigError` exception class, which provides clear error messages for:\n- Invalid JSON syntax (`json.JSONDecodeError`)\n- Schema validation failures (`ValidationError`)\n- Missing files or permissions issues\n\nSources: [src/kimi_cli/config.py:102-139]()\n\n## Complete Configuration Example\n\n**Full Production Configuration:**\n\n```json\n{\n  \"default_model\": \"kimi-main\",\n  \"models\": {\n    \"kimi-main\": {\n      \"provider\": \"kimi\",\n      \"model\": \"moonshot-v1-32k\",\n      \"max_context_size\": 32768\n    },\n    \"kimi-quick\": {\n      \"provider\": \"kimi\",\n      \"model\": \"moonshot-v1-8k\",\n      \"max_context_size\": 8192\n    },\n    \"openai-gpt4\": {\n      \"provider\": \"openai\",\n      \"model\": \"gpt-4-turbo-preview\",\n      \"max_context_size\": 128000\n    }\n  },\n  \"providers\": {\n    \"kimi\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"sk-your-kimi-api-key\"\n    },\n    \"openai\": {\n      \"type\": \"openai_legacy\",\n      \"base_url\": \"https://api.openai.com/v1\",\n      \"api_key\": \"sk-your-openai-api-key\"\n    }\n  },\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  },\n  \"services\": {\n    \"moonshot_search\": {\n      \"base_url\": \"https://search.moonshot.cn/api/v1/search\",\n      \"api_key\": \"your-search-api-key\"\n    }\n  }\n}\n```\n\nThis configuration defines multiple models backed by two providers, enables the Moonshot Search service, and uses default loop control settings.\n\nSources: [src/kimi_cli/config.py:66-76](), [tests/test_config.py:22-37]()"])</script><script>self.__next_f.push([1,"17:T3602,"])</script><script>self.__next_f.push([1,"# Basic Usage\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/ui/print/__init__.py](src/kimi_cli/ui/print/__init__.py)\n- [src/kimi_cli/ui/shell/__init__.py](src/kimi_cli/ui/shell/__init__.py)\n- [src/kimi_cli/ui/shell/metacmd.py](src/kimi_cli/ui/shell/metacmd.py)\n\n\u003c/details\u003e\n\n\n\nThis page covers the fundamental usage patterns for kimi-cli, including how to start the CLI, select UI modes, and perform basic interactions with the agent. For detailed configuration options, see [Installation and Configuration](#2.1). For comprehensive documentation of meta commands and interactive features, see [Meta Commands](#4.2) and [Interactive Shell Mode](#4.1).\n\n## Purpose and Scope\n\nThis document explains how to run kimi-cli from the command line, introduces the three available UI modes (shell, print, and acp), and demonstrates basic interaction patterns. It covers the most common command-line options and typical workflows for getting started with the agent system.\n\n## Starting kimi-cli\n\nThe basic command to start kimi-cli is simply:\n\n```bash\nkimi\n```\n\nThis launches the interactive shell mode with default settings. The CLI will create a new session in the current working directory and begin an interactive conversation with the Kimi Koder agent.\n\n**Sources:** [src/kimi_cli/__init__.py:49-179]()\n\n### Command Invocation Flow\n\n```mermaid\ngraph TB\n    CLI[\"kimi command\"]\n    ClickParse[\"click.command()\u003cbr/\u003e(kimi function)\"]\n    LoadConfig[\"load_config()\"]\n    CreateSession[\"new_session() or\u003cbr/\u003econtinue_session()\"]\n    KimiRun[\"kimi_run()\"]\n    UIDispatch[\"UI Mode Dispatch\"]\n    \n    CLI --\u003e ClickParse\n    ClickParse --\u003e LoadConfig\n    LoadConfig --\u003e CreateSession\n    CreateSession --\u003e KimiRun\n    KimiRun --\u003e UIDispatch\n    \n    UIDispatch --\u003e|\"--ui shell\"| ShellApp[\"ShellApp.run()\"]\n    UIDispatch --\u003e|\"--ui print\"| PrintApp[\"PrintApp.run()\"]\n    UIDispatch --\u003e|\"--ui acp\"| ACPServer[\"ACPServer.run()\"]\n    \n    ShellApp --\u003e CustomPromptSession[\"CustomPromptSession\"]\n    PrintApp --\u003e StdinRead[\"stdin/stdout\"]\n    ACPServer --\u003e ProtocolServer[\"ACP Protocol\"]\n```\n\n**Sources:** [src/kimi_cli/__init__.py:49-179](), [src/kimi_cli/__init__.py:256-379]()\n\n## UI Modes\n\nkimi-cli provides three distinct UI modes for different use cases:\n\n| Mode | Flag | Description | Use Case |\n|------|------|-------------|----------|\n| **shell** | `--ui shell` (default) | Interactive terminal interface | Human interaction, development, exploration |\n| **print** | `--ui print` or `--print` | Non-interactive stdin/stdout | Automation, scripting, CI/CD pipelines |\n| **acp** | `--ui acp` or `--acp` | Agent Client Protocol server | Programmatic integration, IDE extensions |\n\n**Sources:** [src/kimi_cli/__init__.py:103-120](), [src/kimi_cli/__init__.py:46]()\n\n### UI Mode Selection Logic\n\n```mermaid\ngraph LR\n    Start[\"Command Line Args\"]\n    CheckUI{\"--ui flag or\u003cbr/\u003eshortcuts?\"}\n    \n    Start --\u003e CheckUI\n    CheckUI --\u003e|\"--ui shell or default\"| Shell[\"ui = 'shell'\"]\n    CheckUI --\u003e|\"--print\"| Print[\"ui = 'print'\"]\n    CheckUI --\u003e|\"--acp\"| ACP[\"ui = 'acp'\"]\n    \n    Shell --\u003e CreateShellApp[\"ShellApp(soul, welcome_info)\"]\n    Print --\u003e CreatePrintApp[\"PrintApp(soul, input_format, output_format)\"]\n    ACP --\u003e CreateACPServer[\"ACPServer(soul)\"]\n    \n    CreateShellApp --\u003e RunShell[\"app.run(command)\"]\n    CreatePrintApp --\u003e RunPrint[\"app.run(command)\"]\n    CreateACPServer --\u003e RunACP[\"app.run()\"]\n```\n\n**Sources:** [src/kimi_cli/__init__.py:352-377]()\n\n## Shell Mode (Interactive)\n\nShell mode is the default and most feature-rich interface. It provides an interactive prompt with history, auto-completion, live visualization, and meta commands.\n\n### Basic Interaction\n\nWhen you start kimi-cli in shell mode, you'll see a welcome panel followed by an interactive prompt:\n\n```bash\n$ kimi\n\n                                  \n  Welcome to Kimi Koder!          \n         Send /help for help information.\n                                         \n Directory: /path/to/project             \n Session: abc123...                      \n Model: moonshot-v1-128k                 \n\n\nkimi\u003e \n```\n\nAt the prompt, you can:\n- Enter natural language requests to the agent\n- Use meta commands (prefixed with `/`)\n- Press `Ctrl+C` to interrupt the agent\n- Press `Ctrl+D` or type `exit` to quit\n\n**Sources:** [src/kimi_cli/ui/shell/__init__.py:36-82](), [src/kimi_cli/ui/shell/__init__.py:239-284]()\n\n### Interactive Loop\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant CustomPromptSession\n    participant ShellApp\n    participant MetaCmd as \"get_meta_command()\"\n    participant Soul as \"KimiSoul\"\n    \n    User-\u003e\u003eCustomPromptSession: \"Type input\"\n    CustomPromptSession-\u003e\u003eShellApp: \"user_input\"\n    \n    alt \"Input starts with /\"\n        ShellApp-\u003e\u003eMetaCmd: \"get_meta_command(name)\"\n        MetaCmd--\u003e\u003eShellApp: \"MetaCommand\"\n        ShellApp-\u003e\u003eMetaCmd: \"command.func()\"\n        MetaCmd--\u003e\u003eUser: \"Result\"\n    else \"Input is 'exit' or 'quit'\"\n        ShellApp--\u003e\u003eUser: \"Bye!\"\n    else \"Regular input\"\n        ShellApp-\u003e\u003eSoul: \"soul.run(user_input, wire)\"\n        Soul--\u003e\u003eUser: \"Agent response via visualization\"\n    end\n    \n    ShellApp-\u003e\u003eCustomPromptSession: \"Prompt again\"\n```\n\n**Sources:** [src/kimi_cli/ui/shell/__init__.py:46-82](), [src/kimi_cli/ui/shell/__init__.py:109-144]()\n\n### Meta Commands\n\nMeta commands are special commands prefixed with `/` that control the CLI behavior rather than being sent to the agent. Common examples include:\n\n- `/help` - Display help information\n- `/init` - Initialize a new conversation\n- `/clear` - Clear the current context\n- `/setup` - Configure LLM provider settings\n\nFor comprehensive documentation of all meta commands, see [Meta Commands](#4.2).\n\n**Sources:** [src/kimi_cli/ui/shell/__init__.py:74-77](), [src/kimi_cli/ui/shell/metacmd.py]()\n\n### Session Continuation\n\nBy default, each invocation creates a new session. To continue a previous session in the same working directory, use the `--continue` or `-C` flag:\n\n```bash\nkimi --continue\n```\n\nThis restores the conversation history and context from the previous session.\n\n**Sources:** [src/kimi_cli/__init__.py:85-91](), [src/kimi_cli/__init__.py:192-202]()\n\n## Print Mode (Automation)\n\nPrint mode is designed for non-interactive automation scenarios. It reads from stdin and writes to stdout, making it suitable for scripting and pipeline integration.\n\n### Basic Usage\n\n```bash\n# Direct command\nkimi --print -c \"analyze the codebase structure\"\n\n# From stdin\necho \"create a README.md file\" | kimi --print\n\n# Pipeline usage\ncat task.txt | kimi --print \u003e result.txt\n```\n\n**Sources:** [src/kimi_cli/ui/print/__init__.py:23-96]()\n\n### Input and Output Formats\n\nPrint mode supports two formats for structured communication:\n\n| Format | Description |\n|--------|-------------|\n| `text` | Plain text input/output (default) |\n| `stream-json` | JSON Lines format with message objects |\n\n```bash\n# Stream JSON format\nkimi --print --input-format stream-json --output-format stream-json \u003c input.jsonl \u003e output.jsonl\n```\n\nThe `stream-json` format uses the kosong `Message` format for structured communication.\n\n**Sources:** [src/kimi_cli/__init__.py:122-136](), [src/kimi_cli/ui/print/__init__.py:19-20](), [src/kimi_cli/ui/print/__init__.py:122-146]()\n\n### Print Mode Execution Flow\n\n```mermaid\ngraph TB\n    Start[\"PrintApp.run()\"]\n    CheckCommand{\"command\u003cbr/\u003eprovided?\"}\n    ReadStdin[\"Read from stdin\"]\n    CheckFormat{\"input_format?\"}\n    \n    Start --\u003e CheckCommand\n    CheckCommand --\u003e|Yes| Execute\n    CheckCommand --\u003e|No| CheckFormat\n    \n    CheckFormat --\u003e|\"text\"| ReadStdin\n    CheckFormat --\u003e|\"stream-json\"| ReadJSON[\"_read_next_command()\"]\n    \n    ReadStdin --\u003e Execute[\"run_soul(soul, command, visualize_fn)\"]\n    ReadJSON --\u003e Execute\n    \n    Execute --\u003e OutputFormat{\"output_format?\"}\n    OutputFormat --\u003e|\"text\"| PrintText[\"_visualize_text(wire)\"]\n    OutputFormat --\u003e|\"stream-json\"| PrintJSON[\"_visualize_stream_json(wire)\"]\n    \n    PrintText --\u003e Stdout[\"stdout\"]\n    PrintJSON --\u003e Stdout\n```\n\n**Sources:** [src/kimi_cli/ui/print/__init__.py:40-96]()\n\n## ACP Mode (Protocol)\n\nACP (Agent Client Protocol) mode starts a server that implements a standardized protocol for programmatic agent interaction. This is primarily used for IDE integrations and custom clients.\n\n```bash\nkimi --acp\n```\n\nFor details on the ACP protocol, see [Print and ACP Modes](#4.4).\n\n**Sources:** [src/kimi_cli/__init__.py:116-120](), [src/kimi_cli/ui/acp.py]()\n\n## Common Command-Line Options\n\n### Essential Options\n\n```mermaid\ngraph TB\n    Options[\"Command-Line Options\"]\n    \n    Options --\u003e WorkDir[\"--work-dir, -w\u003cbr/\u003eSet working directory\u003cbr/\u003eDefault: current directory\"]\n    Options --\u003e Model[\"--model, -m\u003cbr/\u003eSpecify LLM model\u003cbr/\u003eDefault: from config\"]\n    Options --\u003e Command[\"--command, -c\u003cbr/\u003e--query, -q\u003cbr/\u003eRun single command\"]\n    Options --\u003e Continue[\"--continue, -C\u003cbr/\u003eContinue previous session\"]\n    Options --\u003e Yolo[\"--yolo, --yes, -y\u003cbr/\u003eAuto-approve all actions\"]\n    Options --\u003e AgentFile[\"--agent-file\u003cbr/\u003eCustom agent specification\u003cbr/\u003eDefault: Kimi Koder\"]\n    \n    Options --\u003e Verbose[\"--verbose\u003cbr/\u003ePrint verbose information\"]\n    Options --\u003e Debug[\"--debug\u003cbr/\u003eEnable debug logging\"]\n```\n\n**Sources:** [src/kimi_cli/__init__.py:51-164]()\n\n### Option Reference Table\n\n| Option | Short | Type | Description |\n|--------|-------|------|-------------|\n| `--work-dir` | `-w` | Path | Working directory for the agent. Default: current directory |\n| `--model` | `-m` | String | LLM model to use. Default: from config file |\n| `--command` | `-c`, `-q` | String | User query to the agent. Default: prompt interactively |\n| `--continue` | `-C` | Flag | Continue the previous session for the working directory |\n| `--yolo` | `-y`, `--yes` | Flag | Automatically approve all actions |\n| `--agent-file` | - | Path | Custom agent specification file. Default: builtin Kimi Koder |\n| `--ui` | - | Choice | UI mode: shell, print, or acp. Default: shell |\n| `--verbose` | - | Flag | Print verbose information |\n| `--debug` | - | Flag | Log debug information |\n| `--mcp-config-file` | - | Path | MCP config file to load (can be used multiple times) |\n| `--mcp-config` | - | String | MCP config JSON to load (can be used multiple times) |\n\n**Sources:** [src/kimi_cli/__init__.py:51-164]()\n\n## Basic Workflows\n\n### Workflow 1: Interactive Development\n\n```bash\n# Start in project directory\ncd /path/to/project\n\n# Launch interactive shell\nkimi\n\n# Agent analyzes directory and responds to requests\nkimi\u003e analyze the project structure and create documentation\n\n# Continue later with same context\nkimi --continue\n```\n\n### Workflow 2: Single-Command Execution\n\n```bash\n# Run a single command and exit\nkimi -c \"add unit tests for the auth module\"\n\n# Run in different directory\nkimi -w /path/to/other/project -c \"refactor the database layer\"\n```\n\n### Workflow 3: Automation Pipeline\n\n```bash\n# Use print mode for scripting\necho \"generate API documentation\" | kimi --print \u003e api_docs.txt\n\n# Chain multiple operations\nkimi --print -c \"analyze code complexity\" | \\\n  tee complexity_report.txt | \\\n  kimi --print -c \"suggest refactoring based on the analysis\"\n```\n\n### Workflow 4: Auto-Approval Mode\n\n```bash\n# Automatically approve all tool executions (use with caution)\nkimi --yolo -c \"run all tests and fix any failures\"\n```\n\n**Sources:** [src/kimi_cli/__init__.py:165-379](), [src/kimi_cli/ui/shell/__init__.py:36-82]()\n\n### Session and Context Management\n\n```mermaid\ngraph TB\n    Start[\"kimi command\"]\n    CheckContinue{\"--continue\u003cbr/\u003eflag?\"}\n    \n    Start --\u003e CheckContinue\n    CheckContinue --\u003e|Yes| ContinueSession[\"continue_session(work_dir)\"]\n    CheckContinue --\u003e|No| NewSession[\"new_session(work_dir)\"]\n    \n    ContinueSession --\u003e CheckExists{\"Previous session\u003cbr/\u003eexists?\"}\n    CheckExists --\u003e|Yes| LoadContext[\"Context(session.history_file)\"]\n    CheckExists --\u003e|No| Error[\"Error: No previous session\"]\n    \n    NewSession --\u003e CreateContext[\"Context(new_history_file)\"]\n    \n    LoadContext --\u003e Restore[\"context.restore()\"]\n    CreateContext --\u003e Run[\"Run agent\"]\n    Restore --\u003e Run\n    \n    Run --\u003e SaveHistory[\"Auto-save to history_file\"]\n```\n\n**Sources:** [src/kimi_cli/__init__.py:192-202](), [src/kimi_cli/__init__.py:336-339]()\n\n## Key Code Entities\n\nThe following table maps high-level concepts to their implementation:\n\n| Concept | Code Entity | Location |\n|---------|-------------|----------|\n| CLI Entry Point | `kimi()` function | [src/kimi_cli/__init__.py:165-253]() |\n| Main Execution | `kimi_run()` async function | [src/kimi_cli/__init__.py:256-379]() |\n| Interactive Mode | `ShellApp` class | [src/kimi_cli/ui/shell/__init__.py:30-228]() |\n| Automation Mode | `PrintApp` class | [src/kimi_cli/ui/print/__init__.py:23-178]() |\n| Protocol Mode | `ACPServer` class | [src/kimi_cli/ui/acp.py]() |\n| Prompt Handler | `CustomPromptSession` class | [src/kimi_cli/ui/shell/prompt.py]() |\n| Meta Commands | `get_meta_command()` function | [src/kimi_cli/ui/shell/metacmd.py]() |\n| Session Management | `new_session()`, `continue_session()` | [src/kimi_cli/metadata.py]() |\n| Context Storage | `Context` class | [src/kimi_cli/soul/context.py]() |\n\n**Sources:** [src/kimi_cli/__init__.py:1-388](), [src/kimi_cli/ui/shell/__init__.py:1-285](), [src/kimi_cli/ui/print/__init__.py:1-178]()"])</script><script>self.__next_f.push([1,"18:T4ca9,"])</script><script>self.__next_f.push([1,"# Architecture Overview\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis document provides a comprehensive view of kimi-cli's system architecture, covering the major components, their responsibilities, and how they interact. It describes the layered organization, key abstractions, and data flow patterns that enable the system to function as an AI-powered CLI agent.\n\nFor detailed information about specific components:\n- CLI startup and configuration loading: see [CLI Entry Point and Initialization](#3.1)\n- Agent definitions and execution: see [Agent System](#3.2)\n- LLM provider configuration: see [LLM Integration](#3.3)\n- Event queues and approval mechanisms: see [Communication Layer](#3.4)\n\n## System Layers\n\nThe kimi-cli architecture is organized into five distinct layers:\n\n| Layer | Components | Responsibility |\n|-------|-----------|----------------|\n| **Entry Points** | `kimi()` CLI command, PyPI package | Parse arguments, load configuration, initialize system |\n| **User Interface** | `ShellApp`, `PrintApp`, `ACPServer` | Handle user interaction, display agent output |\n| **Core Agent System** | `Agent`, `KimiSoul`, `Context`, `DenwaRenji` | Execute agent logic, manage conversation state |\n| **Tool Ecosystem** | File tools, web tools, task tools, bash tool | Provide capabilities to the agent |\n| **LLM Integration** | `Config`, `LLM`, chat providers | Abstract LLM API access |\n\nEach layer communicates with adjacent layers through well-defined interfaces, with the `Wire` event queue providing asynchronous communication between the execution engine and UI layers.\n\n**Sources:** [src/kimi_cli/__init__.py:1-387](), [src/kimi_cli/agent.py:1-262](), [src/kimi_cli/soul/kimisoul.py:1-309]()\n\n## Component Architecture\n\n### Entry Point to Execution Flow\n\n```mermaid\ngraph TD\n    main[\"main()\u003cbr/\u003ekimi_cli/__init__.py:382\"] --\u003e kimi[\"kimi()\u003cbr/\u003eCLI command decorator\u003cbr/\u003ekimi_cli/__init__.py:49-254\"]\n    \n    kimi --\u003e load_config[\"load_config()\u003cbr/\u003ekimi_cli/config.py\"]\n    kimi --\u003e load_agents_md[\"load_agents_md()\u003cbr/\u003ekimi_cli/agent.py:251\"]\n    kimi --\u003e create_globals[\"AgentGlobals\u003cbr/\u003ekimi_cli/agent.py:59\"]\n    kimi --\u003e kimi_run[\"kimi_run()\u003cbr/\u003ekimi_cli/__init__.py:256-379\"]\n    \n    kimi_run --\u003e augment[\"augment_provider_with_env_vars()\u003cbr/\u003eOverride with env vars\"]\n    kimi_run --\u003e create_llm[\"create_llm()\u003cbr/\u003ekimi_cli/utils/provider.py\"]\n    kimi_run --\u003e load_agent[\"load_agent_with_mcp()\u003cbr/\u003ekimi_cli/agent.py:85\"]\n    kimi_run --\u003e new_context[\"Context(history_file)\u003cbr/\u003ekimi_cli/soul/context.py\"]\n    kimi_run --\u003e new_soul[\"KimiSoul()\u003cbr/\u003ekimi_cli/soul/kimisoul.py:40\"]\n    \n    kimi_run --\u003e ui_choice{UI Mode}\n    ui_choice --\u003e|shell| ShellApp[\"ShellApp.run()\u003cbr/\u003ekimi_cli/ui/shell/__init__.py\"]\n    ui_choice --\u003e|print| PrintApp[\"PrintApp.run()\u003cbr/\u003ekimi_cli/ui/print/__init__.py\"]\n    ui_choice --\u003e|acp| ACPServer[\"ACPServer.run()\u003cbr/\u003ekimi_cli/ui/acp/__init__.py\"]\n    \n    ShellApp --\u003e run_soul[\"run_soul()\u003cbr/\u003ekimi_cli/ui/__init__.py:18\"]\n    PrintApp --\u003e run_soul\n    ACPServer --\u003e run_soul\n    \n    run_soul --\u003e soul_run[\"soul.run(user_input, wire)\u003cbr/\u003ekimi_cli/soul/kimisoul.py:99\"]\n```\n\nThe initialization flow begins at `main()`, which invokes the Click-decorated `kimi()` command. This function loads configuration from `config.json`, augments it with environment variables, creates the `LLM` instance, and constructs the `AgentGlobals` container with all dependencies. The `load_agent_with_mcp()` function resolves agent inheritance and instantiates tools. Finally, `kimi_run()` creates the UI application (based on `--ui` flag), initializes a `Context` for conversation history, and instantiates `KimiSoul` as the execution engine.\n\n**Sources:** [src/kimi_cli/__init__.py:49-254](), [src/kimi_cli/__init__.py:256-379](), [src/kimi_cli/agent.py:85-94]()\n\n### Agent Loading and Dependency Injection\n\n```mermaid\ngraph TB\n    subgraph \"Agent Specification\"\n        agent_file[\"agent.yaml\u003cbr/\u003eAgentSpec model\"]\n        extend[\"extend: 'default'\u003cbr/\u003eInheritance chain\"]\n        system_prompt[\"system_prompt.txt\u003cbr/\u003eTemplate substitution\"]\n        tools_list[\"tools: list[str]\u003cbr/\u003eModule paths\"]\n        subagents[\"subagents: dict\u003cbr/\u003eRecursive definitions\"]\n    end\n    \n    subgraph \"Loading Process\"\n        load_agent[\"load_agent()\u003cbr/\u003ekimi_cli/agent.py:97\"]\n        load_spec[\"_load_agent_spec()\u003cbr/\u003eResolve inheritance\u003cbr/\u003ekimi_cli/agent.py:145\"]\n        load_prompt[\"_load_system_prompt()\u003cbr/\u003eSubstitute variables\u003cbr/\u003ekimi_cli/agent.py:182\"]\n        load_tools[\"_load_tools()\u003cbr/\u003eImport and inject deps\u003cbr/\u003ekimi_cli/agent.py:194\"]\n    end\n    \n    subgraph \"Dependency Container\"\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003ekimi_cli/agent.py:59\"]\n        Config[\"config: Config\"]\n        LLM[\"llm: LLM | None\"]\n        BuiltinArgs[\"builtin_args: BuiltinSystemPromptArgs\"]\n        DenwaRenji[\"denwa_renji: DenwaRenji\"]\n        Session[\"session: Session\"]\n        Approval[\"approval: Approval\"]\n        \n        AgentGlobals --\u003e Config\n        AgentGlobals --\u003e LLM\n        AgentGlobals --\u003e BuiltinArgs\n        AgentGlobals --\u003e DenwaRenji\n        AgentGlobals --\u003e Session\n        AgentGlobals --\u003e Approval\n    end\n    \n    subgraph \"Tool Instantiation\"\n        load_tool[\"_load_tool()\u003cbr/\u003ekimi_cli/agent.py:212\"]\n        inspect_sig[\"inspect.signature(cls)\u003cbr/\u003eMatch params to deps\"]\n        inject[\"Inject dependencies\u003cbr/\u003ecls(*args)\"]\n    end\n    \n    subgraph \"Result\"\n        Agent[\"Agent\u003cbr/\u003ekimi_cli/agent.py:70\"]\n        name[\"name: str\"]\n        system_prompt_result[\"system_prompt: str\"]\n        toolset[\"toolset: CustomToolset\"]\n        \n        Agent --\u003e name\n        Agent --\u003e system_prompt_result\n        Agent --\u003e toolset\n    end\n    \n    agent_file --\u003e load_spec\n    extend --\u003e load_spec\n    load_spec --\u003e load_agent\n    system_prompt --\u003e load_prompt\n    load_prompt --\u003e load_agent\n    tools_list --\u003e load_tools\n    load_tools --\u003e load_agent\n    \n    AgentGlobals -.inject.-\u003e load_tool\n    load_tools --\u003e load_tool\n    load_tool --\u003e inspect_sig\n    inspect_sig --\u003e inject\n    \n    load_agent --\u003e Agent\n```\n\nAgent loading follows a multi-stage process. The `_load_agent_spec()` function reads the YAML file and recursively resolves the `extend` chain (e.g., custom agent extending `\"default\"` which points to the Kimi Koder agent). The `_load_system_prompt()` function reads the prompt template and substitutes variables from both `BuiltinSystemPromptArgs` (like `KIMI_WORK_DIR`) and spec-defined args. Tools are loaded dynamically using `importlib`: `_load_tool()` imports each module path, uses `inspect.signature()` to determine constructor dependencies, and injects them from the `AgentGlobals` container. This dependency injection pattern enables tools to declare their requirements (e.g., `Config`, `Approval`, `DenwaRenji`) without coupling to the loading infrastructure.\n\n**Sources:** [src/kimi_cli/agent.py:97-143](), [src/kimi_cli/agent.py:145-179](), [src/kimi_cli/agent.py:194-231]()\n\n### KimiSoul Execution Engine\n\n```mermaid\ngraph TB\n    subgraph \"KimiSoul Class\"\n        init[\"__init__()\u003cbr/\u003ekimi_cli/soul/kimisoul.py:43\"]\n        run[\"run(user_input, wire)\u003cbr/\u003ekimi_cli/soul/kimisoul.py:99\"]\n        agent_loop[\"_agent_loop(wire)\u003cbr/\u003eMain loop\u003cbr/\u003ekimi_cli/soul/kimisoul.py:112\"]\n        step[\"_step(wire)\u003cbr/\u003eSingle LLM step\u003cbr/\u003ekimi_cli/soul/kimisoul.py:163\"]\n        grow_context[\"_grow_context()\u003cbr/\u003ekimi_cli/soul/kimisoul.py:234\"]\n        compact[\"compact_context()\u003cbr/\u003ekimi_cli/soul/kimisoul.py:245\"]\n    end\n    \n    subgraph \"Dependencies\"\n        agent[\"Agent\u003cbr/\u003esystem_prompt + toolset\"]\n        globals[\"AgentGlobals\u003cbr/\u003ellm, approval, etc\"]\n        context[\"Context\u003cbr/\u003ehistory + checkpoints\"]\n        loop_control[\"LoopControl\u003cbr/\u003emax_steps, max_retries\"]\n    end\n    \n    subgraph \"Execution Flow\"\n        checkpoint[\"checkpoint()\u003cbr/\u003eSave state\"]\n        append_user[\"append_message(user)\u003cbr/\u003eAdd user input\"]\n        \n        step_begin[\"StepBegin event\"]\n        compact_check{Context\u003cbr/\u003etoo long?}\n        compact_do[\"Compact context\u003cbr/\u003eCompactionBegin/End\"]\n        \n        kosong_step[\"kosong.step()\u003cbr/\u003eCall LLM with tools\"]\n        tool_results[\"tool_results()\u003cbr/\u003eExecute tool calls\"]\n        \n        append_result[\"append_message(result)\"]\n        \n        dmail_check{Pending\u003cbr/\u003eD-Mail?}\n        revert[\"revert_to(checkpoint_id)\"]\n        append_dmail[\"append_message(dmail)\"]\n        \n        finished_check{Tool calls\u003cbr/\u003eempty?}\n        \n        max_check{step_no \u003e\u003cbr/\u003emax_steps?}\n    end\n    \n    init --\u003e agent\n    init --\u003e globals\n    init --\u003e context\n    init --\u003e loop_control\n    \n    run --\u003e checkpoint\n    checkpoint --\u003e append_user\n    append_user --\u003e agent_loop\n    \n    agent_loop --\u003e step_begin\n    step_begin --\u003e compact_check\n    compact_check --\u003e|yes| compact_do\n    compact_check --\u003e|no| kosong_step\n    compact_do --\u003e kosong_step\n    \n    kosong_step --\u003e tool_results\n    tool_results --\u003e grow_context\n    grow_context --\u003e append_result\n    \n    append_result --\u003e dmail_check\n    dmail_check --\u003e|yes| revert\n    revert --\u003e append_dmail\n    append_dmail --\u003e agent_loop\n    \n    dmail_check --\u003e|no| finished_check\n    finished_check --\u003e|yes| done[\"Return\"]\n    finished_check --\u003e|no| max_check\n    max_check --\u003e|yes| raise_error[\"Raise MaxStepsReached\"]\n    max_check --\u003e|no| agent_loop\n```\n\nThe `KimiSoul` class implements the `Soul` protocol and serves as the agent execution engine. Initialization stores references to the `Agent` (prompt and tools), `AgentGlobals` (dependencies), `Context` (conversation history), and `LoopControl` (limits). The `run()` method creates a checkpoint, appends the user message, and delegates to `_agent_loop()`.\n\nThe main loop increments `step_no` and calls `_step()` repeatedly. Before each step, it checks if context exceeds `max_context_size - RESERVED_TOKENS` (50,000) and triggers compaction if needed. The `_step()` method invokes `kosong.step()` with retry logic (using `tenacity`), which calls the LLM and executes tool calls. Results are appended to context via `_grow_context()`. If a D-Mail is pending (from the `SendDMail` tool), the loop raises `BackToTheFuture`, causing a context revert and D-Mail injection. The loop terminates when tool calls are empty (agent finished) or `max_steps_per_run` is exceeded.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:40-76](), [src/kimi_cli/soul/kimisoul.py:99-161](), [src/kimi_cli/soul/kimisoul.py:163-232]()\n\n### Context Management\n\n```mermaid\ngraph LR\n    subgraph \"Context Class\"\n        Context[\"Context\u003cbr/\u003ekimi_cli/soul/context.py\"]\n        history_file[\"_history_file: Path\"]\n        history[\"_history: list[Message]\"]\n        token_count[\"_token_count: int\"]\n        checkpoints[\"_checkpoints: list[int]\"]\n    end\n    \n    subgraph \"Operations\"\n        restore[\"restore()\u003cbr/\u003eLoad from disk\"]\n        append[\"append_message()\u003cbr/\u003eAdd to history + save\"]\n        update_tokens[\"update_token_count()\u003cbr/\u003eTrack usage\"]\n        checkpoint_op[\"checkpoint()\u003cbr/\u003eSave index\"]\n        revert[\"revert_to(checkpoint_id)\u003cbr/\u003eTruncate history\"]\n    end\n    \n    subgraph \"Persistence\"\n        json_file[\"session.history.jsonl\u003cbr/\u003eOne Message per line\"]\n        save[\"_save_history()\u003cbr/\u003eWrite to disk\"]\n    end\n    \n    Context --\u003e history_file\n    Context --\u003e history\n    Context --\u003e token_count\n    Context --\u003e checkpoints\n    \n    restore --\u003e json_file\n    append --\u003e save\n    save --\u003e json_file\n    checkpoint_op --\u003e checkpoints\n    revert --\u003e history\n    revert --\u003e checkpoints\n```\n\nThe `Context` class manages conversation history and checkpoint-based state. It stores messages in `_history` as a list of `Message` objects (from kosong), tracks cumulative `_token_count`, and maintains `_checkpoints` as indices into the history list. The `restore()` method loads history from `session.history.jsonl` (one JSON object per line). `append_message()` adds messages and calls `_save_history()` to persist immediately. `checkpoint()` records the current history length, enabling `revert_to(checkpoint_id)` to truncate both history and checkpoints. This mechanism supports the D-Mail time-travel feature.\n\n**Sources:** [src/kimi_cli/soul/context.py:1-150]() (referenced but not provided in full)\n\n### Communication Infrastructure\n\n```mermaid\ngraph TB\n    subgraph \"Wire Event Queue\"\n        Wire[\"Wire\u003cbr/\u003ekimi_cli/soul/wire.py\"]\n        send[\"send(event)\u003cbr/\u003ePush to queue\"]\n        receive[\"receive()\u003cbr/\u003ePop from queue\"]\n        shutdown[\"shutdown()\u003cbr/\u003eSignal completion\"]\n        current_wire[\"current_wire: ContextVar\u003cbr/\u003eThread-local Wire\"]\n    end\n    \n    subgraph \"Events\"\n        StepBegin[\"StepBegin(step_no)\"]\n        MessagePart[\"MessagePart(text)\"]\n        ToolCall[\"ToolCall(name, args)\"]\n        ToolResult[\"ToolResult(success, output)\"]\n        CompactionBegin[\"CompactionBegin()\"]\n        CompactionEnd[\"CompactionEnd()\"]\n        StatusUpdate[\"StatusUpdate(status)\"]\n        ApprovalRequest[\"ApprovalRequest(action)\"]\n        StepInterrupted[\"StepInterrupted()\"]\n    end\n    \n    subgraph \"Approval System\"\n        Approval[\"Approval\u003cbr/\u003ekimi_cli/soul/approval.py\"]\n        request_approval[\"request_approval(action)\u003cbr/\u003eBlock until decision\"]\n        fetch_request[\"fetch_request()\u003cbr/\u003eGet next request\"]\n        respond[\"respond(decision)\u003cbr/\u003eUnblock tool\"]\n        yolo[\"yolo: bool\u003cbr/\u003eAuto-approve all\"]\n    end\n    \n    subgraph \"UI Consumption\"\n        run_soul[\"run_soul()\u003cbr/\u003ekimi_cli/ui/__init__.py:18\"]\n        ui_loop[\"ui_loop_fn(wire)\u003cbr/\u003eVisualize events\"]\n        soul_task[\"soul.run() task\"]\n        ui_task[\"ui_loop_fn() task\"]\n    end\n    \n    Wire --\u003e send\n    Wire --\u003e receive\n    Wire --\u003e shutdown\n    Wire --\u003e current_wire\n    \n    send --\u003e StepBegin\n    send --\u003e MessagePart\n    send --\u003e ToolCall\n    send --\u003e ToolResult\n    send --\u003e CompactionBegin\n    send --\u003e CompactionEnd\n    send --\u003e StatusUpdate\n    send --\u003e ApprovalRequest\n    send --\u003e StepInterrupted\n    \n    Approval --\u003e request_approval\n    Approval --\u003e fetch_request\n    Approval --\u003e respond\n    Approval --\u003e yolo\n    \n    request_approval -.send.-\u003e Wire\n    fetch_request -.receive.-\u003e Wire\n    \n    run_soul --\u003e soul_task\n    run_soul --\u003e ui_task\n    soul_task -.send.-\u003e Wire\n    Wire -.receive.-\u003e ui_task\n```\n\nThe `Wire` class implements a bidirectional event queue using `asyncio.Queue`. The `send()` method pushes events from the execution engine to the UI, while `receive()` allows the UI to pop events. The `current_wire` context variable stores the active `Wire` instance, enabling tools to send events without explicit parameter passing.\n\nThe `Approval` class coordinates user approval for dangerous operations. When a tool calls `request_approval(action)`, it creates an `ApprovalRequest`, sends it to the `Wire`, and blocks on an internal queue. The UI receives the request, prompts the user, and calls `respond(decision)` to unblock the tool. If `yolo=True`, `request_approval()` immediately returns `Approved`. The `run_soul()` function spawns two concurrent tasks: `soul.run()` generates events, and `ui_loop_fn()` consumes them. This decoupling enables real-time visualization and interactive approval without blocking the agent execution.\n\n**Sources:** [src/kimi_cli/soul/wire.py:1-150]() (referenced), [src/kimi_cli/soul/approval.py:1-100]() (referenced), [src/kimi_cli/ui/__init__.py:18-69]()\n\n## Key Architectural Patterns\n\n### Protocol-Based Abstractions\n\nThe system defines several protocol classes (using `@runtime_checkable` from `typing`):\n\n- **`Soul` protocol** [src/kimi_cli/soul/__init__.py:28-59](): Defines the interface for agent execution engines. `KimiSoul` implements this protocol, enabling future alternative implementations without breaking UI code.\n\n```python\n@runtime_checkable\nclass Soul(Protocol):\n    @property\n    def name(self) -\u003e str: ...\n    @property\n    def model(self) -\u003e str: ...\n    @property\n    def status(self) -\u003e StatusSnapshot: ...\n    async def run(self, user_input: str, wire: Wire): ...\n```\n\nThis pattern allows the UI layer to work with any `Soul` implementation through duck typing, promoting modularity.\n\n**Sources:** [src/kimi_cli/soul/__init__.py:28-59]()\n\n### Dependency Injection via AgentGlobals\n\nThe `AgentGlobals` container [src/kimi_cli/agent.py:59-67]() aggregates all dependencies required by agents and tools:\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `config` | `Config` | LLM models, services, loop control |\n| `llm` | `LLM \\| None` | Active LLM instance |\n| `builtin_args` | `BuiltinSystemPromptArgs` | Work dir, timestamp, etc. |\n| `denwa_renji` | `DenwaRenji` | D-Mail time-travel coordinator |\n| `session` | `Session` | Session ID and history file path |\n| `approval` | `Approval` | User approval coordinator |\n\nWhen loading tools, `_load_tool()` [src/kimi_cli/agent.py:212-231]() uses `inspect.signature()` to determine constructor parameters and injects matching dependencies from the container. This pattern eliminates the need for tools to know about the global initialization processthey simply declare their dependencies as constructor parameters.\n\n**Sources:** [src/kimi_cli/agent.py:59-67](), [src/kimi_cli/agent.py:212-231]()\n\n### Event-Driven UI Updates\n\nThe `Wire` event queue [src/kimi_cli/soul/wire.py]() decouples the agent execution engine from UI rendering. The execution engine (running in the `soul_task`) pushes events like `MessagePart`, `ToolResult`, and `ApprovalRequest` without knowledge of how they'll be displayed. The UI (running in the `ui_task`) consumes events and updates the display accordingly. This design enables:\n\n1. **Multiple UI modes**: The same execution engine works with `ShellApp` (interactive rich terminal), `PrintApp` (plain text/JSON), and `ACPServer` (Agent Client Protocol) by providing different `ui_loop_fn` implementations.\n\n2. **Non-blocking approval**: When `Approval.request_approval()` sends an `ApprovalRequest` to the wire, the UI receives it, prompts the user interactively, and calls `Approval.respond()` to unblock the toolall without the execution engine waiting synchronously.\n\n3. **Graceful cancellation**: The `run_soul()` function [src/kimi_cli/ui/__init__.py:18-69]() monitors a `cancel_event`. When set (e.g., by Ctrl-C), it cancels the `soul_task`, and the `Wire.shutdown()` method breaks the UI loop, ensuring clean teardown.\n\n**Sources:** [src/kimi_cli/ui/__init__.py:18-69](), [src/kimi_cli/soul/wire.py]() (referenced)\n\n### Configuration Layering\n\nConfiguration is resolved in multiple stages:\n\n1. **Base configuration**: Loaded from `~/.config/kimi/config.json` by `load_config()` [src/kimi_cli/config.py]()\n2. **Environment variable overrides**: `augment_provider_with_env_vars()` [src/kimi_cli/__init__.py:294]() checks `OPENAI_API_KEY`, `OPENAI_BASE_URL`, etc.\n3. **Command-line flags**: `--model`, `--yolo`, `--work-dir`, etc. override configuration\n4. **Agent inheritance**: `extend: \"default\"` in agent YAML files chains to builtin agents\n\nThis layering enables flexible configuration while maintaining sensible defaults at each level.\n\n**Sources:** [src/kimi_cli/__init__.py:227-294](), [src/kimi_cli/config.py]() (referenced), [src/kimi_cli/agent.py:145-179]()"])</script><script>self.__next_f.push([1,"19:T3f9e,"])</script><script>self.__next_f.push([1,"# CLI Entry Point and Initialization\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the application startup sequence for kimi-cli, from the command-line entry point through agent initialization and UI handoff. It covers command-line argument parsing, configuration loading, component assembly, and the dependency injection pattern used throughout the system.\n\nFor details on agent configuration and loading mechanisms, see [Agent Configuration](#5). For UI mode implementations, see [User Interfaces](#4). For LLM integration specifics, see [LLM Integration](#3.3).\n\n---\n\n## Entry Point Definition\n\nThe kimi-cli application is installed as a console script via the `[project.scripts]` section in [pyproject.toml:45-46]():\n\n```toml\n[project.scripts]\nkimi = \"kimi_cli:main\"\n```\n\nThe `main()` function serves as the entry point wrapper, invoking the Click command:\n\n[src/kimi_cli/__init__.py:382-387]()\n\n```python\ndef main():\n    kimi()\n```\n\nThe actual CLI command is defined using Click decorators starting at [src/kimi_cli/__init__.py:49-179]().\n\n**Sources:** [pyproject.toml:45-46](), [src/kimi_cli/__init__.py:382-387]()\n\n---\n\n## Command-Line Interface Structure\n\n### Click Command Definition\n\nThe main `kimi()` function is decorated with `@click.command()` and accepts 13 options:\n\n| Option | Type | Default | Description |\n|--------|------|---------|-------------|\n| `--verbose` | Flag | False | Print verbose information |\n| `--debug` | Flag | False | Enable debug logging |\n| `--agent-file` | Path | `DEFAULT_AGENT_FILE` | Custom agent specification file |\n| `--model` / `-m` | String | None | LLM model name |\n| `--work-dir` / `-w` | Path | `Path.cwd()` | Working directory for agent |\n| `--continue` / `-C` | Flag | False | Continue previous session |\n| `--command` / `-c` | String | None | User query to agent |\n| `--ui` | Choice | \"shell\" | UI mode (shell/print/acp) |\n| `--print` | Flag | - | Shortcut for `--ui print` |\n| `--acp` | Flag | - | Shortcut for `--ui acp` |\n| `--input-format` | Choice | None | Input format (text/stream-json) |\n| `--output-format` | Choice | None | Output format (text/stream-json) |\n| `--mcp-config-file` | Path[] | [] | MCP configuration files |\n| `--mcp-config` | String[] | [] | MCP configuration JSON strings |\n| `--yolo` / `-y` | Flag | False | Auto-approve all actions |\n\n**Sources:** [src/kimi_cli/__init__.py:49-179]()\n\n---\n\n## Initialization Flow\n\n### High-Level Startup Sequence\n\n```mermaid\nflowchart TD\n    Start[\"main()\"] --\u003e ClickParse[\"Click: Parse Arguments\"]\n    ClickParse --\u003e LogSetup[\"Setup Logging\u003cbr/\u003e(get_share_dir()/logs/kimi.log)\"]\n    LogSetup --\u003e SessionMgmt[\"Session Management\"]\n    \n    SessionMgmt --\u003e ContCheck{continue_ flag?}\n    ContCheck --\u003e|True| ContinueSession[\"continue_session(work_dir)\"]\n    ContCheck --\u003e|False| NewSession[\"new_session(work_dir)\"]\n    \n    ContinueSession --\u003e SessionCheck{session exists?}\n    SessionCheck --\u003e|No| Error1[\"Raise BadOptionUsage\"]\n    SessionCheck --\u003e|Yes| Validate\n    NewSession --\u003e Validate\n    \n    Validate[\"Validate Options\u003cbr/\u003e(input/output format, MCP)\"]\n    Validate --\u003e ParseMCP[\"Parse MCP Configs\u003cbr/\u003e(from files and strings)\"]\n    \n    ParseMCP --\u003e MainLoop[\"Main Loop\"]\n    MainLoop --\u003e LoadConfig[\"load_config()\"]\n    LoadConfig --\u003e RunKimi[\"kimi_run()\"]\n    \n    RunKimi --\u003e ReloadCheck{Reload exception?}\n    ReloadCheck --\u003e|Yes| MainLoop\n    ReloadCheck --\u003e|No| Exit[\"Exit\"]\n    \n    RunKimi --\u003e Success{succeeded?}\n    Success --\u003e|No| ExitError[\"sys.exit(1)\"]\n    Success --\u003e|Yes| Exit\n```\n\n**Sources:** [src/kimi_cli/__init__.py:165-254]()\n\n---\n\n### Logging Configuration\n\nLogging is configured immediately after argument parsing using `loguru`:\n\n[src/kimi_cli/__init__.py:183-188]()\n\nThe log file is written to `{share_dir}/logs/kimi.log` with:\n- **Rotation:** Daily at 06:00\n- **Retention:** 10 days\n- **Level:** DEBUG if `--debug` is set, otherwise INFO\n\n**Sources:** [src/kimi_cli/__init__.py:183-188]()\n\n---\n\n### Session Management\n\nSessions track conversation history per working directory. The system creates or continues sessions based on the `--continue` flag:\n\n[src/kimi_cli/__init__.py:192-202]()\n\n- **New Session:** `new_session(work_dir)` creates a unique session ID and history file\n- **Continue Session:** `continue_session(work_dir)` retrieves the most recent session for the directory\n- If `--continue` is specified but no previous session exists, a `BadOptionUsage` exception is raised\n\n**Sources:** [src/kimi_cli/__init__.py:192-202](), [src/kimi_cli/metadata.py]()\n\n---\n\n### Input/Output Format Validation\n\nThe CLI validates that format options are only used with compatible UI modes:\n\n[src/kimi_cli/__init__.py:204-213]()\n\n- `--input-format` and `--output-format` are only valid with `--print` mode\n- If specified with other UI modes, a `BadOptionUsage` exception is raised\n\n**Sources:** [src/kimi_cli/__init__.py:204-213]()\n\n---\n\n### MCP Configuration Loading\n\nMCP (Model Context Protocol) configurations are loaded from two sources:\n\n[src/kimi_cli/__init__.py:216-223]()\n\n1. **Files:** `--mcp-config-file` paths are read and parsed as JSON\n2. **Strings:** `--mcp-config` strings are parsed directly as JSON\n\nBoth are validated during parsing, raising `BadOptionUsage` if JSON is invalid.\n\n**Sources:** [src/kimi_cli/__init__.py:216-223]()\n\n---\n\n### Reload Loop\n\nThe main loop at [src/kimi_cli/__init__.py:225-253]() supports configuration reloading:\n\n```python\nwhile True:\n    try:\n        config = load_config()\n        succeeded = asyncio.run(kimi_run(...))\n        break\n    except Reload:\n        continue\n```\n\nThis pattern allows the `/reload` meta command to restart the initialization sequence without exiting the process.\n\n**Sources:** [src/kimi_cli/__init__.py:225-253](), [src/kimi_cli/ui/shell/__init__.py]()\n\n---\n\n## Component Assembly in kimi_run()\n\nThe `kimi_run()` async function assembles all system components:\n\n### Component Assembly Sequence\n\n```mermaid\nsequenceDiagram\n    participant Main as kimi_run()\n    participant Config as Configuration\n    participant LLM as LLM Creation\n    participant Agent as Agent Loading\n    participant Context as Context\n    participant Soul as KimiSoul\n    participant UI as UI Layer\n    \n    Main-\u003e\u003eConfig: Determine model \u0026 provider\n    Config-\u003e\u003eConfig: Try config file defaults\n    Config-\u003e\u003eConfig: Override with env vars\n    Config--\u003e\u003eMain: LLMModel, LLMProvider\n    \n    Main-\u003e\u003eLLM: create_llm(provider, model)\n    LLM--\u003e\u003eMain: LLM instance or None\n    \n    Main-\u003e\u003eMain: Load AGENTS.md\n    Main-\u003e\u003eMain: Run \"ls -la\" for work_dir\n    \n    Main-\u003e\u003eMain: Assemble AgentGlobals\n    Note over Main: Config, LLM, BuiltinArgs,\u003cbr/\u003eDenwaRenji, Session, Approval\n    \n    Main-\u003e\u003eAgent: load_agent_with_mcp(agent_file, globals, mcp_configs)\n    Agent-\u003e\u003eAgent: _load_agent_spec()\n    Agent-\u003e\u003eAgent: _load_system_prompt()\n    Agent-\u003e\u003eAgent: _load_tools()\n    Agent-\u003e\u003eAgent: _load_mcp_tools()\n    Agent--\u003e\u003eMain: Agent(name, system_prompt, toolset)\n    \n    Main-\u003e\u003eContext: Context(session.history_file)\n    Main-\u003e\u003eContext: restore()\n    Context--\u003e\u003eMain: Restored message history\n    \n    Main-\u003e\u003eSoul: KimiSoul(agent, globals, context, loop_control)\n    Soul--\u003e\u003eMain: Soul instance\n    \n    Main-\u003e\u003eMain: os.chdir(work_dir)\n    \n    Main-\u003e\u003eUI: Instantiate UI (ShellApp/PrintApp/ACPServer)\n    Main-\u003e\u003eUI: app.run(command)\n    UI--\u003e\u003eMain: success boolean\n```\n\n**Sources:** [src/kimi_cli/__init__.py:256-380]()\n\n---\n\n### Model and Provider Selection\n\nThe LLM model and provider are selected through a priority chain:\n\n[src/kimi_cli/__init__.py:274-294]()\n\n1. **Config File Default:** If no `--model` specified and `config.default_model` exists, use that\n2. **Config File Named:** If `--model` specified and exists in `config.models`, use that\n3. **Fallback:** Create placeholder with empty values\n4. **Environment Override:** `augment_provider_with_env_vars()` overrides with env vars\n\nIf `provider.base_url` or `model.model` are empty after this process, `llm` is set to `None`.\n\n**Sources:** [src/kimi_cli/__init__.py:274-302]()\n\n---\n\n### AgentGlobals Assembly\n\nThe `AgentGlobals` container aggregates all dependencies required by agents and tools:\n\n[src/kimi_cli/__init__.py:310-322]()\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `config` | `Config` | System configuration |\n| `llm` | `LLM \\| None` | LLM instance |\n| `builtin_args` | `BuiltinSystemPromptArgs` | Built-in template variables |\n| `denwa_renji` | `DenwaRenji` | Time-travel checkpoint manager |\n| `session` | `Session` | Session metadata |\n| `approval` | `Approval` | Tool approval system |\n\n**BuiltinSystemPromptArgs** includes:\n- `KIMI_NOW`: Current datetime in ISO format\n- `KIMI_WORK_DIR`: Absolute working directory path\n- `KIMI_WORK_DIR_LS`: Output of `ls -la` in working directory\n- `KIMI_AGENTS_MD`: Content of AGENTS.md file if present\n\n**Sources:** [src/kimi_cli/__init__.py:310-322](), [src/kimi_cli/agent.py:46-68]()\n\n---\n\n### Agent Loading Pipeline\n\n```mermaid\nflowchart LR\n    Start[\"load_agent_with_mcp()\"] --\u003e LoadSpec[\"load_agent()\u003cbr/\u003eLoad base agent\"]\n    LoadSpec --\u003e LoadAgentSpec[\"_load_agent_spec()\u003cbr/\u003eParse YAML\"]\n    \n    LoadAgentSpec --\u003e ExtendCheck{extend field?}\n    ExtendCheck --\u003e|Yes| LoadBase[\"Recursively load base\u003cbr/\u003e(default or custom)\"]\n    LoadBase --\u003e Merge[\"Merge specs\"]\n    Merge --\u003e Resolved\n    ExtendCheck --\u003e|No| Resolved[\"Resolved AgentSpec\"]\n    \n    Resolved --\u003e LoadPrompt[\"_load_system_prompt()\u003cbr/\u003eTemplate substitution\"]\n    Resolved --\u003e LoadTools[\"_load_tools()\u003cbr/\u003eDependency injection\"]\n    \n    LoadPrompt --\u003e Agent[\"Agent(name,\u003cbr/\u003esystem_prompt,\u003cbr/\u003etoolset)\"]\n    LoadTools --\u003e Agent\n    \n    Agent --\u003e MCPCheck{mcp_configs?}\n    MCPCheck --\u003e|Yes| LoadMCP[\"_load_mcp_tools()\u003cbr/\u003eConnect to MCP servers\"]\n    LoadMCP --\u003e Final[\"Final Agent\"]\n    MCPCheck --\u003e|No| Final\n```\n\n**Sources:** [src/kimi_cli/__init__.py:324-329](), [src/kimi_cli/agent.py:85-249]()\n\n---\n\n### Dependency Injection for Tools\n\nTools are instantiated with dependency injection based on their constructor signatures:\n\n[src/kimi_cli/agent.py:212-231]()\n\nThe `_load_tool()` function:\n1. Imports the tool module and class\n2. Inspects the constructor signature\n3. For each positional parameter, injects the corresponding dependency from the `dependencies` dict\n4. Stops at the first keyword-only parameter\n\nThe `dependencies` dict includes:\n\n[src/kimi_cli/agent.py:120-128]()\n\n```python\ntool_deps = {\n    AgentSpec: agent_spec,\n    AgentGlobals: globals_,\n    Config: globals_.config,\n    BuiltinSystemPromptArgs: globals_.builtin_args,\n    Session: globals_.session,\n    DenwaRenji: globals_.denwa_renji,\n    Approval: globals_.approval,\n}\n```\n\n**Sources:** [src/kimi_cli/agent.py:120-231]()\n\n---\n\n### Context Restoration\n\nThe conversation context is restored from the session's history file:\n\n[src/kimi_cli/__init__.py:336-339]()\n\n```python\ncontext = Context(session.history_file)\nrestored = await context.restore()\n```\n\nIf messages were restored from disk, the history file path is logged.\n\n**Sources:** [src/kimi_cli/__init__.py:336-339]()\n\n---\n\n### KimiSoul Instantiation\n\nThe soul (agent execution engine) is created with the assembled components:\n\n[src/kimi_cli/__init__.py:341-346]()\n\n```python\nsoul = KimiSoul(\n    agent,\n    agent_globals,\n    context=context,\n    loop_control=config.loop_control,\n)\n```\n\n**Sources:** [src/kimi_cli/__init__.py:341-346]()\n\n---\n\n### Working Directory Switch\n\nBefore UI instantiation, the process changes to the specified working directory:\n\n[src/kimi_cli/__init__.py:348-349]()\n\n```python\noriginal_cwd = Path.cwd()\nos.chdir(work_dir)\n```\n\nThe original directory is restored in the `finally` block at [src/kimi_cli/__init__.py:378-379]().\n\n**Sources:** [src/kimi_cli/__init__.py:348-379]()\n\n---\n\n### UI Mode Dispatch\n\nBased on the `ui` parameter, one of three UI implementations is instantiated and run:\n\n[src/kimi_cli/__init__.py:351-377]()\n\n| UI Mode | Class | Initialization | Use Case |\n|---------|-------|----------------|----------|\n| `shell` | `ShellApp` | Includes welcome info, stdin fallback | Interactive terminal |\n| `print` | `PrintApp` | Configured with input/output formats | Non-interactive pipelines |\n| `acp` | `ACPServer` | No special configuration | Agent Client Protocol server |\n\n**ShellApp Special Handling:**\n- If `command` is None and stdin is not a TTY, reads command from stdin\n- Redirects stderr to logger to suppress library warnings\n\n**Sources:** [src/kimi_cli/__init__.py:351-377]()\n\n---\n\n## Dependency Graph\n\n### Complete Component Initialization Dependencies\n\n```mermaid\ngraph TB\n    CLI[\"kimi() CLI Entry\"]\n    Args[\"Command-Line Arguments\"]\n    Config[\"Config\u003cbr/\u003e(load_config)\"]\n    Session[\"Session\u003cbr/\u003e(new/continue)\"]\n    \n    ModelSelect[\"Model Selection\u003cbr/\u003e(config + env vars)\"]\n    LLM[\"LLM Instance\u003cbr/\u003e(create_llm)\"]\n    \n    LSOutput[\"ls -la output\"]\n    AgentsMD[\"AGENTS.md content\"]\n    DateTime[\"datetime.now()\"]\n    \n    BuiltinArgs[\"BuiltinSystemPromptArgs\"]\n    DenwaRenji[\"DenwaRenji\"]\n    Approval[\"Approval\"]\n    \n    AgentGlobals[\"AgentGlobals\"]\n    \n    AgentFile[\"Agent YAML File\"]\n    AgentSpec[\"AgentSpec\u003cbr/\u003e(_load_agent_spec)\"]\n    SystemPrompt[\"System Prompt\u003cbr/\u003e(_load_system_prompt)\"]\n    Tools[\"Tools\u003cbr/\u003e(_load_tools)\"]\n    MCPTools[\"MCP Tools\u003cbr/\u003e(_load_mcp_tools)\"]\n    \n    Agent[\"Agent\"]\n    \n    HistoryFile[\"Session History File\"]\n    Context[\"Context\"]\n    \n    LoopControl[\"loop_control config\"]\n    Soul[\"KimiSoul\"]\n    \n    UI[\"UI Layer\u003cbr/\u003e(ShellApp/PrintApp/ACPServer)\"]\n    \n    CLI --\u003e Args\n    Args --\u003e Config\n    Args --\u003e Session\n    Args --\u003e AgentFile\n    \n    Config --\u003e ModelSelect\n    ModelSelect --\u003e LLM\n    \n    Args --\u003e LSOutput\n    Args --\u003e AgentsMD\n    DateTime --\u003e BuiltinArgs\n    LSOutput --\u003e BuiltinArgs\n    AgentsMD --\u003e BuiltinArgs\n    Args --\u003e BuiltinArgs\n    \n    Config --\u003e AgentGlobals\n    LLM --\u003e AgentGlobals\n    BuiltinArgs --\u003e AgentGlobals\n    DenwaRenji --\u003e AgentGlobals\n    Session --\u003e AgentGlobals\n    Approval --\u003e AgentGlobals\n    \n    AgentFile --\u003e AgentSpec\n    AgentSpec --\u003e SystemPrompt\n    AgentSpec --\u003e Tools\n    AgentGlobals --\u003e Tools\n    Args --\u003e MCPTools\n    \n    SystemPrompt --\u003e Agent\n    Tools --\u003e Agent\n    MCPTools --\u003e Agent\n    \n    Session --\u003e HistoryFile\n    HistoryFile --\u003e Context\n    \n    Agent --\u003e Soul\n    AgentGlobals --\u003e Soul\n    Context --\u003e Soul\n    Config --\u003e LoopControl\n    LoopControl --\u003e Soul\n    \n    Soul --\u003e UI\n    Args --\u003e UI\n```\n\n**Sources:** [src/kimi_cli/__init__.py:165-380](), [src/kimi_cli/agent.py:59-143]()\n\n---\n\n## Error Handling\n\n### Exception Types and Handling\n\nThe initialization sequence handles several exception categories:\n\n| Exception Type | Raised By | Handling |\n|----------------|-----------|----------|\n| `ConfigError` | `load_config()` | Convert to `ClickException` |\n| `BadOptionUsage` | Argument validation | Click handles with usage message |\n| `BadParameter` | Agent loading, empty command | Click handles with usage message |\n| `JSONDecodeError` | MCP config parsing | Convert to `BadOptionUsage` |\n| `ValueError` | `load_agent_with_mcp()` | Convert to `BadParameter` |\n| `Reload` | Meta command | Trigger reload loop |\n\n**Sources:** [src/kimi_cli/__init__.py:192-253]()\n\n---\n\n## Environment Variables\n\nThe system supports environment variable overrides for LLM configuration:\n\n[src/kimi_cli/__init__.py:294]()\n\nThe `augment_provider_with_env_vars()` function checks for variables like:\n- `KIMI_LLM_BASE_URL`\n- `KIMI_LLM_API_KEY`\n- `KIMI_LLM_MODEL`\n\nThis allows runtime configuration without modifying config files.\n\n**Sources:** [src/kimi_cli/__init__.py:294](), [src/kimi_cli/utils/provider.py]()\n\n---\n\n## Version Information\n\nThe application version is retrieved from package metadata:\n\n[src/kimi_cli/__init__.py:43-44]()\n\n```python\n__version__ = importlib.metadata.version(\"kimi-cli\")\nUSER_AGENT = f\"KimiCLI/{__version__}\"\n```\n\nThe `USER_AGENT` string is used in LLM API calls.\n\n**Sources:** [src/kimi_cli/__init__.py:43-44]()"])</script><script>self.__next_f.push([1,"1a:T488b,"])</script><script>self.__next_f.push([1,"# Agent System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/agents/koder/agent.yaml](src/kimi_cli/agents/koder/agent.yaml)\n- [src/kimi_cli/agents/koder/sub.yaml](src/kimi_cli/agents/koder/sub.yaml)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/tools/web/__init__.py](src/kimi_cli/tools/web/__init__.py)\n- [src/kimi_cli/tools/web/fetch.md](src/kimi_cli/tools/web/fetch.md)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe Agent System is the core abstraction layer that defines agent behavior and orchestrates their execution. This document covers agent specification formats, loading mechanisms, dependency injection via `AgentGlobals`, and the `KimiSoul` execution engine that runs agent loops. For information about specific tool implementations that agents can invoke, see [Tool System](#6). For UI-level interactions, see [User Interfaces](#4). For configuration of LLM providers, see [LLM Integration](#3.3).\n\n## Agent Core Structures\n\nThe agent system revolves around three primary data structures that define agent behavior, manage dependencies, and execute agent logic.\n\n### Agent Definition\n\nAn `Agent` is an immutable data structure representing a fully loaded, ready-to-execute agent. It consists of:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `name` | `str` | Human-readable agent identifier |\n| `system_prompt` | `str` | Fully interpolated system prompt text |\n| `toolset` | `Toolset` | Collection of executable tools |\n\n**Agent Hierarchy Diagram**\n\n```mermaid\ngraph TB\n    subgraph \"Agent Definition\"\n        Agent[\"Agent\u003cbr/\u003e(NamedTuple)\"]\n        Agent --\u003e name[\"name: str\"]\n        Agent --\u003e system_prompt[\"system_prompt: str\"]\n        Agent --\u003e toolset[\"toolset: Toolset\"]\n    end\n    \n    subgraph \"Agent Specification\"\n        AgentSpec[\"AgentSpec\u003cbr/\u003e(BaseModel)\"]\n        AgentSpec --\u003e extend[\"extend: str | None\"]\n        AgentSpec --\u003e spec_name[\"name: str | None\"]\n        AgentSpec --\u003e system_prompt_path[\"system_prompt_path: Path | None\"]\n        AgentSpec --\u003e system_prompt_args[\"system_prompt_args: dict[str, str]\"]\n        AgentSpec --\u003e tools[\"tools: list[str] | None\"]\n        AgentSpec --\u003e exclude_tools[\"exclude_tools: list[str] | None\"]\n        AgentSpec --\u003e subagents[\"subagents: dict[str, SubagentSpec] | None\"]\n    end\n    \n    subgraph \"Dependency Container\"\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003e(NamedTuple)\"]\n        AgentGlobals --\u003e config[\"config: Config\"]\n        AgentGlobals --\u003e llm[\"llm: LLM | None\"]\n        AgentGlobals --\u003e builtin_args[\"builtin_args: BuiltinSystemPromptArgs\"]\n        AgentGlobals --\u003e denwa_renji[\"denwa_renji: DenwaRenji\"]\n        AgentGlobals --\u003e session[\"session: Session\"]\n        AgentGlobals --\u003e approval[\"approval: Approval\"]\n    end\n    \n    AgentSpec -.loads into.-\u003e Agent\n    AgentGlobals -.injected during.-\u003e Agent\n```\n\n**Sources:** [src/kimi_cli/agent.py:70-76](), [src/kimi_cli/agent.py:23-36](), [src/kimi_cli/agent.py:59-67]()\n\n### AgentSpec Structure\n\n`AgentSpec` is a Pydantic model defining the agent's configuration in YAML format. It supports inheritance through the `extend` field:\n\n| Field | Required | Description |\n|-------|----------|-------------|\n| `extend` | No | Agent file to inherit from (`\"default\"` or relative path) |\n| `name` | Yes | Agent name (inherited if not specified) |\n| `system_prompt_path` | Yes | Path to system prompt file (relative to agent file) |\n| `system_prompt_args` | No | Template variables for system prompt substitution |\n| `tools` | Yes | List of tool import paths (`\"module:ClassName\"`) |\n| `exclude_tools` | No | Tools to remove from inherited toolset |\n| `subagents` | No | Named subagent definitions for Task tool |\n\n**Example Agent Specification:**\n\n```yaml\nversion: 1\nagent:\n  extend: \"default\"\n  name: \"Custom Koder\"\n  system_prompt_path: ./custom_prompt.md\n  system_prompt_args:\n    ROLE_ADDITIONAL: \"You are an expert in Python.\"\n  exclude_tools:\n    - \"kimi_cli.tools.dmail:SendDMail\"\n```\n\n**Sources:** [src/kimi_cli/agent.py:23-36](), [src/kimi_cli/agents/koder/agent.yaml:1-25]()\n\n### AgentGlobals Container\n\n`AgentGlobals` is a dependency injection container providing global state to agents and tools:\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `config` | `Config` | System configuration including loop control |\n| `llm` | `LLM \\| None` | Language model instance for inference |\n| `builtin_args` | `BuiltinSystemPromptArgs` | Dynamic template variables (time, working directory) |\n| `denwa_renji` | `DenwaRenji` | Time-travel checkpoint manager |\n| `session` | `Session` | Current session metadata and history path |\n| `approval` | `Approval` | User approval system for tool execution |\n\nThe container is instantiated once per kimi-cli invocation and shared across all agents in the execution tree.\n\n**Sources:** [src/kimi_cli/agent.py:59-67](), [src/kimi_cli/__init__.py:310-322]()\n\n### BuiltinSystemPromptArgs\n\nSystem prompts are interpolated with runtime context via template substitution. Four built-in variables are always available:\n\n| Variable | Type | Description |\n|----------|------|-------------|\n| `KIMI_NOW` | `str` | ISO 8601 timestamp of agent start time |\n| `KIMI_WORK_DIR` | `Path` | Absolute path to working directory |\n| `KIMI_WORK_DIR_LS` | `str` | Output of `ls -la` in working directory |\n| `KIMI_AGENTS_MD` | `str` | Contents of `AGENTS.md` file if present |\n\n**Sources:** [src/kimi_cli/agent.py:46-56](), [src/kimi_cli/__init__.py:313-318]()\n\n## Agent Loading Pipeline\n\nThe agent loading process resolves inheritance hierarchies, interpolates system prompts, and instantiates tools with proper dependency injection.\n\n**Agent Loading Flow Diagram**\n\n```mermaid\ngraph TB\n    Start[/\"kimi_run()\"/]\n    Start --\u003e LoadAgentFile[\"load_agent_with_mcp()\u003cbr/\u003e(agent.py:85)\"]\n    \n    LoadAgentFile --\u003e LoadSpec[\"_load_agent_spec()\u003cbr/\u003e(agent.py:145)\"]\n    LoadSpec --\u003e ParseYAML[\"yaml.safe_load()\u003cbr/\u003eParse agent.yaml\"]\n    \n    ParseYAML --\u003e CheckExtend{extend\u003cbr/\u003especified?}\n    CheckExtend --\u003e|Yes| ResolveBase[\"Resolve base agent file\u003cbr/\u003eDEFAULT_AGENT_FILE or relative path\"]\n    ResolveBase --\u003e RecurseLoad[\"Recursive _load_agent_spec()\u003cbr/\u003eon base file\"]\n    RecurseLoad --\u003e MergeSpecs[\"Merge specs:\u003cbr/\u003echild overrides parent\"]\n    \n    CheckExtend --\u003e|No| ValidateSpec[\"Validate required fields:\u003cbr/\u003ename, system_prompt_path, tools\"]\n    MergeSpecs --\u003e ValidateSpec\n    \n    ValidateSpec --\u003e LoadSystemPrompt[\"_load_system_prompt()\u003cbr/\u003e(agent.py:182)\"]\n    LoadSystemPrompt --\u003e ReadFile[\"path.read_text()\"]\n    ReadFile --\u003e Substitute[\"string.Template.substitute()\u003cbr/\u003ebuiltin_args + system_prompt_args\"]\n    \n    Substitute --\u003e CreateToolDeps[\"Build tool dependencies dict:\u003cbr/\u003eAgentSpec, AgentGlobals, Config, etc.\"]\n    CreateToolDeps --\u003e LoadTools[\"_load_tools()\u003cbr/\u003e(agent.py:194)\"]\n    \n    LoadTools --\u003e IterateTools[\"For each tool in tools list\"]\n    IterateTools --\u003e LoadTool[\"_load_tool()\u003cbr/\u003e(agent.py:212)\"]\n    LoadTool --\u003e ImportModule[\"importlib.import_module()\"]\n    ImportModule --\u003e InjectDeps[\"Inject constructor dependencies\u003cbr/\u003evia inspect.signature\"]\n    InjectDeps --\u003e InstantiateTool[\"cls(*args)\"]\n    \n    InstantiateTool --\u003e AddToToolset[\"toolset += tool\"]\n    AddToToolset --\u003e NextTool{More\u003cbr/\u003etools?}\n    NextTool --\u003e|Yes| IterateTools\n    NextTool --\u003e|No| LoadMCP[\"_load_mcp_tools()\u003cbr/\u003e(agent.py:234)\"]\n    \n    LoadMCP --\u003e CreateAgent[\"Create Agent(\u003cbr/\u003ename, system_prompt, toolset)\"]\n    CreateAgent --\u003e Return[/\"Return Agent\"/]\n    \n    style LoadSpec fill:#f9f9f9\n    style LoadSystemPrompt fill:#f9f9f9\n    style LoadTools fill:#f9f9f9\n    style CreateAgent fill:#f9f9f9\n```\n\n**Sources:** [src/kimi_cli/agent.py:85-142](), [src/kimi_cli/agent.py:145-179](), [src/kimi_cli/agent.py:182-191](), [src/kimi_cli/agent.py:194-209]()\n\n### Inheritance Resolution\n\nThe `extend` mechanism supports three inheritance modes:\n\n1. **No inheritance:** Agent defines all fields directly\n2. **Default inheritance:** `extend: \"default\"` inherits from `DEFAULT_AGENT_FILE` ([src/kimi_cli/agents/koder/agent.yaml]())\n3. **Custom inheritance:** `extend: \"./other.yaml\"` inherits from relative path\n\nThe inheritance merge strategy:\n- Child `name` overrides parent `name`\n- Child `system_prompt_path` overrides parent `system_prompt_path`\n- Child `system_prompt_args` are merged (child values override parent keys)\n- Child `tools` completely replaces parent `tools` (no merging)\n- Child `exclude_tools` completely replaces parent `exclude_tools`\n- Child `subagents` completely replaces parent `subagents`\n\n**Sources:** [src/kimi_cli/agent.py:160-179]()\n\n### Tool Dependency Injection\n\nTools are instantiated with constructor dependency injection. The loading system inspects each tool class constructor and injects dependencies from a predefined set:\n\n```python\ntool_deps = {\n    AgentSpec: agent_spec,\n    AgentGlobals: globals_,\n    Config: globals_.config,\n    BuiltinSystemPromptArgs: globals_.builtin_args,\n    Session: globals_.session,\n    DenwaRenji: globals_.denwa_renji,\n    Approval: globals_.approval,\n}\n```\n\nTools declare their dependencies via type-annotated constructor parameters. The system injects them in order, stopping at the first keyword-only parameter.\n\n**Sources:** [src/kimi_cli/agent.py:120-134](), [src/kimi_cli/agent.py:212-231]()\n\n## KimiSoul Execution Engine\n\n`KimiSoul` is the concrete implementation of the `Soul` protocol, responsible for executing agent loops, managing context, handling time travel, and coordinating with the LLM.\n\n### Soul Protocol\n\nThe `Soul` protocol defines the contract for any agent execution engine:\n\n```python\n@runtime_checkable\nclass Soul(Protocol):\n    @property\n    def name(self) -\u003e str: ...\n    \n    @property\n    def model(self) -\u003e str: ...\n    \n    @property\n    def status(self) -\u003e StatusSnapshot: ...\n    \n    async def run(self, user_input: str, wire: Wire): ...\n```\n\n`KimiSoul` implements this protocol and is the only concrete implementation in the codebase. The protocol abstraction allows UI layers to interact with any execution engine uniformly.\n\n**Sources:** [src/kimi_cli/soul/__init__.py:28-59](), [src/kimi_cli/soul/kimisoul.py:305-308]()\n\n### KimiSoul Initialization\n\n`KimiSoul` is instantiated with four key components:\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `agent` | `Agent` | The loaded agent definition to execute |\n| `agent_globals` | `AgentGlobals` | Dependency container with shared state |\n| `context` | `Context` | Conversation history and checkpoint manager |\n| `loop_control` | `LoopControl` | Execution limits (`max_steps_per_run`, `max_retries_per_step`) |\n\nThe constructor also determines whether to enable checkpoint-on-user-message based on the presence of `SendDMail` tool, which requires checkpoint support for time travel.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:43-76](), [src/kimi_cli/__init__.py:341-346]()\n\n### Agent Execution Loop\n\nThe `run()` method orchestrates the complete agent execution lifecycle.\n\n**KimiSoul Execution Loop Diagram**\n\n```mermaid\ngraph TB\n    Start[/\"run(user_input, wire)\"/]\n    Start --\u003e CheckLLM{LLM set?}\n    CheckLLM --\u003e|No| RaiseLLMNotSet[\"raise LLMNotSet()\"]\n    CheckLLM --\u003e|Yes| Checkpoint0[\"_checkpoint()\u003cbr/\u003eCreate checkpoint 0\"]\n    \n    Checkpoint0 --\u003e AppendUser[\"context.append_message()\u003cbr/\u003euser message\"]\n    AppendUser --\u003e SetWire[\"current_wire.set(wire)\u003cbr/\u003eContext variable\"]\n    SetWire --\u003e AgentLoop[\"_agent_loop(wire)\"]\n    \n    AgentLoop --\u003e StepLoop[\"step_no = 1\u003cbr/\u003ewhile True:\"]\n    StepLoop --\u003e SendStepBegin[\"wire.send(StepBegin)\"]\n    SendStepBegin --\u003e StartApprovalPipe[\"Create approval pipe task\u003cbr/\u003eForward approval requests to wire\"]\n    \n    StartApprovalPipe --\u003e CheckContext{Context + reserved\u003cbr/\u003e\u003e= max_context?}\n    CheckContext --\u003e|Yes| SendCompactBegin[\"wire.send(CompactionBegin)\"]\n    SendCompactBegin --\u003e CompactContext[\"compact_context()\"]\n    CompactContext --\u003e SendCompactEnd[\"wire.send(CompactionEnd)\"]\n    SendCompactEnd --\u003e CheckpointBeforeStep\n    \n    CheckContext --\u003e|No| CheckpointBeforeStep[\"_checkpoint()\u003cbr/\u003eBefore step execution\"]\n    CheckpointBeforeStep --\u003e UpdateDenwaRenji[\"denwa_renji.set_n_checkpoints()\"]\n    UpdateDenwaRenji --\u003e ExecuteStep[\"_step(wire)\"]\n    \n    ExecuteStep --\u003e KosongStep[\"kosong.step()\u003cbr/\u003eLLM inference with retry\"]\n    KosongStep --\u003e UpdateTokens[\"context.update_token_count()\u003cbr/\u003efrom usage.input\"]\n    UpdateTokens --\u003e SendStatus[\"wire.send(StatusUpdate)\"]\n    SendStatus --\u003e WaitTools[\"await result.tool_results()\"]\n    \n    WaitTools --\u003e GrowContext[\"_grow_context()\u003cbr/\u003eAppend messages atomically\"]\n    GrowContext --\u003e CheckRejected{Tool\u003cbr/\u003erejected?}\n    CheckRejected --\u003e|Yes| FetchDmail1[\"denwa_renji.fetch_pending_dmail()\"]\n    FetchDmail1 --\u003e ReturnTrue[\"return True\u003cbr/\u003eStop loop\"]\n    \n    CheckRejected --\u003e|No| CheckDmail{Pending\u003cbr/\u003eD-Mail?}\n    CheckDmail --\u003e|Yes| RaiseBTTF[\"raise BackToTheFuture\u003cbr/\u003e(checkpoint_id, messages)\"]\n    CheckDmail --\u003e|No| CheckFinished{Tool calls\u003cbr/\u003eempty?}\n    \n    CheckFinished --\u003e|Yes| ReturnFromLoop[\"Return from loop\"]\n    CheckFinished --\u003e|No| IncrementStep[\"step_no += 1\"]\n    IncrementStep --\u003e CheckMaxSteps{step_no \u003e\u003cbr/\u003emax_steps?}\n    CheckMaxSteps --\u003e|Yes| RaiseMaxSteps[\"raise MaxStepsReached\"]\n    CheckMaxSteps --\u003e|No| StepLoop\n    \n    RaiseBTTF -.caught by.-\u003e RevertContext[\"context.revert_to()\u003cbr/\u003echeckpoint_id\"]\n    RevertContext --\u003e CheckpointAfterRevert[\"_checkpoint()\"]\n    CheckpointAfterRevert --\u003e AppendDmail[\"context.append_message()\u003cbr/\u003eD-Mail system message\"]\n    AppendDmail --\u003e StepLoop\n    \n    ExecuteStep -.on error.-\u003e SendInterrupted[\"wire.send(StepInterrupted)\"]\n    SendInterrupted --\u003e RaiseError[\"Reraise exception\"]\n    \n    style Checkpoint0 fill:#f9f9f9\n    style CheckpointBeforeStep fill:#f9f9f9\n    style ExecuteStep fill:#f9f9f9\n    style GrowContext fill:#f9f9f9\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:99-110](), [src/kimi_cli/soul/kimisoul.py:112-161](), [src/kimi_cli/soul/kimisoul.py:163-232]()\n\n### Step Execution with Retry\n\nIndividual LLM steps use exponential backoff retry for transient errors:\n\n- **Retryable errors:** `APIConnectionError`, `APITimeoutError`, status codes 429/500/502/503\n- **Retry strategy:** Exponential jitter wait (0.3s initial, 5s max, 0.5s jitter)\n- **Max attempts:** `loop_control.max_retries_per_step` (configurable in `config.json`)\n\nThe retry logic is implemented via Tenacity decorators in both `_step()` and `compact_context()`.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:169-186](), [src/kimi_cli/soul/kimisoul.py:254-264](), [src/kimi_cli/soul/kimisoul.py:271-291]()\n\n### Checkpoint Management\n\nCheckpoints enable the D-Mail time-travel mechanism. The checkpoint lifecycle:\n\n1. **Checkpoint 0:** Created before first user message in `run()`\n2. **Step checkpoints:** Created at the start of each step in `_agent_loop()`\n3. **Compaction checkpoints:** Created after context compaction\n4. **Time-travel:** When `BackToTheFuture` is raised, context reverts to a checkpoint\n\nThe `_checkpoint_with_user_message` flag determines whether user messages trigger checkpoints. It's enabled when `SendDMail` tool is present.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:71-76](), [src/kimi_cli/soul/kimisoul.py:96-97](), [src/kimi_cli/soul/kimisoul.py:141-142]()\n\n### BackToTheFuture Exception\n\nTime travel is implemented via exception-based control flow. When a D-Mail is received:\n\n1. `SendDMail` tool enqueues message in `DenwaRenji`\n2. After tool execution, `_step()` checks for pending D-Mail\n3. If found, raises `BackToTheFuture(checkpoint_id, messages)`\n4. `_agent_loop()` catches exception, reverts context, and appends system message\n5. Loop continues from the reverted checkpoint\n\nThe system message injected with the D-Mail instructs the agent to read the message and act on it without mentioning it to the user.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:206-230](), [src/kimi_cli/soul/kimisoul.py:144-148](), [src/kimi_cli/soul/kimisoul.py:294-302]()\n\n### Context Compaction\n\nWhen context size approaches the model's limit (detected by `context.token_count + RESERVED_TOKENS \u003e= max_context_size`), the system automatically compacts history:\n\n1. Send `CompactionBegin()` event to UI\n2. Call `_compaction.compact()` with current history\n3. Revert context to checkpoint 0\n4. Create new checkpoint\n5. Append compacted messages\n6. Send `CompactionEnd()` event to UI\n\nCompaction uses the `SimpleCompaction` strategy, which delegates to the LLM to summarize conversation history.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:131-138](), [src/kimi_cli/soul/kimisoul.py:245-269](), [src/kimi_cli/soul/kimisoul.py:37](), [src/kimi_cli/soul/kimisoul.py:66]()\n\n## Agent Lifecycle Summary\n\n**End-to-End Agent Lifecycle Diagram**\n\n```mermaid\ngraph LR\n    YAML[\"agent.yaml\u003cbr/\u003eAgentSpec\"]\n    Globals[\"AgentGlobals\u003cbr/\u003eDependencies\"]\n    \n    YAML --\u003e LoadAgent[\"load_agent()\"]\n    Globals --\u003e LoadAgent\n    \n    LoadAgent --\u003e ResolveInheritance[\"Resolve extend\u003cbr/\u003erecursively\"]\n    ResolveInheritance --\u003e InterpolatePrompt[\"Interpolate\u003cbr/\u003esystem_prompt\"]\n    InterpolatePrompt --\u003e InjectTools[\"Inject tool\u003cbr/\u003edependencies\"]\n    InjectTools --\u003e Agent[\"Agent\u003cbr/\u003e(immutable)\"]\n    \n    Agent --\u003e Context[\"Context\u003cbr/\u003e(history file)\"]\n    Context --\u003e KimiSoul[\"KimiSoul\u003cbr/\u003e(execution engine)\"]\n    Globals --\u003e KimiSoul\n    \n    KimiSoul --\u003e ShellApp[\"ShellApp/PrintApp/ACPServer\"]\n    ShellApp --\u003e Wire[\"Wire\u003cbr/\u003e(event queue)\"]\n    \n    Wire --\u003e run[\"run(user_input, wire)\"]\n    run --\u003e Loop[\"Agent loop:\u003cbr/\u003eLLM steps\"]\n    Loop --\u003e Tools[\"Tool execution\"]\n    Tools --\u003e Checkpoints[\"Checkpoint\u003cbr/\u003emanagement\"]\n    Checkpoints --\u003e DMail[\"D-Mail\u003cbr/\u003etime travel\"]\n    \n    style Agent fill:#f9f9f9\n    style KimiSoul fill:#f9f9f9\n```\n\n**Sources:** [src/kimi_cli/__init__.py:233-346](), [src/kimi_cli/agent.py:85-142](), [src/kimi_cli/soul/kimisoul.py:99-161]()\n\nThe agent system provides a declarative, extensible architecture for defining agent behavior while maintaining a clean separation between specification (YAML), loading (dependency injection), and execution (KimiSoul loop). The checkpoint-based time-travel mechanism and retry strategies ensure robust execution even with unreliable LLM providers."])</script><script>self.__next_f.push([1,"1b:T447f,"])</script><script>self.__next_f.push([1,"# LLM Integration\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/llm.py](src/kimi_cli/llm.py)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document explains how kimi-cli integrates with Large Language Model (LLM) providers to power agent intelligence. It covers the configuration structure for LLM providers and models, the abstraction layer used for provider independence, and the mechanisms for creating and managing LLM connections.\n\nFor information about how agents use LLMs during execution, see [Agent System](#3.2). For configuration file format and management, see [Configuration Reference](#8).\n\n---\n\n## Architecture Overview\n\nThe LLM integration layer provides a unified interface for connecting to different LLM providers. It abstracts provider-specific details behind the `kosong` library's `ChatProvider` interface, allowing agents to work with any supported provider without modification.\n\n### Component Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Configuration Layer\"\n        ConfigFile[\"config.json\"]\n        ConfigClass[\"Config\"]\n        LLMModelClass[\"LLMModel\"]\n        LLMProviderClass[\"LLMProvider\"]\n    end\n    \n    subgraph \"Provider Factory\"\n        ProviderModule[\"utils/provider.py\"]\n        CreateLLM[\"create_llm()\"]\n        AugmentEnv[\"augment_provider_with_env_vars()\"]\n    end\n    \n    subgraph \"kosong Abstraction\"\n        ChatProvider[\"ChatProvider\u003cbr/\u003e(kosong.base)\"]\n        Kimi[\"Kimi\u003cbr/\u003e(kosong.chat_provider)\"]\n        OpenAILegacy[\"OpenAILegacy\u003cbr/\u003e(kosong.chat_provider)\"]\n        ChaosChatProvider[\"ChaosChatProvider\u003cbr/\u003e(testing)\"]\n    end\n    \n    subgraph \"LLM Wrapper\"\n        LLMClass[\"LLM NamedTuple\u003cbr/\u003e(llm.py)\"]\n    end\n    \n    subgraph \"Agent Execution\"\n        KimiSoul[\"KimiSoul\"]\n        KosongStep[\"kosong.step()\"]\n    end\n    \n    ConfigFile --\u003e ConfigClass\n    ConfigClass --\u003e LLMModelClass\n    ConfigClass --\u003e LLMProviderClass\n    \n    LLMProviderClass --\u003e AugmentEnv\n    LLMModelClass --\u003e AugmentEnv\n    AugmentEnv --\u003e CreateLLM\n    \n    CreateLLM --\u003e Kimi\n    CreateLLM --\u003e OpenAILegacy\n    CreateLLM --\u003e ChaosChatProvider\n    \n    Kimi --\u003e ChatProvider\n    OpenAILegacy --\u003e ChatProvider\n    ChaosChatProvider --\u003e ChatProvider\n    \n    ChatProvider --\u003e LLMClass\n    LLMClass --\u003e KimiSoul\n    LLMClass --\u003e KosongStep\n```\n\n**Sources:** [src/kimi_cli/config.py:1-139](), [src/kimi_cli/utils/provider.py:1-73](), [src/kimi_cli/llm.py:1-9]()\n\n---\n\n## Configuration Structure\n\nLLM integration is configured through two primary classes: `LLMProvider` for API connection details and `LLMModel` for model-specific settings.\n\n### Configuration Classes\n\n```mermaid\nclassDiagram\n    class Config {\n        +str default_model\n        +dict~str,LLMModel~ models\n        +dict~str,LLMProvider~ providers\n        +LoopControl loop_control\n        +Services services\n        +validate_model() Self\n    }\n    \n    class LLMProvider {\n        +Literal type\n        +str base_url\n        +SecretStr api_key\n        +dump_secret() str\n    }\n    \n    class LLMModel {\n        +str provider\n        +str model\n        +int max_context_size\n    }\n    \n    class LoopControl {\n        +int max_steps_per_run\n        +int max_retries_per_step\n    }\n    \n    class Services {\n        +MoonshotSearchConfig moonshot_search\n    }\n    \n    Config --\u003e LLMModel\n    Config --\u003e LLMProvider\n    Config --\u003e LoopControl\n    Config --\u003e Services\n    LLMModel --\u003e LLMProvider\n```\n\n**Sources:** [src/kimi_cli/config.py:11-85]()\n\n### LLMProvider\n\nThe `LLMProvider` class defines connection parameters for an LLM API endpoint:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `type` | `Literal[\"kimi\", \"openai_legacy\", \"_chaos\"]` | Provider type identifier |\n| `base_url` | `str` | API endpoint base URL |\n| `api_key` | `SecretStr` | API authentication key (securely stored) |\n\nThe `api_key` field uses Pydantic's `SecretStr` type to prevent accidental logging or display of sensitive credentials. When serialized to JSON, the secret is extracted using the `dump_secret` method [src/kimi_cli/config.py:21-23]().\n\n**Sources:** [src/kimi_cli/config.py:11-24]()\n\n### LLMModel\n\nThe `LLMModel` class associates a model with a provider and defines its capabilities:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `str` | Name key referencing an entry in `Config.providers` |\n| `model` | `str` | Model identifier (e.g., \"moonshot-v1-128k\") |\n| `max_context_size` | `int` | Maximum context window in tokens |\n\nThe `provider` field must reference a valid provider key in the configuration, which is validated by `Config.validate_model()` [src/kimi_cli/config.py:82-83]().\n\n**Sources:** [src/kimi_cli/config.py:26-35]()\n\n### Configuration Example\n\n```json\n{\n  \"default_model\": \"kimi-128k\",\n  \"models\": {\n    \"kimi-128k\": {\n      \"provider\": \"kimi_provider\",\n      \"model\": \"moonshot-v1-128k\",\n      \"max_context_size\": 128000\n    }\n  },\n  \"providers\": {\n    \"kimi_provider\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"sk-...\"\n    }\n  }\n}\n```\n\n**Sources:** [src/kimi_cli/config.py:66-85]()\n\n---\n\n## Provider Types\n\nkimi-cli supports multiple LLM provider types, each implementing the `kosong.ChatProvider` interface.\n\n### Supported Providers\n\n| Provider Type | Implementation | Use Case |\n|--------------|----------------|----------|\n| `kimi` | `kosong.chat_provider.Kimi` | Moonshot AI's Kimi models with prompt caching |\n| `openai_legacy` | `kosong.chat_provider.OpenAILegacy` | OpenAI-compatible APIs (OpenAI, Azure, local models) |\n| `_chaos` | `kosong.chat_provider.ChaosChatProvider` | Testing provider that simulates errors |\n\n**Sources:** [src/kimi_cli/config.py:14](), [src/kimi_cli/utils/provider.py:3-4]()\n\n### Provider-Specific Features\n\n#### Kimi Provider\n\nThe Kimi provider includes specialized features for Moonshot AI's API:\n\n- **Prompt Caching**: Uses `prompt_cache_key` generation kwargs to enable caching when a `session_id` is provided [src/kimi_cli/utils/provider.py:50-51]()\n- **Custom User-Agent**: Sets `kimi_cli.USER_AGENT` in default headers [src/kimi_cli/utils/provider.py:46-48]()\n- **Streaming Support**: Configured via the `stream` parameter\n\n```python\n# Kimi provider creation with prompt caching\nchat_provider = Kimi(\n    model=model.model,\n    base_url=provider.base_url,\n    api_key=provider.api_key.get_secret_value(),\n    stream=stream,\n    default_headers={\"User-Agent\": kimi_cli.USER_AGENT},\n)\nif session_id:\n    chat_provider = chat_provider.with_generation_kwargs(\n        prompt_cache_key=session_id\n    )\n```\n\n**Sources:** [src/kimi_cli/utils/provider.py:40-51]()\n\n#### OpenAI Legacy Provider\n\nThe OpenAI Legacy provider supports any OpenAI-compatible API:\n\n- Standard OpenAI API format\n- Compatible with Azure OpenAI, local models (LM Studio, Ollama with OpenAI adapters)\n- Configurable base URL for alternate endpoints\n\n**Sources:** [src/kimi_cli/utils/provider.py:52-58]()\n\n#### Chaos Provider\n\nThe Chaos provider is used for testing error handling:\n\n- Simulates API errors with configurable probability [src/kimi_cli/utils/provider.py:64-67]()\n- Generates HTTP errors (429, 500, 503)\n- Not intended for production use\n\n**Sources:** [src/kimi_cli/utils/provider.py:59-68]()\n\n---\n\n## Provider Creation Flow\n\nLLM providers are created through a two-stage process: environment variable augmentation followed by provider instantiation.\n\n### Creation Pipeline\n\n```mermaid\nsequenceDiagram\n    participant Agent as Agent Initialization\n    participant Config as Config Object\n    participant Augment as augment_provider_with_env_vars()\n    participant Create as create_llm()\n    participant Factory as Provider Factory\n    participant LLM as LLM Instance\n    \n    Agent-\u003e\u003eConfig: Get provider \u0026 model config\n    Config-\u003e\u003eAugment: provider, model\n    \n    Note over Augment: Check environment variables\u003cbr/\u003eKIMI_*, OPENAI_*\n    \n    Augment-\u003e\u003eAugment: Override config fields\n    Augment-\u003e\u003eCreate: augmented provider, model\n    \n    Create-\u003e\u003eCreate: Match on provider.type\n    \n    alt type == \"kimi\"\n        Create-\u003e\u003eFactory: new Kimi()\n        Factory-\u003e\u003eCreate: Kimi instance\n        opt session_id provided\n            Create-\u003e\u003eCreate: Add prompt_cache_key\n        end\n    else type == \"openai_legacy\"\n        Create-\u003e\u003eFactory: new OpenAILegacy()\n        Factory-\u003e\u003eCreate: OpenAILegacy instance\n    else type == \"_chaos\"\n        Create-\u003e\u003eFactory: new ChaosChatProvider()\n        Factory-\u003e\u003eCreate: ChaosChatProvider instance\n    end\n    \n    Create-\u003e\u003eLLM: Wrap in LLM NamedTuple\n    LLM-\u003e\u003eAgent: Return LLM instance\n```\n\n**Sources:** [src/kimi_cli/utils/provider.py:12-73]()\n\n### Environment Variable Augmentation\n\nThe `augment_provider_with_env_vars()` function allows runtime override of configuration values through environment variables [src/kimi_cli/utils/provider.py:12-30]():\n\n| Provider | Environment Variables |\n|----------|----------------------|\n| **kimi** | `KIMI_BASE_URL`\u003cbr/\u003e`KIMI_API_KEY`\u003cbr/\u003e`KIMI_MODEL_NAME`\u003cbr/\u003e`KIMI_MODEL_MAX_CONTEXT_SIZE` |\n| **openai_legacy** | `OPENAI_BASE_URL`\u003cbr/\u003e`OPENAI_API_KEY` |\n\nThis mechanism enables:\n- Local development with different credentials\n- CI/CD pipeline configuration\n- Temporary provider switching without config file changes\n\n**Sources:** [src/kimi_cli/utils/provider.py:12-30]()\n\n### Provider Instantiation\n\nThe `create_llm()` function instantiates the appropriate provider based on configuration [src/kimi_cli/utils/provider.py:32-73]():\n\n**Parameters:**\n- `provider: LLMProvider` - Provider configuration\n- `model: LLMModel` - Model configuration\n- `stream: bool = True` - Enable streaming responses\n- `session_id: str | None = None` - Session ID for prompt caching (Kimi only)\n\n**Returns:** `LLM` - A NamedTuple wrapping the `ChatProvider` instance and context size\n\nThe function uses pattern matching on `provider.type` to create the appropriate provider implementation, then wraps it in the `LLM` NamedTuple [src/kimi_cli/utils/provider.py:39-72]().\n\n**Sources:** [src/kimi_cli/utils/provider.py:32-73]()\n\n---\n\n## The LLM Wrapper\n\nThe `LLM` class is a simple NamedTuple that pairs a `ChatProvider` with its context size limit [src/kimi_cli/llm.py:6-9]():\n\n```python\nclass LLM(NamedTuple):\n    chat_provider: ChatProvider\n    max_context_size: int\n```\n\n### Purpose\n\nThis wrapper serves several functions:\n\n1. **Type Safety**: Provides a single type that bundles provider and configuration\n2. **Context Awareness**: Keeps the context size limit with the provider for compaction decisions\n3. **Simplified Passing**: Single object to pass through the system instead of multiple parameters\n\n### Usage Pattern\n\nThe `LLM` instance is typically created during agent initialization and stored in `AgentGlobals`, where it's accessible to the execution engine:\n\n```mermaid\ngraph LR\n    CreateLLM[\"create_llm()\"]\n    LLMInstance[\"LLM Instance\"]\n    AgentGlobals[\"AgentGlobals\"]\n    KimiSoul[\"KimiSoul\"]\n    KosongStep[\"kosong.step()\"]\n    \n    CreateLLM --\u003e LLMInstance\n    LLMInstance --\u003e AgentGlobals\n    AgentGlobals --\u003e KimiSoul\n    KimiSoul --\u003e KosongStep\n    \n    LLMInstance -.-\u003e ChatProvider[\"chat_provider field\"]\n    LLMInstance -.-\u003e ContextSize[\"max_context_size field\"]\n```\n\n**Sources:** [src/kimi_cli/llm.py:1-9]()\n\n---\n\n## Integration with kosong Library\n\nkimi-cli uses the `kosong` library as its LLM abstraction layer. This library provides:\n\n### ChatProvider Interface\n\nThe `kosong.base.chat_provider.ChatProvider` interface defines the contract for all LLM providers:\n\n- Asynchronous message generation\n- Streaming support\n- Tool calling capabilities\n- Generation parameter customization\n\n### Provider Implementations\n\nThe `kosong.chat_provider` module includes production implementations:\n\n| Class | Purpose |\n|-------|---------|\n| `Kimi` | Moonshot AI's proprietary API with prompt caching |\n| `OpenAILegacy` | OpenAI-compatible APIs (OpenAI, Azure, compatible local models) |\n| `ChaosChatProvider` | Testing provider for error handling validation |\n\n### Agent Execution Integration\n\nThe `kosong.step()` function is the bridge between kimi-cli's agent system and the LLM provider:\n\n```mermaid\ngraph TB\n    subgraph \"kimi-cli Agent Layer\"\n        Agent[\"Agent Instance\"]\n        Context[\"Context\u003cbr/\u003e(message history)\"]\n        Tools[\"Agent Tools\"]\n    end\n    \n    subgraph \"kosong Integration\"\n        KosongStep[\"kosong.step()\"]\n        ChatProvider[\"ChatProvider\"]\n    end\n    \n    subgraph \"LLM Provider\"\n        API[\"LLM API\u003cbr/\u003e(Kimi, OpenAI, etc)\"]\n    end\n    \n    Agent --\u003e Context\n    Agent --\u003e Tools\n    \n    Context --\u003e KosongStep\n    Tools --\u003e KosongStep\n    KosongStep --\u003e ChatProvider\n    ChatProvider --\u003e API\n    \n    API --\u003e ChatProvider\n    ChatProvider --\u003e KosongStep\n    KosongStep --\u003e Response[\"Response\u003cbr/\u003e(text + tool_calls)\"]\n```\n\nThe `kosong.step()` function:\n1. Takes the conversation context and available tools\n2. Calls the LLM via the `ChatProvider`\n3. Returns the LLM response including any tool calls\n4. Handles streaming token delivery\n\n**Sources:** [src/kimi_cli/utils/provider.py:1-4](), [src/kimi_cli/llm.py:3-4]()\n\n---\n\n## Configuration Loading and Validation\n\nConfiguration is loaded and validated through a structured process that ensures consistency and security.\n\n### Loading Flow\n\n```mermaid\nflowchart TD\n    Start([Application Start])\n    GetPath[\"get_config_file()\"]\n    CheckExists{Config file\u003cbr/\u003eexists?}\n    \n    LoadFile[\"Load config.json\"]\n    ParseJSON[\"Parse JSON\"]\n    CreateConfig[\"Create Config object\"]\n    Validate[\"validate_model()\"]\n    \n    CreateDefault[\"get_default_config()\"]\n    SaveFile[\"Save to config.json\"]\n    \n    Return([Return Config])\n    Error([Raise ConfigError])\n    \n    Start --\u003e GetPath\n    GetPath --\u003e CheckExists\n    \n    CheckExists --\u003e|No| CreateDefault\n    CreateDefault --\u003e SaveFile\n    SaveFile --\u003e Return\n    \n    CheckExists --\u003e|Yes| LoadFile\n    LoadFile --\u003e ParseJSON\n    ParseJSON --\u003e CreateConfig\n    CreateConfig --\u003e Validate\n    \n    Validate --\u003e|Valid| Return\n    Validate --\u003e|Invalid| Error\n    ParseJSON --\u003e|Error| Error\n```\n\n**Sources:** [src/kimi_cli/config.py:87-124]()\n\n### Validation Rules\n\nThe `Config.validate_model()` method enforces referential integrity [src/kimi_cli/config.py:77-84]():\n\n1. **Default Model Validation**: If `default_model` is set, it must exist in `models` dictionary\n2. **Provider Reference Validation**: Each model's `provider` field must reference a valid entry in `providers` dictionary\n\nViolations raise a `ValueError` with a descriptive message.\n\n**Sources:** [src/kimi_cli/config.py:77-84]()\n\n### Configuration File Location\n\nConfiguration is stored in a platform-specific share directory:\n\n- The path is determined by `get_share_dir()` from the `kimi_cli.share` module\n- Configuration file name: `config.json`\n- Location obtained via `get_config_file()` [src/kimi_cli/config.py:87-89]()\n\n**Sources:** [src/kimi_cli/config.py:87-89]()\n\n---\n\n## Special Considerations\n\n### API Key Security\n\nAPI keys are stored using Pydantic's `SecretStr` type, which:\n- Prevents accidental logging in error messages\n- Masks values in string representations\n- Requires explicit `get_secret_value()` call to access [src/kimi_cli/config.py:18-19]()\n- Serializes to plain text only when explicitly dumped to JSON [src/kimi_cli/config.py:21-23]()\n\n### Session-Based Prompt Caching\n\nFor Kimi providers, prompt caching is enabled by passing a `session_id` to `create_llm()`:\n\n- The session ID is used as `prompt_cache_key` in generation kwargs [src/kimi_cli/utils/provider.py:50-51]()\n- This allows the LLM provider to cache and reuse prompt prefixes across requests\n- Significantly reduces latency and token costs for multi-turn conversations\n\n### Provider Extensibility\n\nAdding a new provider type requires:\n\n1. Adding the type literal to `LLMProvider.type` [src/kimi_cli/config.py:14]()\n2. Implementing the provider case in `create_llm()` [src/kimi_cli/utils/provider.py:39-72]()\n3. Optionally adding environment variable handling in `augment_provider_with_env_vars()` [src/kimi_cli/utils/provider.py:12-30]()\n\nThe `kosong` library handles the actual LLM communication protocol.\n\n**Sources:** [src/kimi_cli/config.py:14](), [src/kimi_cli/utils/provider.py:12-73]()\n\n---\n\n## External Service Integration\n\nIn addition to LLM providers, the configuration system supports external services that tools may use.\n\n### Moonshot Search Integration\n\nThe `SearchWeb` tool uses Moonshot Search API configuration from `Config.services` [src/kimi_cli/tools/web/search.py:42-49]():\n\n```python\ndef __init__(self, config: Config, **kwargs):\n    super().__init__(**kwargs)\n    if config.services.moonshot_search is not None:\n        self._base_url = config.services.moonshot_search.base_url\n        self._api_key = config.services.moonshot_search.api_key.get_secret_value()\n```\n\nThis demonstrates how the configuration system supports both LLM providers and auxiliary services through the same `Config` object.\n\n**Sources:** [src/kimi_cli/tools/web/search.py:42-49](), [src/kimi_cli/config.py:46-64]()"])</script><script>self.__next_f.push([1,"1c:T4855,"])</script><script>self.__next_f.push([1,"# Communication Layer\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/approval.py](src/kimi_cli/soul/approval.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/soul/wire.py](src/kimi_cli/soul/wire.py)\n- [src/kimi_cli/tools/bash/__init__.py](src/kimi_cli/tools/bash/__init__.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [src/kimi_cli/ui/shell/console.py](src/kimi_cli/ui/shell/console.py)\n- [src/kimi_cli/ui/shell/keyboard.py](src/kimi_cli/ui/shell/keyboard.py)\n- [src/kimi_cli/ui/shell/liveview.py](src/kimi_cli/ui/shell/liveview.py)\n- [src/kimi_cli/ui/shell/visualize.py](src/kimi_cli/ui/shell/visualize.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe Communication Layer provides the foundational infrastructure for inter-component communication within kimi-cli. This layer implements an event streaming system (`Wire`) that connects the agent execution engine (`KimiSoul`) with user interface components, and an approval system (`Approval`) that manages user consent for potentially dangerous operations.\n\nThis document covers the wire event system, approval request mechanisms, and communication patterns. For details on how the agent execution engine uses these systems, see [Agent System](#3.2). For UI-specific event handling, see [User Interfaces](#4). For the approval workflow in specific contexts, see [Approval System](#7.2).\n\n## Wire System Architecture\n\nThe `Wire` class [src/kimi_cli/soul/wire.py:95-116]() serves as an asynchronous message queue that enables decoupled communication between the agent execution layer and user interface layer. All events, from LLM message parts to tool results to approval requests, flow through this single channel.\n\n### Core Wire Implementation\n\n```mermaid\ngraph TB\n    subgraph \"Producer: KimiSoul\"\n        KimiSoul[\"KimiSoul._agent_loop\"]\n        StepLogic[\"KimiSoul._step\"]\n        ApprovalPipe[\"_pipe_approval_to_wire\"]\n    end\n    \n    subgraph \"Wire Infrastructure\"\n        Wire[\"Wire\u003cbr/\u003easyncio.Queue\"]\n        CurrentWire[\"current_wire\u003cbr/\u003eContextVar\"]\n    end\n    \n    subgraph \"Consumers: UI Layer\"\n        ShellLoop[\"shell_app.ui_loop\"]\n        PrintLoop[\"print_app.ui_loop\"]\n        ACPLoop[\"acp_server.ui_loop\"]\n    end\n    \n    subgraph \"Side Channel: Approval\"\n        ApprovalQueue[\"Approval._request_queue\"]\n        ToolCall[\"Tool.__call__\"]\n    end\n    \n    KimiSoul --\u003e|\"send(Event)\"| Wire\n    StepLogic --\u003e|\"send(Event)\"| Wire\n    ApprovalPipe --\u003e|\"fetch + send\"| ApprovalQueue\n    ApprovalQueue --\u003e|\"ApprovalRequest\"| Wire\n    ToolCall --\u003e|\"request()\"| ApprovalQueue\n    \n    Wire --\u003e|\"receive()\"| ShellLoop\n    Wire --\u003e|\"receive()\"| PrintLoop\n    Wire --\u003e|\"receive()\"| ACPLoop\n    \n    CurrentWire -.-\u003e|\"get()\"| StepLogic\n    KimiSoul --\u003e|\"set/reset\"| CurrentWire\n```\n\n**Sources:** [src/kimi_cli/soul/wire.py:95-127](), [src/kimi_cli/soul/kimisoul.py:99-111](), [src/kimi_cli/ui/__init__.py:18-70]()\n\nThe `Wire` instance is created in the `run_soul` function [src/kimi_cli/ui/__init__.py:36]() and passed to both the agent execution task and the UI visualization task. The agent sets the wire as a context variable [src/kimi_cli/soul/kimisoul.py:106]() so that nested code can access it without explicit parameter passing.\n\n### Wire Lifecycle\n\n```mermaid\nsequenceDiagram\n    participant UI as UI Layer\n    participant RunSoul as run_soul\n    participant Wire as Wire Instance\n    participant Soul as KimiSoul\n    participant CtxVar as current_wire\n    \n    UI-\u003e\u003eRunSoul: run_soul(soul, input, ui_loop, cancel)\n    RunSoul-\u003e\u003eWire: Wire()\n    RunSoul-\u003e\u003eRunSoul: ui_task = create_task(ui_loop(wire))\n    RunSoul-\u003e\u003eRunSoul: soul_task = create_task(soul.run(input, wire))\n    \n    activate Soul\n    Soul-\u003e\u003eCtxVar: current_wire.set(wire)\n    Note over Soul: Agent loop executes\n    Soul-\u003e\u003eWire: send(StepBegin)\n    Soul-\u003e\u003eWire: send(ContentPart)\n    Soul-\u003e\u003eWire: send(ToolCall)\n    Soul-\u003e\u003eWire: send(ToolResult)\n    Soul-\u003e\u003eCtxVar: current_wire.reset(token)\n    deactivate Soul\n    \n    activate UI\n    loop UI Loop\n        UI-\u003e\u003eWire: msg = receive()\n        UI-\u003e\u003eUI: handle(msg)\n    end\n    deactivate UI\n    \n    RunSoul-\u003e\u003eWire: shutdown()\n    Note over RunSoul: Tasks complete or cancelled\n```\n\n**Sources:** [src/kimi_cli/ui/__init__.py:36-70](), [src/kimi_cli/soul/kimisoul.py:99-110]()\n\n## Event Types and Structure\n\nThe wire carries multiple event types organized into a type hierarchy. All wire messages conform to the `WireMessage` type [src/kimi_cli/soul/wire.py:92]().\n\n### Event Type Hierarchy\n\n```mermaid\ngraph TB\n    WireMessage[\"WireMessage\u003cbr/\u003e(type union)\"]\n    \n    subgraph \"Control Flow Events\"\n        StepBegin[\"StepBegin(n: int)\"]\n        StepInterrupted[\"StepInterrupted\"]\n        CompactionBegin[\"CompactionBegin\"]\n        CompactionEnd[\"CompactionEnd\"]\n        StatusUpdate[\"StatusUpdate(status)\"]\n    end\n    \n    subgraph \"LLM Stream Events\"\n        ContentPart[\"ContentPart\u003cbr/\u003e(from kosong)\"]\n        ToolCallPart[\"ToolCallPart\u003cbr/\u003e(from kosong)\"]\n        ToolCall[\"ToolCall\u003cbr/\u003e(from kosong)\"]\n    end\n    \n    subgraph \"Tool Execution Events\"\n        ToolResult[\"ToolResult\u003cbr/\u003e(from kosong)\"]\n    end\n    \n    subgraph \"Approval Events\"\n        ApprovalRequest[\"ApprovalRequest\"]\n    end\n    \n    WireMessage --\u003e StepBegin\n    WireMessage --\u003e StepInterrupted\n    WireMessage --\u003e CompactionBegin\n    WireMessage --\u003e CompactionEnd\n    WireMessage --\u003e StatusUpdate\n    WireMessage --\u003e ContentPart\n    WireMessage --\u003e ToolCallPart\n    WireMessage --\u003e ToolCall\n    WireMessage --\u003e ToolResult\n    WireMessage --\u003e ApprovalRequest\n```\n\n**Sources:** [src/kimi_cli/soul/wire.py:14-92]()\n\n### Event Definitions\n\n| Event Type | Purpose | Key Fields | Sender |\n|------------|---------|------------|--------|\n| `StepBegin` | Marks the start of an agent loop iteration | `n: int` (step number) | `KimiSoul._agent_loop` |\n| `StepInterrupted` | Indicates the step was cancelled or errored | None | `KimiSoul._agent_loop` |\n| `CompactionBegin` | Context compaction is starting | None | `KimiSoul._agent_loop` |\n| `CompactionEnd` | Context compaction completed | None | `KimiSoul._agent_loop` |\n| `StatusUpdate` | Agent status changed | `status: StatusSnapshot` | `KimiSoul._step` |\n| `ContentPart` | Streaming LLM response token | `text: str` | `kosong.step` (via wire) |\n| `ToolCallPart` | Streaming tool call argument | `function.arguments: str` | `kosong.step` (via wire) |\n| `ToolCall` | Complete tool call received | `id, function` | `kosong.step` (via wire) |\n| `ToolResult` | Tool execution completed | `tool_call_id, content` | `kosong.step` (via wire) |\n| `ApprovalRequest` | Tool requesting user approval | `id, sender, action, description` | Tools via `Approval` |\n\n**Sources:** [src/kimi_cli/soul/wire.py:14-92](), [src/kimi_cli/soul/kimisoul.py:123-192]()\n\n### Event Flow Pattern\n\nControl flow events structure the agent execution timeline, with LLM stream events and tool execution events occurring within each step:\n\n```mermaid\nsequenceDiagram\n    participant Wire\n    participant UI\n    \n    Note over Wire: Step 1\n    Wire-\u003e\u003eUI: StepBegin(1)\n    \n    alt Context needs compaction\n        Wire-\u003e\u003eUI: CompactionBegin\n        Note over Wire: Compaction occurs\n        Wire-\u003e\u003eUI: CompactionEnd\n    end\n    \n    Wire-\u003e\u003eUI: ContentPart(\"text\")\n    Wire-\u003e\u003eUI: ContentPart(\"more\")\n    Wire-\u003e\u003eUI: ToolCallPart(args)\n    Wire-\u003e\u003eUI: ToolCall(complete)\n    Wire-\u003e\u003eUI: StatusUpdate(status)\n    \n    opt Tool needs approval\n        Wire-\u003e\u003eUI: ApprovalRequest\n        UI--\u003e\u003eWire: ApprovalResponse (via resolve())\n    end\n    \n    Wire-\u003e\u003eUI: ToolResult(result)\n    \n    alt More steps needed\n        Note over Wire: Step 2\n        Wire-\u003e\u003eUI: StepBegin(2)\n    else Interrupted or complete\n        Wire-\u003e\u003eUI: StepInterrupted or nothing\n    end\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:112-162](), [src/kimi_cli/soul/wire.py:14-46]()\n\n## Approval Mechanism\n\nThe `Approval` class [src/kimi_cli/soul/approval.py:8-71]() provides a request-response mechanism for tools to obtain user consent before executing potentially dangerous operations. Unlike other wire messages, approval requests use a future-based response mechanism.\n\n### Approval Request Flow\n\n```mermaid\ngraph TB\n    subgraph \"Tool Execution Context\"\n        ToolImpl[\"Tool.__call__\"]\n        GetToolCall[\"get_current_tool_call_or_none()\"]\n        RequestApproval[\"approval.request()\"]\n    end\n    \n    subgraph \"Approval Queue\"\n        Queue[\"Approval._request_queue\"]\n        Request[\"ApprovalRequest\u003cbr/\u003e+ Future\"]\n    end\n    \n    subgraph \"Agent Loop\"\n        PipeTask[\"_pipe_approval_to_wire task\"]\n        FetchRequest[\"approval.fetch_request()\"]\n    end\n    \n    subgraph \"Wire\"\n        WireQueue[\"Wire._queue\"]\n    end\n    \n    subgraph \"UI Layer\"\n        UIReceive[\"UI.receive()\"]\n        UserDecision[\"User Decision\"]\n        Resolve[\"request.resolve()\"]\n    end\n    \n    ToolImpl --\u003e GetToolCall\n    GetToolCall --\u003e|\"ToolCall context\"| RequestApproval\n    RequestApproval --\u003e|\"Check yolo/auto_approve\"| RequestApproval\n    RequestApproval --\u003e|\"Create + queue\"| Queue\n    RequestApproval --\u003e|\"await\"| Request\n    \n    PipeTask --\u003e|\"fetch()\"| Queue\n    Queue --\u003e FetchRequest\n    FetchRequest --\u003e|\"ApprovalRequest\"| WireQueue\n    \n    UIReceive --\u003e|\"receive()\"| WireQueue\n    WireQueue --\u003e UIReceive\n    UIReceive --\u003e UserDecision\n    UserDecision --\u003e Resolve\n    Resolve --\u003e|\"set_result()\"| Request\n    Request -.-\u003e|\"Future completes\"| RequestApproval\n```\n\n**Sources:** [src/kimi_cli/soul/approval.py:8-71](), [src/kimi_cli/soul/kimisoul.py:116-154]()\n\n### Approval Request Structure\n\nThe `ApprovalRequest` class [src/kimi_cli/soul/wire.py:55-90]() contains:\n\n```python\nclass ApprovalRequest:\n    id: str                    # UUID for tracking\n    tool_call_id: str          # Links to LLM tool call\n    sender: str                # Tool name\n    action: str                # Action identifier (for auto-approval)\n    description: str           # Human-readable description\n    _future: asyncio.Future    # Response mechanism\n```\n\n**Sources:** [src/kimi_cli/soul/wire.py:55-90]()\n\n### Approval Response Types\n\n```mermaid\ngraph LR\n    User[\"User Decision\"]\n    \n    User --\u003e|\"Approve once\"| Approve[\"ApprovalResponse.APPROVE\"]\n    User --\u003e|\"Approve for session\"| ApproveSession[\"ApprovalResponse.APPROVE_FOR_SESSION\"]\n    User --\u003e|\"Reject\"| Reject[\"ApprovalResponse.REJECT\"]\n    \n    Approve --\u003e|\"Tool continues\"| Execute[\"Tool Execution\"]\n    ApproveSession --\u003e|\"Add to auto_approve_actions\"| AutoApprove[\"Auto-approve future\"]\n    ApproveSession --\u003e|\"Tool continues\"| Execute\n    Reject --\u003e|\"Tool returns error\"| ToolRejected[\"ToolRejectedError\"]\n    \n    AutoApprove -.-\u003e|\"Next time\"| Execute\n```\n\n**Sources:** [src/kimi_cli/soul/wire.py:49-53](), [src/kimi_cli/soul/approval.py:48-64]()\n\n### Tool Approval Example\n\nThe `Bash` tool demonstrates the approval pattern [src/kimi_cli/tools/bash/__init__.py:32-45]():\n\n```python\nasync def __call__(self, params: Params) -\u003e ToolReturnType:\n    if not await self._approval.request(\n        self.name,                      # sender: \"Bash\"\n        \"run shell command\",            # action: for auto-approval\n        f\"Run command `{params.command}`\",  # description: shown to user\n    ):\n        return ToolRejectedError()\n    \n    # Continue with actual execution...\n```\n\nThe `Approval.request()` method [src/kimi_cli/soul/approval.py:18-64]():\n\n1. Checks if running in \"yolo\" mode  auto-approve\n2. Checks if action is in `_auto_approve_actions` set  auto-approve\n3. Creates `ApprovalRequest` and queues it\n4. Awaits the future until UI calls `request.resolve()`\n5. Returns boolean based on response type\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:32-46](), [src/kimi_cli/soul/approval.py:18-64]()\n\n## Wire Usage Patterns\n\n### Producer Pattern: KimiSoul\n\nThe agent execution engine produces events through three mechanisms:\n\n1. **Direct wire send** for control flow events [src/kimi_cli/soul/kimisoul.py:123,136-138,150,192]():\n   ```python\n   wire.send(StepBegin(step_no))\n   wire.send(CompactionBegin())\n   wire.send(CompactionEnd())\n   wire.send(StatusUpdate(status=self.status))\n   wire.send(StepInterrupted())\n   ```\n\n2. **LLM streaming callbacks** [src/kimi_cli/soul/kimisoul.py:183-184]():\n   ```python\n   result = await kosong.step(\n       chat_provider,\n       self._agent.system_prompt,\n       self._agent.toolset,\n       self._context.history,\n       on_message_part=wire.send,      # Streams ContentPart\n       on_tool_result=wire.send,       # Sends ToolResult\n   )\n   ```\n\n3. **Approval piping task** [src/kimi_cli/soul/kimisoul.py:116-119,124,154]():\n   ```python\n   async def _pipe_approval_to_wire():\n       while True:\n           request = await self._approval.fetch_request()\n           wire.send(request)\n   \n   approval_task = asyncio.create_task(_pipe_approval_to_wire())\n   # ... later ...\n   approval_task.cancel()  # Stop piping after step completes\n   ```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:112-162,176-192]()\n\n### Consumer Pattern: UI Loop\n\nUI implementations follow a consistent receive-and-handle pattern [src/kimi_cli/ui/__init__.py:36-70]():\n\n```python\nasync def ui_loop_fn(wire: Wire):\n    \"\"\"UI loop that processes wire events.\"\"\"\n    while True:\n        try:\n            msg = await wire.receive()\n            # Handle different message types\n            match msg:\n                case StepBegin(n):\n                    # Update UI for new step\n                case ApprovalRequest() as req:\n                    # Prompt user and resolve\n                    response = get_user_decision()\n                    req.resolve(response)\n                case ContentPart():\n                    # Display streaming text\n                # ... handle other events\n        except Exception:\n            break  # Wire shutdown\n```\n\nThe `run_soul` function orchestrates the parallel execution [src/kimi_cli/ui/__init__.py:36-70]():\n\n1. Creates `Wire` instance\n2. Launches UI loop task with wire\n3. Launches soul.run task with wire\n4. Waits for completion or cancellation\n5. Shuts down wire and awaits UI loop completion\n\n**Sources:** [src/kimi_cli/ui/__init__.py:18-70]()\n\n## Context-Aware Communication\n\nThe Communication Layer uses Python's `contextvars` module to provide implicit wire access within the execution context, eliminating the need to pass the wire through every function call.\n\n### ContextVar Pattern\n\n```mermaid\ngraph TB\n    subgraph \"Execution Context\"\n        SoulRun[\"KimiSoul.run()\"]\n        SetWire[\"current_wire.set(wire)\"]\n        AgentLoop[\"_agent_loop()\"]\n        Step[\"_step()\"]\n        KosongStep[\"kosong.step()\"]\n    end\n    \n    subgraph \"ContextVar Storage\"\n        CtxVar[\"current_wire: ContextVar\"]\n    end\n    \n    subgraph \"Tool Context\"\n        ToolExecute[\"Tool.__call__()\"]\n        GetWire[\"get_wire_or_none()\"]\n        GetToolCall[\"get_current_tool_call_or_none()\"]\n    end\n    \n    SoulRun --\u003e|\"wire passed\"| SetWire\n    SetWire --\u003e|\"store\"| CtxVar\n    SoulRun --\u003e AgentLoop\n    AgentLoop --\u003e Step\n    Step --\u003e KosongStep\n    \n    KosongStep -.-\u003e|\"context propagates\"| ToolExecute\n    ToolExecute --\u003e GetWire\n    ToolExecute --\u003e GetToolCall\n    GetWire --\u003e|\"retrieve\"| CtxVar\n    \n    SoulRun --\u003e|\"finally block\"| ResetWire[\"current_wire.reset()\"]\n    ResetWire --\u003e|\"clear\"| CtxVar\n```\n\n**Sources:** [src/kimi_cli/soul/wire.py:118-126](), [src/kimi_cli/soul/kimisoul.py:106-110]()\n\n### Context Variable Implementation\n\nThe wire context variable is defined globally [src/kimi_cli/soul/wire.py:118]():\n\n```python\ncurrent_wire = ContextVar[Wire | None](\"current_wire\", default=None)\n\ndef get_wire_or_none() -\u003e Wire | None:\n    \"\"\"Get the current wire or None.\"\"\"\n    return current_wire.get()\n```\n\nThe `KimiSoul.run()` method manages the context lifecycle [src/kimi_cli/soul/kimisoul.py:106-110]():\n\n```python\nwire_token = current_wire.set(wire)\ntry:\n    await self._agent_loop(wire)\nfinally:\n    current_wire.reset(wire_token)\n```\n\nThis pattern ensures that:\n- The wire is available throughout the agent execution stack\n- Tool execution can access the wire without explicit passing\n- The context is properly cleaned up after execution\n- Nested contexts (e.g., subagents) can have their own wire instances\n\n**Sources:** [src/kimi_cli/soul/wire.py:118-126](), [src/kimi_cli/soul/kimisoul.py:106-110]()\n\n### Tool Context Access\n\nTools access the wire context indirectly through the approval system. The `Approval.request()` method uses `get_current_tool_call_or_none()` [src/kimi_cli/soul/approval.py:34-36]() to verify it's being called within a tool execution context:\n\n```python\ntool_call = get_current_tool_call_or_none()\nif tool_call is None:\n    raise RuntimeError(\"Approval must be requested from a tool call.\")\n```\n\nThis verification ensures approval requests are properly associated with their originating tool calls, maintaining the integrity of the approval flow even when tools are executed asynchronously.\n\n**Sources:** [src/kimi_cli/soul/approval.py:34-37](), [src/kimi_cli/soul/toolset.py]()\n\n## Wire Shutdown and Cleanup\n\nThe wire shutdown mechanism ensures graceful termination of the UI loop:\n\n```mermaid\nsequenceDiagram\n    participant RunSoul\n    participant SoulTask\n    participant Wire\n    participant UITask\n    \n    alt Normal completion\n        SoulTask-\u003e\u003eSoulTask: Execution completes\n        SoulTask--\u003e\u003eRunSoul: Done\n    else Cancellation\n        RunSoul-\u003e\u003eSoulTask: cancel()\n        SoulTask-\u003e\u003eSoulTask: CancelledError\n        SoulTask--\u003e\u003eRunSoul: Cancelled\n    end\n    \n    RunSoul-\u003e\u003eWire: shutdown()\n    Note over Wire: Queue closed\n    \n    UITask-\u003e\u003eWire: receive()\n    Wire--\u003e\u003eUITask: Raises exception\n    UITask-\u003e\u003eUITask: Break loop\n    UITask--\u003e\u003eRunSoul: Done\n    \n    alt Timeout\n        RunSoul-\u003e\u003eRunSoul: wait_for(ui_task, 0.5s)\n        RunSoul-\u003e\u003eRunSoul: Log warning\n    end\n```\n\n**Sources:** [src/kimi_cli/ui/__init__.py:63-70](), [src/kimi_cli/soul/wire.py:114-116]()\n\nThe `Wire.shutdown()` method [src/kimi_cli/soul/wire.py:114-116]() closes the internal asyncio queue, causing subsequent `receive()` calls to raise an exception, which breaks the UI loop. A timeout mechanism [src/kimi_cli/ui/__init__.py:67-69]() logs a warning if the UI loop doesn't terminate within 0.5 seconds.\n\n**Sources:** [src/kimi_cli/soul/wire.py:114-116](), [src/kimi_cli/ui/__init__.py:63-70]()"])</script><script>self.__next_f.push([1,"1d:T5280,"])</script><script>self.__next_f.push([1,"# User Interfaces\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/ui/print/__init__.py](src/kimi_cli/ui/print/__init__.py)\n- [src/kimi_cli/ui/shell/__init__.py](src/kimi_cli/ui/shell/__init__.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document provides an overview of the three user interface modes supported by kimi-cli: **Shell** (interactive), **Print** (automation), and **ACP** (protocol-based). It explains the architecture of the UI layer, how each mode integrates with the agent execution engine, and when to use each mode.\n\nFor detailed information about specific UI features:\n- Interactive shell features and keyboard shortcuts: see [Interactive Shell Mode](#4.1)\n- Meta commands (`/help`, `/init`, etc.): see [Meta Commands](#4.2)\n- Real-time visualization and display: see [Live View and Visualization](#4.3)\n- Non-interactive and protocol modes: see [Print and ACP Modes](#4.4)\n\nFor information about the underlying agent execution: see [Agent System](#3.2)\n\n## UI Mode Overview\n\nkimi-cli provides three distinct user interface modes, each designed for different use cases:\n\n| Mode | Class | Primary Use Case | Input Method | Output Style |\n|------|-------|------------------|--------------|--------------|\n| **Shell** | `ShellApp` | Interactive development | Prompt with history | Rich terminal UI with live updates |\n| **Print** | `PrintApp` | Automation \u0026 scripting | stdin or command argument | Plain text or stream-json |\n| **ACP** | `ACPAgentImpl` | Programmatic integration | Agent Client Protocol | Structured protocol messages |\n\nAll three modes share a common execution path through the `Soul` interface and communicate via the `Wire` event stream, ensuring consistent agent behavior regardless of UI choice.\n\n## UI Layer Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Entry Point\"\n        CLI[\"CLI Entry\u003cbr/\u003e(main function)\"]\n        Config[\"Configuration\u003cbr/\u003eSystem\"]\n    end\n    \n    subgraph \"UI Mode Selection\"\n        ShellApp[\"ShellApp\u003cbr/\u003esrc/kimi_cli/ui/shell/__init__.py\"]\n        PrintApp[\"PrintApp\u003cbr/\u003esrc/kimi_cli/ui/print/__init__.py\"]\n        ACPServer[\"ACPAgentImpl\u003cbr/\u003esrc/kimi_cli/ui/acp.py\"]\n    end\n    \n    subgraph \"Common UI Infrastructure\"\n        RunSoul[\"run_soul()\u003cbr/\u003esrc/kimi_cli/ui/__init__.py\"]\n        Wire[\"Wire\u003cbr/\u003eEvent Stream\u003cbr/\u003esrc/kimi_cli/soul/wire.py\"]\n        Visualize[\"Visualization\u003cbr/\u003eFunctions\"]\n    end\n    \n    subgraph \"Shell-Specific Components\"\n        PromptSession[\"CustomPromptSession\u003cbr/\u003esrc/kimi_cli/ui/shell/prompt.py\"]\n        MetaCmd[\"Meta Commands\u003cbr/\u003esrc/kimi_cli/ui/shell/metacmd.py\"]\n        LiveView[\"StepLiveView\u003cbr/\u003esrc/kimi_cli/ui/shell/visualize.py\"]\n        Console[\"Rich Console\u003cbr/\u003esrc/kimi_cli/ui/shell/console.py\"]\n    end\n    \n    subgraph \"Agent Execution Engine\"\n        Soul[\"Soul Interface\u003cbr/\u003esrc/kimi_cli/soul/__init__.py\"]\n        KimiSoul[\"KimiSoul\u003cbr/\u003eImplementation\"]\n    end\n    \n    CLI --\u003e Config\n    CLI --\u003e ShellApp\n    CLI --\u003e PrintApp\n    CLI --\u003e ACPServer\n    \n    ShellApp --\u003e PromptSession\n    ShellApp --\u003e MetaCmd\n    ShellApp --\u003e RunSoul\n    \n    PrintApp --\u003e RunSoul\n    ACPServer --\u003e RunSoul\n    \n    RunSoul --\u003e Wire\n    RunSoul --\u003e Soul\n    \n    Wire --\u003e Visualize\n    ShellApp --\u003e LiveView\n    LiveView --\u003e Console\n    \n    Soul --\u003e KimiSoul\n    \n    style ShellApp fill:#f9f9f9\n    style PrintApp fill:#f9f9f9\n    style ACPServer fill:#f9f9f9\n    style Wire fill:#f0f0f0\n```\n\n**Diagram: UI Layer Component Architecture**\n\nThe diagram shows how the three UI modes connect to the common execution infrastructure. All modes ultimately call `run_soul()` which manages the `Soul` execution and `Wire` event stream. Each mode provides its own visualization and interaction layer on top of this common foundation.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:1-285](), [src/kimi_cli/ui/print/__init__.py:1-178]()\n\n## UI Mode Selection and Initialization\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant CLI as \"CLI Entry Point\"\n    participant Config\n    participant UIFactory as \"UI Factory Logic\"\n    participant ShellApp\n    participant PrintApp\n    participant ACPServer\n    participant Soul\n    \n    User-\u003e\u003eCLI: \"kimi [options] [command]\"\n    CLI-\u003e\u003eConfig: \"load_config()\"\n    Config--\u003e\u003eCLI: \"Config object\"\n    CLI-\u003e\u003eConfig: \"load_agent(agent_name)\"\n    Config--\u003e\u003eCLI: \"Agent specification\"\n    CLI-\u003e\u003eSoul: \"create Soul instance\"\n    \n    alt Shell Mode (default)\n        CLI-\u003e\u003eUIFactory: \"check --shell or no special flags\"\n        UIFactory-\u003e\u003eShellApp: \"ShellApp(soul, welcome_info)\"\n        ShellApp--\u003e\u003eCLI: \"app instance\"\n        CLI-\u003e\u003eShellApp: \"await app.run(command)\"\n        ShellApp-\u003e\u003eUser: \"Interactive session\"\n    else Print Mode\n        CLI-\u003e\u003eUIFactory: \"check --print flag\"\n        UIFactory-\u003e\u003ePrintApp: \"PrintApp(soul, input_fmt, output_fmt)\"\n        PrintApp--\u003e\u003eCLI: \"app instance\"\n        CLI-\u003e\u003ePrintApp: \"await app.run(command)\"\n        PrintApp-\u003e\u003eUser: \"Text/JSON output\"\n    else ACP Mode\n        CLI-\u003e\u003eUIFactory: \"check --acp flag\"\n        UIFactory-\u003e\u003eACPServer: \"ACPAgentImpl(soul)\"\n        ACPServer--\u003e\u003eCLI: \"server instance\"\n        CLI-\u003e\u003eACPServer: \"await server.serve()\"\n        ACPServer-\u003e\u003eUser: \"Protocol messages\"\n    end\n```\n\n**Diagram: UI Mode Selection Sequence**\n\nThe CLI entry point determines which UI mode to instantiate based on command-line flags. Each mode is initialized with a `Soul` instance and mode-specific configuration.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:30-36](), [src/kimi_cli/ui/print/__init__.py:23-38]()\n\n## Shell Mode (Interactive)\n\nThe `ShellApp` class provides a full-featured interactive terminal interface for working with agents.\n\n### Key Components\n\n| Component | File Path | Purpose |\n|-----------|-----------|---------|\n| `ShellApp` | [src/kimi_cli/ui/shell/__init__.py:30-228]() | Main application orchestrator |\n| `CustomPromptSession` | [src/kimi_cli/ui/shell/prompt.py]() | Input handling with history and modes |\n| `visualize()` | [src/kimi_cli/ui/shell/visualize.py]() | Live view of agent execution |\n| `get_meta_command()` | [src/kimi_cli/ui/shell/metacmd.py]() | Meta command dispatcher |\n| `console` | [src/kimi_cli/ui/shell/console.py]() | Rich console output |\n\n### Execution Flow\n\n```mermaid\nflowchart TD\n    Start[\"ShellApp.run()\"] --\u003e InitPrompt[\"Initialize CustomPromptSession\"]\n    InitPrompt --\u003e WelcomeInfo[\"Display welcome panel\"]\n    WelcomeInfo --\u003e AutoUpdate[\"Start auto-update background task\"]\n    AutoUpdate --\u003e PromptLoop[\"Prompt loop\"]\n    \n    PromptLoop --\u003e GetInput[\"await prompt_session.prompt()\"]\n    GetInput --\u003e CheckEmpty{\"Empty input?\"}\n    CheckEmpty --\u003e|Yes| PromptLoop\n    CheckEmpty --\u003e|No| CheckExit{\"exit/quit?\"}\n    \n    CheckExit --\u003e|Yes| Goodbye[\"Print 'Bye!'\"]\n    Goodbye --\u003e End[\"Return True\"]\n    \n    CheckExit --\u003e|No| CheckMode{\"Input mode?\"}\n    \n    CheckMode --\u003e|Shell| RunShell[\"_run_shell_command()\"]\n    RunShell --\u003e PromptLoop\n    \n    CheckMode --\u003e|Normal| CheckMeta{\"Starts with '/'?\"}\n    CheckMeta --\u003e|Yes| RunMeta[\"_run_meta_command()\"]\n    RunMeta --\u003e PromptLoop\n    \n    CheckMeta --\u003e|No| RunSoul[\"_run_soul_command()\"]\n    RunSoul --\u003e PromptLoop\n    \n    style ShellApp.run fill:#f9f9f9\n    style RunSoul fill:#f0f0f0\n```\n\n**Diagram: ShellApp Main Loop**\n\nThe shell app runs a continuous prompt loop that handles three types of input: shell commands (prefixed with `$`), meta commands (prefixed with `/`), and normal agent commands.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:36-82]()\n\n### Shell Command Execution\n\nThe shell mode supports direct shell command execution when input is prefixed with `$`:\n\n```python\n# From src/kimi_cli/ui/shell/__init__.py:84-107\nasync def _run_shell_command(self, command: str) -\u003e None:\n    \"\"\"Run a shell command in foreground.\"\"\"\n    proc = await asyncio.create_subprocess_shell(command)\n    # Signal handler for interruption\n    loop.add_signal_handler(signal.SIGINT, _handler)\n    await proc.wait()\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:84-107]()\n\n### Meta Command Execution\n\nMeta commands provide special shell-level functionality:\n\n```python\n# From src/kimi_cli/ui/shell/__init__.py:109-144\nasync def _run_meta_command(self, command_str: str):\n    parts = command_str.split(\" \")\n    command_name = parts[0]\n    command_args = parts[1:]\n    command = get_meta_command(command_name)\n    # Execute with appropriate error handling\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:109-144]()\n\n### Welcome Display\n\nThe shell displays a branded welcome panel on startup:\n\n```python\n# From src/kimi_cli/ui/shell/__init__.py:239-284\ndef _print_welcome_info(name: str, model: str, info_items: dict[str, str]) -\u003e None:\n    # Creates Rich panel with logo, help text, model info\n    # Displays version update notifications if available\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:239-284]()\n\n## Print Mode (Automation)\n\nThe `PrintApp` class is designed for non-interactive use cases where kimi-cli is part of an automation pipeline or script.\n\n### Key Features\n\n- **No TTY required**: Reads from stdin or command argument\n- **Auto-approval**: Automatically approves all tool executions (yolo mode)\n- **Multiple formats**: Supports plain text or streaming JSON\n- **Deterministic**: No interactive prompts or user intervention\n\n### Initialization\n\n```python\n# From src/kimi_cli/ui/print/__init__.py:33-38\ndef __init__(self, soul: KimiSoul, input_format: InputFormat, output_format: OutputFormat):\n    self.soul = soul\n    self.input_format = input_format\n    self.output_format = output_format\n    self.soul._approval.set_yolo(True)  # Auto-approve all tools\n```\n\nSources: [src/kimi_cli/ui/print/__init__.py:33-38]()\n\n### Input Formats\n\n| Format | Description | Usage |\n|--------|-------------|-------|\n| `text` | Plain text command | Single command from CLI argument or stdin |\n| `stream-json` | JSON message stream | Multiple `Message` objects, one per line |\n\n### Output Formats\n\n| Format | Description | Usage |\n|--------|-------------|-------|\n| `text` | Simple text output | Human-readable, line-by-line events |\n| `stream-json` | Streaming JSON | Machine-readable context file updates |\n\n### Execution Flow\n\n```mermaid\nflowchart TD\n    Start[\"PrintApp.run()\"] --\u003e SetupCancel[\"Setup cancel event handler\"]\n    SetupCancel --\u003e CheckCommand{\"command provided?\"}\n    \n    CheckCommand --\u003e|No| CheckStdin{\"stdin available?\"}\n    CheckStdin --\u003e|Yes + text format| ReadStdin[\"Read from stdin\"]\n    CheckStdin --\u003e|No + stream-json| ReadLoop[\"Enter read loop\"]\n    \n    CheckCommand --\u003e|Yes| HasCommand[\"Use provided command\"]\n    ReadStdin --\u003e HasCommand\n    \n    HasCommand --\u003e SelectVis{\"output_format?\"}\n    SelectVis --\u003e|text| TextVis[\"_visualize_text()\"]\n    SelectVis --\u003e|stream-json| JSONVis[\"_visualize_stream_json()\"]\n    \n    TextVis --\u003e RunSoul[\"run_soul()\"]\n    JSONVis --\u003e RunSoul\n    \n    RunSoul --\u003e CheckMore{\"stream-json mode?\"}\n    CheckMore --\u003e|Yes| ReadLoop\n    CheckMore --\u003e|No| End[\"Return\"]\n    \n    ReadLoop --\u003e ReadNextCmd[\"_read_next_command()\"]\n    ReadNextCmd --\u003e EOF{\"EOF?\"}\n    EOF --\u003e|Yes| End\n    EOF --\u003e|No| SelectVis\n    \n    style PrintApp.run fill:#f9f9f9\n    style RunSoul fill:#f0f0f0\n```\n\n**Diagram: PrintApp Execution Flow**\n\nThe print app handles both single-command and streaming modes. In streaming mode, it continuously reads JSON messages from stdin until EOF.\n\nSources: [src/kimi_cli/ui/print/__init__.py:40-96]()\n\n### Stream-JSON Mode\n\nIn stream-json mode, the print app reads user messages from stdin and writes context updates to stdout:\n\n```python\n# From src/kimi_cli/ui/print/__init__.py:122-145\ndef _read_next_command(self) -\u003e str | None:\n    while True:\n        json_line = sys.stdin.readline()\n        if not json_line:\n            return None  # EOF\n        data = json.loads(json_line)\n        message = Message.model_validate(data)\n        if message.role == \"user\":\n            return message_extract_text(message)\n```\n\nThe visualization function tails the context file and streams updates:\n\n```python\n# From src/kimi_cli/ui/print/__init__.py:157-177\nasync def _visualize_stream_json(self, wire: Wire, start_position: int):\n    async with aiofiles.open(self.soul._context._file_backend, encoding=\"utf-8\") as f:\n        await f.seek(start_position)\n        while True:\n            line = await f.readline()\n            if line:\n                print(line, end=\"\")\n```\n\nSources: [src/kimi_cli/ui/print/__init__.py:122-177]()\n\n## Common Execution Path\n\nAll UI modes converge on the `run_soul()` function, which manages the agent execution lifecycle:\n\n```mermaid\nsequenceDiagram\n    participant UI as \"UI Mode (Shell/Print/ACP)\"\n    participant RunSoul as \"run_soul()\"\n    participant Wire as \"Wire\"\n    participant VisFn as \"Visualization Function\"\n    participant Soul as \"Soul\"\n    participant Cancel as \"Cancel Event\"\n    \n    UI-\u003e\u003eRunSoul: \"run_soul(soul, command, vis_fn, cancel_event)\"\n    RunSoul-\u003e\u003eWire: \"Create Wire instance\"\n    RunSoul-\u003e\u003eVisFn: \"asyncio.create_task(vis_fn(wire))\"\n    \n    par Agent Execution\n        RunSoul-\u003e\u003eSoul: \"await soul.run(command, wire)\"\n        Soul--\u003e\u003eWire: \"Send events (StepBegin, ToolCall, etc.)\"\n    and Visualization\n        VisFn-\u003e\u003eWire: \"await wire.receive()\"\n        Wire--\u003e\u003eVisFn: \"Event\"\n        VisFn-\u003e\u003eUI: \"Display to user\"\n    and Cancellation Monitor\n        RunSoul-\u003e\u003eCancel: \"Monitor cancel_event\"\n        alt User cancels\n            Cancel--\u003e\u003eRunSoul: \"Event set\"\n            RunSoul-\u003e\u003eSoul: \"Interrupt\"\n        end\n    end\n    \n    Soul--\u003e\u003eRunSoul: \"Execution complete\"\n    RunSoul-\u003e\u003eWire: \"wire.shutdown()\"\n    Wire--\u003e\u003eVisFn: \"QueueShutDown exception\"\n    VisFn--\u003e\u003eRunSoul: \"Task complete\"\n    RunSoul--\u003e\u003eUI: \"Return\"\n```\n\n**Diagram: Common run_soul() Execution Path**\n\nThe `run_soul()` function creates a `Wire` for event streaming, launches the visualization task, runs the soul, and handles cancellation. This pattern is shared across all UI modes.\n\nSources: [src/kimi_cli/ui/__init__.py]()\n\n## Wire Event Stream\n\nThe `Wire` class provides the communication channel between the agent execution engine and the UI layer:\n\n```mermaid\ngraph LR\n    subgraph \"Soul Execution\"\n        Soul[\"Soul.run()\"]\n        Events[\"Events:\u003cbr/\u003eStepBegin\u003cbr/\u003eStepEnd\u003cbr/\u003eToolCallBegin\u003cbr/\u003eToolCallEnd\u003cbr/\u003eApprovalRequest\u003cbr/\u003eStepInterrupted\"]\n    end\n    \n    subgraph \"Wire (Queue)\"\n        Queue[\"asyncio.Queue\"]\n        Send[\"wire.send(event)\"]\n        Receive[\"wire.receive()\"]\n        Shutdown[\"wire.shutdown()\"]\n    end\n    \n    subgraph \"UI Layer\"\n        Visualize[\"Visualization\u003cbr/\u003eFunctions\"]\n        Display[\"Display to\u003cbr/\u003eUser\"]\n    end\n    \n    Soul --\u003e Events\n    Events --\u003e Send\n    Send --\u003e Queue\n    Queue --\u003e Receive\n    Receive --\u003e Visualize\n    Visualize --\u003e Display\n    \n    Soul -.-\u003e|\"On complete\"| Shutdown\n    Shutdown -.-\u003e|\"QueueShutDown\"| Visualize\n    \n    style Wire fill:#f9f9f9\n```\n\n**Diagram: Wire Event Stream Architecture**\n\nThe `Wire` is an async queue that decouples event production (Soul) from event consumption (UI). The `shutdown()` method signals completion to the visualization layer.\n\nSources: [src/kimi_cli/soul/wire.py]()\n\n## Error Handling Patterns\n\nAll UI modes implement consistent error handling:\n\n```mermaid\nflowchart TD\n    Start[\"Execute command\"] --\u003e TryRun[\"try: run_soul()\"]\n    TryRun --\u003e Success[\"Success\"]\n    Success --\u003e End[\"Return True\"]\n    \n    TryRun --\u003e Errors{\"Exception Type\"}\n    \n    Errors --\u003e|LLMNotSet| NoLLM[\"Display: 'LLM not set'\"]\n    NoLLM --\u003e ReturnFalse[\"Return False\"]\n    \n    Errors --\u003e|ChatProviderError| ProviderErr[\"Check status code\"]\n    ProviderErr --\u003e Code401[\"401: Auth failed\"]\n    ProviderErr --\u003e Code402[\"402: Membership expired\"]\n    ProviderErr --\u003e Code403[\"403: Quota exceeded\"]\n    ProviderErr --\u003e CodeOther[\"Other: Generic error\"]\n    Code401 --\u003e ReturnFalse\n    Code402 --\u003e ReturnFalse\n    Code403 --\u003e ReturnFalse\n    CodeOther --\u003e ReturnFalse\n    \n    Errors --\u003e|MaxStepsReached| MaxSteps[\"Display: 'Max steps reached'\"]\n    MaxSteps --\u003e ReturnFalse\n    \n    Errors --\u003e|RunCancelled| Cancelled[\"Display: 'Interrupted by user'\"]\n    Cancelled --\u003e ReturnFalse\n    \n    Errors --\u003e|Reload| Propagate[\"Propagate to caller\"]\n    \n    Errors --\u003e|BaseException| Unknown[\"Log and re-raise\"]\n    Unknown --\u003e Crash[\"Application terminates\"]\n    \n    style TryRun fill:#f0f0f0\n```\n\n**Diagram: Common Error Handling Flow**\n\nAll UI modes handle the same set of expected exceptions with appropriate user messages. The `Reload` exception is propagated to allow configuration reload. Unknown exceptions are re-raised after logging.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:146-198](), [src/kimi_cli/ui/print/__init__.py:54-96]()\n\n## UI Mode Comparison\n\n```mermaid\ngraph TB\n    subgraph \"ShellApp Features\"\n        S1[\"Interactive prompt with history\"]\n        S2[\"Rich terminal UI\"]\n        S3[\"Meta commands\"]\n        S4[\"Live visualization\"]\n        S5[\"Approval prompts\"]\n        S6[\"Auto-update notifications\"]\n        S7[\"Shell command support\"]\n    end\n    \n    subgraph \"PrintApp Features\"\n        P1[\"Stdin/stdout interface\"]\n        P2[\"Plain text output\"]\n        P3[\"Stream-JSON format\"]\n        P4[\"Auto-approval (yolo)\"]\n        P5[\"Scriptable\"]\n    end\n    \n    subgraph \"ACP Features\"\n        A1[\"Protocol-based\"]\n        A2[\"Structured messages\"]\n        A3[\"MCP compatible\"]\n        A4[\"Programmatic control\"]\n        A5[\"Server/client model\"]\n    end\n    \n    subgraph \"Common Infrastructure\"\n        C1[\"run_soul() execution\"]\n        C2[\"Wire event stream\"]\n        C3[\"Soul interface\"]\n        C4[\"Error handling\"]\n        C5[\"Signal handling\"]\n    end\n    \n    S1 -.-\u003e C1\n    S2 -.-\u003e C2\n    S3 -.-\u003e C1\n    S4 -.-\u003e C2\n    S5 -.-\u003e C2\n    \n    P1 -.-\u003e C1\n    P2 -.-\u003e C2\n    P3 -.-\u003e C2\n    P4 -.-\u003e C2\n    \n    A1 -.-\u003e C1\n    A2 -.-\u003e C2\n    A4 -.-\u003e C3\n    \n    style ShellApp fill:#f9f9f9\n    style PrintApp fill:#f9f9f9\n    style ACP fill:#f9f9f9\n    style Common fill:#f0f0f0\n```\n\n**Diagram: UI Mode Feature Comparison**\n\nEach UI mode provides mode-specific features while sharing common execution infrastructure. ShellApp is the richest for interactive use, PrintApp is optimized for automation, and ACP provides programmatic protocol-based access.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:1-285](), [src/kimi_cli/ui/print/__init__.py:1-178]()\n\n## Choosing a UI Mode\n\nUse the following decision matrix to select the appropriate UI mode:\n\n| Use Case | Recommended Mode | Reason |\n|----------|------------------|--------|\n| Development and experimentation | **Shell** | Interactive feedback, debugging, exploration |\n| CI/CD pipelines | **Print** | Stdin/stdout integration, no TTY required |\n| Scripts with single command | **Print** | Simple invocation, structured output |\n| Integration with other tools | **ACP** | Protocol-based, structured communication |\n| Human-supervised workflows | **Shell** | Approval prompts, visualization |\n| Batch processing | **Print** (stream-json) | Multiple commands, machine-readable |\n| IDE integration | **ACP** | Programmatic control, event streaming |\n\n### Command-Line Flags\n\nThe UI mode is selected via command-line flags:\n\n```bash\n# Shell mode (default)\nkimi\n\n# Print mode with text input/output\nkimi --print \"do something\"\n\n# Print mode with stream-json\nkimi --print --input-format stream-json --output-format stream-json\n\n# ACP mode\nkimi --acp\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:30-36](), [src/kimi_cli/ui/print/__init__.py:23-38]()\n\n## Background Tasks\n\nThe `ShellApp` supports background tasks for operations that run concurrently with the main prompt loop:\n\n```python\n# From src/kimi_cli/ui/shell/__init__.py:213-227\ndef _add_background_task(self, coro: Coroutine[Any, Any, Any]) -\u003e asyncio.Task[Any]:\n    task = asyncio.create_task(coro)\n    self._background_tasks.add(task)\n    # Cleanup callback to remove finished tasks\n    task.add_done_callback(_cleanup)\n    return task\n```\n\nCurrent background tasks:\n- **Auto-update checker**: Periodically checks for new versions and displays toast notifications\n\nSources: [src/kimi_cli/ui/shell/__init__.py:200-227]()\n\n## Signal Handling\n\nAll UI modes implement graceful signal handling for `SIGINT` (Ctrl+C):\n\n| Mode | Behavior |\n|------|----------|\n| **ShellApp** | Display tip, continue prompt loop |\n| **ShellApp** (during soul run) | Cancel execution, return to prompt |\n| **ShellApp** (during shell command) | Terminate subprocess |\n| **PrintApp** | Set cancel event, clean shutdown |\n| **ACPServer** | Set cancel event, clean shutdown |\n\nThe signal handler sets a cancel event that the `run_soul()` function monitors:\n\n```python\n# From src/kimi_cli/ui/shell/__init__.py:153-161\ncancel_event = asyncio.Event()\n\ndef _handler():\n    logger.debug(\"SIGINT received.\")\n    cancel_event.set()\n\nloop = asyncio.get_running_loop()\nloop.add_signal_handler(signal.SIGINT, _handler)\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:153-161](), [src/kimi_cli/ui/print/__init__.py:41-48]()"])</script><script>self.__next_f.push([1,"1e:T4e96,"])</script><script>self.__next_f.push([1,"# Interactive Shell Mode\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/denwarenji.py](src/kimi_cli/soul/denwarenji.py)\n- [src/kimi_cli/ui/print/__init__.py](src/kimi_cli/ui/print/__init__.py)\n- [src/kimi_cli/ui/shell/__init__.py](src/kimi_cli/ui/shell/__init__.py)\n- [src/kimi_cli/ui/shell/prompt.py](src/kimi_cli/ui/shell/prompt.py)\n- [src/kimi_cli/ui/shell/update.py](src/kimi_cli/ui/shell/update.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the interactive shell mode of kimi-cli, which provides a full-featured terminal interface for interacting with AI agents. The shell mode offers real-time feedback, auto-completion, command history, and multiple input modes. For information about meta commands available in the shell, see [Meta Commands](#4.2). For details about the live visualization system, see [Live View and Visualization](#4.3). For non-interactive modes, see [Print and ACP Modes](#4.4).\n\n---\n\n## Overview\n\nThe interactive shell mode is implemented by the `ShellApp` class, which orchestrates the prompt system, command routing, agent execution, and background services. It serves as the primary user interface for developers working with kimi-cli in a terminal environment.\n\n**Key Components:**\n\n| Component | Class/Module | Purpose |\n|-----------|-------------|---------|\n| Shell Application | `ShellApp` | Main orchestrator for interactive mode |\n| Prompt System | `CustomPromptSession` | Handles user input, completion, and display |\n| Console | Rich Console | Terminal output and formatting |\n| Update System | `do_update()` | Background update checking |\n| Visualization | `visualize()` | Real-time agent activity display |\n\nSources: [src/kimi_cli/ui/shell/__init__.py:30-82]()\n\n---\n\n## Shell Initialization and Entry Point\n\n### ShellApp Creation\n\nThe `ShellApp` is instantiated with a `Soul` instance and optional welcome information:\n\n```mermaid\ngraph TB\n    CLI[\"CLI Entry Point\"]\n    Config[\"Load Configuration\"]\n    Agent[\"Load Agent Spec\"]\n    Soul[\"Create Soul Instance\"]\n    ShellApp[\"ShellApp(soul, welcome_info)\"]\n    Run[\"run() method\"]\n    \n    CLI --\u003e Config\n    Config --\u003e Agent\n    Agent --\u003e Soul\n    Soul --\u003e ShellApp\n    ShellApp --\u003e Run\n    \n    Run --\u003e Welcome[\"Display Welcome Screen\"]\n    Run --\u003e Prompt[\"Initialize CustomPromptSession\"]\n    Run --\u003e AutoUpdate[\"Start Auto-Update Task\"]\n    Run --\u003e Loop[\"Enter Main Loop\"]\n```\n\nThe initialization process:\n\n1. **Soul Assignment**: `ShellApp.__init__()` receives a configured `Soul` instance\n2. **Welcome Info**: Optional metadata about the current session (workspace, agent name, etc.)\n3. **Background Tasks**: Set to track async operations like auto-update checking\n\nSources: [src/kimi_cli/ui/shell/__init__.py:30-35]()\n\n### Welcome Screen\n\nOn startup, the shell displays a welcome panel with the Kimi logo, agent information, and model configuration:\n\n```mermaid\ngraph LR\n    Welcome[\"_print_welcome_info()\"]\n    \n    Welcome --\u003e Logo[\"Kimi Logo ASCII Art\"]\n    Welcome --\u003e Heading[\"Agent Name \u0026 Help Text\"]\n    Welcome --\u003e Info[\"Session Info Items\"]\n    Welcome --\u003e Model[\"Model Configuration\"]\n    Welcome --\u003e Version[\"Update Status\"]\n    \n    Model --\u003e Set[\"Model: kimi/moonshot-...\"]\n    Model --\u003e NotSet[\"Model: not set, send /setup\"]\n    \n    Version --\u003e Available[\"New version available\"]\n    Version --\u003e Current[\"Up to date\"]\n```\n\nThe welcome screen includes:\n- ASCII art logo in Kimi blue color\n- Agent name and help prompt\n- Session-specific information (workspace path, session ID, etc.)\n- Current LLM model or configuration prompt\n- Update notification if a new version is available\n\nSources: [src/kimi_cli/ui/shell/__init__.py:239-284]()\n\n---\n\n## Main Event Loop\n\nThe shell operates in a continuous event loop that processes user input and routes commands appropriately:\n\n```mermaid\nflowchart TD\n    Start[\"Start Main Loop\"] --\u003e Prompt[\"await prompt_session.prompt()\"]\n    \n    Prompt --\u003e Input{Input Type?}\n    \n    Input --\u003e|Empty| Skip[\"Skip (continue)\"]\n    Input --\u003e|\"exit/quit\"| Exit[\"Print 'Bye!' and break\"]\n    Input --\u003e|KeyboardInterrupt| Tip[\"Show exit tip (continue)\"]\n    Input --\u003e|EOFError| Exit\n    Input --\u003e|Valid Command| CheckMode{Check Mode}\n    \n    CheckMode --\u003e|SHELL Mode| Shell[\"_run_shell_command()\"]\n    CheckMode --\u003e|AGENT Mode| CheckPrefix{Starts with '/'?}\n    \n    CheckPrefix --\u003e|Yes| Meta[\"_run_meta_command()\"]\n    CheckPrefix --\u003e|No| Agent[\"_run_soul_command()\"]\n    \n    Shell --\u003e Prompt\n    Meta --\u003e Prompt\n    Agent --\u003e Prompt\n    Skip --\u003e Prompt\n    Tip --\u003e Prompt\n```\n\n**Loop Behavior:**\n\n- **KeyboardInterrupt (Ctrl-C)**: Displays usage tip, continues loop\n- **EOFError (Ctrl-D)**: Gracefully exits the shell\n- **Empty Input**: Skipped, continues loop\n- **Exit Commands**: `exit`, `quit`, `/exit`, `/quit` all terminate the shell\n- **Shell Mode**: Executes command in subprocess\n- **Meta Commands**: Commands starting with `/` are processed as meta commands\n- **Agent Commands**: Regular text is sent to the agent for processing\n\nSources: [src/kimi_cli/ui/shell/__init__.py:46-82]()\n\n---\n\n## Prompt System Architecture\n\n### CustomPromptSession\n\nThe `CustomPromptSession` class wraps `prompt_toolkit.PromptSession` to provide enhanced functionality:\n\n```mermaid\ngraph TB\n    subgraph \"CustomPromptSession Components\"\n        Session[\"PromptSession\u003cbr/\u003e(prompt_toolkit)\"]\n        History[\"InMemoryHistory\u003cbr/\u003e+ JSONL persistence\"]\n        Completer[\"Merge of:\u003cbr/\u003e- MetaCommandCompleter\u003cbr/\u003e- FileMentionCompleter\"]\n        KeyBindings[\"Custom KeyBindings\u003cbr/\u003e- Ctrl-K: toggle mode\u003cbr/\u003e- Enter: accept completion\"]\n        Toolbar[\"Bottom Toolbar\u003cbr/\u003e- Time, mode, status, shortcuts\"]\n    end\n    \n    Session --\u003e History\n    Session --\u003e Completer\n    Session --\u003e KeyBindings\n    Session --\u003e Toolbar\n    \n    History --\u003e File[\"~/.local/share/kimi-cli/\u003cbr/\u003euser-history/\u003chash\u003e.jsonl\"]\n```\n\nSources: [src/kimi_cli/ui/shell/prompt.py:380-438]()\n\n### Prompt Modes\n\nThe shell supports two distinct interaction modes that can be toggled with `Ctrl-K`:\n\n| Mode | Symbol | Completer | Behavior |\n|------|--------|-----------|----------|\n| **AGENT** | `` | Meta commands + File mentions | Input sent to AI agent |\n| **SHELL** | `$` | Disabled | Input executed as shell command |\n\n**Mode Toggle Implementation:**\n\nWhen `Ctrl-K` is pressed:\n1. `_toggle_mode()` handler switches between `PromptMode.AGENT` and `PromptMode.SHELL`\n2. `_apply_mode()` updates buffer completer settings\n3. Shell mode disables completion and cancels active completion menu\n4. Agent mode enables both meta command and file mention completion\n\nSources: [src/kimi_cli/ui/shell/prompt.py:349-367](), [src/kimi_cli/ui/shell/prompt.py:422-466]()\n\n### Prompt Rendering\n\n```mermaid\ngraph LR\n    Render[\"_render_message()\"]\n    \n    Render --\u003e CheckMode{Mode?}\n    CheckMode --\u003e|AGENT| Agent[\"username \"]\n    CheckMode --\u003e|SHELL| Shell[\"username$ \"]\n```\n\nThe prompt displays the current user's username followed by a mode-specific symbol.\n\nSources: [src/kimi_cli/ui/shell/prompt.py:444-446]()\n\n---\n\n## Auto-Completion System\n\n### Meta Command Completion\n\nThe `MetaCommandCompleter` provides intelligent completion for meta commands:\n\n**Completion Logic:**\n\n```mermaid\nflowchart TD\n    Input[\"User Input\"] --\u003e Check1{Has content\u003cbr/\u003eafter cursor?}\n    Check1 --\u003e|Yes| Skip1[\"Skip completion\"]\n    Check1 --\u003e|No| Check2{Last token\u003cbr/\u003estarts with '/'?}\n    Check2 --\u003e|No| Skip2[\"Skip completion\"]\n    Check2 --\u003e|Yes| Extract[\"Extract typed fragment\u003cbr/\u003e(without '/')\"]\n    \n    Extract --\u003e Match[\"Match against:\u003cbr/\u003e- Command name\u003cbr/\u003e- All aliases\"]\n    Match --\u003e Generate[\"Generate completions with:\u003cbr/\u003e- Text: /canonical_name\u003cbr/\u003e- Display: /name (alias1, alias2)\u003cbr/\u003e- Meta: description\"]\n```\n\n**Completion Display:**\n\n- **Text inserted**: Canonical command name (e.g., `/help`)\n- **Display**: Command with aliases (e.g., `/help (?, h)`)\n- **Metadata**: Command description shown in completion menu\n\nSources: [src/kimi_cli/ui/shell/prompt.py:39-75]()\n\n### File Mention Completion\n\nThe `FileMentionCompleter` provides fuzzy completion for file paths using the `@` prefix:\n\n**Trigger Conditions:**\n\n1. Input contains `@` character\n2. No alphanumeric or special guard characters immediately before `@`\n3. No whitespace in the fragment after `@`\n4. Fragment is not an already-completed file path\n\n**Ignored Paths:**\n\nThe completer filters out common development artifacts and caches:\n\n| Category | Examples |\n|----------|----------|\n| VCS Metadata | `.git`, `.svn`, `.hg` |\n| Tooling Caches | `.cache`, `.pytest_cache`, `.ruff_cache`, `node_modules` |\n| JS Frontend | `.next`, `.nuxt`, `.turbo` |\n| Python Packaging | `__pycache__`, `dist`, `venv`, `*.pyc` |\n| Java/JVM | `target`, `out`, `.mvn` |\n| .NET/Native | `bin`, `obj`, `cmake-build-*` |\n\n**Optimization:**\n\n```mermaid\ngraph TB\n    Request[\"Completion Request\"]\n    \n    Request --\u003e Check{Fragment has '/'\u003cbr/\u003eor length \u003e= 3?}\n    Check --\u003e|No| TopLevel[\"_get_top_level_paths()\u003cbr/\u003e(cached 2s)\"]\n    Check --\u003e|Yes| Deep[\"_get_deep_paths()\u003cbr/\u003e(full walk, cached 2s)\"]\n    \n    TopLevel --\u003e Display[\"Return top-level\u003cbr/\u003efiles/dirs only\"]\n    Deep --\u003e Display2[\"Return all paths\u003cbr/\u003e(up to 1000)\"]\n```\n\nThe completer uses a two-tier caching strategy to minimize filesystem operations:\n- **Top-level cache**: Quick directory listing for short fragments\n- **Deep cache**: Full recursive walk for longer/path-containing fragments\n- Both caches expire after 2 seconds\n\nSources: [src/kimi_cli/ui/shell/prompt.py:78-304]()\n\n---\n\n## Input History Management\n\n### History Persistence\n\nUser inputs are persisted to a JSONL file keyed by workspace directory:\n\n**History File Location:**\n\n```\n~/.local/share/kimi-cli/user-history/\u003cmd5_hash_of_cwd\u003e.jsonl\n```\n\nEach line in the file is a JSON object:\n\n```json\n{\"content\": \"user input string\"}\n```\n\n**History Entry Structure:**\n\n```mermaid\nclassDiagram\n    class _HistoryEntry {\n        +str content\n    }\n    \n    class CustomPromptSession {\n        -Path _history_file\n        -str _last_history_content\n        -InMemoryHistory history\n        +_append_history_entry(text)\n    }\n    \n    CustomPromptSession --\u003e _HistoryEntry\n```\n\n**Deduplication:**\n\nThe shell prevents consecutive duplicate entries by tracking `_last_history_content`. New entries are only written if they differ from the previous entry.\n\nSources: [src/kimi_cli/ui/shell/prompt.py:307-346](), [src/kimi_cli/ui/shell/prompt.py:505-524]()\n\n---\n\n## Keyboard Shortcuts\n\n| Shortcut | Action | Implementation |\n|----------|--------|----------------|\n| **Ctrl-K** | Toggle between AGENT and SHELL modes | `_toggle_mode()` key binding |\n| **Ctrl-D** | Exit shell (EOF signal) | Built-in `prompt_toolkit` behavior |\n| **Ctrl-C** | Cancel current operation | SIGINT handler |\n| **Enter** | Accept first completion when menu is shown | Custom `_accept_completion()` key binding |\n| **Up/Down** | Navigate command history | Built-in `prompt_toolkit` behavior |\n\n**Enter Key Behavior:**\n\nWhen completions are visible, pressing Enter accepts the first (or currently selected) completion instead of submitting the line. This provides a quick way to complete commands without using arrow keys.\n\n```mermaid\nflowchart LR\n    Enter[\"Enter Pressed\"] --\u003e Check{Completions\u003cbr/\u003evisible?}\n    Check --\u003e|Yes| Accept[\"Accept first/current completion\"]\n    Check --\u003e|No| Submit[\"Submit line\"]\n```\n\nSources: [src/kimi_cli/ui/shell/prompt.py:411-428]()\n\n---\n\n## Status Bar and Notifications\n\n### Bottom Toolbar\n\nThe shell displays a persistent bottom toolbar with dynamic information:\n\n```mermaid\ngraph LR\n    Toolbar[\"_render_bottom_toolbar()\"]\n    \n    Toolbar --\u003e Time[\"Current time\u003cbr/\u003e(HH:MM)\"]\n    Toolbar --\u003e Mode[\"Current mode\u003cbr/\u003e(agent/shell)\"]\n    Toolbar --\u003e Toast[\"Toast message\u003cbr/\u003e(if active)\"]\n    Toolbar --\u003e Shortcuts[\"Keyboard shortcuts\u003cbr/\u003e(if space available)\"]\n    Toolbar --\u003e Status[\"Context usage\u003cbr/\u003e(right-aligned)\"]\n```\n\n**Layout Logic:**\n\n1. Start with available terminal width\n2. Render time and mode (always shown)\n3. If toast is active, display it (consumes space and duration)\n4. If no toast, show as many keyboard shortcuts as fit\n5. Right-align status display with padding\n\n**Status Format:**\n\nThe status displays context usage as a percentage: `context: 45.2%`\n\nSources: [src/kimi_cli/ui/shell/prompt.py:526-574]()\n\n### Toast Notifications\n\nToast messages are temporary notifications displayed in the toolbar:\n\n```mermaid\nsequenceDiagram\n    participant Caller\n    participant Queue as \"_toast_queue\"\n    participant Toolbar as \"Bottom Toolbar\"\n    \n    Caller-\u003e\u003eQueue: toast(message, duration)\n    Queue-\u003e\u003eQueue: Put (message, duration)\n    \n    Note over Toolbar: On next refresh\n    Toolbar-\u003e\u003eQueue: Check for messages\n    Queue--\u003e\u003eToolbar: (message, duration)\n    Toolbar-\u003e\u003eToolbar: Display message\n    \n    loop Every _REFRESH_INTERVAL (1.0s)\n        Toolbar-\u003e\u003eToolbar: Decrement duration\n        alt Duration \u003c= 0\n            Toolbar-\u003e\u003eToolbar: Clear toast\n        end\n    end\n```\n\n**Usage Examples:**\n\n- Auto-update checking: `\"checking for updates...\"` (2s)\n- Update available: `\"new version found, run uv tool upgrade...\"` (30s)\n- Update completed: `\"auto updated, restart to use...\"` (5s)\n\nSources: [src/kimi_cli/ui/shell/prompt.py:371-378](), [src/kimi_cli/ui/shell/prompt.py:544-563]()\n\n---\n\n## Auto-Update System\n\n### Background Update Checking\n\nThe shell starts a background task on startup to check for updates:\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Checking\n    Checking --\u003e CheckResult: do_update(check_only=True)\n    \n    CheckResult --\u003e UpToDate: Up to date\n    CheckResult --\u003e UpdateAvailable: New version found\n    CheckResult --\u003e AlreadyUpdated: Auto-updated\n    \n    UpToDate --\u003e [*]\n    \n    UpdateAvailable --\u003e ShowToast: Show toast for 30s\n    ShowToast --\u003e Wait: Wait 60s\n    Wait --\u003e ShowToast: Loop forever\n    \n    AlreadyUpdated --\u003e ShowOnce: Show toast for 5s\n    ShowOnce --\u003e [*]\n```\n\n**Update Flow:**\n\n1. **Initial Check**: Displays toast \"checking for updates...\" for 2 seconds\n2. **Update Available**: Displays persistent toast (30s on, 60s off cycle)\n3. **Auto-Updated**: Displays one-time toast about restart requirement\n4. **Up to Date**: Silent, no further action\n\n**Update Detection:**\n\nThe system compares semantic version tuples:\n\n```\ncurrent_version = \"1.2.3\"\nlatest_version = \"1.3.0\"\n\nsemver_tuple(\"1.2.3\") -\u003e (1, 2, 3)\nsemver_tuple(\"1.3.0\") -\u003e (1, 3, 0)\n\n(1, 2, 3) \u003c (1, 3, 0) -\u003e UPDATE_AVAILABLE\n```\n\nLatest version information is cached to `~/.local/share/kimi-cli/latest_version.txt` and displayed in the welcome screen.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:200-211](), [src/kimi_cli/ui/shell/update.py:78-197]()\n\n---\n\n## Command Execution Flow\n\n### Command Routing\n\n```mermaid\nflowchart TD\n    Input[\"UserInput\"] --\u003e ModeCheck{mode?}\n    \n    ModeCheck --\u003e|SHELL| Shell[\"_run_shell_command()\"]\n    ModeCheck --\u003e|AGENT| PrefixCheck{Starts with '/'?}\n    \n    PrefixCheck --\u003e|Yes| Meta[\"_run_meta_command()\"]\n    PrefixCheck --\u003e|No| Soul[\"_run_soul_command()\"]\n    \n    Shell --\u003e Subprocess[\"asyncio.create_subprocess_shell()\"]\n    Subprocess --\u003e SigInt[\"Register SIGINT handler\"]\n    SigInt --\u003e Wait[\"await proc.wait()\"]\n    Wait --\u003e Cleanup[\"Remove signal handler\"]\n    \n    Meta --\u003e Parse[\"Parse command and args\"]\n    Parse --\u003e Lookup[\"get_meta_command(name)\"]\n    Lookup --\u003e Check{Command exists?}\n    Check --\u003e|No| Error[\"Print 'not found'\"]\n    Check --\u003e|Yes| CheckSupport{Supports Soul type?}\n    CheckSupport --\u003e|No| Error2[\"Print 'not supported'\"]\n    CheckSupport --\u003e|Yes| Execute[\"command.func(app, args)\"]\n    \n    Soul --\u003e Cancel[\"Create cancel_event\"]\n    Cancel --\u003e Handler[\"Register SIGINT handler\"]\n    Handler --\u003e Run[\"run_soul(soul, command, visualize, cancel_event)\"]\n    Run --\u003e Cleanup2[\"Remove signal handler\"]\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:84-108](), [src/kimi_cli/ui/shell/__init__.py:109-144](), [src/kimi_cli/ui/shell/__init__.py:146-198]()\n\n### Shell Command Execution\n\nShell mode commands are executed as subprocesses with interrupt handling:\n\n**Process Flow:**\n\n1. Create subprocess using `asyncio.create_subprocess_shell()`\n2. Register SIGINT handler that terminates the process\n3. Wait for process completion\n4. Remove signal handler\n\nThis allows users to run arbitrary shell commands (e.g., `ls`, `git status`) directly from the prompt without switching to a separate terminal.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:84-108]()\n\n### Agent Command Execution\n\nAgent commands trigger the full agent execution pipeline:\n\n```mermaid\nsequenceDiagram\n    participant Shell as ShellApp\n    participant RunSoul as run_soul()\n    participant Soul as Soul Instance\n    participant Wire as Wire\n    participant Viz as visualize()\n    \n    Shell-\u003e\u003eShell: Create cancel_event\n    Shell-\u003e\u003eShell: Register SIGINT handler\n    Shell-\u003e\u003eRunSoul: run_soul(soul, command, visualize, cancel_event)\n    \n    RunSoul-\u003e\u003eWire: Create Wire instance\n    RunSoul-\u003e\u003eViz: Start visualize task\n    RunSoul-\u003e\u003eSoul: soul.run(command, wire)\n    \n    par Agent Execution\n        Soul-\u003e\u003eWire: Send events (StepBegin, ToolCall, etc.)\n    and Visualization\n        Wire-\u003e\u003eViz: Receive events\n        Viz-\u003e\u003eViz: Update UI\n    end\n    \n    Soul--\u003e\u003eRunSoul: Execution complete\n    RunSoul-\u003e\u003eWire: wire.shutdown()\n    RunSoul-\u003e\u003eViz: Wait for visualization (0.5s timeout)\n    RunSoul--\u003e\u003eShell: Return success/failure\n    \n    Shell-\u003e\u003eShell: Remove SIGINT handler\n```\n\nSources: [src/kimi_cli/ui/shell/__init__.py:146-198](), [src/kimi_cli/ui/__init__.py]()\n\n### Error Handling\n\nThe shell provides graceful error handling for various failure scenarios:\n\n| Exception | HTTP Status | Message |\n|-----------|-------------|---------|\n| `LLMNotSet` | N/A | \"LLM not set, send /setup to configure\" |\n| `APIStatusError` | 401 | \"Authorization failed, please check your API key\" |\n| `APIStatusError` | 402 | \"Membership expired, please renew your plan\" |\n| `APIStatusError` | 403 | \"Quota exceeded, please upgrade your plan or retry later\" |\n| `ChatProviderError` | Other | \"LLM provider error: {message}\" |\n| `MaxStepsReached` | N/A | \"Max steps reached: {n_steps}\" |\n| `RunCancelled` | N/A | \"Interrupted by user\" |\n| `Reload` | N/A | (propagated for configuration reload) |\n\nAll errors are logged and displayed to the user with appropriate coloring (red for errors, yellow for warnings).\n\nSources: [src/kimi_cli/ui/shell/__init__.py:170-198]()\n\n---\n\n## Session Continuity\n\n### Context Preservation\n\nWhen the shell starts, it loads existing context from history files if available. The `Soul` instance maintains:\n\n- Previous conversation history\n- Tool execution results\n- Checkpoints for time-travel features (D-Mail)\n\n### Multi-Session Support\n\nEach workspace (identified by current working directory) maintains its own:\n\n- **Command history**: `~/.local/share/kimi-cli/user-history/\u003chash\u003e.jsonl`\n- **Agent context**: Session-specific history files managed by the Soul\n\nThis allows seamless switching between projects without losing context or history.\n\nSources: [src/kimi_cli/ui/shell/prompt.py:382-398]()\n\n---\n\n## Background Task Management\n\nThe `ShellApp` maintains a set of background tasks that run concurrently with the main event loop:\n\n```mermaid\ngraph TB\n    App[\"ShellApp\"]\n    Tasks[\"_background_tasks: set[Task]\"]\n    \n    App --\u003e Tasks\n    Tasks --\u003e Update[\"Auto-update Task\"]\n    \n    Update --\u003e Check[\"Check for updates\"]\n    Update --\u003e Toast[\"Display toast notifications\"]\n    \n    App --\u003e Cleanup[\"Task cleanup on completion\"]\n    Cleanup --\u003e Remove[\"Remove from set\"]\n    Cleanup --\u003e Log[\"Log exceptions\"]\n```\n\n**Task Lifecycle:**\n\n1. **Creation**: `_add_background_task(coro)` creates and tracks task\n2. **Execution**: Task runs concurrently with main loop\n3. **Completion**: Cleanup callback removes task and logs exceptions\n4. **Cancellation**: Handled gracefully (no error logs)\n\nThis pattern ensures background tasks don't leak resources and exceptions are properly logged.\n\nSources: [src/kimi_cli/ui/shell/__init__.py:213-227]()"])</script><script>self.__next_f.push([1,"1f:T384f,"])</script><script>self.__next_f.push([1,"# Meta Commands\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/ui/shell/metacmd.py](src/kimi_cli/ui/shell/metacmd.py)\n\n\u003c/details\u003e\n\n\n\nThis document describes the meta command system in kimi-cli, which provides special commands prefixed with `/` that control the shell environment, manage context, configure settings, and provide information about the system. Meta commands are distinct from regular user input that gets processed by the agent.\n\nFor information about the interactive shell interface that executes these commands, see [Interactive Shell Mode](#4.1). For information about agent execution that meta commands can control, see [Agent System](#3.2).\n\n## Overview\n\nMeta commands are special commands that begin with a forward slash (`/`) and are intercepted by the `ShellApp` before being sent to the agent. They provide direct control over the CLI environment, including configuration, context management, debugging, and system information.\n\nThe meta command system is implemented using a decorator-based registration pattern in [src/kimi_cli/ui/shell/metacmd.py](), with additional commands defined in separate modules for `setup`, `update`, and `debug` functionality.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:1-268]()\n\n## Meta Command Registration System\n\n### Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Registration System\"\n        Decorator[\"@meta_command decorator\"]\n        MetaCommand[\"MetaCommand NamedTuple\"]\n        PrimaryRegistry[\"_meta_commands dict\"]\n        AliasRegistry[\"_meta_command_aliases dict\"]\n    end\n    \n    subgraph \"Command Definition\"\n        FuncDef[\"def command_func(app, args)\"]\n        Docstring[\"Docstring  description\"]\n        Params[\"Decorator params:\u003cbr/\u003ename, aliases, kimi_soul_only\"]\n    end\n    \n    subgraph \"Lookup and Execution\"\n        GetCommand[\"get_meta_command(name)\"]\n        GetAll[\"get_meta_commands()\"]\n        ShellApp[\"ShellApp._run_meta_command()\"]\n    end\n    \n    FuncDef --\u003e Decorator\n    Docstring --\u003e Decorator\n    Params --\u003e Decorator\n    \n    Decorator --\u003e MetaCommand\n    MetaCommand --\u003e PrimaryRegistry\n    MetaCommand --\u003e AliasRegistry\n    \n    GetCommand --\u003e AliasRegistry\n    GetAll --\u003e PrimaryRegistry\n    \n    ShellApp --\u003e GetCommand\n    GetCommand --\u003e FuncDef\n    \n    style MetaCommand fill:#f9f9f9\n    style Decorator fill:#f9f9f9\n```\n\n**Diagram**: Meta Command Registration and Lookup Flow\n\nThe meta command system uses two registries:\n- `_meta_commands`: Maps primary command names to `MetaCommand` objects\n- `_meta_command_aliases`: Maps both primary names and aliases to `MetaCommand` objects\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:36-64]()\n\n### MetaCommand Structure\n\nThe `MetaCommand` named tuple encapsulates all metadata about a command:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `name` | `str` | Primary command name |\n| `description` | `str` | Human-readable description (from docstring) |\n| `func` | `MetaCmdFunc` | The callable function to execute |\n| `aliases` | `list[str]` | Alternative names for the command |\n| `kimi_soul_only` | `bool` | Whether command requires `KimiSoul` instance |\n\nThe `MetaCmdFunc` type signature is:\n```\nCallable[[ShellApp, list[str]], None | Awaitable[None]]\n```\n\nCommands can be synchronous or asynchronous, and may raise specific exceptions like `LLMNotSet`, `ChatProviderError`, `Reload`, or `asyncio.CancelledError`.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:22-49]()\n\n### Registration Pattern\n\nThe `@meta_command` decorator supports three usage patterns:\n\n```python\n# 1. Simple registration (uses function name)\n@meta_command\ndef help(app: ShellApp, args: list[str]): ...\n\n# 2. Custom primary name\n@meta_command(name=\"release-notes\")\ndef release_notes(app: ShellApp, args: list[str]): ...\n\n# 3. With aliases and flags\n@meta_command(aliases=[\"h\", \"?\"], kimi_soul_only=True)\ndef help(app: ShellApp, args: list[str]): ...\n```\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:66-131]()\n\n## General Meta Commands\n\n### Help System\n\n```mermaid\ngraph LR\n    subgraph \"Help Commands\"\n        Help[\"/help, /h, /?\"]\n        Version[\"/version\"]\n        ReleaseNotes[\"/release-notes\"]\n        Feedback[\"/feedback\"]\n    end\n    \n    subgraph \"Output\"\n        HelpPanel[\"Help Panel with\u003cbr/\u003emeta command list\"]\n        VersionText[\"kimi, version X.Y.Z\"]\n        ChangelogPanel[\"Paginated changelog\"]\n        IssueBrowser[\"Open GitHub Issues\u003cbr/\u003ein browser\"]\n    end\n    \n    Help --\u003e HelpPanel\n    Version --\u003e VersionText\n    ReleaseNotes --\u003e ChangelogPanel\n    Feedback --\u003e IssueBrowser\n    \n    style Help fill:#f9f9f9\n```\n\n**Diagram**: Help and Information Meta Commands\n\n| Command | Aliases | Description | Output |\n|---------|---------|-------------|--------|\n| `/help` | `/h`, `/?` | Show help information | Panel with Beatles quote and command list |\n| `/version` | - | Show version information | Current kimi-cli version number |\n| `/release-notes` | - | Show release notes | Paginated changelog in panel format |\n| `/feedback` | - | Submit feedback | Opens GitHub issues page in browser |\n\nThe `/help` command formats all registered meta commands by calling `get_meta_commands()` and displaying them with their descriptions in a `rich.Panel`.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:140-197]()\n\n### Session Control\n\nThe `/exit` command (alias `/quit`) terminates the shell session. While registered in the meta command system, its execution is actually handled by the `ShellApp` before the meta command handler is invoked, allowing it to break out of the main input loop.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:133-138]()\n\n## KimiSoul-Specific Meta Commands\n\nThese commands are only available when the active soul is a `KimiSoul` instance (not compatible with other soul types). They are marked with `kimi_soul_only=True` in their registration.\n\n### Context Management Commands\n\n```mermaid\ngraph TB\n    subgraph \"Context Operations\"\n        Clear[\"/clear, /reset\"]\n        Compact[\"/compact\"]\n    end\n    \n    subgraph \"Context State\"\n        Context[\"Context object\u003cbr/\u003ewith checkpoints\"]\n        Checkpoints[\"Checkpoint history\"]\n    end\n    \n    subgraph \"Actions\"\n        RevertTo0[\"context.revert_to(0)\"]\n        CompactCtx[\"soul.compact_context()\"]\n        CheckEmpty[\"Check n_checkpoints \u003e 0\"]\n    end\n    \n    Clear --\u003e CheckEmpty\n    Compact --\u003e CheckEmpty\n    \n    CheckEmpty --\u003e|empty| EmptyWarning[\"Print warning\"]\n    CheckEmpty --\u003e|not empty| RevertTo0\n    CheckEmpty --\u003e|not empty| CompactCtx\n    \n    RevertTo0 --\u003e Context\n    CompactCtx --\u003e Context\n    \n    Context --\u003e Checkpoints\n    \n    style Clear fill:#f9f9f9\n    style Compact fill:#f9f9f9\n```\n\n**Diagram**: Context Management Meta Command Flow\n\n#### `/clear` (alias `/reset`)\n\nClears all context by reverting to checkpoint 0, effectively starting a fresh conversation while maintaining the session.\n\nImplementation flow:\n1. Check if `app.soul` is a `KimiSoul` instance (assertion)\n2. Check if `context.n_checkpoints == 0` (warn if empty)\n3. Call `await app.soul._context.revert_to(0)`\n4. Display success message\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:235-246]()\n\n#### `/compact`\n\nManually triggers context compaction to reduce token usage by summarizing older messages. This operation is also performed automatically by `KimiSoul` when context length exceeds configured limits.\n\nImplementation flow:\n1. Validate `KimiSoul` instance and non-empty context\n2. Log operation with `logger.info(\"Running `/compact`\")`\n3. Display status indicator with `console.status()`\n4. Call `await app.soul.compact_context()`\n5. Display success message\n\nFor more details on the compaction algorithm, see [Context Compaction](#7.4).\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:248-261]()\n\n### Codebase Analysis Command\n\n#### `/init`\n\nAnalyzes the current codebase and generates an `AGENTS.md` file containing project-specific agent configuration. This command creates a temporary context, runs the agent with a specialized init prompt, and preserves the main session context.\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant ShellApp\n    participant Init as \"/init command\"\n    participant TempContext\n    participant KimiSoul\n    participant AGENTS_MD\n    \n    User-\u003e\u003eShellApp: /init\n    ShellApp-\u003e\u003eInit: Execute\n    Init-\u003e\u003eInit: Backup current soul\n    Init-\u003e\u003eTempContext: Create temporary context\n    Init-\u003e\u003eKimiSoul: Create temporary soul\n    Init-\u003e\u003eShellApp: _run_soul_command(prompts.INIT)\n    ShellApp-\u003e\u003eKimiSoul: run() with init prompt\n    KimiSoul-\u003e\u003eAGENTS_MD: Generate AGENTS.md file\n    Init-\u003e\u003eInit: Restore original soul\n    Init-\u003e\u003eAGENTS_MD: Load generated file\n    Init-\u003e\u003eShellApp: Append system message about /init\n```\n\n**Diagram**: `/init` Command Execution Sequence\n\nImplementation details:\n1. Creates temporary directory and `Context` instance\n2. Instantiates new `KimiSoul` with same agent/globals but temp context\n3. Executes `prompts.INIT` prompt via `app._run_soul_command()`\n4. Restores original soul after completion\n5. Loads generated `AGENTS.md` file with `load_agents_md()`\n6. Appends system message informing agent about the `/init` execution\n\nThe temporary context ensures the analysis doesn't pollute the main conversation history.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:199-233]()\n\n## Additional Meta Command Modules\n\nThe meta command system is extended through three additional modules imported at the end of `metacmd.py`:\n\n```mermaid\ngraph LR\n    subgraph \"Core Meta Commands\"\n        Core[\"metacmd.py\u003cbr/\u003ehelp, version, exit\u003cbr/\u003einit, clear, compact\u003cbr/\u003erelease-notes, feedback\"]\n    end\n    \n    subgraph \"Extended Modules\"\n        Setup[\"setup.py\u003cbr/\u003e/setup command\"]\n        Update[\"update.py\u003cbr/\u003e/update command\"]\n        Debug[\"debug.py\u003cbr/\u003e/debug commands\"]\n    end\n    \n    Core -.import.-\u003e Setup\n    Core -.import.-\u003e Update\n    Core -.import.-\u003e Debug\n    \n    style Core fill:#f9f9f9\n```\n\n**Diagram**: Meta Command Module Organization\n\n### `/setup`\n\nDefined in `src/kimi_cli/ui/shell/setup.py`, this command provides interactive configuration setup. It guides users through:\n- LLM provider selection and API key configuration\n- Model selection for each provider\n- Optional service configuration (Moonshot Search API)\n\nFor complete configuration details, see [Installation and Configuration](#2.1) and [Configuration Reference](#8).\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:263-267]()\n\n### `/update`\n\nDefined in `src/kimi_cli/ui/shell/update.py`, this command manages kimi-cli updates. It checks for new versions and can trigger installation updates.\n\nFor information about the automatic update checking system, see [Auto-Update System](#7.5).\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:263-267]()\n\n### Debug Commands\n\nDefined in `src/kimi_cli/ui/shell/debug.py`, these commands provide developer-focused functionality for inspecting and debugging the system state.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:263-267]()\n\n## Command Execution Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Prompt as \"CustomPromptSession\"\n    participant ShellApp\n    participant MetaCmd as \"get_meta_command()\"\n    participant Registry as \"_meta_command_aliases\"\n    participant Handler as \"MetaCommand.func\"\n    \n    User-\u003e\u003ePrompt: Enter \"/command arg1 arg2\"\n    Prompt-\u003e\u003eShellApp: Input string\n    ShellApp-\u003e\u003eShellApp: Parse command and args\n    ShellApp-\u003e\u003eMetaCmd: get_meta_command(\"command\")\n    MetaCmd-\u003e\u003eRegistry: Lookup by name or alias\n    \n    alt Command found\n        Registry--\u003e\u003eMetaCmd: Return MetaCommand\n        MetaCmd--\u003e\u003eShellApp: MetaCommand instance\n        \n        alt kimi_soul_only == True\n            ShellApp-\u003e\u003eShellApp: Check isinstance(soul, KimiSoul)\n            alt Not KimiSoul\n                ShellApp-\u003e\u003eUser: Error: Command requires KimiSoul\n            end\n        end\n        \n        ShellApp-\u003e\u003eHandler: func(app, args)\n        \n        alt Async command\n            Handler-\u003e\u003eHandler: await async execution\n        end\n        \n        Handler-\u003e\u003eUser: Display output/effect\n    else Command not found\n        MetaCmd--\u003e\u003eShellApp: None\n        ShellApp-\u003e\u003eShellApp: Route to agent as regular input\n    end\n```\n\n**Diagram**: Meta Command Execution Flow in ShellApp\n\nThe `ShellApp` processes meta commands before routing input to the agent:\n1. Parse input to extract command name and arguments\n2. Look up command in `_meta_command_aliases` registry\n3. Validate `kimi_soul_only` requirement if applicable\n4. Execute the command function (synchronously or asynchronously)\n5. Handle any exceptions (e.g., `Reload` for config changes)\n6. If no meta command matches, route input to agent\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:36-64]()\n\n## Meta Command Categories\n\n| Category | Commands | Purpose |\n|----------|----------|---------|\n| **Information** | `/help`, `/version`, `/release-notes` | Display system information |\n| **Feedback** | `/feedback` | Open issue tracker for user feedback |\n| **Session Control** | `/exit`, `/quit` | Terminate shell session |\n| **Context Management** | `/clear`, `/reset`, `/compact` | Manage conversation context (KimiSoul only) |\n| **Initialization** | `/init` | Generate project-specific agent configuration (KimiSoul only) |\n| **Configuration** | `/setup` | Interactive configuration wizard |\n| **Updates** | `/update` | Check for and install updates |\n| **Debugging** | Various debug commands | Developer tools for system inspection |\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:1-268]()\n\n## Integration with ShellApp\n\nMeta commands integrate with the `ShellApp` interactive shell through several mechanisms:\n\n1. **Command Detection**: Input strings starting with `/` are routed to meta command handling\n2. **Auto-completion**: Meta command names appear in auto-completion suggestions alongside file paths\n3. **Help Display**: All registered commands are displayed in `/help` output\n4. **Error Handling**: Commands can raise specific exceptions that `ShellApp` handles appropriately\n5. **Async Support**: Commands can be async functions, allowing them to interact with the agent system\n\nThe `ShellApp._run_meta_command()` method orchestrates this integration, providing the app instance and parsed arguments to each command function.\n\n**Sources**: [src/kimi_cli/ui/shell/metacmd.py:22-33]()"])</script><script>self.__next_f.push([1,"20:T48d7,"])</script><script>self.__next_f.push([1,"# Live View and Visualization\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [src/kimi_cli/ui/shell/console.py](src/kimi_cli/ui/shell/console.py)\n- [src/kimi_cli/ui/shell/keyboard.py](src/kimi_cli/ui/shell/keyboard.py)\n- [src/kimi_cli/ui/shell/liveview.py](src/kimi_cli/ui/shell/liveview.py)\n- [src/kimi_cli/ui/shell/visualize.py](src/kimi_cli/ui/shell/visualize.py)\n\n\u003c/details\u003e\n\n\n\nThis document describes the live view and visualization system used in kimi-cli's interactive Shell mode to display agent activity in real-time. The live view provides a rich terminal interface that shows streaming LLM responses, tool execution progress, interactive approval requests, and system status.\n\nFor information about the broader Shell UI mode and its features, see [Interactive Shell Mode](#4.1). For details on the Wire event system that feeds the live view, see [Communication Layer](#3.4).\n\n---\n\n## Purpose and Scope\n\nThe live view system provides real-time visualization of agent execution in the terminal, including:\n- Streaming text responses from the LLM with markdown formatting\n- Tool call progress indicators with argument extraction\n- Interactive approval request menus with keyboard navigation\n- Context usage and system status display\n- Graceful handling of interruptions and errors\n\nThe visualization runs as an asynchronous event loop that consumes events from the Wire and updates the terminal display using the Rich library's Live display feature.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:1-378](), [src/kimi_cli/ui/shell/visualize.py:1-106]()\n\n---\n\n## Architecture Overview\n\n```mermaid\ngraph TB\n    Wire[\"Wire\u003cbr/\u003e(Event Stream)\"]\n    VisualizeLoop[\"visualize()\u003cbr/\u003eEvent Consumer Loop\"]\n    StepLiveView[\"StepLiveView\u003cbr/\u003eDisplay Compositor\"]\n    KeyboardListener[\"listen_for_keyboard()\u003cbr/\u003eAsync Key Events\"]\n    RichLive[\"Rich.Live\u003cbr/\u003eTerminal Renderer\"]\n    \n    subgraph \"Display Components\"\n        ToolCallDisplay[\"_ToolCallDisplay\u003cbr/\u003eTool Progress\"]\n        ApprovalDisplay[\"_ApprovalRequestDisplay\u003cbr/\u003eInteractive Menu\"]\n        StatusDisplay[\"Status Bar\u003cbr/\u003eContext Usage\"]\n        TextBuffer[\"Text/Markdown\u003cbr/\u003eBuffer\"]\n    end\n    \n    Wire --\u003e VisualizeLoop\n    VisualizeLoop --\u003e StepLiveView\n    KeyboardListener --\u003e StepLiveView\n    \n    StepLiveView --\u003e ToolCallDisplay\n    StepLiveView --\u003e ApprovalDisplay\n    StepLiveView --\u003e StatusDisplay\n    StepLiveView --\u003e TextBuffer\n    \n    ToolCallDisplay --\u003e RichLive\n    ApprovalDisplay --\u003e RichLive\n    StatusDisplay --\u003e RichLive\n    TextBuffer --\u003e RichLive\n    \n    RichLive --\u003e Terminal[\"Terminal Output\"]\n```\n\n**Diagram: Live View Architecture**\n\nThe system follows a pipeline architecture where the `visualize()` loop consumes events from the Wire, translates them to display components, and updates the Rich Live renderer. The `StepLiveView` class acts as the compositor, managing multiple display elements and coordinating their updates.\n\n**Sources:** [src/kimi_cli/ui/shell/visualize.py:42-106](), [src/kimi_cli/ui/shell/liveview.py:127-296]()\n\n---\n\n## Visualization Event Loop\n\n```mermaid\nsequenceDiagram\n    participant Wire\n    participant Visualize as visualize()\n    participant StepLiveView\n    participant Console as Rich Console\n    participant Keyboard\n    \n    Wire-\u003e\u003eVisualize: StepBegin\n    \n    loop For Each Step\n        Visualize-\u003e\u003eStepLiveView: create with status\n        Visualize-\u003e\u003eKeyboard: start listener\n        \n        loop Event Processing\n            Wire-\u003e\u003eVisualize: Event\n            \n            alt TextPart\n                Visualize-\u003e\u003eStepLiveView: append_text()\n            else ToolCall\n                Visualize-\u003e\u003eStepLiveView: append_tool_call()\n            else ToolCallPart\n                Visualize-\u003e\u003eStepLiveView: append_tool_call_part()\n            else ToolResult\n                Visualize-\u003e\u003eStepLiveView: append_tool_result()\n            else ApprovalRequest\n                Visualize-\u003e\u003eStepLiveView: request_approval()\n                Keyboard-\u003e\u003eStepLiveView: handle_keyboard_event()\n            else StatusUpdate\n                Visualize-\u003e\u003eStepLiveView: update_status()\n            else CompactionBegin\n                Visualize-\u003e\u003eConsole: status(\"Compacting...\")\n            else StepBegin/StepInterrupted\n                Note over Visualize: Break to next step\n            end\n            \n            StepLiveView-\u003e\u003eConsole: Live.update()\n        end\n        \n        alt StepInterrupted\n            Visualize-\u003e\u003eStepLiveView: interrupt()\n        else Normal Completion\n            Visualize-\u003e\u003eStepLiveView: finish()\n        end\n        \n        Visualize-\u003e\u003eKeyboard: stop listener\n    end\n```\n\n**Diagram: Visualization Event Processing Flow**\n\nThe `visualize()` function is the main event loop that orchestrates the display. It processes events from the Wire and delegates to the appropriate `StepLiveView` methods. The loop continues until it receives a `StepInterrupted` event or the Wire shuts down.\n\n| Event Type | Handler Method | Purpose |\n|------------|---------------|---------|\n| `StepBegin` | Loop boundary | Starts a new agent step |\n| `TextPart` | `append_text()` | Streams LLM response text |\n| `ToolCall` | `append_tool_call()` | Begins tool execution display |\n| `ToolCallPart` | `append_tool_call_part()` | Streams tool arguments |\n| `ToolResult` | `append_tool_result()` | Completes tool display with result |\n| `ApprovalRequest` | `request_approval()` | Shows interactive approval menu |\n| `StatusUpdate` | `update_status()` | Updates status bar |\n| `CompactionBegin` | Console status | Shows compaction progress |\n| `StepInterrupted` | `interrupt()` | Marks incomplete tool calls |\n\n**Sources:** [src/kimi_cli/ui/shell/visualize.py:42-106]()\n\n---\n\n## StepLiveView Component Structure\n\n```mermaid\nclassDiagram\n    class StepLiveView {\n        -Text _line_buffer\n        -dict~str, _ToolCallDisplay~ _tool_calls\n        -deque~ApprovalRequest~ _approval_queue\n        -_ApprovalRequestDisplay _current_approval\n        -Text _status_text\n        -Live _live\n        +append_text(text)\n        +append_tool_call(tool_call)\n        +append_tool_call_part(part)\n        +append_tool_result(result)\n        +request_approval(request)\n        +handle_keyboard_event(event)\n        +update_status(status)\n        +finish()\n        +interrupt()\n        -_compose() RenderableType\n        -_push_out(renderable)\n    }\n    \n    class _ToolCallDisplay {\n        -str _tool_name\n        -Lexer _lexer\n        -str _subtitle\n        -bool _finished\n        -Spinner _spinner\n        +RenderableType renderable\n        +append_args_part(args_part)\n        +finish(result)\n    }\n    \n    class _ApprovalRequestDisplay {\n        +ApprovalRequest request\n        +list options\n        +int selected_index\n        +render() RenderableType\n        +move_up()\n        +move_down()\n        +get_selected_response()\n    }\n    \n    class StepLiveViewWithMarkdown {\n        -list~str~ _pending_markdown_parts\n        -Status _buffer_status_obj\n        +append_text(text)\n        -_flush_markdown()\n        -_show_thinking_status()\n        -_hide_thinking_status()\n    }\n    \n    StepLiveView --\u003e _ToolCallDisplay : manages\n    StepLiveView --\u003e _ApprovalRequestDisplay : manages\n    StepLiveViewWithMarkdown --|\u003e StepLiveView : extends\n```\n\n**Diagram: StepLiveView Class Hierarchy**\n\nThe `StepLiveView` class composites multiple display elements and manages their lifecycle. It uses Rich's `Live` display for efficient terminal updates at 10 FPS, keeping the last frame visible when the step completes (`transient=False`).\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:127-296](), [src/kimi_cli/ui/shell/liveview.py:298-355]()\n\n---\n\n## Tool Call Visualization\n\nTool calls are displayed with a spinner during execution and completed with a status indicator (`` or ``). The display extracts a subtitle from the tool arguments for quick context.\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Creating: ToolCall received\n    Creating --\u003e Streaming: Display spinner\n    Streaming --\u003e Streaming: ToolCallPart updates\n    Streaming --\u003e Finished: ToolResult received\n    Finished --\u003e [*]\n    \n    note right of Creating\n        Create _ToolCallDisplay\n        Parse initial arguments\n        Extract subtitle\n    end note\n    \n    note right of Streaming\n        Update subtitle as args stream\n        Show spinner: \"Using toolname: subtitle\"\n    end note\n    \n    note right of Finished\n        Replace spinner with /\n        Show brief result message\n    end note\n```\n\n**Diagram: Tool Call Display State Machine**\n\nThe `_ToolCallDisplay` class manages the lifecycle of a single tool call visualization:\n\n| Phase | Visual Element | Purpose |\n|-------|---------------|---------|\n| Initial | Spinner with tool name | Indicates tool execution started |\n| Streaming | Updated subtitle | Shows extracted argument details |\n| Success | Green  + tool name + subtitle | Indicates successful completion |\n| Error | Red  + tool name + subtitle + brief | Shows error message |\n\nThe subtitle extraction uses `streamingjson.Lexer` to incrementally parse JSON arguments and the `extract_subtitle()` function to pull out meaningful details based on tool type. For example, for `ReadFile`, it extracts the file path; for `WriteFile`, both path and byte count.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:23-76](), [src/kimi_cli/tools/__init__.py:1-100]()\n\n---\n\n## Interactive Approval Interface\n\n```mermaid\ngraph TB\n    ApprovalReq[\"ApprovalRequest\u003cbr/\u003efrom Wire\"]\n    Queue[\"_approval_queue\u003cbr/\u003edeque\"]\n    CurrentApproval[\"_current_approval\u003cbr/\u003e_ApprovalRequestDisplay\"]\n    \n    subgraph \"Menu Options\"\n        Option1[\" Approve\"]\n        Option2[\"  Approve for this session\"]\n        Option3[\"  Reject, tell Kimi CLI what to do instead\"]\n    end\n    \n    subgraph \"Keyboard Events\"\n        UpDown[\"UP/DOWN\u003cbr/\u003eNavigate\"]\n        Enter[\"ENTER\u003cbr/\u003eConfirm\"]\n    end\n    \n    ApprovalReq --\u003e Queue\n    Queue --\u003e CurrentApproval\n    CurrentApproval --\u003e Option1\n    CurrentApproval --\u003e Option2\n    CurrentApproval --\u003e Option3\n    \n    UpDown --\u003e CurrentApproval\n    Enter --\u003e ResolveAction\n    \n    ResolveAction{Resolution Type?}\n    ResolveAction --\u003e|APPROVE| NextRequest[\"Show Next\"]\n    ResolveAction --\u003e|APPROVE_FOR_SESSION| BatchApprove[\"Approve all\u003cbr/\u003esame action\"]\n    ResolveAction --\u003e|REJECT| RejectAll[\"Reject all\u003cbr/\u003epending\"]\n    \n    BatchApprove --\u003e NextRequest\n    RejectAll --\u003e End[\"End step\"]\n    NextRequest --\u003e Queue\n```\n\n**Diagram: Approval Request Flow**\n\nWhen a tool requires approval, the system displays an interactive menu rendered as a yellow-bordered panel. The user navigates options with arrow keys and confirms with Enter.\n\n### Approval Response Types\n\n| Response | Effect | Use Case |\n|----------|--------|----------|\n| `APPROVE` | Allows single action | One-time approval for this specific tool call |\n| `APPROVE_FOR_SESSION` | Allows action for session | Automatically approve all future calls to this tool in the current session |\n| `REJECT` | Denies action, stops step | User wants to provide different instructions; rejects all pending approvals |\n\nThe approval system integrates with keyboard input handling:\n\n```\nUP key     _current_approval.move_up()\nDOWN key   _current_approval.move_down()\nENTER key  _current_approval.get_selected_response()\n            request.resolve(response)\n```\n\nWhen a rejection occurs, the system sets `_reject_all_following = True` to immediately reject any subsequent approval requests in the same step without showing UI.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:78-125](), [src/kimi_cli/ui/shell/liveview.py:213-276]()\n\n---\n\n## Keyboard Event Handling\n\n```mermaid\ngraph LR\n    subgraph \"Terminal Input\"\n        RawInput[\"Raw stdin\u003cbr/\u003eNon-blocking\"]\n    end\n    \n    subgraph \"Keyboard Thread\"\n        Thread[\"_listen_for_keyboard_thread\"]\n        Parser[\"Escape Sequence\u003cbr/\u003eParser\"]\n    end\n    \n    subgraph \"Async Bridge\"\n        Queue[\"asyncio.Queue\"]\n        Generator[\"listen_for_keyboard()\"]\n    end\n    \n    subgraph \"Event Processing\"\n        StepLiveView[\"StepLiveView.\u003cbr/\u003ehandle_keyboard_event()\"]\n        ApprovalMenu[\"_ApprovalRequestDisplay\"]\n    end\n    \n    RawInput --\u003e Thread\n    Thread --\u003e Parser\n    Parser --\u003e Queue\n    Queue --\u003e Generator\n    Generator --\u003e StepLiveView\n    StepLiveView --\u003e ApprovalMenu\n```\n\n**Diagram: Keyboard Input Pipeline**\n\nThe keyboard input system uses a background thread to read raw terminal input and bridges it to async code via `asyncio.Queue`. The thread manipulates terminal settings using `termios` to enable raw, non-blocking input.\n\n### Key Sequence Mapping\n\n| Input | Sequence | KeyEvent |\n|-------|----------|----------|\n| Up Arrow | `\\x1b[A` | `KeyEvent.UP` |\n| Down Arrow | `\\x1b[B` | `KeyEvent.DOWN` |\n| Left Arrow | `\\x1b[D` | `KeyEvent.LEFT` |\n| Right Arrow | `\\x1b[C` | `KeyEvent.RIGHT` |\n| Enter | `\\r` or `\\n` | `KeyEvent.ENTER` |\n| Escape | `\\x1b` | `KeyEvent.ESCAPE` |\n| Tab | `\\t` | `KeyEvent.TAB` |\n\nThe keyboard listener is active only during step execution and is started/stopped by the visualization loop's `_keyboard_listener()` context manager. Currently, only UP, DOWN, and ENTER are handled by the approval interface; other events are ignored.\n\n**Sources:** [src/kimi_cli/ui/shell/keyboard.py:1-116](), [src/kimi_cli/ui/shell/visualize.py:23-40]()\n\n---\n\n## Markdown Rendering\n\nThe `StepLiveViewWithMarkdown` variant buffers text output and renders it as formatted markdown after tool calls or step completion. This provides better visual separation between reasoning and action.\n\n### Rendering Pipeline\n\n```mermaid\nflowchart LR\n    TextPart[\"TextPart\u003cbr/\u003eEvent\"] --\u003e Buffer[\"_pending_markdown_parts\u003cbr/\u003elist\"]\n    \n    Buffer --\u003e Trigger{Trigger?}\n    \n    Trigger --\u003e|ToolCall| Flush[\"_flush_markdown()\"]\n    Trigger --\u003e|Step End| Flush\n    \n    Flush --\u003e Markdown[\"_LeftAlignedMarkdown\u003cbr/\u003eRenderer\"]\n    Markdown --\u003e Console[\"console.print()\"]\n    \n    subgraph \"While Buffering\"\n        ShowStatus[\"Status:\u003cbr/\u003e'Thinking...'\"]\n    end\n    \n    Buffer --\u003e ShowStatus\n    Flush --\u003e HideStatus[\"Hide Status\"]\n```\n\n**Diagram: Markdown Buffering and Rendering**\n\nWhen text arrives, the system:\n1. Shows a \"Thinking...\" spinner status\n2. Buffers all text parts in `_pending_markdown_parts`\n3. On trigger (tool call or step end), flushes the buffer\n4. Renders the complete markdown with `_LeftAlignedMarkdown`\n5. Hides the thinking status\n\nThe `_LeftAlignedMarkdown` class extends Rich's `Markdown` renderer to left-align headings instead of centering them, providing a more code-friendly appearance.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:298-378]()\n\n---\n\n## Status Bar Display\n\nThe status bar appears at the bottom of the live view, showing context usage as a percentage:\n\n```\nText display...\nTool call progress...\n                                                          context: 45.2%\n```\n\nThe status is updated via `StatusUpdate` events from the Wire and formatted by the `_format_status()` method:\n\n```python\n# Bounds checking ensures 0.0 \u003c= usage \u003c= 1.0\nbounded = max(0.0, min(status.context_usage, 1.0))\nreturn f\"context: {bounded:.1%}\"\n```\n\nThe status bar is right-aligned and styled in grey (`grey50`). It can be disabled by setting `_status_text` to `None` during initialization.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:240-244](), [src/kimi_cli/ui/shell/liveview.py:292-295]()\n\n---\n\n## Rich Console Configuration\n\nThe visualization system uses a custom Rich console with a neutral markdown theme that removes default styling:\n\n```python\n_NEUTRAL_MARKDOWN_THEME = Theme({\n    \"markdown.paragraph\": \"none\",\n    \"markdown.h1\": \"none\",\n    \"markdown.h2\": \"none\",\n    # ... all markdown styles set to \"none\"\n    \"status.spinner\": \"none\",\n}, inherit=True)\n\nconsole = Console(highlight=False, theme=_NEUTRAL_MARKDOWN_THEME)\n```\n\nThis configuration:\n- Disables syntax highlighting to avoid false positives in agent output\n- Removes default markdown styling for custom control\n- Inherits other theme settings from Rich defaults\n- Allows the agent's markdown to display cleanly without rich text interference\n\n**Sources:** [src/kimi_cli/ui/shell/console.py:1-30]()\n\n---\n\n## Display Lifecycle\n\nEach agent step creates a new `StepLiveView` instance that manages the display for that step:\n\n```mermaid\nsequenceDiagram\n    participant Loop as visualize() loop\n    participant Step as StepLiveView\n    participant Live as Rich.Live\n    participant Console\n    \n    Loop-\u003e\u003eStep: __enter__()\n    Step-\u003e\u003eLive: __enter__()\n    Live-\u003e\u003eConsole: start live display\n    \n    loop Event Processing\n        Loop-\u003e\u003eStep: append_text/tool_call/etc.\n        Step-\u003e\u003eStep: _compose()\n        Step-\u003e\u003eLive: update(renderable)\n        Live-\u003e\u003eConsole: render frame\n    end\n    \n    Loop-\u003e\u003eStep: finish() or interrupt()\n    Step-\u003e\u003eStep: mark all incomplete\n    Step-\u003e\u003eLive: final update()\n    \n    Loop-\u003e\u003eStep: __exit__()\n    Step-\u003e\u003eLive: __exit__()\n    Live-\u003e\u003eConsole: stop live display\n    Note over Console: Last frame remains visible\n```\n\n**Diagram: StepLiveView Lifecycle**\n\nThe `transient=False` parameter in `Live()` initialization ensures the final frame remains visible after the step completes, creating a permanent record of the step's execution in the terminal scrollback.\n\nThe `_compose()` method builds the renderable by collecting all active display elements:\n1. Text buffer (current line being built)\n2. Buffer status (e.g., \"Thinking...\" spinner)\n3. All tool call displays\n4. Current approval request menu\n5. Status bar (if not empty)\n\nElements are composed into a `Group` for efficient rendering.\n\n**Sources:** [src/kimi_cli/ui/shell/liveview.py:147-178](), [src/kimi_cli/ui/shell/liveview.py:277-290]()\n\n---\n\n## Integration with Shell App\n\nThe live view is used exclusively in Shell mode and integrates with the main application through the `visualize()` coroutine:\n\n```python\n# In shell_app.py\nasync def run_agent():\n    # ... setup ...\n    async with asyncio.TaskGroup() as tg:\n        tg.create_task(soul.run(...))\n        tg.create_task(visualize(wire, initial_status=status))\n```\n\nThe visualization runs concurrently with the agent execution, consuming events from the shared Wire as they're produced. This architecture keeps the display logic completely separate from the agent execution logic.\n\n**Sources:** [src/kimi_cli/ui/shell/visualize.py:42-106]()"])</script><script>self.__next_f.push([1,"21:T2a5c,"])</script><script>self.__next_f.push([1,"# Print and ACP Modes\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/ui/print/__init__.py](src/kimi_cli/ui/print/__init__.py)\n- [src/kimi_cli/ui/shell/__init__.py](src/kimi_cli/ui/shell/__init__.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis page documents the non-interactive execution modes available in kimi-cli: **PrintApp** for command-line automation and scripting, and **ACP Server** for programmatic agent control via the Agent Client Protocol. These modes enable integration with external tools, CI/CD pipelines, and other automated systems.\n\nFor interactive terminal usage, see [Interactive Shell Mode](#4.1). For real-time visualization features, see [Live View and Visualization](#4.3).\n\n## Overview\n\nkimi-cli provides three distinct UI modes to accommodate different usage patterns:\n\n| Mode | Purpose | Interactive | I/O Handling | Approval |\n|------|---------|-------------|--------------|----------|\n| `ShellApp` | Human interaction | Yes | Rich terminal UI | User prompts |\n| `PrintApp` | Scripting/automation | No | Text/JSON streams | Auto-approved |\n| `ACPServer` | Programmatic control | No | HTTP/WebSocket | Client-defined |\n\n**Sources**: [src/kimi_cli/ui/shell/__init__.py](), [src/kimi_cli/ui/print/__init__.py](), [CHANGELOG.md:177-179]()\n\n## PrintApp: Non-Interactive Mode\n\n### Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Input Sources\"\n        CLI_ARG[\"Command-line argument\u003cbr/\u003ekimi --print 'task'\"]\n        STDIN[\"Standard input\u003cbr/\u003epiped text or JSON\"]\n    end\n    \n    subgraph \"PrintApp\"\n        InputParser[\"Input Parser\u003cbr/\u003e_read_next_command()\"]\n        FormatHandler[\"Format Handler\u003cbr/\u003etext | stream-json\"]\n        PrintAppClass[\"PrintApp\u003cbr/\u003eYOLO mode enabled\"]\n    end\n    \n    subgraph \"Execution\"\n        KimiSoul[\"KimiSoul\"]\n        Wire[\"Wire\u003cbr/\u003eEvent Queue\"]\n        Context[\"Context\u003cbr/\u003e_file_backend\"]\n    end\n    \n    subgraph \"Output Sinks\"\n        STDOUT_TEXT[\"Standard output\u003cbr/\u003etext format\"]\n        STDOUT_JSON[\"Standard output\u003cbr/\u003estream-json format\"]\n    end\n    \n    CLI_ARG --\u003e PrintAppClass\n    STDIN --\u003e InputParser\n    InputParser --\u003e FormatHandler\n    FormatHandler --\u003e PrintAppClass\n    \n    PrintAppClass --\u003e KimiSoul\n    KimiSoul --\u003e Wire\n    KimiSoul --\u003e Context\n    \n    Wire --\u003e Visualizer[\"_visualize_text() or\u003cbr/\u003e_visualize_stream_json()\"]\n    Context --\u003e Visualizer\n    \n    Visualizer --\u003e STDOUT_TEXT\n    Visualizer --\u003e STDOUT_JSON\n```\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:1-178]()\n\n### Input Formats\n\nThe `PrintApp` supports two input formats specified via `--input-format`:\n\n#### Text Format (`text`)\n\nReads plain text input from either:\n- Command-line argument: `kimi --print \"analyze this codebase\"`\n- Standard input pipe: `echo \"fix bug\" | kimi --print`\n\nWhen reading from stdin, the entire input is consumed as a single command [src/kimi_cli/ui/print/__init__.py:50-52]().\n\n#### Stream-JSON Format (`stream-json`)\n\nReads newline-delimited JSON messages conforming to the `Message` schema. Each line should contain a JSON object with:\n\n```json\n{\"role\": \"user\", \"content\": [{\"type\": \"text\", \"text\": \"command text\"}]}\n```\n\nThe parser:\n- Ignores empty lines [src/kimi_cli/ui/print/__init__.py:130-132]()\n- Filters messages where `role != \"user\"` [src/kimi_cli/ui/print/__init__.py:137-143]()\n- Extracts text content via `message_extract_text()` [src/kimi_cli/ui/print/__init__.py:138]()\n- Returns `None` on EOF to terminate [src/kimi_cli/ui/print/__init__.py:125-127]()\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:19-20,122-146](), [CHANGELOG.md:202-204]()\n\n### Output Formats\n\nThe `PrintApp` supports two output formats specified via `--output-format`:\n\n#### Text Format (`text`)\n\nPrints human-readable text to stdout as the agent executes:\n\n```mermaid\nsequenceDiagram\n    participant PrintApp\n    participant Wire\n    participant STDOUT\n    \n    PrintApp-\u003e\u003eWire: receive() events\n    loop For each event\n        Wire--\u003e\u003ePrintApp: Event message\n        PrintApp-\u003e\u003eSTDOUT: print(msg)\n    end\n    Note over PrintApp,STDOUT: Blocks until StepInterrupted\u003cbr/\u003eor QueueShutDown\n```\n\nEvents are printed as they arrive from the `Wire` event queue [src/kimi_cli/ui/print/__init__.py:147-155]().\n\n#### Stream-JSON Format (`stream-json`)\n\nOutputs newline-delimited JSON by tailing the context history file:\n\n1. Records the starting file position before execution [src/kimi_cli/ui/print/__init__.py:109]()\n2. Opens `_context._file_backend` in read mode [src/kimi_cli/ui/print/__init__.py:160]()\n3. Seeks to the recorded position [src/kimi_cli/ui/print/__init__.py:161]()\n4. Continuously reads and prints new lines [src/kimi_cli/ui/print/__init__.py:169-175]()\n\nThis format enables downstream tools to parse the complete message history including tool calls and results.\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:20,147-178](), [CHANGELOG.md:179]()\n\n### Automatic Approval\n\nUnlike `ShellApp`, `PrintApp` automatically approves all tool executions by setting YOLO mode:\n\n```python\nself.soul._approval.set_yolo(True)\n```\n\nThis behavior is documented at [src/kimi_cli/ui/print/__init__.py:37]() and ensures non-interactive execution without blocking on approval prompts. Tools like `Bash`, `WriteFile`, and `StrReplaceFile` that normally require user confirmation execute immediately.\n\n**Note**: A proper approval request handling mechanism is planned (see TODO comment at [src/kimi_cli/ui/print/__init__.py:38]()).\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:37-38](), [CHANGELOG.md:49]()\n\n### Error Handling\n\n`PrintApp` handles execution errors by printing to stdout and returning `False`:\n\n| Exception | Output | Return Value |\n|-----------|--------|--------------|\n| `LLMNotSet` | \"LLM not set\" | `False` |\n| `ChatProviderError` | \"LLM provider error: {e}\" | `False` |\n| `MaxStepsReached` | \"Max steps reached: {n_steps}\" | `False` |\n| `RunCancelled` | \"Interrupted by user\" | `False` |\n| Other exceptions | \"Unknown error: {e}\" | Re-raises |\n\nThe error handling logic is implemented in [src/kimi_cli/ui/print/__init__.py:78-96]().\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:78-96]()\n\n## Agent Client Protocol (ACP) Server Mode\n\n### Protocol Overview\n\nThe ACP Server mode exposes kimi-cli functionality through a standardized HTTP/WebSocket interface conforming to the Agent Client Protocol specification (version 0.4.9+).\n\n```mermaid\ngraph LR\n    subgraph \"External Clients\"\n        IDE[\"IDE Extensions\"]\n        Automation[\"Automation Scripts\"]\n        ChatUI[\"Chat Interfaces\"]\n    end\n    \n    subgraph \"ACP Server\"\n        HTTPEndpoints[\"HTTP Endpoints\u003cbr/\u003e/acp/*\"]\n        WebSocket[\"WebSocket\u003cbr/\u003eReal-time events\"]\n        ACPImpl[\"ACPAgentImpl\u003cbr/\u003eProtocol handler\"]\n    end\n    \n    subgraph \"Agent Core\"\n        KimiSoul[\"KimiSoul\"]\n        Wire[\"Wire\"]\n        Context[\"Context\"]\n    end\n    \n    IDE --\u003e HTTPEndpoints\n    Automation --\u003e HTTPEndpoints\n    ChatUI --\u003e WebSocket\n    \n    HTTPEndpoints --\u003e ACPImpl\n    WebSocket --\u003e ACPImpl\n    \n    ACPImpl --\u003e KimiSoul\n    KimiSoul --\u003e Wire\n    KimiSoul --\u003e Context\n    \n    Wire --\u003e ACPImpl\n```\n\n### Invocation\n\nStart the ACP server using either:\n\n```bash\nkimi --ui acp\n# or shorthand:\nkimi --acp\n```\n\nThe server listens for HTTP requests and WebSocket connections, translating them into `KimiSoul` execution requests.\n\n**Sources**: [CHANGELOG.md:197-198,177-178](), [pyproject.toml:8]()\n\n### Protocol Features\n\nThe ACP protocol provides:\n\n- **Session Management**: Create, resume, and list agent sessions\n- **Message Submission**: Send user messages and receive agent responses\n- **Real-time Streaming**: WebSocket events for live execution updates\n- **Cancellation**: Interrupt long-running agent executions\n- **Tool Control**: Configure which tools are available to the agent\n\nThe protocol is implemented using the `agent-client-protocol` Python package (version 0.4.9+) as documented in [pyproject.toml:8]().\n\n**Sources**: [pyproject.toml:8](), [CHANGELOG.md:157,197-198]()\n\n### Comparison with PrintApp\n\n| Feature | PrintApp | ACP Server |\n|---------|----------|------------|\n| Protocol | stdin/stdout | HTTP/WebSocket |\n| State Management | Single execution | Multi-session |\n| Client Type | Shell scripts | Any HTTP client |\n| Streaming | Line-buffered | Real-time events |\n| Cancellation | SIGINT | Protocol-level cancel |\n| Approval | Auto-approved | Client-controlled |\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py](), [CHANGELOG.md:197-198]()\n\n## Usage Examples\n\n### PrintApp Text Mode\n\n```bash\n# Direct command execution\nkimi --print \"analyze the codebase structure\"\n\n# Piped input\necho \"fix the bug in authentication\" | kimi --print\n\n# Stream JSON input with text output\ncat commands.jsonl | kimi --print --input-format stream-json\n```\n\n### PrintApp JSON Mode\n\n```bash\n# Output complete message history as JSON\nkimi --print \"implement feature X\" --output-format stream-json \u003e history.jsonl\n\n# Pipeline processing\ncat input.jsonl | kimi --print \\\n  --input-format stream-json \\\n  --output-format stream-json \\\n  \u003e output.jsonl\n```\n\n### ACP Server Mode\n\n```bash\n# Start server\nkimi --acp\n\n# Then from another terminal or script:\ncurl -X POST http://localhost:8000/acp/sessions \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"message\": {\"role\": \"user\", \"content\": \"help me\"}}'\n```\n\n**Sources**: [CHANGELOG.md:177-179,197-198,202-204]()\n\n## Implementation Notes\n\n### Signal Handling\n\nBoth `PrintApp` and `ACPServer` register SIGINT handlers to enable graceful cancellation:\n\n1. Register handler on loop start [src/kimi_cli/ui/print/__init__.py:43-48]()\n2. Handler sets `cancel_event` which propagates to `run_soul()`\n3. Cleanup removes signal handler in finally block [src/kimi_cli/ui/print/__init__.py:95]()\n\nThis allows `Ctrl-C` to interrupt execution without abrupt process termination.\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:40-48,94-95]()\n\n### Visualization Loop Pattern\n\nThe visualization pattern used across both modes:\n\n```mermaid\nsequenceDiagram\n    participant App as PrintApp/ACPServer\n    participant Task as Visualization Task\n    participant Wire\n    participant Soul as KimiSoul\n    \n    App-\u003e\u003eTask: create_task(visualize)\n    App-\u003e\u003eSoul: run(user_input, wire)\n    \n    par Execution\n        Soul-\u003e\u003eWire: send events\n    and Visualization\n        Task-\u003e\u003eWire: receive events\n        Task-\u003e\u003eTask: process \u0026 output\n    end\n    \n    Soul--\u003e\u003eApp: Execution complete\n    App-\u003e\u003eWire: shutdown()\n    App-\u003e\u003eTask: wait_for(timeout=0.5)\n    Note over App,Task: Ensures visualization cleanup\n```\n\nThe `Wire` shutdown signal ensures visualization tasks terminate cleanly without hanging [src/kimi_cli/ui/print/__init__.py:115-120]().\n\n**Sources**: [src/kimi_cli/ui/print/__init__.py:98-121]()"])</script><script>self.__next_f.push([1,"22:T3cb7,"])</script><script>self.__next_f.push([1,"# Agent Configuration\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/agents/koder/agent.yaml](src/kimi_cli/agents/koder/agent.yaml)\n- [src/kimi_cli/agents/koder/sub.yaml](src/kimi_cli/agents/koder/sub.yaml)\n- [src/kimi_cli/tools/web/__init__.py](src/kimi_cli/tools/web/__init__.py)\n- [src/kimi_cli/tools/web/fetch.md](src/kimi_cli/tools/web/fetch.md)\n\n\u003c/details\u003e\n\n\n\nThis document provides an overview of how agents are defined, configured, and loaded in kimi-cli. Agent configuration uses YAML specifications that define an agent's identity, system prompt, available tools, and relationships to subagents.\n\nFor detailed information about the YAML specification format and all available configuration options, see [Agent Specification Format](#5.1). For information about how agents are loaded and initialized at runtime, see [Agent Loading and Initialization](#5.2). For information about configuring subagents and task delegation, see [Subagents and Task Delegation](#5.3).\n\n## Overview\n\nAgent configuration in kimi-cli follows a declarative approach using YAML files. Each agent is defined by:\n\n- **Identity**: A name and role definition\n- **System Prompt**: A markdown template that defines the agent's behavior\n- **Tools**: A list of capabilities the agent can use\n- **Subagents**: Optional specialized agents for delegation\n- **Extension**: Ability to inherit from other agent configurations\n\nThe configuration system supports agent extension, tool exclusion, template variable substitution, and hierarchical subagent definitions. All agent specifications are loaded through the `_load_agent_spec()` function and instantiated using `load_agent()`.\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml](), [src/kimi_cli/agents/koder/sub.yaml](), [tests/test_load_agent.py:1-230]()\n\n## Agent Configuration Components\n\n```mermaid\ngraph TB\n    subgraph \"YAML Configuration Files\"\n        AgentYAML[\"agent.yaml\u003cbr/\u003eMain configuration\"]\n        SubYAML[\"sub.yaml\u003cbr/\u003eSubagent configuration\"]\n        SystemMD[\"system.md\u003cbr/\u003eSystem prompt template\"]\n        AgentsMD[\"AGENTS.md\u003cbr/\u003eProject metadata\"]\n    end\n    \n    subgraph \"Configuration Objects\"\n        AgentSpec[\"AgentSpec\u003cbr/\u003eParsed YAML data\"]\n        Agent[\"Agent\u003cbr/\u003eRuntime instance\"]\n    end\n    \n    subgraph \"Core Classes\"\n        LoadAgentSpec[\"_load_agent_spec()\u003cbr/\u003esrc/kimi_cli/agent.py\"]\n        LoadAgent[\"load_agent()\u003cbr/\u003esrc/kimi_cli/agent.py\"]\n        LoadSystemPrompt[\"_load_system_prompt()\u003cbr/\u003eTemplate rendering\"]\n        LoadTools[\"_load_tools()\u003cbr/\u003eTool instantiation\"]\n    end\n    \n    subgraph \"Runtime Dependencies\"\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003eDependency container\"]\n        BuiltinArgs[\"BuiltinSystemPromptArgs\u003cbr/\u003eKIMI_* variables\"]\n        Config[\"Config\u003cbr/\u003eLLM \u0026 service config\"]\n        Session[\"Session\u003cbr/\u003eContext \u0026 history\"]\n        Approval[\"Approval\u003cbr/\u003eUser consent\"]\n        DenwaRenji[\"DenwaRenji\u003cbr/\u003eTime-travel system\"]\n    end\n    \n    subgraph \"Tools\"\n        CustomToolset[\"CustomToolset\u003cbr/\u003eTool registry\"]\n        ToolInstances[\"Tool Instances\u003cbr/\u003eReadFile, WriteFile, etc.\"]\n    end\n    \n    AgentYAML --\u003e LoadAgentSpec\n    SubYAML --\u003e LoadAgentSpec\n    LoadAgentSpec --\u003e AgentSpec\n    \n    AgentSpec --\u003e LoadAgent\n    SystemMD --\u003e LoadSystemPrompt\n    AgentsMD --\u003e BuiltinArgs\n    \n    LoadAgent --\u003e LoadSystemPrompt\n    LoadAgent --\u003e LoadTools\n    \n    AgentGlobals --\u003e LoadAgent\n    Config --\u003e AgentGlobals\n    Session --\u003e AgentGlobals\n    Approval --\u003e AgentGlobals\n    DenwaRenji --\u003e AgentGlobals\n    BuiltinArgs --\u003e AgentGlobals\n    \n    LoadTools --\u003e CustomToolset\n    CustomToolset --\u003e ToolInstances\n    ToolInstances --\u003e Agent\n    \n    LoadSystemPrompt --\u003e Agent\n    AgentSpec --\u003e Agent\n```\n\n**Diagram: Agent Configuration Loading Architecture**\n\nThis diagram shows how YAML configuration files are parsed into `AgentSpec` objects, then instantiated into runtime `Agent` objects with their system prompts and tools. The `AgentGlobals` container provides all necessary dependencies for tool instantiation.\n\n**Sources**: [tests/conftest.py:98-114](), [tests/test_load_agent.py:29-36](), [src/kimi_cli/agents/koder/agent.yaml:1-25]()\n\n## YAML Configuration Structure\n\nAgent YAML files follow a versioned schema. The current version (1) defines the following top-level structure:\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `version` | integer | Yes | Schema version (currently 1) |\n| `agent` | object | Yes | Agent specification object |\n\nThe `agent` object contains:\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `name` | string | Yes | Agent display name |\n| `system_prompt_path` | string | Yes | Path to system prompt markdown file |\n| `system_prompt_args` | object | No | Template variables for prompt substitution |\n| `tools` | list[string] | Yes | List of tool module paths |\n| `exclude_tools` | list[string] | No | Tools to exclude (for extension) |\n| `subagents` | object | No | Subagent definitions |\n| `extend` | string | No | Path to parent agent YAML |\n\n**Example from the default koder agent**:\n\n```yaml\nversion: 1\nagent:\n  name: \"\"\n  system_prompt_path: ./system.md\n  system_prompt_args:\n    ROLE_ADDITIONAL: \"\"\n  tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.think:Think\"\n    - \"kimi_cli.tools.bash:Bash\"\n    # ... more tools\n  subagents:\n    koder:\n      path: ./sub.yaml\n      description: \"Good at general software engineering tasks.\"\n```\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:1-25](), [tests/test_load_agent.py:207-222]()\n\n## Agent Extension Mechanism\n\n```mermaid\nflowchart TD\n    Start[\"Load agent.yaml\"] --\u003e CheckExtend{\"Has 'extend'\u003cbr/\u003efield?\"}\n    \n    CheckExtend --\u003e|No| Parse[\"Parse as AgentSpec\"]\n    CheckExtend --\u003e|Yes| LoadBase[\"Load base agent\"]\n    \n    LoadBase --\u003e DefaultCheck{\"extend == 'default'?\"}\n    DefaultCheck --\u003e|Yes| LoadDefault[\"Load DEFAULT_AGENT_FILE\"]\n    DefaultCheck --\u003e|No| LoadPath[\"Load from specified path\"]\n    \n    LoadDefault --\u003e Merge\n    LoadPath --\u003e Merge\n    \n    Merge[\"Merge configurations:\u003cbr/\u003e1. Start with base\u003cbr/\u003e2. Override with child\u003cbr/\u003e3. Merge system_prompt_args\u003cbr/\u003e4. Apply exclude_tools\"]\n    \n    Merge --\u003e Parse\n    Parse --\u003e Validate[\"Validate:\u003cbr/\u003e- name required\u003cbr/\u003e- system_prompt_path required\u003cbr/\u003e- tools required\"]\n    \n    Validate --\u003e Success[\"Return AgentSpec\"]\n    \n    style Merge fill:#f9f9f9\n    style Validate fill:#f9f9f9\n```\n\n**Diagram: Agent Extension Resolution Flow**\n\nThe extension mechanism allows agents to inherit configuration from a base agent. The special value `\"default\"` refers to the built-in koder agent. Child configurations override parent values, with special merge logic for `system_prompt_args` (merged) and tool lists (exclude_tools applied).\n\n**Sources**: [tests/test_load_agent.py:65-120](), [src/kimi_cli/agents/koder/sub.yaml:1-12]()\n\n## AgentGlobals: Dependency Injection Container\n\nThe `AgentGlobals` class serves as the primary dependency injection container for agent loading and tool instantiation. It aggregates all runtime dependencies that tools may need:\n\n```mermaid\ngraph LR\n    subgraph \"AgentGlobals Fields\"\n        Config1[\"config: Config\"]\n        LLM1[\"llm: LLM\"]\n        BuiltinArgs1[\"builtin_args:\u003cbr/\u003eBuiltinSystemPromptArgs\"]\n        DenwaRenji1[\"denwa_renji:\u003cbr/\u003eDenwaRenji\"]\n        Session1[\"session: Session\"]\n        Approval1[\"approval: Approval\"]\n    end\n    \n    subgraph \"Dependency Types Available\"\n        AgentGlobalsType[\"AgentGlobals\"]\n        ConfigType[\"Config\"]\n        BuiltinArgsType[\"BuiltinSystemPromptArgs\"]\n        SessionType[\"Session\"]\n        DenwaRenjiType[\"DenwaRenji\"]\n        ApprovalType[\"Approval\"]\n    end\n    \n    subgraph \"Tool Constructor\"\n        ToolInit[\"__init__(...dependencies...)\"]\n        AutoInject[\"Automatic dependency\u003cbr/\u003eresolution by type\"]\n    end\n    \n    Config1 --\u003e ConfigType\n    LLM1 -.-\u003e ConfigType\n    BuiltinArgs1 --\u003e BuiltinArgsType\n    DenwaRenji1 --\u003e DenwaRenjiType\n    Session1 --\u003e SessionType\n    Approval1 --\u003e ApprovalType\n    \n    AgentGlobalsType --\u003e AutoInject\n    ConfigType --\u003e AutoInject\n    BuiltinArgsType --\u003e AutoInject\n    SessionType --\u003e AutoInject\n    DenwaRenjiType --\u003e AutoInject\n    ApprovalType --\u003e AutoInject\n    \n    AutoInject --\u003e ToolInit\n```\n\n**Diagram: AgentGlobals Dependency Injection**\n\nWhen tools are instantiated via `_load_tools()`, their constructor signatures are inspected. Any parameters with types matching the dependency map are automatically injected. This allows tools to declare their dependencies without manual wiring.\n\n**Sources**: [tests/conftest.py:98-114](), [tests/test_load_agent.py:132-151]()\n\n## System Prompt Template Substitution\n\nSystem prompts are markdown files with template variable substitution using `${VARIABLE_NAME}` syntax. The `_load_system_prompt()` function performs substitution using two sources:\n\n1. **Built-in Arguments** (`BuiltinSystemPromptArgs`):\n   - `${KIMI_NOW}`: Current timestamp\n   - `${KIMI_WORK_DIR}`: Working directory path\n   - `${KIMI_WORK_DIR_LS}`: Directory listing\n   - `${KIMI_AGENTS_MD}`: Contents of AGENTS.md file\n\n2. **Custom Arguments** (`system_prompt_args` from YAML):\n   - User-defined variables specific to the agent\n   - Example: `${ROLE_ADDITIONAL}` for subagent role modification\n\n**Template Example**:\n\n```markdown\nYou are a coding assistant. The current time is ${KIMI_NOW}.\nYour working directory is ${KIMI_WORK_DIR}.\n\n${ROLE_ADDITIONAL}\n```\n\n**Sources**: [tests/test_load_agent.py:122-130](), [tests/conftest.py:65-72](), [src/kimi_cli/agents/koder/sub.yaml:4-6]()\n\n## Tool Path Specification\n\nTools are specified using Python module path notation in the format `\"module.path:ClassName\"`. The tool loading system:\n\n1. Imports the specified module\n2. Retrieves the class by name\n3. Inspects the constructor signature\n4. Automatically injects dependencies from the dependency map\n5. Instantiates and registers the tool with `CustomToolset`\n\n**Common Tool Paths**:\n\n| Tool Path | Tool Class | Purpose |\n|-----------|------------|---------|\n| `kimi_cli.tools.task:Task` | Task | Subagent delegation |\n| `kimi_cli.tools.think:Think` | Think | Reasoning output |\n| `kimi_cli.tools.bash:Bash` | Bash | Shell command execution |\n| `kimi_cli.tools.file:ReadFile` | ReadFile | Read file contents |\n| `kimi_cli.tools.file:WriteFile` | WriteFile | Write file contents |\n| `kimi_cli.tools.file:StrReplaceFile` | StrReplaceFile | String replacement in files |\n| `kimi_cli.tools.web:SearchWeb` | SearchWeb | Web search |\n| `kimi_cli.tools.web:FetchURL` | FetchURL | Fetch web content |\n\nFailed tool imports are collected and reported as errors during agent loading.\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:8-20](), [tests/test_load_agent.py:132-172](), [tests/conftest.py:11-35]()\n\n## Main Agent vs. Subagent Configuration\n\nThe kimi-cli system distinguishes between main agents and subagents with different configuration characteristics:\n\n| Aspect | Main Agent | Subagent |\n|--------|------------|----------|\n| Configuration File | `agent.yaml` | `sub.yaml` |\n| Extension | Typically from default or custom | Always extends main agent |\n| Task Tool | Included | Excluded via `exclude_tools` |\n| SendDMail Tool | Included | Excluded via `exclude_tools` |\n| SetTodoList Tool | Included | Excluded via `exclude_tools` |\n| Subagents | Can have subagents | Cannot have subagents |\n| ROLE_ADDITIONAL | Empty or main role | Contains subagent context message |\n\n**Subagent-Specific Configuration Pattern**:\n\n```yaml\nversion: 1\nagent:\n  extend: ./agent.yaml\n  system_prompt_args:\n    ROLE_ADDITIONAL: |\n      You are now running as a subagent. All the `user` messages \n      are sent by the main agent. The main agent cannot see your \n      context...\n  exclude_tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.dmail:SendDMail\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n  subagents: # explicitly empty\n```\n\nThis pattern prevents infinite delegation loops and maintains clean separation between main agent orchestration and subagent execution.\n\n**Sources**: [src/kimi_cli/agents/koder/sub.yaml:1-12](), [src/kimi_cli/agents/koder/agent.yaml:21-24]()\n\n## Configuration Loading Flow\n\n```mermaid\nsequenceDiagram\n    participant CLI as CLI Entry Point\n    participant LoadAgent as load_agent()\n    participant LoadSpec as _load_agent_spec()\n    participant LoadPrompt as _load_system_prompt()\n    participant LoadTools as _load_tools()\n    participant AgentGlobals\n    participant ToolClass as Tool Class\n    \n    CLI-\u003e\u003eLoadAgent: agent_file, agent_globals\n    LoadAgent-\u003e\u003eLoadSpec: agent_file\n    \n    alt Has extend field\n        LoadSpec-\u003e\u003eLoadSpec: Load base agent\n        LoadSpec-\u003e\u003eLoadSpec: Merge configurations\n    end\n    \n    LoadSpec--\u003e\u003eLoadAgent: AgentSpec\n    \n    LoadAgent-\u003e\u003eLoadAgent: Validate name, prompt, tools\n    \n    LoadAgent-\u003e\u003eLoadPrompt: system_prompt_path,\u003cbr/\u003esystem_prompt_args,\u003cbr/\u003ebuiltin_args\n    LoadPrompt-\u003e\u003eLoadPrompt: Read markdown file\n    LoadPrompt-\u003e\u003eLoadPrompt: Substitute ${VARIABLES}\n    LoadPrompt--\u003e\u003eLoadAgent: Rendered prompt\n    \n    LoadAgent-\u003e\u003eLoadTools: tool_paths, dependency_map\n    \n    loop For each tool path\n        LoadTools-\u003e\u003eLoadTools: Import module\n        LoadTools-\u003e\u003eLoadTools: Get class\n        LoadTools-\u003e\u003eToolClass: Inspect __init__ signature\n        \n        loop For each parameter\n            ToolClass-\u003e\u003eAgentGlobals: Get dependency by type\n            AgentGlobals--\u003e\u003eToolClass: Dependency instance\n        end\n        \n        LoadTools-\u003e\u003eToolClass: Instantiate with dependencies\n        ToolClass--\u003e\u003eLoadTools: Tool instance\n        LoadTools-\u003e\u003eLoadTools: Register with CustomToolset\n    end\n    \n    LoadTools--\u003e\u003eLoadAgent: CustomToolset, bad_tools\n    \n    alt bad_tools not empty\n        LoadAgent-\u003e\u003eCLI: Raise ValueError\n    end\n    \n    LoadAgent-\u003e\u003eLoadAgent: Create Agent instance\n    LoadAgent--\u003e\u003eCLI: Agent\n```\n\n**Diagram: Agent Configuration Loading Sequence**\n\nThis sequence diagram shows the complete flow from CLI invocation to Agent instantiation, including extension resolution, prompt rendering, and tool loading with dependency injection.\n\n**Sources**: [tests/test_load_agent.py:29-36](), [tests/test_load_agent.py:65-73](), [tests/test_load_agent.py:122-130](), [tests/test_load_agent.py:132-151]()\n\n## Error Handling and Validation\n\nThe agent loading system performs comprehensive validation:\n\n**Validation Rules**:\n\n1. **Version Check**: Only version 1 is supported\n2. **Required Fields**: `name`, `system_prompt_path`, and `tools` must be present\n3. **File Existence**: Agent YAML and system prompt files must exist\n4. **Tool Loading**: All tool imports must succeed (invalid tools cause ValueError)\n5. **Extension Resolution**: Base agent files must exist and be valid\n\n**Common Error Scenarios**:\n\n| Error | Condition | Exception |\n|-------|-----------|-----------|\n| Unsupported version | `version != 1` | ValueError |\n| Missing name | `agent.name` is empty or None | ValueError |\n| Missing prompt path | `system_prompt_path` not specified | ValueError |\n| Missing tools | `tools` list is empty or None | ValueError |\n| Invalid tools | Tool import fails | ValueError |\n| File not found | Agent YAML doesn't exist | AssertionError |\n\n**Sources**: [tests/test_load_agent.py:38-53](), [tests/test_load_agent.py:201-229]()"])</script><script>self.__next_f.push([1,"23:T49c7,"])</script><script>self.__next_f.push([1,"# Agent Specification Format\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/agents/koder/agent.yaml](src/kimi_cli/agents/koder/agent.yaml)\n- [src/kimi_cli/agents/koder/sub.yaml](src/kimi_cli/agents/koder/sub.yaml)\n- [src/kimi_cli/tools/web/__init__.py](src/kimi_cli/tools/web/__init__.py)\n- [src/kimi_cli/tools/web/fetch.md](src/kimi_cli/tools/web/fetch.md)\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name, system prompt, available tools, and subagent configurations. \n\nFor information about how agents are loaded and initialized at runtime, see [Agent Loading and Initialization](#5.2). For details on configuring and using subagents for task delegation, see [Subagents and Task Delegation](#5.3).\n\n---\n\n## Overview\n\nAgents in kimi-cli are defined using YAML configuration files that specify all aspects of agent behavior. The system supports agent extension (inheritance), allowing agents to build upon existing configurations. Each agent specification references a system prompt markdown file and declares which tools the agent can use.\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:1-25](), [src/kimi_cli/agents/koder/sub.yaml:1-12]()\n\n---\n\n## YAML File Structure\n\n### Basic Schema\n\nAll agent specifications follow a consistent top-level structure:\n\n```yaml\nversion: 1\nagent:\n  # Agent configuration fields\n```\n\nThe `version` field must be set to `1` (currently the only supported version). The `agent` section contains all agent configuration fields.\n\n**Sources**: [tests/test_load_agent.py:213-222]()\n\n### Minimum Required Fields\n\nA valid agent specification requires three mandatory fields:\n\n| Field | Type | Description | Required |\n|-------|------|-------------|----------|\n| `name` | string | Human-readable agent name | Yes |\n| `system_prompt_path` | path | Relative path to system prompt markdown file | Yes |\n| `tools` | list[string] | List of tool module paths | Yes |\n\n**Example minimal agent**:\n```yaml\nversion: 1\nagent:\n  name: \"My Agent\"\n  system_prompt_path: ./system.md\n  tools:\n    - \"kimi_cli.tools.think:Think\"\n```\n\n**Sources**: [tests/test_load_agent.py:236-256](), [tests/test_load_agent.py:38-53]()\n\n---\n\n## Core Configuration Fields\n\n### Agent Name\n\nThe `name` field identifies the agent. It can be an empty string for unnamed agents but the field must be present.\n\n```yaml\nagent:\n  name: \"Kimi Koder\"\n```\n\nEmpty names are used for subagents that inherit their context from parent agents:\n\n```yaml\nagent:\n  name: \"\"  # Valid for extending agents\n  extend: ./agent.yaml\n```\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:3](), [tests/test_load_agent.py:38-41]()\n\n### System Prompt Path\n\nThe `system_prompt_path` specifies a relative path to a markdown file containing the agent's system prompt. The path is resolved relative to the agent YAML file location.\n\n```yaml\nagent:\n  system_prompt_path: ./system.md\n```\n\nSystem prompts support template variable substitution (see Template Variables section below).\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:4](), [tests/test_load_agent.py:44-47]()\n\n### Tools List\n\nThe `tools` field declares which tools the agent can use. Each tool is specified using the format `module.path:ClassName`.\n\n```yaml\nagent:\n  tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.think:Think\"\n    - \"kimi_cli.tools.bash:Bash\"\n    - \"kimi_cli.tools.file:ReadFile\"\n    - \"kimi_cli.tools.web:SearchWeb\"\n```\n\n**Standard tool modules**:\n\n| Module Path | Available Tools |\n|-------------|-----------------|\n| `kimi_cli.tools.task` | `Task` |\n| `kimi_cli.tools.think` | `Think` |\n| `kimi_cli.tools.todo` | `SetTodoList` |\n| `kimi_cli.tools.bash` | `Bash` |\n| `kimi_cli.tools.file` | `ReadFile`, `WriteFile`, `StrReplaceFile`, `PatchFile`, `Glob`, `Grep` |\n| `kimi_cli.tools.web` | `SearchWeb`, `FetchURL` |\n| `kimi_cli.tools.dmail` | `SendDMail` |\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:7-20](), [tests/conftest.py:23-35]()\n\n---\n\n## System Prompt Arguments\n\n### Template Variable Substitution\n\nSystem prompts support template variable substitution using `${VARIABLE_NAME}` syntax. Variables are provided via the `system_prompt_args` field:\n\n```yaml\nagent:\n  system_prompt_path: ./system.md\n  system_prompt_args:\n    ROLE_ADDITIONAL: \"You are an expert Python developer.\"\n    CUSTOM_VAR: \"custom value\"\n```\n\nIf `system.md` contains:\n```markdown\nYou are an AI assistant. ${ROLE_ADDITIONAL}\nCustom configuration: ${CUSTOM_VAR}\n```\n\nThe resolved prompt becomes:\n```markdown\nYou are an AI assistant. You are an expert Python developer.\nCustom configuration: custom value\n```\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:5-6](), [tests/test_load_agent.py:122-129]()\n\n### Builtin Template Variables\n\nThe system automatically provides builtin variables that are always available:\n\n| Variable | Description | Example Value |\n|----------|-------------|---------------|\n| `KIMI_NOW` | Current timestamp | `2024-01-15T10:30:00+00:00` |\n| `KIMI_WORK_DIR` | Current working directory path | `/home/user/project` |\n| `KIMI_WORK_DIR_LS` | Directory listing of work dir | File listing output |\n| `KIMI_AGENTS_MD` | Contents of AGENTS.md if present | Project agent documentation |\n\nThese variables are automatically injected and do not need to be declared in `system_prompt_args`.\n\n**Sources**: [tests/conftest.py:65-72]()\n\n### Multi-line Arguments\n\nFor longer text values, use YAML multi-line string syntax:\n\n```yaml\nagent:\n  system_prompt_args:\n    ROLE_ADDITIONAL: |\n      You are now running as a subagent. All the `user` messages are sent by the main agent.\n      The main agent cannot see your context, it can only see your last message when you finish the task.\n      You need to provide a comprehensive summary on what you have done and learned in your final message.\n```\n\n**Sources**: [src/kimi_cli/agents/koder/sub.yaml:4-6]()\n\n---\n\n## Tool Configuration\n\n### Excluding Tools\n\nThe `exclude_tools` field removes specific tools from the agent's toolset. This is useful when extending an agent but wanting to restrict certain capabilities:\n\n```yaml\nagent:\n  extend: ./agent.yaml\n  exclude_tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.dmail:SendDMail\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n```\n\nThe exclusion is processed after tool loading, so an agent can inherit all parent tools and selectively remove some.\n\n**Sources**: [src/kimi_cli/agents/koder/sub.yaml:7-10](), [tests/test_load_agent.py:56-62]()\n\n### Tool Loading Process\n\n```mermaid\ngraph TD\n    YAMLSpec[\"Agent YAML Spec\"]\n    ExtendCheck{\"extend field\u003cbr/\u003epresent?\"}\n    LoadBase[\"Load Base Agent Spec\"]\n    MergeTools[\"Merge tools list\"]\n    ParseTools[\"Parse tool strings\u003cbr/\u003emodule:ClassName\"]\n    ExcludeCheck{\"exclude_tools\u003cbr/\u003epresent?\"}\n    RemoveTools[\"Remove excluded tools\"]\n    InstantiateTools[\"Instantiate tool classes\u003cbr/\u003ewith dependencies\"]\n    CustomToolset[\"CustomToolset instance\"]\n    \n    YAMLSpec --\u003e ExtendCheck\n    ExtendCheck --\u003e|Yes| LoadBase\n    ExtendCheck --\u003e|No| ParseTools\n    LoadBase --\u003e MergeTools\n    MergeTools --\u003e ParseTools\n    ParseTools --\u003e ExcludeCheck\n    ExcludeCheck --\u003e|Yes| RemoveTools\n    ExcludeCheck --\u003e|No| InstantiateTools\n    RemoveTools --\u003e InstantiateTools\n    InstantiateTools --\u003e CustomToolset\n```\n\n**Tool instantiation with dependency injection**: Tools are instantiated with required dependencies automatically injected based on their constructor parameters. Available dependency types include `AgentGlobals`, `Config`, `BuiltinSystemPromptArgs`, `Session`, `DenwaRenji`, and `Approval`.\n\n**Sources**: [tests/test_load_agent.py:132-172](), [tests/conftest.py:98-114]()\n\n---\n\n## Agent Extension\n\n### Extending Existing Agents\n\nAgents can extend other agents using the `extend` field, creating an inheritance-like relationship. The extending agent inherits all configuration from the base agent and can override specific fields:\n\n```yaml\nversion: 1\nagent:\n  extend: ./agent.yaml\n  system_prompt_args:\n    ROLE_ADDITIONAL: \"Modified role instructions\"\n  exclude_tools:\n    - \"kimi_cli.tools.task:Task\"\n```\n\n### Extension Resolution\n\n```mermaid\ngraph LR\n    ExtendingAgent[\"Extending Agent YAML\"]\n    ExtendValue{\"extend value\"}\n    BaseAgent[\"Base Agent YAML\"]\n    DefaultAgent[\"DEFAULT_AGENT_FILE\"]\n    MergeFields[\"Merge Configuration Fields\"]\n    ResolvedSpec[\"Resolved AgentSpec\"]\n    \n    ExtendingAgent --\u003e ExtendValue\n    ExtendValue --\u003e|\"./path.yaml\"| BaseAgent\n    ExtendValue --\u003e|\"default\"| DefaultAgent\n    BaseAgent --\u003e MergeFields\n    DefaultAgent --\u003e MergeFields\n    ExtendingAgent --\u003e MergeFields\n    MergeFields --\u003e ResolvedSpec\n```\n\n**Merge behavior**:\n- `name`: Override if specified, otherwise inherit\n- `system_prompt_path`: Override if specified, otherwise inherit\n- `system_prompt_args`: Merge dictionaries, child values override parent\n- `tools`: Override if specified, otherwise inherit\n- `exclude_tools`: Override if specified, otherwise inherit\n- `subagents`: Override if specified, otherwise inherit\n\n**Sources**: [tests/test_load_agent.py:65-73](), [tests/test_load_agent.py:75-120]()\n\n### Default Extension\n\nThe special value `\"default\"` for `extend` references the built-in default agent configuration:\n\n```yaml\nversion: 1\nagent:\n  extend: default\n  system_prompt_args:\n    CUSTOM_ARG: \"custom_value\"\n```\n\nThis loads the default agent from `DEFAULT_AGENT_FILE` and applies overrides.\n\n**Sources**: [tests/test_load_agent.py:75-120]()\n\n---\n\n## Subagent Definitions\n\n### Subagent Configuration\n\nAgents can define subagents for task delegation using the `subagents` field. Each subagent has a name (used for delegation) and configuration:\n\n```yaml\nagent:\n  name: \"Main Agent\"\n  tools:\n    - \"kimi_cli.tools.task:Task\"  # Required for delegation\n  subagents:\n    koder:\n      path: ./sub.yaml\n      description: \"Good at general software engineering tasks.\"\n```\n\n### Subagent Specification Structure\n\n```mermaid\ngraph TB\n    MainAgent[\"Main Agent\u003cbr/\u003eagent.yaml\"]\n    SubagentDef[\"subagents section\"]\n    SubagentSpec[\"Subagent YAML\u003cbr/\u003esub.yaml\"]\n    ExtendMain[\"extend: ./agent.yaml\"]\n    ModifiedPrompt[\"Modified system_prompt_args\"]\n    RestrictedTools[\"exclude_tools\"]\n    \n    MainAgent --\u003e SubagentDef\n    SubagentDef --\u003e|\"path\"| SubagentSpec\n    SubagentSpec --\u003e ExtendMain\n    ExtendMain --\u003e MainAgent\n    SubagentSpec --\u003e ModifiedPrompt\n    SubagentSpec --\u003e RestrictedTools\n    \n    ModifiedPrompt -.-\u003e|\"ROLE_ADDITIONAL\"| SubContext[\"Subagent instructions\"]\n    RestrictedTools -.-\u003e|\"Remove Task, SendDMail\"| Isolation[\"Prevents recursive delegation\"]\n```\n\n**Subagent field structure**:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `path` | string | Relative path to subagent YAML file |\n| `description` | string | Human-readable description for the main agent |\n\nThe `description` is used by the Task tool to help the main agent choose appropriate subagents.\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:21-24](), [src/kimi_cli/agents/koder/sub.yaml:1-12]()\n\n### Typical Subagent Pattern\n\nSubagents typically:\n1. **Extend the main agent**: Inherit most configuration\n2. **Modify ROLE_ADDITIONAL**: Add context about being a subagent\n3. **Exclude high-level tools**: Remove Task, SendDMail, SetTodoList to prevent recursion\n4. **Clear subagents field**: Prevent further nesting\n\n```yaml\nversion: 1\nagent:\n  extend: ./agent.yaml\n  system_prompt_args:\n    ROLE_ADDITIONAL: |\n      You are now running as a subagent. All the `user` messages are sent by the main agent.\n      The main agent cannot see your context, it can only see your last message.\n  exclude_tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.dmail:SendDMail\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n  subagents:  # Empty to prevent further nesting\n```\n\n**Sources**: [src/kimi_cli/agents/koder/sub.yaml:1-12]()\n\n---\n\n## Complete Agent Specification Example\n\n### Main Agent Configuration\n\nHere is a complete example showing all commonly-used fields:\n\n```yaml\nversion: 1\nagent:\n  name: \"Kimi Koder\"\n  system_prompt_path: ./system.md\n  system_prompt_args:\n    ROLE_ADDITIONAL: \"\"\n    PROJECT_CONTEXT: \"Python development project\"\n  tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.think:Think\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n    - \"kimi_cli.tools.bash:Bash\"\n    - \"kimi_cli.tools.file:ReadFile\"\n    - \"kimi_cli.tools.file:Glob\"\n    - \"kimi_cli.tools.file:Grep\"\n    - \"kimi_cli.tools.file:WriteFile\"\n    - \"kimi_cli.tools.file:StrReplaceFile\"\n    - \"kimi_cli.tools.web:SearchWeb\"\n    - \"kimi_cli.tools.web:FetchURL\"\n  subagents:\n    koder:\n      path: ./sub.yaml\n      description: \"Good at general software engineering tasks.\"\n    researcher:\n      path: ./researcher.yaml\n      description: \"Specialized in research and documentation.\"\n```\n\n**Sources**: [src/kimi_cli/agents/koder/agent.yaml:1-25]()\n\n---\n\n## Agent Specification Loading Flow\n\n### From YAML to Runtime Agent\n\n```mermaid\nsequenceDiagram\n    participant File as \"agent.yaml\"\n    participant Loader as \"_load_agent_spec()\"\n    participant ExtProc as \"Extension Processor\"\n    participant AgentSpec as \"AgentSpec dataclass\"\n    participant LoadAgent as \"load_agent()\"\n    participant PromptLoader as \"_load_system_prompt()\"\n    participant ToolLoader as \"_load_tools()\"\n    participant Agent as \"Agent instance\"\n    \n    File-\u003e\u003eLoader: Read YAML file\n    Loader-\u003e\u003eLoader: Validate version == 1\n    \n    alt Has extend field\n        Loader-\u003e\u003eExtProc: Resolve base agent\n        ExtProc-\u003e\u003eExtProc: Recursive load base\n        ExtProc-\u003e\u003eLoader: Merge configurations\n    end\n    \n    Loader-\u003e\u003eAgentSpec: Create dataclass\n    \n    LoadAgent-\u003e\u003eAgentSpec: Get specification\n    LoadAgent-\u003e\u003ePromptLoader: Load system prompt\n    PromptLoader-\u003e\u003ePromptLoader: Resolve ${VARIABLE} templates\n    PromptLoader--\u003e\u003eLoadAgent: Resolved prompt string\n    \n    LoadAgent-\u003e\u003eToolLoader: Load tools with deps\n    ToolLoader-\u003e\u003eToolLoader: Parse module:Class strings\n    ToolLoader-\u003e\u003eToolLoader: Filter exclude_tools\n    ToolLoader-\u003e\u003eToolLoader: Instantiate with DI\n    ToolLoader--\u003e\u003eLoadAgent: CustomToolset\n    \n    LoadAgent-\u003e\u003eAgent: Create Agent instance\n    Agent--\u003e\u003eLoadAgent: Ready agent\n```\n\n**Key functions involved**:\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `_load_agent_spec()` | [src/kimi_cli/agent.py]() | Parses YAML and resolves extension |\n| `_load_system_prompt()` | [src/kimi_cli/agent.py]() | Loads markdown and substitutes variables |\n| `_load_tools()` | [src/kimi_cli/agent.py]() | Instantiates tool classes with dependencies |\n| `load_agent()` | [src/kimi_cli/agent.py]() | Orchestrates complete agent loading |\n\n**Sources**: [tests/test_load_agent.py:29-36](), [tests/conftest.py:11-20]()\n\n---\n\n## Validation Rules\n\n### Specification Validation\n\nThe agent loading system enforces these validation rules:\n\n| Rule | Error Message | Validation Point |\n|------|---------------|------------------|\n| Version must be 1 | `Unsupported agent spec version: X` | YAML parsing |\n| File must exist | `expect agent file to exist` | File loading |\n| Name must be present | `Agent name is required` | Field validation |\n| system_prompt_path required | `System prompt path is required` | Field validation |\n| tools list required | `Tools are required` | Field validation |\n| Tool modules must be valid | `Invalid tools: [...]` | Tool loading |\n\n**Sources**: [tests/test_load_agent.py:207-230](), [tests/test_load_agent.py:38-53](), [tests/test_load_agent.py:201-204]()\n\n### Tool Validation\n\nDuring tool loading, the system:\n1. Attempts to import each tool module\n2. Attempts to instantiate each tool class with available dependencies\n3. Collects any invalid tool paths\n4. Raises `ValueError` with list of invalid tools if any fail\n\nInvalid tool specifications are reported clearly:\n```\nValueError: Invalid tools: ['kimi_cli.tools.nonexistent:Tool']\n```\n\n**Sources**: [tests/test_load_agent.py:153-172]()\n\n---\n\n## AgentSpec Dataclass Structure\n\n### Runtime Representation\n\nThe `AgentSpec` dataclass represents the parsed agent configuration:\n\n```python\n@dataclass\nclass AgentSpec:\n    name: str\n    system_prompt_path: Path\n    system_prompt_args: dict[str, str]\n    tools: list[str]\n    exclude_tools: list[str]\n    subagents: dict[str, SubagentSpec]\n    extend: Path | None  # Resolved to None after extension\n```\n\n### Field Types\n\n| Field | Type | Default | Description |\n|-------|------|---------|-------------|\n| `name` | `str` | Required | Agent display name |\n| `system_prompt_path` | `Path` | Required | Absolute path to prompt file |\n| `system_prompt_args` | `dict[str, str]` | `{}` | Template variables |\n| `tools` | `list[str]` | Required | Tool module paths |\n| `exclude_tools` | `list[str]` | `[]` | Tools to exclude |\n| `subagents` | `dict[str, SubagentSpec]` | `{}` | Subagent definitions |\n| `extend` | `Path \\| None` | `None` | Resolved during loading |\n\n**Sources**: [tests/conftest.py:11-20]()\n\n---\n\n## Best Practices\n\n### Agent Organization\n\n**Recommended directory structure**:\n```\nagents/\n my_agent/\n    agent.yaml       # Main agent configuration\n    system.md        # System prompt\n    sub.yaml         # Subagent configuration\n    sub_system.md    # Subagent prompt (if different)\n```\n\n### Tool Selection Guidelines\n\n**Always include**:\n- `Think` - For reasoning before actions\n- `ReadFile` - Nearly always needed for code/file inspection\n\n**Include for general agents**:\n- `WriteFile`, `StrReplaceFile` - File modification\n- `Glob`, `Grep` - File discovery and search\n- `Bash` - System operations\n- `Task` - If agent needs to delegate work\n\n**Restrict for subagents**:\n- Remove `Task` - Prevents recursive delegation\n- Remove `SendDMail` - Time travel should be main agent only\n- Remove `SetTodoList` - Task tracking at main agent level\n\n### System Prompt Template Design\n\n**Use template variables for**:\n- Role modifications (`ROLE_ADDITIONAL`)\n- Project-specific context\n- Environment information\n\n**Don't hardcode**:\n- Timestamps - use `${KIMI_NOW}`\n- Directory paths - use `${KIMI_WORK_DIR}`\n- File listings - use `${KIMI_WORK_DIR_LS}`\n\n### Extension Patterns\n\n**Prefer extension over duplication**:\n```yaml\n# Good: Extend and modify\nagent:\n  extend: ./base_agent.yaml\n  system_prompt_args:\n    SPECIALIZATION: \"Python expert\"\n```\n\n```yaml\n# Avoid: Duplicating entire configuration\nagent:\n  name: \"Python Agent\"\n  system_prompt_path: ./system.md\n  tools: [...30 tools...]\n```\n\n**Sources**: [tests/test_load_agent.py:75-120](), [src/kimi_cli/agents/koder/sub.yaml:1-12]()"])</script><script>self.__next_f.push([1,"24:T450d,"])</script><script>self.__next_f.push([1,"# Agent Loading and Initialization\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n\n\u003c/details\u003e\n\n\n\nThis document describes how agents are loaded from YAML specifications and initialized with their dependencies, including system prompts, tools, and runtime context. This process occurs during CLI startup and converts declarative agent specifications into executable `Agent` instances.\n\nFor information about the agent YAML format and configuration options, see [Agent Specification Format](#5.1). For details on subagent delegation, see [Subagents and Task Delegation](#5.3).\n\n## Overview\n\nAgent loading is a multi-stage process that transforms YAML-based agent specifications into fully initialized `Agent` instances. The process handles specification inheritance, template substitution, and dependency injection to create agents with the appropriate tools and context.\n\nThe entry point for agent loading is the `load_agent` function in [src/kimi_cli/agent.py:97-142](), which is called from the main CLI function [src/kimi_cli/__init__.py:324]().\n\n```mermaid\nflowchart TD\n    Start[\"CLI Startup\"] --\u003e LoadSpec[\"_load_agent_spec()\"]\n    LoadSpec --\u003e CheckExtend{\"Has extend\u003cbr/\u003efield?\"}\n    CheckExtend --\u003e|Yes| LoadBase[\"Load base agent spec\u003cbr/\u003erecursively\"]\n    CheckExtend --\u003e|No| ValidateSpec[\"Validate required fields\"]\n    LoadBase --\u003e MergeSpecs[\"Merge extended spec\u003cbr/\u003ewith base\"]\n    MergeSpecs --\u003e ValidateSpec\n    \n    ValidateSpec --\u003e CheckValid{\"name, system_prompt_path,\u003cbr/\u003etools present?\"}\n    CheckValid --\u003e|No| Error[\"ValueError\"]\n    CheckValid --\u003e|Yes| LoadPrompt[\"_load_system_prompt()\"]\n    \n    LoadPrompt --\u003e SubstituteVars[\"Template.substitute()\u003cbr/\u003ewith builtin_args + spec args\"]\n    SubstituteVars --\u003e CreateToolset[\"Create CustomToolset\"]\n    CreateToolset --\u003e LoadTools[\"_load_tools()\"]\n    \n    LoadTools --\u003e IterateTools[\"For each tool path\"]\n    IterateTools --\u003e ImportTool[\"Import module and class\"]\n    ImportTool --\u003e InjectDeps[\"Inspect signature\u003cbr/\u003einject dependencies\"]\n    InjectDeps --\u003e InstantiateTool[\"Instantiate tool\"]\n    InstantiateTool --\u003e AddToToolset[\"Add to toolset\"]\n    AddToToolset --\u003e MoreTools{\"More tools?\"}\n    MoreTools --\u003e|Yes| IterateTools\n    MoreTools --\u003e|No| CheckMCP{\"MCP configs\u003cbr/\u003epresent?\"}\n    \n    CheckMCP --\u003e|Yes| LoadMCP[\"_load_mcp_tools()\"]\n    LoadMCP --\u003e CreateAgent[\"Create Agent instance\"]\n    CheckMCP --\u003e|No| CreateAgent\n    \n    CreateAgent --\u003e Return[\"Return Agent\"]\n    \n    style LoadSpec fill:#f9f9f9\n    style LoadPrompt fill:#f9f9f9\n    style LoadTools fill:#f9f9f9\n    style CreateAgent fill:#f9f9f9\n```\n\n**Sources:** [src/kimi_cli/__init__.py:225-254](), [src/kimi_cli/agent.py:85-142]()\n\n## Agent Specification Parsing\n\nThe `_load_agent_spec` function [src/kimi_cli/agent.py:145-179]() parses YAML files into `AgentSpec` objects. This function handles specification inheritance through the `extend` field, allowing agents to build upon existing configurations.\n\n### AgentSpec Structure\n\nThe `AgentSpec` class [src/kimi_cli/agent.py:23-36]() defines the structure of agent configurations:\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `extend` | `str \\| None` | No | Path to base agent or \"default\" |\n| `name` | `str \\| None` | Yes | Agent display name |\n| `system_prompt_path` | `Path \\| None` | Yes | Path to system prompt markdown file |\n| `system_prompt_args` | `dict[str, str]` | No | Template variables for prompt substitution |\n| `tools` | `list[str] \\| None` | Yes | List of tool import paths |\n| `exclude_tools` | `list[str] \\| None` | No | Tools to exclude from base agent |\n| `subagents` | `dict[str, SubagentSpec] \\| None` | No | Subagent definitions for Task tool |\n\n**Sources:** [src/kimi_cli/agent.py:23-44]()\n\n### Specification Extension\n\nWhen an agent specifies `extend`, the loader recursively resolves the base specification and merges fields:\n\n```mermaid\ngraph TB\n    ExtendingSpec[\"Extending Agent YAML\u003cbr/\u003eextend: './base.yaml'\u003cbr/\u003ename: 'Extended Agent'\"]\n    BaseSpec[\"Base Agent YAML\u003cbr/\u003ename: 'Base Agent'\u003cbr/\u003etools: ['tool1', 'tool2']\"]\n    DefaultSpec[\"DEFAULT_AGENT_FILE\u003cbr/\u003e(builtin koder agent)\"]\n    \n    ExtendingSpec --\u003e|\"extend: './base.yaml'\"| LoadBase[\"Load base spec\"]\n    LoadBase --\u003e BaseSpec\n    ExtendingSpec --\u003e|\"extend: 'default'\"| LoadDefault[\"Load default spec\"]\n    LoadDefault --\u003e DefaultSpec\n    \n    BaseSpec --\u003e Merge[\"Merge specifications\"]\n    DefaultSpec --\u003e Merge\n    ExtendingSpec --\u003e Merge\n    \n    Merge --\u003e MergeRules[\"Merge Rules:\u003cbr/\u003e- Extending name overrides base\u003cbr/\u003e- Extending prompt_path overrides base\u003cbr/\u003e- system_prompt_args merged\u003cbr/\u003e- Extending tools replace base tools\u003cbr/\u003e- exclude_tools from extending used\u003cbr/\u003e- Extending subagents replace base\"]\n    \n    MergeRules --\u003e ResolvedSpec[\"Resolved AgentSpec\u003cbr/\u003eextend=None\"]\n```\n\n**Sources:** [src/kimi_cli/agent.py:160-178](), [tests/test_load_agent.py:75-120]()\n\nThe merge follows a last-wins strategy for most fields, with `system_prompt_args` being merged [src/kimi_cli/agent.py:170-171](). After resolution, the `extend` field is set to `None` [src/kimi_cli/agent.py:108]().\n\n## System Prompt Loading\n\nSystem prompts are loaded from markdown files and processed through Python's `string.Template` for variable substitution [src/kimi_cli/agent.py:182-191]().\n\n### Template Substitution\n\nThe `_load_system_prompt` function combines two sources of variables:\n\n1. **Builtin arguments** (`BuiltinSystemPromptArgs`) - Runtime context provided by the CLI\n2. **Spec arguments** - Custom variables defined in `system_prompt_args`\n\n```mermaid\nflowchart LR\n    PromptFile[\"system.md\u003cbr/\u003e'Current time: ${KIMI_NOW}\u003cbr/\u003eWork dir: ${KIMI_WORK_DIR}\u003cbr/\u003eCustom: ${CUSTOM_VAR}'\"]\n    \n    BuiltinArgs[\"BuiltinSystemPromptArgs\u003cbr/\u003eKIMI_NOW\u003cbr/\u003eKIMI_WORK_DIR\u003cbr/\u003eKIMI_WORK_DIR_LS\u003cbr/\u003eKIMI_AGENTS_MD\"]\n    \n    SpecArgs[\"system_prompt_args\u003cbr/\u003e(from agent.yaml)\u003cbr/\u003eCUSTOM_VAR: 'value'\u003cbr/\u003eROLE_ADDITIONAL: ''\"]\n    \n    Template[\"string.Template.substitute()\"]\n    \n    PromptFile --\u003e Template\n    BuiltinArgs --\u003e Template\n    SpecArgs --\u003e Template\n    \n    Template --\u003e Output[\"Resolved system prompt\u003cbr/\u003e'Current time: 2024-01-15T...\u003cbr/\u003eWork dir: /home/user/project\u003cbr/\u003eCustom: value'\"]\n```\n\n**Sources:** [src/kimi_cli/agent.py:182-191](), [src/kimi_cli/__init__.py:313-318]()\n\nThe `BuiltinSystemPromptArgs` [src/kimi_cli/agent.py:46-56]() provides:\n\n- `KIMI_NOW` - Current ISO timestamp with timezone\n- `KIMI_WORK_DIR` - Absolute path to working directory\n- `KIMI_WORK_DIR_LS` - Output of `ls -la` in working directory\n- `KIMI_AGENTS_MD` - Content of `AGENTS.md` if present\n\n**Sources:** [src/kimi_cli/agent.py:46-56](), [src/kimi_cli/__init__.py:305-318]()\n\n## Tool Instantiation and Dependency Injection\n\nTools are loaded dynamically through Python's import system and instantiated with dependency injection [src/kimi_cli/agent.py:194-231]().\n\n### Tool Loading Process\n\nEach tool is specified as an import path in the format `module.path:ClassName`. The `_load_tool` function:\n\n1. Splits the path into module and class name\n2. Imports the module dynamically\n3. Inspects the class constructor signature\n4. Injects dependencies from the `dependencies` dictionary\n5. Instantiates the tool\n\n```mermaid\ngraph TB\n    ToolPath[\"Tool path string\u003cbr/\u003e'kimi_cli.tools.bash:Bash'\"]\n    \n    ToolPath --\u003e Split[\"Split on ':'\"]\n    Split --\u003e ModuleName[\"module_name\u003cbr/\u003e'kimi_cli.tools.bash'\"]\n    Split --\u003e ClassName[\"class_name\u003cbr/\u003e'Bash'\"]\n    \n    ModuleName --\u003e Import[\"importlib.import_module()\"]\n    Import --\u003e Module[\"Module object\"]\n    \n    Module --\u003e GetClass[\"getattr(module, class_name)\"]\n    ClassName --\u003e GetClass\n    GetClass --\u003e Class[\"Tool class\u003cbr/\u003eBash\"]\n    \n    Class --\u003e Inspect[\"inspect.signature(cls)\"]\n    Inspect --\u003e Params[\"Constructor parameters\"]\n    \n    Params --\u003e CheckParam{\"For each\u003cbr/\u003eparam\"}\n    CheckParam --\u003e DepDict[\"dependencies dict\u003cbr/\u003e{type: instance}\"]\n    DepDict --\u003e InjectDep[\"Inject dependency\u003cbr/\u003eby type annotation\"]\n    InjectDep --\u003e ArgsAccum[\"Accumulate args\"]\n    \n    ArgsAccum --\u003e MoreParams{\"More params?\"}\n    MoreParams --\u003e|Yes| CheckParam\n    MoreParams --\u003e|No| Instantiate[\"cls(*args)\"]\n    \n    Instantiate --\u003e ToolInstance[\"Tool instance\"]\n```\n\n**Sources:** [src/kimi_cli/agent.py:212-231]()\n\n### Dependency Dictionary\n\nThe dependency dictionary maps type annotations to instances. It's constructed in `load_agent` [src/kimi_cli/agent.py:120-128]():\n\n```python\ntool_deps = {\n    AgentSpec: agent_spec,\n    AgentGlobals: globals_,\n    Config: globals_.config,\n    BuiltinSystemPromptArgs: globals_.builtin_args,\n    Session: globals_.session,\n    DenwaRenji: globals_.denwa_renji,\n    Approval: globals_.approval,\n}\n```\n\nTools declare their dependencies through constructor parameters with type annotations. For example, the `Bash` tool requires an `Approval` instance:\n\n```python\nclass Bash(CallableTool2):\n    def __init__(self, approval: Approval):\n        # approval injected automatically\n```\n\nThe injection process stops at keyword-only parameters [src/kimi_cli/agent.py:224-226](), allowing tools to have optional configuration parameters.\n\n**Sources:** [src/kimi_cli/agent.py:120-231](), [tests/conftest.py:164-167]()\n\n### Tool Exclusion\n\nTools can be excluded using the `exclude_tools` field [src/kimi_cli/agent.py:130-132]():\n\n```yaml\nagent:\n  tools:\n    - \"kimi_cli.tools.bash:Bash\"\n    - \"kimi_cli.tools.web:SearchWeb\"\n  exclude_tools:\n    - \"kimi_cli.tools.web:SearchWeb\"\n```\n\nThis is particularly useful when extending a base agent to create a restricted subagent.\n\n**Sources:** [src/kimi_cli/agent.py:130-132](), [tests/test_load_agent.py:56-62]()\n\n## AgentGlobals Container\n\n`AgentGlobals` [src/kimi_cli/agent.py:59-67]() is a `NamedTuple` that serves as the primary dependency injection container for the agent system. It aggregates all runtime dependencies that tools and other components need.\n\n```mermaid\nclassDiagram\n    class AgentGlobals {\n        +Config config\n        +LLM llm\n        +BuiltinSystemPromptArgs builtin_args\n        +DenwaRenji denwa_renji\n        +Session session\n        +Approval approval\n    }\n    \n    class Config {\n        +dict models\n        +dict providers\n        +LoopControl loop_control\n        +Services services\n    }\n    \n    class LLM {\n        +ChatProvider chat_provider\n        +int max_context_size\n    }\n    \n    class BuiltinSystemPromptArgs {\n        +str KIMI_NOW\n        +Path KIMI_WORK_DIR\n        +str KIMI_WORK_DIR_LS\n        +str KIMI_AGENTS_MD\n    }\n    \n    class DenwaRenji {\n        +Optional checkpoint\n    }\n    \n    class Session {\n        +str id\n        +Path history_file\n    }\n    \n    class Approval {\n        +bool yolo\n        +dict session_approvals\n    }\n    \n    AgentGlobals --\u003e Config\n    AgentGlobals --\u003e LLM\n    AgentGlobals --\u003e BuiltinSystemPromptArgs\n    AgentGlobals --\u003e DenwaRenji\n    AgentGlobals --\u003e Session\n    AgentGlobals --\u003e Approval\n```\n\n**Sources:** [src/kimi_cli/agent.py:59-67]()\n\n### AgentGlobals Construction\n\n`AgentGlobals` is constructed in the main CLI function [src/kimi_cli/__init__.py:310-322]() after loading configuration and creating the LLM instance:\n\n| Component | Source | Purpose |\n|-----------|--------|---------|\n| `config` | `load_config()` | LLM providers, models, services |\n| `llm` | `create_llm()` | Chat provider for LLM interaction |\n| `builtin_args` | Constructed from runtime state | Template variables for system prompts |\n| `denwa_renji` | `DenwaRenji()` | D-Mail time-travel system |\n| `session` | `new_session()` or `continue_session()` | Session metadata and history file |\n| `approval` | `Approval(yolo=...)` | Tool execution approval system |\n\n**Sources:** [src/kimi_cli/__init__.py:310-322]()\n\n## MCP Tool Integration\n\nAfter loading standard tools, the system can load Model Context Protocol (MCP) tools if MCP configurations are provided [src/kimi_cli/agent.py:85-94]().\n\n### MCP Loading Process\n\n```mermaid\nsequenceDiagram\n    participant CLI as \"CLI Main\"\n    participant LoaderWithMCP as \"load_agent_with_mcp()\"\n    participant Loader as \"load_agent()\"\n    participant MCPLoader as \"_load_mcp_tools()\"\n    participant FastMCP as \"fastmcp.Client\"\n    participant Toolset as \"CustomToolset\"\n    \n    CLI-\u003e\u003eLoaderWithMCP: agent_file, globals_, mcp_configs\n    LoaderWithMCP-\u003e\u003eLoader: agent_file, globals_\n    Loader--\u003e\u003eLoaderWithMCP: Agent with standard tools\n    \n    alt mcp_configs present\n        LoaderWithMCP-\u003e\u003eMCPLoader: toolset, mcp_configs\n        \n        loop For each MCP config\n            MCPLoader-\u003e\u003eFastMCP: Client(mcp_config)\n            MCPLoader-\u003e\u003eFastMCP: async with client\n            MCPLoader-\u003e\u003eFastMCP: list_tools()\n            FastMCP--\u003e\u003eMCPLoader: MCP tool definitions\n            \n            loop For each MCP tool\n                MCPLoader-\u003e\u003eToolset: += MCPTool(tool, client)\n            end\n        end\n        \n        MCPLoader--\u003e\u003eLoaderWithMCP: Updated toolset\n    end\n    \n    LoaderWithMCP--\u003e\u003eCLI: Agent with all tools\n```\n\n**Sources:** [src/kimi_cli/agent.py:85-94](), [src/kimi_cli/agent.py:234-248](), [src/kimi_cli/__init__.py:324]()\n\nMCP configurations can be provided via:\n- `--mcp-config-file` CLI option (multiple allowed) [src/kimi_cli/__init__.py:138-145]()\n- `--mcp-config` CLI option with inline JSON (multiple allowed) [src/kimi_cli/__init__.py:146-154]()\n\nEach MCP server connection creates `MCPTool` instances [src/kimi_cli/tools/mcp.py]() that wrap the MCP tool definitions and handle execution through the fastmcp client.\n\n**Sources:** [src/kimi_cli/__init__.py:138-154](), [src/kimi_cli/__init__.py:216-223](), [src/kimi_cli/agent.py:234-248]()\n\n## Complete Loading Flow in Context\n\nThe following diagram shows how agent loading fits into the broader CLI initialization:\n\n```mermaid\nflowchart TD\n    Start[\"kimi() CLI command\"] --\u003e ParseArgs[\"Parse CLI arguments\"]\n    ParseArgs --\u003e CreateSession[\"new_session() or\u003cbr/\u003econtinue_session()\"]\n    CreateSession --\u003e LoadConfig[\"load_config()\"]\n    \n    LoadConfig --\u003e SetupLLM[\"Setup LLM provider\u003cbr/\u003eaugment_provider_with_env_vars()\u003cbr/\u003ecreate_llm()\"]\n    \n    SetupLLM --\u003e LoadAgentsMD[\"load_agents_md()\u003cbr/\u003e(optional AGENTS.md)\"]\n    \n    LoadAgentsMD --\u003e CreateGlobals[\"Construct AgentGlobals\"]\n    CreateGlobals --\u003e GlobalsDetails[\"AgentGlobals(\u003cbr/\u003econfig, llm, builtin_args,\u003cbr/\u003edenwa_renji, session, approval)\"]\n    \n    GlobalsDetails --\u003e CallLoadAgent[\"load_agent_with_mcp(\u003cbr/\u003eagent_file, agent_globals, mcp_configs)\"]\n    \n    CallLoadAgent --\u003e AgentLoading[\"Agent Loading Process\u003cbr/\u003e(see Overview diagram)\"]\n    \n    AgentLoading --\u003e CreateContext[\"Context(session.history_file)\u003cbr/\u003econtext.restore()\"]\n    \n    CreateContext --\u003e CreateSoul[\"KimiSoul(\u003cbr/\u003eagent, agent_globals,\u003cbr/\u003econtext, loop_control)\"]\n    \n    CreateSoul --\u003e SelectUI{\"UI Mode?\"}\n    \n    SelectUI --\u003e|shell| ShellApp[\"ShellApp(soul)\"]\n    SelectUI --\u003e|print| PrintApp[\"PrintApp(soul)\"]\n    SelectUI --\u003e|acp| ACPServer[\"ACPServer(soul)\"]\n    \n    ShellApp --\u003e Run[\"app.run(command)\"]\n    PrintApp --\u003e Run\n    ACPServer --\u003e Run\n    \n    style AgentLoading fill:#f9f9f9\n    style CreateGlobals fill:#f9f9f9\n    style CreateSoul fill:#f9f9f9\n```\n\n**Sources:** [src/kimi_cli/__init__.py:225-380]()\n\n## Error Handling\n\nThe agent loading process validates specifications and handles errors at multiple stages:\n\n| Stage | Validation | Error Type | Location |\n|-------|-----------|------------|----------|\n| Spec Loading | Version number must be 1 | `ValueError` | [src/kimi_cli/agent.py:150-152]() |\n| Spec Loading | Agent file must exist | `AssertionError` | [src/kimi_cli/agent.py:146]() |\n| Agent Loading | `name` field required | `ValueError` | [src/kimi_cli/agent.py:109-110]() |\n| Agent Loading | `system_prompt_path` required | `ValueError` | [src/kimi_cli/agent.py:111-112]() |\n| Agent Loading | `tools` list required | `ValueError` | [src/kimi_cli/agent.py:113-114]() |\n| Tool Loading | Tool module/class not found | Logged as bad tool | [src/kimi_cli/agent.py:199-209]() |\n| Tool Loading | Tool dependencies missing | `ValueError` | [src/kimi_cli/agent.py:228-229]() |\n| Tool Loading | Invalid tools present | `ValueError` | [src/kimi_cli/agent.py:135-136]() |\n| MCP Loading | Invalid MCP config JSON | `ValueError` | Handled by fastmcp |\n| MCP Loading | MCP server connection failure | `RuntimeError` | Handled by fastmcp |\n\n**Sources:** [src/kimi_cli/agent.py:97-142](), [src/kimi_cli/agent.py:145-179](), [src/kimi_cli/agent.py:194-231](), [tests/test_load_agent.py:38-53]()\n\n## Test Coverage\n\nThe agent loading system has comprehensive test coverage in [tests/test_load_agent.py](). Key test scenarios include:\n\n- Basic agent loading [tests/test_load_agent.py:29-36]()\n- Missing required fields validation [tests/test_load_agent.py:38-53]()\n- Tool exclusion [tests/test_load_agent.py:56-62]()\n- Specification extension/inheritance [tests/test_load_agent.py:65-120]()\n- System prompt template substitution [tests/test_load_agent.py:122-130]()\n- Valid and invalid tool loading [tests/test_load_agent.py:132-172]()\n- AGENTS.md file discovery [tests/test_load_agent.py:174-198]()\n- Version validation [tests/test_load_agent.py:207-222]()\n\nTest fixtures in [tests/conftest.py]() demonstrate the expected structure of dependencies and provide reusable components for testing tools and agents.\n\n**Sources:** [tests/test_load_agent.py:1-411](), [tests/conftest.py:38-115]()"])</script><script>self.__next_f.push([1,"25:T3ad5,"])</script><script>self.__next_f.push([1,"# Subagents and Task Delegation\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/agents/koder/agent.yaml](src/kimi_cli/agents/koder/agent.yaml)\n- [src/kimi_cli/agents/koder/sub.yaml](src/kimi_cli/agents/koder/sub.yaml)\n- [src/kimi_cli/tools/web/__init__.py](src/kimi_cli/tools/web/__init__.py)\n- [src/kimi_cli/tools/web/fetch.md](src/kimi_cli/tools/web/fetch.md)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document covers the subagent system in kimi-cli, which enables agents to delegate tasks to specialized subordinate agents. The Task tool provides task decomposition capabilities by spawning isolated subagents with their own contexts and restricted tool access. This page focuses on the architecture, configuration, and implementation details of subagent delegation.\n\nFor general agent configuration, see [Agent Specification Format](#5.1). For the Task tool from a user perspective, see [Task Management Tools](#6.4). For the broader agent architecture, see [Agent System](#3.2).\n\n## Subagent System Overview\n\nThe subagent system implements a hierarchical delegation pattern where a main agent can spawn specialized subagents to handle specific tasks. Key characteristics include:\n\n- **Context Isolation**: Each subagent runs with its own separate context and history file\n- **Tool Restriction**: Subagents have limited tool access to prevent recursive delegation and maintain control\n- **Filtered Communication**: A `_SubWire` mechanism bubbles up approval requests while maintaining isolation\n- **Automatic Summarization**: Subagents are prompted to provide comprehensive summaries since the main agent cannot see their full context\n\n```mermaid\ngraph TB\n    MainAgent[\"Main Agent\u003cbr/\u003e(kimi)\"]\n    TaskTool[\"Task Tool\u003cbr/\u003e__call__()\"]\n    SubContext[\"Isolated Context\u003cbr/\u003e_sub history files\"]\n    SubAgent[\"Subagent\u003cbr/\u003e(koder)\"]\n    SubWire[\"_SubWire\u003cbr/\u003eFiltered events\"]\n    MainWire[\"Main Wire\u003cbr/\u003eFull events\"]\n    \n    MainAgent --\u003e|\"delegates via\"| TaskTool\n    TaskTool --\u003e|\"creates\"| SubContext\n    TaskTool --\u003e|\"instantiates\"| SubAgent\n    TaskTool --\u003e|\"wraps\"| SubWire\n    SubAgent --\u003e|\"uses\"| SubContext\n    SubAgent --\u003e|\"sends to\"| SubWire\n    SubWire --\u003e|\"bubbles up ApprovalRequest\"| MainWire\n    SubAgent --\u003e|\"returns summary\"| TaskTool\n    TaskTool --\u003e|\"returns ToolOk\"| MainAgent\n    \n    style TaskTool fill:#f9f9f9\n    style SubWire fill:#f9f9f9\n    style SubContext fill:#f9f9f9\n```\n\n**Diagram: Task Delegation Flow**\n\nSources: [src/kimi_cli/tools/task/__init__.py:44-157]()\n\n## Agent Configuration for Subagents\n\n### Main Agent Configuration\n\nThe main agent is configured with full capabilities including the Task tool. The `subagents` section defines which specialized agents can be delegated to.\n\n| Configuration Key | Purpose |\n|------------------|---------|\n| `tools` | Includes `kimi_cli.tools.task:Task` for delegation |\n| `subagents` | Dictionary mapping subagent names to their specifications |\n| `subagents[name].path` | Path to subagent YAML file |\n| `subagents[name].description` | Brief description shown in Task tool documentation |\n\nExample from [src/kimi_cli/agents/koder/agent.yaml:1-25]():\n\n```yaml\nversion: 1\nagent:\n  name: \"\"\n  system_prompt_path: ./system.md\n  tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.dmail:SendDMail\"\n    - \"kimi_cli.tools.think:Think\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n    - \"kimi_cli.tools.bash:Bash\"\n    - \"kimi_cli.tools.file:ReadFile\"\n    # ... other tools\n  subagents:\n    koder:\n      path: ./sub.yaml\n      description: \"Good at general software engineering tasks.\"\n```\n\n### Subagent Configuration\n\nSubagents use the `extend` mechanism to inherit the main agent's configuration, then apply modifications. Critical differences include:\n\n1. **Modified System Prompt**: `ROLE_ADDITIONAL` parameter adds context about being a subagent\n2. **Tool Exclusions**: Removes high-level coordination tools\n3. **No Subagents**: The `subagents` key is explicitly cleared to prevent recursive delegation\n\nExample from [src/kimi_cli/agents/koder/sub.yaml:1-12]():\n\n```yaml\nversion: 1\nagent:\n  extend: ./agent.yaml\n  system_prompt_args:\n    ROLE_ADDITIONAL: |\n      You are now running as a subagent. All the `user` messages are sent by the main agent. \n      The main agent cannot see your context, it can only see your last message when you finish the task. \n      You need to provide a comprehensive summary on what you have done and learned in your final message. \n      If you wrote or modified any files, you must mention them in the summary.\n  exclude_tools:\n    - \"kimi_cli.tools.task:Task\"\n    - \"kimi_cli.tools.dmail:SendDMail\"\n    - \"kimi_cli.tools.todo:SetTodoList\"\n  subagents: # make sure no subagents are provided\n```\n\nThe `ROLE_ADDITIONAL` parameter is interpolated into the system prompt template, informing the subagent of its role and responsibilities.\n\nSources: [src/kimi_cli/agents/koder/agent.yaml:1-25](), [src/kimi_cli/agents/koder/sub.yaml:1-12]()\n\n## Task Tool Implementation\n\n### Initialization and Subagent Loading\n\nThe Task tool is instantiated with references to the agent specification and agent globals. During initialization, it loads all configured subagents and builds the tool description dynamically.\n\n```mermaid\ngraph LR\n    AgentSpec[\"AgentSpec\u003cbr/\u003eagent.yaml\"]\n    TaskInit[\"Task.__init__()\"]\n    LoadAgent[\"load_agent()\u003cbr/\u003efor each subagent\"]\n    SubAgentDict[\"self._subagents\u003cbr/\u003edict[str, Agent]\"]\n    ToolDesc[\"Dynamic description\u003cbr/\u003ewith SUBAGENTS_MD\"]\n    \n    AgentSpec --\u003e|\"subagents config\"| TaskInit\n    TaskInit --\u003e|\"calls\"| LoadAgent\n    LoadAgent --\u003e|\"populates\"| SubAgentDict\n    TaskInit --\u003e|\"generates\"| ToolDesc\n```\n\n**Diagram: Task Tool Initialization**\n\nKey implementation from [src/kimi_cli/tools/task/__init__.py:48-70]():\n\n```python\ndef __init__(self, agent_spec: AgentSpec, agent_globals: AgentGlobals, **kwargs):\n    subagents: dict[str, Agent] = {}\n    descs = []\n\n    # load all subagents\n    assert agent_spec.subagents is not None, \"Task tool expects subagents\"\n    for name, spec in agent_spec.subagents.items():\n        subagents[name] = load_agent(spec.path, agent_globals)\n        descs.append(f\"- `{name}`: {spec.description}\")\n\n    super().__init__(\n        description=load_desc(\n            Path(__file__).parent / \"task.md\",\n            {\n                \"SUBAGENTS_MD\": \"\\n\".join(descs),\n            },\n        ),\n        **kwargs,\n    )\n\n    self._agent_globals = agent_globals\n    self._session = agent_globals.session\n    self._subagents = subagents\n```\n\n### Task Execution Flow\n\nWhen the Task tool is invoked, it executes the following steps:\n\n1. **Validate Subagent**: Check that the requested subagent name exists\n2. **Generate History File**: Create unique history file for isolation\n3. **Create Context**: Instantiate new `Context` with separate file backend\n4. **Instantiate Soul**: Create `KimiSoul` with subagent and isolated context\n5. **Wrap Wire**: Create `_SubWire` to filter communication\n6. **Run Subagent**: Execute with the provided prompt\n7. **Handle Continuation**: If response is too brief, prompt for more detail\n8. **Return Summary**: Extract final assistant message as tool result\n\n```mermaid\nsequenceDiagram\n    participant MA as Main Agent\n    participant Task as Task.__call__()\n    participant HF as _get_subagent_history_file()\n    participant Context as Context\n    participant Soul as KimiSoul\n    participant SubWire as _SubWire\n    participant SA as Subagent\n    \n    MA-\u003e\u003eTask: params(subagent_name, prompt)\n    Task-\u003e\u003eTask: validate subagent exists\n    Task-\u003e\u003eHF: generate unique history file\n    HF--\u003e\u003eTask: Path(_sub_N.json)\n    Task-\u003e\u003eContext: new Context(file_backend)\n    Task-\u003e\u003eSoul: new KimiSoul(agent, context)\n    Task-\u003e\u003eSubWire: new _SubWire(main_wire)\n    Task-\u003e\u003eSoul: run(prompt, sub_wire)\n    Soul-\u003e\u003eSA: execute agent loop\n    SA--\u003e\u003eSoul: tool calls \u0026 responses\n    Soul--\u003e\u003eTask: complete or MaxStepsReached\n    \n    alt Response too brief\n        Task-\u003e\u003eSoul: run(CONTINUE_PROMPT)\n        Soul-\u003e\u003eSA: request continuation\n        SA--\u003e\u003eSoul: detailed response\n    end\n    \n    Task-\u003e\u003eContext: extract history[-1]\n    Task--\u003e\u003eMA: ToolOk(final_response)\n```\n\n**Diagram: Task Execution Sequence**\n\nSources: [src/kimi_cli/tools/task/__init__.py:84-144]()\n\n### Context Isolation Mechanism\n\nEach subagent receives a unique history file to maintain complete context isolation. The naming scheme uses rotation to prevent conflicts:\n\n```python\nasync def _get_subagent_history_file(self) -\u003e Path:\n    \"\"\"Generate a unique history file path for subagent.\"\"\"\n    main_history_file = self._session.history_file\n    subagent_base_name = f\"{main_history_file.stem}_sub\"\n    main_history_file.parent.mkdir(parents=True, exist_ok=True)\n    sub_history_file = await next_available_rotation(\n        main_history_file.parent / f\"{subagent_base_name}{main_history_file.suffix}\"\n    )\n    assert sub_history_file is not None\n    return sub_history_file\n```\n\nThis generates files like:\n- Main: `session_123.json`\n- Sub 1: `session_123_sub_0.json`\n- Sub 2: `session_123_sub_1.json`\n- Sub 3: `session_123_sub_2.json`\n\nSources: [src/kimi_cli/tools/task/__init__.py:72-81]()\n\n## Communication via _SubWire\n\nThe `_SubWire` class provides filtered event streaming between subagent and main agent. It selectively forwards only `ApprovalRequest` events, maintaining isolation while allowing critical user interactions to bubble up.\n\n```mermaid\ngraph TB\n    Subagent[\"Subagent\u003cbr/\u003eKimiSoul.run()\"]\n    SubWire[\"_SubWire\u003cbr/\u003esend()\"]\n    Filter{\"msg type?\"}\n    SuperWire[\"Main Wire\u003cbr/\u003e(parent)\"]\n    Drop[\"Drop\u003cbr/\u003e(ignore)\"]\n    \n    Subagent --\u003e|\"sends WireMessage\"| SubWire\n    SubWire --\u003e Filter\n    Filter --\u003e|\"ApprovalRequest\"| SuperWire\n    Filter --\u003e|\"other events\"| Drop\n    \n    style Filter fill:#f9f9f9\n    style Drop fill:#f9f9f9\n```\n\n**Diagram: Wire Message Filtering**\n\nImplementation from [src/kimi_cli/tools/task/__init__.py:147-157]():\n\n```python\nclass _SubWire(Wire):\n    def __init__(self, super_wire: Wire):\n        super().__init__()\n        self._super_wire = super_wire\n\n    @override\n    def send(self, msg: WireMessage):\n        if isinstance(msg, ApprovalRequest):\n            self._super_wire.send(msg)\n        # TODO: visualize subagent behavior by sending other messages in some way\n```\n\nThis design ensures that:\n- Bash commands requiring approval in subagents still request user consent\n- The main agent's UI doesn't receive duplicate or confusing events\n- Future enhancement can add visualization of subagent behavior\n\nSources: [src/kimi_cli/tools/task/__init__.py:147-157]()\n\n## Response Continuation Logic\n\nTo ensure comprehensive summaries, the Task tool implements a continuation mechanism. If the subagent's final response is less than 200 characters, it automatically prompts for more detail (up to `MAX_CONTINUE_ATTEMPTS`).\n\n| Constant | Value | Purpose |\n|----------|-------|---------|\n| `MAX_CONTINUE_ATTEMPTS` | 1 | Maximum retries for brief responses |\n| `CONTINUE_PROMPT` | Multi-line string | Asks for comprehensive summary |\n\nThe continuation prompt from [src/kimi_cli/tools/task/__init__.py:20-27]():\n\n```\nYour previous response was too brief. Please provide a more comprehensive summary that includes:\n\n1. Specific technical details and implementations\n2. Complete code examples if relevant\n3. Detailed findings and analysis\n4. All important information that should be aware of by the caller\n```\n\nLogic from [src/kimi_cli/tools/task/__init__.py:136-143]():\n\n```python\n# Check if response is too brief, if so, run again with continuation prompt\nn_attempts_remaining = MAX_CONTINUE_ATTEMPTS\nif len(final_response) \u003c 200 and n_attempts_remaining \u003e 0:\n    await soul.run(CONTINUE_PROMPT, sub_wire)\n    \n    if len(context.history) == 0 or context.history[-1].role != \"assistant\":\n        return ToolError(message=_error_msg, brief=\"Failed to run subagent\")\n    final_response = message_extract_text(context.history[-1])\n```\n\nSources: [src/kimi_cli/tools/task/__init__.py:16-27](), [src/kimi_cli/tools/task/__init__.py:136-143]()\n\n## Error Handling\n\nThe Task tool handles several error conditions:\n\n### Invalid Subagent Name\n\n```python\nif params.subagent_name not in self._subagents:\n    return ToolError(\n        message=f\"Subagent not found: {params.subagent_name}\",\n        brief=\"Subagent not found\",\n    )\n```\n\n### Max Steps Reached\n\n```python\ntry:\n    await soul.run(prompt, sub_wire)\nexcept MaxStepsReached as e:\n    return ToolError(\n        message=(\n            f\"Max steps {e.n_steps} reached when running subagent. \"\n            \"Please try splitting the task into smaller subtasks.\"\n        ),\n        brief=\"Max steps reached\",\n    )\n```\n\n### Invalid Context State\n\n```python\n# Check if the subagent context is valid\nif len(context.history) == 0 or context.history[-1].role != \"assistant\":\n    return ToolError(message=_error_msg, brief=\"Failed to run subagent\")\n```\n\nSources: [src/kimi_cli/tools/task/__init__.py:84-98](), [src/kimi_cli/tools/task/__init__.py:115-143]()\n\n## Tool Parameter Schema\n\nThe Task tool accepts three parameters via the `Params` Pydantic model:\n\n```python\nclass Params(BaseModel):\n    description: str = Field(\n        description=\"A short (3-5 word) description of the task\"\n    )\n    subagent_name: str = Field(\n        description=\"The name of the specialized subagent to use for this task\"\n    )\n    prompt: str = Field(\n        description=(\n            \"The task for the subagent to perform. \"\n            \"You must provide a detailed prompt with all necessary background information \"\n            \"because the subagent cannot see anything in your context.\"\n        )\n    )\n```\n\nThe `prompt` field is particularly important because of context isolationthe subagent has no access to the main agent's conversation history, so all necessary information must be included in the task prompt.\n\nSources: [src/kimi_cli/tools/task/__init__.py:30-42]()\n\n## Practical Usage Pattern\n\nA typical delegation workflow:\n\n1. **Main agent identifies** a complex or specialized task\n2. **Selects appropriate subagent** from available options (e.g., \"koder\")\n3. **Formulates comprehensive prompt** with all context needed\n4. **Invokes Task tool** with subagent name and prompt\n5. **Subagent executes** in isolation with restricted tools\n6. **Approval requests bubble up** if needed (e.g., bash commands)\n7. **Subagent provides summary** upon completion\n8. **Main agent receives** summary as tool result\n9. **Main agent continues** with new information\n\nThe main agent must be explicit about what information to include in the task prompt, as the subagent cannot reference earlier conversation turns. This encourages clear task decomposition and prevents implicit dependencies.\n\nSources: [src/kimi_cli/tools/task/__init__.py:30-157]()"])</script><script>self.__next_f.push([1,"26:T5805,"])</script><script>self.__next_f.push([1,"# Tool System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThe Tool System provides the agent with capabilities to interact with the file system, web, shell commands, and perform meta-operations. This page documents the tool architecture, loading mechanism, and provides a comprehensive catalog of all available tools.\n\nFor information about individual tool categories and detailed usage, see:\n- File System Tools: [6.1](#6.1)\n- Web Tools: [6.2](#6.2)\n- System Execution Tools: [6.3](#6.3)\n- Task Management Tools: [6.4](#6.4)\n- Meta Tools: [6.5](#6.5)\n\nFor information about how agents configure and use tools, see Agent Configuration [5](#5).\n\n---\n\n## Tool Architecture\n\nThe tool system is built on the `CallableTool2` base class from the `kosong` library. Tools are organized into modules under `kimi_cli.tools` and are dynamically loaded and instantiated with dependency injection.\n\n### Tool Inheritance Structure\n\n```mermaid\ngraph TB\n    CallableTool2[\"CallableTool2\u003cbr/\u003e(kosong.tooling base)\"]\n    \n    subgraph \"kimi_cli.tools\"\n        subgraph \"file\"\n            ReadFile[\"ReadFile\u003cbr/\u003ekimi_cli.tools.file.read\"]\n            WriteFile[\"WriteFile\u003cbr/\u003ekimi_cli.tools.file.write\"]\n            PatchFile[\"PatchFile\u003cbr/\u003ekimi_cli.tools.file.patch\"]\n            StrReplaceFile[\"StrReplaceFile\u003cbr/\u003ekimi_cli.tools.file.replace\"]\n            Glob[\"Glob\u003cbr/\u003ekimi_cli.tools.file.glob\"]\n            Grep[\"Grep\u003cbr/\u003ekimi_cli.tools.file.grep\"]\n        end\n        \n        subgraph \"web\"\n            SearchWeb[\"SearchWeb\u003cbr/\u003ekimi_cli.tools.web.search\"]\n            FetchURL[\"FetchURL\u003cbr/\u003ekimi_cli.tools.web.fetch\"]\n        end\n        \n        subgraph \"task\"\n            Task[\"Task\u003cbr/\u003ekimi_cli.tools.task\"]\n        end\n        \n        subgraph \"system\"\n            Bash[\"Bash\u003cbr/\u003ekimi_cli.tools.bash\"]\n        end\n        \n        subgraph \"meta\"\n            Think[\"Think\u003cbr/\u003ekimi_cli.tools.think\"]\n            SendDMail[\"SendDMail\u003cbr/\u003ekimi_cli.tools.dmail\"]\n            SetTodoList[\"SetTodoList\u003cbr/\u003ekimi_cli.tools.todo\"]\n        end\n    end\n    \n    CallableTool2 --\u003e ReadFile\n    CallableTool2 --\u003e WriteFile\n    CallableTool2 --\u003e PatchFile\n    CallableTool2 --\u003e StrReplaceFile\n    CallableTool2 --\u003e Glob\n    CallableTool2 --\u003e Grep\n    CallableTool2 --\u003e SearchWeb\n    CallableTool2 --\u003e FetchURL\n    CallableTool2 --\u003e Task\n    CallableTool2 --\u003e Bash\n    CallableTool2 --\u003e Think\n    CallableTool2 --\u003e SendDMail\n    CallableTool2 --\u003e SetTodoList\n```\n\n**Sources:** [tests/conftest.py:23-35](), [tests/test_tool_descriptions.py:5-17]()\n\n### Tool Infrastructure Components\n\n```mermaid\ngraph TB\n    subgraph \"Tool Dependencies\"\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003ekimi_cli.agent\"]\n        Config[\"Config\u003cbr/\u003ekimi_cli.config\"]\n        BuiltinArgs[\"BuiltinSystemPromptArgs\u003cbr/\u003ekimi_cli.agent\"]\n        Session[\"Session\u003cbr/\u003ekimi_cli.metadata\"]\n        DenwaRenji[\"DenwaRenji\u003cbr/\u003ekimi_cli.soul.denwarenji\"]\n        Approval[\"Approval\u003cbr/\u003ekimi_cli.soul.approval\"]\n        AgentSpec[\"AgentSpec\u003cbr/\u003ekimi_cli.agent\"]\n    end\n    \n    subgraph \"Tool Loading\"\n        LoadTools[\"_load_tools()\u003cbr/\u003ekimi_cli.agent\"]\n        CustomToolset[\"CustomToolset\u003cbr/\u003ekimi_cli.soul.toolset\"]\n        ToolCallContext[\"tool_call_context\u003cbr/\u003etests.conftest\"]\n        CurrentToolCall[\"current_tool_call\u003cbr/\u003ekimi_cli.soul.toolset\"]\n    end\n    \n    subgraph \"Tool Execution\"\n        KimiSoul[\"KimiSoul\u003cbr/\u003ekimi_cli.soul.kimi_soul\"]\n        ToolOk[\"ToolOk\u003cbr/\u003ekosong.tooling\"]\n        ToolError[\"ToolError\u003cbr/\u003ekosong.tooling\"]\n    end\n    \n    AgentGlobals --\u003e Config\n    AgentGlobals --\u003e BuiltinArgs\n    AgentGlobals --\u003e Session\n    AgentGlobals --\u003e DenwaRenji\n    AgentGlobals --\u003e Approval\n    \n    LoadTools --\u003e CustomToolset\n    CustomToolset --\u003e KimiSoul\n    \n    ToolCallContext --\u003e CurrentToolCall\n    KimiSoul --\u003e CurrentToolCall\n    \n    KimiSoul --\u003e ToolOk\n    KimiSoul --\u003e ToolError\n```\n\n**Sources:** [tests/conftest.py:98-114](), [tests/test_load_agent.py:132-150]()\n\n---\n\n## Tool Categories and Overview\n\nTools are organized into five functional categories:\n\n| Category | Tool Count | Purpose | Module Path |\n|----------|------------|---------|-------------|\n| **File System** | 6 | File and directory operations | `kimi_cli.tools.file` |\n| **Web Access** | 2 | Internet search and page fetching | `kimi_cli.tools.web` |\n| **System Execution** | 1 | Shell command execution | `kimi_cli.tools.bash` |\n| **Task Management** | 2 | Subagent delegation and progress tracking | `kimi_cli.tools.task`, `kimi_cli.tools.todo` |\n| **Meta Operations** | 3 | Reasoning, time-travel, and context management | `kimi_cli.tools.think`, `kimi_cli.tools.dmail` |\n\n**Sources:** [tests/conftest.py:23-35]()\n\n---\n\n## Tool Loading and Dependency Injection\n\n### Tool Specification Format\n\nTools are specified in agent YAML files using module:class format:\n\n```yaml\ntools:\n  - \"kimi_cli.tools.bash:Bash\"\n  - \"kimi_cli.tools.file:ReadFile\"\n  - \"kimi_cli.tools.web:SearchWeb\"\n```\n\nTools can be excluded using `exclude_tools`:\n\n```yaml\nexclude_tools:\n  - \"kimi_cli.tools.web:SearchWeb\"\n  - \"kimi_cli.tools.web:FetchURL\"\n```\n\n**Sources:** [tests/test_load_agent.py:87-92]()\n\n### Dependency Injection Mechanism\n\n```mermaid\ngraph LR\n    AgentYAML[\"agent.yaml\u003cbr/\u003eTool specifications\"]\n    LoadAgent[\"load_agent()\u003cbr/\u003ekimi_cli.agent\"]\n    LoadTools[\"_load_tools()\"]\n    \n    subgraph \"Dependency Map\"\n        DepMap[\"Dependency Types\"]\n        AG[\"AgentGlobals\"]\n        CF[\"Config\"]\n        BA[\"BuiltinSystemPromptArgs\"]\n        SS[\"Session\"]\n        DR[\"DenwaRenji\"]\n        AP[\"Approval\"]\n        AS[\"AgentSpec\"]\n    end\n    \n    subgraph \"Tool Instantiation\"\n        Inspect[\"inspect.signature()\"]\n        Match[\"Match parameters\u003cbr/\u003eto dependencies\"]\n        Instantiate[\"Instantiate tool\u003cbr/\u003ewith dependencies\"]\n    end\n    \n    CustomToolset[\"CustomToolset\u003cbr/\u003ePopulated with tools\"]\n    \n    AgentYAML --\u003e LoadAgent\n    LoadAgent --\u003e LoadTools\n    \n    LoadTools --\u003e DepMap\n    DepMap --\u003e AG \u0026 CF \u0026 BA \u0026 SS \u0026 DR \u0026 AP \u0026 AS\n    \n    LoadTools --\u003e Inspect\n    Inspect --\u003e Match\n    AG \u0026 CF \u0026 BA \u0026 SS \u0026 DR \u0026 AP \u0026 AS --\u003e Match\n    Match --\u003e Instantiate\n    \n    Instantiate --\u003e CustomToolset\n```\n\n**Sources:** [tests/test_load_agent.py:132-150](), [tests/conftest.py:98-114]()\n\n### Tool Dependencies by Tool\n\n| Tool | Required Dependencies |\n|------|----------------------|\n| `ReadFile` | `BuiltinSystemPromptArgs` |\n| `WriteFile` | `BuiltinSystemPromptArgs`, `Approval` |\n| `PatchFile` | `BuiltinSystemPromptArgs`, `Approval` |\n| `StrReplaceFile` | `BuiltinSystemPromptArgs`, `Approval` |\n| `Glob` | `BuiltinSystemPromptArgs` |\n| `Grep` | (none) |\n| `SearchWeb` | `Config` |\n| `FetchURL` | (none) |\n| `Bash` | `Approval` |\n| `Task` | `AgentSpec`, `AgentGlobals` |\n| `SetTodoList` | (none) |\n| `Think` | (none) |\n| `SendDMail` | `DenwaRenji` |\n\n**Sources:** [tests/conftest.py:140-224]()\n\n---\n\n## Tool Execution Flow\n\n### Tool Call Context Tracking\n\nThe system maintains a context variable `current_tool_call` to track which tool is currently executing:\n\n```mermaid\nsequenceDiagram\n    participant KS as KimiSoul\n    participant TCC as tool_call_context\n    participant CTT as current_tool_call\n    participant Tool as Tool Instance\n    \n    KS-\u003e\u003eTCC: Enter context\n    TCC-\u003e\u003eCTT: Set ToolCall token\n    Note over CTT: ToolCall(id, function)\n    CTT-\u003e\u003eTool: Execute tool\n    Tool--\u003e\u003eCTT: Return result\n    CTT-\u003e\u003eTCC: Reset token\n    TCC--\u003e\u003eKS: Exit context\n```\n\n**Sources:** [tests/conftest.py:124-136]()\n\n### Approval Integration\n\nTools that modify state require approval before execution:\n\n```mermaid\ngraph TB\n    ToolCall[\"Tool Call Request\u003cbr/\u003e(Bash, WriteFile, etc.)\"]\n    \n    CheckApproval{\"Needs Approval?\"}\n    \n    YoloMode{\"Yolo Mode?\"}\n    RequestApproval[\"Request User Approval\u003cbr/\u003evia Wire.send()\"]\n    UserDecision{\"User Approved?\"}\n    \n    Execute[\"Execute Tool\"]\n    Reject[\"Return ToolError\u003cbr/\u003e'User rejected'\"]\n    \n    ToolCall --\u003e CheckApproval\n    CheckApproval --\u003e|Yes| YoloMode\n    CheckApproval --\u003e|No| Execute\n    \n    YoloMode --\u003e|Yes| Execute\n    YoloMode --\u003e|No| RequestApproval\n    \n    RequestApproval --\u003e UserDecision\n    UserDecision --\u003e|Yes| Execute\n    UserDecision --\u003e|No| Reject\n```\n\nTools requiring approval:\n- `Bash` - Shell command execution\n- `WriteFile` - File creation/modification\n- `StrReplaceFile` - String replacement in files\n- `PatchFile` - Patch application\n\n**Sources:** [tests/conftest.py:164-212]()\n\n---\n\n## Comprehensive Tool Catalog\n\n### File System Tools (6 tools)\n\n#### ReadFile\n\n**Module:** `kimi_cli.tools.file.read:ReadFile`\n\n**Description:** Read content from a file with line numbering and pagination support.\n\n**Key Features:**\n- Line-numbered output (like `cat -n`)\n- Pagination with `line_offset` and `n_lines`\n- Maximum 1000 lines per read\n- Lines truncated at 2000 characters\n- Parallel execution recommended\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to file |\n| `line_offset` | integer | No | 1 | Starting line number |\n| `n_lines` | integer | No | 1000 | Number of lines to read |\n\n**Sources:** [tests/test_tool_descriptions.py:146-165](), [tests/test_tool_schemas.py:136-161]()\n\n---\n\n#### WriteFile\n\n**Module:** `kimi_cli.tools.file.write:WriteFile`\n\n**Description:** Write content to a file with overwrite or append modes.\n\n**Requires Approval:** Yes\n\n**Key Features:**\n- Two modes: `overwrite` and `append`\n- For long content (\u003e100 lines), use multiple calls\n- First call with `overwrite`, subsequent with `append`\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to file |\n| `content` | string | Yes | - | Content to write |\n| `mode` | enum | No | `\"overwrite\"` | Write mode: `overwrite` or `append` |\n\n**Sources:** [tests/test_tool_descriptions.py:206-216](), [tests/test_tool_schemas.py:261-284]()\n\n---\n\n#### StrReplaceFile\n\n**Module:** `kimi_cli.tools.file.replace:StrReplaceFile`\n\n**Description:** Replace specific strings within a file.\n\n**Requires Approval:** Yes\n\n**Key Features:**\n- Multi-line string support\n- Single or batch edit operations\n- Preferred over `WriteFile` and `sed`\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to file |\n| `edit` | Edit or Edit[] | Yes | - | Single edit or list of edits |\n| `edit.old` | string | Yes | - | String to replace (multi-line supported) |\n| `edit.new` | string | Yes | - | Replacement string (multi-line supported) |\n| `edit.replace_all` | boolean | No | `false` | Replace all occurrences |\n\n**Sources:** [tests/test_tool_descriptions.py:219-231](), [tests/test_tool_schemas.py:287-328]()\n\n---\n\n#### PatchFile\n\n**Module:** `kimi_cli.tools.file.patch:PatchFile`\n\n**Description:** Apply unified diff patches to files.\n\n**Requires Approval:** Yes\n\n**Key Features:**\n- Unified diff format (like `diff -u` or `git diff`)\n- Clean application required (fails if patch doesn't apply)\n- File must exist before patching\n- Preferred over `WriteFile` and `sed` for edits\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to file |\n| `diff` | string | Yes | - | Unified diff content |\n\n**Sources:** [tests/test_tool_descriptions.py:234-247](), [tests/test_tool_schemas.py:331-348]()\n\n---\n\n#### Glob\n\n**Module:** `kimi_cli.tools.file.glob:Glob`\n\n**Description:** Find files and directories using glob patterns.\n\n**Key Features:**\n- Standard glob syntax: `*`, `?`, `**`\n- Recursive directory search\n- Pattern validation (rejects overly broad patterns)\n\n**Prohibited Patterns:**\n- `**` or `**/*.py` (starting with `**`)\n- `node_modules/**/*`, `venv/**/*` (known large directories)\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `pattern` | string | Yes | - | Glob pattern |\n| `directory` | string or null | No | `null` | Absolute path to search in |\n| `include_dirs` | boolean | No | `true` | Include directories in results |\n\n**Example Patterns:**\n- `*.py` - Python files in current directory\n- `src/**/*.js` - JavaScript files recursively in src/\n- `test_*.py` - Test files starting with \"test_\"\n- `*.config.{js,ts}` - Config files with .js or .ts extension\n\n**Sources:** [tests/test_tool_descriptions.py:168-190](), [tests/test_tool_schemas.py:164-187]()\n\n---\n\n#### Grep\n\n**Module:** `kimi_cli.tools.file.grep:Grep`\n\n**Description:** Powerful search tool based on ripgrep.\n\n**Key Features:**\n- Three output modes: `content`, `files_with_matches`, `count_matches`\n- Context lines (`-B`, `-A`, `-C`)\n- Line numbers (`-n`)\n- Case insensitive (`-i`)\n- File type filtering\n- Multiline mode support\n- Head limit for output truncation\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `pattern` | string | Yes | - | Regular expression pattern (ripgrep syntax) |\n| `path` | string | No | `\".\"` | File or directory to search (absolute path) |\n| `glob` | string or null | No | `null` | Glob pattern to filter files |\n| `output_mode` | string | No | `\"files_with_matches\"` | Output mode |\n| `-B` | integer or null | No | `null` | Lines before match |\n| `-A` | integer or null | No | `null` | Lines after match |\n| `-C` | integer or null | No | `null` | Lines before and after match |\n| `-n` | boolean | No | `false` | Show line numbers |\n| `-i` | boolean | No | `false` | Case insensitive |\n| `type` | string or null | No | `null` | File type (e.g., py, js, rs) |\n| `head_limit` | integer or null | No | `null` | Limit output to first N lines |\n| `multiline` | boolean | No | `false` | Enable multiline mode |\n\n**Important:** Always use `Grep` instead of running `grep` or `rg` via `Bash`.\n\n**Sources:** [tests/test_tool_descriptions.py:193-203](), [tests/test_tool_schemas.py:190-258]()\n\n---\n\n### Web Tools (2 tools)\n\n#### SearchWeb\n\n**Module:** `kimi_cli.tools.web.search:SearchWeb`\n\n**Description:** Search the internet for latest information including news, documents, release notes, blog posts, and papers.\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `query` | string | Yes | - | Query text to search |\n| `limit` | integer | No | 5 | Number of results (1-20) |\n| `include_content` | boolean | No | `false` | Include page content (high token cost) |\n\n**Warning:** Setting `include_content=true` with large `limit` consumes many tokens.\n\n**Sources:** [tests/test_tool_descriptions.py:250-254](), [tests/test_tool_schemas.py:351-376]()\n\n---\n\n#### FetchURL\n\n**Module:** `kimi_cli.tools.web.fetch:FetchURL`\n\n**Description:** Fetch a web page and extract main text content.\n\n**Key Features:**\n- Uses trafilatura for content extraction\n- Returns metadata (title, author, date, etc.)\n- May fail on JavaScript-heavy sites\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `url` | string | Yes | - | URL to fetch |\n\n**Error Handling:**\n- Network errors (DNS resolution, connection failures)\n- HTTP errors (404, 403, etc.)\n- Extraction failures (JavaScript-driven sites)\n\n**Sources:** [tests/test_tool_descriptions.py:257-261](), [tests/test_tool_schemas.py:379-392](), [tests/test_fetch_url.py:1-97]()\n\n---\n\n### System Execution Tools (1 tool)\n\n#### Bash\n\n**Module:** `kimi_cli.tools.bash:Bash`\n\n**Description:** Execute shell commands with comprehensive system access.\n\n**Requires Approval:** Yes\n\n**Key Features:**\n- Fresh shell environment per call (no state preservation)\n- Combined stdout/stderr output\n- Configurable timeout\n- Output truncation for long results\n\n**Safety Guidelines:**\n- Avoid `..` to access outside working directory\n- Never modify files outside working directory unless instructed\n- Never run privileged commands unless instructed\n- Don't use for interactive or long-running commands\n\n**Efficiency Guidelines:**\n- Chain related commands with `\u0026\u0026`, `;`, `||`\n- Use pipes (`|`) and redirections (`\u003e`, `\u003e\u003e`)\n- Quote paths with spaces\n- Use control flows (`if`, `case`, `for`, `while`)\n- Verify directory structure before operations\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `command` | string | Yes | - | Bash command to execute |\n| `timeout` | integer | No | 60 | Timeout in seconds (1-300) |\n\n**Available Commands:**\n- Shell: `cd`, `pwd`, `export`, `env`\n- File system: `ls`, `find`, `mkdir`, `rm`, `cp`, `mv`, `touch`, `chmod`\n- File viewing: `cat`, `grep`, `head`, `tail`, `diff`, `patch`\n- Text processing: `awk`, `sed`, `sort`, `uniq`, `wc`\n- System: `ps`, `kill`, `top`, `df`, `free`, `uname`, `date`\n- Package managers: `pip`, `uv`, `npm`, `yarn`, `bun`, `cargo`\n- Network: `curl`, `wget`, `ping`, `telnet`, `ssh`\n- Archive: `tar`, `zip`, `unzip`\n\n**Sources:** [tests/test_tool_descriptions.py:107-143](), [tests/test_tool_schemas.py:113-133]()\n\n---\n\n### Task Management Tools (2 tools)\n\n#### Task\n\n**Module:** `kimi_cli.tools.task:Task`\n\n**Description:** Spawn subagents to perform specific tasks with isolated contexts.\n\n**Key Use Cases:**\n\n**Context Isolation:**\n- Fix code with detailed debugging process\n- Gather specific knowledge from internet without polluting context\n- Search for specific solutions\n\n**Parallel Multi-Tasking:**\n- Work on multiple independent modules/files\n- Analyze different parts of large codebase\n- Perform multiple web searches simultaneously\n\n**Important Guidelines:**\n- DO NOT forward user prompts directly to Task\n- DO NOT spawn Task for each todo item\n- Only spawn for specific, narrow tasks\n- Provide detailed prompts with all necessary background\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `description` | string | Yes | - | Short 3-5 word task description |\n| `subagent_name` | string | Yes | - | Name of specialized subagent |\n| `prompt` | string | Yes | - | Detailed task prompt with full context |\n\n**Available Subagents:**\n- `koder` - General software engineering tasks\n\n**Sources:** [tests/test_tool_descriptions.py:20-51](), [tests/test_tool_schemas.py:20-41]()\n\n---\n\n#### SetTodoList\n\n**Module:** `kimi_cli.tools.todo:SetTodoList`\n\n**Description:** Update the complete todo list for progress tracking.\n\n**When to Use:**\n- Task involves multiple subtasks/milestones\n- Multiple tasks in single request\n- Need to track progress\n\n**When NOT to Use:**\n- Simple questions (\"What language is used?\")\n- Few-step tasks (\"Fix unit test function\")\n- Specific brainless instructions (\"Replace x with y\")\n\n**Key Features:**\n- Update entire list each time\n- Three statuses: Pending, In Progress, Done\n- Include self-encouragement on completion\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `todos` | Todo[] | Yes | - | Complete updated todo list |\n| `todos[].title` | string | Yes | - | Todo title |\n| `todos[].status` | enum | Yes | - | Status: Pending, In Progress, Done |\n\n**Sources:** [tests/test_tool_descriptions.py:84-104](), [tests/test_tool_schemas.py:78-110]()\n\n---\n\n### Meta Tools (3 tools)\n\n#### Think\n\n**Module:** `kimi_cli.tools.think:Think`\n\n**Description:** Append thoughts to log for complex reasoning or caching.\n\n**Use Cases:**\n- Complex reasoning steps\n- Temporary memory/cache\n- Internal deliberation\n\n**Note:** Does not obtain new information or modify state.\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `thought` | string | Yes | - | Thought to log |\n\n**Sources:** [tests/test_tool_descriptions.py:77-81](), [tests/test_tool_schemas.py:62-75]()\n\n---\n\n#### SendDMail\n\n**Module:** `kimi_cli.tools.dmail:SendDMail`\n\n**Description:** Send messages to past context checkpoints (time travel).\n\n**How It Works:**\n- User messages contain `CHECKPOINT {id}` markers in `\u003csystem\u003e` tags\n- Select checkpoint ID to revert to\n- System reverts context to checkpoint\n- DMail message appended after checkpoint\n- Future messages after checkpoint are lost\n\n**Typical Scenarios:**\n- Large file read with mostly irrelevant content\n- Large web search results (useful or not useful)\n- Struggling code fixes with irrelevant debug process\n\n**Important:** Minimize explanation to user - focus on explaining to past self.\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `message` | string | Yes | - | Message to past self |\n| `checkpoint_id` | integer | Yes | - | Target checkpoint ID |\n\n**Sources:** [tests/test_tool_descriptions.py:54-74](), [tests/test_tool_schemas.py:44-59]()\n\n---\n\n## Tool Loading Error Handling\n\nThe `_load_tools()` function tracks failed tool loads:\n\n```mermaid\ngraph TB\n    ToolSpec[\"Tool Specification\u003cbr/\u003emodule:class string\"]\n    \n    ParseSpec[\"Parse module:class\"]\n    ImportModule[\"import_module()\"]\n    GetClass[\"getattr(module, class)\"]\n    \n    InspectSig[\"inspect.signature()\"]\n    MatchDeps[\"Match parameters\u003cbr/\u003eto dependency map\"]\n    \n    Instantiate[\"Instantiate tool\"]\n    AddToToolset[\"Add to CustomToolset\"]\n    \n    BadTools[\"bad_tools list\"]\n    \n    ToolSpec --\u003e ParseSpec\n    ParseSpec --\u003e ImportModule\n    ImportModule --\u003e|Success| GetClass\n    ImportModule --\u003e|Error| BadTools\n    GetClass --\u003e|Success| InspectSig\n    GetClass --\u003e|Error| BadTools\n    \n    InspectSig --\u003e MatchDeps\n    MatchDeps --\u003e Instantiate\n    Instantiate --\u003e|Success| AddToToolset\n    Instantiate --\u003e|Error| BadTools\n```\n\nInvalid tools are collected and reported. If any tools fail to load, agent initialization raises `ValueError` with the list of bad tool paths.\n\n**Sources:** [tests/test_load_agent.py:153-172](), [tests/test_load_agent.py:201-204]()"])</script><script>self.__next_f.push([1,"27:T6e3b,"])</script><script>self.__next_f.push([1,"# File System Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis document covers the file system tools available in kimi-cli, which provide comprehensive file manipulation capabilities for agents. These tools enable reading, writing, searching, and patching files within the working directory.\n\nFor information about web-based tools (SearchWeb, FetchURL), see [Web Tools](#6.2). For shell command execution, see [System Execution Tools](#6.3). For agent delegation and task management, see [Task Management Tools](#6.4).\n\n## Overview\n\nThe file system tool suite consists of six specialized tools that agents use to interact with the local filesystem. These tools are implemented in the `kimi_cli/tools/file/` directory and follow a common architecture based on the `CallableTool2` base class.\n\n### Tool Categories\n\n| Tool | Purpose | Primary Use Case |\n|------|---------|-----------------|\n| ReadFile | Read file contents with line-based control | Inspecting code, configuration, documentation |\n| WriteFile | Create or overwrite files | Generating new files, complete rewrites |\n| PatchFile | Apply unified diff patches | Precise edits to existing files |\n| StrReplaceFile | String-based find and replace | Simple text substitutions |\n| Glob | Find files using glob patterns | Discovering project structure |\n| Grep | Search file contents using regex | Finding specific code or text patterns |\n\n**Architecture: File System Tool Hierarchy**\n\n```mermaid\ngraph TB\n    CallableTool2[\"CallableTool2\u003cbr/\u003e(Base Class)\"]\n    \n    subgraph FileTools[\"File System Tools\"]\n        ReadFile[\"ReadFile\u003cbr/\u003ekimi_cli/tools/file/read.py\"]\n        WriteFile[\"WriteFile\u003cbr/\u003ekimi_cli/tools/file/write.py\"]\n        PatchFile[\"PatchFile\u003cbr/\u003ekimi_cli/tools/file/patch.py\"]\n        StrReplace[\"StrReplaceFile\u003cbr/\u003ekimi_cli/tools/file/replace.py\"]\n        Glob[\"Glob\u003cbr/\u003ekimi_cli/tools/file/glob.py\"]\n        Grep[\"Grep\u003cbr/\u003ekimi_cli/tools/file/grep.py\"]\n    end\n    \n    subgraph Infrastructure[\"Tool Infrastructure\"]\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003e(Dependency Container)\"]\n        Approval[\"Approval System\"]\n        WorkDir[\"Working Directory\"]\n        Ripgrep[\"Ripgrep Binary\u003cbr/\u003e(External)\"]\n    end\n    \n    CallableTool2 --\u003e ReadFile\n    CallableTool2 --\u003e WriteFile\n    CallableTool2 --\u003e PatchFile\n    CallableTool2 --\u003e StrReplace\n    CallableTool2 --\u003e Glob\n    CallableTool2 --\u003e Grep\n    \n    ReadFile --\u003e AgentGlobals\n    WriteFile --\u003e AgentGlobals\n    WriteFile --\u003e Approval\n    PatchFile --\u003e AgentGlobals\n    StrReplace --\u003e AgentGlobals\n    Glob --\u003e AgentGlobals\n    Grep --\u003e AgentGlobals\n    Grep --\u003e Ripgrep\n    \n    AgentGlobals --\u003e WorkDir\n```\n\nSources: [tests/test_tool_descriptions.py:1-262](), [tests/test_tool_schemas.py:1-393]()\n\n## ReadFile\n\nThe `ReadFile` tool reads text file contents with fine-grained control over which lines to retrieve. It is optimized for parallel execution and includes automatic truncation for long lines.\n\n### Parameters\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to the file to read |\n| `line_offset` | integer | No | 1 | Line number to start reading from (1-indexed) |\n| `n_lines` | integer | No | 1000 | Number of lines to read (max 1000) |\n\n### Schema Definition\n\n```json\n{\n  \"properties\": {\n    \"path\": {\n      \"description\": \"The absolute path to the file to read\",\n      \"type\": \"string\"\n    },\n    \"line_offset\": {\n      \"default\": 1,\n      \"description\": \"The line number to start reading from\",\n      \"minimum\": 1,\n      \"type\": \"integer\"\n    },\n    \"n_lines\": {\n      \"default\": 1000,\n      \"description\": \"The number of lines to read\",\n      \"minimum\": 1,\n      \"type\": \"integer\"\n    }\n  },\n  \"required\": [\"path\"],\n  \"type\": \"object\"\n}\n```\n\n### Key Features\n\n- **Line-numbered output**: Content is returned with line numbers in `cat -n` format\n- **Partial reading**: Use `line_offset` and `n_lines` for large files\n- **Automatic truncation**: Lines longer than 2000 characters are truncated with \"...\"\n- **Parallel execution**: Designed for reading multiple files in one agent response\n- **System notifications**: Alerts when limits are hit during reading\n- **Text files only**: For directories, use Glob or Bash `ls`; for binary files, use Bash tools\n\n### Usage Guidelines\n\nFrom the tool description [tests/test_tool_descriptions.py:148-164]():\n\n\u003e - Make sure you follow the description of each tool parameter.\n\u003e - A `\u003csystem\u003e` tag will be given before the read file content.\n\u003e - Content will be returned with a line number before each line like `cat -n` format.\n\u003e - Use `line_offset` and `n_lines` parameters when you only need to read a part of the file.\n\u003e - The maximum number of lines that can be read at once is 1000.\n\u003e - Any lines longer than 2000 characters will be truncated, ending with \"...\".\n\u003e - The system will notify you when there is any limitation hit when reading the file.\n\u003e - This tool is a tool that you typically want to use in parallel. Always read multiple files in one response when possible.\n\u003e - This tool can only read text files. To list directories, you must use the Glob tool or `ls` command via the Bash tool. To read other file types, use appropriate commands via the Bash tool.\n\u003e - If the file doesn't exist or path is invalid, an error will be returned.\n\u003e - If you want to search for a certain content/pattern, prefer Grep tool over ReadFile.\n\n**ReadFile Execution Flow**\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant ReadFile\n    participant FileSystem\n    \n    Agent-\u003e\u003eReadFile: \"ReadFile(path='/path/to/file.py', line_offset=50, n_lines=100)\"\n    ReadFile-\u003e\u003eFileSystem: \"Check file exists and is text file\"\n    \n    alt File not found\n        FileSystem--\u003e\u003eReadFile: \"Error: File not found\"\n        ReadFile--\u003e\u003eAgent: \"ToolError: File doesn't exist\"\n    else File exists\n        FileSystem--\u003e\u003eReadFile: \"File accessible\"\n        ReadFile-\u003e\u003eFileSystem: \"Read lines 50-149\"\n        FileSystem--\u003e\u003eReadFile: \"Content with line numbers\"\n        \n        ReadFile-\u003e\u003eReadFile: \"Truncate lines \u003e 2000 chars\"\n        ReadFile-\u003e\u003eReadFile: \"Check if limits hit\"\n        \n        alt Limits hit\n            ReadFile-\u003e\u003eReadFile: \"Add system notification\"\n        end\n        \n        ReadFile--\u003e\u003eAgent: \"ToolOk: Line-numbered content\"\n    end\n```\n\nSources: [tests/test_tool_schemas.py:136-161](), [tests/test_tool_descriptions.py:146-165]()\n\n## WriteFile\n\nThe `WriteFile` tool creates new files or modifies existing files with two modes: overwrite and append. This tool requires approval when operating in certain modes.\n\n### Parameters\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to the file to write |\n| `content` | string | Yes | - | Content to write to the file |\n| `mode` | enum | No | \"overwrite\" | Write mode: \"overwrite\" or \"append\" |\n\n### Schema Definition\n\n```json\n{\n  \"properties\": {\n    \"path\": {\n      \"description\": \"The absolute path to the file to write\",\n      \"type\": \"string\"\n    },\n    \"content\": {\n      \"description\": \"The content to write to the file\",\n      \"type\": \"string\"\n    },\n    \"mode\": {\n      \"default\": \"overwrite\",\n      \"description\": \"The mode to use to write to the file\",\n      \"enum\": [\"overwrite\", \"append\"],\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"path\", \"content\"],\n  \"type\": \"object\"\n}\n```\n\n### Usage Guidelines\n\nFrom the tool description [tests/test_tool_descriptions.py:206-216]():\n\n\u003e - When `mode` is not specified, it defaults to `overwrite`. Always write with caution.\n\u003e - When the content to write is too long (e.g. \u003e 100 lines), use this tool multiple times instead of a single call. Use `overwrite` mode at the first time, then use `append` mode after the first write.\n\n### Write Modes\n\n1. **Overwrite mode** (default):\n   - Replaces entire file content\n   - Creates file if it doesn't exist\n   - Requires user approval in interactive mode\n\n2. **Append mode**:\n   - Adds content to end of existing file\n   - Useful for splitting large writes across multiple tool calls\n   - More efficient for incremental content generation\n\nSources: [tests/test_tool_schemas.py:261-284](), [tests/test_tool_descriptions.py:206-216]()\n\n## PatchFile\n\nThe `PatchFile` tool applies unified diff patches to files, providing precise control over file modifications. This is the preferred method for editing existing files.\n\n### Parameters\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `path` | string | Yes | - | Absolute path to the file to patch |\n| `diff` | string | Yes | - | Unified diff format content |\n\n### Schema Definition\n\n```json\n{\n  \"properties\": {\n    \"path\": {\n      \"description\": \"The absolute path to the file to apply the patch to\",\n      \"type\": \"string\"\n    },\n    \"diff\": {\n      \"description\": \"The diff content in unified format to apply\",\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"path\", \"diff\"],\n  \"type\": \"object\"\n}\n```\n\n### Key Features\n\n- **Unified diff format**: Compatible with `diff -u` and `git diff` output\n- **Clean application**: Fails with error if patch doesn't apply cleanly\n- **Text files only**: Designed for text file modifications\n- **File must exist**: Cannot create new files, only modify existing ones\n- **Preferred over WriteFile**: Better for editing existing files\n\n### Usage Guidelines\n\nFrom the tool description [tests/test_tool_descriptions.py:234-247]():\n\n\u003e - The patch must be in unified diff format, the format used by `diff -u` and `git diff`.\n\u003e - Only use this tool on text files.\n\u003e - The tool will fail with error returned if the patch doesn't apply cleanly.\n\u003e - The file must exist before applying the patch.\n\u003e - You should prefer this tool over WriteFile tool and Bash `sed` command when editing an existing file.\n\n**PatchFile vs StrReplaceFile vs WriteFile**\n\n```mermaid\ngraph TD\n    EditDecision[\"Need to Modify File?\"]\n    \n    EditDecision --\u003e|\"Create new file\"| UseWrite[\"Use WriteFile\u003cbr/\u003emode=overwrite\"]\n    EditDecision --\u003e|\"Precise line-level changes\"| UsePatch[\"Use PatchFile\u003cbr/\u003eunified diff\"]\n    EditDecision --\u003e|\"Simple string replacement\"| UseReplace[\"Use StrReplaceFile\u003cbr/\u003eold/new pairs\"]\n    EditDecision --\u003e|\"Complete rewrite\"| UseWrite\n    EditDecision --\u003e|\"Complex transformations\"| CheckSize[\"Large file?\"]\n    \n    CheckSize --\u003e|\"Yes\"| UsePatch\n    CheckSize --\u003e|\"No\"| UseWrite\n    \n    UsePatch --\u003e PatchBenefits[\"Benefits:\u003cbr/\u003e- Shows exact changes\u003cbr/\u003e- Handles context\u003cbr/\u003e- Fails safely\"]\n    UseReplace --\u003e ReplaceBenefits[\"Benefits:\u003cbr/\u003e- Simple syntax\u003cbr/\u003e- Multi-line support\u003cbr/\u003e- Multiple edits\"]\n    UseWrite --\u003e WriteBenefits[\"Benefits:\u003cbr/\u003e- Full control\u003cbr/\u003e- Can append\u003cbr/\u003e- Creates files\"]\n```\n\nSources: [tests/test_tool_schemas.py:331-348](), [tests/test_tool_descriptions.py:234-247]()\n\n## StrReplaceFile\n\nThe `StrReplaceFile` tool performs string-based find-and-replace operations within files. It supports single or multiple edits in one call and handles multi-line strings.\n\n### Parameters\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `path` | string | Yes | Absolute path to the file to edit |\n| `edit` | Edit or Edit[] | Yes | Single edit or array of edits to apply |\n\n### Edit Object Schema\n\n| Field | Type | Required | Default | Description |\n|-------|------|----------|---------|-------------|\n| `old` | string | Yes | - | The old string to replace (multi-line supported) |\n| `new` | string | Yes | - | The new string to replace with (multi-line supported) |\n| `replace_all` | boolean | No | false | Whether to replace all occurrences |\n\n### Full Schema Definition\n\n```json\n{\n  \"$defs\": {\n    \"Edit\": {\n      \"properties\": {\n        \"old\": {\n          \"description\": \"The old string to replace. Can be multi-line.\",\n          \"type\": \"string\"\n        },\n        \"new\": {\n          \"description\": \"The new string to replace with. Can be multi-line.\",\n          \"type\": \"string\"\n        },\n        \"replace_all\": {\n          \"default\": false,\n          \"description\": \"Whether to replace all occurrences.\",\n          \"type\": \"boolean\"\n        }\n      },\n      \"required\": [\"old\", \"new\"],\n      \"type\": \"object\"\n    }\n  },\n  \"properties\": {\n    \"path\": {\n      \"description\": \"The absolute path to the file to edit.\",\n      \"type\": \"string\"\n    },\n    \"edit\": {\n      \"anyOf\": [\n        {\"$ref\": \"#/$defs/Edit\"},\n        {\"items\": {\"$ref\": \"#/$defs/Edit\"}, \"type\": \"array\"}\n      ],\n      \"description\": \"The edit(s) to apply to the file.\"\n    }\n  },\n  \"required\": [\"path\", \"edit\"],\n  \"type\": \"object\"\n}\n```\n\n### Key Features\n\n- **Text files only**: Designed for text file modifications\n- **Multi-line support**: Both `old` and `new` strings can span multiple lines\n- **Single or batch**: Apply one edit or multiple edits in a single call\n- **Preferred over WriteFile**: Better for simple string replacements\n- **Preferred over Bash sed**: More reliable than shell commands\n\n### Usage Guidelines\n\nFrom the tool description [tests/test_tool_descriptions.py:219-231]():\n\n\u003e - Only use this tool on text files.\n\u003e - Multi-line strings are supported.\n\u003e - Can specify a single edit or a list of edits in one call.\n\u003e - You should prefer this tool over WriteFile tool and Bash `sed` command.\n\nSources: [tests/test_tool_schemas.py:287-328](), [tests/test_tool_descriptions.py:219-231]()\n\n## Glob\n\nThe `Glob` tool finds files and directories using glob patterns. It supports standard glob syntax including recursive searches with `**`.\n\n### Parameters\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `pattern` | string | Yes | - | Glob pattern to match files/directories |\n| `directory` | string or null | No | null | Absolute path to search directory (defaults to working directory) |\n| `include_dirs` | boolean | No | true | Whether to include directories in results |\n\n### Schema Definition\n\n```json\n{\n  \"properties\": {\n    \"pattern\": {\n      \"description\": \"Glob pattern to match files/directories.\",\n      \"type\": \"string\"\n    },\n    \"directory\": {\n      \"anyOf\": [{\"type\": \"string\"}, {\"type\": \"null\"}],\n      \"default\": null,\n      \"description\": \"Absolute path to the directory to search in (defaults to working directory).\"\n    },\n    \"include_dirs\": {\n      \"default\": true,\n      \"description\": \"Whether to include directories in results.\",\n      \"type\": \"boolean\"\n    }\n  },\n  \"required\": [\"pattern\"],\n  \"type\": \"object\"\n}\n```\n\n### Pattern Syntax\n\n| Pattern | Matches | Example |\n|---------|---------|---------|\n| `*` | Any characters except `/` | `*.py` matches `test.py` |\n| `?` | Single character | `test?.py` matches `test1.py` |\n| `**` | Recursive subdirectories | `src/**/*.js` matches all JS files in src |\n| `{a,b}` | Either a or b | `*.{js,ts}` matches JS and TS files |\n\n### Usage Guidelines and Restrictions\n\nFrom the tool description [tests/test_tool_descriptions.py:168-190]():\n\n**When to use:**\n- Find files matching specific patterns (e.g., all Python files: `*.py`)\n- Search for files recursively in subdirectories (e.g., `src/**/*.js`)\n- Locate configuration files (e.g., `*.config.*`, `*.json`)\n- Find test files (e.g., `test_*.py`, `*_test.go`)\n\n**Example patterns:**\n- `*.py` - All Python files in current directory\n- `src/**/*.js` - All JavaScript files in src directory recursively\n- `test_*.py` - Python test files starting with \"test_\"\n- `*.config.{js,ts}` - Config files with .js or .ts extension\n\n**Bad example patterns:**\n- `**`, `**/*.py` - Any pattern starting with '**' will be rejected. Because it would recursively search all directories and subdirectories, which is very likely to yield large result that exceeds your context size. Always use more specific patterns like `src/**/*.py` instead.\n- `node_modules/**/*.js` - Although this does not start with '**', it would still highly possible to yield large result because `node_modules` is well-known to contain too many directories and files. Avoid recursively searching in such directories, other examples include `venv`, `.venv`, `__pycache__`, `target`. If you really need to search in a dependency, use more specific patterns like `node_modules/react/src/*` instead.\n\n**Glob Pattern Safety**\n\n```mermaid\ngraph TB\n    Pattern[\"Glob Pattern\"]\n    \n    Pattern --\u003e Check1{\"Starts with '**'?\"}\n    Check1 --\u003e|Yes| Reject1[\" REJECTED\u003cbr/\u003eToo broad - will search everything\"]\n    Check1 --\u003e|No| Check2{\"Searches known\u003cbr/\u003edependency dirs?\"}\n    \n    Check2 --\u003e|\"Yes\u003cbr/\u003e(node_modules, venv, etc)\"| Warn[\" WARNING\u003cbr/\u003eMay yield too many results\"]\n    Check2 --\u003e|No| Check3{\"Has specific\u003cbr/\u003edirectory prefix?\"}\n    \n    Check3 --\u003e|Yes| Accept[\" ACCEPTED\u003cbr/\u003ee.g., src/**/*.py\"]\n    Check3 --\u003e|No| Specific{\"Specific enough?\"}\n    \n    Specific --\u003e|\"Yes\u003cbr/\u003e(*.config.js)\"| Accept\n    Specific --\u003e|\"No\u003cbr/\u003e(*.js)\"| Warn\n    \n    Warn --\u003e Refine[\"Refine pattern to be\u003cbr/\u003emore specific\"]\n```\n\nSources: [tests/test_tool_schemas.py:164-187](), [tests/test_tool_descriptions.py:168-190]()\n\n## Grep\n\nThe `Grep` tool provides powerful search capabilities based on ripgrep. It searches file contents using regular expressions with various output modes and filtering options.\n\n### Parameters\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `pattern` | string | Yes | - | Regular expression pattern (ripgrep syntax) |\n| `path` | string | No | \".\" | File or directory to search (absolute path) |\n| `glob` | string or null | No | null | Glob pattern to filter files (e.g., `*.js`) |\n| `output_mode` | string | No | \"files_with_matches\" | Output format (see below) |\n| `-B` | integer or null | No | null | Lines of context before match |\n| `-A` | integer or null | No | null | Lines of context after match |\n| `-C` | integer or null | No | null | Lines of context before and after match |\n| `-n` | boolean | No | false | Show line numbers |\n| `-i` | boolean | No | false | Case insensitive search |\n| `type` | string or null | No | null | File type (py, rust, js, ts, go, java, etc.) |\n| `head_limit` | integer or null | No | null | Limit output to first N items |\n| `multiline` | boolean | No | false | Enable multiline mode |\n\n### Output Modes\n\n| Mode | Description | Supports Context | Use Case |\n|------|-------------|------------------|----------|\n| `files_with_matches` | Shows only file paths | No (but supports `head_limit`) | Finding which files contain pattern |\n| `content` | Shows matching lines | Yes (supports `-B`, `-A`, `-C`, `-n`, `head_limit`) | Viewing actual matches with context |\n| `count_matches` | Shows total match count | No (but supports `head_limit`) | Getting statistics |\n\n### Schema Definition (Excerpt)\n\n```json\n{\n  \"properties\": {\n    \"pattern\": {\n      \"description\": \"The regular expression pattern to search for\",\n      \"type\": \"string\"\n    },\n    \"output_mode\": {\n      \"default\": \"files_with_matches\",\n      \"description\": \"`content`: Show matching lines; `files_with_matches`: Show file paths; `count_matches`: Show total matches\",\n      \"type\": \"string\"\n    },\n    \"type\": {\n      \"description\": \"File type to search. Examples: py, rust, js, ts, go, java, etc. More efficient than `glob` for standard file types.\",\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\"pattern\"],\n  \"type\": \"object\"\n}\n```\n\n### Key Features\n\n- **Ripgrep-based**: Fast, powerful search using external ripgrep binary\n- **Regular expression**: Supports ripgrep pattern syntax (not grep syntax)\n- **Multiple output modes**: Files only, content with context, or counts\n- **File type filtering**: Use `type` parameter for common file types\n- **Glob filtering**: Use `glob` for custom file patterns\n- **Context control**: Show lines before/after matches with `-B`, `-A`, `-C`\n- **Multiline mode**: Enable with `multiline` for patterns spanning lines\n\n### Important: Ripgrep Syntax\n\nFrom the tool description [tests/test_tool_descriptions.py:193-203]():\n\n\u003e - ALWAYS use Grep tool instead of running `grep` or `rg` command with Bash tool.\n\u003e - Use the ripgrep pattern syntax, not grep syntax. E.g. you need to escape braces like `\\\\{` to search for `{`.\n\n**Grep Usage Patterns**\n\n```mermaid\ngraph LR\n    SearchTask[\"Search Task\"]\n    \n    SearchTask --\u003e Q1{\"Need to see\u003cbr/\u003ematches?\"}\n    \n    Q1 --\u003e|\"No, just files\"| FilesMode[\"output_mode=files_with_matches\u003cbr/\u003eFast, concise\"]\n    Q1 --\u003e|\"Yes, need content\"| ContentMode[\"output_mode=content\u003cbr/\u003eUse -B, -A, -C for context\"]\n    Q1 --\u003e|\"Just count\"| CountMode[\"output_mode=count_matches\u003cbr/\u003eStatistics only\"]\n    \n    FilesMode --\u003e Filter{\"Need to filter\u003cbr/\u003efile types?\"}\n    ContentMode --\u003e Filter\n    CountMode --\u003e Filter\n    \n    Filter --\u003e|\"Standard type\"| TypeParam[\"Use type=py, js, etc.\u003cbr/\u003eMore efficient\"]\n    Filter --\u003e|\"Custom pattern\"| GlobParam[\"Use glob=*.config.js\u003cbr/\u003eFlexible\"]\n    Filter --\u003e|\"No filter\"| Execute[\"Execute search\"]\n    \n    TypeParam --\u003e Execute\n    GlobParam --\u003e Execute\n```\n\nSources: [tests/test_tool_schemas.py:190-258](), [tests/test_tool_descriptions.py:193-203]()\n\n## Tool Integration and Execution\n\n### Tool Selection Logic\n\nThe following decision matrix helps determine which file tool to use for common tasks:\n\n| Task | Recommended Tool | Alternative | Reason |\n|------|-----------------|-------------|---------|\n| Read file content | ReadFile | Bash `cat` | Line-numbered, parallel-friendly |\n| Find files by name | Glob | Bash `find` | Clean pattern syntax |\n| Search file contents | Grep | - | Ripgrep-based, powerful filtering |\n| Create new file | WriteFile | Bash redirect | Approval workflow integration |\n| Edit existing file | PatchFile | StrReplaceFile | Shows exact changes, safer |\n| Simple string replace | StrReplaceFile | Bash `sed` | Multi-line support, cleaner |\n| List directory | Bash `ls` | Glob | Glob returns paths, not details |\n| Complex edits | PatchFile + ReadFile | WriteFile | Better context management |\n\n**File Tool Interaction Patterns**\n\n```mermaid\ngraph TB\n    Agent[\"Agent Decision\"]\n    \n    Agent --\u003e Discover[\"Discovery Phase\"]\n    Agent --\u003e Analysis[\"Analysis Phase\"]\n    Agent --\u003e Modification[\"Modification Phase\"]\n    \n    Discover --\u003e Glob[\"Glob\u003cbr/\u003eFind matching files\"]\n    Discover --\u003e Grep[\"Grep\u003cbr/\u003eSearch content\"]\n    \n    Glob --\u003e ReadFile[\"ReadFile\u003cbr/\u003eInspect files\"]\n    Grep --\u003e ReadFile\n    \n    Analysis --\u003e ReadFile\n    \n    ReadFile --\u003e Decide[\"Decide Modification\u003cbr/\u003eStrategy\"]\n    \n    Decide --\u003e SimpleReplace[\"Simple text change?\"]\n    Decide --\u003e PreciseEdit[\"Precise line edit?\"]\n    Decide --\u003e CompleteRewrite[\"Full rewrite?\"]\n    \n    SimpleReplace --\u003e StrReplaceFile[\"StrReplaceFile\u003cbr/\u003eold/new pairs\"]\n    PreciseEdit --\u003e PatchFile[\"PatchFile\u003cbr/\u003eunified diff\"]\n    CompleteRewrite --\u003e WriteFile[\"WriteFile\u003cbr/\u003emode=overwrite\"]\n    \n    StrReplaceFile --\u003e Verify[\"Verification\"]\n    PatchFile --\u003e Verify\n    WriteFile --\u003e Verify\n    \n    Verify --\u003e Bash[\"Bash\u003cbr/\u003eTest/compile/run\"]\n    Verify --\u003e ReadFile2[\"ReadFile\u003cbr/\u003eConfirm changes\"]\n```\n\n### Approval Requirements\n\nFile system tools integrate with the approval system [tests/test_tool_descriptions.py:206-216]():\n\n- **WriteFile**: Requires approval for overwrite mode in interactive sessions\n- **ReadFile**: No approval required (read-only)\n- **PatchFile**: No approval required (applies specific changes)\n- **StrReplaceFile**: No approval required (predictable replacements)\n- **Glob**: No approval required (read-only)\n- **Grep**: No approval required (read-only)\n\n### Working Directory Context\n\nAll file paths must be absolute paths. Tools access the working directory through `AgentGlobals`:\n\n```\nAgentGlobals\n   working_dir: Path\n       Used by all file tools for path resolution\n       Set at agent initialization\n```\n\nSources: [tests/test_tool_descriptions.py:1-262](), [tests/test_tool_schemas.py:1-393]()\n\n## Tool Implementation Details\n\n### Base Class Hierarchy\n\nAll file system tools inherit from `CallableTool2` base class, which provides:\n\n- JSON schema generation for parameters\n- Tool description formatting\n- Integration with kosong library\n- Async execution support\n- Error handling with `ToolError` and `ToolOk` return types\n\n### External Dependencies\n\n**Grep Tool - Ripgrep Integration**\n\nThe Grep tool depends on an external `ripgrep` binary:\n- Binary is managed through the configuration system\n- Must be available on the system PATH or configured explicitly\n- Provides significantly faster search than Python-based solutions\n- Supports advanced regex features and file type detection\n\n**Tool Execution Pattern**\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant KimiSoul\n    participant FileTool[\"File Tool\u003cbr/\u003e(ReadFile/WriteFile/etc)\"]\n    participant AgentGlobals\n    participant FileSystem\n    \n    Agent-\u003e\u003eKimiSoul: \"Generate tool call\"\n    KimiSoul-\u003e\u003eFileTool: \"async __call__(params)\"\n    FileTool-\u003e\u003eAgentGlobals: \"Get working_dir\"\n    AgentGlobals--\u003e\u003eFileTool: \"Path object\"\n    \n    FileTool-\u003e\u003eFileTool: \"Validate parameters\"\n    FileTool-\u003e\u003eFileTool: \"Resolve absolute path\"\n    \n    alt Needs Approval (WriteFile overwrite)\n        FileTool-\u003e\u003eWire: \"ApprovalRequest event\"\n        Wire-\u003e\u003eUser: \"Show approval dialog\"\n        User--\u003e\u003eWire: \"Approve/Reject\"\n        Wire--\u003e\u003eFileTool: \"Approval response\"\n        \n        alt Rejected\n            FileTool--\u003e\u003eKimiSoul: \"ToolError: Rejected by user\"\n        end\n    end\n    \n    FileTool-\u003e\u003eFileSystem: \"Perform operation\"\n    \n    alt Operation succeeds\n        FileSystem--\u003e\u003eFileTool: \"Success\"\n        FileTool--\u003e\u003eKimiSoul: \"ToolOk: Result\"\n    else Operation fails\n        FileSystem--\u003e\u003eFileTool: \"Error\"\n        FileTool--\u003e\u003eKimiSoul: \"ToolError: Description\"\n    end\n    \n    KimiSoul-\u003e\u003eContext: \"Append tool result\"\n```\n\nSources: [tests/test_tool_descriptions.py:1-262](), Diagram 3 from high-level architecture\n\n## Best Practices\n\n### Parallel Tool Execution\n\nReadFile is specifically designed for parallel execution [tests/test_tool_descriptions.py:160]():\n\n\u003e This tool is a tool that you typically want to use in parallel. Always read multiple files in one response when possible.\n\n**Example pattern**: When analyzing a project structure, an agent can call ReadFile multiple times in a single response to read `main.py`, `config.py`, and `utils.py` simultaneously.\n\n### Large File Handling\n\nFor files exceeding 1000 lines:\n\n1. Use ReadFile with `line_offset` and `n_lines` to read in chunks\n2. Combine with Grep to locate specific sections first\n3. For writing large files, use WriteFile multiple times with append mode [tests/test_tool_descriptions.py:214-215]():\n\n\u003e When the content to write is too long (e.g. \u003e 100 lines), use this tool multiple times instead of a single call. Use `overwrite` mode at the first time, then use `append` mode after the first write.\n\n### Search Strategy\n\nPrefer Grep over ReadFile for searching [tests/test_tool_descriptions.py:163]():\n\n\u003e If you want to search for a certain content/pattern, prefer Grep tool over ReadFile.\n\n**Search workflow**:\n1. Use Grep with `files_with_matches` to find relevant files\n2. Use Grep with `content` mode to see specific matches\n3. Use ReadFile to inspect full file context if needed\n\n### Edit Strategy\n\nTool preference for file modifications [tests/test_tool_descriptions.py:229-230](), [tests/test_tool_descriptions.py:245]():\n\n1. **PatchFile**: Preferred for editing existing files with precise changes\n2. **StrReplaceFile**: Good for simple string replacements\n3. **WriteFile**: Use for creating new files or complete rewrites\n4. **Avoid Bash sed**: File tools provide better error handling and approval workflow\n\nSources: [tests/test_tool_descriptions.py:146-247](), [tests/test_tool_schemas.py:136-348]()"])</script><script>self.__next_f.push([1,"28:T392d,"])</script><script>self.__next_f.push([1,"# Web Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/agents/koder/agent.yaml](src/kimi_cli/agents/koder/agent.yaml)\n- [src/kimi_cli/agents/koder/sub.yaml](src/kimi_cli/agents/koder/sub.yaml)\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/tools/web/__init__.py](src/kimi_cli/tools/web/__init__.py)\n- [src/kimi_cli/tools/web/fetch.md](src/kimi_cli/tools/web/fetch.md)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis document covers the web access tools available in kimi-cli, specifically the `SearchWeb` and `FetchURL` tools. These tools enable agents to search the internet for information and fetch content from web pages. For information about other tool categories, see File System Tools ([#6.1](#6.1)), System Execution Tools ([#6.3](#6.3)), Task Management Tools ([#6.4](#6.4)), and Meta Tools ([#6.5](#6.5)).\n\n## Overview\n\nThe web tools provide agents with two complementary capabilities for accessing internet resources:\n\n| Tool | Purpose | Primary Use Case |\n|------|---------|------------------|\n| `SearchWeb` | Search the internet for information | Finding recent documentation, news, blog posts, papers |\n| `FetchURL` | Fetch and extract content from a specific URL | Reading full content of a known web page |\n\nBoth tools are designed to minimize token consumption while providing agents with access to up-to-date information beyond their training data.\n\n**Sources:** [src/kimi_cli/tools/web/search.py:37-40](), [tests/test_tool_descriptions.py:250-261]()\n\n## Tool Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Web Tool System\"\n        SearchWeb[\"SearchWeb\u003cbr/\u003e(CallableTool2)\"]\n        FetchURL[\"FetchURL\u003cbr/\u003e(CallableTool2)\"]\n    end\n    \n    subgraph \"Configuration\"\n        Config[\"Config\"]\n        Services[\"Services\"]\n        MoonshotSearch[\"MoonshotSearchConfig\u003cbr/\u003ebase_url, api_key\"]\n    end\n    \n    subgraph \"External Services\"\n        SearchAPI[\"Moonshot Search API\"]\n        WebPages[\"Web Pages\u003cbr/\u003e(HTTP/HTTPS)\"]\n    end\n    \n    subgraph \"Processing\"\n        HTTPClient[\"aiohttp.ClientSession\"]\n        ContentExtractor[\"trafilatura\u003cbr/\u003eContent Extraction\"]\n    end\n    \n    subgraph \"Tool Infrastructure\"\n        ToolBase[\"CallableTool2\"]\n        ToolResultBuilder[\"ToolResultBuilder\"]\n        ToolCallContext[\"get_current_tool_call_or_none\"]\n    end\n    \n    Config --\u003e Services\n    Services --\u003e MoonshotSearch\n    \n    SearchWeb --\u003e Config\n    SearchWeb --\u003e ToolBase\n    SearchWeb --\u003e HTTPClient\n    SearchWeb --\u003e ToolResultBuilder\n    SearchWeb --\u003e ToolCallContext\n    \n    FetchURL --\u003e ToolBase\n    FetchURL --\u003e HTTPClient\n    FetchURL --\u003e ContentExtractor\n    FetchURL --\u003e ToolResultBuilder\n    \n    SearchWeb --\u003e SearchAPI\n    FetchURL --\u003e WebPages\n    \n    MoonshotSearch --\u003e SearchAPI\n```\n\n**Sources:** [src/kimi_cli/tools/web/search.py:1-127](), [src/kimi_cli/config.py:46-64]()\n\n## SearchWeb Tool\n\n### Purpose and Functionality\n\nThe `SearchWeb` tool allows agents to search the internet for current information using the Moonshot Search service. The tool is implemented as a `CallableTool2[Params]` subclass in [src/kimi_cli/tools/web/search.py:37]().\n\nThe tool's description provided to the LLM is:\n\u003e \"WebSearch tool allows you to search on the internet to get latest information, including news, documents, release notes, blog posts, papers, etc.\"\n\n**Sources:** [tests/test_tool_descriptions.py:250-254]()\n\n### Configuration Requirements\n\n`SearchWeb` requires the `moonshot_search` service to be configured in the system configuration. The configuration structure is defined in [src/kimi_cli/config.py:46-64]():\n\n```mermaid\nclassDiagram\n    class MoonshotSearchConfig {\n        +base_url: str\n        +api_key: SecretStr\n        +dump_secret()\n    }\n    \n    class Services {\n        +moonshot_search: MoonshotSearchConfig | None\n    }\n    \n    class Config {\n        +services: Services\n        +default_model: str\n        +models: dict\n        +providers: dict\n        +loop_control: LoopControl\n    }\n    \n    Config --\u003e Services\n    Services --\u003e MoonshotSearchConfig\n```\n\nIf the service is not configured, the tool returns an error: `\"Search service is not configured. You may want to try other methods to search.\"`\n\n**Sources:** [src/kimi_cli/config.py:46-64](), [src/kimi_cli/tools/web/search.py:42-59]()\n\n### Parameters\n\nThe `SearchWeb` tool accepts the following parameters, defined in the `Params` class [src/kimi_cli/tools/web/search.py:14-35]():\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| `query` | `str` | Required | The query text to search for |\n| `limit` | `int` | 5 | Number of results to return (1-20) |\n| `include_content` | `bool` | `False` | Whether to include full page content in results |\n\nThe `include_content` parameter is explicitly designed to manage token consumption, with guidance that agents should \"avoid enabling this when `limit` is set to a large value.\"\n\n**Sources:** [src/kimi_cli/tools/web/search.py:14-35](), [tests/test_tool_schemas.py:351-376]()\n\n### Implementation Flow\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant SearchWeb\n    participant Config\n    participant ToolCallContext\n    participant HTTPClient\n    participant SearchAPI\n    participant ResultBuilder\n    \n    Agent-\u003e\u003eSearchWeb: __call__(params)\n    SearchWeb-\u003e\u003eConfig: Check moonshot_search config\n    \n    alt Service not configured\n        SearchWeb-\u003e\u003eResultBuilder: error(\"Service not configured\")\n        ResultBuilder--\u003e\u003eAgent: ToolError\n    else Service configured\n        SearchWeb-\u003e\u003eToolCallContext: get_current_tool_call_or_none()\n        ToolCallContext--\u003e\u003eSearchWeb: tool_call (with id)\n        \n        SearchWeb-\u003e\u003eHTTPClient: POST request\n        Note over SearchWeb,HTTPClient: Headers:\u003cbr/\u003e- User-Agent: kimi_cli.USER_AGENT\u003cbr/\u003e- Authorization: Bearer {api_key}\u003cbr/\u003e- X-Msh-Tool-Call-Id: {tool_call.id}\n        \n        HTTPClient-\u003e\u003eSearchAPI: POST with query params\n        SearchAPI--\u003e\u003eHTTPClient: JSON response\n        \n        alt HTTP error (status != 200)\n            SearchWeb-\u003e\u003eResultBuilder: error(\"Failed to search\")\n            ResultBuilder--\u003e\u003eAgent: ToolError\n        else Validation error\n            SearchWeb-\u003e\u003eResultBuilder: error(\"Failed to parse\")\n            ResultBuilder--\u003e\u003eAgent: ToolError\n        else Success\n            SearchWeb-\u003e\u003eResultBuilder: Format results\n            ResultBuilder--\u003e\u003eAgent: ToolOk with formatted output\n        end\n    end\n```\n\n**Sources:** [src/kimi_cli/tools/web/search.py:52-111]()\n\n### Request and Response Format\n\nThe tool sends a POST request to the configured search API with the following JSON payload [src/kimi_cli/tools/web/search.py:73-78]():\n\n```json\n{\n    \"text_query\": \"\u003cquery\u003e\",\n    \"limit\": 5,\n    \"enable_page_crawling\": false,\n    \"timeout_seconds\": 30\n}\n```\n\nThe response is parsed into `SearchResult` objects [src/kimi_cli/tools/web/search.py:114-123]():\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `site_name` | `str` | Name of the website |\n| `title` | `str` | Page title |\n| `url` | `str` | Page URL |\n| `snippet` | `str` | Summary/snippet of the page |\n| `content` | `str` | Full page content (if requested) |\n| `date` | `str` | Publication date |\n| `icon` | `str` | Site icon URL |\n| `mime` | `str` | Content MIME type |\n\nThe formatted output for each result [src/kimi_cli/tools/web/search.py:101-109]():\n\n```\nTitle: \u003ctitle\u003e\nDate: \u003cdate\u003e\nURL: \u003curl\u003e\nSummary: \u003csnippet\u003e\n\n\u003ccontent if include_content=True\u003e\n```\n\n**Sources:** [src/kimi_cli/tools/web/search.py:64-111](), [src/kimi_cli/tools/web/search.py:114-127]()\n\n### Error Handling\n\nThe tool handles three categories of errors:\n\n1. **Configuration Error**: Service not configured  Returns descriptive error suggesting alternative methods\n2. **HTTP Error**: Non-200 status code  Returns error indicating service may be unavailable\n3. **Validation Error**: Malformed response  Returns error with validation details\n\nAll errors are returned as `ToolError` with both a detailed message and a brief summary.\n\n**Sources:** [src/kimi_cli/tools/web/search.py:55-99]()\n\n## FetchURL Tool\n\n### Purpose and Functionality\n\nThe `FetchURL` tool fetches content from a specific URL and extracts the main text content using the `trafilatura` library. Unlike `SearchWeb`, this tool is used when the agent already knows the URL to fetch.\n\nThe tool's description provided to the LLM is:\n\u003e \"Fetch a web page from a URL and extract main text content from it.\"\n\n**Sources:** [tests/test_tool_descriptions.py:257-261](), [tests/test_fetch_url.py:1-97]()\n\n### Parameters\n\nThe `FetchURL` tool accepts a single required parameter:\n\n| Parameter | Type | Default | Description |\n|-----------|------|---------|-------------|\n| `url` | `str` | Required | The URL to fetch content from |\n\n**Sources:** [tests/test_tool_schemas.py:379-392]()\n\n### Content Extraction\n\n```mermaid\nflowchart TD\n    Start[\"FetchURL.__call__(params)\"]\n    Fetch[\"Fetch URL via aiohttp\"]\n    CheckStatus{HTTP Status?}\n    \n    Extract[\"Extract content with trafilatura\"]\n    CheckContent{Content\u003cbr/\u003eextracted?}\n    \n    FormatOutput[\"Format output with metadata\"]\n    \n    ErrorNetwork[\"Return ToolError:\u003cbr/\u003eNetwork error\"]\n    ErrorHTTP[\"Return ToolError:\u003cbr/\u003eHTTP status error\"]\n    ErrorExtract[\"Return ToolError:\u003cbr/\u003eFailed to extract content\"]\n    \n    Success[\"Return ToolOk:\u003cbr/\u003eFormatted content + metadata\"]\n    \n    Start --\u003e Fetch\n    Fetch --\u003e CheckStatus\n    \n    CheckStatus --\u003e|Network Error| ErrorNetwork\n    CheckStatus --\u003e|Status != 200| ErrorHTTP\n    CheckStatus --\u003e|Status = 200| Extract\n    \n    Extract --\u003e CheckContent\n    CheckContent --\u003e|No content| ErrorExtract\n    CheckContent --\u003e|Content found| FormatOutput\n    \n    FormatOutput --\u003e Success\n```\n\n**Sources:** [tests/test_fetch_url.py:13-97]()\n\n### Output Format\n\nWhen successful, `FetchURL` returns content in a structured format with metadata headers followed by the extracted text [tests/test_fetch_url.py:21-35]():\n\n```\n---\ntitle: \u003cpage title\u003e\nauthor: \u003cauthor\u003e\nurl: \u003curl\u003e\nhostname: \u003chostname\u003e\ndescription: \u003cdescription\u003e\nsitename: \u003csite name\u003e\ndate: \u003cpublication date\u003e\ncategories: \u003ccategories\u003e\n---\n\u003cextracted main text content\u003e\n```\n\nThis format provides agents with both metadata context and the actual content in a token-efficient manner.\n\n**Sources:** [tests/test_fetch_url.py:21-35]()\n\n### Error Scenarios\n\nThe tool handles several error conditions:\n\n| Error Type | Example | Error Message Pattern |\n|------------|---------|----------------------|\n| Invalid URL | Non-existent domain | \"Failed to fetch URL due to network error: ...\" |\n| HTTP Error | 404 Not Found | \"Failed to fetch URL. Status: 404. This may indicate...\" |\n| Malformed URL | \"not-a-valid-url\" | \"Failed to fetch URL due to network error: ...\" |\n| Empty URL | \"\" | \"Failed to fetch URL due to network error: .\" |\n| Extraction Failure | JavaScript-heavy site | \"failed to extract meaningful content\" |\n\n**Sources:** [tests/test_fetch_url.py:38-97]()\n\n### Limitations\n\nThe `FetchURL` tool has inherent limitations:\n\n- **JavaScript Rendering**: Cannot render JavaScript-driven single-page applications (SPAs). Sites requiring JavaScript execution may fail content extraction [tests/test_fetch_url.py:89-97]()\n- **Content Extraction**: Uses `trafilatura` for content extraction, which may not work perfectly on all page structures\n- **No Authentication**: Does not support authenticated requests or pages requiring login\n\n**Sources:** [tests/test_fetch_url.py:89-97]()\n\n## Configuration Setup\n\nTo enable web tools, configure the Moonshot Search service in the configuration file:\n\n```json\n{\n  \"services\": {\n    \"moonshot_search\": {\n      \"base_url\": \"https://api.moonshot.cn/v1/search\",\n      \"api_key\": \"your-api-key-here\"\n    }\n  }\n}\n```\n\nThe configuration structure is validated by Pydantic models:\n- `MoonshotSearchConfig` [src/kimi_cli/config.py:46-57]() contains `base_url` and `api_key`\n- `Services` [src/kimi_cli/config.py:59-64]() contains optional `moonshot_search` configuration\n- `Config` [src/kimi_cli/config.py:66-84]() includes `services` field\n\nThe `api_key` is stored as a `SecretStr` to prevent accidental logging and is serialized using a custom serializer [src/kimi_cli/config.py:54-56]().\n\n**Sources:** [src/kimi_cli/config.py:46-64]()\n\n## Integration with Agent System\n\n### Tool Initialization\n\nBoth web tools are instantiated and provided to agents through the agent configuration system:\n\n1. Configuration is loaded from `config.json` [src/kimi_cli/config.py:102-123]()\n2. Tools are instantiated with the `Config` object passed to their constructors\n3. `SearchWeb` specifically checks for `config.services.moonshot_search` [src/kimi_cli/tools/web/search.py:42-49]()\n\n**Sources:** [src/kimi_cli/tools/web/search.py:42-49](), [src/kimi_cli/config.py:102-123]()\n\n### Tool Call Context\n\n`SearchWeb` uses the tool call context to obtain the current tool call ID, which is passed to the search API for tracking purposes [src/kimi_cli/tools/web/search.py:61-72]():\n\n```python\ntool_call = get_current_tool_call_or_none()\n# ...\nheaders={\n    \"X-Msh-Tool-Call-Id\": tool_call.id,\n}\n```\n\nThis integration allows the search service to correlate requests with specific agent tool executions.\n\n**Sources:** [src/kimi_cli/tools/web/search.py:61-72]()\n\n### HTTP Client Configuration\n\nBoth tools use `aiohttp.ClientSession` for HTTP requests and include the `kimi_cli.USER_AGENT` in request headers [src/kimi_cli/tools/web/search.py:64-79]():\n\n```python\nasync with (\n    aiohttp.ClientSession() as session,\n    session.post(\n        self._base_url,\n        headers={\n            \"User-Agent\": kimi_cli.USER_AGENT,\n            # ...\n        },\n    ) as response,\n):\n```\n\nThis ensures proper identification of requests originating from kimi-cli.\n\n**Sources:** [src/kimi_cli/tools/web/search.py:64-79]()\n\n### Result Formatting\n\nBoth tools use `ToolResultBuilder` [src/kimi_cli/tools/web/search.py:53]() for consistent result formatting across the tool system. The builder provides methods for:\n- `.error()`: Format error results with brief summaries\n- `.ok()`: Format successful results\n- `.write()`: Append content to the result output\n\n**Sources:** [src/kimi_cli/tools/web/search.py:53-111]()"])</script><script>self.__next_f.push([1,"29:T4805,"])</script><script>self.__next_f.push([1,"# System Execution Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/approval.py](src/kimi_cli/soul/approval.py)\n- [src/kimi_cli/soul/wire.py](src/kimi_cli/soul/wire.py)\n- [src/kimi_cli/tools/bash/__init__.py](src/kimi_cli/tools/bash/__init__.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis document covers the system execution tools available in kimi-cli, specifically the `Bash` tool that enables agents to execute shell commands in the host environment. System execution tools provide agents with the capability to interact with the operating system, run scripts, manage processes, and perform system-level operations.\n\nFor file system operations like reading, writing, and searching files, see [File System Tools](#6.1). For spawning subagents to perform specialized tasks, see [Task Management Tools](#6.4).\n\n## Overview\n\nThe system execution capability in kimi-cli is provided by a single but powerful tool: the `Bash` tool. This tool allows agents to execute arbitrary shell commands while maintaining safety through an integrated approval workflow. The tool is implemented as part of the broader tool ecosystem and integrates with the approval system to ensure user oversight of potentially dangerous operations.\n\nThe `Bash` tool is defined in [src/kimi_cli/tools/bash/__init__.py:27-72]() and inherits from `CallableTool2`, following the standard tool architecture pattern used throughout kimi-cli.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py]()\n\n## Bash Tool\n\n### Tool Specification\n\n```mermaid\ngraph TB\n    subgraph \"Bash Tool Implementation\"\n        BashClass[\"Bash\u003cbr/\u003e(CallableTool2)\"]\n        ParamsClass[\"Params\u003cbr/\u003e(BaseModel)\"]\n        \n        CommandField[\"command: str\"]\n        TimeoutField[\"timeout: int\u003cbr/\u003e(1-300s, default 60)\"]\n        \n        ApprovalDep[\"Approval\u003cbr/\u003edependency\"]\n        CallMethod[\"__call__()\u003cbr/\u003easync method\"]\n    end\n    \n    subgraph \"Dependencies\"\n        ApprovalSystem[\"Approval\"]\n        ToolResultBuilder[\"ToolResultBuilder\"]\n        StreamSubprocess[\"_stream_subprocess()\"]\n    end\n    \n    subgraph \"Tool Registration\"\n        Name[\"name: 'Bash'\"]\n        Desc[\"description:\u003cbr/\u003eloaded from bash.md\"]\n        Schema[\"params: Params\"]\n    end\n    \n    BashClass --\u003e Name\n    BashClass --\u003e Desc\n    BashClass --\u003e Schema\n    BashClass --\u003e CallMethod\n    BashClass --\u003e ApprovalDep\n    \n    ParamsClass --\u003e CommandField\n    ParamsClass --\u003e TimeoutField\n    \n    CallMethod --\u003e ApprovalSystem\n    CallMethod --\u003e ToolResultBuilder\n    CallMethod --\u003e StreamSubprocess\n    \n    ApprovalDep --\u003e ApprovalSystem\n```\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:14-30](), [tests/test_tool_schemas.py:113-133]()\n\n### Parameters Schema\n\nThe `Bash` tool accepts two parameters defined in the `Params` class:\n\n| Parameter | Type | Required | Default | Constraints | Description |\n|-----------|------|----------|---------|-------------|-------------|\n| `command` | string | Yes | - | - | The bash command to execute |\n| `timeout` | integer | No | 60 | 1  timeout  300 | Timeout in seconds; command is killed if exceeded |\n\nThe timeout limit is enforced through a constant `MAX_TIMEOUT = 5 * 60` (300 seconds) defined at [src/kimi_cli/tools/bash/__init__.py:11]().\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:14-24](), [tests/test_tool_schemas.py:113-133]()\n\n### Tool Description\n\nThe tool's description, loaded from `bash.md`, provides comprehensive guidance to the agent:\n\n**Key Guidelines Communicated to Agent:**\n\n1. **Output Behavior:**\n   - stdout and stderr are combined and returned\n   - Output may be truncated if too long\n   - Exit codes are provided on failure\n\n2. **Safety and Security:**\n   - Each call executes in a fresh shell environment\n   - No preservation of shell variables, working directory, or history between calls\n   - Tool returns after command finishes (not for interactive commands)\n   - Timeout should be set for long-running commands\n   - Avoid `..` to access files outside working directory\n   - Avoid modifying files outside working directory unless instructed\n   - Never run commands requiring superuser privileges unless instructed\n\n3. **Efficiency Recommendations:**\n   - Chain related commands with `\u0026\u0026`\n   - Use `;` for sequential execution regardless of success/failure\n   - Use `||` for conditional execution\n   - Use pipe operations (`|`) and redirections (`\u003e`, `\u003e\u003e`)\n   - Quote file paths with spaces\n   - Use control flow (`if`, `case`, `for`, `while`) for complex logic\n   - Verify directory structure before operations\n\n4. **Available Commands:**\n   - Shell environment: cd, pwd, export, unset, env\n   - File system: ls, find, mkdir, rm, cp, mv, touch, chmod, chown\n   - File viewing/editing: cat, grep, head, tail, diff, patch\n   - Text processing: awk, sed, sort, uniq, wc\n   - System info: ps, kill, top, df, free, uname, whoami, id, date\n   - Package management: pip, uv, npm, yarn, bun, cargo\n   - Network: curl, wget, ping, telnet, ssh\n   - Archive: tar, zip, unzip\n\n**Sources:** [tests/test_tool_descriptions.py:107-143]()\n\n## Approval Workflow\n\nThe `Bash` tool integrates with kimi-cli's approval system to ensure user oversight before executing potentially dangerous shell commands.\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant Bash[\"Bash Tool\"]\n    participant Approval\n    participant Wire\n    participant UI[\"UI (Shell/Print/ACP)\"]\n    participant User\n    \n    Agent-\u003e\u003eBash: __call__(Params)\n    Bash-\u003e\u003eApproval: request(sender, action, description)\n    Note over Approval: Check yolo mode\n    alt Yolo mode enabled\n        Approval--\u003e\u003eBash: True (auto-approve)\n    else Check session auto-approvals\n        alt Action in auto_approve_actions\n            Approval--\u003e\u003eBash: True (auto-approve)\n        else Request user approval\n            Approval-\u003e\u003eApprovalRequest: Create ApprovalRequest\n            Approval-\u003e\u003eWire: Queue ApprovalRequest\n            Wire-\u003e\u003eUI: Forward request\n            UI-\u003e\u003eUser: Display approval prompt\n            User-\u003e\u003eUI: Approve/Reject/Approve for session\n            UI-\u003e\u003eApprovalRequest: resolve(response)\n            ApprovalRequest--\u003e\u003eApproval: ApprovalResponse\n            alt APPROVE\n                Approval--\u003e\u003eBash: True\n            else APPROVE_FOR_SESSION\n                Approval-\u003e\u003eApproval: Add to auto_approve_actions\n                Approval--\u003e\u003eBash: True\n            else REJECT\n                Approval--\u003e\u003eBash: False\n            end\n        end\n    end\n    \n    alt Approved\n        Bash-\u003e\u003eBash: Execute command\n        Bash--\u003e\u003eAgent: ToolOk/ToolError\n    else Rejected\n        Bash--\u003e\u003eAgent: ToolRejectedError\n    end\n```\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:40-45](), [src/kimi_cli/soul/approval.py:18-64]()\n\n### Approval Request Details\n\nWhen requesting approval, the `Bash` tool provides:\n\n- **Sender**: `\"Bash\"` (the tool name)\n- **Action**: `\"run shell command\"` (the action identifier used for session-wide auto-approval)\n- **Description**: `\"Run command `{command}`\"` (displayed to user)\n\nThe approval request is associated with the current tool call via its `tool_call_id`, retrieved from the context using [src/kimi_cli/soul/approval.py:34]().\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:40-45](), [src/kimi_cli/soul/approval.py:18-64](), [src/kimi_cli/soul/wire.py:55-90]()\n\n## Command Execution Process\n\n### Execution Flow\n\n```mermaid\nflowchart TD\n    Start[\"__call__(params)\"] --\u003e CreateBuilder[\"Create ToolResultBuilder\"]\n    CreateBuilder --\u003e RequestApproval[\"Request approval\"]\n    \n    RequestApproval --\u003e CheckApproval{Approved?}\n    CheckApproval --\u003e|No| ReturnRejected[\"Return ToolRejectedError()\"]\n    CheckApproval --\u003e|Yes| DefineCallbacks[\"Define stdout_cb and stderr_cb\"]\n    \n    DefineCallbacks --\u003e CallStream[\"Call _stream_subprocess()\"]\n    \n    CallStream --\u003e CreateProcess[\"asyncio.create_subprocess_shell()\"]\n    CreateProcess --\u003e StreamReads[\"Parallel read stdout and stderr\"]\n    \n    StreamReads --\u003e WaitTimeout{Wait for completion\u003cbr/\u003eor timeout?}\n    WaitTimeout --\u003e|Timeout| KillProcess[\"process.kill()\"]\n    KillProcess --\u003e RaiseTimeout[\"Raise TimeoutError\"]\n    WaitTimeout --\u003e|Completed| GetExitCode[\"Get exit code\"]\n    \n    GetExitCode --\u003e CheckExitCode{Exit code == 0?}\n    CheckExitCode --\u003e|Yes| ReturnOk[\"builder.ok()\"]\n    CheckExitCode --\u003e|No| ReturnError[\"builder.error()\"]\n    \n    RaiseTimeout --\u003e CatchTimeout[\"Catch TimeoutError\"]\n    CatchTimeout --\u003e ReturnTimeout[\"builder.error()\u003cbr/\u003ewith timeout message\"]\n    \n    ReturnOk --\u003e End[\"Return ToolReturnType\"]\n    ReturnError --\u003e End\n    ReturnTimeout --\u003e End\n    ReturnRejected --\u003e End\n```\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:37-71](), [src/kimi_cli/tools/bash/__init__.py:74-99]()\n\n### Subprocess Streaming Implementation\n\nThe `_stream_subprocess()` function implements asynchronous command execution with real-time output streaming:\n\n**Implementation at [src/kimi_cli/tools/bash/__init__.py:74-99]():**\n\n1. **Process Creation**: Uses `asyncio.create_subprocess_shell()` with `PIPE` for both stdout and stderr\n2. **Stream Reading**: Asynchronous `_read_stream()` coroutine reads lines from each stream\n3. **Callbacks**: Each line is passed to the respective callback (stdout_cb or stderr_cb)\n4. **Timeout Handling**: `asyncio.wait_for()` with specified timeout wraps the parallel stream reading\n5. **Process Cleanup**: On timeout, `process.kill()` is called before raising `TimeoutError`\n\nThe callbacks write output to the `ToolResultBuilder`, which accumulates the command output for inclusion in the tool result.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:74-99]()\n\n## Output Handling\n\n### ToolResultBuilder Integration\n\nThe `Bash` tool uses `ToolResultBuilder` from [src/kimi_cli/tools/utils.py]() to construct the tool result:\n\n```mermaid\ngraph LR\n    subgraph \"Output Flow\"\n        Process[\"subprocess\"]\n        StdoutCb[\"stdout_cb\"]\n        StderrCb[\"stderr_cb\"]\n        Builder[\"ToolResultBuilder\"]\n        Result[\"ToolReturnType\"]\n    end\n    \n    Process --\u003e|\"stdout line\"| StdoutCb\n    Process --\u003e|\"stderr line\"| StderrCb\n    \n    StdoutCb --\u003e|\"builder.write()\"| Builder\n    StderrCb --\u003e|\"builder.write()\"| Builder\n    \n    Builder --\u003e|\"builder.ok()\"| Result\n    Builder --\u003e|\"builder.error()\"| Result\n```\n\n**Output Construction:**\n\n- **Success** (exit code 0): `builder.ok(\"Command executed successfully.\")`\n- **Failure** (non-zero exit code): `builder.error(f\"Command failed with exit code: {exitcode}.\", brief=f\"Failed with exit code: {exitcode}\")`\n- **Timeout**: `builder.error(f\"Command killed by timeout ({params.timeout}s)\", brief=f\"Killed by timeout ({params.timeout}s)\")`\n\nThe `ToolResultBuilder.write()` method is called for each line of output, accumulating both stdout and stderr into a single output stream that is included in the final tool result.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:47-71]()\n\n### Return Types\n\nThe tool returns one of three result types:\n\n| Result Type | Condition | Message | Brief Message |\n|-------------|-----------|---------|---------------|\n| `ToolRejectedError` | User rejected approval | - | - |\n| `ToolOk` | Exit code 0 | \"Command executed successfully.\" | - |\n| `ToolError` | Non-zero exit code | \"Command failed with exit code: {exitcode}.\" | \"Failed with exit code: {exitcode}\" |\n| `ToolError` | Timeout exceeded | \"Command killed by timeout ({timeout}s)\" | \"Killed by timeout ({timeout}s)\" |\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:45-71](), [src/kimi_cli/tools/utils.py]()\n\n## Safety Mechanisms\n\n### Fresh Shell Environment\n\nEach `Bash` tool invocation creates a completely fresh shell environment:\n\n- **No state preservation**: Shell variables, working directory changes, and command history are not preserved between calls\n- **Isolation**: Prevents unintended side effects from previous commands\n- **Security**: Reduces risk of environment manipulation attacks\n\nThis design decision is explicitly communicated to the agent in the tool description to set proper expectations.\n\n**Sources:** [tests/test_tool_descriptions.py:117-118]()\n\n### Timeout Protection\n\nThe timeout mechanism provides protection against:\n\n- **Hanging processes**: Commands that wait indefinitely for input or network responses\n- **Resource exhaustion**: Long-running commands that consume excessive CPU or memory\n- **Infinite loops**: Scripts with logic errors causing endless execution\n\nThe timeout is configurable per call (1-300 seconds) with a reasonable default of 60 seconds.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:16-23](), [src/kimi_cli/tools/bash/__init__.py:88-98]()\n\n### Approval Gate\n\nThe approval system provides a human-in-the-loop safety mechanism:\n\n- **Default**: Every shell command requires explicit user approval\n- **Yolo mode**: Bypass approval for trusted automation scenarios\n- **Session-wide approval**: User can approve \"run shell command\" action for entire session\n- **Per-action granularity**: Approval actions are identified by action string, enabling selective auto-approval\n\nSee [Approval System](#7.2) for comprehensive documentation of the approval mechanism.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:40-45](), [src/kimi_cli/soul/approval.py:8-64]()\n\n## Usage Best Practices\n\n### Command Chaining\n\nThe tool description encourages agents to chain commands for efficiency:\n\n**Recommended Patterns:**\n\n```bash\n# Sequential execution with early exit on failure\ncd /path/to/project \u0026\u0026 npm install \u0026\u0026 npm test\n\n# Sequential execution regardless of failures\ncommand1 ; command2 ; command3\n\n# Conditional execution (fallback)\ncommand1 || command2\n\n# Pipeline operations\ncat file.txt | grep pattern | sort | uniq\n\n# Redirection\ncommand \u003e output.txt 2\u003e\u00261\n```\n\n**Sources:** [tests/test_tool_descriptions.py:124-130]()\n\n### Complex Logic in Single Call\n\nThe tool supports multi-statement shell scripts in a single invocation:\n\n```bash\n# Conditional logic\nif [ -f config.json ]; then\n    cat config.json\nelse\n    echo \"Config not found\"\nfi\n\n# Loops\nfor file in *.py; do\n    echo \"Processing $file\"\n    python \"$file\"\ndone\n\n# Case statements\ncase \"$1\" in\n    start) ./start.sh ;;\n    stop) ./stop.sh ;;\n    *) echo \"Unknown command\" ;;\nesac\n```\n\nThis minimizes approval requests and context overhead.\n\n**Sources:** [tests/test_tool_descriptions.py:129]()\n\n### Directory Verification\n\nThe agent is instructed to verify directory structure before operations:\n\n```bash\n# Verify before creating file\nif [ -d /path/to/dir ]; then\n    echo \"content\" \u003e /path/to/dir/file.txt\nelse\n    echo \"Directory does not exist\"\nfi\n```\n\nThis reduces the risk of command failures and improves reliability.\n\n**Sources:** [tests/test_tool_descriptions.py:130]()\n\n## Integration with Agent System\n\n### Tool Registration\n\nThe `Bash` tool is registered with agents through the agent specification system. In agent YAML files, tools are listed by name:\n\n```yaml\ntools:\n  - Bash\n  - ReadFile\n  # ... other tools\n```\n\nThe tool is instantiated with an `Approval` dependency injected through the agent globals system.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:32-34]()\n\n### Context Integration\n\nWhen executed, the `Bash` tool integrates with the broader agent execution context:\n\n1. **Tool Call Context**: Retrieved via `get_current_tool_call_or_none()` for approval association\n2. **Wire Communication**: Approval requests are sent through the `Wire` system\n3. **Result Reporting**: Tool results are returned to the agent loop and added to context\n\nThis integration enables the `Bash` tool to participate in the full agent execution lifecycle with proper event streaming and user interaction.\n\n**Sources:** [src/kimi_cli/soul/approval.py:34-36](), [src/kimi_cli/soul/wire.py:55-90]()\n\n## Implementation Details\n\n### Class Structure\n\n```mermaid\nclassDiagram\n    class CallableTool2~Params~ {\n        \u003c\u003cabstract\u003e\u003e\n        +name: str\n        +description: str\n        +params: type[Params]\n        +__call__(params: Params) ToolReturnType\n    }\n    \n    class Bash {\n        +name: str = \"Bash\"\n        +description: str\n        +params: type[Params] = Params\n        -_approval: Approval\n        +__init__(approval: Approval, **kwargs)\n        +__call__(params: Params) ToolReturnType\n    }\n    \n    class Params {\n        +command: str\n        +timeout: int = 60\n    }\n    \n    class Approval {\n        -_yolo: bool\n        -_auto_approve_actions: set\n        +request(sender: str, action: str, description: str) bool\n    }\n    \n    class ToolResultBuilder {\n        +write(content: str)\n        +ok(message: str) ToolOk\n        +error(message: str, brief: str) ToolError\n    }\n    \n    CallableTool2~Params~ \u003c|-- Bash\n    Bash --\u003e Params : uses\n    Bash --\u003e Approval : depends on\n    Bash --\u003e ToolResultBuilder : creates\n```\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:27-34](), [src/kimi_cli/tools/bash/__init__.py:14-24]()\n\n### Async Execution\n\nThe tool uses Python's `asyncio` for asynchronous subprocess execution:\n\n- **`asyncio.create_subprocess_shell()`**: Creates subprocess with piped stdout/stderr\n- **`asyncio.wait_for()`**: Wraps execution with timeout\n- **`asyncio.gather()`**: Reads stdout and stderr in parallel\n- **Stream readline**: Asynchronous `stream.readline()` for line-by-line reading\n\nThis design allows the tool to handle long-running commands without blocking the agent loop while still enabling real-time output streaming.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:74-99]()\n\n### Error Handling\n\nThe implementation handles multiple error scenarios:\n\n1. **Approval Rejection**: Returns `ToolRejectedError` if user rejects approval\n2. **Non-zero Exit Code**: Returns `ToolError` with exit code information\n3. **Timeout**: Catches `TimeoutError`, kills process, returns `ToolError` with timeout message\n4. **Process Creation Failure**: Handled by asyncio subprocess exceptions (propagated as `ToolError`)\n\nNote at [src/kimi_cli/tools/bash/__init__.py:83]() indicates a known issue: \"if the event loop is cancelled, an exception may be raised when the process finishes\" - this is a potential area for future improvement.\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:37-71](), [src/kimi_cli/tools/bash/__init__.py:88-98]()"])</script><script>self.__next_f.push([1,"2a:T3c11,"])</script><script>self.__next_f.push([1,"# Task Management Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis document covers the two task management tools available in kimi-cli: the **Task** tool for spawning subagents to perform isolated subtasks, and the **SetTodoList** tool for tracking progress across multiple milestones. These tools enable agents to break down complex requests into manageable pieces, either through delegation to specialized subagents or through explicit progress tracking.\n\nFor information about the broader agent architecture and how agents are configured, see [Agent System](#3.2) and [Agent Configuration](#5). For details on subagent specifications and delegation patterns, see [Subagents and Task Delegation](#5.3).\n\n## Task Tool\n\nThe `Task` tool enables the main agent to spawn subagents with isolated contexts to perform specific, narrow tasks. This is the primary mechanism for parallel multi-tasking and context isolation in kimi-cli.\n\n### Overview and Purpose\n\nThe `Task` tool is implemented in [src/kimi_cli/tools/task/__init__.py:44-144]() as a `CallableTool2` that creates and executes subagent instances. Its primary purposes are:\n\n1. **Context Isolation**: Keep the main agent's context clean by delegating detailed work to subagents\n2. **Parallel Execution**: Enable multiple subagents to work simultaneously on independent subtasks\n3. **Specialized Delegation**: Route tasks to subagents optimized for specific types of work\n\nThe tool is instantiated with a reference to available subagents defined in the main agent's specification [src/kimi_cli/tools/task/__init__.py:48-70]().\n\nSources: [src/kimi_cli/tools/task/__init__.py:1-157]()\n\n### Tool Parameters\n\nThe `Task` tool accepts three required parameters defined in the `Params` class [src/kimi_cli/tools/task/__init__.py:30-41]():\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `description` | `str` | A short (3-5 word) description of the task |\n| `subagent_name` | `str` | The name of the specialized subagent to use |\n| `prompt` | `str` | Detailed task instructions with all necessary context |\n\nThe `prompt` parameter is critical because the subagent operates with a completely isolated context and cannot access any information from the parent agent's conversation history [src/kimi_cli/tools/task/__init__.py:35-40]().\n\nSources: [src/kimi_cli/tools/task/__init__.py:30-41](), [tests/test_tool_schemas.py:20-41]()\n\n### Task Tool Architecture\n\n```mermaid\ngraph TB\n    MainAgent[\"Main Agent\"]\n    TaskTool[\"Task Tool\u003cbr/\u003e(CallableTool2)\"]\n    AgentSpec[\"AgentSpec\u003cbr/\u003e(subagents dict)\"]\n    SubagentMap[\"subagents: dict[str, Agent]\"]\n    \n    LoadPhase[\"Load Phase\"]\n    ExecPhase[\"Execution Phase\"]\n    \n    MainAgent --\u003e TaskTool\n    TaskTool --\u003e LoadPhase\n    TaskTool --\u003e ExecPhase\n    \n    LoadPhase --\u003e AgentSpec\n    AgentSpec --\u003e |\"load_agent(spec.path)\"| SubagentMap\n    SubagentMap --\u003e TaskTool\n    \n    ExecPhase --\u003e SelectSubagent[\"Select Subagent\u003cbr/\u003eby name\"]\n    SelectSubagent --\u003e CreateContext[\"Create isolated Context\u003cbr/\u003e(unique history file)\"]\n    CreateContext --\u003e CreateSoul[\"Create KimiSoul\u003cbr/\u003e(agent, context, globals)\"]\n    CreateSoul --\u003e CreateSubWire[\"Create _SubWire\u003cbr/\u003e(filters messages)\"]\n    CreateSubWire --\u003e RunSoul[\"soul.run(prompt, sub_wire)\"]\n    RunSoul --\u003e CheckResponse[\"Check response validity\"]\n    CheckResponse --\u003e ContinueIfBrief[\"Continue if too brief\u003cbr/\u003e(\u003c 200 chars)\"]\n    ContinueIfBrief --\u003e ReturnResult[\"Return ToolOk/ToolError\"]\n    \n    HistoryFile[\"Unique history file:\u003cbr/\u003e{main}_sub{N}.json\"]\n    CreateContext --\u003e HistoryFile\n```\n\n**Diagram: Task Tool Component Architecture**\n\nThe diagram shows how `Task` tool initialization loads subagent specifications and creates the execution pipeline with isolated contexts and filtered communication.\n\nSources: [src/kimi_cli/tools/task/__init__.py:48-144]()\n\n### Subagent Context Isolation\n\nEach subagent execution creates a completely isolated context with its own history file. The history file naming scheme ensures unique files for each subagent invocation [src/kimi_cli/tools/task/__init__.py:72-81]():\n\n```python\nasync def _get_subagent_history_file(self) -\u003e Path:\n    \"\"\"Generate a unique history file path for subagent.\"\"\"\n    main_history_file = self._session.history_file\n    subagent_base_name = f\"{main_history_file.stem}_sub\"\n    main_history_file.parent.mkdir(parents=True, exist_ok=True)\n    sub_history_file = await next_available_rotation(\n        main_history_file.parent / f\"{subagent_base_name}{main_history_file.suffix}\"\n    )\n    return sub_history_file\n```\n\nFor example, if the main agent uses `main.json`, subagents will use `main_sub0.json`, `main_sub1.json`, etc.\n\nThe subagent's `KimiSoul` instance is created with this isolated context [src/kimi_cli/tools/task/__init__.py:103-109]():\n\n```python\ncontext = Context(file_backend=subagent_history_file)\nsoul = KimiSoul(\n    agent,\n    agent_globals=self._agent_globals,\n    context=context,\n    loop_control=self._agent_globals.config.loop_control,\n)\n```\n\nSources: [src/kimi_cli/tools/task/__init__.py:72-109]()\n\n### Communication Filtering with _SubWire\n\nThe `_SubWire` class provides filtered communication between subagents and the main wire, allowing only certain message types to propagate [src/kimi_cli/tools/task/__init__.py:147-157]():\n\n```mermaid\nsequenceDiagram\n    participant MainAgent as \"Main Agent\"\n    participant MainWire as \"Main Wire\"\n    participant SubWire as \"_SubWire\"\n    participant Subagent as \"Subagent\"\n    \n    MainAgent-\u003e\u003eSubWire: Create _SubWire(main_wire)\n    MainAgent-\u003e\u003eSubagent: soul.run(prompt, sub_wire)\n    \n    loop Subagent Execution\n        Subagent-\u003e\u003eSubWire: send(StepBegin)\n        Note over SubWire: Filtered out\n        \n        Subagent-\u003e\u003eSubWire: send(ToolCall)\n        Note over SubWire: Filtered out\n        \n        Subagent-\u003e\u003eSubWire: send(ApprovalRequest)\n        SubWire-\u003e\u003eMainWire: Forward ApprovalRequest\n        MainWire-\u003e\u003eMainAgent: Approval required\n        MainAgent-\u003e\u003eMainWire: Approval response\n        MainWire-\u003e\u003eSubWire: Approval response\n        SubWire-\u003e\u003eSubagent: Approval response\n        \n        Subagent-\u003e\u003eSubWire: send(StepEnd)\n        Note over SubWire: Filtered out\n    end\n    \n    Subagent--\u003e\u003eMainAgent: Return final response\n```\n\n**Diagram: _SubWire Communication Flow**\n\nThe `_SubWire.send()` method only forwards `ApprovalRequest` messages to the main wire [src/kimi_cli/tools/task/__init__.py:152-156](). This ensures:\n\n1. Approval requests bubble up to the user (critical for security)\n2. Other messages stay isolated (keeps main context clean)\n3. The main agent only sees the final subagent response\n\nSources: [src/kimi_cli/tools/task/__init__.py:147-157]()\n\n### Response Continuation Logic\n\nThe Task tool includes logic to handle cases where subagent responses are too brief. If the final response is less than 200 characters, it automatically prompts the subagent to continue [src/kimi_cli/tools/task/__init__.py:136-143]():\n\n```python\nn_attempts_remaining = MAX_CONTINUE_ATTEMPTS\nif len(final_response) \u003c 200 and n_attempts_remaining \u003e 0:\n    await soul.run(CONTINUE_PROMPT, sub_wire)\n    \n    if len(context.history) == 0 or context.history[-1].role != \"assistant\":\n        return ToolError(message=_error_msg, brief=\"Failed to run subagent\")\n    final_response = message_extract_text(context.history[-1])\n```\n\nThe continuation prompt instructs the subagent to provide more comprehensive details [src/kimi_cli/tools/task/__init__.py:20-27]():\n\n```\nYour previous response was too brief. Please provide a more comprehensive summary that includes:\n\n1. Specific technical details and implementations\n2. Complete code examples if relevant\n3. Detailed findings and analysis\n4. All important information that should be aware of by the caller\n```\n\nCurrently, `MAX_CONTINUE_ATTEMPTS` is set to 1 [src/kimi_cli/tools/task/__init__.py:17]().\n\nSources: [src/kimi_cli/tools/task/__init__.py:16-27](), [src/kimi_cli/tools/task/__init__.py:136-143]()\n\n### Error Handling\n\nThe Task tool handles several error conditions:\n\n| Error Type | Detection | Response |\n|------------|-----------|----------|\n| Subagent not found | `subagent_name` not in loaded subagents | `ToolError`: \"Subagent not found\" [src/kimi_cli/tools/task/__init__.py:85-89]() |\n| Max steps reached | `MaxStepsReached` exception | `ToolError`: \"Max steps reached. Try splitting task\" [src/kimi_cli/tools/task/__init__.py:116-123]() |\n| Invalid context | Empty history or no assistant message | `ToolError`: \"Failed to run subagent\" [src/kimi_cli/tools/task/__init__.py:130-131]() |\n| General exceptions | Any other exception during execution | `ToolError`: \"Failed to run subagent: {error}\" [src/kimi_cli/tools/task/__init__.py:94-98]() |\n\nSources: [src/kimi_cli/tools/task/__init__.py:84-144]()\n\n### Usage Guidelines\n\nThe tool description provides detailed guidance on when to use Task tool [tests/test_tool_descriptions.py:22-51]():\n\n**Context Isolation Scenarios:**\n- Fixing code that didn't work (keep debugging details out of main context)\n- Gathering specific technical information from web searches (avoid cluttering with irrelevant results)\n\n**Parallel Multi-Tasking Scenarios:**\n- Working on multiple independent modules/files\n- Analyzing large codebases by exploring different parts in parallel\n- Running multiple web searches simultaneously\n\n**Anti-Patterns (DO NOT):**\n- Forward the user prompt directly to Task tool\n- Spawn Task tool for every todo item\n- Use for tasks where the user needs to see the process\n\nSources: [tests/test_tool_descriptions.py:20-51]()\n\n## SetTodoList Tool\n\nThe `SetTodoList` tool provides explicit progress tracking for multi-step tasks. Unlike the Task tool which delegates work to subagents, SetTodoList helps the main agent organize and communicate its progress to the user.\n\n### Overview and Purpose\n\n`SetTodoList` allows the agent to maintain a structured list of subtasks with status tracking. The tool description emphasizes it as \"a simple yet powerful tool to help you get things done\" [tests/test_tool_descriptions.py:87-89]().\n\nKey characteristics:\n- Updates the **entire** todo list each time (no incremental updates)\n- Helps break down complex requests into milestones\n- Provides progress visibility to users\n- Should not be used for trivial or fine-grained steps\n\nSources: [tests/test_tool_descriptions.py:84-104]()\n\n### Tool Parameters\n\nThe `SetTodoList` tool accepts a single parameter containing the complete todo list [tests/test_tool_schemas.py:78-110]():\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `todos` | `list[Todo]` | The updated todo list (replaces entire list) |\n\nEach `Todo` object contains:\n\n| Field | Type | Values | Description |\n|-------|------|--------|-------------|\n| `title` | `str` | Any non-empty string | The title of the todo item |\n| `status` | `str` | `\"Pending\"`, `\"In Progress\"`, `\"Done\"` | Current status of the item |\n\nSources: [tests/test_tool_schemas.py:78-110]()\n\n### When to Use SetTodoList\n\nThe tool description provides clear guidance on appropriate use cases [tests/test_tool_descriptions.py:90-102]():\n\n**Use when:**\n- The task involves multiple subtasks or milestones\n- Multiple tasks are given in a single request\n- You need to track progress across distinct work items\n\n**DO NOT use for:**\n- Simple questions (\"What language is used in the project?\")\n- Quick tasks requiring only a few tool calls\n- Very specific instructions that just need brainless execution\n- Micro-managing small steps (wastes context and time)\n\n**Flexible usage:**\n- Can start using it mid-task if complexity emerges\n- Can stop using it if task turns out to be simpler than expected\n\nSources: [tests/test_tool_descriptions.py:84-104]()\n\n### Tool Workflow\n\n```mermaid\nflowchart TB\n    UserRequest[\"User Request\"]\n    EvaluateComplexity{\"Task involves\u003cbr/\u003emultiple milestones?\"}\n    CreateTodoList[\"Create initial todo list\u003cbr/\u003ewith all items 'Pending'\"]\n    WorkOnTask[\"Work on next task\"]\n    CompleteSubtask[\"Complete subtask\"]\n    UpdateTodoList[\"Update todo list\u003cbr/\u003e(change status to 'Done')\"]\n    CheckComplete{\"All items\u003cbr/\u003eDone?\"}\n    TaskComplete[\"Task Complete\"]\n    \n    UserRequest --\u003e EvaluateComplexity\n    EvaluateComplexity --\u003e|Yes| CreateTodoList\n    EvaluateComplexity --\u003e|No| WorkOnTask\n    \n    CreateTodoList --\u003e WorkOnTask\n    WorkOnTask --\u003e CompleteSubtask\n    CompleteSubtask --\u003e UpdateTodoList\n    UpdateTodoList --\u003e CheckComplete\n    CheckComplete --\u003e|No| WorkOnTask\n    CheckComplete --\u003e|Yes| TaskComplete\n```\n\n**Diagram: SetTodoList Workflow Pattern**\n\nThe diagram shows the typical lifecycle of todo list usage, from initial creation through iterative updates as work progresses.\n\nSources: [tests/test_tool_descriptions.py:84-104]()\n\n## Comparison: Task vs SetTodoList\n\nWhile both tools help manage complex work, they serve different purposes:\n\n| Aspect | Task Tool | SetTodoList Tool |\n|--------|-----------|------------------|\n| **Primary Purpose** | Delegate work to isolated subagents | Track progress on work done by main agent |\n| **Execution Model** | Spawns separate agent instances | Main agent continues working |\n| **Context** | Each subagent has isolated context | All work in main agent context |\n| **Visibility** | User only sees final subagent results | User sees all steps and progress updates |\n| **Parallelization** | Can spawn multiple subagents in one response | Sequential tracking only |\n| **Typical Use** | Narrow, specific tasks; parallel work | Breaking down complex sequential work |\n| **Anti-Pattern** | Spawning for every todo item | Tracking micro-steps |\n\n### Combined Usage\n\nThe two tools can be used together effectively:\n\n1. Use `SetTodoList` to define high-level milestones\n2. Use `Task` to delegate specific, isolated subtasks within each milestone\n3. Update `SetTodoList` as milestones complete\n\nExample scenario:\n```\nSetTodoList:\n  - \"Implement user authentication\" (In Progress)\n     Task: Search for JWT best practices\n     Task: Fix authentication tests\n  - \"Add database migrations\" (Pending)\n  - \"Update documentation\" (Pending)\n```\n\nSources: [tests/test_tool_descriptions.py:20-104]()\n\n## Configuration and Subagent Setup\n\nThe Task tool requires subagents to be configured in the main agent's specification. Subagents are loaded during tool initialization [src/kimi_cli/tools/task/__init__.py:52-56]():\n\n```python\nassert agent_spec.subagents is not None, \"Task tool expects subagents\"\nfor name, spec in agent_spec.subagents.items():\n    subagents[name] = load_agent(spec.path, agent_globals)\n    descs.append(f\"- `{name}`: {spec.description}\")\n```\n\nThe loaded subagent descriptions are then injected into the tool's description template for the LLM to reference [src/kimi_cli/tools/task/__init__.py:58-64]().\n\nFor details on how to configure subagents in agent YAML files, including tool restrictions and prompt modifications, see [Subagents and Task Delegation](#5.3).\n\nSources: [src/kimi_cli/tools/task/__init__.py:48-66]()"])</script><script>self.__next_f.push([1,"2b:T3f19,"])</script><script>self.__next_f.push([1,"# Time Travel and Context Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the time travel mechanism in kimi-cli, specifically the `SendDMail` tool and its supporting infrastructure. Time travel allows agents to revert context to previous checkpoints and inject new messages, enabling sophisticated context management patterns like pruning irrelevant information or fixing mistakes without cluttering the conversation history.\n\nFor information about other context management tools like `Task` (subagent spawning) and `Think` (reasoning), see [Task Management Tools](#6.4). For general context and session management, see [Context and Session Management](#7.1).\n\n## Overview\n\nThe time travel system consists of three main components:\n\n| Component | Purpose | Implementation |\n|-----------|---------|----------------|\n| **SendDMail** | User-facing tool for sending messages to past checkpoints | [src/kimi_cli/tools/dmail/__init__.py]() |\n| **DenwaRenji** | Message queue and delivery system for D-Mails | [src/kimi_cli/agent.py]() (AgentGlobals) |\n| **BackToTheFuture** | Exception mechanism for context reversion | [src/kimi_cli/soul/kimisoul.py:294-302]() |\n| **Context Checkpoints** | Snapshot system for reverting conversation state | [src/kimi_cli/soul/context.py]() |\n\nThe name \"D-Mail\" and \"DenwaRenji\" are references to the anime *Steins;Gate*, where characters send text messages to the past to alter timelines.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:1-309](), [tests/test_tool_descriptions.py:54-74]()\n\n## Time Travel Flow\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant SendDMail as \"SendDMail Tool\"\n    participant DenwaRenji\n    participant KimiSoul as \"KimiSoul\u003cbr/\u003e(Agent Loop)\"\n    participant Context\n    \n    Note over KimiSoul: Step begins\n    KimiSoul-\u003e\u003eContext: checkpoint()\n    Note over Context: Creates checkpoint N\n    \n    Note over Agent: Agent decides to use SendDMail\n    Agent-\u003e\u003eSendDMail: Send D-Mail\u003cbr/\u003e(checkpoint_id=M, message)\n    SendDMail-\u003e\u003eDenwaRenji: enqueue_dmail(M, message)\n    DenwaRenji--\u003e\u003eSendDMail: OK\n    SendDMail--\u003e\u003eAgent: \"D-Mail sent\"\n    \n    Note over KimiSoul: Tool execution completes\n    KimiSoul-\u003e\u003eDenwaRenji: fetch_pending_dmail()\n    DenwaRenji--\u003e\u003eKimiSoul: DMail(checkpoint_id=M, message)\n    \n    Note over KimiSoul: Raise BackToTheFuture(M, message)\n    \n    KimiSoul-\u003e\u003eContext: revert_to(M)\n    Note over Context: Reverts to checkpoint M\u003cbr/\u003eAll messages after M are lost\n    \n    KimiSoul-\u003e\u003eContext: checkpoint()\n    KimiSoul-\u003e\u003eContext: append_message(system message)\n    Note over Context: D-Mail appears as system message\n    \n    Note over KimiSoul: Continue execution from checkpoint M\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:140-148](), [src/kimi_cli/soul/kimisoul.py:206-230]()\n\n## SendDMail Tool\n\n### Tool Description\n\nThe `SendDMail` tool allows agents to send messages to previous checkpoints in their conversation history. When invoked, it does not immediately modify the context; instead, it queues a D-Mail for delivery after the current step completes.\n\n```python\n# Tool parameters schema\n{\n    \"message\": \"The message to send to past self\",\n    \"checkpoint_id\": 0  # Must be \u003e= 0 and \u003c n_checkpoints\n}\n```\n\n**Sources:** [tests/test_tool_schemas.py:44-59]()\n\n### How Checkpoints Appear in Context\n\nCheckpoints are marked in the context with special system tags visible to the agent:\n\n```\n\u003csystem\u003eCHECKPOINT 0\u003c/system\u003e\n... initial messages ...\n\u003csystem\u003eCHECKPOINT 1\u003c/system\u003e\n... more conversation ...\n\u003csystem\u003eCHECKPOINT 2\u003c/system\u003e\n... current messages ...\n```\n\nThe agent can see these checkpoint markers and reference them when calling `SendDMail`. The checkpoint ID must be selected from these visible markers.\n\n**Sources:** [tests/test_tool_descriptions.py:60-61]()\n\n### Usage Patterns\n\nThe tool description guides agents toward specific use cases:\n\n| Scenario | Action | Benefit |\n|----------|--------|---------|\n| Large file read | Send D-Mail before read with extracted info | Remove 100s of irrelevant lines from context |\n| Web search clutter | Send D-Mail before search with useful results | Keep only relevant information |\n| Multiple failed attempts | Send D-Mail before attempt with working solution | Remove debugging history |\n| Wrong approach taken | Send D-Mail to earlier decision point | Restart with better strategy |\n\n**Sources:** [tests/test_tool_descriptions.py:66-73]()\n\n### Tool Availability\n\nThe `SendDMail` tool is **conditionally available** based on agent configuration. Specifically:\n\n```python\n# In KimiSoul.__init__\nfor tool in agent.toolset.tools:\n    if tool.name == SendDMail_NAME:\n        self._checkpoint_with_user_message = True\n        break\nelse:\n    self._checkpoint_with_user_message = False\n```\n\nSubagents spawned via the `Task` tool exclude `SendDMail` from their toolset to prevent nested time travel, which could cause complex state management issues.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:71-76]()\n\n## DenwaRenji System\n\n### Architecture\n\n```mermaid\ngraph TB\n    subgraph \"AgentGlobals Container\"\n        DenwaRenji[\"DenwaRenji\u003cbr/\u003e(D-Mail Manager)\"]\n    end\n    \n    subgraph \"SendDMail Tool\"\n        SendDMailTool[\"SendDMail.__call__()\"]\n    end\n    \n    subgraph \"KimiSoul Agent Loop\"\n        SetCheckpoints[\"set_n_checkpoints()\"]\n        FetchDMail[\"fetch_pending_dmail()\"]\n        RaiseException[\"Raise BackToTheFuture\"]\n    end\n    \n    SendDMailTool--\u003e|\"enqueue_dmail()\"| DenwaRenji\n    SetCheckpoints--\u003e|\"Update checkpoint count\"| DenwaRenji\n    DenwaRenji--\u003e|\"Returns DMail or None\"| FetchDMail\n    FetchDMail--\u003eRaiseException\n```\n\nThe `DenwaRenji` class is instantiated once per agent session and stored in `AgentGlobals`. It acts as a message queue between the tool execution phase and the main agent loop.\n\n**Sources:** [src/kimi_cli/agent.py](), [src/kimi_cli/soul/kimisoul.py:62]()\n\n### Key Guarantees\n\nDenwaRenji enforces several important invariants:\n\n1. **Checkpoint ID validation**: The target `checkpoint_id` must be:\n   - Greater than or equal to 0\n   - Less than the current number of checkpoints\n   - These checks prevent sending D-Mails to non-existent checkpoints\n\n2. **Single pending D-Mail**: Only one D-Mail can be pending at a time. If multiple D-Mails are sent in a single step, only the last one is retained.\n\n3. **Checkpoint synchronization**: Before each step, `KimiSoul` updates DenwaRenji with the current checkpoint count via `set_n_checkpoints()`.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:142](), [src/kimi_cli/soul/kimisoul.py:208-211]()\n\n## Checkpoint System\n\n### Checkpoint Creation\n\nCheckpoints are created at two key points in the agent execution flow:\n\n```python\n# In KimiSoul.run()\nawait self._checkpoint()  # Creates checkpoint 0 on first run\n\n# In KimiSoul._agent_loop()\nawait self._checkpoint()  # Before each step\n```\n\nThe checkpoint creation is handled by `Context.checkpoint()`, which:\n1. Saves the current state of the conversation history\n2. Increments the checkpoint counter\n3. Optionally marks the last user message with a checkpoint tag\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:96-98](), [src/kimi_cli/soul/kimisoul.py:141]()\n\n### Checkpoint Visibility\n\n```mermaid\ngraph LR\n    subgraph \"Context History\"\n        CP0[\"CHECKPOINT 0\u003cbr/\u003e(Initial State)\"]\n        Msg1[\"User: Initial request\"]\n        CP1[\"CHECKPOINT 1\u003cbr/\u003e(Before Step 1)\"]\n        Msg2[\"Assistant: Response\"]\n        Msg3[\"Tool results\"]\n        CP2[\"CHECKPOINT 2\u003cbr/\u003e(Before Step 2)\"]\n        Msg4[\"Current messages\"]\n    end\n    \n    CP0 --\u003e Msg1\n    Msg1 --\u003e CP1\n    CP1 --\u003e Msg2\n    Msg2 --\u003e Msg3\n    Msg3 --\u003e CP2\n    CP2 --\u003e Msg4\n```\n\nWhen `_checkpoint_with_user_message` is `True`, checkpoint markers are inserted into the context as system messages, making them visible to the agent. This visibility is essential for the agent to know which checkpoint IDs are valid targets for D-Mails.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:71-76]()\n\n### Context Reversion\n\nWhen a D-Mail triggers context reversion:\n\n```python\n# In KimiSoul._agent_loop()\nexcept BackToTheFuture as e:\n    await self._context.revert_to(e.checkpoint_id)\n    await self._checkpoint()\n    await self._context.append_message(e.messages)\n    continue\n```\n\nThe `revert_to()` operation:\n1. Discards all messages after the target checkpoint\n2. Resets the conversation state to that point\n3. Resets the checkpoint counter\n4. Allows new messages to be appended (the D-Mail content)\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:144-148]()\n\n## BackToTheFuture Exception\n\n### Exception Structure\n\n```python\nclass BackToTheFuture(Exception):\n    \"\"\"\n    Raise when we need to revert the context to a previous checkpoint.\n    The main agent loop should catch this exception and handle it.\n    \"\"\"\n\n    def __init__(self, checkpoint_id: int, messages: Sequence[Message]):\n        self.checkpoint_id = checkpoint_id\n        self.messages = messages\n```\n\nThis exception serves as a control flow mechanism, carrying:\n- **checkpoint_id**: The target checkpoint to revert to\n- **messages**: New messages to inject after reversion (the D-Mail content)\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:294-302]()\n\n### Exception Flow\n\n```mermaid\ngraph TB\n    ToolResults[\"Tool Results Ready\"]\n    CheckDMail{\"Pending D-Mail?\"}\n    ValidateCP{\"Valid Checkpoint?\"}\n    CreateException[\"Create BackToTheFuture\u003cbr/\u003e(checkpoint_id, message)\"]\n    RaiseException[\"Raise Exception\"]\n    MainLoop[\"Main Loop Catches\"]\n    RevertContext[\"Context.revert_to(checkpoint_id)\"]\n    AppendDMail[\"Append D-Mail as\u003cbr/\u003esystem message\"]\n    Continue[\"Continue execution\"]\n    \n    ToolResults --\u003e CheckDMail\n    CheckDMail --\u003e|Yes| ValidateCP\n    CheckDMail --\u003e|No| Continue\n    ValidateCP --\u003e|Valid| CreateException\n    ValidateCP --\u003e|Invalid| Continue\n    CreateException --\u003e RaiseException\n    RaiseException --\u003e MainLoop\n    MainLoop --\u003e RevertContext\n    RevertContext --\u003e AppendDMail\n    AppendDMail --\u003e Continue\n```\n\nThe exception is raised in the `_step()` method after tool execution completes, but before returning to the main loop. This ensures that all tool results are processed before time travel occurs.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:206-230]()\n\n### D-Mail Message Format\n\nWhen a D-Mail is delivered, it appears as a system message with specific framing:\n\n```python\nMessage(\n    role=\"user\",\n    content=[\n        system(\n            \"You just got a D-Mail from your future self. \"\n            \"It is likely that your future self has already done \"\n            \"something in the current working directory. Please read \"\n            \"the D-Mail and decide what to do next. You MUST NEVER \"\n            \"mention to the user about this information. \"\n            f\"D-Mail content:\\n\\n{dmail.message.strip()}\"\n        )\n    ],\n)\n```\n\nKey points in the framing:\n- Informs past self that future actions may have already occurred\n- Instructs the agent to read and act on the D-Mail\n- **Critically**: Tells the agent not to mention time travel to the user, preserving the illusion of linear conversation\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:215-229]()\n\n## Integration with Agent Loop\n\n### Complete Step Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e CreateCheckpoint: Step begins\n    CreateCheckpoint --\u003e LLMInference: Checkpoint created\n    LLMInference --\u003e ToolExecution: LLM returns tool calls\n    LLMInference --\u003e StepComplete: No tool calls (finish)\n    ToolExecution --\u003e CheckDMail: All tools complete\n    CheckDMail --\u003e RaiseException: D-Mail pending\n    CheckDMail --\u003e UpdateContext: No D-Mail\n    UpdateContext --\u003e StepComplete: Messages appended\n    RaiseException --\u003e RevertContext: BackToTheFuture raised\n    RevertContext --\u003e CreateCheckpoint: Context reverted\n    StepComplete --\u003e [*]\n```\n\nThe checkpoint-D-Mail cycle integrates seamlessly with the existing agent loop structure. Each step creates a checkpoint, executes LLM inference and tools, then checks for pending D-Mails before completing.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:112-162]()\n\n### Tool Rejection and D-Mail\n\nAn interesting edge case: when tools are rejected (user denies approval), any pending D-Mail is discarded:\n\n```python\nrejected = any(isinstance(result.result, ToolRejectedError) for result in results)\nif rejected:\n    _ = self._denwa_renji.fetch_pending_dmail()\n    return True\n```\n\nThis prevents time travel when the current step didn't complete successfully, maintaining consistency.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:201-204]()\n\n### Interaction with Context Compaction\n\nContext compaction (see [Context Compaction](#7.4)) also uses the checkpoint system:\n\n```python\nasync def compact_context(self) -\u003e None:\n    compacted_messages = await _compact_with_retry()\n    await self._context.revert_to(0)  # Revert to initial state\n    await self._checkpoint()\n    await self._context.append_message(compacted_messages)\n```\n\nCompaction reverts to checkpoint 0, creates a new checkpoint, then appends the compacted messages. This resets the checkpoint sequence, which affects subsequent D-Mail operations.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:245-270]()\n\n## Key Implementation Details\n\n### Context Variable Usage\n\nThe system uses Python's `contextvars` to track the current wire (event queue) during tool execution:\n\n```python\nfrom kimi_cli.soul.wire import current_wire\n\nwire_token = current_wire.set(wire)\ntry:\n    await self._agent_loop(wire)\nfinally:\n    current_wire.reset(wire_token)\n```\n\nThis allows tools deep in the call stack to access the wire without explicit parameter passing.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:106-110]()\n\n### Shield from Interruption\n\nContext manipulation is protected from cancellation:\n\n```python\n# shield the context manipulation from interruption\nawait asyncio.shield(self._grow_context(result, results))\n```\n\nThis ensures that context updates are atomic and not left in an inconsistent state if the user cancels execution.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:198-199]()\n\n### Checkpoint Count Synchronization\n\nThe checkpoint count is synchronized with DenwaRenji before each step:\n\n```python\nself._denwa_renji.set_n_checkpoints(self._context.n_checkpoints)\n```\n\nThis ensures that DenwaRenji can validate D-Mail checkpoint IDs against the current state.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:142]()\n\n## Usage Examples\n\n### Example 1: Pruning Large File Content\n\n```\n# Agent reads a large file\nCHECKPOINT 1\nUser: \"Analyze the file /path/to/large.py\"\nAssistant: [calls ReadFile]\nTool Result: [5000 lines of code]\n\n# Agent realizes most content is irrelevant\nAssistant: [calls SendDMail(checkpoint_id=1, message=\"The file contains...\")]\n\n# System reverts to CHECKPOINT 1\nCHECKPOINT 1\nUser: \"Analyze the file /path/to/large.py\"\nSystem: \"You just got a D-Mail from your future self...\"\nD-Mail content: \"The file contains only 3 relevant functions...\"\n\n# Agent continues with pruned context\n```\n\n### Example 2: Fixing Failed Attempts\n\n```\nCHECKPOINT 3\nUser: \"Implement feature X\"\nAssistant: [writes code version 1]\nAssistant: [tests, fails]\nAssistant: [modifies code]\nAssistant: [tests again, fails]\nAssistant: [finally succeeds with version 4]\nAssistant: [calls SendDMail(checkpoint_id=3, message=\"Write version 4\")]\n\n# Reverts to checkpoint 3, avoiding all failed attempts\nCHECKPOINT 3\nUser: \"Implement feature X\"\nSystem: \"D-Mail: Write version 4 directly: [working code]\"\n```\n\n**Sources:** [tests/test_tool_descriptions.py:66-73]()\n\n---\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:1-309](), [tests/test_tool_descriptions.py:54-74](), [tests/test_tool_schemas.py:44-59](), [src/kimi_cli/soul/__init__.py:1-60]()"])</script><script>self.__next_f.push([1,"2c:T4936,"])</script><script>self.__next_f.push([1,"# Advanced Features\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n\n\u003c/details\u003e\n\n\n\nThis document covers the sophisticated capabilities of kimi-cli that enable robust, controllable, and efficient agent execution. These features include context and session management with checkpoints, an approval system for dangerous operations, the D-Mail time-travel mechanism for context manipulation, automatic context compaction, and the auto-update system.\n\nFor basic agent execution flow, see [Agent System](#3.2). For tool-specific documentation, see [Tool System](#6). For UI-level features like meta commands, see [Meta Commands](#4.2).\n\n## Overview of Advanced Capabilities\n\nThe advanced features of kimi-cli work together to provide a production-grade agent execution environment. These systems are primarily implemented in the `KimiSoul` execution engine and coordinated through the `Wire` communication layer.\n\n### Feature Integration Architecture\n\n```mermaid\ngraph TB\n    subgraph \"KimiSoul Execution Engine\"\n        AgentLoop[\"_agent_loop()\"]\n        Step[\"_step()\"]\n        Checkpoint[\"_checkpoint()\"]\n        Compact[\"compact_context()\"]\n    end\n    \n    subgraph \"Context Management\"\n        Context[\"Context\"]\n        History[\"history: Sequence[Message]\"]\n        CheckpointStore[\"checkpoint_0, checkpoint_1, ...\"]\n        TokenCount[\"token_count\"]\n    end\n    \n    subgraph \"Approval System\"\n        Approval[\"Approval\"]\n        RequestQueue[\"_request_queue\"]\n        AutoApprove[\"_auto_approve_actions\"]\n        YoloMode[\"_yolo: bool\"]\n    end\n    \n    subgraph \"D-Mail System\"\n        DenwaRenji[\"DenwaRenji\"]\n        PendingDMail[\"fetch_pending_dmail()\"]\n        BackToFuture[\"BackToTheFuture exception\"]\n    end\n    \n    subgraph \"Compaction System\"\n        SimpleCompaction[\"SimpleCompaction\"]\n        CompactTrigger[\"token_count + RESERVED_TOKENS\"]\n        CompactionEvents[\"CompactionBegin/End\"]\n    end\n    \n    subgraph \"Communication\"\n        Wire[\"Wire\"]\n        ApprovalRequest[\"ApprovalRequest\"]\n        StatusUpdate[\"StatusUpdate\"]\n    end\n    \n    AgentLoop --\u003e Step\n    AgentLoop --\u003e Checkpoint\n    AgentLoop --\u003e Compact\n    \n    Step --\u003e Context\n    Step --\u003e Approval\n    Step --\u003e DenwaRenji\n    \n    Checkpoint --\u003e Context\n    Checkpoint --\u003e CheckpointStore\n    \n    Context --\u003e History\n    Context --\u003e TokenCount\n    \n    Compact --\u003e SimpleCompaction\n    Compact --\u003e Context\n    CompactTrigger --\u003e Compact\n    \n    Approval --\u003e RequestQueue\n    Approval --\u003e AutoApprove\n    Approval --\u003e YoloMode\n    Approval --\u003e Wire\n    \n    DenwaRenji --\u003e PendingDMail\n    PendingDMail --\u003e BackToFuture\n    BackToFuture --\u003e Context\n    \n    Wire --\u003e ApprovalRequest\n    Wire --\u003e StatusUpdate\n    Wire --\u003e CompactionEvents\n    \n    Step --\u003e Wire\n    Compact --\u003e CompactionEvents\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:40-292](), [src/kimi_cli/soul/wire.py:95-127](), [src/kimi_cli/soul/approval.py:8-71]()\n\n## Agent Execution Loop with Advanced Features\n\nThe `KimiSoul._agent_loop()` method orchestrates all advanced features during agent execution. Each iteration of the loop performs checkpointing, context compaction checks, step execution, approval handling, and D-Mail processing.\n\n### Main Loop Flow\n\n```mermaid\nsequenceDiagram\n    participant Loop as \"_agent_loop()\"\n    participant Step as \"_step()\"\n    participant Context\n    participant Approval\n    participant DenwaRenji\n    participant Wire\n    participant LLM\n    \n    loop Each step_no\n        Loop-\u003e\u003eWire: send(StepBegin(step_no))\n        Loop-\u003e\u003eLoop: create approval task\n        \n        alt Context too long\n            Loop-\u003e\u003eWire: send(CompactionBegin())\n            Loop-\u003e\u003eLoop: compact_context()\n            Loop-\u003e\u003eWire: send(CompactionEnd())\n        end\n        \n        Loop-\u003e\u003eContext: checkpoint()\n        Loop-\u003e\u003eDenwaRenji: set_n_checkpoints()\n        \n        Loop-\u003e\u003eStep: _step(wire)\n        \n        Step-\u003e\u003eLLM: kosong.step()\n        LLM--\u003e\u003eStep: StepResult\n        \n        Step-\u003e\u003eContext: append_message(result.message)\n        \n        opt Tool calls present\n            Step-\u003e\u003eApproval: request approval via Wire\n            Approval--\u003e\u003eStep: approved/rejected\n            Step-\u003e\u003eStep: execute tools\n            Step-\u003e\u003eContext: append tool results\n        end\n        \n        Step-\u003e\u003eDenwaRenji: fetch_pending_dmail()\n        \n        alt D-Mail pending\n            Step--\u003e\u003eLoop: raise BackToTheFuture\n            Loop-\u003e\u003eContext: revert_to(checkpoint_id)\n            Loop-\u003e\u003eContext: checkpoint()\n            Loop-\u003e\u003eContext: append_message(dmail)\n            note over Loop: Continue from checkpoint\n        end\n        \n        Step--\u003e\u003eLoop: finished (bool)\n        \n        alt finished\n            Loop--\u003e\u003eLoop: return\n        end\n        \n        alt step_no \u003e max_steps_per_run\n            Loop--\u003e\u003eLoop: raise MaxStepsReached\n        end\n    end\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:112-161](), [src/kimi_cli/soul/kimisoul.py:163-232]()\n\n## Context Management and Checkpointing\n\nThe `Context` class maintains conversation history and provides checkpoint-based state management. Checkpoints enable the D-Mail system to revert to previous states.\n\n### Checkpoint Creation and Token Tracking\n\n| Operation | Method | Trigger |\n|-----------|--------|---------|\n| Create checkpoint | `Context.checkpoint()` | Before each agent step |\n| Revert to checkpoint | `Context.revert_to(checkpoint_id)` | When D-Mail received |\n| Update token count | `Context.update_token_count()` | After LLM response |\n| Check context size | `Context.token_count` | Before each step |\n\nThe `KimiSoul` class checks context size before each step and triggers compaction when `token_count + RESERVED_TOKENS \u003e= max_context_size`. The constant `RESERVED_TOKENS = 50_000` ensures adequate buffer for tool results and assistant responses.\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Checkpoint0: \"Initial checkpoint\"\n    Checkpoint0 --\u003e Checkpoint1: \"After first step\"\n    Checkpoint1 --\u003e Checkpoint2: \"After second step\"\n    Checkpoint2 --\u003e Checkpoint3: \"After third step\"\n    \n    Checkpoint3 --\u003e Checkpoint1: \"revert_to(1) via D-Mail\"\n    Checkpoint1 --\u003e Checkpoint2b: \"Resume with new messages\"\n    \n    note right of Checkpoint0: \"_checkpoint_with_user_message\\ncontrols if user message\\nis in checkpoint\"\n    \n    note right of Checkpoint1: \"Each checkpoint stores\\nhistory state before step\"\n```\n\nThe `_checkpoint_with_user_message` flag is set when the `SendDMail` tool is present in the agent's toolset, ensuring user messages are included in checkpoints for time-travel scenarios.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:96-98](), [src/kimi_cli/soul/kimisoul.py:72-76](), [src/kimi_cli/soul/kimisoul.py:131-138]()\n\n## Approval System Architecture\n\nThe `Approval` class implements a request-response pattern for dangerous operations. Tools request approval through the `Approval.request()` method, which creates an `ApprovalRequest` that is sent to the UI via the `Wire`.\n\n### Approval Flow with Modes\n\n```mermaid\nflowchart TD\n    ToolCall[\"Tool execution begins\"] --\u003e CheckContext{\"Tool needs approval?\"}\n    CheckContext --\u003e|No| Execute[\"Execute directly\"]\n    CheckContext --\u003e|Yes| CreateRequest[\"Create ApprovalRequest\"]\n    \n    CreateRequest --\u003e CheckYolo{\"_yolo == True?\"}\n    CheckYolo --\u003e|Yes| AutoApprove[\"Return True immediately\"]\n    \n    CheckYolo --\u003e|No| CheckAuto{\"action in\\n_auto_approve_actions?\"}\n    CheckAuto --\u003e|Yes| AutoApprove\n    \n    CheckAuto --\u003e|No| QueueRequest[\"Put in _request_queue\"]\n    QueueRequest --\u003e SendWire[\"Send via Wire to UI\"]\n    SendWire --\u003e WaitResponse[\"await request.wait()\"]\n    \n    WaitResponse --\u003e ResponseType{Response type?}\n    ResponseType --\u003e|APPROVE| ExecuteOnce[\"Execute once\\nReturn True\"]\n    ResponseType --\u003e|APPROVE_FOR_SESSION| AddToAuto[\"Add to _auto_approve_actions\"]\n    AddToAuto --\u003e ExecuteAuto[\"Execute\\nReturn True\"]\n    ResponseType --\u003e|REJECT| RejectExec[\"Return False\"]\n    \n    AutoApprove --\u003e Execute\n    ExecuteOnce --\u003e Execute\n    ExecuteAuto --\u003e Execute\n    RejectExec --\u003e ToolRejected[\"Return ToolRejectedError\"]\n    \n    Execute --\u003e Complete[\"Tool completes\"]\n    ToolRejected --\u003e Complete\n```\n\n### Approval Request Structure\n\nThe `ApprovalRequest` class (defined in [src/kimi_cli/soul/wire.py:55-90]()) contains:\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `id` | `str` | Unique request identifier (UUID) |\n| `tool_call_id` | `str` | Associated tool call ID from LLM |\n| `sender` | `str` | Tool name requesting approval |\n| `action` | `str` | Action identifier for auto-approval tracking |\n| `description` | `str` | Human-readable description for UI display |\n| `_future` | `asyncio.Future[ApprovalResponse]` | Response mechanism |\n\n**Sources:** [src/kimi_cli/soul/approval.py:8-65](), [src/kimi_cli/tools/bash/__init__.py:40-45](), [src/kimi_cli/soul/wire.py:55-90]()\n\n## D-Mail Time Travel System\n\nThe D-Mail system allows agents to send messages to their past selves by reverting context to a previous checkpoint. This is implemented through the `DenwaRenji` class and the `SendDMail` tool.\n\n### Time Travel Mechanism\n\n```mermaid\ngraph TB\n    subgraph \"Step N Execution\"\n        StepN[\"_step() executes\"]\n        SendDMail[\"SendDMail tool called\"]\n        StoreDMail[\"DenwaRenji.send_dmail()\"]\n    end\n    \n    subgraph \"Step N+1 Check\"\n        StepN1[\"_step() completes\"]\n        FetchDMail[\"denwa_renji.fetch_pending_dmail()\"]\n        CheckDMail{\"dmail != None?\"}\n    end\n    \n    subgraph \"Time Travel\"\n        RaiseException[\"raise BackToTheFuture(checkpoint_id, messages)\"]\n        CatchLoop[\"_agent_loop() catches exception\"]\n        Revert[\"context.revert_to(checkpoint_id)\"]\n        NewCheckpoint[\"Create new checkpoint\"]\n        AppendDMail[\"Append D-Mail as system message\"]\n    end\n    \n    subgraph \"Resume Execution\"\n        ContinueLoop[\"Loop continues from checkpoint\"]\n        AgentReads[\"Agent reads D-Mail in context\"]\n        NewPath[\"Agent takes different path\"]\n    end\n    \n    StepN --\u003e SendDMail\n    SendDMail --\u003e StoreDMail\n    StoreDMail --\u003e StepN1\n    StepN1 --\u003e FetchDMail\n    FetchDMail --\u003e CheckDMail\n    \n    CheckDMail --\u003e|Yes| RaiseException\n    CheckDMail --\u003e|No| Normal[\"Normal flow continues\"]\n    \n    RaiseException --\u003e CatchLoop\n    CatchLoop --\u003e Revert\n    Revert --\u003e NewCheckpoint\n    NewCheckpoint --\u003e AppendDMail\n    AppendDMail --\u003e ContinueLoop\n    ContinueLoop --\u003e AgentReads\n    AgentReads --\u003e NewPath\n```\n\nThe `BackToTheFuture` exception (defined in [src/kimi_cli/soul/kimisoul.py:294-302]()) carries:\n- `checkpoint_id`: The checkpoint to revert to\n- `messages`: System message with D-Mail content\n\nThe D-Mail message format includes a system directive that the agent should never mention this information to the user, maintaining the illusion of linear time.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:206-230](), [src/kimi_cli/soul/kimisoul.py:144-148](), [src/kimi_cli/soul/kimisoul.py:294-302]()\n\n## Context Compaction System\n\nWhen context approaches the LLM's token limit, the `SimpleCompaction` class compacts the history by summarizing older messages while preserving recent context.\n\n### Compaction Trigger and Process\n\n```mermaid\nsequenceDiagram\n    participant Loop as \"_agent_loop()\"\n    participant Context\n    participant Wire\n    participant Compaction as \"SimpleCompaction\"\n    participant LLM\n    \n    Loop-\u003e\u003eContext: Check token_count\n    \n    alt token_count + RESERVED_TOKENS \u003e= max_context_size\n        Loop-\u003e\u003eWire: send(CompactionBegin())\n        Loop-\u003e\u003eLoop: compact_context()\n        \n        Loop-\u003e\u003eCompaction: compact(history, llm)\n        \n        loop Retry with exponential backoff\n            Compaction-\u003e\u003eLLM: Call for summarization\n            LLM--\u003e\u003eCompaction: Compacted messages\n        end\n        \n        Compaction--\u003e\u003eLoop: compacted_messages\n        \n        Loop-\u003e\u003eContext: revert_to(0)\n        Loop-\u003e\u003eContext: checkpoint()\n        Loop-\u003e\u003eContext: append_message(compacted_messages)\n        \n        Loop-\u003e\u003eWire: send(CompactionEnd())\n    end\n```\n\nThe compaction process:\n1. Detects when `token_count + RESERVED_TOKENS \u003e= max_context_size` ([src/kimi_cli/soul/kimisoul.py:131-134]())\n2. Sends `CompactionBegin()` event to UI\n3. Calls `SimpleCompaction.compact()` with retry logic\n4. Reverts context to checkpoint 0 (initial state)\n5. Creates new checkpoint\n6. Appends compacted messages\n7. Sends `CompactionEnd()` event to UI\n\n### Retry Configuration\n\nBoth `_step()` and `compact_context()` use `tenacity` retry decorators with:\n- Exponential backoff with jitter: `initial=0.3, max=5, jitter=0.5`\n- Max attempts: `loop_control.max_retries_per_step`\n- Retryable errors: `APIConnectionError`, `APITimeoutError`, `APIStatusError` (429, 500, 502, 503)\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:131-138](), [src/kimi_cli/soul/kimisoul.py:245-269](), [src/kimi_cli/soul/kimisoul.py:169-174](), [src/kimi_cli/soul/kimisoul.py:272-280]()\n\n## Wire Communication Layer\n\nThe `Wire` class provides an async queue-based communication channel between `KimiSoul` and the UI layer. All events, tool results, and approval requests flow through this channel.\n\n### Wire Message Types\n\n| Message Type | Category | Purpose |\n|--------------|----------|---------|\n| `StepBegin(n)` | Control Flow | Indicates step N is starting |\n| `StepInterrupted` | Control Flow | Step was cancelled/interrupted |\n| `CompactionBegin` | Control Flow | Context compaction started |\n| `CompactionEnd` | Control Flow | Context compaction completed |\n| `StatusUpdate` | Status | Updated context usage percentage |\n| `ContentPart` | LLM Output | Streaming text content |\n| `ToolCall` | LLM Output | Tool invocation from LLM |\n| `ToolCallPart` | LLM Output | Streaming tool call arguments |\n| `ToolResult` | Tool Output | Result of tool execution |\n| `ApprovalRequest` | User Input | Request user approval |\n\nThe `current_wire` context variable ([src/kimi_cli/soul/wire.py:118]()) allows tools to access the wire from anywhere in the call stack without explicit parameter passing.\n\n### Approval Request Piping\n\n```mermaid\nsequenceDiagram\n    participant Loop as \"_agent_loop()\"\n    participant ApprovalQueue as \"Approval._request_queue\"\n    participant PipeTask as \"Approval pipe task\"\n    participant Wire\n    participant UI\n    \n    Loop-\u003e\u003eLoop: Create approval pipe task\n    \n    activate PipeTask\n    loop Until cancelled\n        PipeTask-\u003e\u003eApprovalQueue: fetch_request()\n        ApprovalQueue--\u003e\u003ePipeTask: ApprovalRequest\n        PipeTask-\u003e\u003eWire: send(request)\n        Wire-\u003e\u003eUI: receive() -\u003e request\n    end\n    deactivate PipeTask\n    \n    Note over Loop,UI: Main step execution happens concurrently\n    \n    Loop-\u003e\u003eLoop: Step completes or raises\n    Loop-\u003e\u003ePipeTask: cancel()\n```\n\nThe approval pipe task ([src/kimi_cli/soul/kimisoul.py:116-119]()) runs concurrently with step execution, ensuring approval requests are immediately visible to the UI.\n\n**Sources:** [src/kimi_cli/soul/wire.py:95-127](), [src/kimi_cli/soul/kimisoul.py:116-124](), [src/kimi_cli/soul/wire.py:45-46]()\n\n## Interruption and Cancellation Handling\n\nThe agent execution can be interrupted at specific points while maintaining context integrity. The `asyncio.shield()` call protects critical context operations from cancellation.\n\n### Safe Interruption Points\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e WaitStep: \"Interruptible\"\n    WaitStep --\u003e WaitToolResults: \"Interruptible\"\n    WaitToolResults --\u003e ShieldedContext: \"Shield active\"\n    ShieldedContext --\u003e CheckDMail: \"Interruptible\"\n    CheckDMail --\u003e NextStep: \"Interruptible\"\n    \n    WaitStep --\u003e Interrupted: \"asyncio.CancelledError\"\n    WaitToolResults --\u003e Interrupted: \"asyncio.CancelledError\"\n    CheckDMail --\u003e Interrupted: \"asyncio.CancelledError\"\n    NextStep --\u003e Interrupted: \"asyncio.CancelledError\"\n    \n    ShieldedContext --\u003e [*]: \"Never interrupted here\"\n    Interrupted --\u003e [*]\n    \n    note right of ShieldedContext: \"_grow_context() is shielded\\nto prevent context corruption\"\n```\n\nWhen a `ChatProviderError` or `asyncio.CancelledError` is raised, the loop sends `StepInterrupted()` and breaks, maintaining context consistency.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:149-154](), [src/kimi_cli/soul/kimisoul.py:199](), [src/kimi_cli/ui/__init__.py:18-70]()\n\n## Status Tracking and Updates\n\nThe `StatusSnapshot` class ([src/kimi_cli/soul/__init__.py:23-25]()) provides a lightweight status object containing `context_usage` (a float representing percentage of max context used). This is sent to the UI via `StatusUpdate` events after each LLM call.\n\nThe `KimiSoul.status` property ([src/kimi_cli/soul/kimisoul.py:86-88]()) computes current status, and `_context_usage` ([src/kimi_cli/soul/kimisoul.py:91-94]()) calculates `token_count / max_context_size`.\n\n**Sources:** [src/kimi_cli/soul/__init__.py:23-25](), [src/kimi_cli/soul/kimisoul.py:86-94](), [src/kimi_cli/soul/kimisoul.py:189-192]()\n\n## Integration Example: Bash Tool Approval\n\nThe `Bash` tool demonstrates how tools integrate with the approval system:\n\n```python\n# From bash/__init__.py\nasync def __call__(self, params: Params) -\u003e ToolReturnType:\n    builder = ToolResultBuilder()\n    \n    if not await self._approval.request(\n        self.name,\n        \"run shell command\",\n        f\"Run command `{params.command}`\",\n    ):\n        return ToolRejectedError()\n    \n    # Execute shell command...\n```\n\nThe approval system:\n1. Checks yolo mode first (auto-approve if enabled)\n2. Checks if \"run shell command\" is in `_auto_approve_actions`\n3. If not, creates `ApprovalRequest` and waits for UI response\n4. Returns `True` for approve, `False` for reject\n5. If `APPROVE_FOR_SESSION`, adds action to auto-approve list\n\n**Sources:** [src/kimi_cli/tools/bash/__init__.py:37-45](), [src/kimi_cli/soul/approval.py:18-64]()\n\n## Child Pages\n\nFor detailed documentation on specific advanced features:\n\n- **[Context and Session Management](#7.1)** - Deep dive into context storage, checkpoint mechanics, and session continuation\n- **[Approval System](#7.2)** - Complete approval workflow, yolo mode, and session-wide approvals\n- **[D-Mail and Time Travel](#7.3)** - SendDMail tool usage, DenwaRenji implementation, and time-travel patterns\n- **[Context Compaction](#7.4)** - Compaction algorithms, token management, and history summarization\n- **[Auto-Update System](#7.5)** - Background update checking and binary installation"])</script><script>self.__next_f.push([1,"2d:T4172,"])</script><script>self.__next_f.push([1,"# Context and Session Management\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/__init__.py](src/kimi_cli/__init__.py)\n- [src/kimi_cli/agent.py](src/kimi_cli/agent.py)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document explains how kimi-cli manages conversation state through sessions and contexts. Sessions provide persistent storage for multi-turn conversations across invocations, while contexts manage the in-memory message history and token tracking during agent execution. For information about agent configuration and initialization, see [Agent Configuration](#5). For details on the D-Mail time travel system that relies on checkpointing, see [D-Mail and Time Travel](#7.3).\n\n---\n\n## Session Management\n\n### Session Lifecycle\n\nA session represents a persistent conversation tied to a specific working directory. Each session has a unique identifier and maintains its own history file for storing the conversation across CLI invocations.\n\nThe session lifecycle begins when the user invokes the `kimi` command. The system determines whether to create a new session or continue an existing one based on the `--continue` flag:\n\n```\nUser invokes CLI\n        \n    --continue flag?\n        \n    Yes  continue_session(work_dir)\n        \n    Found?  Use existing session\n    Not Found?  Error\n        \n    No  new_session(work_dir)\n        \n    Create new session with unique ID\n```\n\n**Sources:** [src/kimi_cli/__init__.py:192-202]()\n\n### Session Data Structure\n\nThe `Session` object contains the following key attributes:\n\n| Attribute | Type | Description |\n|-----------|------|-------------|\n| `id` | `str` | Unique session identifier (timestamp-based) |\n| `work_dir` | `Path` | Absolute path to the working directory |\n| `history_file` | `Path` | Path to the persistent history file |\n\nSessions are stored in the share directory under `.kimi/sessions/\u003csession_id\u003e/`, with the history file typically named `history.jsonl`.\n\n**Sources:** [src/kimi_cli/__init__.py:31](), [src/kimi_cli/__init__.py:192-202]()\n\n### Session Creation and Continuation\n\n```mermaid\nsequenceDiagram\n    participant CLI as \"CLI Entry Point\"\n    participant Metadata as \"Session Metadata\"\n    participant FS as \"File System\"\n    \n    alt Create New Session\n        CLI-\u003e\u003eMetadata: new_session(work_dir)\n        Metadata-\u003e\u003eMetadata: Generate session ID\n        Metadata-\u003e\u003eFS: Create session directory\n        Metadata-\u003e\u003eFS: Initialize history file\n        Metadata--\u003e\u003eCLI: Session object\n    else Continue Existing Session\n        CLI-\u003e\u003eMetadata: continue_session(work_dir)\n        Metadata-\u003e\u003eFS: Look up last session\n        alt Session Found\n            Metadata-\u003e\u003eFS: Verify history file exists\n            Metadata--\u003e\u003eCLI: Existing Session object\n        else Session Not Found\n            Metadata--\u003e\u003eCLI: None\n            CLI-\u003e\u003eCLI: Raise error\n        end\n    end\n```\n\n**Sources:** [src/kimi_cli/__init__.py:192-202](), [src/kimi_cli/metadata.py:31]()\n\n---\n\n## Context Management\n\n### Context Overview\n\nThe `Context` class manages the in-memory conversation history during agent execution. It is responsible for:\n- Loading and restoring history from the session's history file\n- Appending new messages to the conversation\n- Tracking token usage\n- Creating and managing checkpoints for time travel\n- Persisting changes back to the history file\n\n```mermaid\ngraph TB\n    Session[\"Session\u003cbr/\u003e(id, work_dir, history_file)\"]\n    Context[\"Context\u003cbr/\u003e(history, token_count, checkpoints)\"]\n    HistoryFile[\"history.jsonl\u003cbr/\u003e(Persistent Storage)\"]\n    Messages[\"Message List\u003cbr/\u003e(In-Memory History)\"]\n    \n    Session --\u003e|\"provides history_file path\"| Context\n    Context --\u003e|\"restore()\"| HistoryFile\n    HistoryFile --\u003e|\"loads messages\"| Messages\n    Context --\u003e|\"manages\"| Messages\n    Context --\u003e|\"append_message()\"| Messages\n    Context --\u003e|\"checkpoint()\"| HistoryFile\n    Messages --\u003e|\"persisted to\"| HistoryFile\n```\n\n**Sources:** [src/kimi_cli/__init__.py:336-339](), [src/kimi_cli/soul/context.py:34]()\n\n### Context Initialization and Restoration\n\nWhen the agent starts, the context is created with the session's history file path and attempts to restore previous conversation history:\n\n```mermaid\nsequenceDiagram\n    participant Main as \"kimi_run()\"\n    participant Context\n    participant HistoryFile as \"history.jsonl\"\n    \n    Main-\u003e\u003eContext: Context(session.history_file)\n    Main-\u003e\u003eContext: restore()\n    Context-\u003e\u003eHistoryFile: Read existing messages\n    alt History File Exists\n        HistoryFile--\u003e\u003eContext: Previous messages\n        Context-\u003e\u003eContext: Load into history list\n        Context--\u003e\u003eMain: True (restored)\n    else History File Empty/Missing\n        Context--\u003e\u003eMain: False (new context)\n    end\n```\n\nThis allows users to seamlessly continue conversations across multiple CLI invocations when using the `--continue` flag.\n\n**Sources:** [src/kimi_cli/__init__.py:336-339]()\n\n### Message Appending and Persistence\n\nDuring agent execution, messages are appended to the context in the following scenarios:\n\n1. **User messages**: When the user provides input ([src/kimi_cli/soul/kimisoul.py:104]())\n2. **Assistant messages**: After each LLM step ([src/kimi_cli/soul/kimisoul.py:236]())\n3. **Tool result messages**: After tool execution completes ([src/kimi_cli/soul/kimisoul.py:242-243]())\n4. **System messages**: For D-Mail time travel instructions ([src/kimi_cli/soul/kimisoul.py:216-229]())\n\n```mermaid\ngraph LR\n    UserInput[\"User Input\"]\n    LLMResponse[\"LLM Response\"]\n    ToolResults[\"Tool Results\"]\n    DMail[\"D-Mail Messages\"]\n    \n    UserInput --\u003e|\"append_message()\"| Context\n    LLMResponse --\u003e|\"append_message()\"| Context\n    ToolResults --\u003e|\"append_message()\"| Context\n    DMail --\u003e|\"append_message()\"| Context\n    \n    Context[\"Context\u003cbr/\u003e(history list)\"]\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:104](), [src/kimi_cli/soul/kimisoul.py:234-243]()\n\n### Token Tracking\n\nThe context maintains a running count of tokens used in the conversation. This is critical for:\n- Triggering context compaction when approaching model limits\n- Providing usage statistics to the UI\n- Determining when checkpoints are needed\n\n```mermaid\nsequenceDiagram\n    participant Soul as \"KimiSoul\"\n    participant Context\n    participant LLM\n    participant Wire\n    \n    Soul-\u003e\u003eLLM: Step request\n    LLM--\u003e\u003eSoul: StepResult with usage\n    Soul-\u003e\u003eContext: update_token_count(usage.input)\n    Note over Context: Updates before-step token count\n    Soul-\u003e\u003eWire: StatusUpdate(context_usage)\n    Soul-\u003e\u003eContext: append_message(result.message)\n    Soul-\u003e\u003eContext: update_token_count(usage.total)\n    Note over Context: Updates after-step token count\n```\n\nThe `context_usage` property calculates the percentage of the model's maximum context size being used:\n\n```\ncontext_usage = token_count / max_context_size\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:189-192](), [src/kimi_cli/soul/kimisoul.py:91-94](), [src/kimi_cli/soul/kimisoul.py:234-238]()\n\n---\n\n## Checkpointing System\n\n### Checkpoint Mechanism\n\nCheckpoints are snapshots of the conversation history at specific points in time. They enable the D-Mail time travel feature by allowing the agent to revert to a previous state and receive messages from its \"future self.\"\n\n```mermaid\ngraph TB\n    subgraph \"Checkpoint Timeline\"\n        CP0[\"Checkpoint 0\u003cbr/\u003e(Initial State)\"]\n        CP1[\"Checkpoint 1\u003cbr/\u003e(After User Msg 1)\"]\n        CP2[\"Checkpoint 2\u003cbr/\u003e(After User Msg 2)\"]\n        CP3[\"Checkpoint 3\u003cbr/\u003e(After User Msg 3)\"]\n    end\n    \n    subgraph \"Operations\"\n        Create[\"checkpoint()\u003cbr/\u003eCreate new checkpoint\"]\n        Revert[\"revert_to(id)\u003cbr/\u003eRestore to checkpoint\"]\n    end\n    \n    CP0 --\u003e CP1\n    CP1 --\u003e CP2\n    CP2 --\u003e CP3\n    Create -.-\u003e|\"stores current state\"| CP3\n    Revert -.-\u003e|\"restores history\"| CP1\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:96-98](), [src/kimi_cli/soul/kimisoul.py:141](), [src/kimi_cli/soul/kimisoul.py:145]()\n\n### Checkpoint Creation Strategy\n\nCheckpoints are created at strategic points during agent execution:\n\n| Timing | Purpose | Code Reference |\n|--------|---------|----------------|\n| Before first user message | Establishes checkpoint 0 (baseline) | [src/kimi_cli/soul/kimisoul.py:103]() |\n| Before each agent step | Enables reversion if D-Mail received | [src/kimi_cli/soul/kimisoul.py:141]() |\n| After context compaction | Preserves compacted state | [src/kimi_cli/soul/kimisoul.py:268]() |\n\nThe checkpoint system is conditional on whether the agent has the `SendDMail` tool enabled:\n\n```python\nif tool.name == SendDMail_NAME:\n    self._checkpoint_with_user_message = True\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:71-76](), [src/kimi_cli/soul/kimisoul.py:96-98]()\n\n### Checkpoint Reversion for Time Travel\n\nWhen a D-Mail is received, the agent reverts to a specified checkpoint and continues execution from that point with the D-Mail message injected:\n\n```mermaid\nsequenceDiagram\n    participant Soul as \"KimiSoul Agent Loop\"\n    participant Context\n    participant DenwaRenji\n    participant HistoryFile\n    \n    Soul-\u003e\u003eDenwaRenji: fetch_pending_dmail()\n    alt D-Mail Present\n        DenwaRenji--\u003e\u003eSoul: DMail(checkpoint_id, message)\n        Soul-\u003e\u003eSoul: Raise BackToTheFuture exception\n        Soul-\u003e\u003eContext: revert_to(checkpoint_id)\n        Context-\u003e\u003eHistoryFile: Truncate to checkpoint\n        Context-\u003e\u003eContext: Clear in-memory history\n        Context-\u003e\u003eHistoryFile: Reload from file\n        Soul-\u003e\u003eContext: checkpoint()\n        Soul-\u003e\u003eContext: append_message(dmail_system_msg)\n        Note over Soul: Agent continues from checkpoint\u003cbr/\u003ewith D-Mail context\n    end\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:206-230](), [src/kimi_cli/soul/kimisoul.py:144-148](), [src/kimi_cli/soul/kimisoul.py:267-269]()\n\n---\n\n## Context Compaction\n\n### Compaction Trigger\n\nWhen the context grows too large and approaches the model's maximum context size, automatic compaction is triggered:\n\n```python\nif (context.token_count + RESERVED_TOKENS \u003e= llm.max_context_size):\n    # Trigger compaction\n```\n\nThe `RESERVED_TOKENS` constant (50,000 tokens) provides a safety buffer to prevent context overflow during the next LLM call.\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:37](), [src/kimi_cli/soul/kimisoul.py:131-138]()\n\n### Compaction Process\n\n```mermaid\nsequenceDiagram\n    participant AgentLoop as \"Agent Loop\"\n    participant Context\n    participant Compaction as \"SimpleCompaction\"\n    participant LLM\n    participant Wire\n    \n    AgentLoop-\u003e\u003eAgentLoop: Check context size\n    alt Context Too Large\n        AgentLoop-\u003e\u003eWire: CompactionBegin()\n        AgentLoop-\u003e\u003eCompaction: compact(history, llm)\n        Compaction-\u003e\u003eLLM: Summarize conversation\n        LLM--\u003e\u003eCompaction: Compacted messages\n        Compaction--\u003e\u003eAgentLoop: New message list\n        AgentLoop-\u003e\u003eContext: revert_to(0)\n        AgentLoop-\u003e\u003eContext: checkpoint()\n        AgentLoop-\u003e\u003eContext: append_message(compacted)\n        AgentLoop-\u003e\u003eWire: CompactionEnd()\n    end\n```\n\nThe compaction process:\n1. Sends `CompactionBegin` event to UI\n2. Uses `SimpleCompaction` strategy to compress conversation history via LLM summarization\n3. Reverts context to checkpoint 0 (initial state)\n4. Creates a new checkpoint\n5. Appends the compacted messages\n6. Sends `CompactionEnd` event to UI\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:131-138](), [src/kimi_cli/soul/kimisoul.py:245-269]()\n\n---\n\n## Integration with Agent Execution\n\n### Context Lifecycle in Agent Run\n\nThe complete lifecycle of context management during a single agent run:\n\n```mermaid\ngraph TD\n    Start[\"soul.run(user_input, wire)\"]\n    Checkpoint0[\"Create checkpoint 0\u003cbr/\u003e(if first run)\"]\n    AppendUser[\"Append user message\"]\n    Loop[\"Enter agent_loop()\"]\n    \n    CheckCompact{\"Context\u003cbr/\u003etoo large?\"}\n    Compact[\"Compact context\"]\n    StepCheckpoint[\"Create checkpoint\u003cbr/\u003ebefore step\"]\n    LLMStep[\"Execute LLM step\"]\n    UpdateTokens[\"Update token count\"]\n    AppendResponse[\"Append assistant message\"]\n    AppendTools[\"Append tool results\"]\n    \n    CheckDMail{\"D-Mail\u003cbr/\u003epending?\"}\n    Revert[\"Revert to checkpoint\"]\n    InjectDMail[\"Inject D-Mail message\"]\n    \n    CheckFinished{\"Tool calls\u003cbr/\u003epresent?\"}\n    CheckMaxSteps{\"Max steps\u003cbr/\u003ereached?\"}\n    \n    End[\"Return to UI\"]\n    \n    Start --\u003e Checkpoint0\n    Checkpoint0 --\u003e AppendUser\n    AppendUser --\u003e Loop\n    Loop --\u003e CheckCompact\n    CheckCompact --\u003e|Yes| Compact\n    CheckCompact --\u003e|No| StepCheckpoint\n    Compact --\u003e StepCheckpoint\n    StepCheckpoint --\u003e LLMStep\n    LLMStep --\u003e UpdateTokens\n    UpdateTokens --\u003e AppendResponse\n    AppendResponse --\u003e AppendTools\n    AppendTools --\u003e CheckDMail\n    CheckDMail --\u003e|Yes| Revert\n    Revert --\u003e InjectDMail\n    InjectDMail --\u003e Loop\n    CheckDMail --\u003e|No| CheckFinished\n    CheckFinished --\u003e|No| End\n    CheckFinished --\u003e|Yes| CheckMaxSteps\n    CheckMaxSteps --\u003e|No| Loop\n    CheckMaxSteps --\u003e|Yes| End\n```\n\n**Sources:** [src/kimi_cli/soul/kimisoul.py:99-111](), [src/kimi_cli/soul/kimisoul.py:112-161]()\n\n### Context in AgentGlobals\n\nThe `Context` is not directly part of `AgentGlobals`, but is closely coordinated with it:\n\n```mermaid\ngraph TB\n    AgentGlobals[\"AgentGlobals\u003cbr/\u003e(Dependency Container)\"]\n    Config[\"config: Config\"]\n    LLM[\"llm: LLM\"]\n    Session[\"session: Session\"]\n    Approval[\"approval: Approval\"]\n    DenwaRenji[\"denwa_renji: DenwaRenji\"]\n    BuiltinArgs[\"builtin_args: BuiltinSystemPromptArgs\"]\n    \n    Context[\"Context\u003cbr/\u003e(Separate Instance)\"]\n    \n    AgentGlobals --\u003e Config\n    AgentGlobals --\u003e LLM\n    AgentGlobals --\u003e Session\n    AgentGlobals --\u003e Approval\n    AgentGlobals --\u003e DenwaRenji\n    AgentGlobals --\u003e BuiltinArgs\n    \n    Session -.-\u003e|\"provides history_file\"| Context\n    DenwaRenji -.-\u003e|\"coordinates with\"| Context\n    LLM -.-\u003e|\"provides max_context_size\"| Context\n```\n\nThe `Context` is created separately in `kimi_run()` using the `Session.history_file` from `AgentGlobals`, and is then passed to `KimiSoul` during initialization.\n\n**Sources:** [src/kimi_cli/__init__.py:310-322](), [src/kimi_cli/__init__.py:336-346](), [src/kimi_cli/agent.py:59-67]()\n\n---\n\n## File Storage and Persistence\n\n### History File Format\n\nThe conversation history is persisted in JSONL (JSON Lines) format, with each line representing a message or checkpoint marker. This format allows for:\n- Incremental writes without parsing the entire file\n- Easy inspection and debugging\n- Efficient checkpoint reversion by truncating the file\n\n### Storage Location\n\nSessions and their history files are stored under the kimi-cli share directory:\n\n```\n~/.local/share/kimi-cli/\n sessions/\n     \u003csession_id\u003e/\n         history.jsonl      # Main conversation history\n         _sub_\u003ctask_id\u003e/    # Subagent history files (if using Task tool)\n             history.jsonl\n```\n\nSubagents spawned via the Task tool maintain isolated history files in `_sub_\u003ctask_id\u003e` subdirectories to prevent context pollution of the main agent.\n\n**Sources:** [src/kimi_cli/__init__.py:32](), [src/kimi_cli/__init__.py:202]()\n\n### Persistence Guarantees\n\nThe context provides the following persistence guarantees:\n\n1. **Immediate writes**: Messages are written to disk as they are appended\n2. **Checkpoint atomicity**: Checkpoints represent consistent conversation states\n3. **Reversion safety**: Reverting to a checkpoint properly truncates both in-memory and on-disk history\n4. **Crash recovery**: Sessions can be continued even after unexpected termination\n\n**Sources:** [src/kimi_cli/soul/context.py:34]()\n\n---\n\n## Summary Table\n\n| Component | Purpose | Key Operations | Storage |\n|-----------|---------|----------------|---------|\n| `Session` | Persistent conversation identity | `new_session()`, `continue_session()` | `.kimi/sessions/\u003cid\u003e/` |\n| `Context` | In-memory history management | `restore()`, `append_message()`, `checkpoint()`, `revert_to()` | `history.jsonl` |\n| Checkpoints | Point-in-time snapshots | Create before each step, revert for D-Mail | Embedded in `history.jsonl` |\n| Token Tracking | Monitor context usage | `update_token_count()`, calculate usage percentage | In-memory counter |\n| Compaction | Context size management | Triggered at 50k token buffer, summarizes history | Replaces history in context |\n\n**Sources:** [src/kimi_cli/__init__.py:192-202](), [src/kimi_cli/__init__.py:336-339](), [src/kimi_cli/soul/kimisoul.py:96-98](), [src/kimi_cli/soul/kimisoul.py:189-192](), [src/kimi_cli/soul/kimisoul.py:131-138]()"])</script><script>self.__next_f.push([1,"2e:T5972,"])</script><script>self.__next_f.push([1,"# Approval System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/approval.py](src/kimi_cli/soul/approval.py)\n- [src/kimi_cli/soul/wire.py](src/kimi_cli/soul/wire.py)\n- [src/kimi_cli/tools/bash/__init__.py](src/kimi_cli/tools/bash/__init__.py)\n- [src/kimi_cli/ui/shell/console.py](src/kimi_cli/ui/shell/console.py)\n- [src/kimi_cli/ui/shell/keyboard.py](src/kimi_cli/ui/shell/keyboard.py)\n- [src/kimi_cli/ui/shell/liveview.py](src/kimi_cli/ui/shell/liveview.py)\n- [src/kimi_cli/ui/shell/visualize.py](src/kimi_cli/ui/shell/visualize.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the approval system used in kimi-cli to request user consent before executing potentially dangerous or system-modifying operations. The approval system provides a mechanism for tools to pause execution and wait for explicit user authorization before proceeding with sensitive actions.\n\nThis page focuses on the approval mechanism itself, including the `Approval` class, `ApprovalRequest` objects, and the communication protocol. For information about specific tools that use approval (such as Bash), see [System Execution Tools](#6.3). For the Wire communication layer that transports approval requests, see [Communication Layer](#3.4).\n\n---\n\n## Overview\n\nThe approval system is a safety mechanism that allows tools to request user consent before executing potentially destructive or system-modifying operations. The system supports three approval modes:\n\n| Mode | Behavior |\n|------|----------|\n| **Normal** | Each action requires explicit user approval |\n| **Session-wide approval** | User can approve an action for the entire session |\n| **Yolo mode** | All approvals are automatically granted |\n\nThe approval flow operates asynchronously: when a tool requires approval, it creates an `ApprovalRequest`, suspends execution, and waits for the user to respond via the UI. The UI presents the request to the user and captures their decision, which is then returned to the waiting tool.\n\nSources: [src/kimi_cli/soul/approval.py:1-71]()\n\n---\n\n## Architecture\n\n### Approval System Components\n\n```mermaid\ngraph TB\n    subgraph \"Tool Layer\"\n        Tool[\"Tool (e.g., Bash)\"]\n        ToolCall[\"ToolCall Context\"]\n    end\n    \n    subgraph \"Approval Core\"\n        Approval[\"Approval Class\u003cbr/\u003eapproval.py\"]\n        RequestQueue[\"asyncio.Queue[ApprovalRequest]\"]\n        YoloFlag[\"_yolo: bool\"]\n        AutoApprove[\"_auto_approve_actions: set\"]\n    end\n    \n    subgraph \"Communication\"\n        ApprovalRequest[\"ApprovalRequest\u003cbr/\u003ewire.py\"]\n        ApprovalResponse[\"ApprovalResponse Enum\u003cbr/\u003eAPPROVE, APPROVE_FOR_SESSION, REJECT\"]\n        Wire[\"Wire\"]\n    end\n    \n    subgraph \"UI Layer\"\n        UI[\"UI (Shell/Print/ACP)\"]\n        UserInput[\"User Decision\"]\n    end\n    \n    Tool --\u003e|\"request(sender, action, description)\"| Approval\n    ToolCall --\u003e|\"get_current_tool_call_or_none()\"| Approval\n    Approval --\u003e|\"check yolo\"| YoloFlag\n    Approval --\u003e|\"check action\"| AutoApprove\n    Approval --\u003e|\"create \u0026 enqueue\"| ApprovalRequest\n    Approval --\u003e|\"put_nowait()\"| RequestQueue\n    RequestQueue --\u003e|\"sent via\"| Wire\n    Wire --\u003e|\"receive()\"| UI\n    UI --\u003e|\"resolve(response)\"| ApprovalRequest\n    ApprovalRequest --\u003e|\"wait() -\u003e ApprovalResponse\"| Approval\n    Approval --\u003e|\"APPROVE_FOR_SESSION\"| AutoApprove\n    UserInput --\u003e|\"approve/reject\"| UI\n```\n\n**Architecture: Approval System Data Flow**\n\nThe approval system consists of three layers:\n\n1. **Tool Layer**: Tools make approval requests via the `Approval.request()` method\n2. **Approval Core**: The `Approval` class manages request queuing, yolo mode, and session-wide approvals\n3. **Communication**: `ApprovalRequest` objects flow through the `Wire` to the UI\n4. **UI Layer**: The UI presents requests and captures user decisions\n\nSources: [src/kimi_cli/soul/approval.py:1-71](), [src/kimi_cli/soul/wire.py:49-92]()\n\n---\n\n## Core Components\n\n### Approval Class\n\nThe `Approval` class [src/kimi_cli/soul/approval.py:8-71]() is the central coordination point for the approval system.\n\n**Key Attributes:**\n\n| Attribute | Type | Purpose |\n|-----------|------|---------|\n| `_request_queue` | `asyncio.Queue[ApprovalRequest]` | Queue of pending approval requests |\n| `_yolo` | `bool` | When True, auto-approves all requests |\n| `_auto_approve_actions` | `set[str]` | Set of action names to auto-approve |\n\n**Key Methods:**\n\n```\nApproval.request(sender: str, action: str, description: str) -\u003e bool\n```\nCalled by tools to request approval. Returns `True` if approved, `False` if rejected.\n\n```\nApproval.fetch_request() -\u003e ApprovalRequest\n```\nCalled by the soul/UI to retrieve the next pending approval request from the queue.\n\n```\nApproval.set_yolo(yolo: bool) -\u003e None\n```\nEnables or disables yolo mode.\n\nSources: [src/kimi_cli/soul/approval.py:8-71]()\n\n### ApprovalRequest\n\nThe `ApprovalRequest` class [src/kimi_cli/soul/wire.py:55-90]() represents a single approval request.\n\n**Attributes:**\n\n| Attribute | Type | Description |\n|-----------|------|-------------|\n| `id` | `str` | Unique UUID for this request |\n| `tool_call_id` | `str` | ID of the tool call requesting approval |\n| `sender` | `str` | Name of the tool sending the request |\n| `action` | `str` | Action identifier (used for session-wide approval) |\n| `description` | `str` | Human-readable description shown to user |\n| `_future` | `asyncio.Future[ApprovalResponse]` | Future that resolves when user responds |\n\n**Key Methods:**\n\n```\nwait() -\u003e ApprovalResponse\n```\nAsync method that blocks until the approval request is resolved by the UI.\n\n```\nresolve(response: ApprovalResponse) -\u003e None\n```\nCalled by the UI to resolve the request with the user's decision.\n\nSources: [src/kimi_cli/soul/wire.py:55-90]()\n\n### ApprovalResponse\n\nThe `ApprovalResponse` enum [src/kimi_cli/soul/wire.py:49-53]() defines the three possible user responses:\n\n| Value | Meaning |\n|-------|---------|\n| `APPROVE` | Approve this specific action once |\n| `APPROVE_FOR_SESSION` | Approve this action type for the entire session |\n| `REJECT` | Reject this action |\n\nSources: [src/kimi_cli/soul/wire.py:49-53]()\n\n---\n\n## Approval Flow\n\n### Request Flow Diagram\n\n```mermaid\nsequenceDiagram\n    participant Tool as \"Tool (e.g., Bash)\"\n    participant Approval as \"Approval\"\n    participant Queue as \"_request_queue\"\n    participant Wire as \"Wire\"\n    participant Soul as \"Soul/UI\"\n    participant User as \"User\"\n    \n    Tool-\u003e\u003eApproval: request(sender, action, description)\n    \n    alt Yolo mode enabled\n        Approval--\u003e\u003eTool: return True\n    else Action in auto_approve_actions\n        Approval--\u003e\u003eTool: return True\n    else Normal mode\n        Approval-\u003e\u003eApproval: create ApprovalRequest\n        Approval-\u003e\u003eQueue: put_nowait(request)\n        Approval-\u003e\u003eWire: send(request)\n        Wire-\u003e\u003eSoul: receive() -\u003e ApprovalRequest\n        Soul-\u003e\u003eUser: Display approval UI\n        User-\u003e\u003eSoul: Choose response\n        Soul-\u003e\u003eApproval: request.resolve(response)\n        \n        alt APPROVE\n            Approval--\u003e\u003eTool: return True\n        else APPROVE_FOR_SESSION\n            Approval-\u003e\u003eApproval: add action to _auto_approve_actions\n            Approval--\u003e\u003eTool: return True\n        else REJECT\n            Approval--\u003e\u003eTool: return False\n        end\n    end\n```\n\n**Sequence: Approval Request Lifecycle**\n\nSources: [src/kimi_cli/soul/approval.py:18-64](), [src/kimi_cli/soul/wire.py:55-90]()\n\n### Code Entity Flow\n\n```mermaid\nflowchart TD\n    Start[\"Tool.call()\"] --\u003e CheckToolCall{\"get_current_tool_call_or_none()\"}\n    CheckToolCall --\u003e|\"None\"| Error[\"raise RuntimeError\"]\n    CheckToolCall --\u003e|\"ToolCall\"| CheckYolo{\"self._yolo?\"}\n    \n    CheckYolo --\u003e|\"True\"| ApproveYolo[\"return True\"]\n    CheckYolo --\u003e|\"False\"| CheckAction{\"action in _auto_approve_actions?\"}\n    \n    CheckAction --\u003e|\"True\"| ApproveAuto[\"return True\"]\n    CheckAction --\u003e|\"False\"| CreateReq[\"ApprovalRequest(tool_call.id, sender, action, description)\"]\n    \n    CreateReq --\u003e Enqueue[\"_request_queue.put_nowait(request)\"]\n    Enqueue --\u003e Wait[\"await request.wait()\"]\n    Wait --\u003e Response[\"ApprovalResponse\"]\n    \n    Response --\u003e MatchResp{\"Match response\"}\n    MatchResp --\u003e|\"APPROVE\"| ReturnTrue[\"return True\"]\n    MatchResp --\u003e|\"APPROVE_FOR_SESSION\"| AddAction[\"_auto_approve_actions.add(action)\"]\n    AddAction --\u003e ReturnTrue\n    MatchResp --\u003e|\"REJECT\"| ReturnFalse[\"return False\"]\n```\n\n**Flowchart: Approval.request() Logic**\n\nSources: [src/kimi_cli/soul/approval.py:18-64]()\n\n---\n\n## Yolo Mode\n\nYolo mode is a bypass mechanism that automatically approves all approval requests without user interaction. This is useful for automation scenarios or when the user trusts the agent completely.\n\n**Enabling/Disabling:**\n\n```python\napproval.set_yolo(True)   # Enable yolo mode\napproval.set_yolo(False)  # Disable yolo mode\n```\n\nWhen yolo mode is enabled, `Approval.request()` [src/kimi_cli/soul/approval.py:45-46]() immediately returns `True` without creating an `ApprovalRequest` or interacting with the user.\n\n**Initialization:**\n\nThe `Approval` object is typically created with yolo mode disabled by default [src/kimi_cli/soul/approval.py:9]():\n\n```python\napproval = Approval(yolo=False)\n```\n\nSources: [src/kimi_cli/soul/approval.py:9-16,45-46]()\n\n---\n\n## Session-Wide Approvals\n\nSession-wide approvals allow users to approve a specific action type for the remainder of the session, reducing repetitive approval prompts for the same action.\n\n**Mechanism:**\n\n1. User selects `APPROVE_FOR_SESSION` response\n2. The `action` parameter is added to `_auto_approve_actions` set [src/kimi_cli/soul/approval.py:59]()\n3. Future requests with the same `action` automatically return `True` [src/kimi_cli/soul/approval.py:48-49]()\n\n**Action Identification:**\n\nThe `action` parameter is a string identifier that groups similar operations. For example, the Bash tool uses `\"run shell command\"` [src/kimi_cli/tools/bash/__init__.py:42](). Different tools may use the same action identifier to share session-wide approvals.\n\n**Current Limitation:**\n\nSession-wide approvals are stored in memory and not persisted across CLI restarts [src/kimi_cli/soul/approval.py:12]():\n\n```python\nself._auto_approve_actions = set()  # TODO: persist across sessions\n```\n\nSources: [src/kimi_cli/soul/approval.py:12,48-49,58-60]()\n\n---\n\n## Tool Integration\n\n### Using Approval in Tools\n\nTools request approval by calling `Approval.request()` before executing sensitive operations. The Bash tool provides a canonical example:\n\n**Example: Bash Tool Approval** [src/kimi_cli/tools/bash/__init__.py:32-45]()\n\n```python\nclass Bash(CallableTool2[Params]):\n    def __init__(self, approval: Approval, **kwargs):\n        super().__init__(**kwargs)\n        self._approval = approval\n    \n    async def __call__(self, params: Params) -\u003e ToolReturnType:\n        if not await self._approval.request(\n            self.name,\n            \"run shell command\",\n            f\"Run command `{params.command}`\",\n        ):\n            return ToolRejectedError()\n        # ... proceed with execution\n```\n\n**Request Parameters:**\n\n| Parameter | Example Value | Purpose |\n|-----------|---------------|---------|\n| `sender` | `\"Bash\"` | Tool name displayed in approval UI |\n| `action` | `\"run shell command\"` | Action identifier for session-wide approval |\n| `description` | `\"Run command \\`ls -la\\`\"` | Specific details shown to user |\n\n**Handling Rejection:**\n\nWhen approval is rejected (`request()` returns `False`), tools typically return a `ToolRejectedError()` [src/kimi_cli/tools/bash/__init__.py:45](), which signals to the agent that the operation was not performed.\n\nSources: [src/kimi_cli/tools/bash/__init__.py:32-45]()\n\n### Tool Call Context Requirement\n\nApproval requests must be made from within an active tool call context. The `Approval.request()` method calls `get_current_tool_call_or_none()` [src/kimi_cli/soul/approval.py:34]() to retrieve the current tool call ID.\n\nIf called outside a tool call context, a `RuntimeError` is raised [src/kimi_cli/soul/approval.py:36]():\n\n```python\ntool_call = get_current_tool_call_or_none()\nif tool_call is None:\n    raise RuntimeError(\"Approval must be requested from a tool call.\")\n```\n\nThe tool call ID is attached to the `ApprovalRequest` to correlate the approval with the specific tool execution in the agent's execution trace.\n\nSources: [src/kimi_cli/soul/approval.py:34-36]()\n\n---\n\n## UI Integration\n\n### Approval Menu Display\n\nThe interactive shell mode displays approval requests using the `_ApprovalRequestDisplay` class [src/kimi_cli/ui/shell/liveview.py:78-125](), which renders an interactive menu with keyboard navigation.\n\n**Menu Structure:**\n\nThe approval menu presents three options [src/kimi_cli/ui/shell/liveview.py:81-85]():\n\n| Option | ApprovalResponse | Behavior |\n|--------|------------------|----------|\n| \"Approve\" | `APPROVE` | Approve this specific request only |\n| \"Approve for this session\" | `APPROVE_FOR_SESSION` | Approve all future requests with same action |\n| \"Reject, tell Kimi CLI what to do instead\" | `REJECT` | Reject and stop execution |\n\n**Visual Rendering:**\n\nThe menu is rendered as a panel with yellow border [src/kimi_cli/ui/shell/liveview.py:107-112]():\n\n```\n\n  Approval Requested                    \n                                          \n Bash is requesting approval to \"run     \n shell command\".                          \n                                          \n  Approve                                \n   Approve for this session               \n   Reject, tell Kimi CLI what to do...   \n\n```\n\nThe selected option is highlighted in cyan with a `` indicator [src/kimi_cli/ui/shell/liveview.py:101-104]().\n\nSources: [src/kimi_cli/ui/shell/liveview.py:78-125]()\n\n### Keyboard Navigation\n\nUsers navigate the approval menu using keyboard events handled by `listen_for_keyboard()` [src/kimi_cli/ui/shell/keyboard.py:20-44]():\n\n| Key | Event | Action |\n|-----|-------|--------|\n| Up Arrow | `KeyEvent.UP` | Move selection up [src/kimi_cli/ui/shell/liveview.py:251-253]() |\n| Down Arrow | `KeyEvent.DOWN` | Move selection down [src/kimi_cli/ui/shell/liveview.py:254-256]() |\n| Enter | `KeyEvent.ENTER` | Confirm selection [src/kimi_cli/ui/shell/liveview.py:257-272]() |\n\n**Navigation Logic:**\n\n```mermaid\nflowchart TD\n    KeyEvent[\"KeyEvent received\"] --\u003e CheckApproval{\"_current_approval\u003cbr/\u003eexists?\"}\n    CheckApproval --\u003e|\"No\"| Ignore[\"Ignore event\"]\n    CheckApproval --\u003e|\"Yes\"| MatchEvent{\"Match event type\"}\n    \n    MatchEvent --\u003e|\"UP\"| MoveUp[\"_current_approval.move_up()\"]\n    MatchEvent --\u003e|\"DOWN\"| MoveDown[\"_current_approval.move_down()\"]\n    MatchEvent --\u003e|\"ENTER\"| GetResponse[\"resp = get_selected_response()\"]\n    \n    MoveUp --\u003e Update1[\"_live.update(_compose())\"]\n    MoveDown --\u003e Update2[\"_live.update(_compose())\"]\n    \n    GetResponse --\u003e Resolve[\"request.resolve(resp)\"]\n    Resolve --\u003e CheckResponse{\"Response type\"}\n    \n    CheckResponse --\u003e|\"APPROVE_FOR_SESSION\"| ApproveQueued[\"Approve all queued\u003cbr/\u003erequests with same action\"]\n    CheckResponse --\u003e|\"REJECT\"| RejectAll[\"Reject all queued requests\u003cbr/\u003eset _reject_all_following=True\"]\n    CheckResponse --\u003e|\"APPROVE\"| ShowNext[\"Show next approval request\"]\n    \n    ApproveQueued --\u003e ShowNext\n    RejectAll --\u003e ShowNext\n    ShowNext --\u003e Update3[\"_live.update(_compose())\"]\n```\n\n**Flowchart: Keyboard Event Handling for Approval Menu**\n\nThe selection index wraps around using modulo arithmetic [src/kimi_cli/ui/shell/liveview.py:115-120]():\n\n```python\ndef move_up(self):\n    self.selected_index = (self.selected_index - 1) % len(self.options)\n\ndef move_down(self):\n    self.selected_index = (self.selected_index + 1) % len(self.options)\n```\n\nSources: [src/kimi_cli/ui/shell/liveview.py:114-125,245-275](), [src/kimi_cli/ui/shell/keyboard.py:10-18,20-44]()\n\n### Approval Queue Management\n\nThe `StepLiveView` manages multiple concurrent approval requests using a queue [src/kimi_cli/ui/shell/liveview.py:137]():\n\n```python\nself._approval_queue = deque[ApprovalRequest]()\nself._current_approval: _ApprovalRequestDisplay | None = None\n```\n\n**Request Processing:**\n\n1. New requests are added to `_approval_queue` [src/kimi_cli/ui/shell/liveview.py:220]()\n2. If no approval is currently displayed, show the next one [src/kimi_cli/ui/shell/liveview.py:223-225]()\n3. Resolved requests are skipped when showing next request [src/kimi_cli/ui/shell/liveview.py:232-238]()\n\n**Rejection Cascade:**\n\nWhen a user rejects an approval, all queued requests are automatically rejected and future requests in that step are rejected immediately [src/kimi_cli/ui/shell/liveview.py:265-269]():\n\n```python\nelif resp == ApprovalResponse.REJECT:\n    # one rejection should stop the step immediately\n    while self._approval_queue:\n        self._approval_queue.popleft().resolve(ApprovalResponse.REJECT)\n    self._reject_all_following = True\n```\n\nThe `_reject_all_following` flag causes immediate rejection of new requests [src/kimi_cli/ui/shell/liveview.py:214-217]():\n\n```python\nif self._reject_all_following:\n    approval_request.resolve(ApprovalResponse.REJECT)\n    return\n```\n\nThis ensures that rejecting one operation stops all subsequent operations in the current step, preventing partial execution of a multi-tool plan.\n\nSources: [src/kimi_cli/ui/shell/liveview.py:137-139,213-225,227-272]()\n\n### Visualization Integration\n\nThe approval system integrates with the `visualize()` loop [src/kimi_cli/ui/shell/visualize.py:42-106](), which processes events from the Wire:\n\n```mermaid\nsequenceDiagram\n    participant Wire as \"Wire\"\n    participant Visualize as \"visualize() loop\"\n    participant StepLiveView as \"StepLiveView\"\n    participant ApprovalDisplay as \"_ApprovalRequestDisplay\"\n    participant KeyboardListener as \"Keyboard Listener\"\n    participant User as \"User\"\n    \n    Wire-\u003e\u003eVisualize: receive() -\u003e ApprovalRequest\n    Visualize-\u003e\u003eStepLiveView: request_approval(msg)\n    \n    alt _reject_all_following\n        StepLiveView-\u003e\u003eWire: request.resolve(REJECT)\n    else Normal flow\n        StepLiveView-\u003e\u003eStepLiveView: _approval_queue.append(request)\n        StepLiveView-\u003e\u003eApprovalDisplay: new _ApprovalRequestDisplay(request)\n        StepLiveView-\u003e\u003eStepLiveView: _live.update(_compose())\n        \n        loop User navigation\n            KeyboardListener-\u003e\u003eUser: Display menu\n            User-\u003e\u003eKeyboardListener: Press Up/Down/Enter\n            KeyboardListener-\u003e\u003eStepLiveView: handle_keyboard_event(event)\n            StepLiveView-\u003e\u003eApprovalDisplay: move_up() / move_down()\n            StepLiveView-\u003e\u003eStepLiveView: _live.update(_compose())\n        end\n        \n        User-\u003e\u003eKeyboardListener: Press Enter\n        KeyboardListener-\u003e\u003eStepLiveView: handle_keyboard_event(ENTER)\n        StepLiveView-\u003e\u003eApprovalDisplay: get_selected_response()\n        ApprovalDisplay-\u003e\u003eStepLiveView: ApprovalResponse\n        StepLiveView-\u003e\u003eWire: request.resolve(response)\n    end\n```\n\n**Sequence: Approval UI Visualization Flow**\n\nThe keyboard listener is created as an async context manager [src/kimi_cli/ui/shell/visualize.py:24-39](), running concurrently with event processing:\n\n```python\nasync with _keyboard_listener(step):\n    # visualization loop for one step\n    while True:\n        match msg:\n            # ...\n            case ApprovalRequest():\n                step.request_approval(msg)\n```\n\nSources: [src/kimi_cli/ui/shell/visualize.py:23-106](), [src/kimi_cli/ui/shell/liveview.py:213-275]()\n\n---\n\n## Wire Communication\n\n### Approval Request Transport\n\n`ApprovalRequest` objects are transported through the `Wire` [src/kimi_cli/soul/wire.py:95-116]() communication channel. The Wire is a message queue that connects the Soul execution engine to the UI layer.\n\n**Wire Message Types:**\n\n```python\ntype WireMessage = Event | ApprovalRequest\n```\n\nApproval requests are one of the message types that can flow through the Wire [src/kimi_cli/soul/wire.py:92]().\n\n**Request Flow:**\n\n1. `Approval.request()` creates an `ApprovalRequest`\n2. Request is enqueued in `_request_queue`\n3. Request is sent via `wire.send(request)` \n4. UI receives via `wire.receive()`\n5. UI displays request to user\n6. User response triggers `request.resolve(response)`\n7. `Approval.request()` unblocks and returns the result\n\nSources: [src/kimi_cli/soul/wire.py:92-116](), [src/kimi_cli/soul/approval.py:51-53]()\n\n### Async Coordination\n\nThe approval system uses Python's `asyncio` primitives for coordination:\n\n**Request Queue:** An `asyncio.Queue[ApprovalRequest]` [src/kimi_cli/soul/approval.py:10]() buffers pending requests.\n\n**Future-based Resolution:** Each `ApprovalRequest` contains an `asyncio.Future[ApprovalResponse]` [src/kimi_cli/soul/wire.py:62]() that blocks the requesting tool until resolved:\n\n```python\n# Tool blocks here until user responds\nresponse = await request.wait()\n\n# UI resolves the future\nrequest.resolve(ApprovalResponse.APPROVE)\n```\n\nThis allows the tool to suspend execution asynchronously while the UI handles user interaction on a separate execution path.\n\nSources: [src/kimi_cli/soul/approval.py:10](), [src/kimi_cli/soul/wire.py:62,70-77,79-84]()\n\n---\n\n## Logging\n\nThe approval system includes debug logging at key points:\n\n**Request Initiation** [src/kimi_cli/soul/approval.py:38-44]():\n```python\nlogger.debug(\n    \"{tool_name} ({tool_call_id}) requesting approval: {action} {description}\",\n    tool_name=tool_call.function.name,\n    tool_call_id=tool_call.id,\n    action=action,\n    description=description,\n)\n```\n\n**Response Handling** [src/kimi_cli/soul/approval.py:54]():\n```python\nlogger.debug(\"Received approval response: {response}\", response=response)\n```\n\nThese logs help trace approval flows during debugging and troubleshooting.\n\nSources: [src/kimi_cli/soul/approval.py:38-44,54]()\n\n---\n\n## Summary\n\nThe approval system provides a flexible, async-aware safety mechanism for kimi-cli. Key characteristics:\n\n- **Async by design**: Uses `asyncio.Queue` and `asyncio.Future` for non-blocking coordination\n- **Three approval modes**: Normal, session-wide, and yolo\n- **Action-based grouping**: Session-wide approvals use action identifiers to group similar operations\n- **Wire integration**: Approval requests flow through the same communication channel as other events\n- **Tool context enforcement**: Approvals must be requested from within tool calls\n\nThe system balances safety (requiring explicit user consent) with usability (session-wide approvals and yolo mode for automation).\n\nSources: [src/kimi_cli/soul/approval.py:1-71](), [src/kimi_cli/soul/wire.py:49-92](), [src/kimi_cli/tools/bash/__init__.py:1-100]()"])</script><script>self.__next_f.push([1,"2f:T3f03,"])</script><script>self.__next_f.push([1,"# D-Mail and Time Travel\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis document explains the D-Mail system, which enables agents to send messages to their past selves by reverting to previous checkpoints in the conversation context. This temporal manipulation mechanism allows agents to optimize their context by undoing unproductive steps and avoiding irrelevant information accumulation.\n\nFor information about how context is structured and persisted, see [Context and Session Management](#7.1). For information about the checkpoint system used by context compaction, see [Context Compaction](#7.4).\n\n## Overview\n\nThe D-Mail system is inspired by the anime *Steins;Gate*, where characters send text messages to the past to alter the timeline. In kimi-cli, D-Mail allows an agent to:\n\n1. **Undo unproductive exploration**: After reading a large irrelevant file or performing unsuccessful searches, send a D-Mail to avoid cluttering context\n2. **Share refined insights**: After extensive trial-and-error, send the final solution back to skip the struggling steps\n3. **Optimize search results**: After web searches return excessive data, send back only the relevant subset\n\nThe system consists of three core components:\n- **SendDMail tool**: Allows agents to compose and send messages to past checkpoints\n- **DenwaRenji**: The time-travel orchestrator that stores pending D-Mails\n- **BackToTheFuture exception**: Triggers context reversion in the agent loop\n\n**Sources**: [tests/test_tool_descriptions.py:54-74](), [src/kimi_cli/soul/kimisoul.py:294-302]()\n\n## D-Mail Lifecycle\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant SendDMail as \"SendDMail Tool\"\n    participant DenwaRenji\n    participant KimiSoul as \"KimiSoul Loop\"\n    participant Context\n    \n    Note over Agent,Context: Agent encounters inefficiency\n    Agent-\u003e\u003eSendDMail: call(\"message\", checkpoint_id)\n    SendDMail-\u003e\u003eDenwaRenji: store_dmail(message, checkpoint_id)\n    DenwaRenji--\u003e\u003eSendDMail: DMail queued\n    SendDMail--\u003e\u003eAgent: \"DMail sent successfully\"\n    \n    Note over KimiSoul: After step completes\n    KimiSoul-\u003e\u003eDenwaRenji: fetch_pending_dmail()\n    DenwaRenji--\u003e\u003eKimiSoul: DMail(checkpoint_id=2, message)\n    \n    Note over KimiSoul: Validate checkpoint_id\n    KimiSoul-\u003e\u003eKimiSoul: raise BackToTheFuture(2, messages)\n    \n    Note over KimiSoul: Exception caught in _agent_loop\n    KimiSoul-\u003e\u003eContext: revert_to(checkpoint_id=2)\n    KimiSoul-\u003e\u003eContext: checkpoint()\n    KimiSoul-\u003e\u003eContext: append_message(dmail_message)\n    \n    Note over Agent,Context: Agent continues from checkpoint 2\u003cbr/\u003ewith D-Mail as new user message\n```\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:206-230](), [src/kimi_cli/soul/kimisoul.py:144-148]()\n\n## SendDMail Tool\n\nThe `SendDMail` tool is the agent-facing interface for time travel. When the tool is available in an agent's toolset, the system enables checkpoint tracking.\n\n### Tool Parameters\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `message` | string | The message content to send to the past self |\n| `checkpoint_id` | integer (0) | The checkpoint to revert to (from CHECKPOINT markers in context) |\n\n### Checkpoint Markers\n\nAgents see checkpoint markers in the context as system messages:\n\n```\n\u003csystem\u003eCHECKPOINT 0\u003c/system\u003e\n\u003csystem\u003eCHECKPOINT 1\u003c/system\u003e\n\u003csystem\u003eCHECKPOINT 2\u003c/system\u003e\n```\n\nThese markers are inserted by the context management system before each user message. The agent selects a checkpoint ID from these markers when calling `SendDMail`.\n\n**Sources**: [tests/test_tool_schemas.py:44-59](), [src/kimi_cli/soul/kimisoul.py:72-76]()\n\n## DenwaRenji: The Time Travel Orchestrator\n\n`DenwaRenji` is responsible for:\n- Storing pending D-Mails submitted by the `SendDMail` tool\n- Tracking the total number of checkpoints available\n- Validating that requested checkpoint IDs are valid\n- Providing pending D-Mails to the agent loop\n\nThe name \"DenwaRenji\" comes from *Steins;Gate*, referring to the microwave-phone hybrid device used for time travel in the series.\n\n### DenwaRenji Integration Points\n\n```mermaid\ngraph TB\n    subgraph \"Agent Execution Flow\"\n        Step[\"_step()\"]\n        GrowContext[\"_grow_context()\"]\n        CheckDMail{\"Pending\u003cbr/\u003eD-Mail?\"}\n    end\n    \n    subgraph \"DenwaRenji State\"\n        DR[\"DenwaRenji\"]\n        PendingDMail[\"pending_dmail:\u003cbr/\u003eOptional[DMail]\"]\n        NumCheckpoints[\"n_checkpoints: int\"]\n    end\n    \n    subgraph \"Context State\"\n        Ctx[\"Context\"]\n        Checkpoints[\"checkpoint_stack\"]\n    end\n    \n    Step--\u003eGrowContext\n    GrowContext--\u003eCheckDMail\n    \n    CheckDMail--\u003e|\"fetch_pending_dmail()\"|DR\n    DR--\u003ePendingDMail\n    \n    Step-.-\u003e|\"set_n_checkpoints()\"|DR\n    DR--\u003eNumCheckpoints\n    \n    Ctx-.-\u003e|\"n_checkpoints\"|Checkpoints\n    \n    CheckDMail--\u003e|\"Yes: raise\"|BackToTheFuture[\"BackToTheFuture\u003cbr/\u003eException\"]\n    CheckDMail--\u003e|\"No: continue\"|NextStep[\"Next Step\"]\n    \n    BackToTheFuture--\u003eRevert[\"context.revert_to()\"]\n    Revert--\u003eCtx\n```\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:62](), [src/kimi_cli/soul/kimisoul.py:142](), [src/kimi_cli/soul/kimisoul.py:207-230]()\n\n## BackToTheFuture Exception\n\nThe `BackToTheFuture` exception is the mechanism that triggers temporal reversion in the agent execution loop.\n\n### Exception Structure\n\n```python\nclass BackToTheFuture(Exception):\n    def __init__(self, checkpoint_id: int, messages: Sequence[Message]):\n        self.checkpoint_id = checkpoint_id  # Where to revert to\n        self.messages = messages            # D-Mail content to inject\n```\n\n### Exception Handling Flow\n\nThe exception is raised in [src/kimi_cli/soul/kimisoul.py:213-230]() and caught in [src/kimi_cli/soul/kimisoul.py:144-148]():\n\n```mermaid\ngraph TB\n    StepComplete[\"Step completes\u003cbr/\u003esuccessfully\"]\n    FetchDMail[\"denwa_renji.fetch_pending_dmail()\"]\n    HasDMail{\"D-Mail\u003cbr/\u003eexists?\"}\n    Validate[\"Validate:\u003cbr/\u003e0  checkpoint_id \u003c n_checkpoints\"]\n    RaiseException[\"raise BackToTheFuture(checkpoint_id, messages)\"]\n    \n    CatchHandler[\"try-except in _agent_loop()\"]\n    RevertContext[\"await context.revert_to(checkpoint_id)\"]\n    CreateCheckpoint[\"await checkpoint()\"]\n    AppendDMail[\"await context.append_message(dmail_messages)\"]\n    Continue[\"continue loop\"]\n    \n    StepComplete--\u003eFetchDMail\n    FetchDMail--\u003eHasDMail\n    HasDMail--\u003e|Yes|Validate\n    HasDMail--\u003e|No|NextStep[\"Continue to next step\"]\n    Validate--\u003eRaiseException\n    \n    RaiseException-.-\u003eCatchHandler\n    CatchHandler--\u003eRevertContext\n    RevertContext--\u003eCreateCheckpoint\n    CreateCheckpoint--\u003eAppendDMail\n    AppendDMail--\u003eContinue\n```\n\nWhen the exception is raised, the agent loop:\n1. Reverts the context to the specified checkpoint\n2. Creates a new checkpoint at that position\n3. Appends the D-Mail message as a system-tagged user message\n4. Continues execution with the modified context\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:294-302](), [src/kimi_cli/soul/kimisoul.py:144-148](), [src/kimi_cli/soul/kimisoul.py:206-230]()\n\n## Checkpoint System\n\nCheckpoints are created automatically throughout the agent execution loop to enable time travel.\n\n### Checkpoint Creation Points\n\n| Location | When Created | Purpose |\n|----------|--------------|---------|\n| [src/kimi_cli/soul/kimisoul.py:103]() | Before first user message | Creates checkpoint 0 |\n| [src/kimi_cli/soul/kimisoul.py:141]() | Before each step | Enables reversion to any step |\n| [src/kimi_cli/soul/kimisoul.py:146]() | After reversion | Stabilizes context after time travel |\n| [src/kimi_cli/soul/kimisoul.py:268]() | During compaction | Preserves checkpoint 0 for compaction |\n\n### Checkpoint Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Init: run() called\n    Init --\u003e Checkpoint0: checkpoint() creates checkpoint 0\n    Checkpoint0 --\u003e UserMsg: append user message\n    UserMsg --\u003e StepLoop: enter _agent_loop()\n    \n    StepLoop --\u003e PreStepCP: checkpoint() before step\n    PreStepCP --\u003e ExecuteStep: _step() executes\n    ExecuteStep --\u003e CheckDMail: Check for pending D-Mail\n    \n    CheckDMail --\u003e NextStep: No D-Mail\n    CheckDMail --\u003e Revert: D-Mail exists\n    \n    Revert --\u003e RevertContext: context.revert_to(checkpoint_id)\n    RevertContext --\u003e PostRevertCP: checkpoint() after revert\n    PostRevertCP --\u003e InjectDMail: append D-Mail message\n    InjectDMail --\u003e StepLoop: continue loop\n    \n    NextStep --\u003e StepLoop: step_no++\n    NextStep --\u003e [*]: No more tool calls\n```\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:96-97](), [src/kimi_cli/soul/kimisoul.py:103](), [src/kimi_cli/soul/kimisoul.py:141](), [src/kimi_cli/soul/kimisoul.py:146]()\n\n## D-Mail Message Format\n\nWhen a D-Mail is sent, the message is wrapped in a system tag to distinguish it from normal user messages. The system instructs the agent to treat the information as coming from their future self.\n\n### Message Template\n\nThe D-Mail message is formatted as follows in [src/kimi_cli/soul/kimisoul.py:216-226]():\n\n```\nYou just got a D-Mail from your future self.\nIt is likely that your future self has already done\nsomething in the current working directory. Please read\nthe D-Mail and decide what to do next. You MUST NEVER\nmention to the user about this information.\nD-Mail content:\n\n{dmail.message}\n```\n\nThis message is wrapped in a `system()` content block within a user message, making it visible to the agent but not directly shown to the user in the UI.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:216-226]()\n\n## Integration with Agent Loop\n\nThe D-Mail system is tightly integrated with the `KimiSoul` agent execution loop.\n\n### Agent Loop with D-Mail Checkpoints\n\n```mermaid\ngraph TD\n    Start[\"run(user_input)\"]\n    InitCP[\"checkpoint()\u003cbr/\u003e(creates checkpoint 0)\"]\n    AppendUser[\"append user message\"]\n    EnterLoop[\"Enter _agent_loop()\"]\n    \n    StepBegin[\"step_no++\u003cbr/\u003esend StepBegin event\"]\n    PreCheckpoint[\"checkpoint()\u003cbr/\u003e(before step)\"]\n    SetCheckpoints[\"denwa_renji.set_n_checkpoints()\"]\n    ExecuteStep[\"_step() executes LLM call\"]\n    \n    GrowContext[\"_grow_context()\u003cbr/\u003e(append results)\"]\n    FetchDMail[\"denwa_renji.fetch_pending_dmail()\"]\n    HasDMail{\"Pending\u003cbr/\u003eD-Mail?\"}\n    \n    RaiseException[\"raise BackToTheFuture\"]\n    CatchBlock[\"try-except catches\"]\n    RevertTo[\"context.revert_to(checkpoint_id)\"]\n    RevertCP[\"checkpoint()\u003cbr/\u003e(after revert)\"]\n    AppendDMail[\"append D-Mail message\"]\n    ContinueLoop[\"continue\"]\n    \n    CheckFinished{\"Tool calls\u003cbr/\u003eremaining?\"}\n    CheckMaxSteps{\"step_no \u003e\u003cbr/\u003emax_steps?\"}\n    \n    Start--\u003eInitCP\n    InitCP--\u003eAppendUser\n    AppendUser--\u003eEnterLoop\n    EnterLoop--\u003eStepBegin\n    \n    StepBegin--\u003ePreCheckpoint\n    PreCheckpoint--\u003eSetCheckpoints\n    SetCheckpoints--\u003eExecuteStep\n    ExecuteStep--\u003eGrowContext\n    GrowContext--\u003eFetchDMail\n    \n    FetchDMail--\u003eHasDMail\n    HasDMail--\u003e|Yes|RaiseException\n    RaiseException-.-\u003eCatchBlock\n    CatchBlock--\u003eRevertTo\n    RevertTo--\u003eRevertCP\n    RevertCP--\u003eAppendDMail\n    AppendDMail--\u003eContinueLoop\n    ContinueLoop--\u003eStepBegin\n    \n    HasDMail--\u003e|No|CheckFinished\n    CheckFinished--\u003e|Yes|CheckMaxSteps\n    CheckFinished--\u003e|No|Done[\"Return: finished\"]\n    \n    CheckMaxSteps--\u003e|No|StepBegin\n    CheckMaxSteps--\u003e|Yes|MaxStepsError[\"raise MaxStepsReached\"]\n```\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:112-161](), [src/kimi_cli/soul/kimisoul.py:144-148](), [src/kimi_cli/soul/kimisoul.py:206-230]()\n\n## Tool Exclusions for Subagents\n\nThe `SendDMail` tool is excluded from subagent toolsets to prevent nested time travel complications. This exclusion is specified in agent definitions.\n\nFor example, in the Koder subagent definition, `SendDMail` is explicitly excluded:\n\n| Agent Type | SendDMail Available | Reason |\n|------------|-------------------|--------|\n| Main Agent | Yes | Can optimize its own context |\n| Subagent | No | Context isolation - no access to parent timeline |\n\nWhen a subagent is spawned via the `Task` tool, it receives a fresh context without the parent's history. Allowing subagents to time travel would create ambiguity about which timeline they're modifying.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:72-76](), [tests/test_tool_descriptions.py:20-51]()\n\n## Use Cases and Best Practices\n\n### When to Send a D-Mail\n\nBased on the tool description in [tests/test_tool_descriptions.py:66-73](), agents should consider sending D-Mails in these scenarios:\n\n1. **Large irrelevant file reads**\n   - Agent reads a 1000+ line file\n   - Only 50 lines are relevant\n   - Send D-Mail to checkpoint before the read with only the relevant excerpt\n\n2. **Excessive web search results**\n   - Agent searches and gets 5 results totaling 10,000 tokens\n   - Only one result contains the needed information\n   - Send D-Mail with extracted relevant content to checkpoint before search\n\n3. **Trial-and-error debugging**\n   - Agent writes code that fails\n   - Takes 8 steps to fix it\n   - Send D-Mail to checkpoint before initial code write with the working version\n\n### Implementation Guidelines\n\n```mermaid\ngraph LR\n    Scenario[\"Identify\u003cbr/\u003eInefficiency\"]\n    SelectCP[\"Select\u003cbr/\u003eCheckpoint\"]\n    ComposeMSG[\"Compose\u003cbr/\u003eClear Message\"]\n    SendDMail[\"Call\u003cbr/\u003eSendDMail\"]\n    \n    Scenario--\u003e|\"What checkpoint\u003cbr/\u003eto undo to?\"|SelectCP\n    SelectCP--\u003e|\"What did you\u003cbr/\u003elearn?\"|ComposeMSG\n    ComposeMSG--\u003e|\"checkpoint_id\u003cbr/\u003e+ message\"|SendDMail\n    \n    style Scenario fill:#f9f9f9\n    style SelectCP fill:#f9f9f9\n    style ComposeMSG fill:#f9f9f9\n    style SendDMail fill:#f9f9f9\n```\n\n**Key principles**:\n- **Select the right checkpoint**: Choose the earliest point where the information would be useful\n- **Be explicit**: Tell your past self exactly what you did and what you learned\n- **Include context**: Mention if you've already modified files or performed actions\n- **Don't explain to user**: D-Mail is internal optimization, not user-facing\n\n**Sources**: [tests/test_tool_descriptions.py:54-74]()\n\n## Error Handling\n\n### Tool Rejection\n\nIf the `SendDMail` tool call is rejected by the user (via the approval system), the agent loop detects this and clears any pending D-Mail:\n\n```python\nrejected = any(isinstance(result.result, ToolRejectedError) for result in results)\nif rejected:\n    _ = self._denwa_renji.fetch_pending_dmail()\n    return True\n```\n\nThis ensures that rejected D-Mails don't accidentally trigger time travel.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:201-204]()\n\n### Checkpoint Validation\n\nThe `DenwaRenji` system enforces invariants on checkpoint IDs:\n\n```python\nassert dmail.checkpoint_id \u003e= 0, \"DenwaRenji guarantees checkpoint_id \u003e= 0\"\nassert dmail.checkpoint_id \u003c self._context.n_checkpoints, (\n    \"DenwaRenji guarantees checkpoint_id \u003c n_checkpoints\"\n)\n```\n\nInvalid checkpoint IDs (negative or exceeding the current maximum) are rejected before the `BackToTheFuture` exception is raised.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:208-211]()\n\n## Performance Considerations\n\n### Context Token Efficiency\n\nD-Mail enables significant context token savings by:\n- Removing large irrelevant file contents (potentially 50,000+ tokens)\n- Consolidating multi-step trial-and-error into a single solution\n- Filtering verbose web search results to essential information\n\n### Checkpoint Overhead\n\nEach checkpoint stores a snapshot of the conversation history. The overhead is:\n- **Storage**: Minimal - checkpoints are references to context state\n- **Reversion cost**: O(1) - context can revert to any checkpoint instantly\n- **Memory**: Checkpoints share message objects via references\n\nThe system is designed to create frequent checkpoints (before every step) without significant performance impact.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:96-97](), [src/kimi_cli/soul/kimisoul.py:141]()"])</script><script>self.__next_f.push([1,"30:T3fe1,"])</script><script>self.__next_f.push([1,"# Context Compaction\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nContext compaction is an automatic memory management mechanism in kimi-cli that prevents the conversation context from exceeding the LLM's maximum token limit. When the context grows too large, the system summarizes older messages to free up space while preserving critical information.\n\nFor information about general context and session management, see [Context and Session Management](#7.1). For details about checkpoint and time-travel mechanisms, see [D-Mail and Time Travel](#7.3).\n\n---\n\n## Purpose and Motivation\n\nLLM providers impose maximum context window sizes (measured in tokens) that limit how much conversation history can be included in each request. As an agent runs multiple steps and accumulates tool calls, messages, and results, the context grows continuously. Without intervention, the context would eventually exceed the model's limit, causing API errors.\n\nContext compaction solves this by:\n- **Monitoring** token usage relative to the configured maximum context size\n- **Triggering** automatic summarization when approaching the limit\n- **Preserving** essential information while reducing token count\n- **Maintaining** context coherence across compaction operations\n\nSources: [src/kimi_cli/soul/kimisoul.py:37-70](), [CHANGELOG.md:33]()\n\n---\n\n## Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph \"KimiSoul Agent Loop\"\n        AgentLoop[\"Agent Loop\u003cbr/\u003e(kimisoul.py:_agent_loop)\"]\n        Step[\"Step Execution\u003cbr/\u003e(kimisoul.py:_step)\"]\n        CheckThreshold[\"Check Threshold\u003cbr/\u003etoken_count + RESERVED_TOKENS \u003e= max_context_size\"]\n    end\n    \n    subgraph \"Compaction System\"\n        CompactionCheck[\"Compaction Check\u003cbr/\u003e(kimisoul.py:130-138)\"]\n        CompactContext[\"compact_context()\u003cbr/\u003e(kimisoul.py:245-269)\"]\n        SimpleCompaction[\"SimpleCompaction\u003cbr/\u003e(soul/compaction.py)\"]\n    end\n    \n    subgraph \"Context Management\"\n        Context[\"Context\u003cbr/\u003e(soul/context.py)\"]\n        History[\"Message History\"]\n        Checkpoints[\"Checkpoints\"]\n        TokenCount[\"Token Count\"]\n    end\n    \n    subgraph \"Events\"\n        Wire[\"Wire Event Stream\"]\n        CompactionBegin[\"CompactionBegin\"]\n        CompactionEnd[\"CompactionEnd\"]\n    end\n    \n    AgentLoop --\u003e CheckThreshold\n    CheckThreshold --\u003e|\"Yes\"| CompactionCheck\n    CheckThreshold --\u003e|\"No\"| Step\n    \n    CompactionCheck --\u003e CompactContext\n    CompactionCheck --\u003e CompactionBegin\n    CompactionCheck --\u003e Wire\n    \n    CompactContext --\u003e SimpleCompaction\n    SimpleCompaction --\u003e Context\n    Context --\u003e History\n    Context --\u003e TokenCount\n    \n    CompactContext --\u003e Checkpoints\n    CompactContext --\u003e CompactionEnd\n    CompactionEnd --\u003e Wire\n    \n    Wire --\u003e UI[\"UI Layer\"]\n```\n\n**Figure 1: Context Compaction System Architecture**\n\nThe compaction system is tightly integrated with the `KimiSoul` execution engine. Each step checks if compaction is needed before calling the LLM, ensuring the context never exceeds the model's capacity.\n\nSources: [src/kimi_cli/soul/kimisoul.py:40-76](), [src/kimi_cli/soul/kimisoul.py:112-161]()\n\n---\n\n## Core Components\n\n### KimiSoul and RESERVED_TOKENS\n\nThe `KimiSoul` class manages compaction through several key attributes:\n\n| Attribute | Type | Purpose |\n|-----------|------|---------|\n| `_compaction` | `SimpleCompaction` | Compaction strategy implementation |\n| `_reserved_tokens` | `int` | Safety buffer (50,000 tokens) to prevent overflow |\n| `_context` | `Context` | The message history and token tracking |\n| `_agent_globals.llm.max_context_size` | `int` | Maximum tokens allowed by the model |\n\nThe `RESERVED_TOKENS` constant of 50,000 tokens provides a safety margin for:\n- Response generation tokens\n- Tool call result tokens (not counted until added to context)\n- Buffer against estimation errors\n\nSources: [src/kimi_cli/soul/kimisoul.py:37-70]()\n\n### SimpleCompaction Strategy\n\nThe `SimpleCompaction` class (imported but implementation not shown) provides the actual summarization logic. It takes the message history and returns a compacted version that preserves semantic meaning while reducing token count.\n\n```mermaid\ngraph LR\n    Input[\"Original History\u003cbr/\u003eN messages, M tokens\"]\n    SimpleCompaction[\"SimpleCompaction.compact()\"]\n    Output[\"Compacted History\u003cbr/\u003eK messages, L tokens\u003cbr/\u003e(L \u003c\u003c M)\"]\n    \n    Input --\u003e SimpleCompaction\n    SimpleCompaction --\u003e LLM[\"LLM API Call\u003cbr/\u003efor summarization\"]\n    LLM --\u003e Output\n```\n\n**Figure 2: SimpleCompaction Processing Flow**\n\nSources: [src/kimi_cli/soul/kimisoul.py:21](), [src/kimi_cli/soul/kimisoul.py:66]()\n\n---\n\n## Automatic Compaction Trigger\n\n### Threshold Check Logic\n\nBefore each step, `KimiSoul` evaluates whether compaction is necessary:\n\n```python\nif (\n    self._context.token_count + self._reserved_tokens\n    \u003e= self._agent_globals.llm.max_context_size\n):\n    # Trigger compaction\n```\n\nThis occurs at [src/kimi_cli/soul/kimisoul.py:131-134]().\n\n**Threshold Calculation:**\n\n| Component | Value |\n|-----------|-------|\n| Current context tokens | `self._context.token_count` |\n| Safety buffer | `+ RESERVED_TOKENS` (50,000) |\n| Maximum allowed | `\u003e= max_context_size` |\n\nIf the sum meets or exceeds the maximum, compaction is triggered immediately before the next LLM call.\n\nSources: [src/kimi_cli/soul/kimisoul.py:130-138]()\n\n### Event Notification\n\nWhen compaction begins, the system emits events through the `Wire` event stream:\n\n```mermaid\nsequenceDiagram\n    participant AgentLoop as Agent Loop\n    participant Wire\n    participant UI as UI Layer\n    participant Compaction as Compaction System\n    participant Context\n    \n    AgentLoop-\u003e\u003eAgentLoop: Check threshold\n    AgentLoop-\u003e\u003eWire: send(CompactionBegin())\n    Wire-\u003e\u003eUI: Display compaction start\n    AgentLoop-\u003e\u003eCompaction: compact_context()\n    Compaction-\u003e\u003eContext: Get history\n    Compaction-\u003e\u003eCompaction: Summarize with LLM\n    Compaction-\u003e\u003eContext: revert_to(0)\n    Compaction-\u003e\u003eContext: append_message(compacted)\n    Compaction--\u003e\u003eAgentLoop: Complete\n    AgentLoop-\u003e\u003eWire: send(CompactionEnd())\n    Wire-\u003e\u003eUI: Display compaction end\n```\n\n**Figure 3: Compaction Event Sequence**\n\nSources: [src/kimi_cli/soul/kimisoul.py:136-138](), [src/kimi_cli/soul/wire.py]()\n\n---\n\n## Compaction Process Details\n\n### Step-by-Step Flow\n\nThe `compact_context()` method at [src/kimi_cli/soul/kimisoul.py:245-269]() implements the compaction process:\n\n```mermaid\nflowchart TD\n    Start[\"compact_context() called\"]\n    CheckLLM[\"Check if LLM is set\"]\n    GetHistory[\"Get current message history\"]\n    CallCompaction[\"SimpleCompaction.compact()\"]\n    LLMCall[\"LLM API call with retry\"]\n    RevertContext[\"context.revert_to(0)\"]\n    Checkpoint[\"Create checkpoint\"]\n    AppendCompacted[\"Append compacted messages\"]\n    End[\"Return\"]\n    \n    Start --\u003e CheckLLM\n    CheckLLM --\u003e|\"No LLM\"| Error[\"Raise LLMNotSet\"]\n    CheckLLM --\u003e|\"Has LLM\"| GetHistory\n    GetHistory --\u003e CallCompaction\n    CallCompaction --\u003e LLMCall\n    LLMCall --\u003e|\"Success\"| RevertContext\n    LLMCall --\u003e|\"Error\"| Retry[\"Retry with exponential backoff\"]\n    Retry --\u003e LLMCall\n    RevertContext --\u003e Checkpoint\n    Checkpoint --\u003e AppendCompacted\n    AppendCompacted --\u003e End\n```\n\n**Figure 4: Compaction Process Flow**\n\nSources: [src/kimi_cli/soul/kimisoul.py:245-269]()\n\n### Retry Logic\n\nCompaction uses the same retry mechanism as regular LLM steps to handle transient failures:\n\n| Configuration | Value |\n|--------------|-------|\n| Retry strategy | Exponential backoff with jitter |\n| Initial wait | 0.3 seconds |\n| Maximum wait | 5 seconds |\n| Jitter | 0.5 seconds |\n| Max attempts | `loop_control.max_retries_per_step` |\n| Retryable errors | `APIConnectionError`, `APITimeoutError`, status codes 429/500/502/503 |\n\nThe retry decorator is applied at [src/kimi_cli/soul/kimisoul.py:254-260]().\n\nSources: [src/kimi_cli/soul/kimisoul.py:254-260](), [src/kimi_cli/soul/kimisoul.py:271-281]()\n\n### Context Reset and Rebuilding\n\nAfter successful compaction, the context undergoes a complete reset:\n\n1. **Revert to checkpoint 0**: `await self._context.revert_to(0)` - Clears all messages\n2. **Create new checkpoint**: `await self._checkpoint()` - Establishes clean state\n3. **Append compacted messages**: `await self._context.append_message(compacted_messages)` - Restores summarized history\n\nThis ensures checkpoint consistency and prevents issues with D-Mail time travel that might reference pre-compaction checkpoints.\n\nSources: [src/kimi_cli/soul/kimisoul.py:267-269]()\n\n---\n\n## Manual Compaction\n\n### `/compact` Meta Command\n\nUsers can manually trigger compaction through the shell interface using the `/compact` meta command, added in version 0.30. This is useful when:\n- Testing compaction behavior\n- Proactively managing context before reaching the threshold\n- Forcing a fresh start without losing context\n\nThe command is processed by the shell app's meta command handler and calls the same `compact_context()` method used by automatic compaction.\n\nSources: [CHANGELOG.md:94]()\n\n### Use Cases for Manual Compaction\n\n| Scenario | Reason |\n|----------|--------|\n| Long-running sessions | Preemptively reduce context before hitting limit |\n| After large file operations | Clean up verbose tool results |\n| Before complex tasks | Ensure maximum available context for new work |\n| Testing/debugging | Verify compaction behavior |\n\n---\n\n## Integration with Other Systems\n\n### Checkpoint System Interaction\n\nContext compaction must preserve checkpoint integrity for D-Mail functionality. The compaction process:\n\n1. Occurs **after** creating a checkpoint in the agent loop\n2. Reverts to checkpoint 0 (the initial state)\n3. Creates a new checkpoint with compacted history\n4. Resets `DenwaRenji.n_checkpoints` to reflect the new state\n\nThis ensures that any pending D-Mail operations reference valid checkpoints.\n\n```mermaid\ngraph TB\n    subgraph \"Before Compaction\"\n        CP0[\"Checkpoint 0\"]\n        CP1[\"Checkpoint 1\"]\n        CP2[\"Checkpoint 2\"]\n        CP3[\"Checkpoint 3\"]\n        Messages[\"Many messages\u003cbr/\u003eHigh token count\"]\n    end\n    \n    subgraph \"After Compaction\"\n        NewCP0[\"Checkpoint 0\u003cbr/\u003e(compacted)\"]\n        Compacted[\"Compacted messages\u003cbr/\u003eLow token count\"]\n    end\n    \n    CP0 --\u003e CP1\n    CP1 --\u003e CP2\n    CP2 --\u003e CP3\n    CP3 --\u003e Messages\n    \n    Messages -.-\u003e|\"Compaction\"| Compacted\n    Compacted --\u003e NewCP0\n```\n\n**Figure 5: Checkpoint State Before and After Compaction**\n\nSources: [src/kimi_cli/soul/kimisoul.py:96-98](), [src/kimi_cli/soul/kimisoul.py:141-142](), [src/kimi_cli/soul/kimisoul.py:267-269]()\n\n### Token Counting and Context Usage\n\nThe `Context` class tracks token count, which is updated after each LLM response:\n\n- **Input tokens**: Updated before appending the response at [src/kimi_cli/soul/kimisoul.py:190-192]()\n- **Total tokens**: Updated after appending at [src/kimi_cli/soul/kimisoul.py:237-238]()\n- **Context usage metric**: Calculated as `token_count / max_context_size` at [src/kimi_cli/soul/kimisoul.py:91-94]()\n\nThis metric is exposed through `StatusSnapshot` and sent to the UI via `StatusUpdate` events.\n\nSources: [src/kimi_cli/soul/kimisoul.py:91-94](), [src/kimi_cli/soul/kimisoul.py:190-192](), [src/kimi_cli/soul/kimisoul.py:237-238]()\n\n---\n\n## Configuration\n\n### LLM Model Configuration\n\nThe maximum context size is determined by the LLM model configuration:\n\n```json\n{\n  \"models\": {\n    \"kimi\": {\n      \"name\": \"moonshot-v1-128k\",\n      \"max_context_size\": 128000\n    }\n  }\n}\n```\n\nThis value is loaded into `agent_globals.llm.max_context_size` and validated against `RESERVED_TOKENS` during `KimiSoul` initialization:\n\n```python\nassert self._reserved_tokens \u003c= self._agent_globals.llm.max_context_size\n```\n\nSources: [src/kimi_cli/soul/kimisoul.py:68-69](), [CHANGELOG.md:213]()\n\n### Loop Control Settings\n\nCompaction retry behavior is controlled by `LoopControl` configuration:\n\n| Setting | Default | Description |\n|---------|---------|-------------|\n| `max_retries_per_step` | 3 | Maximum retry attempts for compaction |\n\nThis setting affects both regular steps and compaction operations.\n\nSources: [src/kimi_cli/soul/kimisoul.py:173](), [src/kimi_cli/soul/kimisoul.py:258](), [src/kimi_cli/config.py]()\n\n---\n\n## Error Handling\n\n### Exception Types\n\nCompaction can raise the following exceptions:\n\n| Exception | Condition | Handling |\n|-----------|-----------|----------|\n| `LLMNotSet` | No LLM configured when compaction triggered | Propagates to caller, should not occur in normal operation |\n| `ChatProviderError` | LLM API error during compaction | Retried up to `max_retries_per_step` times |\n| `APIConnectionError` | Network connection failure | Retried with exponential backoff |\n| `APITimeoutError` | Request timeout | Retried with exponential backoff |\n\nAll exceptions propagate to the agent loop's try-except handler at [src/kimi_cli/soul/kimisoul.py:149-154]().\n\nSources: [src/kimi_cli/soul/kimisoul.py:254-264](), [src/kimi_cli/soul/kimisoul.py:271-280]()\n\n### Retry Strategy\n\nThe retry logic uses `tenacity` library decorators:\n\n```python\n@tenacity.retry(\n    retry=retry_if_exception(self._is_retryable_error),\n    before_sleep=partial(self._retry_log, \"compaction\"),\n    wait=wait_exponential_jitter(initial=0.3, max=5, jitter=0.5),\n    stop=stop_after_attempt(self._loop_control.max_retries_per_step),\n    reraise=True,\n)\n```\n\nRetryable errors are determined by `_is_retryable_error()` at [src/kimi_cli/soul/kimisoul.py:271-280]().\n\nSources: [src/kimi_cli/soul/kimisoul.py:254-260](), [src/kimi_cli/soul/kimisoul.py:169-175]()\n\n---\n\n## Implementation Details\n\n### Key Classes and Methods\n\n| Class/Method | Location | Purpose |\n|--------------|----------|---------|\n| `KimiSoul.__init__()` | [src/kimi_cli/soul/kimisoul.py:43-76]() | Initializes compaction system |\n| `KimiSoul._agent_loop()` | [src/kimi_cli/soul/kimisoul.py:112-161]() | Contains threshold check and trigger |\n| `KimiSoul.compact_context()` | [src/kimi_cli/soul/kimisoul.py:245-269]() | Executes compaction process |\n| `KimiSoul._context_usage` | [src/kimi_cli/soul/kimisoul.py:91-94]() | Calculates usage percentage |\n| `SimpleCompaction.compact()` | [src/kimi_cli/soul/compaction.py]() | Implements summarization strategy |\n| `Context.revert_to()` | [src/kimi_cli/soul/context.py]() | Resets context to checkpoint |\n| `Context.append_message()` | [src/kimi_cli/soul/context.py]() | Adds messages to history |\n\n### Event Types\n\nCompaction-related events sent through `Wire`:\n\n| Event | Class | Trigger Point |\n|-------|-------|--------------|\n| `CompactionBegin` | [src/kimi_cli/soul/wire.py]() | Before compaction starts |\n| `CompactionEnd` | [src/kimi_cli/soul/wire.py]() | After compaction completes |\n| `StatusUpdate` | [src/kimi_cli/soul/wire.py]() | After token count update |\n\nSources: [src/kimi_cli/soul/kimisoul.py:136-138](), [src/kimi_cli/soul/wire.py]()\n\n---\n\n## Performance Considerations\n\n### Token Count Estimation\n\nToken counts are provided by the LLM API after each response via the `usage` field in `StepResult`. However:\n- Tool result tokens are **not** available until after execution\n- This creates a window where actual usage may exceed estimates\n- `RESERVED_TOKENS` buffer accounts for this uncertainty\n\n### Compaction Latency\n\nCompaction involves:\n1. **LLM API call** for summarization (potentially slow)\n2. **Context revert** operation (fast, in-memory)\n3. **Checkpoint creation** (fast, in-memory)\n4. **Message appending** (fast, in-memory)\n\nThe LLM call dominates latency. Users see `CompactionBegin` and `CompactionEnd` events indicating progress.\n\nSources: [src/kimi_cli/soul/kimisoul.py:130-138](), [src/kimi_cli/soul/kimisoul.py:245-269]()\n\n---\n\n## Version History\n\n| Version | Change | Reference |\n|---------|--------|-----------|\n| 0.36 | Added auto context compaction | [CHANGELOG.md:33]() |\n| 0.30 | Added `/compact` meta command | [CHANGELOG.md:94]() |\n| Unreleased | Fixed context compaction threshold check | [CHANGELOG.md:16]() |\n\nSources: [CHANGELOG.md:16](), [CHANGELOG.md:33](), [CHANGELOG.md:94]()"])</script><script>self.__next_f.push([1,"31:T39fa,"])</script><script>self.__next_f.push([1,"# Auto-Update System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/soul/denwarenji.py](src/kimi_cli/soul/denwarenji.py)\n- [src/kimi_cli/ui/shell/prompt.py](src/kimi_cli/ui/shell/prompt.py)\n- [src/kimi_cli/ui/shell/update.py](src/kimi_cli/ui/shell/update.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThe Auto-Update System provides automatic version checking and binary updates for kimi-cli. The system downloads, extracts, and installs new versions from a CDN in the background without requiring user intervention beyond confirming the update. This document covers the update mechanism, version detection, platform support, and installation workflow.\n\nFor information about the interactive shell interface where updates are initiated, see [Interactive Shell Mode](#4.1). For meta commands that trigger updates, see [Meta Commands](#4.2).\n\n---\n\n## System Overview\n\nThe auto-update system operates as a background service that checks for new versions, downloads platform-specific binaries from a CDN, and replaces the current executable with the updated version. The system is implemented entirely in [src/kimi_cli/ui/shell/update.py]() and integrates with the shell UI for user notifications.\n\n### Key Features\n\n| Feature | Description |\n|---------|-------------|\n| Background checking | Version checks occur asynchronously without blocking user interaction |\n| Platform detection | Automatically identifies macOS/Linux and x86_64/aarch64 architectures |\n| Semantic versioning | Compares versions using semantic versioning tuples |\n| CDN distribution | Downloads from `https://cdn.kimi.com/binaries/kimi-cli` |\n| Self-replacement | Installs updates to `~/.local/bin/kimi` |\n| Version caching | Stores latest version in `~/.kimi/latest_version.txt` |\n| Lock mechanism | Prevents concurrent update operations |\n\nSources: [src/kimi_cli/ui/shell/update.py:1-210]()\n\n---\n\n## Architecture\n\n### Core Components and Code Entities\n\n**Core Components and Their Relationships**\n\n```mermaid\ngraph TB\n    subgraph UpdateEntry[\"Update Entry Points\"]\n        MetaCommand[\"Meta Command: /update\"]\n        BackgroundCheck[\"Background Check: shell startup\"]\n    end\n    \n    subgraph Orchestration[\"Update Orchestration\"]\n        DoUpdate[\"do_update()\"]\n        UpdateLock[\"_UPDATE_LOCK: asyncio.Lock\"]\n        DoUpdateImpl[\"_do_update()\"]\n    end\n    \n    subgraph VersionMgmt[\"Version Management\"]\n        GetLatest[\"_get_latest_version()\"]\n        SemverTuple[\"semver_tuple()\"]\n        CurrentVersion[\"__version__\"]\n        LatestVersionFile[\"LATEST_VERSION_FILE\"]\n    end\n    \n    subgraph PlatformDetect[\"Platform Detection\"]\n        DetectTarget[\"_detect_target()\"]\n        PlatformSystem[\"platform.system()\"]\n        PlatformMachine[\"platform.machine()\"]\n    end\n    \n    subgraph DownloadInstall[\"Download and Install\"]\n        CDN[\"BASE_URL CDN\"]\n        AioHTTP[\"aiohttp.ClientSession\"]\n        TarExtract[\"tarfile.open()\"]\n        ShutilCopy[\"shutil.copy2()\"]\n        InstallDir[\"INSTALL_DIR: ~/.local/bin\"]\n    end\n    \n    subgraph ResultStates[\"Result States\"]\n        UpdateResult[\"UpdateResult enum\"]\n        States[\"UP_TO_DATE | UPDATE_AVAILABLE | UPDATED | FAILED | UNSUPPORTED\"]\n    end\n    \n    MetaCommand --\u003e DoUpdate\n    BackgroundCheck --\u003e DoUpdate\n    DoUpdate --\u003e UpdateLock\n    UpdateLock --\u003e DoUpdateImpl\n    \n    DoUpdateImpl --\u003e GetLatest\n    DoUpdateImpl --\u003e DetectTarget\n    DoUpdateImpl --\u003e SemverTuple\n    \n    GetLatest --\u003e CDN\n    GetLatest --\u003e AioHTTP\n    GetLatest --\u003e LatestVersionFile\n    \n    SemverTuple --\u003e CurrentVersion\n    \n    DetectTarget --\u003e PlatformSystem\n    DetectTarget --\u003e PlatformMachine\n    \n    DoUpdateImpl --\u003e TarExtract\n    DoUpdateImpl --\u003e ShutilCopy\n    ShutilCopy --\u003e InstallDir\n    \n    DoUpdateImpl --\u003e UpdateResult\n    UpdateResult --\u003e States\n```\n\nSources: [src/kimi_cli/ui/shell/update.py:1-210]()\n\n---\n\n## Update Result States\n\nThe system uses an `UpdateResult` enum to represent all possible outcomes of an update operation:\n\n**Update State Transitions**\n\n```mermaid\nstateDiagram-v2\n    [*] --\u003e Checking\n    Checking --\u003e UP_TO_DATE: \"Current version \u003e= Latest\"\n    Checking --\u003e UPDATE_AVAILABLE: \"check_only=True\"\n    Checking --\u003e Downloading: \"Update needed\"\n    Checking --\u003e FAILED: \"Network/parsing error\"\n    Checking --\u003e UNSUPPORTED: \"Platform not supported\"\n    \n    Downloading --\u003e Extracting: \"Download complete\"\n    Downloading --\u003e FAILED: \"Download error\"\n    \n    Extracting --\u003e Installing: \"Extract complete\"\n    Extracting --\u003e FAILED: \"Extract error\"\n    \n    Installing --\u003e UPDATED: \"Install complete\"\n    Installing --\u003e FAILED: \"Install error\"\n    \n    UP_TO_DATE --\u003e [*]\n    UPDATE_AVAILABLE --\u003e [*]\n    UPDATED --\u003e [*]\n    FAILED --\u003e [*]\n    UNSUPPORTED --\u003e [*]\n```\n\n| State | Description | Exit Code Path |\n|-------|-------------|----------------|\n| `UP_TO_DATE` | Current version is already the latest | [line 112-115]() |\n| `UPDATE_AVAILABLE` | Update exists but not applied (check-only mode) | [line 117-124]() |\n| `UPDATED` | Successfully downloaded and installed new version | [line 195-197]() |\n| `FAILED` | Network, extraction, or installation error | [line 104, 154, 177, 192]() |\n| `UNSUPPORTED` | Platform/architecture not supported | [line 94-96]() |\n\nSources: [src/kimi_cli/ui/shell/update.py:23-29, 78-197]()\n\n---\n\n## Update Workflow\n\n### Complete Update Sequence\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant MetaCmd as \"/update command\"\n    participant DoUpdate as \"do_update()\"\n    participant Lock as \"_UPDATE_LOCK\"\n    participant Impl as \"_do_update()\"\n    participant Platform as \"_detect_target()\"\n    participant CDN as \"CDN Server\"\n    participant FS as \"File System\"\n    \n    User-\u003e\u003eMetaCmd: \"Trigger update\"\n    MetaCmd-\u003e\u003eDoUpdate: \"Call with print=True\"\n    DoUpdate-\u003e\u003eLock: \"Acquire lock\"\n    Lock-\u003e\u003eImpl: \"_do_update()\"\n    \n    Impl-\u003e\u003eImpl: \"Load __version__\"\n    Impl-\u003e\u003ePlatform: \"Detect platform\"\n    Platform--\u003e\u003eImpl: \"target string\"\n    \n    Impl-\u003e\u003eCDN: \"GET /latest\"\n    CDN--\u003e\u003eImpl: \"latest version\"\n    \n    Impl-\u003e\u003eFS: \"Write LATEST_VERSION_FILE\"\n    Impl-\u003e\u003eImpl: \"semver_tuple comparison\"\n    \n    alt \"Already up to date\"\n        Impl--\u003e\u003eDoUpdate: \"UP_TO_DATE\"\n    else \"Update available\"\n        Impl-\u003e\u003eCDN: \"GET /{version}/{filename}.tar.gz\"\n        CDN--\u003e\u003eImpl: \"Binary archive\"\n        \n        Impl-\u003e\u003eFS: \"Write to temp directory\"\n        Impl-\u003e\u003eImpl: \"tarfile.extractall()\"\n        Impl-\u003e\u003eFS: \"os.walk() to find 'kimi'\"\n        \n        Impl-\u003e\u003eFS: \"shutil.copy2() to INSTALL_DIR\"\n        Impl-\u003e\u003eFS: \"os.chmod() +x\"\n        \n        Impl--\u003e\u003eDoUpdate: \"UPDATED\"\n    end\n    \n    DoUpdate--\u003e\u003eLock: \"Release lock\"\n    Lock--\u003e\u003eMetaCmd: \"Result\"\n    MetaCmd--\u003e\u003eUser: \"Display result\"\n```\n\nSources: [src/kimi_cli/ui/shell/update.py:78-197]()\n\n---\n\n## Version Detection and Comparison\n\n### Semantic Version Parsing\n\nThe `semver_tuple()` function [line 34-44]() converts version strings to comparable tuples:\n\n```python\n# Input examples and outputs:\n\"0.39\"       (0, 39, 0)\n\"v0.39\"      (0, 39, 0)\n\"1.2.3\"      (1, 2, 3)\n\"invalid\"    (0, 0, 0)\n```\n\nThe function:\n1. Strips leading `v` if present\n2. Extracts major, minor, and optional patch numbers using regex `^(\\d+)\\.(\\d+)(?:\\.(\\d+))?`\n3. Defaults patch to 0 if not provided\n4. Returns `(0, 0, 0)` for invalid formats\n\nVersion comparison logic [line 109-124]():\n\n```python\ncur_t = semver_tuple(current_version)  # From kimi_cli.__version__\nlat_t = semver_tuple(latest_version)    # From CDN\n\nif cur_t \u003e= lat_t:\n    return UpdateResult.UP_TO_DATE\nelif check_only:\n    return UpdateResult.UPDATE_AVAILABLE\nelse:\n    # Proceed with download and installation\n```\n\nSources: [src/kimi_cli/ui/shell/update.py:34-44, 109-124]()\n\n---\n\n## Platform Support\n\n### Platform Detection Algorithm\n\nThe `_detect_target()` function [src/kimi_cli/ui/shell/update.py:47-64]() builds a target string in the format `{arch}-{os}`:\n\n**Platform Detection Flow**\n\n```mermaid\nflowchart TD\n    Start[\"_detect_target()\"] --\u003e GetMachine[\"platform.machine()\"]\n    GetMachine --\u003e CheckArch{\"Architecture?\"}\n    \n    CheckArch --\u003e|\"x86_64, amd64\"| SetX64[\"arch = x86_64\"]\n    CheckArch --\u003e|\"arm64, aarch64\"| SetARM[\"arch = aarch64\"]\n    CheckArch --\u003e|\"other\"| Unsupported1[\"Return None\"]\n    \n    SetX64 --\u003e GetSystem[\"platform.system()\"]\n    SetARM --\u003e GetSystem\n    \n    GetSystem --\u003e CheckOS{\"OS?\"}\n    CheckOS --\u003e|\"Darwin\"| SetDarwin[\"os = apple-darwin\"]\n    CheckOS --\u003e|\"Linux\"| SetLinux[\"os = unknown-linux-gnu\"]\n    CheckOS --\u003e|\"other\"| Unsupported2[\"Return None\"]\n    \n    SetDarwin --\u003e BuildTarget[\"Return target string\"]\n    SetLinux --\u003e BuildTarget\n    \n    Unsupported1 --\u003e End[\"UNSUPPORTED\"]\n    Unsupported2 --\u003e End\n    BuildTarget --\u003e End\n```\n\n### Supported Platforms\n\n| Platform | Architecture | Target String |\n|----------|-------------|---------------|\n| macOS | x86_64 | `x86_64-apple-darwin` |\n| macOS | ARM64 | `aarch64-apple-darwin` |\n| Linux | x86_64 | `x86_64-unknown-linux-gnu` |\n| Linux | ARM64 | `aarch64-unknown-linux-gnu` |\n\nSources: [src/kimi_cli/ui/shell/update.py:47-64]()\n\n---\n\n## Download and Installation\n\n### CDN Structure\n\nThe update system fetches binaries from a structured CDN:\n\n```\nBASE_URL = \"https://cdn.kimi.com/binaries/kimi-cli\"\n\n /latest                          # Latest version identifier (e.g., \"0.38\")\n /{version}/                      # Version-specific directory\n     kimi-{version}-{target}.tar.gz\n```\n\nExample download URL construction [src/kimi_cli/ui/shell/update.py:133-134]():\n```\nfilename = f\"kimi-{latest_version}-{target}.tar.gz\"\ndownload_url = f\"{BASE_URL}/{latest_version}/{filename}\"\n\n# Example: https://cdn.kimi.com/binaries/kimi-cli/0.39/kimi-0.39-x86_64-apple-darwin.tar.gz\n```\n\nSources: [src/kimi_cli/ui/shell/update.py:18-19, 133-134]()\n\n### Installation Process\n\n**Binary Installation Workflow**\n\n```mermaid\nflowchart TD\n    Start[\"Download tarball\"] --\u003e TempDir[\"tempfile.TemporaryDirectory\"]\n    TempDir --\u003e Download[\"aiohttp ClientSession 64KB chunks\"]\n    Download --\u003e WriteTar[\"Write to temp file\"]\n    \n    WriteTar --\u003e Extract[\"tarfile.open r:gz mode\"]\n    Extract --\u003e Walk[\"os.walk find kimi binary\"]\n    Walk --\u003e FindBinary{\"Binary found?\"}\n    \n    FindBinary --\u003e|\"No\"| FailExtract[\"Return FAILED\"]\n    FindBinary --\u003e|\"Yes\"| CreateDir[\"INSTALL_DIR.mkdir parents=True\"]\n    \n    CreateDir --\u003e Copy[\"shutil.copy2\"]\n    Copy --\u003e Chmod[\"os.chmod +x permissions\"]\n    Chmod --\u003e Cleanup[\"Temp dir auto-cleanup\"]\n    Cleanup --\u003e Success[\"Return UPDATED\"]\n    \n    FailExtract --\u003e End[\"Report error\"]\n    Success --\u003e End\n```\n\nThe installation writes to [src/kimi_cli/ui/shell/update.py:179-193]():\n- **Destination**: `~/.local/bin/kimi`\n- **Permissions**: Executable for user, group, and others\n- **Method**: `shutil.copy2()` preserves metadata\n\nSources: [src/kimi_cli/ui/shell/update.py:136-193]()\n\n---\n\n## Concurrency Control\n\n### Update Lock Mechanism\n\nThe system uses an `asyncio.Lock` to prevent concurrent update operations [line 31-32, 79-80]():\n\n```python\n_UPDATE_LOCK = asyncio.Lock()\n\nasync def do_update(...) -\u003e UpdateResult:\n    async with _UPDATE_LOCK:\n        return await _do_update(...)\n```\n\nThis ensures:\n- Only one update operation runs at a time\n- Multiple `/update` commands don't cause race conditions\n- Background checks don't interfere with manual updates\n\nSources: [src/kimi_cli/ui/shell/update.py:31-32, 79-80]()\n\n---\n\n## Version Caching\n\nThe system caches the latest available version to avoid repeated CDN queries:\n\n| Component | Purpose | Location |\n|-----------|---------|----------|\n| `LATEST_VERSION_FILE` | Cache file for latest version | `~/.kimi/latest_version.txt` |\n| Update frequency | Written on every version check | [line 107]() |\n| Read usage | Not used for version comparison (always queries CDN) | N/A |\n\nThe cache file is written but not read by the update logic, serving primarily as a record of the last known latest version.\n\nSources: [src/kimi_cli/ui/shell/update.py:83, 107]()\n\n---\n\n## Error Handling\n\n### Exception Categories\n\n**Error Handling Paths**\n\n```mermaid\ngraph LR\n    Errors[\"Error Scenarios\"] --\u003e Network[\"Network Errors\"]\n    Errors --\u003e Platform[\"Platform Errors\"]\n    Errors --\u003e FS[\"File System Errors\"]\n    Errors --\u003e Archive[\"Archive Errors\"]\n    \n    Network --\u003e GetVersion[\"aiohttp.ClientError in _get_latest_version\"]\n    Network --\u003e Download[\"aiohttp.ClientError in download\"]\n    \n    Platform --\u003e DetectFail[\"Unsupported OS/arch in _detect_target\"]\n    \n    FS --\u003e WriteFail[\"OSError in file write\"]\n    FS --\u003e InstallFail[\"Exception in shutil.copy2\"]\n    \n    Archive --\u003e ExtractFail[\"Exception in tarfile.extractall\"]\n    Archive --\u003e NotFound[\"kimi binary not found\"]\n    \n    GetVersion --\u003e Failed[\"FAILED\"]\n    Download --\u003e Failed\n    DetectFail --\u003e Unsupported[\"UNSUPPORTED\"]\n    WriteFail --\u003e Failed\n    InstallFail --\u003e Failed\n    ExtractFail --\u003e Failed\n    NotFound --\u003e Failed\n```\n\nAll errors are logged using the `loguru` logger and optionally printed to the console based on the `print` parameter.\n\nSources: [src/kimi_cli/ui/shell/update.py:73-75, 94-96, 103-104, 148-158, 174-177, 189-193]()\n\n---\n\n## Integration Points\n\n### Shell UI Integration\n\nThe update system integrates with the shell UI through:\n\n1. **Meta Commands**: The `/update` command triggers `do_update(print=True)` [CHANGELOG.md:56]()\n2. **Toast Notifications**: Update status can be displayed via the toast system [src/kimi_cli/ui/shell/prompt.py:375-378]()\n3. **Background Tasks**: Updates can be checked asynchronously during shell startup\n\n### Configuration\n\nThe update system operates independently of the main configuration system and uses:\n- No configuration files (hardcoded CDN URL)\n- Platform detection via `platform` module\n- Version from `kimi_cli.__version__` [line 87]()\n\nSources: [src/kimi_cli/ui/shell/update.py:18-20, 87](), [CHANGELOG.md:56]()\n\n---\n\n## Usage Examples\n\n### Check-Only Mode\n\n```python\nresult = await do_update(print=True, check_only=True)\n# Result: UPDATE_AVAILABLE (if update exists)\n#         UP_TO_DATE (if current)\n```\n\nReturns `UPDATE_AVAILABLE` without downloading if an update exists.\n\n### Full Update\n\n```python\nresult = await do_update(print=True, check_only=False)\n# Result: UPDATED (if successful)\n#         UP_TO_DATE (if current)\n#         FAILED (if error)\n#         UNSUPPORTED (if platform unsupported)\n```\n\nDownloads, extracts, and installs the update if available.\n\n### Silent Background Check\n\n```python\nresult = await do_update(print=False, check_only=True)\n# No console output, only logs\n```\n\nUseful for periodic background checks without user notification.\n\nSources: [src/kimi_cli/ui/shell/update.py:78-197]()"])</script><script>self.__next_f.push([1,"32:T380f,"])</script><script>self.__next_f.push([1,"# Configuration Reference\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n\n\u003c/details\u003e\n\n\n\nThis document provides a comprehensive reference for all configuration options available in kimi-cli's `config.json` file. It covers the structure, schema, and validation rules for configuring LLM providers, models, loop control parameters, and external services.\n\nFor information about agent-specific configuration (system prompts, toolsets, and agent inheritance), see [Agent Specification Format](#5.1). For information about MCP tool server configuration, see [External Services](#8.3).\n\n## Configuration File Location\n\nThe configuration file is located at `~/.local/share/kimi/config.json` (or the platform-specific shared data directory). The location is determined by the `get_config_file()` function [src/kimi_cli/config.py:87-89]().\n\nWhen kimi-cli first runs, if no configuration file exists, a default empty configuration is created [src/kimi_cli/config.py:111-116](). The configuration must be populated with at least one model and provider before the agent can function.\n\n**Sources**: [src/kimi_cli/config.py:87-124]()\n\n## Configuration Schema Overview\n\nThe configuration system is built using Pydantic models that provide validation and type safety. The root configuration object is `Config`, which contains nested structures for providers, models, loop control, and services.\n\n### Configuration Data Model\n\n```mermaid\nclassDiagram\n    class Config {\n        +str default_model\n        +dict[str, LLMModel] models\n        +dict[str, LLMProvider] providers\n        +LoopControl loop_control\n        +Services services\n        +validate_model() Self\n    }\n    \n    class LLMProvider {\n        +Literal type\n        +str base_url\n        +SecretStr api_key\n        +dump_secret() str\n    }\n    \n    class LLMModel {\n        +str provider\n        +str model\n        +int max_context_size\n    }\n    \n    class LoopControl {\n        +int max_steps_per_run\n        +int max_retries_per_step\n    }\n    \n    class Services {\n        +MoonshotSearchConfig moonshot_search\n    }\n    \n    class MoonshotSearchConfig {\n        +str base_url\n        +SecretStr api_key\n        +dump_secret() str\n    }\n    \n    Config \"1\" *-- \"0..*\" LLMModel : contains\n    Config \"1\" *-- \"0..*\" LLMProvider : contains\n    Config \"1\" *-- \"1\" LoopControl : contains\n    Config \"1\" *-- \"1\" Services : contains\n    Services \"1\" *-- \"0..1\" MoonshotSearchConfig : contains\n    LLMModel \"1\" --\u003e \"1\" LLMProvider : references\n```\n\n**Sources**: [src/kimi_cli/config.py:11-84]()\n\n## LLM Provider Configuration\n\n### Provider Types\n\nThe `LLMProvider` class [src/kimi_cli/config.py:11-24]() defines LLM provider configurations. Three provider types are supported:\n\n| Provider Type | Description | Use Case |\n|--------------|-------------|----------|\n| `kimi` | Moonshot AI's Kimi API | Production use with Kimi models |\n| `openai_legacy` | OpenAI-compatible API (chat completions) | OpenAI or compatible services |\n| `_chaos` | Testing provider with artificial failures | Development and testing only |\n\n### Provider Configuration Structure\n\nEach provider entry in the `providers` dictionary contains:\n\n```json\n{\n  \"providers\": {\n    \"my-provider\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"your-api-key-here\"\n    }\n  }\n}\n```\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `type` | `\"kimi\"` \\| `\"openai_legacy\"` \\| `\"_chaos\"` | Provider type identifier |\n| `base_url` | `string` | Base URL for API requests |\n| `api_key` | `string` | API authentication key (stored as `SecretStr`) |\n\nThe `api_key` field uses Pydantic's `SecretStr` type [src/kimi_cli/config.py:18]() to prevent accidental logging of sensitive credentials. When serialized to JSON, it is explicitly dumped using `dump_secret()` [src/kimi_cli/config.py:21-23]().\n\n**Sources**: [src/kimi_cli/config.py:11-24](), [src/kimi_cli/utils/provider.py:32-72]()\n\n## LLM Model Configuration\n\n### Model Configuration Structure\n\nThe `LLMModel` class [src/kimi_cli/config.py:26-35]() defines model configurations. Each model entry references a provider and specifies context limits:\n\n```json\n{\n  \"models\": {\n    \"kimi-fast\": {\n      \"provider\": \"my-provider\",\n      \"model\": \"moonshot-v1-8k\",\n      \"max_context_size\": 8192\n    }\n  },\n  \"default_model\": \"kimi-fast\"\n}\n```\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `string` | Key referencing an entry in the `providers` dictionary |\n| `model` | `string` | Model identifier (provider-specific) |\n| `max_context_size` | `integer` | Maximum context window size in tokens |\n\n### Default Model Selection\n\nThe `default_model` field [src/kimi_cli/config.py:69]() specifies which model to use when no model is explicitly provided via CLI arguments. This field must reference a valid key in the `models` dictionary, enforced by validation [src/kimi_cli/config.py:78-80]().\n\n### Model-Provider Relationship Validation\n\nThe configuration validates that:\n1. The `default_model` exists in the `models` dictionary [src/kimi_cli/config.py:79-80]()\n2. Every model's `provider` field references an existing provider [src/kimi_cli/config.py:82-83]()\n\n**Sources**: [src/kimi_cli/config.py:26-84]()\n\n## Loop Control Configuration\n\nThe `LoopControl` class [src/kimi_cli/config.py:37-43]() configures agent execution loop behavior:\n\n```json\n{\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  }\n}\n```\n\n| Field | Type | Default | Description |\n|-------|------|---------|-------------|\n| `max_steps_per_run` | `integer` | `100` | Maximum number of agent loop iterations before termination |\n| `max_retries_per_step` | `integer` | `3` | Maximum retry attempts for a single step on transient errors |\n\n### Usage Context\n\n- **max_steps_per_run**: Prevents infinite loops in agent execution. Each LLM call and tool execution counts as one step.\n- **max_retries_per_step**: Handles transient errors (rate limits, network issues) by automatically retrying failed API calls.\n\n**Sources**: [src/kimi_cli/config.py:37-43](), [tests/test_config.py:30-32]()\n\n## Services Configuration\n\n### Moonshot Search Service\n\nThe `Services` class [src/kimi_cli/config.py:59-64]() contains optional external service configurations. Currently, only Moonshot Search is supported through the `MoonshotSearchConfig` class [src/kimi_cli/config.py:46-56]():\n\n```json\n{\n  \"services\": {\n    \"moonshot_search\": {\n      \"base_url\": \"https://search.moonshot.cn/v1/search\",\n      \"api_key\": \"your-search-api-key\"\n    }\n  }\n}\n```\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `base_url` | `string` | Moonshot Search API endpoint |\n| `api_key` | `string` | Search service authentication key |\n\nWhen configured, the `SearchWeb` tool uses this service to perform web searches [src/kimi_cli/tools/web/search.py:42-49](). If not configured, the tool returns an error instructing the agent to try alternative methods [src/kimi_cli/tools/web/search.py:55-59]().\n\n**Sources**: [src/kimi_cli/config.py:46-64](), [src/kimi_cli/tools/web/search.py:42-59]()\n\n## Environment Variable Overrides\n\nConfiguration values can be overridden using environment variables, allowing deployment-specific customization without modifying `config.json`.\n\n### Environment Variable Override Flow\n\n```mermaid\nflowchart TD\n    LoadConfig[\"load_config()\"]\n    ConfigFile[\"config.json\"]\n    ConfigObj[\"Config object\"]\n    SelectModel[\"Select model from CLI\"]\n    AugmentProvider[\"augment_provider_with_env_vars()\"]\n    CheckEnv{\"Environment\u003cbr/\u003evariables set?\"}\n    OverrideProvider[\"Override provider.base_url\u003cbr/\u003eprovider.api_key\"]\n    OverrideModel[\"Override model.model\u003cbr/\u003emodel.max_context_size\"]\n    CreateLLM[\"create_llm()\"]\n    LLMInstance[\"LLM instance\"]\n    \n    LoadConfig --\u003e ConfigFile\n    ConfigFile --\u003e ConfigObj\n    ConfigObj --\u003e SelectModel\n    SelectModel --\u003e AugmentProvider\n    AugmentProvider --\u003e CheckEnv\n    CheckEnv --\u003e|Yes| OverrideProvider\n    CheckEnv --\u003e|Yes| OverrideModel\n    CheckEnv --\u003e|No| CreateLLM\n    OverrideProvider --\u003e CreateLLM\n    OverrideModel --\u003e CreateLLM\n    CreateLLM --\u003e LLMInstance\n```\n\n### Kimi Provider Environment Variables\n\n| Environment Variable | Overrides | Example |\n|---------------------|-----------|---------|\n| `KIMI_BASE_URL` | `provider.base_url` | `https://api.moonshot.cn/v1` |\n| `KIMI_API_KEY` | `provider.api_key` | `sk-...` |\n| `KIMI_MODEL_NAME` | `model.model` | `moonshot-v1-32k` |\n| `KIMI_MODEL_MAX_CONTEXT_SIZE` | `model.max_context_size` | `32768` |\n\nThe augmentation logic is in `augment_provider_with_env_vars()` [src/kimi_cli/utils/provider.py:12-30]():\n- For Kimi providers (`type: \"kimi\"`), checks for `KIMI_*` variables [src/kimi_cli/utils/provider.py:14-22]()\n- For OpenAI-compatible providers, checks for `OPENAI_BASE_URL` and `OPENAI_API_KEY` [src/kimi_cli/utils/provider.py:23-27]()\n\n### OpenAI Provider Environment Variables\n\n| Environment Variable | Overrides | Example |\n|---------------------|-----------|---------|\n| `OPENAI_BASE_URL` | `provider.base_url` | `https://api.openai.com/v1` |\n| `OPENAI_API_KEY` | `provider.api_key` | `sk-...` |\n\n**Sources**: [src/kimi_cli/utils/provider.py:12-30]()\n\n## Configuration Validation\n\n### Validation Rules\n\nThe `Config` model implements validation through Pydantic's `@model_validator` [src/kimi_cli/config.py:77-84]():\n\n1. **Default Model Existence**: If `default_model` is set (non-empty), it must exist as a key in the `models` dictionary.\n2. **Provider Reference Integrity**: Every model's `provider` field must reference an existing key in the `providers` dictionary.\n\n### Error Handling\n\nConfiguration loading can fail with two error types:\n\n| Error Type | Cause | Example |\n|-----------|-------|---------|\n| `json.JSONDecodeError` | Invalid JSON syntax | Missing comma, unclosed bracket |\n| `ValidationError` | Schema validation failure | Invalid field type, failed validation rule |\n\nBoth errors are caught and wrapped in `ConfigError` [src/kimi_cli/config.py:122-123](), providing a clear error message:\n\n```python\nraise ConfigError(f\"Invalid configuration file: {config_file}\") from e\n```\n\n**Sources**: [src/kimi_cli/config.py:77-84](), [src/kimi_cli/config.py:102-123]()\n\n## Default Configuration\n\nWhen no configuration file exists, `get_default_config()` [src/kimi_cli/config.py:92-99]() creates a minimal valid configuration:\n\n```json\n{\n  \"default_model\": \"\",\n  \"models\": {},\n  \"providers\": {},\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  },\n  \"services\": {}\n}\n```\n\nThis configuration is automatically saved to disk [src/kimi_cli/config.py:114-116]() but requires user configuration before the agent can run (at minimum, one provider and one model must be defined).\n\n**Sources**: [src/kimi_cli/config.py:92-99](), [tests/test_config.py:10-37]()\n\n## Configuration Loading and Saving\n\n### Loading Process\n\n```mermaid\nflowchart TD\n    Start[\"load_config()\"]\n    GetPath[\"get_config_file()\"]\n    CheckExists{\"File\u003cbr/\u003eexists?\"}\n    CreateDefault[\"get_default_config()\"]\n    SaveDefault[\"Save to disk\"]\n    ReturnDefault[\"Return default Config\"]\n    ReadFile[\"Read JSON from file\"]\n    ParseJSON[\"Parse JSON\"]\n    ValidateSchema[\"Validate with Pydantic\"]\n    Success{\"Validation\u003cbr/\u003esuccess?\"}\n    ReturnConfig[\"Return Config object\"]\n    RaiseError[\"Raise ConfigError\"]\n    \n    Start --\u003e GetPath\n    GetPath --\u003e CheckExists\n    CheckExists --\u003e|No| CreateDefault\n    CreateDefault --\u003e SaveDefault\n    SaveDefault --\u003e ReturnDefault\n    CheckExists --\u003e|Yes| ReadFile\n    ReadFile --\u003e ParseJSON\n    ParseJSON --\u003e ValidateSchema\n    ValidateSchema --\u003e Success\n    Success --\u003e|Yes| ReturnConfig\n    Success --\u003e|No| RaiseError\n```\n\nThe `load_config()` function [src/kimi_cli/config.py:102-123]() implements this flow:\n1. Determines the config file path using `get_config_file()` [src/kimi_cli/config.py:87-89]()\n2. If the file doesn't exist, creates and saves default configuration [src/kimi_cli/config.py:111-116]()\n3. If the file exists, reads and parses JSON [src/kimi_cli/config.py:119-121]()\n4. Validates using Pydantic, raising `ConfigError` on failure [src/kimi_cli/config.py:122-123]()\n\n### Saving Process\n\nThe `save_config()` function [src/kimi_cli/config.py:133-138]() serializes the configuration to JSON with the following properties:\n- 2-space indentation for readability\n- `exclude_none=True` to omit null values\n- UTF-8 encoding\n\n**Sources**: [src/kimi_cli/config.py:87-138]()\n\n## Configuration Usage in the System\n\n```mermaid\nflowchart LR\n    ConfigFile[\"config.json\"]\n    LoadConfig[\"load_config()\"]\n    ConfigObj[\"Config object\"]\n    \n    subgraph \"Provider Creation\"\n        GetProvider[\"Select provider \u0026 model\"]\n        AugmentEnv[\"augment_provider_with_env_vars()\"]\n        CreateLLM[\"create_llm()\"]\n        LLMInstance[\"LLM instance\"]\n    end\n    \n    subgraph \"Service Initialization\"\n        ExtractServices[\"config.services\"]\n        SearchWeb[\"SearchWeb tool\"]\n    end\n    \n    subgraph \"Agent Execution\"\n        LoopControl[\"config.loop_control\"]\n        KimiSoul[\"KimiSoul agent loop\"]\n    end\n    \n    ConfigFile --\u003e LoadConfig\n    LoadConfig --\u003e ConfigObj\n    ConfigObj --\u003e GetProvider\n    GetProvider --\u003e AugmentEnv\n    AugmentEnv --\u003e CreateLLM\n    CreateLLM --\u003e LLMInstance\n    \n    ConfigObj --\u003e ExtractServices\n    ExtractServices --\u003e SearchWeb\n    \n    ConfigObj --\u003e LoopControl\n    LoopControl --\u003e KimiSoul\n```\n\nThe configuration is consumed by multiple system components:\n- **LLM Creation**: Provider and model configuration is used by `create_llm()` [src/kimi_cli/utils/provider.py:32-72]() to instantiate chat providers\n- **Tool Initialization**: Services configuration is injected into tools like `SearchWeb` [src/kimi_cli/tools/web/search.py:42-49]()\n- **Agent Execution**: Loop control parameters govern agent behavior (documented in [Context and Session Management](#7.1))\n\n**Sources**: [src/kimi_cli/config.py:66-84](), [src/kimi_cli/utils/provider.py:32-72](), [src/kimi_cli/tools/web/search.py:42-49]()"])</script><script>self.__next_f.push([1,"33:T30af,"])</script><script>self.__next_f.push([1,"# LLM Provider Configuration\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/llm.py](src/kimi_cli/llm.py)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n\n\u003c/details\u003e\n\n\n\nThis document describes how Large Language Model (LLM) providers and models are configured in kimi-cli. It covers the configuration file structure, supported provider types, environment variable overrides, and the instantiation process that transforms configuration into executable LLM instances.\n\nFor information about how LLM instances are integrated into the agent execution engine, see [LLM Integration](#3.3). For broader configuration options including loop control and external services, see [Configuration Reference](#8).\n\n## Configuration Structure\n\nThe LLM configuration system is organized around three primary Pydantic models defined in [src/kimi_cli/config.py:11-84](). The `Config` class serves as the root configuration object, containing dictionaries of providers and models, along with a `default_model` field that specifies which model to use when none is explicitly provided.\n\n### Configuration Hierarchy\n\n```mermaid\ngraph TB\n    subgraph ConfigFile[\"config.json\"]\n        Config[\"Config\"]\n    end\n    \n    subgraph Providers[\"providers: dict[str, LLMProvider]\"]\n        Provider1[\"'kimi_default'\u003cbr/\u003eLLMProvider\"]\n        Provider2[\"'openai_compatible'\u003cbr/\u003eLLMProvider\"]\n        ProviderN[\"...\"]\n    end\n    \n    subgraph Models[\"models: dict[str, LLMModel]\"]\n        Model1[\"'kimi-k1-nano'\u003cbr/\u003eLLMModel\"]\n        Model2[\"'gpt-4'\u003cbr/\u003eLLMModel\"]\n        ModelN[\"...\"]\n    end\n    \n    Config --\u003e Providers\n    Config --\u003e Models\n    Config --\u003e DefaultModel[\"default_model: str\"]\n    \n    Model1 --\u003e Provider1\n    Model2 --\u003e Provider2\n    \n    Provider1 --\u003e ProviderFields[\"type: Literal\u003cbr/\u003ebase_url: str\u003cbr/\u003eapi_key: SecretStr\"]\n    Model1 --\u003e ModelFields[\"provider: str\u003cbr/\u003emodel: str\u003cbr/\u003emax_context_size: int\"]\n```\n\n**Configuration Object Relationships**: The `Config` class contains two dictionaries that establish provider and model definitions. Each `LLMModel` references a provider by name, creating a validation dependency enforced at configuration load time.\n\n**Sources**: [src/kimi_cli/config.py:11-84]()\n\n### LLMProvider Class\n\nThe `LLMProvider` class [src/kimi_cli/config.py:11-24]() defines connection parameters for a specific LLM service endpoint:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `type` | `Literal[\"kimi\", \"openai_legacy\", \"_chaos\"]` | Provider type identifier determining the implementation |\n| `base_url` | `str` | API base URL for the provider endpoint |\n| `api_key` | `SecretStr` | Authentication API key (serialized securely) |\n\nThe `api_key` field uses Pydantic's `SecretStr` type to prevent accidental logging or display of sensitive credentials. The custom serializer [src/kimi_cli/config.py:21-23]() ensures the key is properly written when saving configuration files.\n\n**Sources**: [src/kimi_cli/config.py:11-24]()\n\n### LLMModel Class\n\nThe `LLMModel` class [src/kimi_cli/config.py:26-35]() defines a specific model configuration:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `str` | Name key referencing an entry in `Config.providers` |\n| `model` | `str` | Model identifier passed to the provider API |\n| `max_context_size` | `int` | Maximum context window size in tokens |\n\nThe `provider` field creates a named reference to a provider definition. This indirection allows multiple models to share the same provider configuration. The `max_context_size` value is used by the context management system to trigger compaction when the conversation history approaches token limits.\n\n**Sources**: [src/kimi_cli/config.py:26-35]()\n\n### Validation Rules\n\nThe `Config` class implements a Pydantic model validator [src/kimi_cli/config.py:77-84]() that enforces referential integrity:\n\n1. If `default_model` is non-empty, it must reference a key in the `models` dictionary\n2. Every `LLMModel.provider` value must reference a key in the `providers` dictionary\n\nThese validation rules ensure that the configuration is internally consistent before the application attempts to instantiate any LLM instances. Validation errors raise a `ValueError` with a descriptive message indicating which reference is broken.\n\n**Sources**: [src/kimi_cli/config.py:77-84]()\n\n## Provider Types\n\nkimi-cli supports three provider types, each implementing a different chat provider interface from the `kosong` library:\n\n### Kimi Provider\n\nThe `\"kimi\"` provider type [src/kimi_cli/utils/provider.py:40-51]() instantiates a `Kimi` chat provider with the following features:\n\n- Uses the Moonshot AI Kimi API\n- Supports streaming responses when `stream=True`\n- Includes custom `User-Agent` header from `kimi_cli.USER_AGENT`\n- Optional `prompt_cache_key` for session-based caching when `session_id` is provided\n\n**Configuration Example**:\n```json\n{\n  \"providers\": {\n    \"kimi_default\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"sk-...\"\n    }\n  }\n}\n```\n\n**Sources**: [src/kimi_cli/utils/provider.py:40-51]()\n\n### OpenAI Legacy Provider\n\nThe `\"openai_legacy\"` provider type [src/kimi_cli/utils/provider.py:52-58]() instantiates an `OpenAILegacy` chat provider compatible with OpenAI's API format:\n\n- Follows OpenAI API conventions\n- Works with OpenAI-compatible endpoints (e.g., Azure OpenAI, local models)\n- Supports streaming responses\n\n**Configuration Example**:\n```json\n{\n  \"providers\": {\n    \"openai_compatible\": {\n      \"type\": \"openai_legacy\",\n      \"base_url\": \"https://api.openai.com/v1\",\n      \"api_key\": \"sk-...\"\n    }\n  }\n}\n```\n\n**Sources**: [src/kimi_cli/utils/provider.py:52-58]()\n\n### Chaos Provider\n\nThe `\"_chaos\"` provider type [src/kimi_cli/utils/provider.py:59-68]() is a testing-only provider that simulates unreliable API behavior:\n\n- Configured with 80% error probability\n- Returns HTTP errors (429, 500, 503) to test retry logic\n- Used in development and testing to verify resilience\n\nThis provider should never be used in production configurations. The underscore prefix indicates its internal/testing nature.\n\n**Sources**: [src/kimi_cli/utils/provider.py:59-68]()\n\n## Environment Variable Overrides\n\nThe `augment_provider_with_env_vars()` function [src/kimi_cli/utils/provider.py:12-30]() provides a mechanism to override configuration values using environment variables. This is particularly useful for:\n\n- Keeping sensitive credentials out of configuration files\n- Switching between environments (development, staging, production)\n- Temporary testing with different models or endpoints\n\n### Kimi Provider Environment Variables\n\n| Environment Variable | Overrides | Type |\n|---------------------|-----------|------|\n| `KIMI_BASE_URL` | `provider.base_url` | `str` |\n| `KIMI_API_KEY` | `provider.api_key` | `SecretStr` |\n| `KIMI_MODEL_NAME` | `model.model` | `str` |\n| `KIMI_MODEL_MAX_CONTEXT_SIZE` | `model.max_context_size` | `int` |\n\n### OpenAI Provider Environment Variables\n\n| Environment Variable | Overrides | Type |\n|---------------------|-----------|------|\n| `OPENAI_BASE_URL` | `provider.base_url` | `str` |\n| `OPENAI_API_KEY` | `provider.api_key` | `SecretStr` |\n\nEnvironment variable overrides are applied **after** loading the configuration file but **before** instantiating the LLM. This means environment variables always take precedence over file-based configuration.\n\n**Sources**: [src/kimi_cli/utils/provider.py:12-30]()\n\n## Provider Instantiation Flow\n\nThe process of transforming configuration into an executable LLM instance follows a multi-stage pipeline:\n\n```mermaid\nsequenceDiagram\n    participant App as \"Application Startup\"\n    participant LoadConfig as \"load_config()\"\n    participant ConfigValidator as \"Config Validator\"\n    participant EnvAugment as \"augment_provider_with_env_vars()\"\n    participant CreateLLM as \"create_llm()\"\n    participant ChatProvider as \"ChatProvider Instance\"\n    participant LLMTuple as \"LLM NamedTuple\"\n    \n    App-\u003e\u003eLoadConfig: Request configuration\n    LoadConfig-\u003e\u003eLoadConfig: Read config.json\n    LoadConfig-\u003e\u003eConfigValidator: Validate structure\n    ConfigValidator-\u003e\u003eConfigValidator: Check provider references\n    ConfigValidator-\u003e\u003eConfigValidator: Check default_model\n    ConfigValidator--\u003e\u003eLoadConfig: Config object\n    \n    App-\u003e\u003eApp: Select model\u003cbr/\u003e(default or --model)\n    App-\u003e\u003eEnvAugment: augment(provider, model)\n    EnvAugment-\u003e\u003eEnvAugment: Check KIMI_BASE_URL, etc.\n    EnvAugment-\u003e\u003eEnvAugment: Override fields if set\n    EnvAugment--\u003e\u003eApp: Augmented config\n    \n    App-\u003e\u003eCreateLLM: create_llm(provider, model)\n    CreateLLM-\u003e\u003eCreateLLM: Match provider.type\n    \n    alt type == \"kimi\"\n        CreateLLM-\u003e\u003eChatProvider: Kimi(model, base_url, api_key)\n        ChatProvider-\u003e\u003eChatProvider: Add User-Agent header\n        ChatProvider-\u003e\u003eChatProvider: Configure session cache\n    else type == \"openai_legacy\"\n        CreateLLM-\u003e\u003eChatProvider: OpenAILegacy(...)\n    else type == \"_chaos\"\n        CreateLLM-\u003e\u003eChatProvider: ChaosChatProvider(...)\n    end\n    \n    CreateLLM-\u003e\u003eLLMTuple: LLM(chat_provider, max_context_size)\n    LLMTuple--\u003e\u003eApp: Ready for KimiSoul\n```\n\n**LLM Instantiation Pipeline**: Configuration is loaded, validated, augmented with environment overrides, and finally instantiated into a `ChatProvider` implementation wrapped in an `LLM` tuple. The `LLM` tuple [src/kimi_cli/llm.py:6-8]() is a simple container with two fields: `chat_provider` (the kosong provider instance) and `max_context_size` (used for context management).\n\n**Sources**: [src/kimi_cli/config.py:102-123](), [src/kimi_cli/utils/provider.py:12-72](), [src/kimi_cli/llm.py:6-8]()\n\n## Configuration File Location and Management\n\nThe configuration file is located at a platform-specific shared directory determined by `get_share_dir()`. The file path is retrieved via `get_config_file()` [src/kimi_cli/config.py:87-89](), which returns `{share_dir}/config.json`.\n\n### Default Configuration\n\nIf no configuration file exists, `load_config()` [src/kimi_cli/config.py:102-123]() automatically creates one with default values:\n\n```json\n{\n  \"default_model\": \"\",\n  \"models\": {},\n  \"providers\": {},\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  },\n  \"services\": {}\n}\n```\n\nThis empty configuration requires the user to run setup commands (see [Meta Commands](#4.2)) to populate provider and model definitions before the agent can function.\n\n**Sources**: [src/kimi_cli/config.py:92-99](), [tests/test_config.py:22-37]()\n\n### Saving Configuration\n\nThe `save_config()` function [src/kimi_cli/config.py:133-138]() serializes a `Config` object back to JSON with:\n- 2-space indentation for readability\n- `exclude_none=True` to omit null fields\n- UTF-8 encoding\n\nConfiguration modifications made through meta commands (e.g., `/setup`) use this function to persist changes.\n\n**Sources**: [src/kimi_cli/config.py:133-138]()\n\n## Configuration in External Services\n\nWhile this document focuses on LLM provider configuration, the `Config` class also contains a `services` field for external service configuration. For example, the `SearchWeb` tool [src/kimi_cli/tools/web/search.py:42-49]() reads `config.services.moonshot_search` to access the Moonshot Search API configuration, which follows a similar structure with `base_url` and `api_key` fields.\n\nFor comprehensive coverage of all service configurations, see [External Services](#8.3).\n\n**Sources**: [src/kimi_cli/tools/web/search.py:42-49]()\n\n## Error Handling\n\nConfiguration errors are wrapped in a `ConfigError` exception [src/kimi_cli/config.py:126-130](). Common error scenarios include:\n\n- **JSON parsing errors**: Malformed JSON syntax in `config.json`\n- **Validation errors**: Missing required fields or invalid field types\n- **Reference errors**: `default_model` or `LLMModel.provider` referencing non-existent keys\n- **Provider type errors**: Unsupported `provider.type` value in `create_llm()`\n\nAll configuration validation occurs at application startup, ensuring that runtime errors due to misconfiguration are caught early in the lifecycle.\n\n**Sources**: [src/kimi_cli/config.py:118-130](), [src/kimi_cli/utils/provider.py:69-70]()"])</script><script>self.__next_f.push([1,"34:T2b2a,"])</script><script>self.__next_f.push([1,"# Loop Control and Limits\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/soul/__init__.py](src/kimi_cli/soul/__init__.py)\n- [src/kimi_cli/soul/kimisoul.py](src/kimi_cli/soul/kimisoul.py)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/ui/__init__.py](src/kimi_cli/ui/__init__.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n\n\u003c/details\u003e\n\n\n\nThis document describes the `loop_control` configuration section in `config.json`, which controls the execution limits and retry behavior of the agent execution loop. These settings prevent infinite loops and handle transient API errors gracefully.\n\nFor information about other configuration options, see [Configuration Reference](#8). For details on how the agent execution loop operates, see [Agent System](#3.2).\n\n## Overview\n\nThe `LoopControl` configuration defines two critical constraints on agent execution:\n\n1. **Maximum steps per run**: Prevents unbounded agent loops by limiting the total number of LLM inference steps in a single user request\n2. **Maximum retries per step**: Handles transient API failures by automatically retrying failed LLM calls with exponential backoff\n\nThese limits ensure that the system remains responsive and robust against both logical errors (infinite loops) and infrastructure failures (API timeouts, rate limits).\n\n**Sources**: [src/kimi_cli/config.py:37-44]()\n\n## Configuration Structure\n\nThe `loop_control` section in `config.json` follows this structure:\n\n```json\n{\n  \"loop_control\": {\n    \"max_steps_per_run\": 100,\n    \"max_retries_per_step\": 3\n  }\n}\n```\n\nThe `LoopControl` class is defined as a Pydantic model with default values:\n\n| Field | Type | Default | Description |\n|-------|------|---------|-------------|\n| `max_steps_per_run` | `int` | 100 | Maximum number of agent loop iterations in one run |\n| `max_retries_per_step` | `int` | 3 | Maximum number of retry attempts for transient API errors |\n\n**Sources**: [src/kimi_cli/config.py:37-44](), [tests/test_config.py:30-32]()\n\n## Agent Loop Flow with Limits\n\n```mermaid\nflowchart TD\n    Start[\"User Input\"] --\u003e Checkpoint[\"Create Checkpoint\"]\n    Checkpoint --\u003e AppendMsg[\"Append User Message\"]\n    AppendMsg --\u003e InitLoop[\"Initialize step_no = 1\"]\n    \n    InitLoop --\u003e LoopCheck{{\"step_no \u003e max_steps_per_run?\"}}\n    LoopCheck --\u003e|Yes| MaxStepsError[\"Raise MaxStepsReached\"]\n    LoopCheck --\u003e|No| StepBegin[\"Send StepBegin Event\"]\n    \n    StepBegin --\u003e Compaction{\"Context Too Long?\"}\n    Compaction --\u003e|Yes| CompactCtx[\"Compact Context\"]\n    Compaction --\u003e|No| Checkpoint2[\"Create Checkpoint\"]\n    CompactCtx --\u003e Checkpoint2\n    \n    Checkpoint2 --\u003e ExecuteStep[\"Execute Step with Retry\"]\n    ExecuteStep --\u003e CheckFinish{\"Tool Calls Remaining?\"}\n    \n    CheckFinish --\u003e|No| EndSuccess[\"Run Complete\"]\n    CheckFinish --\u003e|Yes| IncrStep[\"step_no += 1\"]\n    IncrStep --\u003e LoopCheck\n    \n    MaxStepsError --\u003e End[\"End\"]\n    EndSuccess --\u003e End\n    \n    ExecuteStep -.-\u003e|\"ChatProviderError\"| StepInterrupted[\"Send StepInterrupted\"]\n    StepInterrupted --\u003e End\n```\n\n**Diagram: Agent Loop with Step Limit**\n\nThe `KimiSoul._agent_loop` method implements the main execution loop. After each step, it increments `step_no` and checks against `max_steps_per_run`. If the limit is exceeded, it raises `MaxStepsReached` exception.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:112-162]()\n\n## Step Execution with Retry Logic\n\n```mermaid\nflowchart TD\n    Start[\"Begin Step Execution\"] --\u003e SetupRetry[\"Configure Tenacity Retry\"]\n    SetupRetry --\u003e Attempt[\"Attempt LLM Call\"]\n    \n    Attempt --\u003e CheckError{\"Error Occurred?\"}\n    CheckError --\u003e|No| Success[\"Return StepResult\"]\n    CheckError --\u003e|Yes| ClassifyError{\"Is Retryable?\"}\n    \n    ClassifyError --\u003e|No| RaiseError[\"Reraise Exception\"]\n    ClassifyError --\u003e|Yes| CheckAttempts{{\"attempt_number \u003c= max_retries_per_step?\"}}\n    \n    CheckAttempts --\u003e|No| RaiseError\n    CheckAttempts --\u003e|Yes| LogRetry[\"Log Retry Attempt\"]\n    LogRetry --\u003e WaitBackoff[\"Wait with Exponential Backoff\"]\n    WaitBackoff --\u003e Attempt\n    \n    Success --\u003e End[\"Continue\"]\n    RaiseError --\u003e End\n```\n\n**Diagram: Step Retry Mechanism**\n\nThe `KimiSoul._step` method wraps the LLM call with a Tenacity retry decorator. The retry configuration uses:\n- `stop_after_attempt(self._loop_control.max_retries_per_step)` to limit retry attempts\n- `wait_exponential_jitter(initial=0.3, max=5, jitter=0.5)` for backoff timing\n- `retry_if_exception(self._is_retryable_error)` to filter retryable errors\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:163-187]()\n\n## Retryable Error Classification\n\n```mermaid\ngraph TB\n    subgraph \"Error Types\"\n        APIConnectionError[\"APIConnectionError\"]\n        APITimeoutError[\"APITimeoutError\"]\n        APIStatusError[\"APIStatusError\"]\n    end\n    \n    subgraph \"Classification Logic\"\n        IsRetryable[\"_is_retryable_error()\"]\n    end\n    \n    subgraph \"Status Codes\"\n        Code429[\"429 - Too Many Requests\"]\n        Code500[\"500 - Internal Server Error\"]\n        Code502[\"502 - Bad Gateway\"]\n        Code503[\"503 - Service Unavailable\"]\n    end\n    \n    APIConnectionError --\u003e IsRetryable\n    APITimeoutError --\u003e IsRetryable\n    APIStatusError --\u003e CheckStatus{\"Status Code?\"}\n    \n    CheckStatus --\u003e Code429\n    CheckStatus --\u003e Code500\n    CheckStatus --\u003e Code502\n    CheckStatus --\u003e Code503\n    \n    Code429 --\u003e IsRetryable\n    Code500 --\u003e IsRetryable\n    Code502 --\u003e IsRetryable\n    Code503 --\u003e IsRetryable\n    \n    IsRetryable --\u003e Retry[\"Retry Allowed\"]\n```\n\n**Diagram: Retryable Error Decision Tree**\n\nThe `KimiSoul._is_retryable_error` static method determines whether an exception should trigger a retry:\n\n| Error Type | Always Retryable | Notes |\n|------------|------------------|-------|\n| `APIConnectionError` | Yes | Network connectivity issues |\n| `APITimeoutError` | Yes | Request timeout |\n| `APIStatusError` | Conditional | Only for status codes 429, 500, 502, 503 |\n| Other exceptions | No | Raised immediately without retry |\n\nThis classification ensures that transient infrastructure failures are automatically handled, while application-level errors (e.g., invalid parameters, authentication failures) are surfaced immediately.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:271-280]()\n\n## Configuration in KimiSoul\n\n```mermaid\ngraph LR\n    Config[\"Config Object\"] --\u003e LoadLoopControl[\"load_config()\"]\n    LoadLoopControl --\u003e LoopControl[\"LoopControl Instance\"]\n    \n    Agent[\"Agent Definition\"] --\u003e AgentGlobals[\"AgentGlobals Container\"]\n    LoopControl --\u003e KimiSoul[\"KimiSoul Constructor\"]\n    AgentGlobals --\u003e KimiSoul\n    \n    KimiSoul --\u003e StoreInField[\"self._loop_control\"]\n    StoreInField --\u003e AgentLoop[\"_agent_loop()\"]\n    StoreInField --\u003e StepMethod[\"_step()\"]\n    StoreInField --\u003e CompactMethod[\"compact_context()\"]\n    \n    AgentLoop -.-\u003e|\"uses\"| MaxStepsPerRun[\"max_steps_per_run\"]\n    StepMethod -.-\u003e|\"uses\"| MaxRetriesPerStep[\"max_retries_per_step\"]\n    CompactMethod -.-\u003e|\"uses\"| MaxRetriesPerStep\n```\n\n**Diagram: Loop Control Configuration Flow**\n\nThe `KimiSoul` constructor receives a `LoopControl` instance and stores it in `self._loop_control`. This instance is then referenced in:\n\n1. **`_agent_loop`**: Checks `step_no \u003e self._loop_control.max_steps_per_run` after each iteration\n2. **`_step`**: Uses `stop_after_attempt(self._loop_control.max_retries_per_step)` in the retry decorator\n3. **`compact_context`**: Uses the same retry configuration as `_step` for context compaction\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:43-76](), [src/kimi_cli/soul/kimisoul.py:160-161](), [src/kimi_cli/soul/kimisoul.py:173](), [src/kimi_cli/soul/kimisoul.py:258]()\n\n## Behavior on Limit Reached\n\n### Maximum Steps Exceeded\n\nWhen `max_steps_per_run` is exceeded:\n\n1. The loop check at line 160-161 evaluates to true\n2. `MaxStepsReached` exception is raised with the step count\n3. The exception propagates to the UI layer\n4. The user is notified that the agent reached its execution limit\n\n```python\nif step_no \u003e self._loop_control.max_steps_per_run:\n    raise MaxStepsReached(self._loop_control.max_steps_per_run)\n```\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:160-161](), [src/kimi_cli/soul/__init__.py:13-21]()\n\n### Maximum Retries Exceeded\n\nWhen `max_retries_per_step` is exceeded:\n\n1. Tenacity stops retrying after the configured number of attempts\n2. The original exception is re-raised (due to `reraise=True`)\n3. The `_agent_loop` catches `ChatProviderError` exceptions\n4. A `StepInterrupted` event is sent to the UI\n5. The agent loop breaks and returns control to the caller\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:149-152]()\n\n## Retry Logging\n\nEach retry attempt is logged by the `_retry_log` static method, providing visibility into retry behavior:\n\n```python\nlogger.info(\n    \"Retrying {name} for the {n} time. Waiting {sleep} seconds.\",\n    name=name,\n    n=retry_state.attempt_number,\n    sleep=retry_state.next_action.sleep if retry_state.next_action is not None else \"unknown\",\n)\n```\n\nThe log message includes:\n- **name**: Either \"step\" or \"compaction\" to identify which operation is retrying\n- **attempt_number**: The current retry attempt (1, 2, 3, ...)\n- **sleep duration**: The wait time before the next attempt (follows exponential backoff)\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:282-291]()\n\n## Complete Configuration Example\n\n```json\n{\n  \"default_model\": \"kimi-k1.5-latest\",\n  \"models\": {\n    \"kimi-k1.5-latest\": {\n      \"provider\": \"kimi\",\n      \"model\": \"k1.5\",\n      \"max_context_size\": 128000\n    }\n  },\n  \"providers\": {\n    \"kimi\": {\n      \"type\": \"kimi\",\n      \"base_url\": \"https://api.moonshot.cn/v1\",\n      \"api_key\": \"your-api-key-here\"\n    }\n  },\n  \"loop_control\": {\n    \"max_steps_per_run\": 50,\n    \"max_retries_per_step\": 5\n  },\n  \"services\": {}\n}\n```\n\nIn this example:\n- The agent will stop after 50 steps maximum (reduced from default 100)\n- Each LLM call will retry up to 5 times on transient errors (increased from default 3)\n- These settings are appropriate for environments with less reliable API connectivity\n\n**Sources**: [src/kimi_cli/config.py:66-75](), [tests/test_config.py:22-37]()\n\n## Relationship to Context Compaction\n\nThe retry logic also applies to context compaction operations. When the context becomes too large (approaching `max_context_size`), the `compact_context` method is called, which uses the same retry configuration:\n\n```python\n@tenacity.retry(\n    retry=retry_if_exception(self._is_retryable_error),\n    before_sleep=partial(self._retry_log, \"compaction\"),\n    wait=wait_exponential_jitter(initial=0.3, max=5, jitter=0.5),\n    stop=stop_after_attempt(self._loop_control.max_retries_per_step),\n    reraise=True,\n)\n```\n\nThis ensures that compaction operations, which are also LLM calls, receive the same resilience against transient failures.\n\n**Sources**: [src/kimi_cli/soul/kimisoul.py:253-265]()"])</script><script>self.__next_f.push([1,"35:T2f54,"])</script><script>self.__next_f.push([1,"# External Services\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [CHANGELOG.md](CHANGELOG.md)\n- [pyproject.toml](pyproject.toml)\n- [src/kimi_cli/config.py](src/kimi_cli/config.py)\n- [src/kimi_cli/tools/web/search.py](src/kimi_cli/tools/web/search.py)\n- [src/kimi_cli/utils/provider.py](src/kimi_cli/utils/provider.py)\n- [tests/test_config.py](tests/test_config.py)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis document covers the configuration and integration of external services used by kimi-cli. External services are third-party APIs that extend the capabilities of the agent system beyond core LLM functionality. These services are configured centrally in the main configuration file and consumed by specific tools.\n\nFor LLM provider configuration (Kimi, OpenAI), see [LLM Provider Configuration](#8.1). For configuring agent execution behavior, see [Loop Control and Limits](#8.2).\n\n## Overview\n\nExternal services in kimi-cli are optional, pluggable integrations that enhance tool capabilities. Currently, the system supports:\n\n- **Moonshot Search API**: Powers the `SearchWeb` tool with web search capabilities\n\nServices are configured in the `services` section of the configuration file and accessed by tools through the global configuration object.\n\n**Sources:** [src/kimi_cli/config.py:59-64]()\n\n## Configuration Structure\n\nExternal services are defined using Pydantic models that enforce type safety and validation. The configuration hierarchy is:\n\n```mermaid\ngraph TB\n    Config[\"Config\u003cbr/\u003e(Main configuration)\"]\n    Services[\"Services\u003cbr/\u003eservices field\"]\n    MoonshotSearch[\"MoonshotSearchConfig\u003cbr/\u003emoonshot_search field\"]\n    \n    Config --\u003e Services\n    Services --\u003e MoonshotSearch\n    \n    MoonshotSearch --\u003e BaseURL[\"base_url: str\"]\n    MoonshotSearch --\u003e APIKey[\"api_key: SecretStr\"]\n```\n\n**Diagram: External Services Configuration Hierarchy**\n\nThe `Services` class aggregates all external service configurations:\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `moonshot_search` | `MoonshotSearchConfig \\| None` | No | Moonshot Search API configuration |\n\nEach service configuration contains:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `base_url` | `str` | API endpoint base URL |\n| `api_key` | `SecretStr` | API authentication key (encrypted in memory) |\n\n**Sources:** [src/kimi_cli/config.py:46-64]()\n\n## Moonshot Search API Configuration\n\nThe Moonshot Search API is a web search service that provides search results with optional content crawling. It is used by the `SearchWeb` tool to perform internet searches.\n\n### Configuration Model\n\nThe `MoonshotSearchConfig` class defines the configuration schema:\n\n```\nMoonshotSearchConfig\n base_url: str          # Base URL for Moonshot Search service\n api_key: SecretStr     # API key for authentication\n```\n\nThe `api_key` field uses Pydantic's `SecretStr` type to ensure:\n- The key is never exposed in logs or string representations\n- Serialization requires explicit handling via `get_secret_value()`\n- Security by default in the configuration layer\n\n**Sources:** [src/kimi_cli/config.py:46-56]()\n\n### Configuration File Format\n\nExternal services are configured in `config.json` under the `services` key:\n\n```json\n{\n  \"default_model\": \"moonshot-v1-128k\",\n  \"models\": { ... },\n  \"providers\": { ... },\n  \"services\": {\n    \"moonshot_search\": {\n      \"base_url\": \"https://api.moonshot.cn/v1/services/search\",\n      \"api_key\": \"your-api-key-here\"\n    }\n  }\n}\n```\n\nWhen `moonshot_search` is `null` or not present, the `SearchWeb` tool will return an error message indicating the service is not configured.\n\n**Sources:** [src/kimi_cli/config.py:59-64](), [src/kimi_cli/tools/web/search.py:42-49]()\n\n## Service Integration with Tools\n\nExternal services are injected into tools during initialization through the dependency injection system. This diagram shows the flow from configuration loading to tool usage:\n\n```mermaid\nsequenceDiagram\n    participant CLI as \"CLI Entry Point\"\n    participant ConfigModule as \"load_config()\"\n    participant ConfigFile as \"config.json\"\n    participant Config as \"Config object\"\n    participant ToolInit as \"Tool Initialization\"\n    participant SearchWeb as \"SearchWeb tool\"\n    participant API as \"Moonshot Search API\"\n    \n    CLI-\u003e\u003eConfigModule: Load configuration\n    ConfigModule-\u003e\u003eConfigFile: Read file\n    ConfigFile--\u003e\u003eConfigModule: JSON data\n    ConfigModule-\u003e\u003eConfig: Parse into Config model\n    Config--\u003e\u003eConfigModule: Validated config\n    ConfigModule--\u003e\u003eCLI: Config object\n    \n    CLI-\u003e\u003eToolInit: Initialize agent tools\n    ToolInit-\u003e\u003eSearchWeb: __init__(config=config)\n    SearchWeb-\u003e\u003eConfig: Read services.moonshot_search\n    Config--\u003e\u003eSearchWeb: MoonshotSearchConfig or None\n    SearchWeb-\u003e\u003eSearchWeb: Store base_url and api_key\n    \n    Note over SearchWeb: Tool is ready for execution\n    \n    SearchWeb-\u003e\u003eAPI: POST request with auth\n    API--\u003e\u003eSearchWeb: Search results\n```\n\n**Diagram: External Service Configuration and Usage Flow**\n\n### Tool Configuration Pattern\n\nTools that use external services follow this initialization pattern:\n\n1. Tool receives `Config` object via constructor dependency injection\n2. Tool reads the relevant service configuration from `config.services`\n3. Tool extracts and stores required fields (`base_url`, `api_key`)\n4. Tool checks for configuration presence and returns user-friendly errors if missing\n\n**Example from SearchWeb tool:**\n\n```python\ndef __init__(self, config: Config, **kwargs):\n    super().__init__(**kwargs)\n    if config.services.moonshot_search is not None:\n        self._base_url = config.services.moonshot_search.base_url\n        self._api_key = config.services.moonshot_search.api_key.get_secret_value()\n    else:\n        self._base_url = \"\"\n        self._api_key = \"\"\n```\n\nWhen the tool is called, it validates the configuration:\n\n```python\nif not self._base_url or not self._api_key:\n    return builder.error(\n        \"Search service is not configured. You may want to try other methods to search.\",\n        brief=\"Search service not configured\",\n    )\n```\n\n**Sources:** [src/kimi_cli/tools/web/search.py:42-59]()\n\n## Moonshot Search API Integration\n\nThe `SearchWeb` tool demonstrates the complete integration pattern for external services:\n\n```mermaid\ngraph TB\n    SearchWebCall[\"SearchWeb.__call__\u003cbr/\u003e(params)\"]\n    ValidateConfig[\"Validate Configuration\u003cbr/\u003eCheck base_url and api_key\"]\n    BuildRequest[\"Build HTTP Request\"]\n    HTTPPost[\"aiohttp.ClientSession.post()\"]\n    CheckStatus[\"Check HTTP Status\"]\n    ParseResponse[\"Parse JSON Response\u003cbr/\u003eResponse model\"]\n    FormatResults[\"Format Search Results\"]\n    ReturnSuccess[\"Return ToolResult\"]\n    ReturnError[\"Return Error Message\"]\n    \n    SearchWebCall --\u003e ValidateConfig\n    ValidateConfig --\u003e|Missing| ReturnError\n    ValidateConfig --\u003e|Present| BuildRequest\n    BuildRequest --\u003e HTTPPost\n    HTTPPost --\u003e CheckStatus\n    CheckStatus --\u003e|200 OK| ParseResponse\n    CheckStatus --\u003e|Error| ReturnError\n    ParseResponse --\u003e|Success| FormatResults\n    ParseResponse --\u003e|ValidationError| ReturnError\n    FormatResults --\u003e ReturnSuccess\n```\n\n**Diagram: SearchWeb Tool Execution Flow**\n\n### Request Details\n\nThe tool constructs HTTP POST requests with the following characteristics:\n\n| Component | Value | Source |\n|-----------|-------|--------|\n| URL | `{base_url}` from config | `MoonshotSearchConfig.base_url` |\n| Method | `POST` | Hardcoded |\n| Headers | `Authorization: Bearer {api_key}` | `MoonshotSearchConfig.api_key` |\n| Headers | `User-Agent: {kimi_cli.USER_AGENT}` | Application constant |\n| Headers | `X-Msh-Tool-Call-Id: {tool_call.id}` | Current tool execution context |\n| Body | JSON with query parameters | Tool parameters |\n\n### Request Body Schema\n\n```json\n{\n  \"text_query\": \"search query text\",\n  \"limit\": 5,\n  \"enable_page_crawling\": false,\n  \"timeout_seconds\": 30\n}\n```\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `text_query` | `string` | The search query text |\n| `limit` | `integer` | Number of results (1-20) |\n| `enable_page_crawling` | `boolean` | Whether to fetch full page content |\n| `timeout_seconds` | `integer` | Request timeout duration |\n\n**Sources:** [src/kimi_cli/tools/web/search.py:64-79]()\n\n### Response Handling\n\nThe API returns a JSON response validated against the `Response` model:\n\n```\nResponse\n search_results: list[SearchResult]\n     SearchResult\n         site_name: str\n         title: str\n         url: str\n         snippet: str\n         content: str = \"\"      # When enable_page_crawling=True\n         date: str = \"\"\n         icon: str = \"\"\n         mime: str = \"\"\n```\n\nThe tool formats results into a human-readable text format with section separators:\n\n```\nTitle: {result.title}\nDate: {result.date}\nURL: {result.url}\nSummary: {result.snippet}\n\n{result.content}  # If requested\n\n---\n\n[Next result...]\n```\n\n**Sources:** [src/kimi_cli/tools/web/search.py:90-111](), [src/kimi_cli/tools/web/search.py:114-126]()\n\n## Error Handling\n\nExternal service integrations implement comprehensive error handling:\n\n| Error Condition | HTTP Status | Tool Behavior |\n|----------------|-------------|---------------|\n| Service not configured | N/A | Return error: \"Search service not configured\" |\n| HTTP request failure | Non-200 | Return error with status code |\n| JSON parse failure | 200 | Return error: \"Failed to parse search results\" |\n| Validation error | 200 | Return error with validation details |\n\nAll errors are returned as `ToolResult` objects with:\n- Full error message for the agent's context\n- Brief error summary for display\n- Non-blocking behavior (agent can continue with alternative approaches)\n\n**Sources:** [src/kimi_cli/tools/web/search.py:55-99]()\n\n## Configuration Best Practices\n\n### Security Considerations\n\n1. **API Key Storage**: Store API keys in the configuration file with restricted file permissions\n2. **SecretStr Usage**: The `SecretStr` type prevents accidental key exposure in logs\n3. **Serialization Control**: Keys are only serialized when explicitly requested via `get_secret_value()`\n\n### Configuration Validation\n\nThe configuration system validates external service settings:\n\n```python\n# Automatic validation on load\nconfig = load_config()  # Raises ValidationError if invalid\n\n# Service presence is optional\nif config.services.moonshot_search is not None:\n    # Service is configured\n    pass\nelse:\n    # Service is not configured, tools degrade gracefully\n    pass\n```\n\n### Default Behavior\n\nWhen external services are not configured:\n- Tools detect missing configuration during initialization\n- Tools return helpful error messages suggesting alternative approaches\n- Agents can adapt by using other available tools\n- System remains functional with reduced capabilities\n\n**Sources:** [src/kimi_cli/config.py:102-123](), [src/kimi_cli/tools/web/search.py:55-59]()\n\n## Adding New External Services\n\nTo add a new external service, follow this pattern:\n\n1. **Define Configuration Model** in `config.py`:\n   ```python\n   class NewServiceConfig(BaseModel):\n       base_url: str\n       api_key: SecretStr\n       # Additional fields...\n   ```\n\n2. **Add to Services Class**:\n   ```python\n   class Services(BaseModel):\n       moonshot_search: MoonshotSearchConfig | None = None\n       new_service: NewServiceConfig | None = None  # Add here\n   ```\n\n3. **Create Tool Using Service**:\n   ```python\n   class NewTool(CallableTool2[Params]):\n       def __init__(self, config: Config, **kwargs):\n           super().__init__(**kwargs)\n           if config.services.new_service is not None:\n               self._base_url = config.services.new_service.base_url\n               self._api_key = config.services.new_service.api_key.get_secret_value()\n   ```\n\n4. **Implement Error Handling** for missing configuration\n5. **Document Configuration** in user-facing materials\n\n**Sources:** [src/kimi_cli/config.py:46-64](), [src/kimi_cli/tools/web/search.py:42-49]()"])</script><script>self.__next_f.push([1,"36:T5bd1,"])</script><script>self.__next_f.push([1,"# Development Guide\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.github/workflows/ci.yml](.github/workflows/ci.yml)\n- [.github/workflows/release.yml](.github/workflows/release.yml)\n- [Makefile](Makefile)\n- [pyrightconfig.json](pyrightconfig.json)\n- [src/kimi_cli/deps/Makefile](src/kimi_cli/deps/Makefile)\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n\n\u003c/details\u003e\n\n\n\nThis guide is for developers who want to contribute to kimi-cli or extend it with custom functionality. It covers development environment setup, build system, testing infrastructure, CI/CD workflows, and extension points.\n\nFor information about:\n- Using kimi-cli as an end user, see [Getting Started](#2)\n- Agent configuration and customization, see [Agent Configuration](#5)\n- Detailed build system documentation, see [Build System](#9.1)\n- Testing practices and infrastructure, see [Testing](#9.2)\n- Creating custom tools, see [Creating Custom Tools](#9.3)\n- CI/CD pipeline details, see [CI/CD and Release Process](#9.4)\n\n## Development Environment Setup\n\n### Prerequisites\n\nkimi-cli requires:\n- Python 3.13 or higher\n- `uv` package manager (version 0.8.5 or higher)\n- Platform-specific build tools for PyInstaller\n\n### Initial Setup\n\nDevelopment setup is automated through the `Makefile`:\n\n```bash\nmake prepare\n```\n\nThis command performs two operations:\n1. Downloads platform-specific dependencies (ripgrep binary) via `download-deps` target\n2. Synchronizes Python dependencies using `uv sync --frozen`\n\nThe dependency download process is managed by [src/kimi_cli/deps/Makefile:1-63](), which detects the host platform (OS and architecture) and downloads the appropriate ripgrep binary from GitHub releases.\n\n### Code Quality Tools\n\nkimi-cli enforces code quality through three main tools:\n\n| Tool | Purpose | Makefile Target |\n|------|---------|-----------------|\n| `ruff` | Linting and auto-formatting | `make format`, `make check` |\n| `pyright` | Static type checking | `make check` |\n| `pytest` | Unit and integration testing | `make test` |\n\nThe type checker configuration is defined in [pyrightconfig.json:1-9](), which includes `src/**/*.py` and `tests/**/*.py` while excluding cache directories.\n\n**Sources:** [Makefile:1-25](), [src/kimi_cli/deps/Makefile:1-63](), [pyrightconfig.json:1-9]()\n\n## Development Workflow\n\n### Development Cycle\n\n```mermaid\ngraph LR\n    Edit[\"Edit Source Code\"] --\u003e Format[\"make format\"]\n    Format --\u003e Check[\"make check\"]\n    Check --\u003e Pass1{\"Checks\u003cbr/\u003ePass?\"}\n    Pass1 --\u003e|No| Edit\n    Pass1 --\u003e|Yes| Test[\"make test\"]\n    Test --\u003e Pass2{\"Tests\u003cbr/\u003ePass?\"}\n    Pass2 --\u003e|No| Edit\n    Pass2 --\u003e|Yes| Build[\"make build\"]\n    Build --\u003e Smoke[\"Test Binary\u003cbr/\u003e./dist/kimi\"]\n    Smoke --\u003e Commit[\"git commit\u003cbr/\u003egit push\"]\n```\n\n### Makefile Targets Reference\n\nThe root [Makefile:1-25]() provides these targets:\n\n| Target | Command | Description |\n|--------|---------|-------------|\n| `prepare` | `download-deps`, `uv sync --frozen` | Set up development environment |\n| `format` | `uv run ruff check --fix`, `uv run ruff format` | Auto-fix issues and format code |\n| `check` | `uv run ruff check`, `uv run ruff format --check`, `uv run pyright` | Run linters and type checker |\n| `test` | `uv run pytest tests -vv` | Run test suite with verbose output |\n| `build` | `uv run pyinstaller kimi.spec` | Create standalone binary |\n\n**Sources:** [Makefile:1-25]()\n\n## Codebase Architecture\n\n### Source Code Organization\n\n```mermaid\ngraph TB\n    subgraph \"Entry Points\"\n        CLI[\"src/kimi_cli/__init__.py\u003cbr/\u003emain(), parse arguments\"]\n    end\n    \n    subgraph \"Core Systems\"\n        Agent[\"src/kimi_cli/agent.py\u003cbr/\u003eAgentSpec, AgentGlobals,\u003cbr/\u003eload_agent()\"]\n        Config[\"src/kimi_cli/config.py\u003cbr/\u003eConfig, get_default_config()\"]\n        Soul[\"src/kimi_cli/soul/\u003cbr/\u003eKimiSoul, Context,\u003cbr/\u003eDenwaRenji, Approval\"]\n    end\n    \n    subgraph \"Extensions\"\n        Tools[\"src/kimi_cli/tools/\u003cbr/\u003efile/, web/, bash/,\u003cbr/\u003etask/, think/, dmail/\"]\n        UI[\"src/kimi_cli/ui/\u003cbr/\u003eshell/, print/\"]\n        Deps[\"src/kimi_cli/deps/\u003cbr/\u003ebin/rg, Makefile\"]\n    end\n    \n    subgraph \"Test Infrastructure\"\n        Conftest[\"tests/conftest.py\u003cbr/\u003eFixtures: agent_globals,\u003cbr/\u003econfig, llm, tools\"]\n        Tests[\"tests/test_*.py\u003cbr/\u003eUnit tests\"]\n    end\n    \n    CLI --\u003e Agent\n    CLI --\u003e Config\n    CLI --\u003e UI\n    Agent --\u003e Soul\n    Agent --\u003e Tools\n    \n    Conftest --\u003e Tests\n    Tests --\u003e Agent\n    Tests --\u003e Tools\n```\n\nThe codebase follows a layered architecture:\n- **Entry Points**: [src/kimi_cli/__init__.py]() handles command-line parsing and initialization\n- **Core Systems**: [src/kimi_cli/agent.py]() and [src/kimi_cli/soul/]() implement agent execution\n- **Extensions**: [src/kimi_cli/tools/]() and [src/kimi_cli/ui/]() provide extensible functionality\n- **Test Infrastructure**: [tests/conftest.py:1-225]() defines reusable fixtures\n\n**Sources:** [Makefile:1-25](), [tests/conftest.py:1-225]()\n\n## Build System Architecture\n\n### Dependency Management Flow\n\n```mermaid\ngraph TB\n    subgraph \"Python Dependencies\"\n        PyProject[\"pyproject.toml\u003cbr/\u003eDependencies\"]\n        UVLock[\"uv.lock\u003cbr/\u003eLocked versions\"]\n        UVSync[\"uv sync --frozen\"]\n        VirtualEnv[\".venv/\u003cbr/\u003eVirtual environment\"]\n    end\n    \n    subgraph \"Binary Dependencies\"\n        DepMakefile[\"src/kimi_cli/deps/Makefile\"]\n        PlatformDetect[\"Platform Detection\u003cbr/\u003euname -s, uname -m\"]\n        TargetMap[\"Target Mapping\u003cbr/\u003ex86_64-unknown-linux-musl\u003cbr/\u003eaarch64-apple-darwin\u003cbr/\u003eetc.\"]\n        Download[\"Download from GitHub\u003cbr/\u003eripgrep releases\"]\n        ExtractBin[\"Extract \u0026 Install\u003cbr/\u003esrc/kimi_cli/deps/bin/rg\"]\n    end\n    \n    PyProject --\u003e UVSync\n    UVLock --\u003e UVSync\n    UVSync --\u003e VirtualEnv\n    \n    DepMakefile --\u003e PlatformDetect\n    PlatformDetect --\u003e TargetMap\n    TargetMap --\u003e Download\n    Download --\u003e ExtractBin\n```\n\n### Platform-Specific Binary Downloads\n\nThe [src/kimi_cli/deps/Makefile:1-63]() handles platform detection and binary downloads:\n\n**Platform Detection** [src/kimi_cli/deps/Makefile:7-32]():\n- Detects OS: `uname -s` (Darwin/Linux)\n- Detects architecture: `uname -m` (x86_64/aarch64/arm64/armv7l)\n- Maps to ripgrep target names\n\n**Target Mapping Examples:**\n| OS | Architecture | Target |\n|----|--------------|--------|\n| macOS | ARM64 | `aarch64-apple-darwin` |\n| macOS | x86_64 | `x86_64-apple-darwin` |\n| Linux | x86_64 | `x86_64-unknown-linux-musl` |\n| Linux | aarch64 | `aarch64-unknown-linux-gnu` |\n\n**Download Process** [src/kimi_cli/deps/Makefile:38-58]():\n1. Check if `src/kimi_cli/deps/bin/rg` already exists\n2. Download tarball from GitHub releases using `curl` or `wget`\n3. Extract to temporary directory\n4. Copy binary to `src/kimi_cli/deps/bin/rg`\n5. Make executable with `chmod +x`\n\n**Sources:** [Makefile:1-25](), [src/kimi_cli/deps/Makefile:1-63]()\n\n## Testing Infrastructure\n\n### Fixture Dependency Graph\n\n```mermaid\ngraph TB\n    subgraph \"Primitive Fixtures\"\n        Config[\"config()\u003cbr/\u003eConfig\"]\n        LLM[\"llm()\u003cbr/\u003eLLM with MockChatProvider\"]\n        TempWork[\"temp_work_dir()\u003cbr/\u003ePath\"]\n        TempShare[\"temp_share_dir()\u003cbr/\u003ePath\"]\n    end\n    \n    subgraph \"Derived Fixtures\"\n        BuiltinArgs[\"builtin_args()\u003cbr/\u003eBuiltinSystemPromptArgs\"]\n        Session[\"session()\u003cbr/\u003eSession\"]\n        Approval[\"approval()\u003cbr/\u003eApproval(yolo=True)\"]\n        DenwaRenji[\"denwa_renji()\u003cbr/\u003eDenwaRenji\"]\n        AgentSpec[\"agent_spec()\u003cbr/\u003eAgentSpec\"]\n    end\n    \n    subgraph \"Container Fixture\"\n        AgentGlobals[\"agent_globals()\u003cbr/\u003eAgentGlobals\"]\n    end\n    \n    subgraph \"Tool Fixtures\"\n        TaskTool[\"task_tool(agent_spec,\u003cbr/\u003eagent_globals)\"]\n        BashTool[\"bash_tool(approval)\u003cbr/\u003ewith tool_call_context\"]\n        ReadFile[\"read_file_tool\u003cbr/\u003e(builtin_args)\"]\n        WriteFile[\"write_file_tool\u003cbr/\u003e(builtin_args, approval)\"]\n        OtherTools[\"search_web_tool\u003cbr/\u003efetch_url_tool\u003cbr/\u003ethink_tool\u003cbr/\u003eetc.\"]\n    end\n    \n    TempWork --\u003e BuiltinArgs\n    TempWork --\u003e Session\n    TempShare --\u003e Session\n    \n    Config --\u003e AgentGlobals\n    LLM --\u003e AgentGlobals\n    BuiltinArgs --\u003e AgentGlobals\n    DenwaRenji --\u003e AgentGlobals\n    Session --\u003e AgentGlobals\n    Approval --\u003e AgentGlobals\n    \n    AgentSpec --\u003e TaskTool\n    AgentGlobals --\u003e TaskTool\n    Approval --\u003e BashTool\n    BuiltinArgs --\u003e ReadFile\n    BuiltinArgs --\u003e WriteFile\n    Approval --\u003e WriteFile\n```\n\n### Core Test Fixtures\n\nThe [tests/conftest.py:1-225]() file defines the complete fixture hierarchy:\n\n**Primitive Fixtures:**\n- `config()` [tests/conftest.py:38-41](): Returns `get_default_config()`\n- `llm()` [tests/conftest.py:44-47](): Creates `LLM` with `MockChatProvider([])` for deterministic testing\n- `temp_work_dir()` [tests/conftest.py:50-54](): Provides temporary working directory\n- `temp_share_dir()` [tests/conftest.py:57-61](): Provides temporary shared directory\n\n**Derived Fixtures:**\n- `builtin_args()` [tests/conftest.py:64-72](): Creates `BuiltinSystemPromptArgs` with test timestamp \"1970-01-01T00:00:00+00:00\"\n- `session()` [tests/conftest.py:81-88](): Creates `Session` with test ID and temporary directories\n- `approval()` [tests/conftest.py:91-94](): Creates `Approval(yolo=True)` for auto-approval in tests\n- `denwa_renji()` [tests/conftest.py:75-78](): Creates `DenwaRenji` instance\n- `agent_spec()` [tests/conftest.py:117-120](): Loads `DEFAULT_AGENT_FILE`\n\n**Container Fixture:**\n- `agent_globals()` [tests/conftest.py:97-114](): Assembles all dependencies into `AgentGlobals` container\n\n**Tool Fixtures:**\nEach tool has a dedicated fixture that injects its required dependencies:\n- `task_tool()` [tests/conftest.py:139-142](): Requires `AgentSpec` and `AgentGlobals`\n- `bash_tool()` [tests/conftest.py:163-167](): Requires `Approval`, uses `tool_call_context(\"Bash\")`\n- `read_file_tool()` [tests/conftest.py:170-173](): Requires `BuiltinSystemPromptArgs`\n- `write_file_tool()` [tests/conftest.py:188-194](): Requires `BuiltinSystemPromptArgs` and `Approval`, uses `tool_call_context(\"WriteFile\")`\n- Additional tool fixtures for `str_replace_file_tool`, `patch_file_tool`, `search_web_tool`, `fetch_url_tool`, etc. [tests/conftest.py:197-224]()\n\n### Tool Call Context Helper\n\nThe `tool_call_context()` helper [tests/conftest.py:123-136]() simulates the execution context required by approval-gated tools:\n\n```python\n@contextmanager\ndef tool_call_context(tool_name: str) -\u003e Generator[None]:\n    from kosong.base.message import ToolCall\n    from kimi_cli.soul.toolset import current_tool_call\n    \n    token = current_tool_call.set(\n        ToolCall(id=\"test\", function=ToolCall.FunctionBody(name=tool_name, arguments=None))\n    )\n    try:\n        yield\n    finally:\n        current_tool_call.reset(token)\n```\n\nThis sets the `current_tool_call` context variable that approval mechanisms check during tool execution.\n\n**Sources:** [tests/conftest.py:1-225]()\n\n### Testing Patterns\n\nThe test suite demonstrates several patterns, exemplified in [tests/test_load_agent.py:1-411]():\n\n**Agent Loading Tests:**\n- Basic loading [tests/test_load_agent.py:29-36](): Validates agent name, system prompt, and toolset\n- Validation [tests/test_load_agent.py:38-53](): Tests required field enforcement\n- Extension mechanism [tests/test_load_agent.py:65-120](): Tests `extend` inheritance\n- Template substitution [tests/test_load_agent.py:122-130](): Tests system prompt variable replacement\n\n**Fixture Composition Pattern:**\n```python\ndef test_load_agent_basic(agent_file: Path, agent_globals: AgentGlobals):\n    \"\"\"Test loading a basic agent configuration.\"\"\"\n    agent = load_agent(agent_file, agent_globals)\n    \n    assert agent.name == \"Test Agent\"\n    assert \"You are a test agent\" in agent.system_prompt\n    assert agent.toolset is not None\n```\n\n**Temporary File Pattern:**\n```python\n@pytest.fixture\ndef agent_file() -\u003e Generator[Path, Any, Any]:\n    with tempfile.TemporaryDirectory() as tmpdir:\n        tmpdir = Path(tmpdir)\n        \n        system_md = tmpdir / \"system.md\"\n        system_md.write_text(\"You are a test agent\")\n        \n        agent_yaml = tmpdir / \"agent.yaml\"\n        agent_yaml.write_text(\"\"\"\nversion: 1\nagent:\n  name: \"Test Agent\"\n  system_prompt_path: ./system.md\n  tools: [\"kimi_cli.tools.think:Think\"]\n\"\"\")\n        \n        yield agent_yaml\n```\n\n**Sources:** [tests/test_load_agent.py:1-411](), [tests/conftest.py:1-225]()\n\n## CI/CD Pipeline Architecture\n\n### Continuous Integration Workflow\n\n```mermaid\ngraph TB\n    subgraph \"Triggers\"\n        PR[\"Pull Request\"]\n        Push[\"Push to main branch\"]\n    end\n    \n    subgraph \"CI Job: ubuntu-22.04\"\n        Checkout[\"actions/checkout@v4\"]\n        Python[\"actions/setup-python@v5\u003cbr/\u003ePython 3.13\"]\n        UV[\"astral-sh/setup-uv@v1\u003cbr/\u003euv 0.8.5\"]\n        Prepare[\"make prepare\u003cbr/\u003edownload-deps, uv sync\"]\n        Check[\"make check\u003cbr/\u003eruff, pyright\"]\n        Test[\"make test\u003cbr/\u003epytest\"]\n        Build[\"make build\u003cbr/\u003epyinstaller\"]\n        Smoke[\"./dist/kimi --help\"]\n        Upload[\"actions/upload-artifact@v4\u003cbr/\u003ekimi-x86_64-unknown-linux-gnu\u003cbr/\u003eretention: 7 days\"]\n    end\n    \n    PR --\u003e Checkout\n    Push --\u003e Checkout\n    \n    Checkout --\u003e Python\n    Python --\u003e UV\n    UV --\u003e Prepare\n    Prepare --\u003e Check\n    Check --\u003e Test\n    Test --\u003e Build\n    Build --\u003e Smoke\n    Smoke --\u003e Upload\n```\n\nThe CI workflow [.github/workflows/ci.yml:1-62]() executes on every pull request and push to main:\n\n**Setup Phase** [.github/workflows/ci.yml:25-40]():\n1. Checkout repository with `actions/checkout@v4`\n2. Set up Python 3.13 with `actions/setup-python@v5`, allowing pre-releases\n3. Set up uv 0.8.5 with `astral-sh/setup-uv@v1`\n\n**Validation Phase** [.github/workflows/ci.yml:39-46]():\n1. `make prepare`: Downloads dependencies and syncs Python packages\n2. `make check`: Runs ruff linting, formatting checks, and pyright type checking\n3. `make test`: Runs pytest test suite with verbose output\n\n**Build Phase** [.github/workflows/ci.yml:48-52]():\n1. `make build`: Creates standalone binary with PyInstaller\n2. Smoke test: `./dist/kimi --help` verifies the binary is executable\n\n**Artifact Upload** [.github/workflows/ci.yml:54-61]():\n- Uploads binary as `kimi-x86_64-unknown-linux-gnu`\n- 7-day retention period for ephemeral CI artifacts\n\n**Note:** The CI workflow currently only builds on Linux x86_64. macOS and ARM platforms are commented out in the matrix [.github/workflows/ci.yml:17-22]().\n\n**Sources:** [.github/workflows/ci.yml:1-62]()\n\n### Release Workflow\n\n```mermaid\ngraph TB\n    subgraph \"Triggers\"\n        Tag[\"Push Tag\"]\n        Manual[\"workflow_dispatch\"]\n    end\n    \n    subgraph \"Build Job: Matrix\"\n        Linux[\"ubuntu-22.04\u003cbr/\u003ex86_64-unknown-linux-gnu\"]\n        MacIntel[\"macos-13\u003cbr/\u003ex86_64-apple-darwin\"]\n        MacArm[\"macos-14\u003cbr/\u003eaarch64-apple-darwin\"]\n    end\n    \n    subgraph \"Each Platform Build\"\n        Setup[\"Setup: Python 3.13 + uv 0.8.5\"]\n        PrepBuild[\"make prepare\u003cbr/\u003emake build\"]\n        Package[\"tar -czf\u003cbr/\u003ekimi-TAG-TARGET.tar.gz\"]\n        UploadArtifact[\"Upload Artifact\u003cbr/\u003eretention: 7 days\"]\n    end\n    \n    subgraph \"Release Job\"\n        Download[\"Download All Artifacts\u003cbr/\u003emerge-multiple\"]\n        SHA[\"Generate SHA256 sums\u003cbr/\u003efor each tarball\"]\n        GHRelease[\"Create GitHub Release\u003cbr/\u003eattach tarballs + SHA256\"]\n    end\n    \n    subgraph \"PyPI Job\"\n        UVBuild[\"uv build\u003cbr/\u003esdist + wheel\"]\n        PyPIPublish[\"pypa/gh-action-pypi-publish\u003cbr/\u003ePYPI_API_TOKEN\"]\n    end\n    \n    Tag --\u003e Linux\n    Tag --\u003e MacIntel\n    Tag --\u003e MacArm\n    Manual --\u003e Linux\n    \n    Linux --\u003e Setup\n    MacIntel --\u003e Setup\n    MacArm --\u003e Setup\n    \n    Setup --\u003e PrepBuild\n    PrepBuild --\u003e Package\n    Package --\u003e UploadArtifact\n    \n    UploadArtifact --\u003e Download\n    Download --\u003e SHA\n    SHA --\u003e GHRelease\n    \n    Tag --\u003e UVBuild\n    UVBuild --\u003e PyPIPublish\n```\n\nThe release workflow [.github/workflows/release.yml:1-137]() is triggered by tag pushes or manual dispatch:\n\n**Build Job Matrix** [.github/workflows/release.yml:13-72]():\nBuilds on three platforms:\n- `ubuntu-22.04`  `x86_64-unknown-linux-gnu`\n- `macos-13`  `x86_64-apple-darwin`\n- `macos-14`  `aarch64-apple-darwin`\n\nEach build:\n1. Sets up Python 3.13 and uv 0.8.5\n2. Runs `make prepare` and `make build`\n3. Packages binary as `kimi-{TAG}-{TARGET}.tar.gz` [.github/workflows/release.yml:49-61]()\n4. Uploads artifact with 7-day retention\n\n**Release Job** [.github/workflows/release.yml:73-108]():\n1. Downloads all build artifacts with `merge-multiple: true`\n2. Generates SHA256 checksums for each tarball [.github/workflows/release.yml:87-96]():\n   ```bash\n   for f in *.tar.gz; do\n     sha256sum \"$f\" \u003e \"$f.sha256\"\n   done\n   ```\n3. Creates GitHub Release with `softprops/action-gh-release@v2` [.github/workflows/release.yml:98-108]():\n   - Tag name from `github.ref_name`\n   - Auto-generated release notes\n   - Attaches all `*.tar.gz` and `*.tar.gz.sha256` files\n\n**PyPI Job** [.github/workflows/release.yml:110-137]():\n1. Builds Python distributions with `uv build` [.github/workflows/release.yml:128-129]()\n2. Publishes to PyPI using `pypa/gh-action-pypi-publish@release/v1` [.github/workflows/release.yml:131-136]()\n3. Authenticates with `PYPI_API_TOKEN` secret\n\n**Sources:** [.github/workflows/release.yml:1-137]()\n\n## Extension Points\n\n### Custom Tool Development\n\nTools are the primary extension mechanism. Each tool:\n- Inherits from a base tool class (if using the `kosong` framework)\n- Declares JSON schema for parameters\n- Receives dependencies via constructor injection\n- Can request user approval through the `Approval` system\n\nFor detailed implementation guidance, see [Creating Custom Tools](#9.3).\n\n### Agent Specification Customization\n\nAgents support inheritance through the `extend` field:\n- **Builtin agents**: Located in `src/kimi_cli/agents/` (e.g., Kimi Koder)\n- **Project-level agents**: `AGENTS.md` or `agents.md` in working directory\n- **Custom agents**: Specified via `--agent-file` flag\n\nFor YAML structure and configuration options, see [Agent Specification Format](#5.1).\n\n### Chat Provider Integration\n\nLLM integration is abstracted through the `kosong` library's `ChatProvider` interface:\n- `KimiChatProvider`: Moonshot Kimi API\n- `OpenAIChatProvider`: OpenAI-compatible APIs\n- `ChaosChatProvider`: Random responses for testing\n- Custom providers can implement the `ChatProvider` interface\n\nFor provider configuration, see [LLM Provider Configuration](#8.1).\n\n### UI Mode Implementation\n\nThree UI modes are available:\n- `ShellApp`: Interactive shell with rich rendering and prompt_toolkit\n- `PrintApp`: Non-interactive text/JSON output for pipelines\n- `ACPServer`: Agent Client Protocol server for programmatic access\n\nCustom UI modes can consume events from the `Wire` event queue and implement custom rendering logic.\n\n**Sources:** [Makefile:1-25](), [tests/conftest.py:1-225]()\n\n## Code Quality Standards\n\n### Linting and Formatting\n\n**Auto-format code** [Makefile:5-8]():\n```bash\nmake format\n```\nExecutes:\n- `uv run ruff check --fix`: Auto-fix linting issues\n- `uv run ruff format`: Format code\n\n**Check without modifying** [Makefile:10-14]():\n```bash\nmake check\n```\nExecutes:\n- `uv run ruff check`: Linting\n- `uv run ruff format --check`: Format verification\n- `uv run pyright`: Type checking\n\n### Type Checking Requirements\n\nAll code must include type annotations and pass `pyright` strict checks:\n- Configuration: [pyrightconfig.json:1-9]()\n- Includes: `src/**/*.py`, `tests/**/*.py`\n- Excludes: `**/__pycache__/**/*.py`\n\n### Testing Requirements\n\nAll contributions should include tests:\n- **Unit tests**: Test individual functions/classes in isolation\n- **Integration tests**: Test tool interactions and agent execution\n- **Fixture usage**: Use fixtures from [tests/conftest.py:1-225]() for dependency injection\n- **Pattern consistency**: Follow existing test patterns in `tests/test_*.py`\n\n**Sources:** [Makefile:1-25](), [pyrightconfig.json:1-9](), [tests/conftest.py:1-225]()\n\n## Debugging and Development Tips\n\n### Selective Test Execution\n\n```bash\n# Run specific test file\nuv run pytest tests/test_load_agent.py -vv\n\n# Run specific test function\nuv run pytest tests/test_load_agent.py::test_load_agent_basic -vv\n\n# Run tests matching pattern\nuv run pytest tests -k \"load_agent\" -vv\n\n# Show print statements\nuv run pytest tests -vv -s\n```\n\n### Binary Testing\n\nAfter building with `make build`, test the binary locally:\n\n```bash\n# Verify help output\n./dist/kimi --help\n\n# Check version\n./dist/kimi --version\n\n# Test basic functionality\n./dist/kimi \"list files in current directory\"\n\n# Test with specific agent\n./dist/kimi --agent-file ./path/to/agent.yaml \"task description\"\n```\n\n### Mock LLM for Testing\n\nTests use `MockChatProvider` for deterministic testing without API calls [tests/conftest.py:44-47]():\n\n```python\nfrom kosong.chat_provider import MockChatProvider\nfrom kimi_cli.llm import LLM\n\nllm = LLM(\n    chat_provider=MockChatProvider([]),\n    max_context_size=100_000\n)\n```\n\nThe empty list `[]` means no predefined responses; tests should mock specific interactions as needed.\n\n### Tool Call Context for Tests\n\nWhen testing tools that require approval or tool call context, use:\n\n**Option 1: Tool-specific fixtures**\n```python\ndef test_my_tool(bash_tool: Bash):\n    # bash_tool fixture already wraps tool_call_context\n    result = bash_tool.execute(command=\"echo test\")\n```\n\n**Option 2: Manual context**\n```python\nfrom tests.conftest import tool_call_context\n\ndef test_custom():\n    with tool_call_context(\"MyTool\"):\n        # Tool execution here\n        pass\n```\n\n**Sources:** [Makefile:1-25](), [tests/conftest.py:1-225]()\n\n## Platform-Specific Considerations\n\n### Supported Platforms\n\nThe build system supports the following platforms through automatic detection:\n\n| OS | Architecture | Target Identifier |\n|----|--------------|-------------------|\n| macOS | ARM64 (M1/M2/M3) | `aarch64-apple-darwin` |\n| macOS | Intel x86_64 | `x86_64-apple-darwin` |\n| Linux | x86_64 | `x86_64-unknown-linux-musl` |\n| Linux | ARM64 | `aarch64-unknown-linux-gnu` |\n| Linux | ARMv7 | `arm-unknown-linux-gnueabihf` |\n\n### Binary Dependencies\n\nThe `ripgrep` binary is platform-specific and managed automatically:\n- Download URL: `https://github.com/BurntSushi/ripgrep/releases/download/{VERSION}/ripgrep-{VERSION}-{TARGET}.tar.gz`\n- Installation path: `src/kimi_ci/deps/bin/rg`\n- Version: Configurable via `RG_VERSION` environment variable (default: 15.0.0)\n\nThe [src/kimi_cli/deps/Makefile:1-63]() handles detection, download, and installation automatically during `make prepare`.\n\n### PyInstaller Packaging\n\nPyInstaller bundles the Python interpreter, dependencies, and platform-specific binaries into a single executable. The `kimi.spec` file (not shown in provided files) configures:\n- Entry point: `src/kimi_cli/__init__.py:main()`\n- Data files: Agent definitions, system prompts\n- Binary files: `src/kimi_cli/deps/bin/rg`\n- Output: Single-file executable at `dist/kimi`\n\n### CI/CD Platform Matrix\n\n**CI Workflow** [.github/workflows/ci.yml:10-23]():\n- Active: `ubuntu-22.04` (x86_64)\n- Commented out: ARM Linux, macOS Intel, macOS ARM\n\n**Release Workflow** [.github/workflows/release.yml:13-27]():\n- Active: `ubuntu-22.04` (x86_64), `macos-13` (Intel), `macos-14` (ARM)\n\nThe release workflow provides binaries for all major platforms, while CI focuses on Linux for faster feedback.\n\n**Sources:** [.github/workflows/ci.yml:1-62](), [.github/workflows/release.yml:1-137](), [src/kimi_cli/deps/Makefile:1-63]()"])</script><script>self.__next_f.push([1,"37:T3fa6,"])</script><script>self.__next_f.push([1,"# Build System\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.github/workflows/ci.yml](.github/workflows/ci.yml)\n- [.github/workflows/release.yml](.github/workflows/release.yml)\n- [CHANGELOG.md](CHANGELOG.md)\n- [Makefile](Makefile)\n- [pyproject.toml](pyproject.toml)\n- [pyrightconfig.json](pyrightconfig.json)\n- [src/kimi_cli/deps/Makefile](src/kimi_cli/deps/Makefile)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\nThis document describes the build and development infrastructure for kimi-cli, including dependency management, code quality tooling, binary compilation, and CI/CD pipelines. For deployment and distribution details, see the Release Process section in [9.4](#9.4). For testing infrastructure, see [9.2](#9.2).\n\n## Overview\n\nThe kimi-cli build system is centered around three core technologies:\n\n- **uv**: Fast Python package manager for dependency resolution and virtual environment management\n- **PyInstaller**: Bundles the Python application into standalone executables for distribution\n- **Makefile**: Orchestrates all build, test, and quality control tasks\n\nThe system supports building standalone binaries for three platforms: Linux x86_64, macOS Intel (x86_64), and macOS ARM (aarch64). All builds include the Python runtime and third-party dependencies, plus the `ripgrep` binary for grep functionality.\n\n**Sources:** [pyproject.toml:1-60](), [Makefile:1-25]()\n\n## Build System Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Source Code\"\n        PY[\"src/kimi_cli/**/*.py\"]\n        TOML[\"pyproject.toml\"]\n        SPEC[\"kimi.spec\"]\n    end\n    \n    subgraph \"Dependency Management\"\n        UV[\"uv\u003cbr/\u003ePackage Manager\"]\n        LOCK[\"uv.lock\"]\n        VENV[\".venv/\u003cbr/\u003eVirtual Environment\"]\n        DEPS_MK[\"src/kimi_cli/deps/Makefile\"]\n        RG[\"bin/rg\u003cbr/\u003eripgrep binary\"]\n    end\n    \n    subgraph \"Quality Tools\"\n        RUFF[\"ruff\u003cbr/\u003eLinter \u0026 Formatter\"]\n        PYRIGHT[\"pyright\u003cbr/\u003eType Checker\"]\n        PYTEST[\"pytest\u003cbr/\u003eTest Runner\"]\n    end\n    \n    subgraph \"Build Tools\"\n        PYINSTALLER[\"PyInstaller\"]\n        DIST[\"dist/kimi\u003cbr/\u003eStandalone Binary\"]\n    end\n    \n    subgraph \"Makefile Targets\"\n        PREPARE[\"make prepare\"]\n        FORMAT[\"make format\"]\n        CHECK[\"make check\"]\n        TEST[\"make test\"]\n        BUILD[\"make build\"]\n    end\n    \n    TOML --\u003e UV\n    UV --\u003e LOCK\n    UV --\u003e VENV\n    \n    PREPARE --\u003e UV\n    PREPARE --\u003e DEPS_MK\n    DEPS_MK --\u003e RG\n    \n    FORMAT --\u003e RUFF\n    CHECK --\u003e RUFF\n    CHECK --\u003e PYRIGHT\n    TEST --\u003e PYTEST\n    \n    RUFF --\u003e PY\n    PYRIGHT --\u003e PY\n    PYTEST --\u003e PY\n    \n    BUILD --\u003e PYINSTALLER\n    PYINSTALLER --\u003e SPEC\n    SPEC --\u003e PY\n    SPEC --\u003e VENV\n    SPEC --\u003e RG\n    PYINSTALLER --\u003e DIST\n    \n    VENV --\u003e RUFF\n    VENV --\u003e PYRIGHT\n    VENV --\u003e PYTEST\n```\n\n**Sources:** [pyproject.toml:1-60](), [Makefile:1-25](), [src/kimi_cli/deps/Makefile:1-63]()\n\n## Dependency Management with uv\n\nThe project uses `uv` version 0.8.5 as its package manager, configured through `pyproject.toml`. Dependencies are organized into two groups:\n\n| Dependency Type | Location | Purpose |\n|----------------|----------|---------|\n| Runtime Dependencies | `[project.dependencies]` | Required for application execution (e.g., `click`, `kosong`, `rich`) |\n| Development Dependencies | `[dependency-groups.dev]` | Required for development only (e.g., `pytest`, `pyright`, `ruff`) |\n\n### Package Configuration\n\nThe project is configured as a standard Python package:\n\n```\n[project]\nname = \"kimi-cli\"\nversion = \"0.39\"\nrequires-python = \"\u003e=3.13\"\n```\n\nThe `[project.scripts]` section defines the CLI entry point:\n\n```\n[project.scripts]\nkimi = \"kimi_cli:main\"\n```\n\nThis creates the `kimi` command that invokes the `main()` function in `kimi_cli/__init__.py`.\n\n**Sources:** [pyproject.toml:1-46]()\n\n### Build Backend Configuration\n\nThe project uses `uv_build` as the build backend, with specific exclusions:\n\n```\n[build-system]\nrequires = [\"uv_build\u003e=0.8.5,\u003c0.9.0\"]\nbuild-backend = \"uv_build\"\n\n[tool.uv.build-backend]\nmodule-name = [\"kimi_cli\"]\nsource-exclude = [\"tests/**/*\", \"src/kimi_cli/deps/**/*\"]\n```\n\nThis configuration excludes test files and the `deps/` directory (which contains downloaded binaries) from the built distribution.\n\n**Sources:** [pyproject.toml:37-43]()\n\n### Dependency Synchronization\n\nThe `make prepare` target initializes the development environment:\n\n```makefile\nprepare: download-deps\n\tuv sync --frozen\n```\n\nThe `--frozen` flag ensures that dependencies are installed exactly as specified in `uv.lock`, preventing unexpected version changes. This target also downloads external dependencies via the included Makefile.\n\n**Sources:** [Makefile:1-3]()\n\n## Code Quality Tools\n\n### Ruff Configuration\n\nRuff serves as both linter and formatter, configured in `pyproject.toml`:\n\n```\n[tool.ruff]\nline-length = 100\n\n[tool.ruff.lint]\nselect = [\n    \"E\",   # pycodestyle\n    \"F\",   # Pyflakes\n    \"UP\",  # pyupgrade\n    \"B\",   # flake8-bugbear\n    \"SIM\", # flake8-simplify\n    \"I\",   # isort\n]\n```\n\n| Rule Set | Purpose |\n|----------|---------|\n| E | pycodestyle errors (PEP 8 violations) |\n| F | Pyflakes errors (undefined names, unused imports) |\n| UP | pyupgrade suggestions (modernize Python syntax) |\n| B | flake8-bugbear (detect common bugs) |\n| SIM | flake8-simplify (simplify code patterns) |\n| I | isort (sort imports) |\n\nTwo Makefile targets use Ruff:\n\n```makefile\nformat:\n\tuv run ruff check --fix\n\tuv run ruff format\n\ncheck:\n\tuv run ruff check\n\tuv run ruff format --check\n```\n\nThe `format` target applies automatic fixes, while `check` validates without modification.\n\n**Sources:** [pyproject.toml:48-59](), [Makefile:5-14]()\n\n### Pyright Configuration\n\nType checking is performed by Pyright, configured via `pyrightconfig.json`:\n\n```json\n{\n    \"include\": [\n        \"src/**/*.py\",\n        \"tests/**/*.py\"\n    ],\n    \"exclude\": [\n        \"**/__pycache__/**/*.py\",\n    ]\n}\n```\n\nInvoked via `uv run pyright` in the `check` target.\n\n**Sources:** [pyrightconfig.json:1-9](), [Makefile:14]()\n\n## Binary Building with PyInstaller\n\n### Build Process Flow\n\n```mermaid\nsequenceDiagram\n    participant Dev as Developer\n    participant Make as Makefile\n    participant UV as uv\n    participant PyInst as PyInstaller\n    participant Spec as kimi.spec\n    participant FS as File System\n    \n    Dev-\u003e\u003eMake: make build\n    Make-\u003e\u003eUV: uv run pyinstaller kimi.spec\n    \n    UV-\u003e\u003ePyInst: Launch in virtual environment\n    PyInst-\u003e\u003eSpec: Read build configuration\n    \n    Note over Spec: Defines entry point,\u003cbr/\u003eincludes, excludes,\u003cbr/\u003ebinary dependencies\n    \n    Spec-\u003e\u003ePyInst: Return configuration\n    \n    PyInst-\u003e\u003eFS: Collect Python sources\u003cbr/\u003efrom src/kimi_cli/\n    PyInst-\u003e\u003eFS: Collect dependencies\u003cbr/\u003efrom .venv/\n    PyInst-\u003e\u003eFS: Include ripgrep binary\u003cbr/\u003efrom src/kimi_cli/deps/bin/rg\n    \n    PyInst-\u003e\u003ePyInst: Analyze imports\n    PyInst-\u003e\u003ePyInst: Bundle Python runtime\n    PyInst-\u003e\u003ePyInst: Create executable\n    \n    PyInst-\u003e\u003eFS: Write dist/kimi\n    PyInst--\u003e\u003eMake: Build complete\n    Make--\u003e\u003eDev: Binary ready at dist/kimi\n```\n\n**Sources:** [Makefile:20-22]()\n\n### PyInstaller Specification\n\nWhile `kimi.spec` is not provided in the files, it is referenced in the build command. Based on the project structure, the spec file would typically include:\n\n- **Entry Point**: `kimi_cli:main` (as defined in `pyproject.toml`)\n- **Data Files**: `src/kimi_cli/deps/bin/rg` (ripgrep binary)\n- **Hidden Imports**: Agent definitions, tool modules, potentially MCP dependencies\n- **Excludes**: Test files, development tools\n\nThe PyInstaller process:\n1. Analyzes the `kimi_cli` module and its imports\n2. Collects all required Python files and dependencies from `.venv/`\n3. Includes the ripgrep binary from `src/kimi_cli/deps/bin/rg`\n4. Bundles the Python interpreter\n5. Produces a single executable in `dist/kimi`\n\n**Sources:** [Makefile:20-22](), [pyproject.toml:45-46]()\n\n## External Dependency Management\n\n### Ripgrep Binary Download\n\nThe `Grep` tool requires the `ripgrep` (`rg`) binary. The build system automatically downloads the appropriate binary for the target platform:\n\n```mermaid\ngraph LR\n    subgraph \"Platform Detection\"\n        UNAME[\"uname -s\u003cbr/\u003euname -m\"]\n        OS[\"OS: Darwin/Linux\"]\n        ARCH[\"ARCH: x86_64/arm64/aarch64\"]\n    end\n    \n    subgraph \"Target Selection\"\n        MAP[\"Platform Mapping\"]\n        TARGET[\"RG_TARGET\u003cbr/\u003ee.g., x86_64-unknown-linux-musl\"]\n    end\n    \n    subgraph \"Download \u0026 Install\"\n        URL[\"GitHub Release URL\"]\n        DOWNLOAD[\"curl/wget download\"]\n        EXTRACT[\"tar -xzf\"]\n        INSTALL[\"cp to bin/rg\"]\n    end\n    \n    UNAME --\u003e OS\n    UNAME --\u003e ARCH\n    OS --\u003e MAP\n    ARCH --\u003e MAP\n    MAP --\u003e TARGET\n    TARGET --\u003e URL\n    URL --\u003e DOWNLOAD\n    DOWNLOAD --\u003e EXTRACT\n    EXTRACT --\u003e INSTALL\n```\n\n### Platform Target Mapping\n\nThe `src/kimi_cli/deps/Makefile` implements platform detection:\n\n```makefile\nifeq ($(OS),Darwin)\n  ifeq ($(ARCH),arm64)\n    RG_TARGET := aarch64-apple-darwin\n  else ifeq ($(ARCH),x86_64)\n    RG_TARGET := x86_64-apple-darwin\n```\n\n| Host OS | Host Architecture | ripgrep Target |\n|---------|------------------|----------------|\n| Darwin | arm64 | aarch64-apple-darwin |\n| Darwin | x86_64 | x86_64-apple-darwin |\n| Linux | x86_64 | x86_64-unknown-linux-musl |\n| Linux | aarch64 | aarch64-unknown-linux-gnu |\n| Linux | armv7l | arm-unknown-linux-gnueabihf |\n\nThe download process constructs a URL:\n\n```\nhttps://github.com/BurntSushi/ripgrep/releases/download/\n  {RG_VERSION}/ripgrep-{RG_VERSION}-{RG_TARGET}.tar.gz\n```\n\nWhere `RG_VERSION` defaults to `15.0.0` but can be overridden via environment variable.\n\n**Sources:** [src/kimi_cli/deps/Makefile:1-63]()\n\n### Download Implementation\n\nThe `download-ripgrep` target checks if `rg` already exists before downloading:\n\n```makefile\ndownload-ripgrep:\n\t@if [ -f \"$(BIN_DIR)/rg\" ]; then \\\n\t\techo \"rg already installed at $(BIN_DIR)/rg\"; \\\n\telse \\\n\t\t# Download logic...\n```\n\nThe download uses `curl` if available, falling back to `wget`:\n\n```makefile\nif command -v curl \u003e/dev/null 2\u003e\u00261; then \\\n    curl -L --fail -o \"$(TMP_DIR)/$(RG_TAR)\" \"$(RG_URL)\"; \\\nelse \\\n    if command -v wget \u003e/dev/null 2\u003e\u00261; then \\\n        wget -O \"$(TMP_DIR)/$(RG_TAR)\" \"$(RG_URL)\"; \\\n```\n\nAfter downloading, the tarball is extracted and the binary is copied to `$(BIN_DIR)/rg` with execute permissions.\n\n**Sources:** [src/kimi_cli/deps/Makefile:38-58]()\n\n## Makefile Targets Reference\n\n| Target | Dependencies | Description |\n|--------|--------------|-------------|\n| `prepare` | `download-deps` | Downloads ripgrep and syncs Python dependencies via `uv sync --frozen` |\n| `format` | - | Applies ruff formatting and auto-fixes to source code |\n| `check` | - | Validates code with ruff linting, format checking, and pyright type checking |\n| `test` | - | Runs pytest test suite with verbose output |\n| `build` | - | Builds standalone binary using PyInstaller and `kimi.spec` |\n| `download-deps` | `download-ripgrep` | Downloads all external binary dependencies |\n| `download-ripgrep` | - | Downloads ripgrep binary for current platform |\n\n### Development Workflow\n\nTypical development workflow:\n\n```bash\n# Initial setup\nmake prepare\n\n# During development\nmake format      # Format code\nmake check       # Validate code quality\nmake test        # Run tests\n\n# Build binary\nmake build       # Creates dist/kimi\n```\n\n**Sources:** [Makefile:1-25](), [src/kimi_cli/deps/Makefile:61-62]()\n\n## CI/CD Integration\n\n### CI Workflow\n\nThe `.github/workflows/ci.yml` workflow runs on every pull request and push to `main`:\n\n```mermaid\ngraph TB\n    subgraph \"Trigger Events\"\n        PR[\"Pull Request\"]\n        PUSH[\"Push to main\"]\n    end\n    \n    subgraph \"CI Job: test\"\n        SETUP[\"Setup:\u003cbr/\u003ePython 3.13\u003cbr/\u003euv 0.8.5\"]\n        PREPARE[\"make prepare\"]\n        CHECK[\"make check\"]\n        TEST[\"make test\"]\n        BUILD[\"make build\"]\n        SMOKE[\"./dist/kimi --help\"]\n        UPLOAD[\"Upload Artifact\u003cbr/\u003e7-day retention\"]\n    end\n    \n    PR --\u003e SETUP\n    PUSH --\u003e SETUP\n    SETUP --\u003e PREPARE\n    PREPARE --\u003e CHECK\n    CHECK --\u003e TEST\n    TEST --\u003e BUILD\n    BUILD --\u003e SMOKE\n    SMOKE --\u003e UPLOAD\n```\n\nThe CI job runs on `ubuntu-22.04` for the `x86_64-unknown-linux-gnu` target. Matrix configuration exists for additional platforms but is commented out:\n\n```yaml\nmatrix:\n  include:\n    - runner: ubuntu-22.04\n      target: x86_64-unknown-linux-gnu\n    # - runner: ubuntu-22.04-arm\n    #   target: aarch64-unknown-linux-gnu\n    # - runner: macos-13\n    #   target: x86_64-apple-darwin\n    # - runner: macos-14\n    #   target: aarch64-apple-darwin\n```\n\nThe workflow produces an artifact named `kimi-{target}` containing the built binary with 7-day retention.\n\n**Sources:** [.github/workflows/ci.yml:1-62]()\n\n### Release Workflow\n\nThe `.github/workflows/release.yml` workflow activates on:\n- Git tag pushes (any tag matching `*`)\n- Manual workflow dispatch\n\n```mermaid\ngraph TB\n    subgraph \"Trigger\"\n        TAG[\"Push Tag\"]\n        MANUAL[\"Manual Dispatch\"]\n    end\n    \n    subgraph \"Build Job (x3 platforms)\"\n        SETUP_B[\"Setup Environment\"]\n        PREPARE_B[\"make prepare\"]\n        BUILD_B[\"make build\"]\n        PACKAGE[\"tar -czf artifacts/\"]\n        UPLOAD_B[\"Upload Artifact\"]\n    end\n    \n    subgraph \"Release Job\"\n        DOWNLOAD[\"Download Artifacts\"]\n        SHA[\"Generate SHA256\"]\n        GH_RELEASE[\"Create GitHub Release\u003cbr/\u003e+ Upload Assets\"]\n    end\n    \n    subgraph \"PyPI Job\"\n        SETUP_P[\"Setup Environment\"]\n        BUILD_P[\"uv build\u003cbr/\u003e(sdist + wheel)\"]\n        PUBLISH[\"Publish to PyPI\"]\n    end\n    \n    TAG --\u003e SETUP_B\n    MANUAL --\u003e SETUP_B\n    SETUP_B --\u003e PREPARE_B\n    PREPARE_B --\u003e BUILD_B\n    BUILD_B --\u003e PACKAGE\n    PACKAGE --\u003e UPLOAD_B\n    \n    UPLOAD_B --\u003e DOWNLOAD\n    DOWNLOAD --\u003e SHA\n    SHA --\u003e GH_RELEASE\n    \n    TAG --\u003e SETUP_P\n    MANUAL --\u003e SETUP_P\n    SETUP_P --\u003e BUILD_P\n    BUILD_P --\u003e PUBLISH\n```\n\nThe release workflow builds binaries for three platforms in parallel:\n\n| Runner | Target Platform |\n|--------|----------------|\n| ubuntu-22.04 | x86_64-unknown-linux-gnu |\n| macos-13 | x86_64-apple-darwin |\n| macos-14 | aarch64-apple-darwin |\n\nEach build produces a tarball: `kimi-{TAG}-{TARGET}.tar.gz`\n\n**Sources:** [.github/workflows/release.yml:1-137]()\n\n### Binary Packaging\n\nThe release workflow packages binaries with SHA256 checksums:\n\n```bash\n# Package binary as tar.gz\ncp dist/kimi artifacts/kimi\nFILENAME=\"kimi-${TAG}-${{ matrix.target }}.tar.gz\"\ntar -C artifacts -czf \"artifacts/${FILENAME}\" kimi\n\n# Generate SHA256\nfor f in *.tar.gz; do\n  sha256sum \"$f\" \u003e \"$f.sha256\"\ndone\n```\n\nThe `release` job then creates a GitHub Release and attaches:\n- `kimi-{TAG}-{TARGET}.tar.gz` (binary tarball)\n- `kimi-{TAG}-{TARGET}.tar.gz.sha256` (checksum file)\n\n**Sources:** [.github/workflows/release.yml:49-96]()\n\n### Python Package Publishing\n\nThe `publish-python` job runs independently, building and publishing to PyPI:\n\n```yaml\n- name: Build distributions\n  run: uv build\n\n- name: Publish to PyPI\n  uses: pypa/gh-action-pypi-publish@release/v1\n  with:\n    user: __token__\n    password: ${{ secrets.PYPI_API_TOKEN }}\n```\n\nThe `uv build` command uses the `uv_build` backend configuration to produce:\n- Source distribution (sdist): `.tar.gz` containing source code\n- Wheel distribution: `.whl` containing built package\n\nBoth distributions exclude tests and deps directories per the `source-exclude` configuration.\n\n**Sources:** [.github/workflows/release.yml:110-136](), [pyproject.toml:37-43]()\n\n## Build Reproducibility\n\nThe build system ensures reproducibility through:\n\n1. **Locked Dependencies**: `uv.lock` pins all transitive dependencies to specific versions\n2. **Frozen Sync**: `uv sync --frozen` prevents version drift during installation\n3. **Pinned Build Tools**: CI workflows specify exact versions:\n   - Python: `3.13` (with `allow-prereleases: true`)\n   - uv: `0.8.5`\n   - ripgrep: `15.0.0` (overridable via `RG_VERSION` env var)\n4. **Explicit Build Backend**: `uv_build\u003e=0.8.5,\u003c0.9.0` constrains the build backend version\n\nThese measures ensure that builds are consistent across development machines and CI environments.\n\n**Sources:** [pyproject.toml:37-39](), [Makefile:3](), [.github/workflows/ci.yml:28-37](), [.github/workflows/release.yml:32-41](), [src/kimi_cli/deps/Makefile:6]()"])</script><script>self.__next_f.push([1,"38:T44af,"])</script><script>self.__next_f.push([1,"# Testing\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.github/workflows/ci.yml](.github/workflows/ci.yml)\n- [.github/workflows/release.yml](.github/workflows/release.yml)\n- [Makefile](Makefile)\n- [pyrightconfig.json](pyrightconfig.json)\n- [src/kimi_cli/deps/Makefile](src/kimi_cli/deps/Makefile)\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the testing infrastructure for kimi-cli, including the pytest configuration, fixture system, test execution workflow, and continuous integration setup. It covers how tests are organized, how to run them, and how to write new tests using the provided fixture ecosystem.\n\nFor information about the build system and release process, see [Build System](#9.1) and [CI/CD and Release Process](#9.4).\n\n---\n\n## Test Infrastructure Overview\n\nThe kimi-cli testing system is built on pytest and provides a comprehensive fixture ecosystem for testing all components of the system. Tests are located in the `tests/` directory and use dependency injection through pytest fixtures to instantiate tools, agents, and supporting infrastructure.\n\n**Architecture Diagram: Test Infrastructure Components**\n\n```mermaid\ngraph TB\n    subgraph \"Test Execution\"\n        Makefile[\"Makefile\u003cbr/\u003etest target\"]\n        Pytest[\"pytest\"]\n        TestFiles[\"Test Files\u003cbr/\u003etest_*.py\"]\n    end\n    \n    subgraph \"Fixture System\"\n        Conftest[\"conftest.py\u003cbr/\u003eCore Fixtures\"]\n        Config[\"config fixture\"]\n        LLM[\"llm fixture\"]\n        AgentGlobals[\"agent_globals fixture\"]\n        TempDirs[\"temp_work_dir\u003cbr/\u003etemp_share_dir\"]\n        ToolFixtures[\"Tool Fixtures\u003cbr/\u003e*_tool\"]\n    end\n    \n    subgraph \"Test Utilities\"\n        ToolCallContext[\"tool_call_context()\u003cbr/\u003eContext Manager\"]\n        MockChatProvider[\"MockChatProvider\"]\n        InlineSnapshot[\"inline-snapshot\"]\n    end\n    \n    subgraph \"Type Checking\"\n        Pyright[\"pyright\"]\n        PyrightConfig[\"pyrightconfig.json\"]\n    end\n    \n    subgraph \"Linting\"\n        Ruff[\"ruff check\u003cbr/\u003eruff format\"]\n    end\n    \n    Makefile --\u003e Pytest\n    Makefile --\u003e Pyright\n    Makefile --\u003e Ruff\n    \n    Pytest --\u003e TestFiles\n    TestFiles --\u003e Conftest\n    TestFiles --\u003e ToolCallContext\n    TestFiles --\u003e InlineSnapshot\n    \n    Conftest --\u003e Config\n    Conftest --\u003e LLM\n    Conftest --\u003e AgentGlobals\n    Conftest --\u003e TempDirs\n    Conftest --\u003e ToolFixtures\n    \n    LLM --\u003e MockChatProvider\n    ToolFixtures --\u003e ToolCallContext\n    \n    Pyright --\u003e PyrightConfig\n```\n\n**Sources**: [tests/conftest.py:1-225](), [Makefile:1-25](), [pyrightconfig.json:1-9]()\n\n---\n\n## Pytest Configuration and Fixtures\n\n### Core Fixture System\n\nThe fixture system in [tests/conftest.py:1-225]() provides reusable test components through dependency injection. Fixtures are organized hierarchically, with complex fixtures depending on simpler ones.\n\n**Fixture Dependency Graph**\n\n```mermaid\ngraph TB\n    config[\"config\u003cbr/\u003eConfig\"]\n    llm[\"llm\u003cbr/\u003eLLM\"]\n    temp_work_dir[\"temp_work_dir\u003cbr/\u003ePath\"]\n    temp_share_dir[\"temp_share_dir\u003cbr/\u003ePath\"]\n    builtin_args[\"builtin_args\u003cbr/\u003eBuiltinSystemPromptArgs\"]\n    denwa_renji[\"denwa_renji\u003cbr/\u003eDenwaRenji\"]\n    session[\"session\u003cbr/\u003eSession\"]\n    approval[\"approval\u003cbr/\u003eApproval\"]\n    \n    agent_globals[\"agent_globals\u003cbr/\u003eAgentGlobals\"]\n    agent_spec[\"agent_spec\u003cbr/\u003eAgentSpec\"]\n    \n    task_tool[\"task_tool\u003cbr/\u003eTask\"]\n    send_dmail_tool[\"send_dmail_tool\u003cbr/\u003eSendDMail\"]\n    think_tool[\"think_tool\u003cbr/\u003eThink\"]\n    set_todo_list_tool[\"set_todo_list_tool\u003cbr/\u003eSetTodoList\"]\n    bash_tool[\"bash_tool\u003cbr/\u003eBash\"]\n    \n    read_file_tool[\"read_file_tool\u003cbr/\u003eReadFile\"]\n    glob_tool[\"glob_tool\u003cbr/\u003eGlob\"]\n    grep_tool[\"grep_tool\u003cbr/\u003eGrep\"]\n    write_file_tool[\"write_file_tool\u003cbr/\u003eWriteFile\"]\n    str_replace_file_tool[\"str_replace_file_tool\u003cbr/\u003eStrReplaceFile\"]\n    patch_file_tool[\"patch_file_tool\u003cbr/\u003ePatchFile\"]\n    \n    search_web_tool[\"search_web_tool\u003cbr/\u003eSearchWeb\"]\n    fetch_url_tool[\"fetch_url_tool\u003cbr/\u003eFetchURL\"]\n    \n    temp_work_dir --\u003e builtin_args\n    temp_work_dir --\u003e session\n    temp_share_dir --\u003e session\n    \n    config --\u003e agent_globals\n    llm --\u003e agent_globals\n    builtin_args --\u003e agent_globals\n    denwa_renji --\u003e agent_globals\n    session --\u003e agent_globals\n    approval --\u003e agent_globals\n    \n    agent_spec --\u003e task_tool\n    agent_globals --\u003e task_tool\n    \n    denwa_renji --\u003e send_dmail_tool\n    \n    approval --\u003e bash_tool\n    \n    builtin_args --\u003e read_file_tool\n    builtin_args --\u003e glob_tool\n    builtin_args --\u003e write_file_tool\n    builtin_args --\u003e str_replace_file_tool\n    builtin_args --\u003e patch_file_tool\n    \n    approval --\u003e write_file_tool\n    approval --\u003e str_replace_file_tool\n    approval --\u003e patch_file_tool\n    \n    config --\u003e search_web_tool\n```\n\n**Sources**: [tests/conftest.py:38-224]()\n\n### Fixture Categories\n\n| Category | Fixtures | Purpose |\n|----------|----------|---------|\n| **Configuration** | `config`, `llm` | Provide Config and LLM instances |\n| **Temporary Resources** | `temp_work_dir`, `temp_share_dir` | Create isolated temporary directories |\n| **Agent Infrastructure** | `builtin_args`, `denwa_renji`, `session`, `approval` | Provide agent execution dependencies |\n| **Aggregators** | `agent_globals`, `agent_spec` | Combine dependencies for agent initialization |\n| **Tools** | `*_tool` (16 fixtures) | Instantiate individual tool instances |\n\n**Sources**: [tests/conftest.py:38-224]()\n\n### Key Fixture Implementations\n\n#### Configuration Fixtures\n\n```python\n# From tests/conftest.py:38-47\n```\n\nThe `config` fixture returns the default configuration from [kimi_cli.config:get_default_config](). The `llm` fixture creates an LLM instance with a `MockChatProvider` for testing without real API calls.\n\n**Sources**: [tests/conftest.py:38-47]()\n\n#### Temporary Directory Fixtures\n\n```python\n# From tests/conftest.py:50-61\n```\n\nThese fixtures use `tempfile.TemporaryDirectory()` to create isolated directories that are automatically cleaned up after tests complete. They return `Path` objects using Python's `Generator` type hint.\n\n**Sources**: [tests/conftest.py:50-61]()\n\n#### BuiltinSystemPromptArgs Fixture\n\n```python\n# From tests/conftest.py:64-72\n```\n\nThe `builtin_args` fixture provides a `BuiltinSystemPromptArgs` instance with:\n- Fixed timestamp: `\"1970-01-01T00:00:00+00:00\"`\n- Temporary work directory\n- Test placeholder content for ls output and agents.md\n\n**Sources**: [tests/conftest.py:64-72]()\n\n#### AgentGlobals Fixture\n\n```python\n# From tests/conftest.py:97-114\n```\n\nThe `agent_globals` fixture aggregates all dependencies required by agents and tools into a single container. This is the primary dependency injection mechanism for agent initialization.\n\n**Sources**: [tests/conftest.py:97-114]()\n\n#### Tool Fixtures with Context Management\n\nSome tool fixtures require a tool call context to be active. The `tool_call_context` helper creates this context:\n\n```python\n# From tests/conftest.py:123-136\n```\n\nTool fixtures that need approval (Bash, WriteFile, StrReplaceFile, PatchFile) use this context manager:\n\n```python\n# Example from tests/conftest.py:163-167\n@pytest.fixture\ndef bash_tool(approval: Approval) -\u003e Generator[Bash]:\n    \"\"\"Create a Bash tool instance.\"\"\"\n    with tool_call_context(\"Bash\"):\n        yield Bash(approval)\n```\n\n**Sources**: [tests/conftest.py:123-136](), [tests/conftest.py:163-213]()\n\n---\n\n## Test Execution\n\n### Local Test Execution\n\nTests are executed locally using Make targets:\n\n| Command | Purpose |\n|---------|---------|\n| `make test` | Run all tests with verbose output |\n| `make check` | Run linting (ruff) and type checking (pyright) |\n| `make format` | Auto-format code with ruff |\n\n**Test Execution Flow**\n\n```mermaid\nsequenceDiagram\n    participant Dev as Developer\n    participant Make as Makefile\n    participant UV as uv\n    participant Pytest as pytest\n    participant Tests as Test Files\n    participant Fixtures as Fixtures\n    \n    Dev-\u003e\u003eMake: make test\n    Make-\u003e\u003eUV: uv run pytest tests -vv\n    UV-\u003e\u003ePytest: Execute with args\n    \n    Pytest-\u003e\u003eTests: Discover test_*.py\n    Tests-\u003e\u003eFixtures: Request fixtures\n    Fixtures-\u003e\u003eFixtures: Build dependency tree\n    Fixtures--\u003e\u003eTests: Provide instances\n    \n    Tests-\u003e\u003eTests: Execute test functions\n    Tests--\u003e\u003ePytest: Report results\n    Pytest--\u003e\u003eUV: Exit code + output\n    UV--\u003e\u003eMake: Exit code\n    Make--\u003e\u003eDev: Display results\n```\n\n**Sources**: [Makefile:16-18]()\n\n### Test Command Details\n\nThe `make test` command executes:\n\n```bash\nuv run pytest tests -vv\n```\n\nThis runs pytest with:\n- `tests` directory as the target\n- `-vv` for very verbose output (shows test names and parameters)\n- Using `uv run` to ensure correct virtual environment activation\n\n**Sources**: [Makefile:16-18]()\n\n### Check Command\n\nThe `make check` command runs three validations:\n\n```bash\nuv run ruff check          # Linting\nuv run ruff format --check # Format verification\nuv run pyright             # Type checking\n```\n\nType checking configuration is defined in [pyrightconfig.json:1-9]():\n\n```json\n{\n    \"include\": [\n        \"src/**/*.py\",\n        \"tests/**/*.py\"\n    ],\n    \"exclude\": [\n        \"**/__pycache__/**/*.py\",\n    ]\n}\n```\n\n**Sources**: [Makefile:10-14](), [pyrightconfig.json:1-9]()\n\n---\n\n## Continuous Integration\n\n### CI Workflow Overview\n\nThe CI workflow in [.github/workflows/ci.yml:1-62]() runs on every pull request and push to the main branch. It performs a complete validation cycle including linting, type checking, testing, and binary building.\n\n**CI Workflow Structure**\n\n```mermaid\ngraph LR\n    subgraph Trigger[\"Trigger Events\"]\n        PR[\"Pull Request\"]\n        Push[\"Push to main\"]\n    end\n    \n    subgraph Setup[\"Setup Phase\"]\n        Checkout[\"Checkout Code\u003cbr/\u003eactions/checkout@v4\"]\n        SetupPython[\"Setup Python 3.13\u003cbr/\u003eactions/setup-python@v5\"]\n        SetupUV[\"Setup uv 0.8.5\u003cbr/\u003eastral-sh/setup-uv@v1\"]\n        Prepare[\"make prepare\u003cbr/\u003euv sync + download-deps\"]\n    end\n    \n    subgraph Validate[\"Validation Phase\"]\n        Check[\"make check\u003cbr/\u003eruff + pyright\"]\n        Test[\"make test\u003cbr/\u003epytest\"]\n    end\n    \n    subgraph Build[\"Build Phase\"]\n        BuildBinary[\"make build\u003cbr/\u003ePyInstaller\"]\n        SmokeTest[\"./dist/kimi --help\"]\n    end\n    \n    subgraph Artifact[\"Artifact Phase\"]\n        Upload[\"Upload Artifact\u003cbr/\u003e7-day retention\"]\n    end\n    \n    PR --\u003e Checkout\n    Push --\u003e Checkout\n    Checkout --\u003e SetupPython\n    SetupPython --\u003e SetupUV\n    SetupUV --\u003e Prepare\n    Prepare --\u003e Check\n    Check --\u003e Test\n    Test --\u003e BuildBinary\n    BuildBinary --\u003e SmokeTest\n    SmokeTest --\u003e Upload\n```\n\n**Sources**: [.github/workflows/ci.yml:1-62]()\n\n### CI Job Configuration\n\nThe CI job uses a matrix strategy but currently only runs on `ubuntu-22.04`:\n\n```yaml\n# From .github/workflows/ci.yml:10-23\nstrategy:\n  fail-fast: false\n  matrix:\n    include:\n      - runner: ubuntu-22.04\n        target: x86_64-unknown-linux-gnu\n      # macOS runners commented out for CI\n```\n\n**Sources**: [.github/workflows/ci.yml:10-23]()\n\n### CI Steps Detail\n\n| Step | Command | Purpose |\n|------|---------|---------|\n| Checkout | `actions/checkout@v4` | Clone repository |\n| Setup Python | `actions/setup-python@v5` | Install Python 3.13 |\n| Setup uv | `astral-sh/setup-uv@v1` | Install uv 0.8.5 |\n| Prepare | `make prepare` | Sync dependencies and download ripgrep |\n| Check | `make check` | Run linting and type checking |\n| Test | `make test` | Run pytest test suite |\n| Build | `make build` | Create standalone binary |\n| Smoke Test | `./dist/kimi --help` | Verify binary works |\n| Upload | `actions/upload-artifact@v4` | Store binary for 7 days |\n\n**Sources**: [.github/workflows/ci.yml:24-61]()\n\n### Dependency Preparation\n\nThe `make prepare` target ensures all dependencies are available:\n\n```bash\n# From Makefile:1-3\nprepare: download-deps\n    uv sync --frozen\n```\n\nThis downloads platform-specific binaries (ripgrep) and synchronizes Python dependencies.\n\n**Sources**: [Makefile:1-3](), [src/kimi_cli/deps/Makefile:1-63]()\n\n---\n\n## Writing Tests\n\n### Test File Organization\n\nTest files follow pytest conventions:\n- Located in `tests/` directory\n- Named with `test_*.py` pattern\n- Contain functions named `test_*`\n- Use fixtures via function parameters\n\n**Example Test Structure from test_load_agent.py**\n\n```python\n# From tests/test_load_agent.py:29-36\ndef test_load_agent_basic(agent_file: Path, agent_globals: AgentGlobals):\n    \"\"\"Test loading a basic agent configuration.\"\"\"\n    agent = load_agent(agent_file, agent_globals)\n\n    assert agent.name == \"Test Agent\"\n    assert \"You are a test agent\" in agent.system_prompt\n    assert agent.toolset is not None\n```\n\n**Sources**: [tests/test_load_agent.py:29-36]()\n\n### Using Fixtures in Tests\n\nTests request fixtures by including them as function parameters. Pytest automatically resolves dependencies:\n\n```python\n# From tests/test_load_agent.py:132-150\ndef test_load_tools_valid(agent_globals: AgentGlobals):\n    \"\"\"Test loading valid tools.\"\"\"\n    tool_paths = [\"kimi_cli.tools.think:Think\", \"kimi_cli.tools.bash:Bash\"]\n    toolset = CustomToolset()\n    bad_tools = _load_tools(\n        toolset,\n        tool_paths,\n        {\n            AgentGlobals: agent_globals,\n            Config: agent_globals.config,\n            BuiltinSystemPromptArgs: agent_globals.builtin_args,\n            Session: agent_globals.session,\n            DenwaRenji: agent_globals.denwa_renji,\n            Approval: agent_globals.approval,\n        },\n    )\n\n    assert len(bad_tools) == 0\n    assert toolset is not None\n```\n\n**Sources**: [tests/test_load_agent.py:132-150]()\n\n### Creating Test-Specific Fixtures\n\nTests can define their own fixtures for test-specific resources. These fixtures can depend on fixtures from `conftest.py`:\n\n```python\n# From tests/test_load_agent.py:235-255\n@pytest.fixture\ndef agent_file() -\u003e Generator[Path, Any, Any]:\n    \"\"\"Create a basic agent configuration file.\"\"\"\n    with tempfile.TemporaryDirectory() as tmpdir:\n        tmpdir = Path(tmpdir)\n\n        # Create system.md\n        system_md = tmpdir / \"system.md\"\n        system_md.write_text(\"You are a test agent\")\n\n        # Create agent.yaml\n        agent_yaml = tmpdir / \"agent.yaml\"\n        agent_yaml.write_text(\"\"\"\nversion: 1\nagent:\n  name: \"Test Agent\"\n  system_prompt_path: ./system.md\n  tools: [\"kimi_cli.tools.think:Think\"]\n\"\"\")\n\n        yield agent_yaml\n```\n\n**Sources**: [tests/test_load_agent.py:235-255]()\n\n### Using inline-snapshot\n\nThe codebase uses `inline-snapshot` for snapshot testing, which allows capturing and verifying complex output:\n\n```python\n# From tests/test_load_agent.py:93-100\nspec = _load_agent_spec(extending_agent)\n\nassert spec.name == snapshot(\"\")\nassert spec.system_prompt_path == DEFAULT_AGENT_FILE.parent / \"system.md\"\nassert spec.system_prompt_args == snapshot(\n    {\"ROLE_ADDITIONAL\": \"\", \"CUSTOM_ARG\": \"custom_value\"}\n)\n```\n\nThe `snapshot()` function records expected values on first run and verifies them on subsequent runs.\n\n**Sources**: [tests/test_load_agent.py:93-100]()\n\n### Testing Tools with Approval\n\nTools that require approval must be tested within a tool call context:\n\n```python\n# Pattern for testing approval tools\n@pytest.fixture\ndef write_file_tool(\n    builtin_args: BuiltinSystemPromptArgs, approval: Approval\n) -\u003e Generator[WriteFile]:\n    \"\"\"Create a WriteFile tool instance.\"\"\"\n    with tool_call_context(\"WriteFile\"):\n        yield WriteFile(builtin_args, approval)\n```\n\nThe `approval` fixture is configured with `yolo=True` to auto-approve during tests:\n\n```python\n# From tests/conftest.py:91-94\n@pytest.fixture\ndef approval() -\u003e Approval:\n    \"\"\"Create a Approval instance.\"\"\"\n    return Approval(yolo=True)\n```\n\n**Sources**: [tests/conftest.py:189-194](), [tests/conftest.py:91-94]()\n\n### Error Testing Patterns\n\nTests should verify error conditions using `pytest.raises`:\n\n```python\n# From tests/test_load_agent.py:38-41\ndef test_load_agent_missing_name(agent_file_no_name: Path, agent_globals: AgentGlobals):\n    \"\"\"Test loading agent with missing name raises ValueError.\"\"\"\n    with pytest.raises(ValueError, match=\"Agent name is required\"):\n        load_agent(agent_file_no_name, agent_globals)\n```\n\n**Sources**: [tests/test_load_agent.py:38-41]()\n\n### Test Isolation\n\nEach test should be isolated and not depend on other tests:\n\n1. **Use temporary directories**: Always use `temp_work_dir` and `temp_share_dir` fixtures\n2. **Create fresh fixtures**: Let pytest handle fixture creation and cleanup\n3. **No global state**: Avoid modifying global variables or environment\n4. **Independent assertions**: Each test should verify one specific behavior\n\n**Sources**: [tests/conftest.py:50-61](), [tests/test_load_agent.py:1-411]()\n\n---\n\n## Test Execution Reference\n\n### Running Specific Tests\n\n```bash\n# Run single test file\nuv run pytest tests/test_load_agent.py -vv\n\n# Run single test function\nuv run pytest tests/test_load_agent.py::test_load_agent_basic -vv\n\n# Run tests matching pattern\nuv run pytest tests -k \"load_agent\" -vv\n```\n\n### Useful Pytest Options\n\n| Option | Purpose |\n|--------|---------|\n| `-vv` | Very verbose output |\n| `-s` | Show print statements |\n| `-x` | Stop on first failure |\n| `--pdb` | Drop into debugger on failure |\n| `--lf` | Run only last failed tests |\n| `-k PATTERN` | Run tests matching pattern |\n\n### Debug Output\n\nTo see debug output during tests, use the `-s` flag:\n\n```bash\nuv run pytest tests/test_load_agent.py::test_load_agent_basic -vv -s\n```\n\n**Sources**: [Makefile:16-18]()"])</script><script>self.__next_f.push([1,"39:T5037,"])</script><script>self.__next_f.push([1,"# Creating Custom Tools\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [src/kimi_cli/soul/approval.py](src/kimi_cli/soul/approval.py)\n- [src/kimi_cli/soul/wire.py](src/kimi_cli/soul/wire.py)\n- [src/kimi_cli/tools/bash/__init__.py](src/kimi_cli/tools/bash/__init__.py)\n- [tests/conftest.py](tests/conftest.py)\n- [tests/test_fetch_url.py](tests/test_fetch_url.py)\n- [tests/test_load_agent.py](tests/test_load_agent.py)\n- [tests/test_tool_descriptions.py](tests/test_tool_descriptions.py)\n- [tests/test_tool_schemas.py](tests/test_tool_schemas.py)\n\n\u003c/details\u003e\n\n\n\nThis guide covers the process of creating custom tools that can be used by agents in kimi-cli. Tools are callable functions that agents can invoke to perform actions such as file operations, web requests, or system commands. For information about configuring which tools are available to agents, see [Agent Specification Format](#5.1). For a catalog of built-in tools, see [Tool System](#6).\n\n## Tool System Architecture\n\nThe kimi-cli tool system is built on the `kosong.tooling.CallableTool2` base class. Tools are dynamically loaded and instantiated through dependency injection, registered in a `CustomToolset`, and invoked by the agent during execution. The system supports both read-only operations and operations that require user approval.\n\n```mermaid\ngraph TB\n    subgraph \"Tool Definition\"\n        ToolClass[\"CallableTool2[Params]\u003cbr/\u003eBase class\"]\n        ParamsModel[\"Pydantic BaseModel\u003cbr/\u003eParameter schema\"]\n        CallMethod[\"async __call__()\u003cbr/\u003eImplementation\"]\n        ToolDesc[\"Tool description\u003cbr/\u003eMarkdown file\"]\n    end\n    \n    subgraph \"Tool Infrastructure\"\n        AgentGlobals[\"AgentGlobals\u003cbr/\u003eDependency container\"]\n        CustomToolset[\"CustomToolset\u003cbr/\u003eTool registry\"]\n        ToolLoader[\"_load_tools()\u003cbr/\u003eDynamic loading\"]\n    end\n    \n    subgraph \"Execution Context\"\n        CurrentToolCall[\"current_tool_call\u003cbr/\u003eContextVar\"]\n        Wire[\"Wire\u003cbr/\u003eEvent stream\"]\n        Approval[\"Approval\u003cbr/\u003eUser consent\"]\n    end\n    \n    subgraph \"Tool Results\"\n        ToolResultBuilder[\"ToolResultBuilder\u003cbr/\u003eResult formatting\"]\n        ToolReturnType[\"ToolReturnType\u003cbr/\u003eSuccess/Error\"]\n        ToolRejectedError[\"ToolRejectedError\u003cbr/\u003eRejection handling\"]\n    end\n    \n    ToolClass --\u003e ParamsModel\n    ToolClass --\u003e CallMethod\n    ToolClass --\u003e ToolDesc\n    \n    ToolLoader --\u003e AgentGlobals\n    ToolLoader --\u003e CustomToolset\n    CustomToolset --\u003e ToolClass\n    \n    CallMethod --\u003e CurrentToolCall\n    CallMethod --\u003e Wire\n    CallMethod --\u003e Approval\n    \n    CallMethod --\u003e ToolResultBuilder\n    ToolResultBuilder --\u003e ToolReturnType\n    Approval --\u003e ToolRejectedError\n```\n\n**Tool Loading and Execution Flow**\n\nSources: [src/kimi_cli/tools/bash/__init__.py:1-100](), [tests/test_load_agent.py:132-172](), [tests/conftest.py:1-225]()\n\n## Tool Base Class Structure\n\nAll custom tools must inherit from `CallableTool2[Params]` where `Params` is a Pydantic model defining the tool's parameters. The tool class requires three class attributes:\n\n| Attribute | Type | Description |\n|-----------|------|-------------|\n| `name` | `str` | The name of the tool as it appears to the LLM |\n| `description` | `str` | A detailed description of what the tool does and how to use it |\n| `params` | `type[BaseModel]` | The Pydantic model class defining the tool's parameters |\n\nThe tool must also implement an `async __call__` method that accepts the parameter model and returns a `ToolReturnType`.\n\n```mermaid\nclassDiagram\n    class CallableTool2~Params~ {\n        \u003c\u003cabstract\u003e\u003e\n        +name: str\n        +description: str\n        +params: type[Params]\n        +__call__(params: Params) ToolReturnType*\n    }\n    \n    class Params {\n        \u003c\u003cBaseModel\u003e\u003e\n        +field1: type\n        +field2: type\n    }\n    \n    class CustomTool {\n        +name: str\n        +description: str\n        +params: type[Params]\n        +__init__(deps)\n        +__call__(params: Params) ToolReturnType\n    }\n    \n    class Bash {\n        +name: \"Bash\"\n        +description: str\n        +params: type[Params]\n        -_approval: Approval\n        +__init__(approval: Approval)\n        +__call__(params: Params) ToolReturnType\n    }\n    \n    CallableTool2 \u003c|-- CustomTool\n    CallableTool2 \u003c|-- Bash\n    CustomTool --\u003e Params: uses\n    Bash --\u003e Params: uses\n```\n\n**Tool Class Hierarchy and Structure**\n\nSources: [src/kimi_cli/tools/bash/__init__.py:27-35]()\n\n## Defining Tool Parameters\n\nTool parameters are defined using a Pydantic `BaseModel` class. Each field in the model becomes a parameter that the LLM must provide when calling the tool. Use Pydantic's `Field` to add descriptions, validation, and default values:\n\n```python\nfrom pydantic import BaseModel, Field\n\nclass Params(BaseModel):\n    command: str = Field(description=\"The bash command to execute.\")\n    timeout: int = Field(\n        description=\"The timeout in seconds for the command to execute.\",\n        default=60,\n        ge=1,\n        le=300,\n    )\n```\n\n**Parameter Definition Best Practices:**\n\n| Practice | Description | Example |\n|----------|-------------|---------|\n| Descriptive field names | Use clear, unambiguous names | `file_path` not `fp` |\n| Detailed descriptions | Explain what the parameter does and format requirements | `\"The absolute path to the file to read\"` |\n| Validation constraints | Use Pydantic validators for bounds and formats | `ge=1, le=300` for numeric ranges |\n| Sensible defaults | Provide defaults where appropriate | `timeout: int = 60` |\n\nSources: [src/kimi_cli/tools/bash/__init__.py:14-24]()\n\n## Implementing Tool Logic\n\nThe core tool logic is implemented in the `async __call__` method. This method receives the validated parameters and must return a `ToolReturnType`. Tools should use `ToolResultBuilder` to construct their results:\n\n```mermaid\nsequenceDiagram\n    participant Agent\n    participant Toolset\n    participant Tool\n    participant Approval\n    participant Builder as ToolResultBuilder\n    \n    Agent-\u003e\u003eToolset: Execute tool call\n    Toolset-\u003e\u003eTool: __call__(params)\n    \n    alt Requires Approval\n        Tool-\u003e\u003eApproval: request(sender, action, description)\n        Approval--\u003e\u003eTool: approved/rejected\n        alt Rejected\n            Tool-\u003e\u003eBuilder: Return ToolRejectedError\n            Tool--\u003e\u003eToolset: Error result\n        end\n    end\n    \n    Tool-\u003e\u003eTool: Execute tool logic\n    \n    alt Success\n        Tool-\u003e\u003eBuilder: ok(message)\n    else Failure\n        Tool-\u003e\u003eBuilder: error(message, brief)\n    end\n    \n    Tool--\u003e\u003eToolset: ToolReturnType\n    Toolset--\u003e\u003eAgent: Tool result\n```\n\n**Tool Execution Flow with Approval**\n\nSources: [src/kimi_cli/tools/bash/__init__.py:36-72](), [src/kimi_cli/soul/approval.py:18-64]()\n\n## Dependency Injection\n\nTools can receive dependencies through their `__init__` method. The tool loading system uses type hints to automatically inject the correct dependencies. Common injectable types include:\n\n| Type | Description | Usage |\n|------|-------------|-------|\n| `AgentGlobals` | Container for all agent-level dependencies | Access to config, LLM, session, etc. |\n| `Config` | Application configuration | LLM providers, service endpoints |\n| `BuiltinSystemPromptArgs` | Built-in prompt arguments | Work directory, current time |\n| `Session` | Current session metadata | Session ID, history file paths |\n| `Approval` | User approval system | Request permission for actions |\n| `DenwaRenji` | Time-travel system | Context checkpointing |\n\n```mermaid\ngraph LR\n    subgraph \"Tool Loading\"\n        ToolPath[\"Tool path string\u003cbr/\u003e'kimi_cli.tools.bash:Bash'\"]\n        LoadTools[\"_load_tools()\"]\n        DepsMap[\"Dependencies map\u003cbr/\u003e{Type: instance}\"]\n    end\n    \n    subgraph \"Tool Instantiation\"\n        ToolClass[\"Tool class\"]\n        InitInspect[\"Inspect __init__\u003cbr/\u003etype hints\"]\n        InjectDeps[\"Inject matching\u003cbr/\u003edependencies\"]\n        ToolInstance[\"Tool instance\"]\n    end\n    \n    subgraph \"Available Dependencies\"\n        AG[\"AgentGlobals\"]\n        Cfg[\"Config\"]\n        Builtin[\"BuiltinSystemPromptArgs\"]\n        Sess[\"Session\"]\n        Appr[\"Approval\"]\n        DR[\"DenwaRenji\"]\n    end\n    \n    ToolPath --\u003e LoadTools\n    DepsMap --\u003e LoadTools\n    LoadTools --\u003e ToolClass\n    ToolClass --\u003e InitInspect\n    InitInspect --\u003e InjectDeps\n    \n    AG --\u003e DepsMap\n    Cfg --\u003e DepsMap\n    Builtin --\u003e DepsMap\n    Sess --\u003e DepsMap\n    Appr --\u003e DepsMap\n    DR --\u003e DepsMap\n    \n    InjectDeps --\u003e ToolInstance\n```\n\n**Dependency Injection System**\n\nExample from the `Bash` tool:\n\n```python\ndef __init__(self, approval: Approval, **kwargs):\n    super().__init__(**kwargs)\n    self._approval = approval\n```\n\nSources: [tests/test_load_agent.py:132-172](), [tests/conftest.py:98-114](), [src/kimi_cli/tools/bash/__init__.py:32-34]()\n\n## Integration with the Approval System\n\nTools that perform potentially destructive operations should request user approval. The `Approval` system provides a standardized way to request permission before executing actions:\n\n```python\nif not await self._approval.request(\n    self.name,\n    \"run shell command\",\n    f\"Run command `{params.command}`\",\n):\n    return ToolRejectedError()\n```\n\n**Approval Parameters:**\n\n| Parameter | Description |\n|-----------|-------------|\n| `sender` | Tool name (typically `self.name`) |\n| `action` | Action identifier for auto-approval tracking |\n| `description` | Human-readable description shown to user |\n\nThe approval system supports three response modes:\n- **Approve once**: Approve this specific action\n- **Approve for session**: Auto-approve this action type for the entire session\n- **Reject**: Deny the action and return an error\n\nWhen approval is rejected, return `ToolRejectedError()` which creates a standardized rejection message for the agent.\n\nSources: [src/kimi_cli/tools/bash/__init__.py:40-45](), [src/kimi_cli/soul/approval.py:18-64](), [tests/conftest.py:92-94]()\n\n## Tool Results and Error Handling\n\nUse `ToolResultBuilder` to construct tool results. The builder provides methods for different result types:\n\n| Method | Purpose | Example |\n|--------|---------|---------|\n| `write(content)` | Append content to result | `builder.write(output_line)` |\n| `ok(message)` | Success with message | `builder.ok(\"Command executed successfully\")` |\n| `error(message, brief)` | Error with full and brief message | `builder.error(\"Command failed\", brief=\"Exit code 1\")` |\n\nThe `brief` parameter in `error()` provides a concise summary that appears in the agent's context, while the full message contains detailed information.\n\n```python\ntry:\n    exitcode = await execute_command(params.command)\n    \n    if exitcode == 0:\n        return builder.ok(\"Command executed successfully.\")\n    else:\n        return builder.error(\n            f\"Command failed with exit code: {exitcode}.\",\n            brief=f\"Failed with exit code: {exitcode}\",\n        )\nexcept TimeoutError:\n    return builder.error(\n        f\"Command killed by timeout ({params.timeout}s)\",\n        brief=f\"Killed by timeout ({params.timeout}s)\",\n    )\n```\n\nSources: [src/kimi_cli/tools/bash/__init__.py:38-71]()\n\n## Tool Registration and Loading\n\nTools are registered in agent specifications using fully-qualified paths in the format `\"module.path:ClassName\"`. The `_load_tools` function dynamically imports and instantiates tools:\n\n```mermaid\ngraph TB\n    subgraph \"Agent Specification\"\n        AgentYAML[\"agent.yaml\u003cbr/\u003etools list\"]\n        ToolPaths[\"Tool paths:\u003cbr/\u003e'kimi_cli.tools.bash:Bash'\u003cbr/\u003e'kimi_cli.tools.think:Think'\"]\n    end\n    \n    subgraph \"Tool Loading Process\"\n        ParsePath[\"Parse module:class\"]\n        ImportModule[\"Import module\"]\n        GetClass[\"Get class from module\"]\n        InspectInit[\"Inspect __init__ signature\"]\n        MatchDeps[\"Match dependencies\"]\n        Instantiate[\"Instantiate tool\"]\n    end\n    \n    subgraph \"Result\"\n        Toolset[\"CustomToolset\u003cbr/\u003ewith tool instances\"]\n        BadTools[\"Bad tools list\u003cbr/\u003e(failed to load)\"]\n    end\n    \n    AgentYAML --\u003e ToolPaths\n    ToolPaths --\u003e ParsePath\n    ParsePath --\u003e ImportModule\n    ImportModule --\u003e GetClass\n    GetClass --\u003e InspectInit\n    InspectInit --\u003e MatchDeps\n    MatchDeps --\u003e Instantiate\n    \n    Instantiate --\u003e Toolset\n    ImportModule -.failure.-\u003e BadTools\n    GetClass -.failure.-\u003e BadTools\n    Instantiate -.failure.-\u003e BadTools\n```\n\n**Tool Loading Process**\n\nTo make a custom tool available to agents:\n\n1. **Create the tool module** with the tool class\n2. **Add the tool path** to the agent's `tools` list in YAML:\n   ```yaml\n   tools:\n     - \"kimi_cli.tools.custom:MyCustomTool\"\n   ```\n3. **Handle loading errors**: The system will report bad tools but continue loading valid ones\n\nSources: [tests/test_load_agent.py:132-172](), [tests/test_load_agent.py:201-204]()\n\n## Loading Tool Descriptions\n\nTool descriptions should be loaded from markdown files using the `load_desc` utility. This allows for rich, formatted descriptions that help the LLM understand when and how to use the tool:\n\n```python\nfrom pathlib import Path\nfrom kimi_cli.tools.utils import load_desc\n\nclass MyTool(CallableTool2[Params]):\n    name: str = \"MyTool\"\n    description: str = load_desc(Path(__file__).parent / \"mytool.md\", {})\n    params: type[Params] = Params\n```\n\nThe second argument to `load_desc` is a dictionary for template variable substitution in the markdown file.\n\nSources: [src/kimi_cli/tools/bash/__init__.py:29]()\n\n## Testing Custom Tools\n\nCustom tools should be tested using pytest fixtures that provide the necessary dependencies. The test fixture pattern ensures tools receive properly configured dependencies:\n\n```mermaid\ngraph LR\n    subgraph \"Test Fixtures\"\n        ConfigFix[\"config fixture\"]\n        LLMFix[\"llm fixture\"]\n        ApprovalFix[\"approval fixture\"]\n        BuiltinFix[\"builtin_args fixture\"]\n        GlobalsFix[\"agent_globals fixture\"]\n    end\n    \n    subgraph \"Tool Fixture\"\n        ToolFix[\"custom_tool fixture\"]\n        CreateTool[\"Instantiate tool\u003cbr/\u003ewith dependencies\"]\n    end\n    \n    subgraph \"Test Cases\"\n        TestSuccess[\"test_tool_success()\"]\n        TestError[\"test_tool_error()\"]\n        TestApproval[\"test_tool_approval()\"]\n    end\n    \n    ConfigFix --\u003e GlobalsFix\n    LLMFix --\u003e GlobalsFix\n    ApprovalFix --\u003e GlobalsFix\n    BuiltinFix --\u003e GlobalsFix\n    \n    GlobalsFix --\u003e ToolFix\n    ApprovalFix --\u003e ToolFix\n    \n    ToolFix --\u003e CreateTool\n    CreateTool --\u003e TestSuccess\n    CreateTool --\u003e TestError\n    CreateTool --\u003e TestApproval\n```\n\n**Test Fixture Pattern**\n\nExample test fixture for a custom tool requiring approval:\n\n```python\n@pytest.fixture\ndef my_tool(approval: Approval) -\u003e Generator[MyTool]:\n    \"\"\"Create a MyTool instance.\"\"\"\n    with tool_call_context(\"MyTool\"):\n        yield MyTool(approval)\n```\n\nThe `tool_call_context` helper sets up the current tool call context variable, which is required for tools that use the approval system.\n\nSources: [tests/conftest.py:38-225]()\n\n## Complete Example: Creating a Custom Tool\n\nHere's a complete walkthrough of creating a custom tool that interacts with an external API:\n\n**Step 1: Define the parameter model** (in `src/kimi_cli/tools/custom/api_call.py`):\n\n```python\nfrom pydantic import BaseModel, Field\n\nclass Params(BaseModel):\n    endpoint: str = Field(description=\"The API endpoint to call\")\n    method: str = Field(\n        description=\"HTTP method\",\n        default=\"GET\",\n        pattern=\"^(GET|POST|PUT|DELETE)$\"\n    )\n    body: str | None = Field(\n        description=\"Request body for POST/PUT\",\n        default=None\n    )\n```\n\n**Step 2: Create the tool class**:\n\n```python\nfrom pathlib import Path\nfrom typing import override\nimport httpx\n\nfrom kosong.tooling import CallableTool2, ToolReturnType\n\nfrom kimi_cli.soul.approval import Approval\nfrom kimi_cli.tools.utils import ToolRejectedError, ToolResultBuilder, load_desc\n\nclass APICall(CallableTool2[Params]):\n    name: str = \"APICall\"\n    description: str = load_desc(Path(__file__).parent / \"api_call.md\", {})\n    params: type[Params] = Params\n    \n    def __init__(self, approval: Approval, **kwargs):\n        super().__init__(**kwargs)\n        self._approval = approval\n    \n    @override\n    async def __call__(self, params: Params) -\u003e ToolReturnType:\n        builder = ToolResultBuilder()\n        \n        # Request approval for write operations\n        if params.method in [\"POST\", \"PUT\", \"DELETE\"]:\n            if not await self._approval.request(\n                self.name,\n                \"api write operation\",\n                f\"{params.method} to {params.endpoint}\",\n            ):\n                return ToolRejectedError()\n        \n        try:\n            async with httpx.AsyncClient() as client:\n                response = await client.request(\n                    method=params.method,\n                    url=params.endpoint,\n                    content=params.body,\n                    timeout=30.0,\n                )\n                \n                builder.write(f\"Status: {response.status_code}\\n\")\n                builder.write(response.text)\n                \n                if response.is_success:\n                    return builder.ok(\"API call successful\")\n                else:\n                    return builder.error(\n                        f\"API call failed: {response.status_code}\",\n                        brief=f\"Status {response.status_code}\"\n                    )\n        except httpx.TimeoutException:\n            return builder.error(\"Request timed out\", brief=\"Timeout\")\n        except Exception as e:\n            return builder.error(f\"Error: {e}\", brief=\"Request failed\")\n```\n\n**Step 3: Create the description file** (`api_call.md`):\n\n```markdown\nMake HTTP requests to external APIs.\n\nUse this tool to interact with RESTful APIs. Supports GET, POST, PUT, and DELETE methods.\nWrite operations (POST, PUT, DELETE) require user approval.\n\nExamples:\n- Fetch data: endpoint=\"https://api.example.com/data\", method=\"GET\"\n- Create resource: endpoint=\"https://api.example.com/items\", method=\"POST\", body='{\"name\":\"item\"}'\n```\n\n**Step 4: Add to agent configuration** (`agent.yaml`):\n\n```yaml\ntools:\n  - \"kimi_cli.tools.custom:APICall\"\n```\n\n**Step 5: Create test fixtures** (`tests/test_api_call.py`):\n\n```python\nimport pytest\nfrom tests.conftest import tool_call_context\n\n@pytest.fixture\ndef api_call_tool(approval: Approval):\n    \"\"\"Create an APICall tool instance.\"\"\"\n    with tool_call_context(\"APICall\"):\n        from kimi_cli.tools.custom import APICall\n        yield APICall(approval)\n\n@pytest.mark.asyncio\nasync def test_api_call_get(api_call_tool):\n    \"\"\"Test GET request.\"\"\"\n    result = await api_call_tool(\n        api_call_tool.params(endpoint=\"https://httpbin.org/get\", method=\"GET\")\n    )\n    assert result.is_success\n```\n\nSources: [src/kimi_cli/tools/bash/__init__.py:1-100](), [tests/conftest.py:164-168]()\n\n## Tool Context Variables\n\nTools execute within a context that provides access to the current tool call information and the event stream:\n\n| Context Variable | Type | Purpose | Access |\n|-----------------|------|---------|--------|\n| `current_tool_call` | `ContextVar[ToolCall]` | Current tool call metadata | `get_current_tool_call_or_none()` |\n| `current_wire` | `ContextVar[Wire]` | Event stream for UI communication | `get_wire_or_none()` |\n\nThese context variables are set automatically by the tool execution infrastructure. Tools that need approval must be called within a tool call context (automatically provided during agent execution).\n\nSources: [tests/conftest.py:123-136](), [src/kimi_cli/soul/wire.py:118-126](), [src/kimi_cli/soul/approval.py:34-36]()\n\n## Best Practices Summary\n\n| Category | Recommendation |\n|----------|---------------|\n| **Parameter Design** | Use descriptive names, detailed descriptions, and appropriate validation |\n| **Error Handling** | Always use `ToolResultBuilder` to format results consistently |\n| **Approval** | Request approval for write operations, destructive actions, or external communication |\n| **Description** | Store tool descriptions in separate markdown files for better documentation |\n| **Testing** | Create pytest fixtures that mirror production dependency injection |\n| **Dependencies** | Only request the dependencies your tool actually needs |\n| **Async** | All tool implementations must be async (`async def __call__`) |\n| **Logging** | Use the `builder.write()` method to log progress and output |\n\nSources: [src/kimi_cli/tools/bash/__init__.py:1-100](), [tests/conftest.py:1-225](), [tests/test_load_agent.py:132-172]()"])</script><script>self.__next_f.push([1,"3a:T404f,"])</script><script>self.__next_f.push([1,"# CI/CD and Release Process\n\n\u003cdetails\u003e\n\u003csummary\u003eRelevant source files\u003c/summary\u003e\n\nThe following files were used as context for generating this wiki page:\n\n- [.github/workflows/ci.yml](.github/workflows/ci.yml)\n- [.github/workflows/release.yml](.github/workflows/release.yml)\n- [CHANGELOG.md](CHANGELOG.md)\n- [Makefile](Makefile)\n- [pyproject.toml](pyproject.toml)\n- [pyrightconfig.json](pyrightconfig.json)\n- [src/kimi_cli/deps/Makefile](src/kimi_cli/deps/Makefile)\n- [uv.lock](uv.lock)\n\n\u003c/details\u003e\n\n\n\n## Purpose and Scope\n\nThis document describes the automated continuous integration, build, and release workflows for kimi-cli. It covers the GitHub Actions pipelines that test pull requests, build standalone binaries, create releases, and publish packages to PyPI. For information about the build system configuration used by developers locally, see [Build System](#9.1). For testing framework details, see [Testing](#9.2).\n\n## CI/CD Architecture Overview\n\nThe kimi-cli project uses GitHub Actions for automated testing, building, and releasing. The system consists of two primary workflows that handle the complete lifecycle from code changes to published releases.\n\n```mermaid\ngraph TB\n    subgraph \"Code Changes\"\n        PR[\"Pull Request\"]\n        PushMain[\"Push to main\"]\n        Tag[\"Git Tag\"]\n    end\n    \n    subgraph \"CI Workflow (.github/workflows/ci.yml)\"\n        CITrigger[\"Trigger: PR or push to main\"]\n        CIMatrix[\"Matrix: ubuntu-22.04\u003cbr/\u003etarget: x86_64-unknown-linux-gnu\"]\n        CIPrepare[\"make prepare\u003cbr/\u003eSetup uv + dependencies\"]\n        CICheck[\"make check\u003cbr/\u003eruff + pyright\"]\n        CITest[\"make test\u003cbr/\u003epytest\"]\n        CIBuild[\"make build\u003cbr/\u003ePyInstaller\"]\n        CISmoke[\"Smoke test: ./dist/kimi --help\"]\n        CIArtifact[\"Upload artifact\u003cbr/\u003eretention: 7 days\"]\n    end\n    \n    subgraph \"Release Workflow (.github/workflows/release.yml)\"\n        RelTrigger[\"Trigger: Tag push or manual\"]\n        RelMatrix[\"Matrix: ubuntu-22.04, macos-13, macos-14\u003cbr/\u003etargets: x86_64-linux, x86_64-darwin, aarch64-darwin\"]\n        RelBuild[\"Build Job\u003cbr/\u003emake build\"]\n        RelPackage[\"Package as tar.gz\u003cbr/\u003ekimi-TAG-TARGET.tar.gz\"]\n        RelUpload[\"Upload build artifacts\"]\n        RelRelease[\"Release Job\u003cbr/\u003eCreate GitHub Release\"]\n        RelSHA[\"Generate SHA256 checksums\"]\n        RelAssets[\"Attach tar.gz + sha256 files\"]\n        RelPyPI[\"Publish Job\u003cbr/\u003euv build + PyPI publish\"]\n    end\n    \n    PR --\u003e CITrigger\n    PushMain --\u003e CITrigger\n    CITrigger --\u003e CIMatrix\n    CIMatrix --\u003e CIPrepare\n    CIPrepare --\u003e CICheck\n    CICheck --\u003e CITest\n    CITest --\u003e CIBuild\n    CIBuild --\u003e CISmoke\n    CISmoke --\u003e CIArtifact\n    \n    Tag --\u003e RelTrigger\n    RelTrigger --\u003e RelMatrix\n    RelMatrix --\u003e RelBuild\n    RelBuild --\u003e RelPackage\n    RelPackage --\u003e RelUpload\n    RelUpload --\u003e RelRelease\n    RelRelease --\u003e RelSHA\n    RelSHA --\u003e RelAssets\n    RelTrigger --\u003e RelPyPI\n```\n\n**Sources:** [.github/workflows/ci.yml:1-62](), [.github/workflows/release.yml:1-137]()\n\n## Continuous Integration Pipeline\n\nThe CI workflow runs on every pull request and push to the `main` branch. It performs comprehensive validation including linting, type checking, testing, and binary builds.\n\n### Workflow Configuration\n\nThe workflow is defined in [.github/workflows/ci.yml:1-62]() with the following triggers:\n\n```yaml\non:\n  pull_request:\n  push:\n    branches:\n      - main\n```\n\n### Build Matrix\n\nCurrently, CI runs on a single platform configuration:\n\n| Runner | Target Platform |\n|--------|----------------|\n| `ubuntu-22.04` | `x86_64-unknown-linux-gnu` |\n\nThe matrix structure [.github/workflows/ci.yml:14-22]() supports additional platforms (ARM Linux, macOS x86_64, macOS ARM64) but they are commented out, likely for performance or cost optimization.\n\n### CI Pipeline Steps\n\n```mermaid\nflowchart LR\n    Checkout[\"1. Checkout\u003cbr/\u003eactions/checkout@v4\"]\n    Python[\"2. Setup Python 3.13\u003cbr/\u003eactions/setup-python@v5\"]\n    UV[\"3. Setup uv 0.8.5\u003cbr/\u003eastral-sh/setup-uv@v1\"]\n    Prepare[\"4. make prepare\u003cbr/\u003edownload ripgrep, sync deps\"]\n    Check[\"5. make check\u003cbr/\u003eruff check + format + pyright\"]\n    Test[\"6. make test\u003cbr/\u003euv run pytest\"]\n    Build[\"7. make build\u003cbr/\u003epyinstaller kimi.spec\"]\n    Smoke[\"8. ./dist/kimi --help\u003cbr/\u003eValidate binary works\"]\n    Upload[\"9. Upload artifact\u003cbr/\u003ekimi-TARGET.tar.gz\u003cbr/\u003e7 day retention\"]\n    \n    Checkout --\u003e Python\n    Python --\u003e UV\n    UV --\u003e Prepare\n    Prepare --\u003e Check\n    Check --\u003e Test\n    Test --\u003e Build\n    Build --\u003e Smoke\n    Smoke --\u003e Upload\n```\n\n**Sources:** [.github/workflows/ci.yml:24-61]()\n\nEach step in the pipeline serves a specific purpose:\n\n1. **Checkout** [.github/workflows/ci.yml:25-26]() - Clones the repository\n2. **Python Setup** [.github/workflows/ci.yml:28-32]() - Installs Python 3.13 with prerelease support\n3. **UV Setup** [.github/workflows/ci.yml:34-37]() - Installs the `uv` package manager at version 0.8.5\n4. **Prepare** [.github/workflows/ci.yml:39-40]() - Executes `make prepare` which downloads external dependencies (ripgrep) and syncs Python dependencies\n5. **Check** [.github/workflows/ci.yml:42-43]() - Runs `make check` which invokes `ruff` for linting/formatting and `pyright` for type checking\n6. **Test** [.github/workflows/ci.yml:45-46]() - Runs `make test` which executes `pytest` on the test suite\n7. **Build** [.github/workflows/ci.yml:48-49]() - Runs `make build` which uses PyInstaller to create a standalone binary\n8. **Smoke Test** [.github/workflows/ci.yml:51-52]() - Validates the built binary by running `./dist/kimi --help`\n9. **Upload** [.github/workflows/ci.yml:54-61]() - Uploads the binary as a workflow artifact with 7-day retention\n\n**Sources:** [.github/workflows/ci.yml:1-62](), [Makefile:1-28]()\n\n## Build System Integration\n\nThe CI/CD workflows rely heavily on the Makefile targets defined in [Makefile:1-28](). These targets provide a consistent interface for both local development and automated builds.\n\n### Core Make Targets\n\n| Target | Command | Purpose |\n|--------|---------|---------|\n| `prepare` | `make prepare` | Downloads external dependencies (ripgrep) and syncs Python packages with `uv sync --frozen` |\n| `check` | `make check` | Runs `ruff check`, `ruff format --check`, and `pyright` for code quality validation |\n| `test` | `make test` | Executes `uv run pytest tests -vv` |\n| `build` | `make build` | Builds standalone binary with `uv run pyinstaller kimi.spec` |\n| `format` | `make format` | Auto-fixes linting issues with `ruff check --fix` and `ruff format` |\n\n**Sources:** [Makefile:4-26]()\n\n### Tool Resolution\n\nThe Makefile uses a clever resolution pattern [Makefile:1-2]() to prefer system-installed tools while falling back to `uv run`:\n\n```makefile\nRUFF := $(shell command -v ruff 2\u003e /dev/null || echo \"uv run ruff\")\nPYRIGHT := $(shell command -v pyright 2\u003e /dev/null || echo \"uv run pyright\")\n```\n\nThis ensures the build works both in CI environments (where tools are installed via `uv`) and on developer machines (where tools might be globally installed).\n\n**Sources:** [Makefile:1-2]()\n\n## Release Workflow\n\nThe release workflow creates multi-platform binaries, generates GitHub releases, and publishes the Python package to PyPI. It is triggered either by pushing a git tag or manually via workflow dispatch.\n\n### Release Triggers\n\nThe workflow [.github/workflows/release.yml:3-7]() supports two trigger mechanisms:\n\n- **Tag Push**: Automatically triggered when a tag matching any pattern is pushed\n- **Manual Dispatch**: Can be manually triggered via GitHub Actions UI\n\n### Multi-Platform Build Matrix\n\nThe release workflow builds binaries for three platforms:\n\n```mermaid\ngraph TB\n    subgraph \"Build Matrix\"\n        Linux[\"ubuntu-22.04\u003cbr/\u003ex86_64-unknown-linux-gnu\"]\n        MacIntel[\"macos-13\u003cbr/\u003ex86_64-apple-darwin\"]\n        MacArm[\"macos-14\u003cbr/\u003eaarch64-apple-darwin\"]\n    end\n    \n    subgraph \"Build Process (parallel)\"\n        BuildA[\"make prepare\u003cbr/\u003emake build\"]\n        BuildB[\"make prepare\u003cbr/\u003emake build\"]\n        BuildC[\"make prepare\u003cbr/\u003emake build\"]\n    end\n    \n    subgraph \"Artifacts\"\n        TarA[\"kimi-TAG-x86_64-unknown-linux-gnu.tar.gz\"]\n        TarB[\"kimi-TAG-x86_64-apple-darwin.tar.gz\"]\n        TarC[\"kimi-TAG-aarch64-apple-darwin.tar.gz\"]\n    end\n    \n    Linux --\u003e BuildA\n    MacIntel --\u003e BuildB\n    MacArm --\u003e BuildC\n    \n    BuildA --\u003e TarA\n    BuildB --\u003e TarB\n    BuildC --\u003e TarC\n```\n\n**Sources:** [.github/workflows/release.yml:18-26]()\n\n### Release Pipeline Architecture\n\nThe release workflow consists of three independent jobs:\n\n```mermaid\nflowchart TB\n    subgraph \"Build Job (matrix)\"\n        B1[\"Checkout + Setup\u003cbr/\u003ePython 3.13 + uv 0.8.5\"]\n        B2[\"make prepare\"]\n        B3[\"make build\"]\n        B4[\"Package as tar.gz\u003cbr/\u003ekimi-TAG-TARGET.tar.gz\"]\n        B5[\"Upload artifact\"]\n        B1 --\u003e B2 --\u003e B3 --\u003e B4 --\u003e B5\n    end\n    \n    subgraph \"Release Job (depends on build)\"\n        R1[\"Download all artifacts\u003cbr/\u003eactions/download-artifact@v4\"]\n        R2[\"Generate SHA256 checksums\u003cbr/\u003esha256sum for each tar.gz\"]\n        R3[\"Create GitHub Release\u003cbr/\u003esoftprops/action-gh-release@v2\"]\n        R4[\"Attach tar.gz + sha256 files\"]\n        R1 --\u003e R2 --\u003e R3 --\u003e R4\n    end\n    \n    subgraph \"Publish Python Job (independent)\"\n        P1[\"Checkout + Setup\u003cbr/\u003ePython 3.13 + uv 0.8.5\"]\n        P2[\"uv build\u003cbr/\u003eCreate sdist + wheel\"]\n        P3[\"Publish to PyPI\u003cbr/\u003epypa/gh-action-pypi-publish\"]\n        P1 --\u003e P2 --\u003e P3\n    end\n    \n    B5 -.-\u003e|needs: build| R1\n```\n\n**Sources:** [.github/workflows/release.yml:13-137]()\n\n### Build Job Details\n\nThe build job [.github/workflows/release.yml:13-72]() runs in parallel across all matrix configurations:\n\n1. **Checkout and Setup** [.github/workflows/release.yml:29-41]() - Clone repository, install Python 3.13 and uv 0.8.5\n2. **Prepare Environment** [.github/workflows/release.yml:43-44]() - Run `make prepare` to download dependencies\n3. **Build Binary** [.github/workflows/release.yml:46-47]() - Run `make build` to create standalone executable\n4. **Package Artifact** [.github/workflows/release.yml:49-61]() - Create tar.gz archive with naming pattern `kimi-${TAG}-${TARGET}.tar.gz`\n5. **Upload** [.github/workflows/release.yml:63-71]() - Upload artifact with 7-day retention\n\nThe packaging script [.github/workflows/release.yml:53-61]() performs:\n\n```bash\nmkdir -p artifacts\ncp dist/kimi artifacts/kimi\nFILENAME=\"kimi-${TAG}-${TARGET}.tar.gz\"\ntar -C artifacts -czf \"artifacts/${FILENAME}\" kimi\nrm -f artifacts/kimi\n```\n\n**Sources:** [.github/workflows/release.yml:13-72]()\n\n### Release Job Details\n\nThe release job [.github/workflows/release.yml:73-109]() aggregates all build artifacts and creates the GitHub release:\n\n1. **Download Artifacts** [.github/workflows/release.yml:78-82]() - Downloads all artifacts from build job using `merge-multiple: true` to collect into a single directory\n2. **Generate Checksums** [.github/workflows/release.yml:88-96]() - Creates SHA256 checksum files for each tar.gz archive\n3. **Create Release** [.github/workflows/release.yml:98-108]() - Uses `softprops/action-gh-release@v2` to create a GitHub release with auto-generated release notes and all artifacts attached\n\nThe checksum generation script [.github/workflows/release.yml:90-95]() creates individual `.sha256` files:\n\n```bash\ncd downloads\nfor f in *.tar.gz; do\n  sha256sum \"$f\" \u003e \"$f.sha256\"\n  echo \"sha256($(basename \"$f\"))=$(cut -d' ' -f1 \"$f.sha256\")\"\ndone\n```\n\n**Sources:** [.github/workflows/release.yml:73-109]()\n\n### PyPI Publishing Job\n\nThe Python package publishing job [.github/workflows/release.yml:110-137]() runs independently and publishes to PyPI:\n\n1. **Setup** [.github/workflows/release.yml:114-126]() - Checkout, install Python 3.13 and uv 0.8.5\n2. **Build Distributions** [.github/workflows/release.yml:128-129]() - Run `uv build` to create source distribution (sdist) and wheel\n3. **Publish** [.github/workflows/release.yml:131-136]() - Use `pypa/gh-action-pypi-publish@release/v1` to upload to PyPI using token authentication\n\nThe job requires a `PYPI_API_TOKEN` secret to be configured in the repository settings [.github/workflows/release.yml:135]().\n\n**Sources:** [.github/workflows/release.yml:110-137]()\n\n## Dependency Management\n\nThe build system manages external binary dependencies through a dedicated Makefile in [src/kimi_cli/deps/Makefile:1-63]().\n\n### Ripgrep Binary Management\n\nThe primary external dependency is `ripgrep` (rg), used by the Grep tool. The dependency Makefile handles platform-specific downloading and installation.\n\n```mermaid\ngraph LR\n    subgraph \"Platform Detection\"\n        DetectOS[\"uname -s\u003cbr/\u003eDarwin or Linux\"]\n        DetectArch[\"uname -m\u003cbr/\u003earm64, x86_64, aarch64\"]\n        MapTarget[\"Map to ripgrep target:\u003cbr/\u003eaarch64-apple-darwin\u003cbr/\u003ex86_64-apple-darwin\u003cbr/\u003ex86_64-unknown-linux-musl\u003cbr/\u003eaarch64-unknown-linux-gnu\"]\n    end\n    \n    subgraph \"Download Process\"\n        CheckExists[\"Check if bin/rg exists\"]\n        Download[\"Download from GitHub\u003cbr/\u003ecurl or wget\"]\n        Extract[\"tar -xzf\"]\n        Install[\"Copy to bin/rg\u003cbr/\u003echmod +x\"]\n    end\n    \n    DetectOS --\u003e MapTarget\n    DetectArch --\u003e MapTarget\n    MapTarget --\u003e CheckExists\n    CheckExists --\u003e|not found| Download\n    Download --\u003e Extract\n    Extract --\u003e Install\n    CheckExists --\u003e|exists| Skip[\"Skip download\"]\n```\n\n**Sources:** [src/kimi_cli/deps/Makefile:1-63]()\n\n### Platform Mapping Logic\n\nThe Makefile [src/kimi_cli/deps/Makefile:10-32]() implements OS and architecture detection:\n\n| OS | Architecture | Ripgrep Target |\n|----|--------------|----------------|\n| Darwin | `arm64` | `aarch64-apple-darwin` |\n| Darwin | `x86_64` | `x86_64-apple-darwin` |\n| Linux | `x86_64` | `x86_64-unknown-linux-musl` |\n| Linux | `aarch64` | `aarch64-unknown-linux-gnu` |\n| Linux | `armv7l` | `arm-unknown-linux-gnueabihf` |\n\nThe download URL is constructed as [src/kimi_cli/deps/Makefile:34]():\n\n```\nhttps://github.com/BurntSushi/ripgrep/releases/download/${RG_VERSION}/ripgrep-${RG_VERSION}-${RG_TARGET}.tar.gz\n```\n\n**Sources:** [src/kimi_cli/deps/Makefile:10-35]()\n\n### Download Implementation\n\nThe `download-ripgrep` target [src/kimi_cli/deps/Makefile:38-58]() implements the download logic:\n\n1. **Existence Check**: Skip if `bin/rg` already exists\n2. **Download**: Use `curl` (preferred) or `wget` (fallback) to fetch the tarball\n3. **Extract**: Extract tarball to temporary directory\n4. **Install**: Copy binary to `bin/rg` and make executable\n5. **Cleanup**: Tarball remains in `tmp/` directory\n\nThe `download-deps` target [src/kimi_cli/deps/Makefile:61-62]() serves as the entry point, included by the main Makefile [Makefile:27]().\n\n**Sources:** [src/kimi_cli/deps/Makefile:38-63](), [Makefile:27]()\n\n## Type Checking Configuration\n\nThe CI pipeline includes type checking with Pyright, configured via [pyrightconfig.json:1-9]().\n\n```json\n{\n    \"include\": [\n        \"src/**/*.py\",\n        \"tests/**/*.py\"\n    ],\n    \"exclude\": [\n        \"**/__pycache__/**/*.py\"\n    ]\n}\n```\n\nThis configuration ensures:\n- All source code in `src/` is type-checked\n- All test code in `tests/` is type-checked\n- Compiled Python cache files are excluded\n\n**Sources:** [pyrightconfig.json:1-9]()\n\n## Publishing Channels\n\nKimi-cli releases are distributed through two primary channels:\n\n### GitHub Releases\n\nGitHub releases provide platform-specific standalone binaries:\n- **Linux x86_64**: `kimi-${TAG}-x86_64-unknown-linux-gnu.tar.gz`\n- **macOS Intel**: `kimi-${TAG}-x86_64-apple-darwin.tar.gz`\n- **macOS Apple Silicon**: `kimi-${TAG}-aarch64-apple-darwin.tar.gz`\n\nEach binary includes:\n- Executable file `kimi`\n- SHA256 checksum file for verification\n- Auto-generated release notes from commit history\n\n**Sources:** [.github/workflows/release.yml:98-108]()\n\n### PyPI Package\n\nPython package distribution provides:\n- **Source distribution** (sdist): Pure Python source code\n- **Wheel** (bdist_wheel): Built distribution\n\nUsers can install via:\n```bash\npip install kimi-cli\n```\n\nThis channel is managed by the `publish-python` job [.github/workflows/release.yml:110-137]() and requires `PYPI_API_TOKEN` authentication.\n\n**Sources:** [.github/workflows/release.yml:110-137]()\n\n## Workflow Permissions\n\nThe release workflow requires write permissions to create GitHub releases [.github/workflows/release.yml:9-10]():\n\n```yaml\npermissions:\n  contents: write\n```\n\nThis permission allows the `softprops/action-gh-release` action to create releases and upload assets.\n\n**Sources:** [.github/workflows/release.yml:9-10]()"])</script><script>self.__next_f.push([1,"5:[\"$\",\"$L12\",null,{\"repoName\":\"MoonshotAI/kimi-cli\",\"hasConfig\":false,\"canSteer\":true,\"children\":[\"$\",\"$L13\",null,{\"wiki\":{\"metadata\":{\"repo_name\":\"MoonshotAI/kimi-cli\",\"commit_hash\":\"e613cdd1\",\"generated_at\":\"2025-11-06T20:42:02.597893\",\"config\":null,\"config_source\":\"none\"},\"pages\":[{\"page_plan\":{\"id\":\"1\",\"title\":\"Overview\"},\"content\":\"$14\"},{\"page_plan\":{\"id\":\"2\",\"title\":\"Getting Started\"},\"content\":\"$15\"},{\"page_plan\":{\"id\":\"2.1\",\"title\":\"Installation and Configuration\"},\"content\":\"$16\"},{\"page_plan\":{\"id\":\"2.2\",\"title\":\"Basic Usage\"},\"content\":\"$17\"},{\"page_plan\":{\"id\":\"3\",\"title\":\"Architecture Overview\"},\"content\":\"$18\"},{\"page_plan\":{\"id\":\"3.1\",\"title\":\"CLI Entry Point and Initialization\"},\"content\":\"$19\"},{\"page_plan\":{\"id\":\"3.2\",\"title\":\"Agent System\"},\"content\":\"$1a\"},{\"page_plan\":{\"id\":\"3.3\",\"title\":\"LLM Integration\"},\"content\":\"$1b\"},{\"page_plan\":{\"id\":\"3.4\",\"title\":\"Communication Layer\"},\"content\":\"$1c\"},{\"page_plan\":{\"id\":\"4\",\"title\":\"User Interfaces\"},\"content\":\"$1d\"},{\"page_plan\":{\"id\":\"4.1\",\"title\":\"Interactive Shell Mode\"},\"content\":\"$1e\"},{\"page_plan\":{\"id\":\"4.2\",\"title\":\"Meta Commands\"},\"content\":\"$1f\"},{\"page_plan\":{\"id\":\"4.3\",\"title\":\"Live View and Visualization\"},\"content\":\"$20\"},{\"page_plan\":{\"id\":\"4.4\",\"title\":\"Print and ACP Modes\"},\"content\":\"$21\"},{\"page_plan\":{\"id\":\"5\",\"title\":\"Agent Configuration\"},\"content\":\"$22\"},{\"page_plan\":{\"id\":\"5.1\",\"title\":\"Agent Specification Format\"},\"content\":\"$23\"},{\"page_plan\":{\"id\":\"5.2\",\"title\":\"Agent Loading and Initialization\"},\"content\":\"$24\"},{\"page_plan\":{\"id\":\"5.3\",\"title\":\"Subagents and Task Delegation\"},\"content\":\"$25\"},{\"page_plan\":{\"id\":\"6\",\"title\":\"Tool System\"},\"content\":\"$26\"},{\"page_plan\":{\"id\":\"6.1\",\"title\":\"File System Tools\"},\"content\":\"$27\"},{\"page_plan\":{\"id\":\"6.2\",\"title\":\"Web Tools\"},\"content\":\"$28\"},{\"page_plan\":{\"id\":\"6.3\",\"title\":\"System Execution Tools\"},\"content\":\"$29\"},{\"page_plan\":{\"id\":\"6.4\",\"title\":\"Task Management Tools\"},\"content\":\"$2a\"},{\"page_plan\":{\"id\":\"6.5\",\"title\":\"Time Travel and Context Tools\"},\"content\":\"$2b\"},{\"page_plan\":{\"id\":\"7\",\"title\":\"Advanced Features\"},\"content\":\"$2c\"},{\"page_plan\":{\"id\":\"7.1\",\"title\":\"Context and Session Management\"},\"content\":\"$2d\"},{\"page_plan\":{\"id\":\"7.2\",\"title\":\"Approval System\"},\"content\":\"$2e\"},{\"page_plan\":{\"id\":\"7.3\",\"title\":\"D-Mail and Time Travel\"},\"content\":\"$2f\"},{\"page_plan\":{\"id\":\"7.4\",\"title\":\"Context Compaction\"},\"content\":\"$30\"},{\"page_plan\":{\"id\":\"7.5\",\"title\":\"Auto-Update System\"},\"content\":\"$31\"},{\"page_plan\":{\"id\":\"8\",\"title\":\"Configuration Reference\"},\"content\":\"$32\"},{\"page_plan\":{\"id\":\"8.1\",\"title\":\"LLM Provider Configuration\"},\"content\":\"$33\"},{\"page_plan\":{\"id\":\"8.2\",\"title\":\"Loop Control and Limits\"},\"content\":\"$34\"},{\"page_plan\":{\"id\":\"8.3\",\"title\":\"External Services\"},\"content\":\"$35\"},{\"page_plan\":{\"id\":\"9\",\"title\":\"Development Guide\"},\"content\":\"$36\"},{\"page_plan\":{\"id\":\"9.1\",\"title\":\"Build System\"},\"content\":\"$37\"},{\"page_plan\":{\"id\":\"9.2\",\"title\":\"Testing\"},\"content\":\"$38\"},{\"page_plan\":{\"id\":\"9.3\",\"title\":\"Creating Custom Tools\"},\"content\":\"$39\"},{\"page_plan\":{\"id\":\"9.4\",\"title\":\"CI/CD and Release Process\"},\"content\":\"$3a\"}]},\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]\n"])</script><script>self.__next_f.push([1,"c:null\n10:[[\"$\",\"title\",\"0\",{\"children\":\"Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name\"}],[\"$\",\"meta\",\"2\",{\"property\":\"og:title\",\"content\":\"Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:description\",\"content\":\"This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:url\",\"content\":\"https://deepwiki.com/MoonshotAI/kimi-cli/5.1-agent-specification-format\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:site_name\",\"content\":\"DeepWiki\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:title\",\"content\":\"Agent Specification Format | MoonshotAI/kimi-cli | DeepWiki\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:description\",\"content\":\"This document describes the YAML-based agent specification format used to define agents in kimi-cli. Agent specifications define the identity, capabilities, and behavior of an agent including its name\"}],[\"$\",\"link\",\"10\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"48x48\"}],[\"$\",\"link\",\"11\",{\"rel\":\"icon\",\"href\":\"/icon.png?66aaf51e0e68c818\",\"type\":\"image/png\",\"sizes\":\"16x16\"}],[\"$\",\"link\",\"12\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-icon.png?a4f658907db0ab87\",\"type\":\"image/png\",\"sizes\":\"180x180\"}]]\n"])</script></body></html>